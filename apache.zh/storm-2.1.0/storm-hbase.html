<html ><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <title>Storm HBase集成</title>

    <!-- Bootstrap core CSS -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="/assets/css/bootstrap-theme.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="asset?aid=5">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/assets/css/owl.theme.css" rel="stylesheet">
    <link href="/assets/css/owl.carousel.css" rel="stylesheet">
    <script type="text/javascript" src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/owl.carousel.min.js"></script>
    <script type="text/javascript" src="/assets/js/storm.js"></script>
    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>


  <body >
    <header>
  <div class="container-fluid">
     <div class="row">
          <div class="col-md-5">
            <a href="/index.html"><img src="/images/logo.png" class="logo"></a>
          </div>
          <div class="col-md-5">
            
              <h1>版本：2.1.0</h1>
            
          </div>
          <div class="col-md-2">
            <a href="/downloads.html" class="btn-std btn-block btn-download">下载</a>
          </div>
        </div>
    </div>
</header>
<!--Header End-->
<!--Navigation Begin-->
<div class="navbar" role="banner">
  <div class="container-fluid">
      <div class="navbar-header">
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse"></button>
        </div>
        <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
          <ul class="nav navbar-nav">
              <li><a href="/index.html" id="home">家</a></li>
                <li><a href="/getting-help.html" id="getting-help">获得帮助</a></li>
                <li><a href="/about/integrates.html" id="project-info">项目信息</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" id="documentation" data-toggle="dropdown">文献资料<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                      
                        
                          <li><a href="/releases/2.1.0/index.html">2.1.0</a></li>
                        
                      
                        
                          <li><a href="/releases/2.0.0/index.html">2.0.0</a></li>
                        
                      
                        
                          <li><a href="/releases/1.2.3/index.html">1.2.3</a></li>
                        
                      
                    </ul>
                </li>
                <li><a href="/talksAndVideos.html">讲座和幻灯片</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" id="contribute" data-toggle="dropdown">社区<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="/contribute/Contributing-to-Storm.html">贡献</a></li>
                        <li><a href="/contribute/People.html">人</a></li>
                        <li><a href="/contribute/BYLAWS.html">按照法律规定</a></li>
                    </ul>
                </li>
                <li><a href="/2019/10/31/storm210-released.html" id="news">新闻</a></li>
            </ul>
        </nav>
    </div>
</div>



    <div class="container-fluid">
    <h1 class="page-title">Storm HBase集成</h1>
          <div class="row">
           	<div class="col-md-12">
	             <!-- Documentation -->

<p class="post-meta"></p>

<div class="documentation-content"><p><a href="https://hbase.apache.org">Apache HBase的</a> Storm / Trident集成</p>

<h2 id="usage">用法</h2>

<p>与HBase进行交互的主要API是<code>org.apache.storm.hbase.bolt.mapper.HBaseMapper</code>接口：</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HBaseMapper</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="nf">rowKey</span><span class="o">(</span><span class="n">Tuple</span> <span class="n">tuple</span><span class="o">);</span>

    <span class="n">ColumnList</span> <span class="nf">columns</span><span class="o">(</span><span class="n">Tuple</span> <span class="n">tuple</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>的<code>rowKey()</code>方法很简单：给定一个Storm元组，返回代表行键的字节数组。</p>

<p>的<code>columns()</code>方法定义将写入HBase行的内容。的<code>ColumnList</code>类允许您同时添加标准HBase列和HBase计数器列。</p>

<p>要添加标准列，请使用<code>addColumn()</code>方法：</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">ColumnList</span> <span class="n">cols</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ColumnList</span><span class="o">();</span>
<span class="n">cols</span><span class="o">.</span><span class="na">addColumn</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">columnFamily</span><span class="o">,</span> <span class="n">field</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">toBytes</span><span class="o">(</span><span class="n">tuple</span><span class="o">.</span><span class="na">getValueByField</span><span class="o">(</span><span class="n">field</span><span class="o">)));</span>
</code></pre></div>
<p>要添加计数器列，请使用<code>addCounter()</code>方法：</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">ColumnList</span> <span class="n">cols</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ColumnList</span><span class="o">();</span>
<span class="n">cols</span><span class="o">.</span><span class="na">addCounter</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">columnFamily</span><span class="o">,</span> <span class="n">field</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">toLong</span><span class="o">(</span><span class="n">tuple</span><span class="o">.</span><span class="na">getValueByField</span><span class="o">(</span><span class="n">field</span><span class="o">)));</span>
</code></pre></div>
<p>当远程HBase启用安全性时，需要为storm-hbase连接器提供kerberos密钥表和相应的主体名称。具体来说，传递到拓扑中的Config对象应包含{（“ storm.keytab.file”，“ $ keytab”），（“ storm.kerberos.principal”，“ $ principal”）}。例：</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Config</span><span class="o">();</span>
<span class="o">...</span>
<span class="n">config</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"storm.keytab.file"</span><span class="o">,</span> <span class="s">"$keytab"</span><span class="o">);</span>
<span class="n">config</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"storm.kerberos.principal"</span><span class="o">,</span> <span class="s">"$principal"</span><span class="o">);</span>
<span class="n">StormSubmitter</span><span class="o">.</span><span class="na">submitTopology</span><span class="o">(</span><span class="s">"$topologyName"</span><span class="o">,</span> <span class="n">config</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">createTopology</span><span class="o">());</span>
</code></pre></div>
<h2 id="working-with-secure-hbase-using-delegation-tokens">使用委派令牌使用安全HBASE。</h2>

<p>如果您的拓扑结构要与安全的HBase进行交互，则必须通过HBase对螺栓/状态进行身份验证。上述方法要求所有潜在的工作主机上都带有“ storm.keytab.file”。如果群集上有多个拓扑，每个拓扑都有不同的hbase用户，则必须创建多个密钥表并将其分发给所有工作线程。除了这样做，您可以使用以下方法：</p>

<p>您的管理员可以将nimbus配置为代表拓扑提交者用户自动获取委派令牌。nimbus应该以以下配置启动：</p>
<div class="highlight"><pre><code class="language-" data-lang="">nimbus.autocredential.plugins.classes : ["org.apache.storm.hbase.security.AutoHBase"] 
nimbus.credential.renewers.classes : ["org.apache.storm.hbase.security.AutoHBase"] 
hbase.keytab.file: "/path/to/keytab/on/nimbus" (This is the keytab of hbase super user that can impersonate other users.)
hbase.kerberos.principal: "superuser@EXAMPLE.com"
nimbus.credential.renewers.freq.secs : 518400 (6 days, hbase tokens by default expire every 7 days and can not be renewed,  if you have custom settings for hbase.auth.token.max.lifetime in hbase-site.xml than you should ensure this value is atleast 1 hour less then that.)
</code></pre></div>
<p>您的拓扑配置应具有：</p>
<div class="highlight"><pre><code class="language-" data-lang="">topology.auto-credentials :["org.apache.storm.hbase.security.AutoHBase"]
</code></pre></div>
<p>如果nimbus没有上述配置，则需要添加它，然后重新启动它。确保nimbus的类路径中包含hbase配置文件（core-site.xml，hdfs-site.xml和hbase-site.xml）和具有所有依赖项的storm-hbase jar。</p>

<p>作为将配置文件（core-site.xml，hdfs-site.xml和hbase-site.xml）添加到类路径的替代方法，您可以将配置指定为拓扑配置的一部分。例如，在您自定义的storm.yaml中（或在提交拓扑时使用-c选项），</p>
<div class="highlight"><pre><code class="language-" data-lang="">hbaseCredentialsConfigKeys : ["cluster1", "cluster2"] (the hbase clusters you want to fetch the tokens from)
"cluster1": {"config1": "value1", "config2": "value2", ... } (A map of config key-values specific to cluster1)
"cluster2": {"config1": "value1", "hbase.keytab.file": "/path/to/keytab/for/cluster2/on/nimubs", "hbase.kerberos.principal": "cluster2user@EXAMPLE.com"} (here along with other configs, we have custom keytab and principal for "cluster2" which will override the keytab/principal specified at topology level)
</code></pre></div>
<p>除了指定键值，您还可以直接指定资源文件，例如，</p>
<div class="highlight"><pre><code class="language-" data-lang="">"cluster1": {"resources": ["/path/to/core-site1.xml", "/path/to/hbase-site1.xml"]}
"cluster2": {"resources": ["/path/to/core-site2.xml", "/path/to/hbase-site2.xml"]}
</code></pre></div>
<p>Storm将为每个群集分别下载令牌，并将其填充到主题中，并定期更新令牌。这样，可以运行多个螺栓，以连接到同一拓扑中的单独的HBase群集。</p>

<p>Nimbus将使用配置中指定的密钥表和主体对HBase进行身份验证。从那时起，对于每个拓扑提交，nimbus都会模拟拓扑提交者用户，并代表拓扑提交者用户获取委派令牌。如果拓扑是在topology.auto-credentials设置为AutoHBase的情况下启动的，则nimbus会将委托令牌推送给拓扑的所有工作程序，并且hbase螺栓/状态将使用这些令牌进行身份验证。</p>

<p>由于nimbus冒充拓扑提交者用户，因此您需要确保hbase.kerberos.principal中指定的用户有权代表其他用户获取令牌。为此，您需要遵循此链接上列出的配置说明</p>

<p><a href="http://hbase.apache.org/book/security.html#security.rest.gateway">http://hbase.apache.org/book/security.html#security.rest.gateway</a></p>

<p>您可以在此处阅读有关设置安全HBase的信息： <a href="http://hbase.apache.org/book/security.html">http</a> : <a href="http://hbase.apache.org/book/security.html">//hbase.apache.org/book/security.html</a> 。</p>

<h3 id="simplehbasemapper">SimpleHBaseMapper</h3>

<p><code>storm-hbase</code>包括通用<code>HBaseMapper</code>实现称为<code>SimpleHBaseMapper</code>可以将Storm元组映射到常规HBase列和计数器列。</p>

<p>使用<code>SimpleHBaseMapper</code> ，您只需告诉它要映射到哪些列类型的字段即可。</p>

<p>以下代码创建一个<code>SimpleHBaseMapper</code>实例表明：</p>

<ol>
<li>使用<code>word</code>元组值作为行键。</li>
<li>为元组字段添加标准的HBase列<code>word</code> 。</li>
<li>为元组字段添加HBase计数器列<code>count</code> 。</li>
<li>将值写入<code>cf</code>列族。</li>
</ol>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">SimpleHBaseMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleHBaseMapper</span><span class="o">()</span> 
        <span class="o">.</span><span class="na">withRowKeyField</span><span class="o">(</span><span class="s">"word"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withColumnFields</span><span class="o">(</span><span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"word"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">withCounterFields</span><span class="o">(</span><span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"count"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">withColumnFamily</span><span class="o">(</span><span class="s">"cf"</span><span class="o">);</span>
</code></pre></div>
<h3 id="hbasebolt">HBaseBolt</h3>

<p>要使用<code>HBaseBolt</code> ，使用要写入的表的名称构造它<code>HBaseMapper</code>实施：</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">HBaseBolt</span> <span class="n">hbase</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HBaseBolt</span><span class="o">(</span><span class="s">"WordCount"</span><span class="o">,</span> <span class="n">mapper</span><span class="o">);</span>
</code></pre></div>
<p>HBaseBolt参数</p>

<p>| Arg |描述|类型默认值| | --- | --- | --- | writeToWAL |启用耐久性SYNC_WAL或SKIP_WAL |布尔值（可选）|是的| configKey |任何与Hbase相关的配置|地图（可选）| | | batchSize |批处理的最大元组数一起写入HBase Int（可选）| 15000 | | flushIntervalSecs | （以秒为单位）如果> 0，则HBase Bolt将定期刷新事务批处理。建议启用此功能以避免在等待批处理填充时元组超时。| Int（可选）| 0 |</p>

<p>的<code>HBaseBolt</code>将委托给<code>mapper</code>实例以了解如何将元数据持久化到HBase。</p>

<h3 id="hbasevaluemapper">HBaseValueMapper</h3>

<p>此类允许您将HBase查找结果转换为风暴值，这些值将由<code>HBaseLookupBolt</code> 。</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HBaseValueMapper</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Values</span><span class="o">&gt;</span> <span class="nf">toTuples</span><span class="o">(</span><span class="n">Result</span> <span class="n">result</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
    <span class="kt">void</span> <span class="nf">declareOutputFields</span><span class="o">(</span><span class="n">OutputFieldsDeclarer</span> <span class="n">declarer</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>的<code>toTuples</code>方法采用HBase <code>Result</code>实例，并期望列表<code>Values</code>瞬间。此函数返回的每个值都将由<code>HBaseLookupBolt</code> 。</p>

<p>的<code>declareOutputFields</code>应该用来声明<code>HBaseLookupBolt</code> 。</p>

<p>有一个示例实现<code>examples/storm-hbase-examples/src/main/java</code>目录。</p>

<h3 id="hbaseprojectioncriteria">HBaseProjectionCriteria</h3>

<p>此类允许您为HBase Get函数指定投影条件。这是lookupBolt的可选参数，如果您不指定此实例，则所有列将由<code>HBaseLookupBolt</code> 。</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HBaseProjectionCriteria</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">HBaseProjectionCriteria</span> <span class="nf">addColumnFamily</span><span class="o">(</span><span class="n">String</span> <span class="n">columnFamily</span><span class="o">);</span>
    <span class="kd">public</span> <span class="n">HBaseProjectionCriteria</span> <span class="nf">addColumn</span><span class="o">(</span><span class="n">ColumnMetaData</span> <span class="n">column</span><span class="o">);</span>
</code></pre></div>
<p><code>addColumnFamily</code>接受columnFamily。设置此参数意味着该系列的所有列都将包含在投影中。</p>

<p><code>addColumn</code>接受columnMetaData实例。设置此参数意味着只有列family中的该列才是投影的一部分。以下代码创建一个projectionCriteria，它指定了一个投影条件：</p>

<ol>
<li>包括来自列族cf的count列。</li>
<li>包括列系列cf2中的所有列。</li>
</ol>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">HBaseProjectionCriteria</span> <span class="n">projectionCriteria</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HBaseProjectionCriteria</span><span class="o">()</span>
    <span class="o">.</span><span class="na">addColumn</span><span class="o">(</span><span class="k">new</span> <span class="n">HBaseProjectionCriteria</span><span class="o">.</span><span class="na">ColumnMetaData</span><span class="o">(</span><span class="s">"cf"</span><span class="o">,</span> <span class="s">"count"</span><span class="o">))</span>
    <span class="o">.</span><span class="na">addColumnFamily</span><span class="o">(</span><span class="s">"cf2"</span><span class="o">);</span>
</code></pre></div>
<h3 id="hbaselookupbolt">HBaseLookupBolt</h3>

<p>要使用<code>HBaseLookupBolt</code> ，使用要写入的表的名称构造它，实现<code>HBaseMapper</code>和一个实现<code>HBaseRowToStormValueMapper</code> 。您可以选择指定一个<code>HBaseProjectionCriteria</code> 。</p>

<p>的<code>HBaseLookupBolt</code>将使用映射器获取要查找的rowKey。它将使用<code>HBaseProjectionCriteria</code>找出要包括在结果中的列，它将利用<code>HBaseRowToStormValueMapper</code>获取要由螺栓发出的值。</p>

<p>除此之外<code>HBaseLookupBolt</code>使用使用咖啡因的内存LRU缓存支持螺栓端HBase结果缓存。要启用缓存：</p>

<p><code>hbase.cache.enable</code> -启用缓存（默认为false）</p>

<p><code>hbase.cache.ttl.seconds</code> -设置LRU缓存的生存时间（以秒为单位）（默认为300）</p>

<p><code>hbase.cache.size</code> -设置缓存大小（默认为1000）</p>

<p>您可以在下面查看示例拓扑LookupWordCount.java <code>examples/storm-hbase-examples/src/main/java</code> 。</p>

<h2 id="example-persistent-word-count">示例：持久字数</h2>

<p>一个可运行的示例可以在<code>examples/storm-hbase-examples/src/main/java</code>目录。</p>

<h3 id="setup">设定</h3>

<p>以下步骤假定您在本地运行HBase，或者有一个<code>hbase-site.xml</code>在指向您的HBase群集的类路径上。</p>

<p>使用<code>hbase shell</code>创建架构的命令：</p>
<div class="highlight"><pre><code class="language-" data-lang="">&gt; create 'WordCount', 'cf'
</code></pre></div>
<h3 id="execution">执行</h3>

<p>跑过<code>org.apache.storm.hbase.topology.PersistenWordCount</code>类（它将运行拓扑10秒钟，然后退出）。</p>

<p>在字数统计拓扑运行之后（或同时），运行<code>org.apache.storm.hbase.topology.WordCountClient</code>类以查看存储在HBase中的计数器值。您应该看到以下内容：</p>
<div class="highlight"><pre><code class="language-" data-lang="">Word: 'apple', Count: 6867
Word: 'orange', Count: 6645
Word: 'pineapple', Count: 6954
Word: 'banana', Count: 6787
Word: 'watermelon', Count: 6806
</code></pre></div>
<p>作为参考，下面列出了示例拓扑：</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PersistentWordCount</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">WORD_SPOUT</span> <span class="o">=</span> <span class="s">"WORD_SPOUT"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">COUNT_BOLT</span> <span class="o">=</span> <span class="s">"COUNT_BOLT"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">HBASE_BOLT</span> <span class="o">=</span> <span class="s">"HBASE_BOLT"</span><span class="o">;</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Config</span><span class="o">();</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">hbConf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">){</span>
            <span class="n">hbConf</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"hbase.rootdir"</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="n">config</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"hbase.conf"</span><span class="o">,</span> <span class="n">hbConf</span><span class="o">);</span>

        <span class="n">WordSpout</span> <span class="n">spout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WordSpout</span><span class="o">();</span>
        <span class="n">WordCounter</span> <span class="n">bolt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WordCounter</span><span class="o">();</span>

        <span class="n">SimpleHBaseMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleHBaseMapper</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withRowKeyField</span><span class="o">(</span><span class="s">"word"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withColumnFields</span><span class="o">(</span><span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"word"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withCounterFields</span><span class="o">(</span><span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"count"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withColumnFamily</span><span class="o">(</span><span class="s">"cf"</span><span class="o">);</span>

        <span class="n">HBaseBolt</span> <span class="n">hbase</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HBaseBolt</span><span class="o">(</span><span class="s">"WordCount"</span><span class="o">,</span> <span class="n">mapper</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withConfigKey</span><span class="o">(</span><span class="s">"hbase.conf"</span><span class="o">);</span>


        <span class="c1">// wordSpout ==&gt; countBolt ==&gt; HBaseBolt</span>
        <span class="n">TopologyBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TopologyBuilder</span><span class="o">();</span>

        <span class="n">builder</span><span class="o">.</span><span class="na">setSpout</span><span class="o">(</span><span class="n">WORD_SPOUT</span><span class="o">,</span> <span class="n">spout</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="n">COUNT_BOLT</span><span class="o">,</span> <span class="n">bolt</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="na">shuffleGrouping</span><span class="o">(</span><span class="n">WORD_SPOUT</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="n">HBASE_BOLT</span><span class="o">,</span> <span class="n">hbase</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="na">fieldsGrouping</span><span class="o">(</span><span class="n">COUNT_BOLT</span><span class="o">,</span> <span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"word"</span><span class="o">));</span>

        <span class="n">String</span> <span class="n">topoName</span> <span class="o">=</span> <span class="s">"test"</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">topoName</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">4</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hdfs url: "</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="s">", keytab file: "</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">+</span> 
                <span class="s">", principal name: "</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">+</span> <span class="s">", toplogy name: "</span> <span class="o">+</span> <span class="n">topoName</span><span class="o">);</span>
            <span class="n">hbConf</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">HBaseSecurityUtil</span><span class="o">.</span><span class="na">STORM_KEYTAB_FILE_KEY</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">]);</span>
            <span class="n">hbConf</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">HBaseSecurityUtil</span><span class="o">.</span><span class="na">STORM_USER_NAME_KEY</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="mi">3</span><span class="o">]);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Usage: PersistentWordCount &lt;hbase.rootdir&gt; [topology name] [keytab file] [principal name]"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">config</span><span class="o">.</span><span class="na">setNumWorkers</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
        <span class="n">StormSubmitter</span><span class="o">.</span><span class="na">submitTopology</span><span class="o">(</span><span class="n">topoName</span><span class="o">,</span> <span class="n">config</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">createTopology</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>


	          </div>
	       </div>
	  </div>
<footer>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>聚会</h5>
                    <ul class="latest-news">
                        
                        <li><a href="http://www.meetup.com/Apache-Storm-Apache-Kafka/">Apache Storm和Apache Kafka</a> <span class="small">（加利福尼亚州桑尼维尔）</span></li>
                        
                        <li><a href="http://www.meetup.com/Apache-Storm-Kafka-Users/">Apache Storm和Kafka用户</a> <span class="small">（华盛顿州西雅图）</span></li>
                        
                        <li><a href="http://www.meetup.com/New-York-City-Storm-User-Group/">NYC Storm用户组</a> <span class="small">（纽约州纽约）</span></li>
                        
                        <li><a href="http://www.meetup.com/Bay-Area-Stream-Processing">湾区流处理</a> <span class="small">（加利福尼亚州埃默里维尔）</span></li>
                        
                        <li><a href="http://www.meetup.com/Boston-Storm-Users/">波士顿实时数据</a> <span class="small">（马萨诸塞州波士顿）</span></li>
                        
                        <li><a href="http://www.meetup.com/storm-london">伦敦风暴用户组</a> <span class="small">（英国伦敦）</span></li>
                        
                        <!-- <li><a href="http://www.meetup.com/Apache-Storm-Kafka-Users/">Seatle, WA</a> <span class="small">(27 Jun 2015)</span></li> -->
                    </ul>
                </div>
            </div>
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>关于Apache Storm</h5>
                    <p>Apache Storm与任何排队系统和任何数据库系统集成。Apache Storm的喷口抽象使集成新排队系统变得容易。同样，将Apache Storm与数据库系统集成很容易。</p>
               </div>
            </div>
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>第一眼</h5>
                    <ul class="footer-list">
                        <li><a href="/releases/current/Rationale.html">基本原理</a></li>
                        <li><a href="/releases/current/Tutorial.html">讲解</a></li>
                        <li><a href="/releases/current/Setting-up-development-environment.html">搭建开发环境</a></li>
                        <li><a href="/releases/current/Creating-a-new-Storm-project.html">创建一个新的Apache Storm项目</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>文献资料</h5>
                    <ul class="footer-list">
                        <li><a href="/releases/current/index.html">指数</a></li>
                        <li><a href="/releases/current/javadocs/index.html">Java文档</a></li>
                        <li><a href="/releases/current/FAQ.html">常问问题</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <hr>
        <div class="row">   
            <div class="col-md-12">
                <p align="center">版权所有©2019 <a href="http://www.apache.org">Apache Software Foundation</a> 。版权所有。
                    <br>Apache Storm，Apache，Apache Feather徽标和Apache Storm项目徽标是The Apache Software Foundation的商标。
                    <br>提及的所有其他商标可能是其各自所有者的商标或注册商标。</p>
            </div>
        </div>
    </div>
</footer>
<!--Footer End-->
<!-- Scroll to top -->
<span class="totop"><a href="#"><i class="fa fa-angle-up"></i></a></span> 





</body></html>