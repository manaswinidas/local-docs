<html ><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <title>多语言协议</title>

    <!-- Bootstrap core CSS -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="/assets/css/bootstrap-theme.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="asset?aid=5">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/assets/css/owl.theme.css" rel="stylesheet">
    <link href="/assets/css/owl.carousel.css" rel="stylesheet">
    <script type="text/javascript" src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/owl.carousel.min.js"></script>
    <script type="text/javascript" src="/assets/js/storm.js"></script>
    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>


  <body >
    <header>
  <div class="container-fluid">
     <div class="row">
          <div class="col-md-5">
            <a href="/index.html"><img src="/images/logo.png" class="logo"></a>
          </div>
          <div class="col-md-5">
            
              <h1>版本：2.1.0</h1>
            
          </div>
          <div class="col-md-2">
            <a href="/downloads.html" class="btn-std btn-block btn-download">下载</a>
          </div>
        </div>
    </div>
</header>
<!--Header End-->
<!--Navigation Begin-->
<div class="navbar" role="banner">
  <div class="container-fluid">
      <div class="navbar-header">
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse"></button>
        </div>
        <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
          <ul class="nav navbar-nav">
              <li><a href="/index.html" id="home">家</a></li>
                <li><a href="/getting-help.html" id="getting-help">获得帮助</a></li>
                <li><a href="/about/integrates.html" id="project-info">项目信息</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" id="documentation" data-toggle="dropdown">文献资料<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                      
                        
                          <li><a href="/releases/2.1.0/index.html">2.1.0</a></li>
                        
                      
                        
                          <li><a href="/releases/2.0.0/index.html">2.0.0</a></li>
                        
                      
                        
                          <li><a href="/releases/1.2.3/index.html">1.2.3</a></li>
                        
                      
                    </ul>
                </li>
                <li><a href="/talksAndVideos.html">讲座和幻灯片</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" id="contribute" data-toggle="dropdown">社区<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="/contribute/Contributing-to-Storm.html">贡献</a></li>
                        <li><a href="/contribute/People.html">人</a></li>
                        <li><a href="/contribute/BYLAWS.html">按照法律规定</a></li>
                    </ul>
                </li>
                <li><a href="/2019/10/31/storm210-released.html" id="news">新闻</a></li>
            </ul>
        </nav>
    </div>
</div>



    <div class="container-fluid">
    <h1 class="page-title">多语言协议</h1>
          <div class="row">
           	<div class="col-md-12">
	             <!-- Documentation -->

<p class="post-meta"></p>

<div class="documentation-content"><p>本页说明从Storm 0.7.1开始的多语言协议。[此处]（Storm-multi-language-protocol-（versions-0.7.0-and-below）.html）记录了0.7.1之前的版本使用的协议有所不同。</p>

<h1 id="storm-multi-language-protocol">风暴多语言协议</h1>

<h2 id="supported-lanugages">支持的语言</h2>

<p>Storm Multi-Language具有以下语言的实现：</p>

<ul>
<li><a href="https://github.com/apache/storm/tree/master/storm-multilang/javascript">的JavaScript</a></li>
<li><a href="https://github.com/apache/storm/tree/master/storm-multilang/python">蟒蛇</a></li>
<li><a href="https://github.com/apache/storm/tree/master/storm-multilang/ruby">红宝石</a></li>
</ul>

<p>第三方库可用于以下语言：</p>

<ul>
<li><a href="https://github.com/Azure/net-storm-multilang-adapter">C＃（在.net core 2.0上）</a></li>
</ul>

<h2 id="shell-components">外壳组件</h2>

<p>通过ShellBolt，ShellSpout和ShellProcess类实现对多种语言的支持。这些类实现了IBolt和ISpout接口，以及使用Java的ProcessBuilder类通过外壳执行脚本或程序的协议。</p>

<h3 id="packaging-of-shell-scripts">包装外壳脚本</h3>

<p>默认情况下，ShellProcess假定您的代码打包在拓扑jar的jar子目录下，并且默认情况下会将可执行进程的当前工作目录更改为从jar提取的资源目录。jar文件不会在其中存储文件的权限。这包括执行位，该位将允许操作程序系统对shell脚本进行修改和运行。因此，在大多数示例中，脚本具有以下形式<code>python mybolt.py</code>因为python可执行文件已经在超级用户上，并且mybolt打包在jar的资源目录中。</p>

<p>如果您想打包更复杂的东西（例如python本身的新版本），则需要为此使用blob存储区，并且<code>.tgz</code>支持权限的存档。</p>

<p>有关如何运送罐子的更多详细信息，请参阅<a href="distcache-blobstore.html">Blob商店</a>上的文档。</p>

<p>要使ShellBolt / ShellSpout与Blob存储区dist缓存中随附的可执行文件和脚本一起工作，请添加</p>
<div class="highlight"><pre><code class="language-" data-lang="">changeChildCWD(false);
</code></pre></div>
<p>在ShellBolt / ShellSpout的构造函数中。然后，shell命令将相对于工作程序的cwd。到资源的符号链接所在的位置。</p>

<p>因此，如果我用名为symlink的python发货<code>newPython</code>和我运送到的Python ShellSpout <code>shell_spout.py</code>我会有类似的东西</p>
<div class="highlight"><pre><code class="language-" data-lang="">public MyShellSpout() {
    super("./newPython/bin/python", "./shell_spout.py");
    changeChildCWD(false);
}
</code></pre></div>
<h2 id="output-fields">输出栏位</h2>

<p>输出字段是拓扑的Thrift定义的一部分。这意味着在Java中使用多语言时，您需要创建一个扩展ShellBolt，实现IRichBolt并在其中声明字段的螺栓。 <code>declareOutputFields</code> （与ShellSpout相似）。</p>

<p>您可以在<a href="Concepts.html">概念</a>上了解更多</p>

<h2 id="protocol-preamble">协议序言</h2>

<p>通过执行的脚本或程序的STDIN和STDOUT实现简单的协议。与流程交换的所有数据均以JSON编码，从而使几乎所有语言都可以支持。</p>

<h1 id="packaging-your-stuff">包装你的东西</h1>

<p>要在群集上运行外壳程序组件，必须将外壳程序外壳中的脚本放在<code>resources/</code>将jar内的目录提交给主目录。</p>

<p>但是，在本地计算机上进行开发或测试期间，资源目录仅需要位于类路径中。</p>

<h2 id="the-protocol">协议书</h2>

<p>笔记：</p>

<ul>
<li>该协议的两端都使用行读取机制，因此请务必从输入中剪掉换行符并将其附加到输出中。</li>
<li>所有JSON输入和输出都由包含“ end”的一行终止。请注意，该分隔符本身不是JSON编码的。</li>
<li>下面的要点是从脚本编写者的STDIN和STDOUT的角度编写的。</li>
</ul>

<h3 id="initial-handshake">初始握手</h3>

<p>两种类型的外壳组件的初始握手都相同：</p>

<ul>
<li>STDIN：设置信息。这是具有Storm配置，PID目录和拓扑上下文的JSON对象，如下所示：</li>
</ul>
<div class="highlight"><pre><code class="language-" data-lang="">{
    "conf": {
        "topology.message.timeout.secs": 3,
        // etc
    },
    "pidDir": "...",
    "context": {
        "task-&gt;component": {
            "1": "example-spout",
            "2": "__acker",
            "3": "example-bolt1",
            "4": "example-bolt2"
        },
        "taskid": 3,
        // Everything below this line is only available in Storm 0.10.0+
        "componentid": "example-bolt"
        "stream-&gt;target-&gt;grouping": {
            "default": {
                "example-bolt2": {
                    "type": "SHUFFLE"}}},
        "streams": ["default"],
        "stream-&gt;outputfields": {"default": ["word"]},
        "source-&gt;stream-&gt;grouping": {
            "example-spout": {
                "default": {
                    "type": "FIELDS",
                    "fields": ["word"]
                }
            }
        }
        "source-&gt;stream-&gt;fields": {
            "example-spout": {
                "default": ["word"]
            }
        }
    }
}
</code></pre></div>
<p>您的脚本应在此目录中创建一个空文件，其PID命名。例如，PID为1234，因此将在目录中创建一个名为1234的空文件。该文件可让主管知道PID，以便以后可以关闭进程。</p>

<p>从Storm 0.10.0开始，Storm发送到Shell组件的上下文已得到实质性增强，以包括JVM组件可用的拓扑上下文的所有方面。一个关键的附加功能是可以通过以下方式确定拓扑中外壳组件的源和目标（即输入和输出）： <code>stream->target->grouping</code>和<code>source->stream->grouping</code>字典。在这些嵌套词典的最内层，分组表示为最小包含<code>type</code>键，但也可以有一个<code>fields</code>指定一个字段涉及的字段的键<code>FIELDS</code>分组。</p>

<ul>
<li>STDOUT：您的PID，位于JSON对象中，例如<code>{"pid": 1234}</code> 。Shell组件会将PID记录到其日志中。</li>
</ul>

<p>接下来会发生什么取决于组件的类型：</p>

<h3 id="spouts">喷口</h3>

<p>外壳喷口是同步的。其余的发生在while（true）循环中：</p>

<ul>
<li>STDIN：下一个，确认，激活，停用或失败命令。</li>
</ul>

<p>“下一个”等效于ISpout的<code>nextTuple</code> 。看起来像：</p>
<div class="highlight"><pre><code class="language-" data-lang="">{"command": "next"}
</code></pre></div>
<p>“ ack”看起来像：</p>
<div class="highlight"><pre><code class="language-" data-lang="">{"command": "ack", "id": "1231231"}
</code></pre></div>
<p>“激活”等同于ISpout的<code>activate</code> ：<code>{"command": "activate"}</code></p>

<p>“停用”等同于ISpout的<code>deactivate</code> ：<code>{"command": "deactivate"}</code></p>

<p>“失败”如下所示：</p>
<div class="highlight"><pre><code class="language-" data-lang="">{"command": "fail", "id": "1231231"}
</code></pre></div>
<ul>
<li>STDOUT：上一个命令的喷口结果。这可以是发射和日志的序列。</li>
</ul>

<p>发射看起来像：</p>
<div class="highlight"><pre><code class="language-" data-lang="">{
    "command": "emit",
    // The id for the tuple. Leave this out for an unreliable emit. The id can
    // be a string or a number.
    "id": "1231231",
    // The id of the stream this tuple was emitted to. Leave this empty to emit to default stream.
    "stream": "1",
    // If doing an emit direct, indicate the task to send the tuple to
    "task": 9,
    // All the values in this tuple
    "tuple": ["field1", 2, 3]
}
</code></pre></div>
<p>如果不执行直接发射，则您将立即收到在STDIN上将元组作为JSON数组发射到的任务ID。</p>

<p>一个“日志”将在工作日志中记录一条消息。看起来像：</p>
<div class="highlight"><pre><code class="language-" data-lang="">{
    "command": "log",
    // the message to log
    "msg": "hello world!"
}
</code></pre></div>
<ul>
<li>STDOUT：“同步”命令结束发射和日志的顺序。看起来像：</li>
</ul>
<div class="highlight"><pre><code class="language-" data-lang="">{"command": "sync"}
</code></pre></div>
<p>同步后，ShellSpout在发送另一个next，ack或fail命令之前将不会读取您的输出。</p>

<p>请注意，与ISpout相似，下一次，确认或失败后，工作器中的所有喷嘴都将被锁定，直到同步。就像ISpout一样，如果没有下一个元组要发出，则在同步之前您应该睡一小段时间。ShellSpout不会自动为您睡眠。</p>

<h3 id="bolts">螺栓</h3>

<p>外壳螺栓协议是异步的。您将在STDIN上立即收到元组，并且可能随时通过写入STDOUT来发出，确认和失败，并进行记录，如下所示：</p>

<ul>
<li>STDIN：元组！这是一个JSON编码的结构，如下所示：</li>
</ul>
<div class="highlight"><pre><code class="language-" data-lang="">{
    // The tuple's id - this is a string to support languages lacking 64-bit precision
    "id": "-6955786537413359385",
    // The id of the component that created this tuple
    "comp": "1",
    // The id of the stream this tuple was emitted to
    "stream": "1",
    // The id of the task that created this tuple
    "task": 9,
    // All the values in this tuple
    "tuple": ["snow white and the seven dwarfs", "field2", 3]
}
</code></pre></div>
<ul>
<li>STDOUT：确认，失败，发出或记录。发射看起来像：</li>
</ul>
<div class="highlight"><pre><code class="language-" data-lang="">{
    "command": "emit",
    // The ids of the tuples this output tuples should be anchored to
    "anchors": ["1231231", "-234234234"],
    // The id of the stream this tuple was emitted to. Leave this empty to emit to default stream.
    "stream": "1",
    // If doing an emit direct, indicate the task to send the tuple to
    "task": 9,
    // All the values in this tuple
    "tuple": ["field1", 2, 3]
}
</code></pre></div>
<p>如果不执行直接发出操作，您将收到在STDIN上以JSON数组向其发送元组的任务ID。请注意，由于Shell Bolt协议的异步性质，在发出后进行读取时，您可能不会收到任务ID。您可以改为读取先前发射的任务ID或要处理的新元组。但是，您将以与它们相应的发出相同的顺序接收任务ID列表。</p>

<p>ack看起来像：</p>
<div class="highlight"><pre><code class="language-" data-lang="">{
    "command": "ack",
    // the id of the tuple to ack
    "id": "123123"
}
</code></pre></div>
<p>失败看起来像：</p>
<div class="highlight"><pre><code class="language-" data-lang="">{
    "command": "fail",
    // the id of the tuple to fail
    "id": "123123"
}
</code></pre></div>
<p>一个“日志”将在工作日志中记录一条消息。看起来像：</p>
<div class="highlight"><pre><code class="language-" data-lang="">{
    "command": "log",
    // the message to log
    "msg": "hello world!"
}
</code></pre></div>
<ul>
<li>请注意，从0.7.1版开始，不再需要外壳螺栓来“同步”。</li>
</ul>

<h3 id="handling-heartbeats-0-9-3-and-later">处理心跳（0.9.3及更高版本）</h3>

<p>从Storm 0.9.3开始，ShellSpout / ShellBolt和它们的多语言子进程之间一直处于心跳状态，以检测挂起/僵尸子进程。任何通过多语言与Storm进行交互的库都必须对听音采取以下措施：</p>

<h4 id="spout">喷口</h4>

<p>Shell喷口是同步的，因此子流程始终发送<code>sync</code>最后的命令<code>next()</code> ，因此您无需做太多事情来支持喷嘴的心跳。就是说，在执行过程中，子进程的睡眠时间不得超过工作者超时的时间<code>next()</code> 。</p>

<h4 id="bolt">螺栓</h4>

<p>Shell螺栓是异步的，因此ShellBolt将定期将心跳元组发送到其子进程。心跳元组看起来像：</p>
<div class="highlight"><pre><code class="language-" data-lang="">{
    "id": "-6955786537413359385",
    "comp": "1",
    "stream": "__heartbeat",
    // this shell bolt's system task id
    "task": -1,
    "tuple": []
}
</code></pre></div>
<p>子流程收到心跳元组时，必须发送一个<code>sync</code>命令回到ShellBolt。</p>
</div>


	          </div>
	       </div>
	  </div>
<footer>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>聚会</h5>
                    <ul class="latest-news">
                        
                        <li><a href="http://www.meetup.com/Apache-Storm-Apache-Kafka/">Apache Storm和Apache Kafka</a> <span class="small">（加利福尼亚州桑尼维尔）</span></li>
                        
                        <li><a href="http://www.meetup.com/Apache-Storm-Kafka-Users/">Apache Storm和Kafka用户</a> <span class="small">（华盛顿州西雅图）</span></li>
                        
                        <li><a href="http://www.meetup.com/New-York-City-Storm-User-Group/">NYC Storm用户组</a> <span class="small">（纽约州纽约）</span></li>
                        
                        <li><a href="http://www.meetup.com/Bay-Area-Stream-Processing">湾区流处理</a> <span class="small">（加利福尼亚州埃默里维尔）</span></li>
                        
                        <li><a href="http://www.meetup.com/Boston-Storm-Users/">波士顿实时数据</a> <span class="small">（马萨诸塞州波士顿）</span></li>
                        
                        <li><a href="http://www.meetup.com/storm-london">伦敦风暴用户组</a> <span class="small">（英国伦敦）</span></li>
                        
                        <!-- <li><a href="http://www.meetup.com/Apache-Storm-Kafka-Users/">Seatle, WA</a> <span class="small">(27 Jun 2015)</span></li> -->
                    </ul>
                </div>
            </div>
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>关于Apache Storm</h5>
                    <p>Apache Storm与任何排队系统和任何数据库系统集成。Apache Storm的喷口抽象使集成新排队系统变得容易。同样，将Apache Storm与数据库系统集成很容易。</p>
               </div>
            </div>
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>第一眼</h5>
                    <ul class="footer-list">
                        <li><a href="/releases/current/Rationale.html">基本原理</a></li>
                        <li><a href="/releases/current/Tutorial.html">讲解</a></li>
                        <li><a href="/releases/current/Setting-up-development-environment.html">搭建开发环境</a></li>
                        <li><a href="/releases/current/Creating-a-new-Storm-project.html">创建一个新的Apache Storm项目</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>文献资料</h5>
                    <ul class="footer-list">
                        <li><a href="/releases/current/index.html">指数</a></li>
                        <li><a href="/releases/current/javadocs/index.html">Java文档</a></li>
                        <li><a href="/releases/current/FAQ.html">常问问题</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <hr>
        <div class="row">   
            <div class="col-md-12">
                <p align="center">版权所有©2019 <a href="http://www.apache.org">Apache Software Foundation</a> 。版权所有。
                    <br>Apache Storm，Apache，Apache Feather徽标和Apache Storm项目徽标是The Apache Software Foundation的商标。
                    <br>提及的所有其他商标可能是其各自所有者的商标或注册商标。</p>
            </div>
        </div>
    </div>
</footer>
<!--Footer End-->
<!-- Scroll to top -->
<span class="totop"><a href="#"><i class="fa fa-angle-up"></i></a></span> 





</body></html>