<html ><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <title>Storm SQL集成</title>

    <!-- Bootstrap core CSS -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="/assets/css/bootstrap-theme.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="asset?aid=5">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/assets/css/owl.theme.css" rel="stylesheet">
    <link href="/assets/css/owl.carousel.css" rel="stylesheet">
    <script type="text/javascript" src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/owl.carousel.min.js"></script>
    <script type="text/javascript" src="/assets/js/storm.js"></script>
    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>


  <body >
    <header>
  <div class="container-fluid">
     <div class="row">
          <div class="col-md-5">
            <a href="/index.html"><img src="/images/logo.png" class="logo"></a>
          </div>
          <div class="col-md-5">
            
              <h1>版本：2.1.0</h1>
            
          </div>
          <div class="col-md-2">
            <a href="/downloads.html" class="btn-std btn-block btn-download">下载</a>
          </div>
        </div>
    </div>
</header>
<!--Header End-->
<!--Navigation Begin-->
<div class="navbar" role="banner">
  <div class="container-fluid">
      <div class="navbar-header">
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse"></button>
        </div>
        <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
          <ul class="nav navbar-nav">
              <li><a href="/index.html" id="home">家</a></li>
                <li><a href="/getting-help.html" id="getting-help">获得帮助</a></li>
                <li><a href="/about/integrates.html" id="project-info">项目信息</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" id="documentation" data-toggle="dropdown">文献资料<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                      
                        
                          <li><a href="/releases/2.1.0/index.html">2.1.0</a></li>
                        
                      
                        
                          <li><a href="/releases/2.0.0/index.html">2.0.0</a></li>
                        
                      
                        
                          <li><a href="/releases/1.2.3/index.html">1.2.3</a></li>
                        
                      
                    </ul>
                </li>
                <li><a href="/talksAndVideos.html">讲座和幻灯片</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" id="contribute" data-toggle="dropdown">社区<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="/contribute/Contributing-to-Storm.html">贡献</a></li>
                        <li><a href="/contribute/People.html">人</a></li>
                        <li><a href="/contribute/BYLAWS.html">按照法律规定</a></li>
                    </ul>
                </li>
                <li><a href="/2019/10/31/storm210-released.html" id="news">新闻</a></li>
            </ul>
        </nav>
    </div>
</div>



    <div class="container-fluid">
    <h1 class="page-title">Storm SQL集成</h1>
          <div class="row">
           	<div class="col-md-12">
	             <!-- Documentation -->

<p class="post-meta"></p>

<div class="documentation-content"><p>Storm SQL集成允许用户对Storm中的流数据运行SQL查询。SQL界面不仅可以加快流分析的开发周期，而且还为统一批处理数据（如<a href="///hive.apache.org">Apache Hive</a>和实时流数据分析）提供了机会。</p>

<p>在较高级别，StormSQL使用Streams API将SQL查询编译到Storm拓扑，并在Storm集群中执行它们。本文档提供有关如何将StormSQL用作最终用户的信息。对于对StormSQL的设计和实现的更多细节感兴趣的人，请参阅<a href="storm-sql-internal.html">此</a>页面。</p>

<p>Storm SQL集成是一个<code>experimental</code>功能，因此Storm SQL内部和支持的功能可能会发生变化。但是小的更改不会影响用户体验。引入破坏性的UX更改时，我们将通知/通知用户。</p>

<h2 id="usage">用法</h2>

<p>跑过<code>storm sql</code>命令将SQL语句编译为Storm拓扑，并将其提交到Storm集群</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ bin/storm sql &lt;sql-file&gt; &lt;topo-name&gt;
</code></pre></div>
<p>在其中<code>sql-file</code>包含要执行的SQL语句的列表，以及<code>topo-name</code>是拓扑的名称。</p>

<p>StormSQL激活<code>explain mode</code>并在用户指定时显示查询计划而不是提交拓扑<code>topo-name</code>如<code>--explain</code> 。详细说明可从以下网站获得<code>Showing Query Plan (explain mode)</code>部分。</p>

<h2 id="supported-features">支持的功能</h2>

<p>当前存储库中支持以下功能：</p>

<ul>
<li>与外部数据源之间的流传输</li>
<li>过滤元组</li>
<li>投影</li>
<li>用户定义的函数（标量）</li>
</ul>

<p>暂时不支持聚合和联接。Storm SQL何时将支持本机<code>Streaming SQL</code> ，将介绍这些功能。</p>

<p>请注意，由于Storm使用<a href="///calcite.apache.org">Apache Calcite</a>解析提供的SQL，因此您可能会受益于Calcite文档的浏览，特别是关于<a href="https://calcite.apache.org/docs/reference.html#identifiers">identifiers</a>的部分。</p>

<h2 id="specifying-external-data-sources">指定外部数据源</h2>

<p>在StormSQL中，数据由外部表表示。用户可以使用<code>CREATE EXTERNAL TABLE</code>声明。的语法<code>CREATE EXTERNAL TABLE</code>紧密遵循<a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL">Hive数据定义语言中</a>定义的一种：</p>
<div class="highlight"><pre><code class="language-" data-lang="">CREATE EXTERNAL TABLE table_name field_list
    [ STORED AS
      INPUTFORMAT input_format_classname
      OUTPUTFORMAT output_format_classname
    ]
    LOCATION location
    [ PARALLELISM parallelism ]
    [ TBLPROPERTIES tbl_properties ]
    [ AS select_stmt ]
</code></pre></div>
<p>您可以在<a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL">Hive数据定义语言中</a>找到有关属性的详细说明。</p>

<p><code>PARALLELISM</code>是StormSQL自己的关键字，用于描述输入数据源的并行提示。这与向Spout提供并行提示相同。下游运算符在重新分区之前以相同的并行性执行（聚合触发重新分区）。</p>

<p>默认值为1，此选项对输出数据源无效。（如果需要，我们可能会更改。通常需要避免重新分区。）</p>

<p>例如，以下语句指定一个Kafka出口和接收器：</p>
<div class="highlight"><pre><code class="language-" data-lang="">CREATE EXTERNAL TABLE FOO (ID INT PRIMARY KEY) LOCATION 'kafka://test?bootstrap-servers=localhost:9092' TBLPROPERTIES '{"producer":{"acks":"1","key.serializer":"org.apache.storm.kafka.IntSerializer"}}'
</code></pre></div>
<h2 id="plugging-in-external-data-sources">插入外部数据源</h2>

<p>用户通过实施以下操作插入外部数据源<code>ISqlStreamsDataSource</code>接口并使用Java的服务加载程序的机制注册它们。将根据表URI的方案选择外部数据源。请参考执行<code>storm-sql-kafka</code>更多细节。</p>

<h2 id="specifying-user-defined-function-udf">指定用户定义功能（UDF）</h2>

<p>用户可以使用以下命令定义用户定义的函数（标量） <code>CREATE FUNCTION</code>声明。例如，以下语句定义<code>MYPLUS</code>使用的功能<code>org.apache.storm.sql.TestUtils$MyPlus</code>类。</p>
<div class="highlight"><pre><code class="language-" data-lang="">CREATE FUNCTION MYPLUS AS 'org.apache.storm.sql.TestUtils$MyPlus'
</code></pre></div>
<p>Storm SQL通过检查定义了哪些方法来确定函数是标量函数还是聚合函数。如果该类定义<code>evaluate</code>方法，Storm SQL将函数视为<code>scalar</code> 。</p>

<p>标量函数的类示例在这里：</p>
<div class="highlight"><pre><code class="language-" data-lang="">  public class MyPlus {
    public static Integer evaluate(Integer x, Integer y) {
      return x + y;
    }
  }

</code></pre></div>
<h2 id="example-filtering-kafka-stream">示例：过滤Kafka流</h2>

<p>假设有一个Kafka流代表订单交易。流中的每个消息都包含订单的ID，产品的单价和订单的数量。目标是过滤交易量较大的订单，并将这些订单插入另一个Kafka流中以进行进一步分析。</p>

<p>用户可以在SQL文件中指定以下SQL语句：</p>
<div class="highlight"><pre><code class="language-" data-lang="">CREATE EXTERNAL TABLE ORDERS (ID INT PRIMARY KEY, UNIT_PRICE INT, QUANTITY INT) LOCATION 'kafka://orders?bootstrap-servers=localhost:9092,localhost:9093'
CREATE EXTERNAL TABLE LARGE_ORDERS (ID INT PRIMARY KEY, TOTAL INT) LOCATION 'kafka://large_orders?bootstrap-servers=localhost:9092,localhost:9093' TBLPROPERTIES '{"producer":{"acks":"1","key.serializer":"org.apache.storm.kafka.IntSerializer"}}'
INSERT INTO LARGE_ORDERS SELECT ID, UNIT_PRICE * QUANTITY AS TOTAL FROM ORDERS WHERE UNIT_PRICE * QUANTITY &gt; 50
</code></pre></div>
<p>第一条语句定义表<code>ORDER</code>代表输入流。的<code>LOCATION</code>子句指定Kafka引导服务器（ <code>localhost:9092,localhost:9093</code> ）和主题（ <code>orders</code> ）。</p>

<p>同样，第二条语句指定表<code>LARGE_ORDERS</code>代表输出流。的<code>TBLPROPERTIES</code>子句指定<a href="http://kafka.apache.org/documentation.html#producerconfigs">KafkaProducer</a>的配置，并且是Kafka接收器表所必需的。</p>

<p>第三句话是<code>SELECT</code>定义拓扑的语句：它指示StormSQL过滤外部表中的所有订单<code>ORDERS</code> ，计算总价并将匹配的记录插入由指定的Kafka流中<code>LARGE_ORDER</code> 。</p>

<p>要运行此示例，用户需要包括数据源（ <code>storm-sql-kafka</code>在这种情况下）及其在类路径中的依赖关系。用户运行时将自动处理Storm SQL核心依赖关系<code>storm sql</code> 。用户可以在提交步骤中包括数据源，如下所示：</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ bin/storm sql order_filtering.sql order_filtering --artifacts "org.apache.storm:storm-sql-kafka:2.0.0-SNAPSHOT,org.apache.storm:storm-kafka-client:2.0.0-SNAPSHOT,org.apache.kafka:kafka-clients:1.1.0^org.slf4j:slf4j-log4j12"
</code></pre></div>
<p>上面的命令将SQL语句提交给StormSQL。如果用户使用不同版本的Storm或Kafka，则用户需要修改每个工件的版本。</p>

<p>运行上面的命令后，您现在应该可以看到<code>order_filtering</code> Storm UI中的拓扑。</p>

<h2 id="showing-query-plan-explain-mode">显示查询计划（解释模式）</h2>

<p>喜欢<code>explain</code>在SQL语句上，StormSQL提供<code>explain mode</code>运行Storm SQL Runner时。在解释模式下，StormSQL分析每个查询语句（仅DML）并显示计划，而不是提交拓扑。</p>

<p>为了运行<code>explain mode</code> ，您需要提供以下拓扑名称： <code>--explain</code>并运行<code>storm sql</code>与提交相同。</p>

<p>例如，当您以解释模式运行上面的示例时：</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ bin/storm sql order_filtering.sql --explain --artifacts "org.apache.storm:storm-sql-kafka:2.0.0-SNAPSHOT,org.apache.storm:storm-kafka-client:2.0.0-SNAPSHOT,org.apache.kafka:kafka-clients:1.1.0^org.slf4j:slf4j-log4j12"
</code></pre></div>
<p>StormSQL的输出如下所示：</p>
<div class="highlight"><pre><code class="language-" data-lang="">
===========================================================
query&gt;
CREATE EXTERNAL TABLE ORDERS (ID INT PRIMARY KEY, UNIT_PRICE INT, QUANTITY INT) LOCATION 'kafka://orders?bootstrap-servers=localhost:9092,localhost:9093'
-----------------------------------------------------------
17:03:06.040 [main] INFO  o.a.s.s.r.DataSourcesRegistry - Registering scheme socket with org.apache.storm.sql.runtime.datasource.socket.SocketDataSourcesProvider@d62fe5b
17:03:06.090 [main] INFO  o.a.s.s.r.DataSourcesRegistry - Registering scheme kafka with org.apache.storm.sql.kafka.KafkaDataSourcesProvider@34158c08
17:03:06.290 [main] INFO  o.a.s.k.s.KafkaSpoutConfig - Setting Kafka consumer property 'auto.offset.reset' to 'earliest' to ensure at-least-once processing
17:03:06.290 [main] INFO  o.a.s.k.s.KafkaSpoutConfig - Setting Kafka consumer property 'enable.auto.commit' to 'false', because the spout does not support auto-commit
No plan presented on DDL
===========================================================
===========================================================
query&gt;
CREATE EXTERNAL TABLE LARGE_ORDERS (ID INT PRIMARY KEY, TOTAL INT) LOCATION 'kafka://large_orders?bootstrap-servers=localhost:9092,localhost:9093' TBLPROPERTIES '{"producer":{"acks":"1","key.serializer":"org.apache.storm.kafka.IntSerializer"}}'
-----------------------------------------------------------
17:03:06.504 [main] INFO  o.a.s.k.s.KafkaSpoutConfig - Setting Kafka consumer property 'auto.offset.reset' to 'earliest' to ensure at-least-once processing
17:03:06.504 [main] INFO  o.a.s.k.s.KafkaSpoutConfig - Setting Kafka consumer property 'enable.auto.commit' to 'false', because the spout does not support auto-commit
No plan presented on DDL
===========================================================
===========================================================
query&gt;
INSERT INTO LARGE_ORDERS SELECT ID, UNIT_PRICE * QUANTITY AS TOTAL FROM ORDERS WHERE UNIT_PRICE * QUANTITY &gt; 50
-----------------------------------------------------------
plan&gt;
LogicalTableModify(table=[[LARGE_ORDERS]], operation=[INSERT], flattened=[true])
  LogicalProject(ID=[$0], TOTAL=[*($1, $2)])
    LogicalFilter(condition=[&gt;(*($1, $2), 50)])
      EnumerableTableScan(table=[[ORDERS]])

===========================================================

</code></pre></div>
<h2 id="debugging-expressions">调试表达式</h2>

<p>提交Storm SQL拓扑时，将记录基于SQL表达式生成的代码。例如，订单过滤示例中的WHERE子句将在提交期间生成以下日志：</p>
<div class="highlight"><pre><code class="language-" data-lang="">17:37:55.344 [main] INFO  o.a.s.s.r.s.f.EvaluationCalc - Expression code for filter:
public class Generated_STREAMSCALCREL_33_0 implements org.apache.storm.sql.runtime.calcite.ExecutableExpression {
  public void execute(org.apache.calcite.interpreter.Context context, Object[] outputValues) {
    final Object[] current = context.values;
    outputValues[0] = org.apache.calcite.runtime.SqlFunctions.toInt(current[1]) * org.apache.calcite.runtime.SqlFunctions.toInt(current[2]) &gt; 50;
  }

  public Object execute(org.apache.calcite.interpreter.Context context) {
    final Object[] values = new Object[1];
    this.execute(context, values);
    return values[0];
  }

}
</code></pre></div>
<p>如果您需要调试拓扑，这将很有帮助。</p>

<h2 id="current-limitations">电流限制</h2>

<ul>
<li>窗口化尚未实现。</li>
<li>在支持窗口化之后将引入聚合和联接。</li>
</ul>
</div>


	          </div>
	       </div>
	  </div>
<footer>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>聚会</h5>
                    <ul class="latest-news">
                        
                        <li><a href="http://www.meetup.com/Apache-Storm-Apache-Kafka/">Apache Storm和Apache Kafka</a> <span class="small">（加利福尼亚州桑尼维尔）</span></li>
                        
                        <li><a href="http://www.meetup.com/Apache-Storm-Kafka-Users/">Apache Storm和Kafka用户</a> <span class="small">（华盛顿州西雅图）</span></li>
                        
                        <li><a href="http://www.meetup.com/New-York-City-Storm-User-Group/">NYC Storm用户组</a> <span class="small">（纽约州纽约）</span></li>
                        
                        <li><a href="http://www.meetup.com/Bay-Area-Stream-Processing">湾区流处理</a> <span class="small">（加利福尼亚州埃默里维尔）</span></li>
                        
                        <li><a href="http://www.meetup.com/Boston-Storm-Users/">波士顿实时数据</a> <span class="small">（马萨诸塞州波士顿）</span></li>
                        
                        <li><a href="http://www.meetup.com/storm-london">伦敦风暴用户组</a> <span class="small">（英国伦敦）</span></li>
                        
                        <!-- <li><a href="http://www.meetup.com/Apache-Storm-Kafka-Users/">Seatle, WA</a> <span class="small">(27 Jun 2015)</span></li> -->
                    </ul>
                </div>
            </div>
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>关于Apache Storm</h5>
                    <p>Apache Storm与任何排队系统和任何数据库系统集成。Apache Storm的喷口抽象使集成新排队系统变得容易。同样，将Apache Storm与数据库系统集成很容易。</p>
               </div>
            </div>
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>第一眼</h5>
                    <ul class="footer-list">
                        <li><a href="/releases/current/Rationale.html">基本原理</a></li>
                        <li><a href="/releases/current/Tutorial.html">讲解</a></li>
                        <li><a href="/releases/current/Setting-up-development-environment.html">搭建开发环境</a></li>
                        <li><a href="/releases/current/Creating-a-new-Storm-project.html">创建一个新的Apache Storm项目</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>文献资料</h5>
                    <ul class="footer-list">
                        <li><a href="/releases/current/index.html">指数</a></li>
                        <li><a href="/releases/current/javadocs/index.html">Java文档</a></li>
                        <li><a href="/releases/current/FAQ.html">常问问题</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <hr>
        <div class="row">   
            <div class="col-md-12">
                <p align="center">版权所有©2019 <a href="http://www.apache.org">Apache Software Foundation</a> 。版权所有。
                    <br>Apache Storm，Apache，Apache Feather徽标和Apache Storm项目徽标是The Apache Software Foundation的商标。
                    <br>提及的所有其他商标可能是其各自所有者的商标或注册商标。</p>
            </div>
        </div>
    </div>
</footer>
<!--Footer End-->
<!-- Scroll to top -->
<span class="totop"><a href="#"><i class="fa fa-angle-up"></i></a></span> 





</body></html>