<html lang="zh-Hans" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><link href="./images/docs-stylesheet.css" rel="stylesheet" type="text/css"><title>Apache Tomcat 9（9.0.21）-类加载器方法</title><meta name="author" content="Craig R. McClanahan"><meta name="author" content="Yoav Shapira"><script type="application/javascript" data-comments-identifier="tomcat-9.0-doc/class-loader-howto">
    "use strict"; // Enable strict mode

    (function() {
      var thisScript = document.currentScript;
      if (!thisScript) { // Workaround for IE <= 11
        var scripts = document.getElementsByTagName("script");
        thisScript = scripts[scripts.length - 1];
      }
      document.addEventListener("DOMContentLoaded", (function() {
        var commentsDiv = document.getElementById("comments_thread");
        var commentsShortname = "tomcat";
        var commentsIdentifier = "https://tomcat.apache.org/" +
          thisScript.getAttribute("data-comments-identifier") + ".html";

        (function(w, d) {
          if (w.location.hostname.toLowerCase() == "tomcat.apache.org") {
            var s = d.createElement("script");
            s.type = "application/javascript";
            s.async = true;
            s.src = "https://comments.apache.org/show_comments.lua?site=" +
              encodeURIComponent(commentsShortname) +
              "&page=" + encodeURIComponent(commentsIdentifier);
            d.head.appendChild(s);
          } else {
            commentsDiv.appendChild(d.createTextNode("Comments are disabled for this page at the moment."));
          }
        })(window, document);
      }), false);
    })();
  </script></head><body ><div id="wrapper"><header><div id="header"><div><div><div class="logo noPrint"><a href="https://tomcat.apache.org/"><img alt="Tomcat主页" src="./images/tomcat.png"></a></div><div style="height:1px"></div><div class="asfLogo noPrint"><a href="https://www.apache.org/" target="_blank"><img src="./images/asf-logo.svg" alt="Apache软件基金会" style="width:266px;height:83px"></a></div><h1>Apache Tomcat 9</h1><div class="versionInfo">版本9.0.21， <time datetime="2019-06-04"> 2019年6月4日</time></div><div style="height:1px"></div><div style="clear:left"></div></div></div></div></header><div id="middle"><div><div id="mainLeft" class="noprint"><div><nav><div><h2>链接</h2><ul><li><a href="index.html">文件首页</a></li><li><a href="https://wiki.apache.org/tomcat/FAQ">常问问题</a></li><li><a href="#comments_section">用户评论</a></li></ul></div><div><h2>用户指南</h2><ul><li><a href="introduction.html">1）简介</a></li><li><a href="setup.html">2）设定</a></li><li><a href="appdev/index.html">3）第一个webapp</a></li><li><a href="deployer-howto.html">4）部署者</a></li><li><a href="manager-howto.html">5）经理</a></li><li><a href="host-manager-howto.html">6）主机管理员</a></li><li><a href="realm-howto.html">7）领域和AAA</a></li><li><a href="security-manager-howto.html">8）安全经理</a></li><li><a href="jndi-resources-howto.html">9）JNDI资源</a></li><li><a href="jndi-datasource-examples-howto.html">10）JDBC数据源</a></li><li><a href="class-loader-howto.html">11）类加载</a></li><li><a href="jasper-howto.html">12）JSP</a></li><li><a href="ssl-howto.html">13）SSL / TLS</a></li><li><a href="ssi-howto.html">14）SSI</a></li><li><a href="cgi-howto.html">15）CGI</a></li><li><a href="proxy-howto.html">16）代理支持</a></li><li><a href="mbeans-descriptors-howto.html">17）MBean描述符</a></li><li><a href="default-servlet.html">18）默认Servlet</a></li><li><a href="cluster-howto.html">19）聚类</a></li><li><a href="balancer-howto.html">20）负载均衡器</a></li><li><a href="connectors.html">21）连接器</a></li><li><a href="monitoring.html">22）监控与管理</a></li><li><a href="logging.html">23）记录</a></li><li><a href="apr.html">24）APR /本地</a></li><li><a href="virtual-hosting-howto.html">25）虚拟主机</a></li><li><a href="aio.html">26）高级IO</a></li><li><a href="extras.html">27）附加组件</a></li><li><a href="maven-jars.html">28）行刑</a></li><li><a href="security-howto.html">29）安全注意事项</a></li><li><a href="windows-service-howto.html">30）Windows服务</a></li><li><a href="windows-auth-howto.html">31）Windows身份验证</a></li><li><a href="jdbc-pool.html">32）Tomcat的JDBC池</a></li><li><a href="web-socket-howto.html">33）WebSocket</a></li><li><a href="rewrite.html">34）改写</a></li></ul></div><div><h2>参考</h2><ul><li><a href="RELEASE-NOTES.txt">发行说明</a></li><li><a href="config/index.html">组态</a></li><li><a href="api/index.html">Tomcat Java文档</a></li><li><a href="servletapi/index.html">Servlet Java文档</a></li><li><a href="jspapi/index.html">JSP 2.3 Java文档</a></li><li><a href="elapi/index.html">EL 3.0 Java文档</a></li><li><a href="websocketapi/index.html">WebSocket 1.1 Java文档</a></li><li><a href="https://tomcat.apache.org/connectors-doc/">JK 1.2文档</a></li></ul></div><div><h2>Apache Tomcat开发</h2><ul><li><a href="building.html">建造</a></li><li><a href="changelog.html">变更日志</a></li><li><a href="https://wiki.apache.org/tomcat/TomcatVersions">状态</a></li><li><a href="developers.html">开发者</a></li><li><a href="architecture/index.html">建筑</a></li><li><a href="funcspecs/index.html">功能规格。</a></li><li><a href="tribes/introduction.html">部族</a></li></ul></div></nav></div></div><div id="mainRight"><div id="content"><h2>类加载器的使用方法</h2><h3 id="Table_of_Contents">目录</h3><div class="text">
<ul><li><a href="#Overview">总览</a></li><li><a href="#Class_Loader_Definitions">类加载器定义</a></li><li><a href="#XML_Parsers_and_Java">XML解析器和Java</a></li><li><a href="#Running_under_a_security_manager">在安全管理器下运行</a></li><li><a href="#Advanced_configuration">进阶设定</a></li></ul>
</div><h3 id="Overview">总览</h3><div class="text">

<p>像许多服务器应用程序一样，Tomcat安装了各种类加载器（即，实现<code>java.lang.ClassLoader</code> ），以允许容器的不同部分以及在容器上运行的Web应用程序可以访问可用类和资源的不同存储库。该机制用于提供Servlet规范2.4版中定义的功能-特别是9.4和9.6节。</p>

<p>在Java环境中，类加载器排列在父子树中。通常，当要求类加载器加载特定的类或资源时，它首先将请求委派给父类加载器，然后仅在父类加载器找不到所请求的类或资源时，才在其自己的存储库中查找。请注意，Web应用程序类加载器的模型<em>与</em>此略有<em>不同</em> ，如下所述，但是主要原理是相同的。</p>

<p>启动Tomcat时，它将创建一组类加载器，这些类加载器被组织为以下父子关系，其中父类加载器位于子类加载器之上：</p>

<div class="codeBox"><pre><code>      Bootstrap
          |
       System
          |
       Common
       /     \
  Webapp1   Webapp2 ...</code></pre></div>

<p>下一节将详细讨论这些类加载器的每个特征，包括它们的类源和可见的资源。</p>

</div><h3 id="Class_Loader_Definitions">类加载器定义</h3><div class="text">

<p>如上图所示，Tomcat在初始化时会创建以下类加载器：</p>
<ul>
<li><p><strong>Bootstrap-</strong>该类加载器包含Java虚拟机提供的基本运行时类，以及System Extensions目录中存在的JAR文件中的所有类（ <code>$JAVA_HOME/jre/lib/ext</code> ）。<em>注意</em> ：某些JVM可能将其实现为多个类加载器，或者可能根本不可见（作为类加载器）。</p></li>
<li><p><strong>系统</strong> -该类加载器通常是根据<code>CLASSPATH</code>环境变量。所有这些类对于Tomcat内部类和Web应用程序都是可见的。但是，标准的Tomcat启动脚本（ <code>$CATALINA_HOME/bin/catalina.sh</code>要么<code>%CATALINA_HOME%\bin\catalina.bat</code> ）完全忽略了<code>CLASSPATH</code>环境变量本身，而是从以下存储库构建System类加载器：</p>
    <ul>
    <li><p><em>$ CATALINA_HOME / bin / bootstrap.jar</em> —包含用于初始化Tomcat服务器的main（）方法，以及它依赖的类加载器实现类。</p></li>
    <li><p><em>$ CATALINA_BASE / bin / tomcat-juli.jar</em>或<em>$ CATALINA_HOME / bin / tomcat-juli.jar</em> —记录实现类。这些包括增强类<code>java.util.logging</code> API，称为Tomcat JULI，是Tomcat内部使用的Apache Commons Logging库的程序包重命名副本。有关更多详细信息，请参见<a href="logging.html">日志记录文档</a> 。</p>
        <p>如果<code>tomcat-juli.jar</code>在<em>$ CATALINA_BASE / bin中存在</em> ，而不是在<em>$ CATALINA_HOME / bin中使用</em> 。在某些日志记录配置中很有用</p></li>
    <li><p><em>$ CATALINA_HOME / bin / commons-daemon.jar</em> — <a href="https://commons.apache.org/daemon/">Apache Commons Daemon</a>项目中的类。该JAR文件不存在于<code>CLASSPATH</code>由__建造<code>catalina.bat</code> | <code>.sh</code>脚本，但从<em>bootstrap.jar</em>的清单文件引用。</p></li>
    </ul>
    </li>
<li><p><strong>通用</strong> -该类加载器包含对Tomcat内部类和所有Web应用程序都可见的其他类。</p>
    <p>通常情况下，应用类<strong>不</strong>应该放在这里。此类加载器搜索的位置由<code>common.loader</code> $ CATALINA_BASE / conf / catalina.properties中的属性。默认设置将按列出的顺序搜索以下位置：</p>
    <ul>
      <li>解压后的类和资源<code>$CATALINA_BASE/lib</code></li>
      <li>JAR文件<code>$CATALINA_BASE/lib</code></li>
      <li>解压后的类和资源<code>$CATALINA_HOME/lib</code></li>
      <li>JAR文件<code>$CATALINA_HOME/lib</code></li>
    </ul>
    <p>默认情况下，这包括以下内容：</p>
    <ul>
    <li><em>注解-api.jar</em> — JavaEE注解类。</li>
    <li><em>catalina.jar</em> — Tomcat的Catalina servlet容器部分的实现。</li>
    <li><em>catalina-ant.jar</em> — Tomcat Catalina Ant任务。</li>
    <li><em>catalina-ha.jar</em> —高可用性软件包。</li>
    <li><em>catalina-storeconfig.jar</em> —从当前状态生成XML配置文件</li>
    <li><em>catalina-tribes.jar</em> —组通信程序包。</li>
    <li><em>ecj-*。jar</em> — Eclipse JDT Java编译器。</li>
    <li><em>el-api.jar</em> — EL 3.0 API。</li>
    <li><em>jasper.jar</em> — Tomcat Jasper JSP编译器和运行时。</li>
    <li><em>jasper-el.jar</em> — Tomcat Jasper EL实现。</li>
    <li><em>jsp-api.jar</em> — JSP 2.3 API。</li>
    <li><em>servlet-api.jar</em> — Servlet 4.0 API。</li>
    <li><em>tomcat-api.jar</em> — Tomcat定义的几个接口。</li>
    <li><em>tomcat-coyote.jar</em> -Tomcat连接器和实用程序类。</li>
    <li><em>tomcat-dbcp.jar</em> —基于Apache Commons Pool 2和Apache Commons DBCP 2的程序包重命名副本的数据库连接池实现。</li>
    <li><em>tomcat-i18n-**。jar</em> —包含其他语言资源包的可选JAR。由于默认捆绑包还包含在每个单独的JAR中，因此如果不需要消息的国际化，可以安全地删除它们。</li>
    <li><em>tomcat-jdbc.jar</em> —一种替代的数据库连接池实现，称为Tomcat JDBC池。有关更多详细信息，请参见<a href="jdbc-pool.html">文档</a> 。</li>
    <li><em>tomcat-util.jar</em> -Apache Tomcat的各种组件使用的通用类。</li>
    <li><em>tomcat-websocket.jar</em> — WebSocket 1.1的实现</li>
    <li><em>websocket-api.jar</em> — WebSocket 1.1 API</li>
    </ul></li>
<li><p><strong>WebappX</strong> —为部署在单个Tomcat实例中的每个Web应用程序创建一个类加载器。所有未打包的类和资源<code>/WEB-INF/classes</code> Web应用程序的目录，以及JAR文件中的类和资源<code>/WEB-INF/lib</code> Web应用程序的目录对此Web应用程序可见，但对其他Web应用程序不可见。</p></li>
</ul>

<p>如上所述，Web应用程序类加载器与默认的Java委托模型有所不同（根据Servlet规范2.4版，第9.7.2节Web应用程序类加载器中的建议）。处理从Web应用程序的<em>WebappX</em>类加载器加载类的请求时，该类加载器将<strong>首先</strong>在本地存储库中查找，而不是在查找之前委派。也有例外。属于JRE基类的类不能被覆盖。有一些例外，例如可以使用适当的JVM功能覆盖XML解析器组件，JVM功能是Java <= 8的认可标准重写功能，而Java 9+的可升级模块功能。最后，对于由Tomcat（Servlet，JSP，EL，WebSocket）实现的规范，Web应用程序类加载器将始终首先委托JavaEE API类。Tomcat中的所有其他类装入器都遵循通常的委托模式。</p>

<p>因此，从Web应用程序的角度来看，类或资源的加载按以下顺序查找以下存储库：</p>
<ul>
<li>JVM的Bootstrap类</li>
<li><em>/ WEB-INF /</em>您的网络应用程序<em>类</em></li>
<li>Web应用程序的<em>/WEB-INF/lib/*.jar</em></li>
<li>系统类加载器类（如上所述）</li>
<li>通用类加载器类（如上所述）</li>
</ul>

<p>如果Web应用程序类加载器<a href="config/loader.html">配置</a>有<code><Loader delegate="true"/></code>那么订单变成：</p>
<ul>
<li>JVM的Bootstrap类</li>
<li>系统类加载器类（如上所述）</li>
<li>通用类加载器类（如上所述）</li>
<li><em>/ WEB-INF /</em>您的网络应用程序<em>类</em></li>
<li>Web应用程序的<em>/WEB-INF/lib/*.jar</em></li>
</ul>

</div><h3 id="XML_Parsers_and_Java">XML解析器和Java</h3><div class="text">

<p>从Java 1.4开始，JRE内包装了JAXP API和XML解析器的副本。这会对希望使用自己的XML解析器的应用程序产生影响。</p>

<p>在旧版本的Tomcat中，您可以简单地替换Tomcat库目录中的XML解析器以更改所有Web应用程序使用的解析器。但是，当您运行Java的现代版本时，此技术将无效，因为通常的类加载器委托过程将始终在JDK内部选择实现，而不是选择该实现。</p>

<p>Java <= 8支持一种称为“认可标准覆盖机制”的机制，以允许替换在JCP外部创建的API（即，来自W3C的DOM和SAX）。它还可以用于更新XML解析器实现。有关更多信息，请参见： <a href="http://docs.oracle.com/javase/1.5.0/docs/guide/standards/index.html">http</a> : <a href="http://docs.oracle.com/javase/1.5.0/docs/guide/standards/index.html">//docs.oracle.com/javase/1.5.0/docs/guide/standards/index.html</a> 。对于Java 9+，请使用可升级模块功能。</p>

<p>Tomcat通过包括系统属性设置来利用认可的机制<code>-Djava.endorsed.dirs=$JAVA_ENDORSED_DIRS</code>在启动容器的命令行中。此选项的默认值为<em>$ CATALINA_HOME / endorsed</em> 。默认情况下，不创建该<em>认可</em>目录。请注意，Java 9不再支持已认可的功能，并且仅当目录<em>$ CATALINA_HOME / endorsed</em>存在或变量存在时，才设置上述系统属性<code>JAVA_ENDORSED_DIRS</code>已经设置好了。
</p>

<p>请注意，覆盖任何JRE组件都会带来风险。如果覆盖的组件未提供100％兼容的API（例如Xerces提供的API与JRE提供的XML API并非100％兼容），则存在Tomcat和/或已部署的应用程序遇到错误的风险。</p>

</div><h3 id="Running_under_a_security_manager">在安全管理器下运行</h3><div class="text">

<p>在安全管理器下运行时，允许加载类的位置也将取决于策略文件的内容。有关更多信息，请参见<a href="security-manager-howto.html">Security Manager How-To</a> 。</p>

</div><h3 id="Advanced_configuration">进阶设定</h3><div class="text">

<p>也可以配置更复杂的类加载器层次结构。请参见下图。默认情况下，未定义<strong>服务器</strong>和<strong>共享</strong>类加载器，并使用上面显示的简化层次结构。可以通过为以下对象定义值来使用更复杂的层次结构<code>server.loader</code>和/或<code>shared.loader</code>物业<code>conf/catalina.properties</code> 。</p>

<div class="codeBox"><pre><code>
  Bootstrap
      |
    System
      |
    Common
     /  \
Server  Shared
         /  \
   Webapp1  Webapp2 ...</code></pre></div>

<p><strong>服务器</strong>类加载器仅对Tomcat内部可见，而对Web应用程序则完全不可见。</p>

<p><strong>共享</strong>类加载器对于所有Web应用程序都是可见的，并且可以用于在所有Web应用程序之间共享代码。但是，对此共享代码的任何更新将需要重新启动Tomcat。</p>

</div><div class="noprint"><h3 id="comments_section">评论</h3><div class="text"><p class="notice"><strong>注意：</strong>此注释部分收集有关改进Apache Tomcat文档的建议。<br><br>如果您遇到问题并需要帮助，请阅读“ <a href="https://tomcat.apache.org/findhelp.html">查找帮助”</a>页面，然后在tomcat-users <a href="https://tomcat.apache.org/lists.html">邮件列表中</a>询问您的问题。不要在这里问这样的问题。这不是“问答”部分。<br><br><a href="./comments.html">这里</a>解释<a href="./comments.html">了</a> Apache Comments System。如果评论已被实施或被认为无效/偏离主题，则我们的主持人可能会将其删除。
                  </p><div id="comments_thread"></div></div></div></div></div></div></div><footer><div id="footer">版权所有©1999-2019，Apache软件基金会</div></footer></div></body></html>