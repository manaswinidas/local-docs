<html lang="zh-Hans" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><link href="./images/docs-stylesheet.css" rel="stylesheet" type="text/css"><title>Apache Tomcat 9（9.0.21）-Windows身份验证方法</title><script type="application/javascript" data-comments-identifier="tomcat-9.0-doc/windows-auth-howto">
    "use strict"; // Enable strict mode

    (function() {
      var thisScript = document.currentScript;
      if (!thisScript) { // Workaround for IE <= 11
        var scripts = document.getElementsByTagName("script");
        thisScript = scripts[scripts.length - 1];
      }
      document.addEventListener("DOMContentLoaded", (function() {
        var commentsDiv = document.getElementById("comments_thread");
        var commentsShortname = "tomcat";
        var commentsIdentifier = "https://tomcat.apache.org/" +
          thisScript.getAttribute("data-comments-identifier") + ".html";

        (function(w, d) {
          if (w.location.hostname.toLowerCase() == "tomcat.apache.org") {
            var s = d.createElement("script");
            s.type = "application/javascript";
            s.async = true;
            s.src = "https://comments.apache.org/show_comments.lua?site=" +
              encodeURIComponent(commentsShortname) +
              "&page=" + encodeURIComponent(commentsIdentifier);
            d.head.appendChild(s);
          } else {
            commentsDiv.appendChild(d.createTextNode("Comments are disabled for this page at the moment."));
          }
        })(window, document);
      }), false);
    })();
  </script></head><body ><div id="wrapper"><header><div id="header"><div><div><div class="logo noPrint"><a href="https://tomcat.apache.org/"><img alt="Tomcat主页" src="./images/tomcat.png"></a></div><div style="height:1px"></div><div class="asfLogo noPrint"><a href="https://www.apache.org/" target="_blank"><img src="./images/asf-logo.svg" alt="Apache软件基金会" style="width:266px;height:83px"></a></div><h1>Apache Tomcat 9</h1><div class="versionInfo">版本9.0.21， <time datetime="2019-06-04"> 2019年6月4日</time></div><div style="height:1px"></div><div style="clear:left"></div></div></div></div></header><div id="middle"><div><div id="mainLeft" class="noprint"><div><nav><div><h2>链接</h2><ul><li><a href="index.html">文件首页</a></li><li><a href="https://wiki.apache.org/tomcat/FAQ">常问问题</a></li><li><a href="#comments_section">用户评论</a></li></ul></div><div><h2>用户指南</h2><ul><li><a href="introduction.html">1）简介</a></li><li><a href="setup.html">2）设定</a></li><li><a href="appdev/index.html">3）第一个webapp</a></li><li><a href="deployer-howto.html">4）部署者</a></li><li><a href="manager-howto.html">5）经理</a></li><li><a href="host-manager-howto.html">6）主机管理员</a></li><li><a href="realm-howto.html">7）领域和AAA</a></li><li><a href="security-manager-howto.html">8）安全经理</a></li><li><a href="jndi-resources-howto.html">9）JNDI资源</a></li><li><a href="jndi-datasource-examples-howto.html">10）JDBC数据源</a></li><li><a href="class-loader-howto.html">11）类加载</a></li><li><a href="jasper-howto.html">12）JSP</a></li><li><a href="ssl-howto.html">13）SSL / TLS</a></li><li><a href="ssi-howto.html">14）SSI</a></li><li><a href="cgi-howto.html">15）CGI</a></li><li><a href="proxy-howto.html">16）代理支持</a></li><li><a href="mbeans-descriptors-howto.html">17）MBean描述符</a></li><li><a href="default-servlet.html">18）默认Servlet</a></li><li><a href="cluster-howto.html">19）聚类</a></li><li><a href="balancer-howto.html">20）负载均衡器</a></li><li><a href="connectors.html">21）连接器</a></li><li><a href="monitoring.html">22）监控与管理</a></li><li><a href="logging.html">23）记录</a></li><li><a href="apr.html">24）APR /本地</a></li><li><a href="virtual-hosting-howto.html">25）虚拟主机</a></li><li><a href="aio.html">26）高级IO</a></li><li><a href="extras.html">27）附加组件</a></li><li><a href="maven-jars.html">28）行刑</a></li><li><a href="security-howto.html">29）安全注意事项</a></li><li><a href="windows-service-howto.html">30）Windows服务</a></li><li><a href="windows-auth-howto.html">31）Windows身份验证</a></li><li><a href="jdbc-pool.html">32）Tomcat的JDBC池</a></li><li><a href="web-socket-howto.html">33）WebSocket</a></li><li><a href="rewrite.html">34）改写</a></li></ul></div><div><h2>参考</h2><ul><li><a href="RELEASE-NOTES.txt">发行说明</a></li><li><a href="config/index.html">组态</a></li><li><a href="api/index.html">Tomcat Java文档</a></li><li><a href="servletapi/index.html">Servlet Java文档</a></li><li><a href="jspapi/index.html">JSP 2.3 Java文档</a></li><li><a href="elapi/index.html">EL 3.0 Java文档</a></li><li><a href="websocketapi/index.html">WebSocket 1.1 Java文档</a></li><li><a href="https://tomcat.apache.org/connectors-doc/">JK 1.2文档</a></li></ul></div><div><h2>Apache Tomcat开发</h2><ul><li><a href="building.html">建造</a></li><li><a href="changelog.html">变更日志</a></li><li><a href="https://wiki.apache.org/tomcat/TomcatVersions">状态</a></li><li><a href="developers.html">开发者</a></li><li><a href="architecture/index.html">建筑</a></li><li><a href="funcspecs/index.html">功能规格。</a></li><li><a href="tribes/introduction.html">部族</a></li></ul></div></nav></div></div><div id="mainRight"><div id="content"><h2>Windows身份验证方法</h2><h3 id="Table_of_Contents">目录</h3><div class="text">
<ul><li><a href="#Overview">总览</a></li><li><a href="#Built-in_Tomcat_support">内置Tomcat支持</a><ol><li><a href="#Domain_Controller">域控制器</a></li><li><a href="#Tomcat_instance_(Windows_server)">Tomcat实例（Windows服务器）</a></li><li><a href="#Tomcat_instance_(Linux_server)">Tomcat实例（Linux服务器）</a></li><li><a href="#Web_application">Web应用程序</a></li><li><a href="#Client">客户</a></li><li><a href="#References">参考文献</a></li></ol></li><li><a href="#Third_party_libraries">第三方图书馆</a><ol><li><a href="#Waffle">胡扯</a></li><li><a href="#Spring_Security_-_Kerberos_Extension">Spring Security-Kerberos扩展</a></li><li><a href="#SPNEGO_project_at_SourceForge">SourceForge的SPNEGO项目</a></li><li><a href="#Jespa">杰斯帕</a></li></ol></li><li><a href="#Reverse_proxies">反向代理</a><ol><li><a href="#Microsoft_IIS">Microsoft IIS</a></li><li><a href="#Apache_httpd">阿帕奇httpd</a></li></ol></li></ul>
</div><h3 id="Overview">总览</h3><div class="text">
<p>集成Windows身份验证在Intranet环境中最常用，因为它要求执行身份验证的服务器和被身份验证的用户属于同一域。为了自动验证用户，用户使用的客户端计算机也必须是域的一部分。</p>
<p>使用Apache Tomcat实现集成Windows身份验证有多种选择。他们是：</p>
<ul>
<li>内置的Tomcat支持。</li>
<li>使用第三方库，例如Waffle。</li>
<li>使用支持Windows身份验证的反向代理来执行身份验证步骤，例如IIS或httpd。</li>
</ul>
<p>以下各节将讨论每个选项的配置。</p>
</div><h3 id="Built-in_Tomcat_support">内置Tomcat支持</h3><div class="text">
<p>Kerberos（集成Windows身份验证的基础）需要仔细配置。如果严格按照本指南中的步骤进行操作，则将产生有效的配置。务必严格遵循以下步骤。配置的灵活性范围很小。从测试至今，已知：</p>
<ul>
<li>用于访问Tomcat服务器的主机名必须与SPN中的主机名完全匹配，否则身份验证将失败。在这种情况下，调试日志中可能会报告校验和错误。</li>
<li>客户端必须认为服务器是本地受信任Intranet的一部分。</li>
<li>SPN必须为HTTP /， <hostname>并且在所有使用位置均必须完全相同。</hostname></li>
<li>该端口号不得包含在SPN中。</li>
<li>最多只能将一个SPN映射到一个域用户。</li>
<li>Tomcat必须以与SPN关联的域帐户或域管理员身份运行。<strong>不</strong>建议在域管理员用户下运行Tomcat。</li>
<li>域名（ <code>DEV.LOCAL</code> ）在ktpass命令中使用或在jaas.conf中使用时都不区分大小写</li>
<li>使用ktpass命令时必须指定域</li>
</ul>
<p>内置Tomcat支持Windows身份验证的配置包含四个组件。域控制器，托管Tomcat的服务器，希望使用Windows身份验证的Web应用程序和客户端计算机。以下各节描述了每个组件所需的配置。</p>
<p>在下面的配置示例中使用的三台计算机的名称是win-dc01.dev.local（域控制器），win-tc01.dev.local（Tomcat实例）和win-pc01.dev.local（客户端）。全部都是DEV.LOCAL域的成员。</p>
<p>注意：为了在以下步骤中使用密码，必须放松域密码策略。不建议在生产环境中使用。
</p>

  <div class="subsection"><h4 id="Domain_Controller">域控制器</h4><div class="text">
  <p>这些步骤假定服务器已被配置为充当域控制器。将Windows服务器配置为域控制器不在本操作方法的范围内。配置域控制器以使Tomcat支持Windows身份验证的步骤如下：</p>
  <ul>
  <li>创建一个将映射到Tomcat服务器使用的服务名称的域用户。在此方法中，此用户称为<code>tc01</code>且密码为<code>tc01pass</code> 。</li>
  <li>将服务主体名称（SPN）映射到用户帐户。SPN采用以下形式<code><service class>/<host>:<port>/<service name></code> 。本方法中使用的SPN是<code>HTTP/win-tc01.dev.local</code> 。要将用户映射到SPN，请运行以下命令：<div class="codeBox"><pre><code>setspn -A HTTP/win-tc01.dev.local tc01</code></pre></div>
  </li>
  <li>生成密钥表文件，Tomcat服务器将使用该密钥表文件对域控制器进行身份验证。该文件包含服务提供商帐户的Tomcat私钥，应相应地加以保护。要生成文件，请运行以下命令（全部在一行上）：<div class="codeBox"><pre><code>ktpass /out c:\tomcat.keytab /mapuser tc01@DEV.LOCAL
          /princ HTTP/win-tc01.dev.local@DEV.LOCAL
          /pass tc01pass /kvno 0</code></pre></div></li>
  <li>创建要在客户端上使用的域用户。在此方法中，域用户是<code>test</code>密码为<code>testpass</code> 。</li>
  </ul>
  <p>在运行Windows Server 2008 R2 64位标准的域控制器上，对林和域使用Windows Server 2003功能级别，已经对上述步骤进行了测试。
  </p>
  </div></div>

  <div class="subsection"><h4 id="Tomcat_instance_(Windows_server)">Tomcat实例（Windows服务器）</h4><div class="text">
  <p>这些步骤假定已经安装并配置了Tomcat和Java 6 JDK / JRE，并且Tomcat以tc01@DEV.LOCAL用户身份运行。为Windows身份验证配置Tomcat实例的步骤如下：</p>
  <ul>
  <li>复制<code>tomcat.keytab</code>在域控制器上创建的文件<code>$CATALINA_BASE/conf/tomcat.keytab</code> 。</li>
  <li>创建kerberos配置文件<code>$CATALINA_BASE/conf/krb5.ini</code> 。该使用方法中使用的文件包含：<div class="codeBox"><pre><code>[libdefaults]
default_realm = DEV.LOCAL
default_keytab_name = FILE:c:\apache-tomcat-9.0.x\conf\tomcat.keytab
default_tkt_enctypes = rc4-hmac,aes256-cts-hmac-sha1-96,aes128-cts-hmac-sha1-96
default_tgs_enctypes = rc4-hmac,aes256-cts-hmac-sha1-96,aes128-cts-hmac-sha1-96
forwardable=true

[realms]
DEV.LOCAL = {
        kdc = win-dc01.dev.local:88
}

[domain_realm]
dev.local= DEV.LOCAL
.dev.local= DEV.LOCAL</code></pre></div>可以通过设置该文件的位置来更改此文件的位置。 <code>java.security.krb5.conf</code>系统属性。</li>
  <li>创建JAAS登录配置文件<code>$CATALINA_BASE/conf/jaas.conf</code> 。该使用方法中使用的文件包含：<div class="codeBox"><pre><code>com.sun.security.jgss.krb5.initiate {
    com.sun.security.auth.module.Krb5LoginModule required
    doNotPrompt=true
    principal="HTTP/win-tc01.dev.local@DEV.LOCAL"
    useKeyTab=true
    keyTab="c:/apache-tomcat-9.0.x/conf/tomcat.keytab"
    storeKey=true;
};

com.sun.security.jgss.krb5.accept {
    com.sun.security.auth.module.Krb5LoginModule required
    doNotPrompt=true
    principal="HTTP/win-tc01.dev.local@DEV.LOCAL"
    useKeyTab=true
    keyTab="c:/apache-tomcat-9.0.x/conf/tomcat.keytab"
    storeKey=true;
};</code></pre></div>可以通过设置该文件的位置来更改此文件的位置。 <code>java.security.auth.login.config</code>系统属性。使用的LoginModule是特定于JVM的，因此请确保指定的LoginModule与使用的JVM匹配。登录配置的名称必须与<a href="config/valve.html#SPNEGO_Valve">认证阀</a>使用的值匹配。</li>
  </ul>
  <p>SPNEGO身份验证器可以与任何<a href="config/realm.html">领域一起</a>使用，但是如果与JNDI领域一起使用，则默认情况下，JNDI领域将使用用户的委派凭据连接到Active Directory。如果仅需要经过身份验证的用户名，则可以使用AuthenticatedUserRealm，该方法将仅基于不具有任何角色的经过身份验证的用户名返回一个Principal。</p>
  <p>以上步骤已在运行Windows Server 2008 R2 64位标准版和Oracle 1.6.0_24 64位JDK的Tomcat服务器上进行了测试。</p>
  </div></div>

  <div class="subsection"><h4 id="Tomcat_instance_(Linux_server)">Tomcat实例（Linux服务器）</h4><div class="text">
  <p>经过测试：</p>
  <ul>
  <li>Java 1.7.0，更新45，64位</li>
  <li>Ubuntu Server 12.04.3 LTS 64位</li>
  <li>Tomcat 8.0.x（R1546570）</li>
  </ul>
  <p>尽管建议使用最新的稳定版本，但它应可与任何Tomcat 8发行版一起使用。</p>
  <p>该配置与Windows相同，但有以下更改：</p>
  <ul>
  <li>Linux服务器不必是Windows域的一部分。</li>
  <li>应该使用Linux样式文件路径（例如/ usr / local / tomcat / ...）更新krb5.ini和jaas.conf中的keytab文件的路径，以反映Linux服务器上的keytab文件的路径。</li>
  </ul>
  </div></div>

  <div class="subsection"><h4 id="Web_application">Web应用程序</h4><div class="text">
  <p>需要将Web应用程序配置为使用Tomcat特定的身份验证方法<code>SPNEGO</code> （而不是BASIC等）在web.xml中。与其他身份验证器一样，可以通过显式配置<a href="config/valve.html#SPNEGO_Valve">身份验证阀门</a>并在Valve上设置属性来自定义行为。</p>
  </div></div>

  <div class="subsection"><h4 id="Client">客户</h4><div class="text">
  <p>客户端必须配置为使用Kerberos身份验证。对于Internet Explorer，这意味着确保Tomcat实例位于“本地Intranet”安全域中，并且已将其配置为（工具> Internet选项>高级），并且已启用集成Windows身份验证。请注意，如果您使用同一台计算机作为客户端和Tomcat实例，则这<strong>将</strong>不起作用，因为Internet Explorer将使用不受支持的NTLM协议。</p>
  </div></div>

  <div class="subsection"><h4 id="References">参考文献</h4><div class="text">
  <p>正确配置Kerberos身份验证可能很棘手。以下参考资料可能会有所帮助。<a href="https://tomcat.apache.org/lists.html#tomcat-users">Tomcat用户邮件列表中</a>也始终可以提供建议。</p>
  <ol>
  <li><a href="http://www.adopenstatic.com/cs/blogs/ken/archive/2006/10/19/512.aspx">IIS和Kerberos</a></li>
  <li><a href="http://spnego.sourceforge.net/index.html">SourceForge的SPNEGO项目</a></li>
  <li><a href="http://docs.oracle.com/javase/7/docs/technotes/guides/security/jgss/tutorials/index.html">Oracle Java GSS-API教程（Java 7）</a></li>
  <li><a href="http://docs.oracle.com/javase/7/docs/technotes/guides/security/jgss/tutorials/Troubleshooting.html">Oracle Java GSS-API教程-故障排除（Java 7）</a></li>
  <li><a href="https://cwiki.apache.org/confluence/display/GMOxDOC21/Using+SPNEGO+in+Geronimo#UsingSPNEGOinGeronimo-SettinguptheDomainControllerMachine">用于Windows身份验证的Geronimo配置</a></li>
  <li><a href="http://blogs.msdn.com/b/openspecification/archive/2010/11/17/encryption-type-selection-in-kerberos-exchanges.aspx">Kerberos交换中的加密选择</a></li>
  <li><a href="http://support.microsoft.com/kb/977321">支持的Kerberos密码套件</a></li>
  </ol>
  </div></div>

</div><h3 id="Third_party_libraries">第三方图书馆</h3><div class="text">

  <div class="subsection"><h4 id="Waffle">胡扯</h4><div class="text">
  <p>可以通过<a href="http://waffle.codeplex.com/" rel="nofollow">Waffle网站</a>找到此解决方案的完整详细信息。主要功能是：</p>
  <ul>
  <li>嵌入式解决方案</li>
  <li>简单配置（无需JAAS或Kerberos keytab配置）</li>
  <li>使用本地库</li>
  </ul>
  </div></div>

  <div class="subsection"><h4 id="Spring_Security_-_Kerberos_Extension">Spring Security-Kerberos扩展</h4><div class="text">
  <p>可通过<a href="http://static.springsource.org/spring-security/site/extensions/krb/index.html" rel="nofollow">Kerberos扩展网站</a>找到此解决方案的完整详细信息。主要功能是：</p>
  <ul>
  <li>扩展到Spring Security</li>
  <li>需要生成一个Kerberos keytab文件</li>
  <li>纯Java解决方案</li>
  </ul>
  </div></div>

  <div class="subsection"><h4 id="SPNEGO_project_at_SourceForge">SourceForge的SPNEGO项目</h4><div class="text">
  <p>该解决方案的完整详细信息可以在<a href="http://spnego.sourceforge.net/index.html/" rel="nofollow">项目站点中</a>找到。主要功能是：</p>
  <ul>
  <li>使用Kerberos</li>
  <li>纯Java解决方案</li>
  </ul>
  </div></div>

  <div class="subsection"><h4 id="Jespa">杰斯帕</h4><div class="text">
  <p>可通过<a href="http://www.ioplex.com/" rel="nofollow">项目网站</a>找到此解决方案的完整详细信息<a href="http://www.ioplex.com/" rel="nofollow">。</a> 主要功能是：</p>
  <ul>
  <li>纯Java解决方案</li>
  <li>先进的Active Directory集成</li>
  </ul>
  </div></div>
</div><h3 id="Reverse_proxies">反向代理</h3><div class="text">

  <div class="subsection"><h4 id="Microsoft_IIS">Microsoft IIS</h4><div class="text">
  <p>配置IIS以提供Windows身份验证需要执行三个步骤。他们是：</p>
  <ol>
  <li>将IIS配置为Tomcat的反向代理（请参阅<a href="https://tomcat.apache.org/connectors-doc/webserver_howto/iis.html">IIS Web服务器方法）</a> 。</li>
  <li>配置IIS以使用Windows身份验证</li>
  <li>通过将<a href="config/ajp.html">AJP连接器</a>上的tomcatAuthentication属性设置为，将Tomcat配置为使用来自IIS的身份验证用户信息。 <code>false</code> 。或者，将tomcatAuthorization属性设置为<code>true</code>允许IIS进行身份验证，而Tomcat执行授权。</li>
  </ol>
  </div></div>

  <div class="subsection"><h4 id="Apache_httpd">阿帕奇httpd</h4><div class="text">
  <p>Apache httpd开箱即用不支持Windows身份验证，但是可以使用许多第三方模块。这些包括：</p>
  <ol>
  <li>在Windows平台上使用的<a href="http://sourceforge.net/projects/mod-auth-sspi/" rel="nofollow">mod_auth_sspi</a> 。</li>
  <li>对于非Windows平台，请使用<a href="http://adldap.sourceforge.net/wiki/doku.php?id=mod_auth_ntlm_winbind" rel="nofollow">mod_auth_ntlm_winbind</a> 。已知可在32位平台上使用httpd2.0.x。一些用户报告了httpd 2.2.x版本和64位Linux版本的稳定性问题。</li>
  </ol>
  <p>要配置httpd以提供Windows身份验证，需要执行三个步骤。他们是：</p>
  <ol>
  <li>将httpd配置为Tomcat的反向代理（请参阅<a href="https://tomcat.apache.org/connectors-doc/webserver_howto/apache.html">Apache httpd Web服务器方法）</a> 。</li>
  <li>将httpd配置为使用Windows身份验证</li>
  <li>通过将<a href="config/ajp.html">AJP连接器</a>上的tomcatAuthentication属性设置为，将Tomcat配置为使用来自httpd的身份验证用户信息。 <code>false</code> 。</li>
  </ol>
  </div></div>

</div><div class="noprint"><h3 id="comments_section">评论</h3><div class="text"><p class="notice"><strong>注意：</strong>此注释部分收集有关改进Apache Tomcat文档的建议。<br><br>如果您遇到问题并需要帮助，请阅读“ <a href="https://tomcat.apache.org/findhelp.html">查找帮助”</a>页面，然后在tomcat-users <a href="https://tomcat.apache.org/lists.html">邮件列表中</a>询问您的问题。不要在这里问这样的问题。这不是“问答”部分。<br><br><a href="./comments.html">这里</a>解释<a href="./comments.html">了</a> Apache Comments System。如果评论已被实施或被认为无效/偏离主题，则我们的主持人可能会将其删除。
                  </p><div id="comments_thread"></div></div></div></div></div></div></div><footer><div id="footer">版权所有©1999-2019，Apache软件基金会</div></footer></div></body></html>