<html lang="zh-Hans" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><link href="./images/docs-stylesheet.css" rel="stylesheet" type="text/css"><title>Apache Tomcat 9（9.0.21）-SSL / TLS配置方法</title><meta name="author" content="Christopher Cain"><meta name="author" content="Yoav Shapira"><script type="application/javascript" data-comments-identifier="tomcat-9.0-doc/ssl-howto">
    "use strict"; // Enable strict mode

    (function() {
      var thisScript = document.currentScript;
      if (!thisScript) { // Workaround for IE <= 11
        var scripts = document.getElementsByTagName("script");
        thisScript = scripts[scripts.length - 1];
      }
      document.addEventListener("DOMContentLoaded", (function() {
        var commentsDiv = document.getElementById("comments_thread");
        var commentsShortname = "tomcat";
        var commentsIdentifier = "https://tomcat.apache.org/" +
          thisScript.getAttribute("data-comments-identifier") + ".html";

        (function(w, d) {
          if (w.location.hostname.toLowerCase() == "tomcat.apache.org") {
            var s = d.createElement("script");
            s.type = "application/javascript";
            s.async = true;
            s.src = "https://comments.apache.org/show_comments.lua?site=" +
              encodeURIComponent(commentsShortname) +
              "&page=" + encodeURIComponent(commentsIdentifier);
            d.head.appendChild(s);
          } else {
            commentsDiv.appendChild(d.createTextNode("Comments are disabled for this page at the moment."));
          }
        })(window, document);
      }), false);
    })();
  </script></head><body ><div id="wrapper"><header><div id="header"><div><div><div class="logo noPrint"><a href="https://tomcat.apache.org/"><img alt="Tomcat主页" src="./images/tomcat.png"></a></div><div style="height:1px"></div><div class="asfLogo noPrint"><a href="https://www.apache.org/" target="_blank"><img src="./images/asf-logo.svg" alt="Apache软件基金会" style="width:266px;height:83px"></a></div><h1>Apache Tomcat 9</h1><div class="versionInfo">版本9.0.21， <time datetime="2019-06-04"> 2019年6月4日</time></div><div style="height:1px"></div><div style="clear:left"></div></div></div></div></header><div id="middle"><div><div id="mainLeft" class="noprint"><div><nav><div><h2>链接</h2><ul><li><a href="index.html">文件首页</a></li><li><a href="https://wiki.apache.org/tomcat/FAQ">常问问题</a></li><li><a href="#comments_section">用户评论</a></li></ul></div><div><h2>用户指南</h2><ul><li><a href="introduction.html">1）简介</a></li><li><a href="setup.html">2）设定</a></li><li><a href="appdev/index.html">3）第一个webapp</a></li><li><a href="deployer-howto.html">4）部署者</a></li><li><a href="manager-howto.html">5）经理</a></li><li><a href="host-manager-howto.html">6）主机管理员</a></li><li><a href="realm-howto.html">7）领域和AAA</a></li><li><a href="security-manager-howto.html">8）安全经理</a></li><li><a href="jndi-resources-howto.html">9）JNDI资源</a></li><li><a href="jndi-datasource-examples-howto.html">10）JDBC数据源</a></li><li><a href="class-loader-howto.html">11）类加载</a></li><li><a href="jasper-howto.html">12）JSP</a></li><li><a href="ssl-howto.html">13）SSL / TLS</a></li><li><a href="ssi-howto.html">14）SSI</a></li><li><a href="cgi-howto.html">15）CGI</a></li><li><a href="proxy-howto.html">16）代理支持</a></li><li><a href="mbeans-descriptors-howto.html">17）MBean描述符</a></li><li><a href="default-servlet.html">18）默认Servlet</a></li><li><a href="cluster-howto.html">19）聚类</a></li><li><a href="balancer-howto.html">20）负载均衡器</a></li><li><a href="connectors.html">21）连接器</a></li><li><a href="monitoring.html">22）监控与管理</a></li><li><a href="logging.html">23）记录</a></li><li><a href="apr.html">24）APR /本地</a></li><li><a href="virtual-hosting-howto.html">25）虚拟主机</a></li><li><a href="aio.html">26）高级IO</a></li><li><a href="extras.html">27）附加组件</a></li><li><a href="maven-jars.html">28）行刑</a></li><li><a href="security-howto.html">29）安全注意事项</a></li><li><a href="windows-service-howto.html">30）Windows服务</a></li><li><a href="windows-auth-howto.html">31）Windows身份验证</a></li><li><a href="jdbc-pool.html">32）Tomcat的JDBC池</a></li><li><a href="web-socket-howto.html">33）WebSocket</a></li><li><a href="rewrite.html">34）改写</a></li></ul></div><div><h2>参考</h2><ul><li><a href="RELEASE-NOTES.txt">发行说明</a></li><li><a href="config/index.html">组态</a></li><li><a href="api/index.html">Tomcat Java文档</a></li><li><a href="servletapi/index.html">Servlet Java文档</a></li><li><a href="jspapi/index.html">JSP 2.3 Java文档</a></li><li><a href="elapi/index.html">EL 3.0 Java文档</a></li><li><a href="websocketapi/index.html">WebSocket 1.1 Java文档</a></li><li><a href="https://tomcat.apache.org/connectors-doc/">JK 1.2文档</a></li></ul></div><div><h2>Apache Tomcat开发</h2><ul><li><a href="building.html">建造</a></li><li><a href="changelog.html">变更日志</a></li><li><a href="https://wiki.apache.org/tomcat/TomcatVersions">状态</a></li><li><a href="developers.html">开发者</a></li><li><a href="architecture/index.html">建筑</a></li><li><a href="funcspecs/index.html">功能规格。</a></li><li><a href="tribes/introduction.html">部族</a></li></ul></div></nav></div></div><div id="mainRight"><div id="content"><h2>SSL / TLS配置方法</h2><h3 id="Table_of_Contents">目录</h3><div class="text">
<ul><li><a href="#Quick_Start">快速开始</a></li><li><a href="#Introduction_to_SSL">SSL / TLS简介</a></li><li><a href="#SSL_and_Tomcat">SSL / TLS和Tomcat</a></li><li><a href="#Certificates">证明书</a></li><li><a href="#General_Tips_on_Running_SSL">运行SSL的一般提示</a></li><li><a href="#Configuration">组态</a><ol><li><a href="#Prepare_the_Certificate_Keystore">准备证书密钥库</a></li><li><a href="#Edit_the_Tomcat_Configuration_File">编辑Tomcat配置文件</a></li></ol></li><li><a href="#Installing_a_Certificate_from_a_Certificate_Authority">从证书颁发机构安装证书</a><ol><li><a href="#Create_a_local_Certificate_Signing_Request_(CSR)">创建本地证书签名请求（CSR）</a></li><li><a href="#Importing_the_Certificate">导入证书</a></li></ol></li><li><a href="#Using_OCSP_Certificates">使用OCSP证书</a><ol><li><a href="#Generating_OCSP-Enabled_Certificates">生成启用OCSP的证书</a></li><li><a href="#Configuring_OCSP_Connector">配置OCSP连接器</a></li><li><a href="#Starting_OCSP_Responder">启动OCSP响应程序</a></li></ol></li><li><a href="#Troubleshooting">故障排除</a></li><li><a href="#Using_the_SSL_for_session_tracking_in_your_application">在应用程序中使用SSL进行会话跟踪</a></li><li><a href="#Miscellaneous_Tips_and_Bits">杂项技巧</a></li></ul>
</div><h3 id="Quick_Start">快速开始</h3><div class="text">

    <p><em>下面的描述使用变量名$ CATALINA_BASE来引用可解决大多数相对路径的基本目录。如果尚未通过设置CATALINA_BASE目录为多个实例配置Tomcat，则$ CATALINA_BASE将设置为$ CATALINA_HOME的值，该目录已将Tomcat安装到该目录中。</em></p>

<p>要在Tomcat上安装和配置SSL / TLS支持，您需要遵循以下简单步骤。有关更多信息，请阅读本方法的其余部分。</p>
<ol>
<li><p>通过执行以下命令，创建密钥库文件来存储服务器的私钥和自签名证书：</p>
<p>视窗：</p>
<div class="codeBox"><pre><code>"%JAVA_HOME%\bin\keytool" -genkey -alias tomcat -keyalg RSA</code></pre></div>
<p>Unix：</p>
<div class="codeBox"><pre><code>$JAVA_HOME/bin/keytool -genkey -alias tomcat -keyalg RSA</code></pre></div>

<p>并将密码值指定为“ changeit”。</p></li>
<li><p>取消注释“ SSL HTTP / 1.1 Connector”条目<code>$CATALINA_BASE/conf/server.xml</code>并按照以下“ <a href="#Configuration">配置”部分</a>中的说明进行修改。</p></li>

</ol>


</div><h3 id="Introduction_to_SSL">SSL / TLS简介</h3><div class="text">

<p>传输层安全性（TLS）及其前身安全套接字层（SSL）是允许Web浏览器和Web服务器通过安全连接进行通信的技术。这意味着要发送的数据在处理之前先由一方加密，传输，然后由另一方解密。这是一个双向过程，这意味着服务器和浏览器都在发送数据之前对所有流量进行加密。</p>

<p>SSL / TLS协议的另一个重要方面是身份验证。这意味着，在您初次尝试通过安全连接与Web服务器通信时，该服务器将以“证书”的形式向您的Web浏览器提供一组凭据，以证明该网站是谁及其声称的身份成为。在某些情况下，服务器还可能会从您的Web浏览器中请求证书，以要求提供<em>您</em>所声称的身份的证明。这被称为“客户端身份验证”，尽管实际上，与个人用户相比，这种方式更多地用于企业对企业（B2B）交易。大多数启用了SSL的Web服务器都不请求客户端身份验证。</p>

</div><h3 id="SSL_and_Tomcat">SSL / TLS和Tomcat</h3><div class="text">

<p>重要的是要注意，通常只有将Tomcat作为独立的Web服务器运行时，才需要配置Tomcat以利用安全套接字。可以在“ <a href="security-howto.html">安全注意事项”文档中</a>找到详细信息。当主要将Tomcat作为Servlet / JSP容器运行在另一个Web服务器（例如Apache或Microsoft IIS）之后时，通常需要配置主Web服务器以处理来自用户的SSL连接。通常，此服务器将协商所有与SSL相关的功能，然后仅在解密那些请求之后才传递发往Tomcat容器的所有请求。同样，Tomcat将返回明文响应，该响应将在返回用户浏览器之前进行加密。在这种环境下，Tomcat知道主Web服务器和客户端之间的通信是通过安全连接进行的（因为您的应用程序需要能够对此进行询问），但是它本身并不参与加密或解密。</p>

</div><h3 id="Certificates">证明书</h3><div class="text">

<p>为了实现SSL，Web服务器必须为每个接受安全连接的外部接口（IP地址）具有关联的证书。这种设计背后的理论是，服务器应提供某种合理的保证，确保您的所有者是您认为的所有者，尤其是在接收任何敏感信息之前。虽然对证书的更广泛的解释超出了本文档的范围，但是可以将证书视为Internet地址的“数字护照”。它说明了站点与哪个组织相关联，以及有关站点所有者或管理员的一些基本联系信息。</p>

<p>该证书由其所有者加密签名，因此其他任何人都很难伪造。为了使证书能在访问者浏览器中正常运行而不会发出警告，它需要由受信任的第三方签名。这些称为<em>证书颁发机构</em> （CA）。要获得签名证书，您需要选择一个CA并按照您选择的CA提供的说明来获取证书。有一系列的CA，包括一些免费提供证书的CA。</p>

<p>Java提供了一个相对简单的命令行工具，称为<code>keytool</code> ，可以轻松创建“自签名”证书。自签名证书只是用户生成的证书，尚未由著名的CA进行签名，因此根本无法保证它们是真实的。尽管自签名证书对于某些测试方案很有用，但它们不适合任何形式的生产使用。</p>

</div><h3 id="General_Tips_on_Running_SSL">运行SSL的一般提示</h3><div class="text">

<p>使用SSL保护网站时，务必确保通过SSL提供该网站使用的所有资产，以使攻击者无法通过将恶意内容注入javascript文件或类似内容来绕过安全性。为了进一步增强网站的安全性，您应该评估使用HSTS标头。它允许您向浏览器传达始终应通过https访问您的站点的信息。</p>

<p>在安全连接上使用基于名称的虚拟主机，需要仔细配置在单个证书或提供服务器名称指示（SNI）支持的Tomcat 8.5及更高版本中指定的名称。SNI允许将具有不同名称的多个证书与单个TLS连接器关联。</p>

</div><h3 id="Configuration">组态</h3><div class="text">

<div class="subsection"><h4 id="Prepare_the_Certificate_Keystore">准备证书密钥库</h4><div class="text">

<p>Tomcat当前仅在<code>JKS</code> ， <code>PKCS11</code>要么<code>PKCS12</code>格式化密钥库。的<code>JKS</code>格式是Java的标准“ Java KeyStore”格式，并且是由<code>keytool</code>命令行实用程序。该工具包含在JDK中。的<code>PKCS12</code>格式是一种互联网标准，可以通过OpenSSL和Microsoft的Key-Manager进行操作。
</p>

<p>密钥库中的每个条目都由别名字符串标识。尽管许多密钥库实现以不区分大小写的方式对待别名，但区分大小写的实现仍然可用。的<code>PKCS11</code>例如，规范要求别名区分大小写。为了避免与别名区分大小写有关的问题，建议不要使用仅大小写不同的别名。
</p>

<p>要将现有证书导入到<code>JKS</code>密钥库，请阅读有关您的JDK文档包中的文档<code>keytool</code> 。请注意，OpenSSL通常会在密钥之前添加可读的注释，但是<code>keytool</code>不支持。因此，如果您的证书在关键数据之前有注释，请在导入证书之前先删除它们<code>keytool</code> 。
</p>
<p>要将您自己的CA签名的现有证书导入到<code>PKCS12</code>使用OpenSSL的密钥库，您将执行以下命令：</p>
<div class="codeBox"><pre><code>openssl pkcs12 -export -in mycert.crt -inkey mykey.key
                       -out mycert.p12 -name tomcat -CAfile myCA.crt
                       -caname root -chain</code></pre></div>
<p>有关更高级的情况，请参阅<a href="https://www.openssl.org/" rel="nofollow">OpenSSL文档</a> 。</p>

<p>创建一个新的<code>JKS</code>从头开始，包含单个自签名证书的密钥库，从终端命令行执行以下命令：</p>
<p>视窗：</p>
<div class="codeBox"><pre><code>"%JAVA_HOME%\bin\keytool" -genkey -alias tomcat -keyalg RSA</code></pre></div>
<p>Unix：</p>
<div class="codeBox"><pre><code>$JAVA_HOME/bin/keytool -genkey -alias tomcat -keyalg RSA</code></pre></div>

<p>（最好将RSA算法作为一种安全算法，这还可以确保与其他服务器和组件的一般兼容性。）</p>

<p>此命令将在运行该文件的用户的主目录中创建一个新文件，名为“ <code>.keystore</code> ”。要指定其他位置或文件名，请添加<code>-keystore</code>参数，然后是密钥库文件的完整路径名， <code>keytool</code>上面显示的命令。您还需要在<code>server.xml</code>配置文件，如稍后所述。例如：</p>
<p>视窗：</p>
<div class="codeBox"><pre><code>"%JAVA_HOME%\bin\keytool" -genkey -alias tomcat -keyalg RSA
  -keystore \path\to\my\keystore</code></pre></div>
<p>Unix：</p>
<div class="codeBox"><pre><code>$JAVA_HOME/bin/keytool -genkey -alias tomcat -keyalg RSA
  -keystore /path/to/my/keystore</code></pre></div>

<p>执行此命令后，将首先提示您输入密钥库密码。Tomcat使用的默认密码是“ <code>changeit</code> ”（全部小写），不过您可以根据需要指定自定义密码。您还需要在<code>server.xml</code>配置文件，如稍后所述。</p>

<p>接下来，系统将提示您输入有关此证书的常规信息，例如公司，联系人姓名等。该信息将显示给尝试访问您应用程序中安全页面的用户，因此请确保此处提供的信息与他们期望的信息匹配。</p>

<p>最后，将提示您输入<em>密钥密码</em> ，这是专用于此证书的密码（与存储在同一密钥库文件中的任何其他证书相反）。的<code>keytool</code>提示将告诉您，按ENTER键会自动使用与密钥库相同的密码。您可以自由使用相同的密码或选择自定义密码。如果您选择了与密钥库密码不同的密码，则还需要在<code>server.xml</code>配置文件。</p>

<p>如果一切成功，那么您现在将拥有一个带有证书的密钥库文件，服务器可以使用该证书。</p>

</div></div>

<div class="subsection"><h4 id="Edit_the_Tomcat_Configuration_File">编辑Tomcat配置文件</h4><div class="text">
<p>Tomcat可以使用三种不同的SSL实现：</p>
<ul>
<li>作为Java运行时的一部分提供的JSSE实现</li>
<li>使用OpenSSL的JSSE实现</li>
<li>APR实现，默认情况下使用OpenSSL引擎</li>
</ul>
<p>确切的配置详细信息取决于所使用的实现。如果通过指定通用配置了连接器<code>protocol="HTTP/1.1"</code>然后自动选择Tomcat使用的实现。如果安装使用<a href="apr.html">APR</a> （即您已经安装了Tomcat本机库），则它将使用JSSE OpenSSL实现，否则将使用Java JSSE实现。
</p>

<p>如果需要，可以避免自动选择实现。通过在<a href="config/http.html">Connector</a>的<b>协议</b>属性中指定类名来完成此操作。</p>

<p>要定义Java（JSSE）连接器，无论是否加载了APR库，请使用以下方法之一：</p>
<div class="codeBox"><pre><code>&lt;!-- Define a HTTP/1.1 Connector on port 8443, JSSE NIO implementation --&gt;
&lt;Connector protocol="org.apache.coyote.http11.Http11NioProtocol"
           sslImplementationName="org.apache.tomcat.util.net.jsse.JSSEImplementation"
           port="8443" .../&gt;

&lt;!-- Define a HTTP/1.1 Connector on port 8443, JSSE NIO2 implementation --&gt;
&lt;Connector protocol="org.apache.coyote.http11.Http11Nio2Protocol"
           sslImplementationName="org.apache.tomcat.util.net.jsse.JSSEImplementation"
           port="8443" .../&gt;</code></pre></div>

<p>如果需要，还可以显式配置OpenSSL JSSE实现。如果已安装APR库（与使用APR连接器一样），则使用sslImplementationName属性可以启用它。使用OpenSSL JSSE实现时，配置可以使用JSSE属性或OpenSSL属性（用于APR连接器），但不得在同一SSLHostConfig或Connector元素中混合两种类型的属性。</p>
<div class="codeBox"><pre><code>&lt;!-- Define a HTTP/1.1 Connector on port 8443, JSSE NIO implementation and OpenSSL --&gt;
&lt;Connector protocol="org.apache.coyote.http11.Http11NioProtocol" port="8443"
           sslImplementationName="org.apache.tomcat.util.net.openssl.OpenSSLImplementation"
           .../&gt;</code></pre></div>

<p>或者，要指定一个APR连接器（APR库必须可用），请使用：</p>
<div class="codeBox"><pre><code>&lt;!-- Define a HTTP/1.1 Connector on port 8443, APR implementation --&gt;
&lt;Connector protocol="org.apache.coyote.http11.Http11AprProtocol"
           port="8443" .../&gt;</code></pre></div>

<p>如果使用的是APR或JSSE OpenSSL，则可以选择配置OpenSSL的替代引擎。</p>
<div class="codeBox"><pre><code>&lt;Listener className="org.apache.catalina.core.AprLifecycleListener"
          SSLEngine="someengine" SSLRandomSeed="somedevice" /&gt;</code></pre></div>
<p>默认值为</p>
<div class="codeBox"><pre><code>&lt;Listener className="org.apache.catalina.core.AprLifecycleListener"
          SSLEngine="on" SSLRandomSeed="builtin" /&gt;</code></pre></div>
<p>还有<code>useAprConnector</code>属性可以用于使Tomcat默认使用APR连接器而不是NIO连接器：</p>
<div class="codeBox"><pre><code>&lt;Listener className="org.apache.catalina.core.AprLifecycleListener"
          useAprConnector="true" SSLEngine="on" SSLRandomSeed="builtin" /&gt;</code></pre></div>
<p>因此，要启用OpenSSL，请确保将SSLEngine属性设置为除<code>off</code> 。默认值为<code>on</code>并且如果您指定另一个值，则它必须是有效的OpenSSL引擎名称。
</p>

<p>SSLRandomSeed允许指定熵的来源。生产系统需要可靠的熵源，但是熵可能需要大量时间才能收集，因此测试系统不能使用诸如“ / dev / urandom”之类的阻塞熵源，从而可以更快地启动Tomcat。
</p>

<p>最后一步是在<code>$CATALINA_BASE/conf/server.xml</code>文件，在哪里<code>$CATALINA_BASE</code>表示Tomcat实例的基本目录。一个例子<code><Connector></code> SSL连接器的元素包含在默认值中<code>server.xml</code>与Tomcat一起安装的文件。要配置使用JSSE的SSL连接器，您将需要删除注释并对其进行编辑，使其看起来像这样：</p>
<div class="codeBox"><pre><code>&lt;!-- Define a SSL Coyote HTTP/1.1 Connector on port 8443 --&gt;
&lt;Connector
           protocol="org.apache.coyote.http11.Http11NioProtocol"
           port="8443" maxThreads="200"
           scheme="https" secure="true" SSLEnabled="true"
           keystoreFile="${user.home}/.keystore" keystorePass="changeit"
           clientAuth="false" sslProtocol="TLS"/&gt;</code></pre></div>
<p>注意：如果安装了tomcat-native，则配置将使用带有OpenSSL实现的JSSE，该实现支持此配置或下面给出的APR配置示例。</p>
<p>APR连接器对许多SSL设置使用不同的属性，尤其是密钥和证书。APR配置的示例是：</p>
<div class="codeBox"><pre><code>&lt;!-- Define a SSL Coyote HTTP/1.1 Connector on port 8443 --&gt;
&lt;Connector
           protocol="org.apache.coyote.http11.Http11AprProtocol"
           port="8443" maxThreads="200"
           scheme="https" secure="true" SSLEnabled="true"
           SSLCertificateFile="/usr/local/ssl/server.crt"
           SSLCertificateKeyFile="/usr/local/ssl/server.pem"
           SSLVerifyClient="optional" SSLProtocol="TLSv1+TLSv1.1+TLSv1.2"/&gt;</code></pre></div>


<p><a href="config/http.html#SSL_Support">HTTP连接器</a>配置参考的“ SSL支持”部分中记录了配置选项和关于哪些属性是必需的信息。确保为使用的连接器使用正确的属性。NIO和NIO2连接器使用JSSE，除非安装了JSSE OpenSSL实现（在这种情况下，它支持JSSE或OpenSSL配置样式），而APR /本机连接器使用APR。</p>

<p>的<code>port</code>属性是Tomcat将在其上侦听安全连接的TCP / IP端口号。您可以将其更改为所需的任何端口号（例如，将其更改为默认端口）。 <code>https</code>通信，即443）。但是，在许多操作系统上，要在端口号小于1024的端口上运行Tomcat，必须进行特殊设置（超出本文档的范围）。</p>

  <p><em>如果您在此处更改端口号，则还应该更改为<code>redirectPort</code>非SSL连接器上的属性。这使Tomcat可以自动重定向尝试访问页面的用户，这些用户使用Servlet规范所要求的安全性约束来指定需要SSL。</em></p>

<p>完成这些配置更改后，您必须像平常一样重新启动Tomcat，并且应该可以正常工作。您应该能够通过SSL访问Tomcat支持的任何Web应用程序。例如，尝试：</p>
<div class="codeBox"><pre><code>https://localhost:8443/</code></pre></div>
<p>并且您应该看到通常的Tomcat启动页面（除非您已经修改了ROOT Web应用程序）。如果这不起作用，则以下部分包含一些故障排除提示。</p>

</div></div>

</div><h3 id="Installing_a_Certificate_from_a_Certificate_Authority">从证书颁发机构安装证书</h3><div class="text">
<p>要从证书颁发机构（例如verisign.com，thawte.com或trustcenter.de）获取并安装证书，请阅读上一节，然后按照以下说明进行操作：</p>

<div class="subsection"><h4 id="Create_a_local_Certificate_Signing_Request_(CSR)">创建本地证书签名请求（CSR）</h4><div class="text">
<p>为了从您选择的证书颁发机构获得证书，您必须创建一个所谓的证书签名请求（CSR）。证书颁发机构将使用该CSR来创建一个证书，该证书将您的网站标识为“安全”。要创建CSR，请按照以下步骤操作：</p>
<ul>
<li>创建本地自签名证书（如上一节所述）：<div class="codeBox"><pre><code>keytool -genkey -alias tomcat -keyalg RSA
    -keystore &lt;your_keystore_filename&gt;</code></pre></div>注意：在某些情况下，您将必须输入网站的域名（即<code>www.myside.org</code> ）在“名字和姓氏”字段中，以创建有效的证书。
</li>
<li>然后使用以下方法创建CSR：<div class="codeBox"><pre><code>keytool -certreq -keyalg RSA -alias tomcat -file certreq.csr
    -keystore &lt;your_keystore_filename&gt;</code></pre></div>
</li>
</ul>
<p>现在，您有一个名为<code>certreq.csr</code>可以提交给证书颁发机构（请参阅证书颁发机构网站上的文档以了解如何执行此操作）。作为回报，您将获得证书。</p>
</div></div>

<div class="subsection"><h4 id="Importing_the_Certificate">导入证书</h4><div class="text">
<p>有了证书后，您可以将其导入本地密钥库。首先，您必须将所谓的链证书或根证书导入到密钥库中。之后，您可以继续导入证书。</p>

<ul>
<li>从获得证书的证书颁发机构下载链证书。<br>对于Verisign.com商业证书，请访问：http://www.verisign.com/support/install/intermediate.html<br>对于Verisign.com试用证书，请访问：http://www.verisign.com/support/verisign-intermediate-ca/Trial_Secure_Server_Root/index.html<br>对于Trustcenter.de，请访问：http://www.trustcenter.de/certservices/cacerts/en/en.htm#server<br>对于Thawte.com，请访问：http://www.thawte.com/certs/trustmap.html<br>
</li>
<li>将链证书导入您的密钥库<div class="codeBox"><pre><code>keytool -import -alias root -keystore &lt;your_keystore_filename&gt;
    -trustcacerts -file &lt;filename_of_the_chain_certificate&gt;</code></pre></div>
</li>
<li>最后导入您的新证书<div class="codeBox"><pre><code>keytool -import -alias tomcat -keystore &lt;your_keystore_filename&gt;
    -file &lt;your_certificate_filename&gt;</code></pre></div>
</li>
</ul>
</div></div>
</div><h3 id="Using_OCSP_Certificates">使用OCSP证书</h3><div class="text">
<p>要将在线证书状态协议（OCSP）与Apache Tomcat一起使用，请确保已下载，安装并配置了<a href="https://tomcat.apache.org/download-native.cgi">Tomcat本机连接器</a> 。此外，如果使用Windows平台，请确保下载支持ocsp的连接器。</p>
<p>要使用OCSP，您需要满足以下条件：</p>

<ul>
  <li>启用OCSP的证书</li>
  <li>带有SSL APR连接器的Tomcat</li>
  <li>配置的OCSP响应器</li>
</ul>

<div class="subsection"><h4 id="Generating_OCSP-Enabled_Certificates">生成启用OCSP的证书</h4><div class="text">
<p>Apache Tomcat要求启用OCSP的证书在证书中编码OCSP响应者位置。与OCSP相关的基本证书颁发机构设置<code>openssl.cnf</code>文件可能如下所示：</p>

<div class="codeBox"><pre><code>
#... omitted for brevity

[x509]
x509_extensions = v3_issued

[v3_issued]
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid,issuer
# The address of your responder
authorityInfoAccess = OCSP;URI:http://127.0.0.1:8088
keyUsage = critical,digitalSignature,nonRepudiation,keyEncipherment,dataEncipherment,keyAgreement,keyCertSign,cRLSign,encipherOnly,decipherOnly
basicConstraints=critical,CA:FALSE
nsComment="Testing OCSP Certificate"

#... omitted for brevity
</code></pre></div>

<p>上面的设置对OCSP响应者地址进行编码<code>127.0.0.1:8088</code>进入证书。请注意，对于以下步骤，您必须具有<code>openssl.cnf</code>和CA的其他配置就绪。生成启用OCSP的证书：</p>

<ul>
  <li>创建一个私钥：<div class="codeBox"><pre><code>openssl genrsa -aes256 -out ocsp-cert.key 4096</code></pre></div>
  </li>
  <li>创建签名请求（CSR）：<div class="codeBox"><pre><code>openssl req -config openssl.cnf -new -sha256 \
  -key ocsp-cert.key -out ocsp-cert.csr</code></pre></div></li>
  <li>签署企业社会责任：<div class="codeBox"><pre><code>openssl ca -openssl.cnf -extensions ocsp -days 375 -notext \
  -md sha256 -in ocsp-cert.csr -out ocsp-cert.crt</code></pre></div>
  </li>
  <li>您可以验证证书：<div class="codeBox"><pre><code>openssl x509 -noout -text -in ocsp-cert.crt</code></pre></div>
  </li>
</ul>
</div></div>

<div class="subsection"><h4 id="Configuring_OCSP_Connector">配置OCSP连接器</h4><div class="text">

<p>要配置OCSP连接器，请首先确认您正在加载Tomcat APR库。检查<a href="apr.html#Installation">基于Tomcat的基于Apache可移植运行时（APR）的本机库，</a>以获取有关安装APR的更多信息。 OCSP中启用了OCSP的基本连接器定义<code>server.xml</code>文件外观如下：</p>
<div class="codeBox"><pre><code>
&lt;Connector
    port="8443"
    protocol="org.apache.coyote.http11.Http11AprProtocol"
    secure="true"
    scheme="https"
    SSLEnabled="true"
  &lt;SSLHostConfig
      caCertificateFile="/path/to/ca.pem"
      certificateVerification="require"
      certificateVerificationDepth="10" &gt;
    &lt;Certificate
        certificateFile="/path/to/ocsp-cert.crt"
        certificateKeyFile="/path/to/ocsp-cert.key" /&gt;
  &lt;/SSLHostConfig&gt;
</code></pre></div>
</div></div>

<div class="subsection"><h4 id="Starting_OCSP_Responder">启动OCSP响应程序</h4><div class="text">
  <p>Apache Tomcat将查询OCSP响应器服务器以获取证书状态。测试时，创建OCSP响应程序的一种简单方法是执行以下命令：</p><div class="codeBox"><pre><code>openssl ocsp -port 127.0.0.1:8088 \
    -text -sha256 -index index.txt \
    -CA ca-chain.cert.pem -rkey ocsp-cert.key \
    -rsigner ocsp-cert.crt</code></pre></div> <p></p>

 <p>请注意，使用OCSP时，连接器证书中编码的响应者必须正在运行。有关更多信息，请参见<a href="https://www.openssl.org/docs/man1.1.0/apps/ocsp.html">OCSP文档</a> 。
 </p>

</div></div>

</div><h3 id="Troubleshooting">故障排除</h3><div class="text">

<p>下面列出了设置SSL通信时可能遇到的常见问题，以及如何解决这些问题。</p>

<ul>

<li>Tomcat启动时，出现类似“java.io。FileNotFoundException：找不到{some-directory} / {some-file}”。

    <p>可能的解释是Tomcat无法在其查找位置找到密钥库文件。默认情况下，Tomcat期望将密钥库文件命名为<code>.keystore</code>在运行Tomcat的用户主目录中（可能与您的：-相同或不同）。如果密钥库文件在其他任何位置，则需要添加一个<code>keystoreFile</code>归因于<code><Connector></code> <a href="#Edit_the_Tomcat_Configuration_File">Tomcat配置文件</a>中的元素。</p>
    </li>

<li>Tomcat启动时，出现类似“java.io。FileNotFoundException：密钥库被篡改，或者密码不正确”。

    <p>假定某人<em>实际上</em>并未篡改您的密钥库文件，最可能的原因是Tomcat使用的密码与创建密钥库文件时使用的密码不同。要解决此问题，您可以返回并<a href="#Prepare_the_Certificate_Keystore">重新创建密钥库文件</a> ，也可以添加或更新<code>keystorePass</code>的属性<code><Connector></code> <a href="#Edit_the_Tomcat_Configuration_File">Tomcat配置文件</a>中的元素。<strong>提醒</strong> -密码区分大小写！</p>
    </li>

<li>Tomcat启动时，出现类似“ java.net。SocketException：SSL握手错误javax.net.ssl。SSLException：没有可用的证书或密钥与已启用的SSL密码套件相对应。”<p>可能的解释是Tomcat在指定的密钥库中找不到服务器密钥的别名。检查是否正确<code>keystoreFile</code>和<code>keyAlias</code>在中指定<code><Connector></code> <a href="#Edit_the_Tomcat_Configuration_File">Tomcat配置文件</a>中的元素。
    <strong>提醒</strong> - <code>keyAlias</code>值可能区分大小写！</p>
    </li>

<li>我的基于Java的客户端中止了握手，并带有“ java.lang”之类的异常。RuntimeException：无法生成DH密钥对”和“ java.security。InvalidAlgorithmParameterException：素数必须是64的倍数，并且只能在512到1024（含）之间变化”<p>如果您使用的是APR /本机连接器或JSSE OpenSSL实现，它将通过RSA证书的密钥大小确定临时DH密钥的强度。例如，2048位RSA密钥将导致DH密钥使用2048位素数。不幸的是，Java 6仅支持768位，而Java 7仅支持1024位。因此，如果您的证书具有更强的密钥，则旧的Java客户端可能会产生此类握手失败。作为缓解措施，您可以尝试通过配置适当的密码来强制他们使用其他密码<code>SSLCipherSuite</code>并激活<code>SSLHonorCipherOrder</code> ，或在证书文件中嵌入弱DH参数。不建议使用后一种方法，因为它会削弱SSL安全性（logjam攻击）。</p>
    </li>

</ul>

<p>如果仍然有问题，则<strong>TOMCAT-USER</strong>邮件列表是一个很好的信息来源。您可以在<a href="https://tomcat.apache.org/lists.html">https://tomcat.apache.org/lists.html</a>上找到指向此列表中先前消息的存档以及订阅和取消订阅信息的指针。</p>

</div><h3 id="Using_the_SSL_for_session_tracking_in_your_application">在应用程序中使用SSL进行会话跟踪</h3><div class="text">
  <p>这是Servlet 3.0规范中的新功能。因为它使用与物理客户端-服务器连接关联的SSL会话ID，所以存在一些限制。他们是：</p>
    <ul>
      <li>Tomcat必须具有属性<strong>isSecure</strong>设置为的连接器<code>true</code> 。</li>
      <li>如果SSL连接由代理或硬件加速器管理，则它们必须填充SSL请求标头（请参阅<a href="config/valve.html">SSLValve</a> ），以便Tomcat可以看到SSL会话ID。</li>
      <li>如果Tomcat终止了SSL连接，则将无法使用会话复制，因为SSL会话ID在每个节点上都不同。</li>
    </ul>

  <p>要启用SSL会话跟踪，您需要使用上下文侦听器将上下文的跟踪模式设置为仅SSL（如果启用了任何其他跟踪模式，则会优先使用它）。它可能看起来像：</p>
    <div class="codeBox"><pre><code>package org.apache.tomcat.example;

import java.util.EnumSet;

import javax.servlet.ServletContext;
import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;
import javax.servlet.SessionTrackingMode;

public class SessionTrackingModeListener implements ServletContextListener {

    @Override
    public void contextDestroyed(ServletContextEvent event) {
        // Do nothing
    }

    @Override
    public void contextInitialized(ServletContextEvent event) {
        ServletContext context = event.getServletContext();
        EnumSet&lt;SessionTrackingMode&gt; modes =
            EnumSet.of(SessionTrackingMode.SSL);

        context.setSessionTrackingModes(modes);
    }

}</code></pre></div>

  <p>注意：SSL会话跟踪是针对NIO和NIO2连接器实现的。APR连接器尚未实现。</p>

</div><h3 id="Miscellaneous_Tips_and_Bits">杂项技巧</h3><div class="text">

<p>要从请求访问SSL会话ID，请使用：</p>

  <div class="codeBox"><pre><code>String sslID = (String)request.getAttribute("javax.servlet.request.ssl_session_id");</code></pre></div>
<p>有关此区域的其他讨论，请参见<a href="https://bz.apache.org/bugzilla/show_bug.cgi?id=22679">Bugzilla</a> 。
</p>

  <p>要终止SSL会话，请使用：</p>
    <div class="codeBox"><pre><code>// Standard HTTP session invalidation
session.invalidate();

// Invalidate the SSL Session
org.apache.tomcat.util.net.SSLSessionManager mgr =
    (org.apache.tomcat.util.net.SSLSessionManager)
    request.getAttribute("javax.servlet.request.ssl_session_mgr");
mgr.invalidateSession();

// Close the connection since the SSL session will be active until the connection
// is closed
response.setHeader("Connection", "close");</code></pre></div>
  <p>请注意，由于使用了SSLSessionManager类，因此该代码特定于Tomcat。当前仅适用于NIO和NIO2连接器，不适用于APR / native连接器。
  </p>
</div><div class="noprint"><h3 id="comments_section">评论</h3><div class="text"><p class="notice"><strong>注意：</strong>此注释部分收集有关改进Apache Tomcat文档的建议。<br><br>如果您遇到问题并需要帮助，请阅读“ <a href="https://tomcat.apache.org/findhelp.html">查找帮助”</a>页面，然后在tomcat-users <a href="https://tomcat.apache.org/lists.html">邮件列表中</a>询问您的问题。不要在这里问这样的问题。这不是“问答”部分。<br><br><a href="./comments.html">这里</a>解释<a href="./comments.html">了</a> Apache Comments System。如果评论已被实施或被认为无效/偏离主题，则我们的主持人可能会将其删除。
                  </p><div id="comments_thread"></div></div></div></div></div></div></div><footer><div id="footer">版权所有©1999-2019，Apache软件基金会</div></footer></div></body></html>