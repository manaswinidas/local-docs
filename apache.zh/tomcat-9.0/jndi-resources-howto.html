<html lang="zh-Hans" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><link href="./images/docs-stylesheet.css" rel="stylesheet" type="text/css"><title>Apache Tomcat 9（9.0.21）-JNDI资源使用方法</title><meta name="author" content="Craig R. McClanahan"><meta name="author" content="Yoav Shapira"><script type="application/javascript" data-comments-identifier="tomcat-9.0-doc/jndi-resources-howto">
    "use strict"; // Enable strict mode

    (function() {
      var thisScript = document.currentScript;
      if (!thisScript) { // Workaround for IE <= 11
        var scripts = document.getElementsByTagName("script");
        thisScript = scripts[scripts.length - 1];
      }
      document.addEventListener("DOMContentLoaded", (function() {
        var commentsDiv = document.getElementById("comments_thread");
        var commentsShortname = "tomcat";
        var commentsIdentifier = "https://tomcat.apache.org/" +
          thisScript.getAttribute("data-comments-identifier") + ".html";

        (function(w, d) {
          if (w.location.hostname.toLowerCase() == "tomcat.apache.org") {
            var s = d.createElement("script");
            s.type = "application/javascript";
            s.async = true;
            s.src = "https://comments.apache.org/show_comments.lua?site=" +
              encodeURIComponent(commentsShortname) +
              "&page=" + encodeURIComponent(commentsIdentifier);
            d.head.appendChild(s);
          } else {
            commentsDiv.appendChild(d.createTextNode("Comments are disabled for this page at the moment."));
          }
        })(window, document);
      }), false);
    })();
  </script></head><body ><div id="wrapper"><header><div id="header"><div><div><div class="logo noPrint"><a href="https://tomcat.apache.org/"><img alt="Tomcat主页" src="./images/tomcat.png"></a></div><div style="height:1px"></div><div class="asfLogo noPrint"><a href="https://www.apache.org/" target="_blank"><img src="./images/asf-logo.svg" alt="Apache软件基金会" style="width:266px;height:83px"></a></div><h1>Apache Tomcat 9</h1><div class="versionInfo">版本9.0.21， <time datetime="2019-06-04"> 2019年6月4日</time></div><div style="height:1px"></div><div style="clear:left"></div></div></div></div></header><div id="middle"><div><div id="mainLeft" class="noprint"><div><nav><div><h2>链接</h2><ul><li><a href="index.html">文件首页</a></li><li><a href="https://wiki.apache.org/tomcat/FAQ">常问问题</a></li><li><a href="#comments_section">用户评论</a></li></ul></div><div><h2>用户指南</h2><ul><li><a href="introduction.html">1）简介</a></li><li><a href="setup.html">2）设定</a></li><li><a href="appdev/index.html">3）第一个webapp</a></li><li><a href="deployer-howto.html">4）部署者</a></li><li><a href="manager-howto.html">5）经理</a></li><li><a href="host-manager-howto.html">6）主机管理员</a></li><li><a href="realm-howto.html">7）领域和AAA</a></li><li><a href="security-manager-howto.html">8）安全经理</a></li><li><a href="jndi-resources-howto.html">9）JNDI资源</a></li><li><a href="jndi-datasource-examples-howto.html">10）JDBC数据源</a></li><li><a href="class-loader-howto.html">11）类加载</a></li><li><a href="jasper-howto.html">12）JSP</a></li><li><a href="ssl-howto.html">13）SSL / TLS</a></li><li><a href="ssi-howto.html">14）SSI</a></li><li><a href="cgi-howto.html">15）CGI</a></li><li><a href="proxy-howto.html">16）代理支持</a></li><li><a href="mbeans-descriptors-howto.html">17）MBean描述符</a></li><li><a href="default-servlet.html">18）默认Servlet</a></li><li><a href="cluster-howto.html">19）聚类</a></li><li><a href="balancer-howto.html">20）负载均衡器</a></li><li><a href="connectors.html">21）连接器</a></li><li><a href="monitoring.html">22）监控与管理</a></li><li><a href="logging.html">23）记录</a></li><li><a href="apr.html">24）APR /本地</a></li><li><a href="virtual-hosting-howto.html">25）虚拟主机</a></li><li><a href="aio.html">26）高级IO</a></li><li><a href="extras.html">27）附加组件</a></li><li><a href="maven-jars.html">28）行刑</a></li><li><a href="security-howto.html">29）安全注意事项</a></li><li><a href="windows-service-howto.html">30）Windows服务</a></li><li><a href="windows-auth-howto.html">31）Windows身份验证</a></li><li><a href="jdbc-pool.html">32）Tomcat的JDBC池</a></li><li><a href="web-socket-howto.html">33）WebSocket</a></li><li><a href="rewrite.html">34）改写</a></li></ul></div><div><h2>参考</h2><ul><li><a href="RELEASE-NOTES.txt">发行说明</a></li><li><a href="config/index.html">组态</a></li><li><a href="api/index.html">Tomcat Java文档</a></li><li><a href="servletapi/index.html">Servlet Java文档</a></li><li><a href="jspapi/index.html">JSP 2.3 Java文档</a></li><li><a href="elapi/index.html">EL 3.0 Java文档</a></li><li><a href="websocketapi/index.html">WebSocket 1.1 Java文档</a></li><li><a href="https://tomcat.apache.org/connectors-doc/">JK 1.2文档</a></li></ul></div><div><h2>Apache Tomcat开发</h2><ul><li><a href="building.html">建造</a></li><li><a href="changelog.html">变更日志</a></li><li><a href="https://wiki.apache.org/tomcat/TomcatVersions">状态</a></li><li><a href="developers.html">开发者</a></li><li><a href="architecture/index.html">建筑</a></li><li><a href="funcspecs/index.html">功能规格。</a></li><li><a href="tribes/introduction.html">部族</a></li></ul></div></nav></div></div><div id="mainRight"><div id="content"><h2>JNDI资源使用方法</h2><h3 id="Table_of_Contents">目录</h3><div class="text">
<ul><li><a href="#Introduction">介绍</a></li><li><a href="#web.xml_configuration">web.xml配置</a></li><li><a href="#context.xml_configuration">context.xml配置</a></li><li><a href="#Global_configuration">全局配置</a></li><li><a href="#Using_resources">使用资源</a></li><li><a href="#Tomcat_Standard_Resource_Factories">Tomcat标准资源工厂</a><ol><li><a href="#Generic_JavaBean_Resources">通用JavaBean资源</a></li><li><a href="#UserDatabase_Resources">UserDatabase资源</a></li><li><a href="#JavaMail_Sessions">JavaMail会话</a></li><li><a href="#JDBC_Data_Sources">JDBC数据源</a></li></ol></li><li><a href="#Adding_Custom_Resource_Factories">添加自定义资源工厂</a></li></ul>
</div><h3 id="Introduction">介绍</h3><div class="text">

<p>Tomcat以与<a href="http://www.oracle.com/technetwork/java/javaee/overview/index.html">Java Enterprise Edition</a>应用程序服务器提供的方式兼容的方式为其下运行的每个Web应用程序提供JNDI <strong>InitialContext</strong>实现实例。Java EE标准提供了一组标准的元素。 <code>/WEB-INF/web.xml</code>文件以引用/定义资源。</p>

<p>请参阅以下规范，以获取有关JNDI编程API以及Tomcat为其提供的服务所仿真的Java Enterprise Edition（Java EE）服务器支持的功能的更多信息：</p>
<ul>
<li><a href="http://docs.oracle.com/javase/7/docs/technotes/guides/jndi/index.html">Java命名和目录接口</a> （包含在JDK 1.4及更高版本中）</li>
<li><a href="http://www.oracle.com/technetwork/java/javaee/documentation/index.html">Java EE平台规范</a> （尤其，请参阅有关<em>命名的</em>第5章）</li>
</ul>

</div><h3 id="web.xml_configuration">web.xml配置</h3><div class="text">

<p>Web应用程序部署描述符中可以使用以下元素（ <code>/WEB-INF/web.xml</code> ）来定义资源：</p>
<ul>
<li><code><strong><env-entry></strong></code> -环境条目，一个单值参数，可用于配置应用程序的运行方式。</li>
<li><code><strong><resource-ref></strong></code> -资源引用，通常是对象工厂的资源，例如JDBC <code>DataSource</code> ，一个JavaMail <code>Session</code>或配置到Tomcat中的自定义对象工厂。</li>
<li><code><strong><resource-env-ref></strong></code> -资源环境参考，是<code>resource-ref</code>在Servlet 2.4中添加了，可以更轻松地为不需要身份验证信息的资源进行配置。</li>
</ul>

<p>前提是Tomcat能够识别用于创建资源的适当资源工厂，并且不需要其他配置信息，则Tomcat将使用以下信息： <code>/WEB-INF/web.xml</code>创建资源。</p>

<p>Tomcat为无法在web.xml中指定的JNDI资源提供了许多Tomcat特定的选项。这些包括<code>closeMethod</code>当Web应用程序停止运行时，可以更快地清理JNDI资源。 <code>singleton</code>它控制是否为每个JNDI查找创建资源的新实例。要使用这些配置选项，必须在Web应用程序的<a href="config/context.html"><code><Context></code></a>元素或<a href="config/globalresources.html"><code><strong><GlobalNamingResources></strong></code></a>的元素<code>$CATALINA_BASE/conf/server.xml</code> 。</p>

</div><h3 id="context.xml_configuration">context.xml配置</h3><div class="text">

<p>如果Tomcat无法识别适当的资源工厂和/或需要其他配置信息，则必须指定其他特定于Tomcat的配置，然后Tomcat才能创建资源。在Tomcat中输入特定于Tomcat的资源配置<a href="config/context.html"><code><Context></code></a>可以在任何一个中指定的元素<code>$CATALINA_BASE/conf/server.xml</code>或最好是每个Web应用程序上下文XML文件（ <code>META-INF/context.xml</code> ）。</p>

<p>Tomcat特定的资源配置是使用<a href="config/context.html"><code><Context></code></a>元件：</p>

<ul>
<li><a href="config/context.html#Environment_Entries"><environment></environment></a> -为将通过JNDI向Web应用程序公开的标量环境条目配置名称和值<code>InitialContext</code> （等同于包含一个<code><env-entry></code> Web应用程序部署描述符中的元素）。</li>
<li><a href="config/context.html#Resource_Definitions"><resource></resource></a> -配置可供应用程序使用的资源的名称和数据类型（等同于包含一个<code><resource-ref></code> Web应用程序部署描述符中的元素）。</li>
<li><a href="config/context.html#Resource_Links"><resourcelink></resourcelink></a> -将链接添加到在全局JNDI上下文中定义的资源。使用资源链接使Web应用程序可以访问在<a href="config/globalresources.html"><globalnamingresources></globalnamingresources></a>的子元素<a href="config/server.html"><server></server></a>元件。</li>
<li><a href="config/context.html#Transaction"><transaction></transaction></a> -添加资源工厂以实例化在以下位置可用的UserTransaction对象实例<code>java:comp/UserTransaction</code> 。</li>

</ul>

<p>这些元素中可以嵌套任何数量<a href="config/context.html"><code><Context></code></a>元素，并且仅与该特定Web应用程序相关联。</p>

<p>如果已经在<a href="config/context.html"><code><Context></code></a>元素，无需在以下位置定义该资源<code>/WEB-INF/web.xml</code> 。但是，建议将条目保留在<code>/WEB-INF/web.xml</code>记录Web应用程序的资源需求。</p>

<p>如果已经为<code><env-entry></code> Web应用程序部署描述符中包含的元素（ <code>/WEB-INF/web.xml</code> ）和<code><Environment></code>作为元素的一部分<a href="config/context.html"><code><Context></code></a> Web应用程序的元素， <strong>仅</strong>当相应的允许时，部署描述符中的值<strong>才</strong>优先<code><Environment></code>元素（通过设置<code>override</code>属性为“ true”）。</p>

</div><h3 id="Global_configuration">全局配置</h3><div class="text">

<p>Tomcat为整个服务器维护一个单独的全局资源命名空间。这些是在<a href="config/globalresources.html"><code><strong><GlobalNamingResources></strong></code></a>的元素<code>$CATALINA_BASE/conf/server.xml</code> 。您可以通过以下方式向Web应用程序公开这些资源： <a href="config/context.html#Resource_Links"><resourcelink></resourcelink></a>将其包含在每个Web应用程序上下文中。</p>

<p>如果已使用定义资源<a href="config/context.html#Resource_Links"><resourcelink></resourcelink></a> ，则不必在<code>/WEB-INF/web.xml</code> 。但是，建议将条目保留在<code>/WEB-INF/web.xml</code>记录Web应用程序的资源需求。</p>

</div><h3 id="Using_resources">使用资源</h3><div class="text">

<p>的<code>InitialContext</code>配置为在最初部署Web应用程序时使用，并可供Web应用程序组件使用（用于只读访问）。所有配置的条目和资源都放置在<code>java:comp/env</code> JNDI名称空间的一部分，因此通常是对资源的访问-在这种情况下，是对JDBC的访问<code>DataSource</code> -看起来像这样：</p>

<div class="codeBox"><pre><code>// Obtain our environment naming context
Context initCtx = new InitialContext();
Context envCtx = (Context) initCtx.lookup("java:comp/env");

// Look up our data source
DataSource ds = (DataSource)
  envCtx.lookup("jdbc/EmployeeDB");

// Allocate and use a connection from the pool
Connection conn = ds.getConnection();
... use this connection to access the database ...
conn.close();</code></pre></div>

</div><h3 id="Tomcat_Standard_Resource_Factories">Tomcat标准资源工厂</h3><div class="text">

  <p>Tomcat包括一系列标准资源工厂，这些工厂可以为您的Web应用程序提供服务，但可以为您提供配置灵活性（通过<a href="config/context.html"><code><Context></code></a>元素）而无需修改Web应用程序或部署描述符。以下每个小节详细介绍了标准资源工厂的配置和使用。</p>

  <p>有关如何在Tomcat中创建，安装，配置和使用自己的自定义资源工厂类的信息，请参见<a href="#Adding_Custom_Resource_Factories">添加自定义资源工厂</a> 。</p>

  <p><em>注</em> –在标准资源工厂中，只有“ JDBC数据源”和“用户事务”工厂被强制在其他平台上可用，然后只有在平台实现Java Enterprise Edition（Java EE）规范时才需要它们。所有其他标准资源工厂，以及您自己编写的自定义资源工厂，都是特定于Tomcat的，不能假定在其他容器上可用。</p>

  <div class="subsection"><h4 id="Generic_JavaBean_Resources">通用JavaBean资源</h4><div class="text">

    <h5>0。介绍</h5>

    <p>此资源工厂可用于创建符合标准JavaBeans命名约定的<em>任何</em> Java类的对象（即，它具有零参数构造函数，并具有符合setFoo（）命名模式的属性设置器。资源工厂每次只会在适当的bean类中创建一个新实例。 <code>lookup()</code>如果该条目是<code>singleton</code>工厂的属性设置为<code>false</code> 。</p>

    <p>下面介绍了使用此工具所需的步骤。</p>

    <h5>1。创建您的JavaBean类</h5>

    <p>创建JavaBean类，该类将在每次查找资源工厂时实例化。对于此示例，假设您创建一个类<code>com.mycompany.MyBean</code> ，如下所示：</p>

<div class="codeBox"><pre><code>package com.mycompany;

public class MyBean {

  private String foo = "Default Foo";

  public String getFoo() {
    return (this.foo);
  }

  public void setFoo(String foo) {
    this.foo = foo;
  }

  private int bar = 0;

  public int getBar() {
    return (this.bar);
  }

  public void setBar(int bar) {
    this.bar = bar;
  }


}</code></pre></div>

  <h5>2。声明您的资源需求</h5>

  <p>接下来，修改您的Web应用程序部署描述符（ <code>/WEB-INF/web.xml</code> ）声明JNDI名称，在该名称下您将请求此bean的新实例。最简单的方法是使用<code><resource-env-ref></code>元素，如下所示：</p>

<div class="codeBox"><pre><code>&lt;resource-env-ref&gt;
  &lt;description&gt;
    Object factory for MyBean instances.
  &lt;/description&gt;
  &lt;resource-env-ref-name&gt;
    bean/MyBeanFactory
  &lt;/resource-env-ref-name&gt;
  &lt;resource-env-ref-type&gt;
    com.mycompany.MyBean
  &lt;/resource-env-ref-type&gt;
&lt;/resource-env-ref&gt;</code></pre></div>

    <p><strong>警告</strong> -确保您遵守DTD对于Web应用程序部署描述符所要求的元素排序！有关详细信息，请参见<a href="https://wiki.apache.org/tomcat/Specifications">Servlet规范</a> 。</p>

  <h5>3。编码您的应用程序对此资源的使用</h5>

  <p>该资源环境参考的典型用法如下所示：</p>

<div class="codeBox"><pre><code>Context initCtx = new InitialContext();
Context envCtx = (Context) initCtx.lookup("java:comp/env");
MyBean bean = (MyBean) envCtx.lookup("bean/MyBeanFactory");

writer.println("foo = " + bean.getFoo() + ", bar = " +
               bean.getBar());</code></pre></div>

    <h5>4。配置Tomcat的资源工厂</h5>

    <p>要配置Tomcat的资源工厂，请将类似元素添加到<a href="config/context.html"><code><Context></code></a>此Web应用程序的元素。</p>

<div class="codeBox"><pre><code>&lt;Context ...&gt;
  ...
  &lt;Resource name="bean/MyBeanFactory" auth="Container"
            type="com.mycompany.MyBean"
            factory="org.apache.naming.factory.BeanFactory"
            bar="23"/&gt;
  ...
&lt;/Context&gt;</code></pre></div>

    <p>请注意，资源名称（此处为<code>bean/MyBeanFactory</code>必须与Web应用程序部署描述符中指定的值匹配。我们还正在初始化<code>bar</code>财产，这将导致<code>setBar(23)</code>在返回新bean之前被调用。因为我们没有初始化<code>foo</code>属性（尽管我们可以拥有），bean将包含其构造函数设置的任何默认值。</p>

    <p>某些bean具有无法自动从字符串值转换的类型的属性。使用Tomcat BeanFactory设置此类属性将失败，并显示NamingException。如果这些bean提供了从字符串值设置属性的方法，则可以将Tomcat BeanFactory配置为使用这些方法。使用以下命令完成配置<code>forceString</code>属性。</p>

    <p>假设我们的bean看起来像这样：</p>

<div class="codeBox"><pre><code>package com.mycompany;

import java.net.InetAddress;
import java.net.UnknownHostException;

public class MyBean2 {

  private InetAddress local = null;

  public InetAddress getLocal() {
    return local;
  }

  public void setLocal(InetAddress ip) {
    local = ip;
  }

  public void setLocal(String localHost) {
    try {
      local = InetAddress.getByName(localHost);
    } catch (UnknownHostException ex) {
    }
  }

  private InetAddress remote = null;

  public InetAddress getRemote() {
    return remote;
  }

  public void setRemote(InetAddress ip) {
    remote = ip;
  }

  public void host(String remoteHost) {
    try {
      remote = InetAddress.getByName(remoteHost);
    } catch (UnknownHostException ex) {
    }
  }

}</code></pre></div>

    <p>Bean具有两个属性，两者均为类型<code>InetAddress</code> 。第一个属性<code>local</code>还有一个带有字符串参数的setter方法。默认情况下，Tomcat BeanFactory会尝试使用与属性类型相同的参数类型的自动检测到的setter，然后抛出NamingException，因为它不准备将给定的字符串属性值转换为<code>InetAddress</code> 。我们可以告诉Tomcat BeanFactory像这样使用其他设置器：</p>

<div class="codeBox"><pre><code>&lt;Context ...&gt;
  ...
  &lt;Resource name="bean/MyBeanFactory" auth="Container"
            type="com.mycompany.MyBean2"
            factory="org.apache.naming.factory.BeanFactory"
            forceString="local"
            local="localhost"/&gt;
  ...
&lt;/Context&gt;</code></pre></div>

    <p>bean属性<code>remote</code>也可以从字符串设置，但是必须使用非标准方法名称<code>host</code> 。设置<code>local</code>和<code>remote</code>使用以下配置：</p>

<div class="codeBox"><pre><code>&lt;Context ...&gt;
  ...
  &lt;Resource name="bean/MyBeanFactory" auth="Container"
            type="com.mycompany.MyBean2"
            factory="org.apache.naming.factory.BeanFactory"
            forceString="local,remote=host"
            local="localhost"
            remote="tomcat.apache.org"/&gt;
  ...
&lt;/Context&gt;</code></pre></div>

    <p>可以组合多个属性描述<code>forceString</code>用逗号作为分隔符。每个属性描述都仅包含属性名称，在这种情况下，BeanFactory调用setter方法。或包含<code>name=method</code>在这种情况下，名为<code>name</code>由调用方法设置<code>method</code> 。对于类型的属性<code>String</code>或原始类型或其关联的原始包装器类使用<code>forceString</code>不需要。将自动检测到正确的设置器，并将应用参数转换。</p>

  </div></div>


  <div class="subsection"><h4 id="UserDatabase_Resources">UserDatabase资源</h4><div class="text">

    <h5>0。介绍</h5>

    <p>通常将UserDatabase资源配置为供UserDatabase领域使用的全局资源。Tomcat包括一个UserDatabaseFactory，它创建由XML文件支持的UserDatabase资源-通常<code>tomcat-users.xml</code></p>

    <p>下面介绍设置全局UserDatabase资源所需的步骤。</p>

    <h5>1。创建/编辑XML文件</h5>

    <p>XML文件通常位于<code>$CATALINA_BASE/conf/tomcat-users.xml</code>但是，您可以随意在文件系统上的任何位置找到该文件。建议将XML文件放在<code>$CATALINA_BASE/conf</code> 。典型的XML如下所示：</p>

<div class="codeBox"><pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;tomcat-users&gt;
  &lt;role rolename="tomcat"/&gt;
  &lt;role rolename="role1"/&gt;
  &lt;user username="tomcat" password="tomcat" roles="tomcat"/&gt;
  &lt;user username="both" password="tomcat" roles="tomcat,role1"/&gt;
  &lt;user username="role1" password="tomcat" roles="role1"/&gt;
&lt;/tomcat-users&gt;</code></pre></div>

    <h5>2。声明您的资源</h5>

    <p>接下来，修改<code>$CATALINA_BASE/conf/server.xml</code>根据您的XML文件创建UserDatabase资源。它看起来应该像这样：</p>

<div class="codeBox"><pre><code>&lt;Resource name="UserDatabase"
          auth="Container"
          type="org.apache.catalina.UserDatabase"
          description="User database that can be updated and saved"
          factory="org.apache.catalina.users.MemoryUserDatabaseFactory"
          pathname="conf/tomcat-users.xml"
          readonly="false" /&gt;</code></pre></div>

    <p>的<code>pathname</code>属性可以是URL，绝对路径或相对路径。如果是相对的，则相对于<code>$CATALINA_BASE</code> 。
    </p>

    <p>的<code>readonly</code>属性是可选的，默认为<code>true</code>如果未提供。如果XML是可写的，则它将在Tomcat启动时写入。<strong>警告：</strong>写入文件时，它将继承运行Tomcat的用户的默认文件权限。确保这些适当以维护安装的安全性。</p>

    <p>如果在领域中引用，则默认情况下，UserDatabse将监视<code>pathname</code>进行更改，如果观察到上次修改时间发生更改，则重新加载文件。可以通过设置<code>watchSource</code>归因于<code>false</code> 。
    </p>

    <h5>3。配置领域</h5>

    <p>如<a href="config/realm.html">Realm配置文档中</a>所述，配置UserDatabase Realm以使用此资源。</p>

  </div></div>


  <div class="subsection"><h4 id="JavaMail_Sessions">JavaMail会话</h4><div class="text">

    <h5>0。介绍</h5>

    <p>在许多Web应用程序中，发送电子邮件消息是系统功能的必需部分。<a href="http://www.oracle.com/technetwork/java/javamail/index.html">Java Mail</a> API使此过程相对简单，但是需要客户端应用程序必须了解的许多配置详细信息（包括用于消息发送的SMTP主机的名称）。</p>

    <p>Tomcat包括一个将创建的标准资源工厂<code>javax.mail.Session</code>您的会话实例，已经配置为连接到SMTP服务器。通过这种方式，应用程序完全不受电子邮件服务器配置环境中的更改的影响-它仅在需要时请求并接收预配置的会话。</p>

    <p>下面概述了为此所需的步骤。</p>

    <h5>1。声明您的资源需求</h5>

    <p>您应该做的第一件事是修改Web应用程序部署描述符（ <code>/WEB-INF/web.xml</code> ）声明要在其下查找预配置会话的JNDI名称。按照惯例，所有此类名称应解析为<code>mail</code>子上下文（相对于标准<code>java:comp/env</code>命名上下文是所有提供的资源工厂的根。典型的<code>web.xml</code>条目可能如下所示：</p>
<div class="codeBox"><pre><code>&lt;resource-ref&gt;
  &lt;description&gt;
    Resource reference to a factory for javax.mail.Session
    instances that may be used for sending electronic mail
    messages, preconfigured to connect to the appropriate
    SMTP server.
  &lt;/description&gt;
  &lt;res-ref-name&gt;
    mail/Session
  &lt;/res-ref-name&gt;
  &lt;res-type&gt;
    javax.mail.Session
  &lt;/res-type&gt;
  &lt;res-auth&gt;
    Container
  &lt;/res-auth&gt;
&lt;/resource-ref&gt;</code></pre></div>

    <p><strong>警告</strong> -确保您遵守DTD对于Web应用程序部署描述符所要求的元素排序！有关详细信息，请参见<a href="https://wiki.apache.org/tomcat/Specifications">Servlet规范</a> 。</p>

    <h5>2。编码您的应用程序对此资源的使用</h5>

    <p>该资源引用的典型用法如下所示：</p>
<div class="codeBox"><pre><code>Context initCtx = new InitialContext();
Context envCtx = (Context) initCtx.lookup("java:comp/env");
Session session = (Session) envCtx.lookup("mail/Session");

Message message = new MimeMessage(session);
message.setFrom(new InternetAddress(request.getParameter("from")));
InternetAddress to[] = new InternetAddress[1];
to[0] = new InternetAddress(request.getParameter("to"));
message.setRecipients(Message.RecipientType.TO, to);
message.setSubject(request.getParameter("subject"));
message.setContent(request.getParameter("content"), "text/plain");
Transport.send(message);</code></pre></div>

    <p>请注意，应用程序使用与Web应用程序部署描述符中声明的资源引用名称相同的名称。这与在配置文件中配置的资源工厂相匹配。 <a href="config/context.html"><code><Context></code></a> Web应用程序的元素，如下所述。</p>

    <h5>3。配置Tomcat的资源工厂</h5>

    <p>要配置Tomcat的资源工厂，请将类似的元素添加到<a href="config/context.html"><code><Context></code></a>此Web应用程序的元素。</p>

<div class="codeBox"><pre><code>&lt;Context ...&gt;
  ...
  &lt;Resource name="mail/Session" auth="Container"
            type="javax.mail.Session"
            mail.smtp.host="localhost"/&gt;
  ...
&lt;/Context&gt;</code></pre></div>

    <p>请注意，资源名称（此处为<code>mail/Session</code> ）必须与Web应用程序部署描述符中指定的值匹配。自定义值<code>mail.smtp.host</code>该参数指向为您的网络提供SMTP服务的服务器。</p>

    <p>其他资源属性和值将转换为属性和值并传递给<code>javax.mail.Session.getInstance(java.util.Properties)</code>作为<code>java.util.Properties</code>采集。除了JavaMail规范的附件A中定义的属性外，各个提供程序还可以支持其他属性。
    </p>

    <p>如果资源配置有<code>password</code>属性和一个<code>mail.smtp.user</code>要么<code>mail.user</code>属性，然后Tomcat的资源工厂将配置并添加一个<code>javax.mail.Authenticator</code>邮件会话。</p>

    <h5>4。安装JavaMail库</h5>

    <p><a href="http://javamail.java.net/">下载JavaMail API</a> 。</p>

    <p>解压缩发行版并将mail.jar放入$ CATALINA_HOME / lib中，以便在邮件会话资源初始化期间Tomcat可以使用它。<strong>注意：</strong>将此jar放在$ CATALINA_HOME / lib和Web应用程序的lib文件夹中都会导致错误，因此请确保仅将其放在$ CATALINA_HOME / lib位置。
    </p>

    <h5>5，重新启动Tomcat</h5>

    <p>为了使其他JAR对Tomcat可见，必须重新启动Tomcat实例。</p>


    <h5>应用范例</h5>

    <p>的<code>/examples</code> Tomcat随附的应用程序包含使用此资源工厂的示例。可通过“ JSP示例”链接进行访问。实际发送邮件消息的servlet的源代码位于<code>/WEB-INF/classes/SendMailServlet.java</code> 。</p>

    <p><strong>警告</strong> -默认配置假定端口25上有一个SMTP服务器列表<code>localhost</code> 。如果不是这种情况，请编辑<a href="config/context.html"><code><Context></code></a>此Web应用程序的元素，并修改<code>mail.smtp.host</code>参数为网络上SMTP服务器的主机名。</p>

  </div></div>

  <div class="subsection"><h4 id="JDBC_Data_Sources">JDBC数据源</h4><div class="text">

    <h5>0。介绍</h5>

    <p>许多Web应用程序需要通过JDBC驱动程序访问数据库，以支持该应用程序所需的功能。Java EE平台规范要求Java EE应用服务器为此提供<em>数据源</em>实现（即，用于JDBC连接的连接池）。Tomcat提供了完全相同的支持，因此，使用此服务在Tomcat上开发的基于数据库的应用程序将在任何Java EE服务器上保持不变。</p>

    <p>有关JDBC的信息，请查阅以下内容：</p>
    <ul>
    <li><a href="http://www.oracle.com/technetwork/java/javase/jdbc/index.html">http://www.oracle.com/technetwork/java/javase/jdbc/index.html-</a>有关Java数据库连接的信息的主页。</li>
    <li><a href="http://java.sun.com/j2se/1.3/docs/guide/jdbc/spec2/jdbc2.1.frame.html">http://java.sun.com/j2se/1.3/docs/guide/jdbc/spec2/jdbc2.1.frame.html-JDBC</a> 2.1 API规范。</li>
    <li><a href="http://java.sun.com/products/jdbc/jdbc20.stdext.pdf">http://java.sun.com/products/jdbc/jdbc20.stdext.pdf-JDBC</a> 2.0标准扩展API（包括<code>javax.sql.DataSource</code> API）。该程序包现在称为“ JDBC可选程序包”。</li>
    <li><a href="http://www.oracle.com/technetwork/java/javaee/overview/index.htm">http://www.oracle.com/technetwork/java/javaee/overview/index.htm-Java</a> EE平台规范（涵盖了所有Java EE平台必须提供给应用程序的JDBC功能）。</li>
    </ul>

    <p><strong>注</strong> – Tomcat中的默认数据源支持基于<a href="https://commons.apache.org/">Commons</a>项目中的<strong>DBCP 2</strong>连接池。但是，可以使用其他任何实现的连接池<code>javax.sql.DataSource</code> ，通过编写自己的自定义资源工厂，描述<a href="#Adding_Custom_Resource_Factories">如下</a> 。</p>

    <h5>1。安装您的JDBC驱动程序</h5>

    <p><em>JDBC数据源的使用</em> JNDI Resource Factory要求您为Tomcat内部类和Web应用程序提供适当的JDBC驱动程序。通过将驱动程序的JAR文件安装到<code>$CATALINA_HOME/lib</code>目录，该驱动程序可用于资源工厂和您的应用程序。</p>

    <h5>2。声明您的资源需求</h5>

    <p>接下来，修改Web应用程序部署描述符（ <code>/WEB-INF/web.xml</code> ）以声明JNDI名称，在该名称下您将查找预配置的数据源。按照惯例，所有此类名称应解析为<code>jdbc</code>子上下文（相对于标准<code>java:comp/env</code>命名上下文是所有提供的资源工厂的根。典型的<code>web.xml</code>条目可能如下所示：</p>
<div class="codeBox"><pre><code>&lt;resource-ref&gt;
  &lt;description&gt;
    Resource reference to a factory for java.sql.Connection
    instances that may be used for talking to a particular
    database that is configured in the &lt;Context&gt;
    configuration for the web application.
  &lt;/description&gt;
  &lt;res-ref-name&gt;
    jdbc/EmployeeDB
  &lt;/res-ref-name&gt;
  &lt;res-type&gt;
    javax.sql.DataSource
  &lt;/res-type&gt;
  &lt;res-auth&gt;
    Container
  &lt;/res-auth&gt;
&lt;/resource-ref&gt;</code></pre></div>

    <p><strong>警告</strong> -确保您遵守DTD对于Web应用程序部署描述符所要求的元素排序！有关详细信息，请参见<a href="https://wiki.apache.org/tomcat/Specifications">Servlet规范</a> 。</p>

    <h5>3。编码您的应用程序对此资源的使用</h5>

    <p>该资源引用的典型用法如下所示：</p>
<div class="codeBox"><pre><code>Context initCtx = new InitialContext();
Context envCtx = (Context) initCtx.lookup("java:comp/env");
DataSource ds = (DataSource)
  envCtx.lookup("jdbc/EmployeeDB");

Connection conn = ds.getConnection();
... use this connection to access the database ...
conn.close();</code></pre></div>

    <p>请注意，应用程序使用与Web应用程序部署描述符中声明的资源引用名称相同的名称。这与在配置文件中配置的资源工厂相匹配。 <a href="config/context.html"><code><Context></code></a> Web应用程序的元素，如下所述。</p>

    <h5>4。配置Tomcat的资源工厂</h5>

    <p>要配置Tomcat的资源工厂，请将类似元素添加到<a href="config/context.html"><code><Context></code></a> Web应用程序的元素。</p>

<div class="codeBox"><pre><code>&lt;Context ...&gt;
  ...
  &lt;Resource name="jdbc/EmployeeDB"
            auth="Container"
            type="javax.sql.DataSource"
            username="dbusername"
            password="dbpassword"
            driverClassName="org.hsql.jdbcDriver"
            url="jdbc:HypersonicSQL:database"
            maxTotal="8"
            maxIdle="4"/&gt;
  ...
&lt;/Context&gt;</code></pre></div>

    <p>请注意，资源名称（此处为<code>jdbc/EmployeeDB</code> ）必须与Web应用程序部署描述符中指定的值匹配。</p>

    <p>本示例假定您正在使用HypersonicSQL数据库JDBC驱动程序。自定义<code>driverClassName</code>和<code>driverName</code>参数以匹配实际数据库的JDBC驱动程序和连接URL。</p>

    <p>Tomcat的标准数据源资源工厂的配置属性（ <code>org.apache.tomcat.dbcp.dbcp2.BasicDataSourceFactory</code> ） 如下面所述：</p>
    <ul>
    <li><strong>driverClassName-</strong>要使用的JDBC驱动程序的标准Java类名称。</li>
    <li><strong>用户名</strong> -要传递给我们的JDBC驱动程序的数据库用户名。</li>
    <li><strong>password-</strong>要传递给我们的JDBC驱动程序的数据库密码。</li>
    <li><strong>url-</strong>要传递给我们的JDBC驱动程序的连接URL。（为了向后兼容，该属性<code>driverName</code>也被认可。）</li>
    <li><strong>initialSize-</strong>在池初始化期间将在池中创建的初始连接数。默认值：0</li>
    <li><strong>maxTotal-</strong>可以同时从此池分配的最大连接数。默认值：8</li>
    <li><strong>minIdle-</strong>同时在此池中处于空闲状态的最小连接数。默认值：0</li>
    <li><strong>maxIdle-</strong>可以同时在此池中处于空闲状态的最大连接数。默认值：8</li>
    <li><strong>maxWaitMillis-</strong>抛出异常之前，池将等待（没有可用连接时）连接返回的最大毫秒数。默认值：-1（无限）</li>
    </ul>
    <p>一些其他属性可处理连接验证：</p>
    <ul>
    <li><strong>validationQuery-</strong>池可用于在将连接返回给应用程序之前验证连接的SQL查询。如果指定，则此查询必须是返回至少一行的SQL SELECT语句。</li>
    <li><strong>validationQueryTimeout-</strong>验证查询返回的超时（以秒为单位）。默认值：-1（无限）</li>
    <li><strong>testOnBorrow</strong> - true或false：连接是否应该使用每个它从池借用时间的验证查询验证。默认值：true</li>
    <li><strong>testOnReturn-</strong>是或否：每次将连接返回到池时是否应使用验证查询来验证连接。默认值：false</li>
    </ul>
    <p>可选的退出线程负责通过删除任何长时间处于空闲状态的连接来缩小池。驱逐者不尊重<code>minIdle</code> 。请注意，如果仅希望根据配置的池缩小池，则无需激活退出线程。 <code>maxIdle</code>属性。</p>
    <p>逐出器默认情况下处于禁用状态，可以使用以下属性进行配置：</p>
    <ul>
    <li><strong>timeBetweenEvictionRunsMillis-逐次</strong>运行两次之间的毫秒数。默认值：-1（禁用）</li>
    <li><strong>numTestsPerEvictionRun-</strong>每次运行<strong>驱逐程序时，驱逐</strong>程序将检查连接是否空闲的连接数。默认值：3</li>
    <li><strong>minEvictableIdleTimeMillis-</strong>空闲时间（以毫秒为单位），在此时间之后，退出者可以从池中删除连接。默认值：30 * 60 * 1000（30分钟）</li>
    <li><strong>testWhileIdle-</strong>正确或错误：是否应在空闲时使<strong>退出</strong>线程使用验证查询来验证连接。默认值：false</li>
    </ul>
    <p>另一个可选功能是删除废弃的连接。如果应用程序长时间不将其返回到池中，则该连接称为放弃连接。池可以自动关闭此类连接并将其从池中删除。这是应用程序泄漏连接的一种解决方法。</p>
    <p>默认情况下，放弃功能是禁用的，可以使用以下属性进行配置：</p>
    <ul>
    <li><strong>removeAbandonedOnBorrow-</strong>正确或错误：借用连接时是否从池中删除废弃的连接。默认值：false</li>
    <li><strong>removeAbandonedOnMaintenance-</strong>正确或错误：是否在池维护期间从池中删除废弃的连接。默认值：false</li>
    <li><strong>removeAbandonedTimeout-</strong>假定借用的连接被放弃之前经过的秒数。默认值：300</li>
    <li><strong>logAbandoned</strong> - true或false：是否记录对应用程序代码的堆栈跟踪它放弃了陈述或连接。这增加了严重的开销。默认值：false</li>
    </ul>
    <p>最后，还有各种属性可以对池行为进行进一步的微调：</p>
    <ul>
    <li><strong>defaultAutoCommit-</strong>正确或错误：此池创建的连接的默认自动提交状态。默认值：true</li>
    <li><strong>defaultReadOnly-</strong>正确或错误：此池创建的连接的默认只读状态。默认值：false</li>
    <li><strong>defaultTransactionIsolation-</strong>设置默认事务隔离级别。可以是以下之一<code>NONE</code> ， <code>READ_COMMITTED</code> ， <code>READ_UNCOMMITTED</code> ， <code>REPEATABLE_READ</code> ， <code>SERIALIZABLE</code> 。默认值：未设置默认值</li>
    <li><strong>poolPreparedStatements</strong> -true或false：是否<strong>合并</strong> PreparedStatements和CallableStatements。默认值：false</li>
    <li><strong>maxOpenPreparedStatements-</strong>可以同时从语句池分配的最大打开语句数。默认值：-1（无限制）</li>
    <li><strong>defaultCatalog-</strong>默认目录的名称。默认值：未设置</li>
    <li><strong>connectionInitSqls-</strong>创建连接后，SQL语句列表将运行一次。用分号分隔多个语句（ <code>;</code> ）。默认值：无声明</li>
    <li><strong>connectionProperties-</strong>传递给驱动程序以创建连接的特定于驱动程序的属性。每个属性均以<code>name=value</code> ，多个属性之间用分号（ <code>;</code> ）。默认值：无属性</li>
    <li><strong>accessToUnderlyingConnectionAllowed-</strong>正确或错误：是否允许访问基础连接。默认值：false</li>
    </ul>
    <p>有关更多详细信息，请参阅Commons DBCP 2文档。</p>

  </div></div>

</div><h3 id="Adding_Custom_Resource_Factories">添加自定义资源工厂</h3><div class="text">

  <p>如果没有标准资源工厂可以满足您的需求，则可以编写自己的工厂并将其集成到Tomcat中，然后在服务器上配置该工厂的使用。 <a href="config/context.html"><code><Context></code></a> Web应用程序的元素。在下面的示例中，我们将创建一个仅知道如何创建工厂<code>com.mycompany.MyBean</code>上面的<a href="#Generic_JavaBean_Resources">通用JavaBean资源</a>示例中的bean。</p>

  <h4>1。编写资源工厂类</h4>

  <p>您必须编写一个实现JNDI服务提供者的类<code>javax.naming.spi.ObjectFactory</code>接口。每次您的Web应用程序调用<code>lookup()</code>在绑定到该工厂的上下文条目上（假设工厂配置有<code>singleton="false"</code> ）， <code>getObjectInstance()</code>使用以下参数调用方法：</p>
  <ul>
  <li><strong>Object obj-</strong> （可能为null）对象，其中包含可用于创建对象的位置或参考信息。对于Tomcat，它将始终是类型的对象<code>javax.naming.Reference</code> ，其中包含此工厂类的类名称以及配置属性（来自<a href="config/context.html"><code><Context></code></a>用于Web应用程序）以用于创建要返回的对象。</li>
  <li><strong>名称名称</strong> -该工厂相对于其绑定的名称<code>nameCtx</code> ， 要么<code>null</code>如果未指定名称。</li>
  <li><strong>上下文名称Ctx-与之</strong>相对的上下文<code>name</code>指定了参数，或者<code>null</code>如果<code>name</code>相对于默认初始上下文。</li>
  <li><strong>哈希表环境</strong> -创建此对象时使用的环境（可能为null）。这通常在Tomcat对象工厂中被忽略。</li>
  </ul>

  <p>创建一个知道如何生产的资源工厂<code>MyBean</code>实例，您可以创建一个这样的类：</p>

<div class="codeBox"><pre><code>package com.mycompany;

import java.util.Enumeration;
import java.util.Hashtable;
import javax.naming.Context;
import javax.naming.Name;
import javax.naming.NamingException;
import javax.naming.RefAddr;
import javax.naming.Reference;
import javax.naming.spi.ObjectFactory;

public class MyBeanFactory implements ObjectFactory {

  public Object getObjectInstance(Object obj,
      Name name2, Context nameCtx, Hashtable environment)
      throws NamingException {

      // Acquire an instance of our specified bean class
      MyBean bean = new MyBean();

      // Customize the bean properties from our attributes
      Reference ref = (Reference) obj;
      Enumeration addrs = ref.getAll();
      while (addrs.hasMoreElements()) {
          RefAddr addr = (RefAddr) addrs.nextElement();
          String name = addr.getType();
          String value = (String) addr.getContent();
          if (name.equals("foo")) {
              bean.setFoo(value);
          } else if (name.equals("bar")) {
              try {
                  bean.setBar(Integer.parseInt(value));
              } catch (NumberFormatException e) {
                  throw new NamingException("Invalid 'bar' value " + value);
              }
          }
      }

      // Return the customized instance
      return (bean);

  }

}</code></pre></div>

  <p>在此示例中，我们无条件创建了一个新的<code>com.mycompany.MyBean</code>类，并根据包含在其中的参数填充其属性<code><ResourceParams></code>配置此工厂的元素（请参见下文）。您应注意，任何名为<code>factory</code>应该跳过-该参数用于指定工厂类本身的名称（在这种情况下， <code>com.mycompany.MyBeanFactory</code> ），而不是要配置的Bean的属性。</p>

  <p>有关更多信息<code>ObjectFactory</code> ，请参阅《 <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/jndi/index.html">JNDI服务提供商接口（SPI）规范》</a> 。</p>

  <p>您将需要根据包含所有JAR文件中的类路径的类路径编译此类。 <code>$CATALINA_HOME/lib</code>目录。完成后，将解开的工厂类（和相应的Bean类）放在下面<code>$CATALINA_HOME/lib</code> ，或放在JAR文件中<code>$CATALINA_HOME/lib</code> 。这样，所需的类文件对于Catalina内部资源和您的Web应用程序都是可见的。</p>

  <h4>2。声明您的资源需求</h4>

  <p>接下来，修改您的Web应用程序部署描述符（ <code>/WEB-INF/web.xml</code> ）声明JNDI名称，在该名称下您将请求此bean的新实例。最简单的方法是使用<code><resource-env-ref></code>元素，如下所示：</p>

<div class="codeBox"><pre><code>&lt;resource-env-ref&gt;
  &lt;description&gt;
    Object factory for MyBean instances.
  &lt;/description&gt;
  &lt;resource-env-ref-name&gt;
    bean/MyBeanFactory
  &lt;/resource-env-ref-name&gt;
  &lt;resource-env-ref-type&gt;
    com.mycompany.MyBean
  &lt;/resource-env-ref-type&gt;
&lt;/resource-env-ref&gt;</code></pre></div>

    <p><strong>警告</strong> -确保您遵守DTD对于Web应用程序部署描述符所要求的元素排序！有关详细信息，请参见<a href="https://wiki.apache.org/tomcat/Specifications">Servlet规范</a> 。</p>

  <h4>3。编码您的应用程序对此资源的使用</h4>

  <p>该资源环境参考的典型用法如下所示：</p>

<div class="codeBox"><pre><code>Context initCtx = new InitialContext();
Context envCtx = (Context) initCtx.lookup("java:comp/env");
MyBean bean = (MyBean) envCtx.lookup("bean/MyBeanFactory");

writer.println("foo = " + bean.getFoo() + ", bar = " +
               bean.getBar());</code></pre></div>

    <h4>4。配置Tomcat的资源工厂</h4>

    <p>要配置Tomcat的资源工厂，请将类似的元素添加到<a href="config/context.html"><code><Context></code></a>此Web应用程序的元素。</p>

<div class="codeBox"><pre><code>&lt;Context ...&gt;
  ...
  &lt;Resource name="bean/MyBeanFactory" auth="Container"
            type="com.mycompany.MyBean"
            factory="com.mycompany.MyBeanFactory"
            singleton="false"
            bar="23"/&gt;
  ...
&lt;/Context&gt;</code></pre></div>

    <p>请注意，资源名称（此处为<code>bean/MyBeanFactory</code>必须与Web应用程序部署描述符中指定的值匹配。我们还正在初始化<code>bar</code>财产，这将导致<code>setBar(23)</code>在返回新bean之前被调用。因为我们没有初始化<code>foo</code>属性（尽管我们可以拥有），bean将包含其构造函数设置的任何默认值。</p>

    <p>您还将注意到，从应用程序开发人员的角度来看，资源环境引用的声明以及用于请求新实例的编程与用于<em>Generic JavaBean Resources</em>示例的方法相同。这说明了使用JNDI资源封装功能的优点之一-只要维护兼容的API，就可以更改基础实现，而不必使用这些资源修改应用程序。</p>

</div><div class="noprint"><h3 id="comments_section">评论</h3><div class="text"><p class="notice"><strong>注意：</strong>此注释部分收集有关改进Apache Tomcat文档的建议。<br><br>如果您遇到问题并需要帮助，请阅读“ <a href="https://tomcat.apache.org/findhelp.html">查找帮助”</a>页面，然后在tomcat-users <a href="https://tomcat.apache.org/lists.html">邮件列表中</a>询问您的问题。不要在这里问这样的问题。这不是“问答”部分。<br><br><a href="./comments.html">这里</a>解释<a href="./comments.html">了</a> Apache Comments System。如果评论已被实施或被认为无效/偏离主题，则我们的主持人可能会将其删除。
                  </p><div id="comments_thread"></div></div></div></div></div></div></div><footer><div id="footer">版权所有©1999-2019，Apache软件基金会</div></footer></div></body></html>