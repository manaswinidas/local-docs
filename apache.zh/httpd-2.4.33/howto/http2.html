<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>HTTP / 2指南-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP服务器</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> >操作方法<a href="./index.html">/教程</a></div><div id="page-content"><div id="preamble"><h1>HTTP / 2指南</h1>


    <p>这是Apache httpd中HTTP / 2实现的方法指南。此功能已<em>投入生产</em> ，您可以期望接口和指令保持一致的版本。
    </p>
  </div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#protocol">HTTP / 2协议</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#implementation">Apache httpd中的HTTP / 2</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#building">使用HTTP / 2支持构建httpd</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#basic-config">基本配置</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#clients">客户群</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#tools">调试HTTP / 2的有用工具</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#push">服务器推送</a></li>
</ul><h3>也可以看看</h3><ul class="seealso"><li><a href="../mod/mod_http2.html">mod_http2</a></li></ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="protocol" id="protocol">HTTP / 2协议</a></h2>
    
    <p>HTTP / 2是世界上最成功的应用程序层协议HTTP的演进。它专注于更有效地利用网络资源。它不会改变HTTP的基本原理，即语义。仍然有请求，响应，标头等等。因此，如果您已经知道HTTP / 1，那么您也知道95％的HTTP / 2。</p>
    <p>关于HTTP / 2及其工作原理的文章很多。当然，最规范的是其<a href="https://tools.ietf.org/html/rfc7540">RFC 7540</a> （ <a href="http://httpwg.org/specs/rfc7540.html">也以更易读的格式YMMV提供</a> ）。因此，您将在其中找到螺母和螺栓。</p>
    <p>但是，就像RFC一样，先阅读并不是一件好事。最好是先了解事情想要做，然后了解它是<em>如何</em>做的RFC <em>什么</em> 。<a href="https://daniel.haxx.se/http2/">http：//</a> <a href="https://curl.haxx.se">curl</a>的作者Daniel Stenberg <a href="https://daniel.haxx.se/http2/">解释</a>了一个更好的文档。它也以越来越多的语言提供！</p>
    <p>太长了，没看过：在阅读本文档时，需要牢记一些新的术语和陷阱：</p>
    <ul>
        <li>HTTP / 2是一种<strong>二进制协议</strong> ，与纯文本的HTTP 1.1相反。后者是人类可读的（例如，嗅探网络流量），而前者则不是。有关官方FAQ <a href="https://http2.github.io/faq/#why-is-http2-binary">问题</a>中的更多信息。</li>
        <li><strong>h2</strong>是TLS上的HTTP / 2（通过ALPN进行协议协商）。</li>
        <li><strong>h2c</strong>是TCP上的HTTP / 2。</li>
        <li><strong>帧</strong>是HTTP / 2连接中最小的通信单元，由标头和根据帧类型构造的八位字节的可变长度序列组成。有关更多信息，请参见官方文档<a href="http://httpwg.org/specs/rfc7540.html#FramingLayer">部分</a> 。</li>
        <li><strong>流</strong>是HTTP / 2连接内的双向帧流。HTTP 1.1中的对应概念是请求/响应消息交换。有关更多信息，请参见官方文档<a href="http://httpwg.org/specs/rfc7540.html#StreamsLayer">部分</a> 。</li>
        <li>HTTP / 2能够在同一个TCP连接上运行<strong>多个数据流</strong> ，避免了经典的HTTP 1.1头阻止缓慢的请求，并且避免了为每个请求/响应重新实例化TCP连接（KeepAlive修补了HTTP 1.1中的问题，但是做了尚未完全解决）。</li>
    </ul>
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="implementation" id="implementation">Apache httpd中的HTTP / 2</a></h2>
    
    <p>HTTP / 2协议由其自己的httpd模块（恰当地命名为<a href="../mod/mod_http2.html">mod_http2）实现</a> 。它实现了RFC 7540所描述的全部功能，并支持明文（http :)上的HTTP / 2，以及安全（https :)连接。明文变体名为“ <code>h2c</code> '，安全的一个' <code>h2</code> '。对于<code>h2c</code>它允许<em>直接</em>模式和<code>Upgrade:</code>通过初始HTTP / 1请求。</p>
    <p>为Web开发人员提供新功能的HTTP / 2功能之一是<a href="#push">Server Push</a> 。请参阅该部分以了解您的Web应用程序如何使用它。</p>
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="building" id="building">使用HTTP / 2支持构建httpd</a></h2>
    
    <p><a href="../mod/mod_http2.html">mod_http2</a>使用的库<a href="https://nghttp2.org">nghttp2</a>作为其实现的基础。为了建造<code>mod_http2</code>您至少需要1.2.1版<code>libnghttp2</code>安装在您的系统上。</p>
    <p>当你<code>./configure</code>您的Apache httpd源代码树，您需要给它“ <code>--enable-http2</code> '作为触发模块构建的附加参数。你应该<code>libnghttp2</code>驻留在不寻常的地方（无论操作系统上是什么），您都可以使用“ <code>--with-nghttp2=<path></code> ' 至<code>configure</code> 。</p>
    <p>尽管这对于大多数人来说应该可以解决问题，但他们还是更喜欢静态链接的人<code>nghttp2</code>在此模块中。对于那些，选项<code>--enable-nghttp2-staticlib-deps</code>存在。它的工作原理与将openssl静态链接到mod_ssl的方式非常相似。</p>
    <p>说到SSL，您需要意识到大多数浏览器只会在以下情况下使用HTTP / 2： <code>https:</code> URL，因此您需要具有SSL支持的服务器。不仅如此，您还需要一个支持以下内容的SSL库： <code>ALPN</code>延期。如果您使用的是OpenSSL库，则至少需要版本1.0.2。</p>
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="basic-config" id="basic-config">基本配置</a></h2>
    

    <p>当你有一个<code>httpd</code>内置<code>mod_http2</code>您需要一些基本配置使其生效。与每个Apache模块一样，第一件事是您需要加载它：</p>
    <pre class="prettyprint lang-config">LoadModule http2_module modules/mod_http2.so</pre>

    
    <p>您需要添加到服务器配置中的第二个指令是</p>
    <pre class="prettyprint lang-config">Protocols h2 http/1.1</pre>

    <p>这使安全变体h2成为服务器连接上的首选协议。要启用所有HTTP / 2变体时，只需编写：</p>
    <pre class="prettyprint lang-config">Protocols h2 h2c http/1.1</pre>

    <p>根据您放置此指令的位置，它会影响所有连接或仅影响到某个虚拟主机的连接。您可以将其嵌套，如下所示：</p>
    <pre class="prettyprint lang-config">Protocols http/1.1
&lt;VirtualHost ...&gt;
    ServerName test.example.org
    Protocols h2 http/1.1
&lt;/VirtualHost&gt;</pre>


    <p>这仅允许HTTP / 1连接，但SSL连接除外<code>test.example.org</code>提供HTTP / 2。</p>
    <div class="note"><h3>选择一个强大的SSLCipherSuite</h3>
     <p>的<code class="directive"><a href="../mod/mod_ssl.html#sslciphersuite">SSLCipherSuite</a></code>需要使用强大的TLS密码套件进行配置。当前版本的mod_http2不会实施任何密码，但是大多数客户端会这样做。将浏览器指向<code>h2</code>具有不正确密码套件的已启用服务器将迫使其简单地拒绝并退回到HTTP 1.1。这是第一次为HTTP / 2配置httpd时常犯的错误，因此请记住这一点，以避免长时间的调试会话！如果要确定要选择的密码套件，请避免使用<a href="http://httpwg.org/specs/rfc7540.html#BadCipherSuites">HTTP / 2 TLS黑名单中</a>列出的密码套件。</p>
    </div>
    <p>提到的协议顺序也很重要。默认情况下，第一个是最喜欢的协议。当客户提供多个选择时，将选择最左侧的一个。在</p>
    <pre class="prettyprint lang-config">Protocols http/1.1 h2</pre>

    <p>最优选的协议是HTTP / 1，除非客户端<em>仅</em>支持h2，否则它将始终被选择。由于我们想与支持HTTP / 2的客户端对话，因此更好的顺序是</p>
    <pre class="prettyprint lang-config">Protocols h2 h2c http/1.1</pre>


    <p>订购还有另外一件事：客户也有自己的偏好。如果需要，可以将服务器配置为选择客户端最喜欢的协议：</p>
    <pre class="prettyprint lang-config">ProtocolsHonorOrder Off</pre>

    <p>使<em>您</em>编写协议的订单无关紧要，只有客户的订单才能确定。</p>
    <p>最后一件事：不检查您配置的协议的正确性或拼写。您可以提及不存在的协议，因此无需警惕<code>Protocols</code>与任何<code>IfModule</code>检查。</p>
    <p>有关配置的更多高级技巧，请参阅<a href="../mod/mod_http2.html#dimensioning">有关尺寸标注</a>以及<a href="../mod/mod_http2.html#misdirected">如何使用同一证书管理多个主机</a>的<a href="../mod/mod_http2.html#dimensioning">模块部分</a> 。</p>
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="clients" id="clients">客户群</a></h2>
    
    <p>几乎所有现代浏览器都支持HTTP / 2，但仅通过SSL连接：Firefox（v43），Chrome（v45），Safari（自v9），iOS Safari（v9），Opera（v35），Chrome for Android（v49）和Internet资源管理器（Windows10上为v11）（ <a href="http://caniuse.com/#search=http2">源</a> ）。</p>
    <p>其他客户端以及服务器<a href="https://github.com/http2/http2-spec/wiki/Implementations">在“实现” Wiki</a>上列出，其中包括c，c ++，common lisp，dart，erlang，haskell，java，nodejs，php，python，perl，ruby，rust，scala和swift的实现。</p>
    <p>一些非浏览器客户端实现通过明文h2c支持HTTP / 2。最通用的是<a href="https://curl.haxx.se">卷曲</a> 。</p>
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="tools" id="tools">调试HTTP / 2的有用工具</a></h2>
    
    <p>首先要提到的工具当然是<a href="https://curl.haxx.se">curl</a> 。请确保您的版本支持HTTP / 2，并检查其<code>Features</code> ：</p>
    <pre class="prettyprint lang-config">    $ curl -V
    curl 7.45.0 (x86_64-apple-darwin15.0.0) libcurl/7.45.0 OpenSSL/1.0.2d zlib/1.2.8 nghttp2/1.3.4
    Protocols: dict file ftp ftps gopher http https imap imaps ldap ldaps pop3 [...] 
    Features: IPv6 Largefile NTLM NTLM_WB SSL libz TLS-SRP <strong>HTTP2</strong>
    </pre>

    <div class="note"><h3>Mac OS自制笔记</h3>brew安装curl --with-openssl --with-nghttp2</div>
    <p>而对于真正深入检查<a href="https://wiki.wireshark.org/HTTP2">Wireshark的</a> 。</p>
    <p><a href="https://nghttp2.org">nghttp2</a>软件包还包括客户端，例如：</p>
    <ul>
        <li><a href="https://nghttp2.org/documentation/nghttp.1.html">nghttp-</a>用于可视化HTTP / 2框架并更好地了解协议。</li>
        <li><a href="https://nghttp2.org/documentation/h2load-howto.html">h2load-</a>对服务器进行压力测试很有用。</li>
    </ul>
    <p>Chrome浏览器通过<a href="javascript:void(0);">特殊的net-internals页面</a>提供详细的HTTP / 2日志。<a href="https://chrome.google.com/webstore/detail/http2-and-spdy-indicator/mpbpobfflnpcgagjijhmgnchggcjblin?hl=en">Chrome</a>和<a href="https://addons.mozilla.org/en-us/firefox/addon/spdy-indicator/">Firefox</a>还有一个有趣的扩展，可以在您的浏览器使用HTTP / 2时可视化。</p>
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="push" id="push">服务器推送</a></h2>
    
    <p>HTTP / 2协议允许服务器向从未要求的客户端推送响应。对话的基调是：“这里有一个您从未发送过的请求，对此的响应将很快到达……”</p>
    <p>但是有一些限制：客户端可以禁用此功能，并且服务器只能对来自客户端的请求进行推送。</p>
    <p>目的是允许服务器向最可能需要的客户端发送资源：属于客户端请求的html页面的css或javascript资源。css等引用的一组图像。</p>
    <p>客户端的优势在于，它节省了发送请求的时间，该时间可能从几毫秒到半秒不等，具体取决于两者的位置。缺点是，客户端可能会收到缓存中已拥有的东西。当然，HTTP / 2允许尽早取消此类请求，但是仍然浪费了资源。</p>
    <p>总结一下：关于如何最好地利用HTTP / 2的这一功能，没有一个好的策略，并且每个人都还在试验。因此，您如何在Apache httpd中进行实验？</p>
    <p><code>mod_http2</code>检查响应头是否<code>Link</code>标头采用某种格式：</p>
    <pre class="prettyprint lang-config">Link &lt;/xxx.css&gt;;rel=preload, &lt;/xxx.js&gt;; rel=preload</pre>

    <p>如果连接支持PUSH，则这两个资源将发送到客户端。作为Web开发人员，您可以直接在应用程序响应中设置这些标头，也可以通过以下方式配置服务器</p>
    <pre class="prettyprint lang-config">&lt;Location /xxx.html&gt;
    Header add Link "&lt;/xxx.css&gt;;rel=preload"
    Header add Link "&lt;/xxx.js&gt;;rel=preload"
&lt;/Location&gt;</pre>

    <p>如果要使用<code>preload</code>链接而无需触发按钮，则可以使用<code>nopush</code>参数，如</p>
    <pre class="prettyprint lang-config">Link &lt;/xxx.css&gt;;rel=preload;nopush</pre>

    <p>或者您可以完全通过指令为服务器禁用PUSH</p>
    <pre class="prettyprint lang-config">H2Push Off</pre>

    <p>还有更多：</p>
    <p>该模块将记录每个连接已推送的日志（基本上是URL哈希），并且不会将相同的资源推送两次。连接关闭时，该信息将被丢弃。</p>
    <p>有人在考虑客户端如何告诉服务器已经拥有的服务器，因此可以避免对这些服务器进行推销，但是目前这都是高度试验性的。</p>
    <p>另一个实验草案已在<code>mod_http2</code>是“ <a href="https://tools.ietf.org/html/draft-ruellan-http-accept-push-policy-00">接受-推-策略”标头字段</a> ，客户可以在其中为每个请求定义其接受哪种类型的PUSH。</p>
  </div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>