<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>Apache教程：使用CGI的动态内容-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP服务器</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> >操作方法<a href="./index.html">/教程</a></div><div id="page-content"><div id="preamble"><h1>Apache教程：使用CGI的动态内容</h1>

</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#intro">介绍</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#configuring">配置Apache以允许CGI</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#writing">编写CGI程序</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#troubleshoot">但是仍然无法正常工作！</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#behindscenes">幕后发生了什么事？</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#libraries">CGI模块/库</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#moreinfo">想要查询更多的信息</a></li>
</ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="intro" id="intro">介绍</a></h2>
    

    <table class="related"><tbody><tr><th>相关模块</th><th>相关指令</th></tr><tr><td><ul><li><code class="module"><a href="../mod/mod_alias.html">mod_alias</a></code></li><li><code class="module"><a href="../mod/mod_cgi.html">mod_cgi</a></code></li><li><code class="module"><a href="../mod/mod_cgid.html">mod_cgid</a></code></li></ul></td><td><ul><li><code class="directive"><a href="../mod/mod_mime.html#addhandler">AddHandler</a></code></li><li><code class="directive"><a href="../mod/core.html#options">Options</a></code></li><li><code class="directive"><a href="../mod/mod_alias.html#scriptalias">ScriptAlias</a></code></li></ul></td></tr></tbody></table>

    <p>CGI（通用网关接口）为Web服务器定义了一种与外部内容生成程序进行交互的方式，这些程序通常称为CGI程序或CGI脚本。这是一种使用最熟悉的编程语言将动态内容放置在您的网站上的简单方法。本文档将介绍如何在Apache Web服务器上设置CGI，以及如何开始编写CGI程序。</p>
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="configuring" id="configuring">配置Apache以允许CGI</a></h2>
    

    <p>为了使CGI程序正常工作，您需要将Apache配置为允许CGI执行。有几种方法可以做到这一点。</p>

    <div class="warning">注意：如果Apache是使用共享模块支持构建的，则需要确保已加载该模块；否则，请确保已加载。在你的<code>httpd.conf</code>您需要确保<code class="directive"><a href="../mod/mod_so.html#loadmodule">LoadModule</a></code>指令尚未被注释掉。正确配置的指令可能如下所示：<pre class="prettyprint lang-config">LoadModule cgid_module modules/mod_cgid.so</pre>在Windows上，或使用非线程MPM（如prefork），正确配置的指令可能如下所示：<pre class="prettyprint lang-config">LoadModule cgi_module modules/mod_cgi.so</pre>
</div>


    <h3><a name="scriptalias" id="scriptalias">脚本别名</a></h3>
      

      <p>的<code class="directive"><a href="../mod/mod_alias.html#scriptalias">ScriptAlias</a></code>指令告诉Apache为CGI程序预留了一个特定目录。Apache将假定此目录中的每个文件都是CGI程序，并在客户端请求该特定资源时尝试执行该文件。</p>

      <p>的<code class="directive"><a href="../mod/mod_alias.html#scriptalias">ScriptAlias</a></code>指令看起来像：</p>

      <pre class="prettyprint lang-config">ScriptAlias "/cgi-bin/" "/usr/local/apache2/cgi-bin/"</pre>


      <p>显示的示例来自默认<code>httpd.conf</code>配置文件（如果您在默认位置安装了Apache）。的<code class="directive"><a href="../mod/mod_alias.html#scriptalias">ScriptAlias</a></code>指令很像<code class="directive"><a href="../mod/mod_alias.html#alias">Alias</a></code>指令，它定义要映射到特定目录的URL前缀。<code class="directive">Alias</code>和<code class="directive">ScriptAlias</code>通常用于目录之外的目录<code class="directive"><a href="../mod/core.html#documentroot">DocumentRoot</a></code>目录。和...之间的不同<code class="directive">Alias</code>和<code class="directive">ScriptAlias</code>就是它<code class="directive">ScriptAlias</code>具有附加含义，即该URL前缀下的所有内容都将被视为CGI程序。因此，以上示例告诉Apache对资源的任何请求都以<code>/cgi-bin/</code>应该从目录中提供<code>/usr/local/apache2/cgi-bin/</code> ，应视为CGI程序。</p>

      <p>例如，如果网址<code>http://www.example.com/cgi-bin/test.pl</code>被请求，Apache将尝试执行该文件<code>/usr/local/apache2/cgi-bin/test.pl</code>并返回输出。当然，该文件必须存在并且可以执行，并以特定方式返回输出，否则Apache将返回错误消息。</p>
    

    <h3><a name="nonscriptalias" id="nonscriptalias">ScriptAlias目录之外的CGI</a></h3>
      

      <p>CGI程序通常仅限于<code class="directive"><a href="../mod/mod_alias.html#scriptalias">ScriptAlias</a></code>出于安全原因而创建的目录。这样，管理员可以严格控制允许谁使用CGI程序。但是，如果采取了适当的安全预防措施，则没有理由不能从任意目录运行CGI程序。例如，您可能希望让用户使用其主目录中的主页来拥有Web内容。 <code class="directive"><a href="../mod/mod_userdir.html#userdir">UserDir</a></code>指示。如果他们想拥有自己的CGI程序，但无权访问主程序<code>cgi-bin</code>目录，他们将需要能够在其他地方运行CGI程序。</p>

      <p>允许在任意目录中执行CGI有两个步骤。首先， <code>cgi-script</code>处理程序必须使用<code class="directive"><a href="../mod/mod_mime.html#addhandler">AddHandler</a></code>要么<code class="directive"><a href="../mod/core.html#sethandler">SetHandler</a></code>指示。第二， <code>ExecCGI</code>必须在<code class="directive"><a href="../mod/core.html#options">Options</a></code>指示。</p>
    

    <h3><a name="options" id="options">明确使用选项来允许CGI执行</a></h3>
      

      <p>您可以显式使用<code class="directive"><a href="../mod/core.html#options">Options</a></code>指令，在主服务器配置文件中，用于指定允许在特定目录中执行CGI：</p>

      <pre class="prettyprint lang-config">&lt;Directory "/usr/local/apache2/htdocs/somedir"&gt;
    Options +ExecCGI
&lt;/Directory&gt;</pre>


      <p>上面的指令告诉Apache允许执行CGI文件。您还需要告诉服务器哪些文件是CGI文件。下列<code class="directive"><a href="../mod/mod_mime.html#addhandler">AddHandler</a></code>指令告诉服务器将所有文件与<code>cgi</code>要么<code>pl</code>作为CGI程序的扩展：</p>

      <pre class="prettyprint lang-config">AddHandler cgi-script .cgi .pl</pre>

    

    <h3><a name="htaccess" id="htaccess">.htaccess文件</a></h3>
      

      <p>的<a href="htaccess.html"><code>.htaccess</code>本教程</a>显示了如果您无权访问如何激活CGI程序<code>httpd.conf</code> 。</p>
    

    <h3><a name="userdir" id="userdir">用户目录</a></h3>
      

      <p>允许CGI程序执行以结尾的任何文件<code>.cgi</code>在用户目录中，可以使用以下配置。</p>

      <pre class="prettyprint lang-config">&lt;Directory "/home/*/public_html"&gt;
    Options +ExecCGI
    AddHandler cgi-script .cgi
&lt;/Directory&gt;</pre>


      <p>如果您希望指定一个<code>cgi-bin</code>用户目录的子目录，所有内容都将被视为CGI程序，您可以使用以下命令。</p>

      <pre class="prettyprint lang-config">&lt;Directory "/home/*/public_html/cgi-bin"&gt;
    Options ExecCGI
    SetHandler cgi-script
&lt;/Directory&gt;</pre>


    

  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="writing" id="writing">编写CGI程序</a></h2>
    

    <p>``常规''编程和CGI编程之间有两个主要区别。</p>

    <p>首先，您CGI程序的所有输出必须在<a class="glossarylink" href="../glossary.html#mime-type" title="见词汇">MIME类型</a>标头之前。这是HTTP标头，告诉客户端它正在接收哪种内容。大多数时候，这看起来像：</p>

    <div class="example"><p><code>Content-type: text/html</code></p></div>

    <p>其次，您的输出必须为HTML或浏览器将能够显示的其他格式。在大多数情况下，这将是HTML，但是有时您可能会编写一个CGI程序来输出gif图像或其他非HTML内容。</p>

    <p>除了这两点之外，编写CGI程序看起来与您可能编写的任何其他程序非常相似。</p>

    <h3><a name="firstcgi" id="firstcgi">您的第一个CGI程序</a></h3>
      

      <p>以下是一个示例CGI程序，该程序将一行输出到您的浏览器。输入以下内容，将其保存到名为<code>first.pl</code> ，并将其放入您的<code>cgi-bin</code>目录。</p>

      <pre class="prettyprint lang-perl">#!/usr/bin/perl
print "Content-type: text/html\n\n";
print "Hello, World.";</pre>


      <p>即使您不熟悉Perl，您也应该能够看到这里发生的情况。第一行告诉Apache（或您碰巧在其下运行的任何Shell）可以通过将文件提供给该位置的解释器来执行该程序。 <code>/usr/bin/perl</code> 。第二行显示我们所讨论的内容类型声明，其后是两个回车换行符。这会在标头之后放置一个空白行，以指示HTTP标头的结尾和正文的开头。第三行显示字符串“ Hello，World”。到此为止。</p>

      <p>如果您打开喜欢的浏览器并告诉它获取地址</p>

      <div class="example"><p><code>http://www.example.com/cgi-bin/first.pl</code></p></div>

      <p>或将文件放在任何位置，您都会看到一行<code>Hello, World.</code>出现在您的浏览器窗口中。这不是很令人兴奋，但是一旦您能够正常工作，您就有很大的机会让几乎所有的东西都能正常工作。</p>
    
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="troubleshoot" id="troubleshoot">但是仍然无法正常工作！</a></h2>
    

    <p>当您尝试从网络访问CGI程序时，可能会在浏览器中看到以下四个基本信息：</p>

    <dl>
      <dt>您的CGI程序的输出</dt>
      <dd>大！这意味着一切正常。如果输出正确，但是浏览器未正确处理，请确保输入正确<code>Content-Type</code>在您的CGI程序中设置。</dd>

      <dt>您的CGI程序的源代码或“不允许使用POST方法”消息</dt>
      <dd>这意味着您没有正确配置Apache以处理您的CGI程序。重读有关<a href="#configuring">配置Apache</a>的部分，然后尝试查找您错过的内容。</dd>

      <dt>以“禁止”开头的消息</dt>
      <dd>这意味着存在权限问题。检查<a href="#errorlogs">Apache错误日志</a>和下面有关<a href="#permissions">文件权限</a>的部分。</dd>

      <dt>一条消息，指出“内部服务器错误”</dt>
      <dd>如果检查<a href="#errorlogs">Apache错误日志</a> ，则可能会发现它显示“脚本头过早结束”，以及CGI程序生成的错误消息。在这种情况下，您将需要检查以下每个部分，以查看可能阻止CGI程序发出正确的HTTP标头的原因。</dd>
    </dl>

    <h3><a name="permissions" id="permissions">档案权限</a></h3>
      

      <p>请记住，服务器不会像您那样运行。也就是说，当服务器启动时，它正在以非特权用户的权限运行-通常<code>nobody</code> ， 要么<code>www</code> -因此，它需要额外的权限才能执行您拥有的文件。通常，授予文件足够权限以执行以下操作的方法： <code>nobody</code>是授予所有人对该文件的执行权限：</p>

      <div class="example"><p><code>chmod a+x first.pl</code></p></div>

      <p>另外，如果您的程序读取或写入任何其他文件，则这些文件将需要具有正确的权限才能允许此操作。</p>

    

    <h3><a name="pathinformation" id="pathinformation">路径信息和环境</a></h3>
      

      <p>当您从命令行运行程序时，无需考虑就可以将某些信息传递给外壳。例如，您有一个<code>PATH</code> ，它告诉Shell在哪里可以找到您引用的文件。</p>

      <p>当程序作为CGI程序通过Web服务器运行时，它可能没有相同的名称<code>PATH</code> 。您在CGI程序中调用的任何程序（例如<code>sendmail</code> （例如）将需要由完整路径指定，以便外壳程序在尝试执行CGI程序时可以找到它们。</p>

      <p>脚本解释器（通常是<code>perl</code> ）显示在您的CGI程序的第一行中，如下所示：</p>

      <pre class="prettyprint lang-perl">#!/usr/bin/perl</pre>


      <p>确保实际上这是解释器的路径。</p>
      <div class="warning">在Windows上编辑CGI脚本时，行尾字符可能会附加到解释器路径。确保随后将文件以ASCII模式传输到服务器。否则，由于无法识别的行尾字符将被解释为解释器文件名的一部分，因此可能会导致操作系统发出“找不到命令”警告。
      </div>
    

    <h3><a name="missingenv" id="missingenv">缺少环境变量</a></h3>
      

      <p>如果您的CGI程序依赖于非标准<a href="#env">环境变量</a> ，则需要确保这些变量由Apache传递。</p>

      <p>当您错过环境中的HTTP标头时，请确保它们按照<a href="http://tools.ietf.org/html/rfc2616">RFC 2616</a>第4.2节的格式设置：标头名称必须以字母开头，之后只能是字母，数字或连字符。任何违反此规则的标头都将被静默删除。</p>

    

    <h3><a name="syntaxerrors" id="syntaxerrors">程式错误</a></h3>
      

      <p>大多数时候，CGI程序失败是由于程序本身存在问题。一旦掌握了CGI的知识，并且不再犯上述两个错误，就尤其如此。首先要做的是确保在通过Web服务器测试程序之前，从命令行运行程序。例如，尝试：</p>

      <div class="example"><p><code>cd /usr/local/apache2/cgi-bin<br> ./first.pl</code></p></div>

      <p>（请勿致电<code>perl</code>口译员。Shell和Apache应该使用脚本第一行中的<a href="#pathinformation">路径信息</a>来找到解释器。）</p>

      <p>您看到的由程序编写的第一件事应该是一组HTTP标头，包括<code>Content-Type</code> ，后跟空白行。如果看到其他内容，Apache将返回<code>Premature end of script headers</code>如果您尝试通过服务器运行它，则会出现错误。有关更多详细信息，请参见上面的<a href="#writing">编写CGI程序</a> 。</p>
    

    <h3><a name="errorlogs" id="errorlogs">错误日志</a></h3>
      

      <p>错误日志是您的朋友。发生任何错误都会在错误日志中生成消息。您应该始终先查看那里。如果您托管网站的位置不允许您访问错误日志，则可能应该将网站托管在其他位置。学习阅读错误日志，您会发现几乎所有问题都得到了快速识别和快速解决。</p>
    

    <h3><a name="suexec" id="suexec">苏执行</a></h3>
      

      <p><a href="../suexec.html">suexec</a>支持程序允许CGI程序在不同的用户权限下运行，具体取决于它们位于哪个虚拟主机或用户主目录中。Suexec具有非常严格的权限检查，如果检查失败，将导致您的CGI程序失败并<code>Premature end of script headers</code> 。</p>

      <p>要检查您是否正在使用suexec，请运行<code>apachectl -V</code>并检查位置<code>SUEXEC_BIN</code> 。如果Apache找到一个<code class="program"><a href="../programs/suexec.html">suexec</a></code>二进制文件在启动时启动，suexec将被激活。</p>

      <p>除非您完全了解suexec，否则不应该使用它。要禁用suexec，只需删除（或重命名） <code class="program"><a href="../programs/suexec.html">suexec</a></code>指向的二进制文件<code>SUEXEC_BIN</code>然后重新启动服务器。如果在阅读了<a href="../suexec.html">suexec之后</a> ，您仍然希望使用它，请运行<code>suexec -V</code>查找suexec日志文件的位置，并使用该日志文件查找您违反的策略。</p>
    
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="behindscenes" id="behindscenes">幕后发生了什么事？</a></h2>
    

    <p>随着CGI编程的发展，您将对了解幕后发生的事情变得很有用。具体来说，浏览器和服务器之间如何通信。因为尽管编写一个打印“ Hello，World。”的程序非常好，但是它并不是特别有用。</p>

    <h3><a name="env" id="env">环境变量</a></h3>
      

      <p>环境变量是在您使用计算机时在您周围浮动的值。它们是有用的东西，例如您的路径（当您键入命令时，计算机将在其中搜索实际文件以执行命令），用户名，终端类型等等。有关日常的日常环境变量的完整列表，请键入<code>env</code>在命令提示符下。</p>

      <p>在CGI事务期间，服务器和浏览器还会设置环境变量，以便它们可以相互通信。这些是诸如浏览器类型（Netscape，IE，Lynx），服务器类型（Apache，IIS，WebSite），正在运行的CGI程序的名称之类的东西。</p>

      <p>这些变量可供CGI程序员使用，并且只是客户端与服务器之间通讯的一半。所需变量的完整列表位于<a href="http://www.ietf.org/rfc/rfc3875">Common Gateway Interface RFC</a> 。</p>

      <p>这个简单的Perl CGI程序将显示所有正在传递的环境变量。两个相似的程序包含在<code>cgi-bin</code> Apache发行版的目录。请注意，某些变量是必需的，而其他变量是可选的，因此您可能会看到其中列出的一些不在正式列表中的变量。此外，Apache提供了许多不同的方法来<a href="../env.html">将您自己的环境变量添加</a>到默认提供的基本<a href="../env.html">变量</a>中。</p>

      <pre class="prettyprint lang-perl">#!/usr/bin/perl
use strict;
use warnings;

print "Content-type: text/html\n\n";
foreach my $key (keys %ENV) {
    print "$key --&gt; $ENV{$key}&lt;br&gt;";
}</pre>

    

    <h3><a name="stdin" id="stdin">STDIN和STDOUT</a></h3>
      

      <p>服务器和客户端之间的其他通信是通过标准输入（ <code>STDIN</code> ）和标准输出（ <code>STDOUT</code> ）。在正常的日常情况下， <code>STDIN</code>表示键盘或程序可以执行的文件，并且<code>STDOUT</code>通常是指控制台或屏幕。</p>

      <p>当你<code>POST</code> Web表单到CGI程序，该表单中的数据被捆绑成一种特殊格式，并通过<code>STDIN</code> 。然后，程序可以像处理来自键盘或文件的数据一样处理该数据。</p>

      <p>“特殊格式”非常简单。字段名称及其值用等号（=）连接在一起，值对使用＆符连接在一起。不方便的字符（例如空格，＆符和等号）将转换为等效的十六进制，以免影响作品。整个数据字符串可能类似于：</p>

      <div class="example"><p><code>name=Rich%20Bowen&city=Lexington&state=KY&sidekick=Squirrel%20Monkey</code></p></div>

      <p>有时您还会看到将这种类型的字符串附加到URL。完成后，服务器将该字符串放入称为的环境变量中<code>QUERY_STRING</code> 。那叫做<code>GET</code>请求。您的HTML表单指定了<code>GET</code>或一个<code>POST</code>通过设置<code>METHOD</code>中的属性<code>FORM</code>标签。</p>

      <p>然后，您的程序负责将该字符串拆分为有用的信息。幸运的是，有一些库和模块可用来帮助您处理这些数据以及处理CGI程序的其他方面。</p>
    
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="libraries" id="libraries">CGI模块/库</a></h2>
    

    <p>编写CGI程序时，应考虑使用代码库或模块来完成大部分繁琐的工作。这样可以减少错误，加快开发速度。</p>

    <p>如果您在Perl中编写CGI程序，则可以在<a href="http://www.cpan.org/">CPAN</a>上使用模块。为此，最受欢迎的模块是<code>CGI.pm</code> 。您可能还会考虑<code>CGI::Lite</code> ，它实现了最少的功能集，这是大多数程序中所需要的。</p>

    <p>如果您使用C编写CGI程序，则有多种选择。其中之一是<code>CGIC</code>库， <a href="http://www.boutell.com/cgic/">网址</a>为<a href="http://www.boutell.com/cgic/">http://www.boutell.com/cgic/</a> 。</p>
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="moreinfo" id="moreinfo">想要查询更多的信息</a></h2>
    

    <p>当前的CGI规范在<a href="http://www.ietf.org/rfc/rfc3875">通用网关接口RFC中</a>可用。</p>

    <p>当您将有关CGI问题的问题发布到邮件列表或新闻组时，请确保您提供了有关发生的情况，预期发生的情况以及实际发生的情况有所不同的足够信息，您正在运行的服务器，您的CGI程序使用的语言以及（如果可能）有问题的代码。这将使查找问题变得更加简单。</p>

    <p>请注意，除非您确定在Apache源代码中发现了问题，否则<strong>切勿</strong>将有关CGI问题的问题发布到Apache错误数据库中。</p>
  </div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>