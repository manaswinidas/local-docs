<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>反向代理指南-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP服务器</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> >操作方法<a href="./index.html">/教程</a></div><div id="page-content"><div id="preamble"><h1>反向代理指南</h1>


    <p>除了作为“基本” Web服务器并向最终用户提供静态和动态内容之外，Apache httpd（以及大多数其他Web服务器）还可以充当反向代理服务器，也称为“网关”服务器。</p>

    <p>在这种情况下，httpd本身不会生成或托管数据，而是通过一台或几台后端服务器获得内容，这些服务器通常没有与外部网络的直接连接。当httpd收到来自客户端的请求时，该请求本身将被<em>代理</em>到这些后端服务器之一，然后由该后端服务器处理该请求，生成内容，然后将该内容发送回httpd，然后再将实际的HTTP响应生成回客户端。</p>

    <p>这种实现有很多原因，但是通常典型的理由是由于安全性，高可用性，负载平衡和集中式身份验证/授权。在这些实现中，至关重要的是后端基础结构（那些实际处理请求的服务器）的布局，设计和体系结构必须与外界隔离并受到保护；就客户端而言，反向代理服务器<em>是</em>所有内容的唯一来源。</p>

    <p>典型的实现如下：</p>
    <p class="centered"><img src="../images/reverse-proxy-arch.png" alt="反向代理拱"></p>

  </div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#related">反向代理</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#simple">简单的反向代理</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#cluster">集群和均衡器</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#config">平衡器和BalancerMember配置</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#failover">故障转移</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#manager">平衡经理</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#health-check">动态健康检查</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#status">平衡器成员状态标志</a></li>
</ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="related" id="related">反向代理</a></h2>
  
  <table class="related"><tbody><tr><th>相关模块</th><th>相关指令</th></tr><tr><td><ul><li><code class="module"><a href="../mod/mod_proxy.html">mod_proxy</a></code></li><li><code class="module"><a href="../mod/mod_proxy_balancer.html">mod_proxy_balancer</a></code></li><li><code class="module"><a href="../mod/mod_proxy_hcheck.html">mod_proxy_hcheck</a></code></li></ul></td><td><ul><li><code class="directive"><a href="../mod/mod_proxy.html#proxypass">ProxyPass</a></code></li><li><code class="directive"><a href="../mod/mod_proxy.html#balancermember">BalancerMember</a></code></li></ul></td></tr></tbody></table>
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="simple" id="simple">简单的反向代理</a></h2>
    

    <p>的<code class="directive"><a href="../mod/mod_proxy.html#proxypass">ProxyPass</a></code>伪指令指定传入请求到后端服务器（或称为a的服务器集群）的映射<code>Balancer</code>组）。最简单的示例代理所有请求（ <code>"/"</code> ）到单个后端：</p>

    <pre class="prettyprint lang-config">ProxyPass "/"  "http://www.example.com/"</pre>


    <p>为了确保和<code>Location:</code>从后端生成的标头被修改为指向反向代理，而不是返回自身。 <code class="directive"><a href="../mod/mod_proxy.html#proxypassreverse">ProxyPassReverse</a></code>指令最常需要：</p>

    <pre class="prettyprint lang-config">ProxyPass "/"  "http://www.example.com/"
ProxyPassReverse "/"  "http://www.example.com/"</pre>


    <p>只能代理特定的URI，如以下示例所示：</p>

    <pre class="prettyprint lang-config">ProxyPass "/images"  "http://www.example.com/"
ProxyPassReverse "/images"  "http://www.example.com/"</pre>


    <p>在上面，所有以<code>/images</code>被代理到指定后端的路径，否则将在本地处理。
    </p>
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="cluster" id="cluster">集群和均衡器</a></h2>
    

    <p>如上所述，它仍然有用，但仍然存在缺陷，即（单个）后端节点出现故障或负载沉重时，代理这些请求不会提供任何真正的优势。所需要的是能够定义一组或一组后端服务器，这些后端服务器可以处理此类请求，并使反向代理在其中进行负载平衡和故障转移。该组有时称为<em>集群，</em>但是Apache httpd的术语是<em>balancer</em> 。一个人通过利用<code class="directive"><a href="../mod/mod_proxy.html#proxy"><Proxy></a></code>和<code class="directive"><a href="../mod/mod_proxy.html#balancermember">BalancerMember</a></code>指令如下所示：</p>

    <pre class="prettyprint lang-config">&lt;Proxy balancer://myset&gt;
    BalancerMember http://www2.example.com:8080
    BalancerMember http://www3.example.com:8080
    ProxySet lbmethod=bytraffic
&lt;/Proxy&gt;

ProxyPass "/images/"  "balancer://myset/"
ProxyPassReverse "/images/"  "balancer://myset/"</pre>


    <p>的<code>balancer://</code> scheme告诉httpd我们正在创建一个名为<em>myset</em>的平衡器集。它包括2个后端服务器，httpd称为<em>BalancerMembers</em> 。在这种情况下， <code>/images</code>将被代理到2和后端<em>之一</em> 。的<code class="directive"><a href="../mod/mod_proxy.html#proxyset">ProxySet</a></code>指令指定<em>myset</em> Balancer使用基于I / O字节进行平衡的负载平衡算法。
    </p>

    <div class="note"><h3>暗示</h3>
      <p>
      	<em>平衡器</em>成员有时也称为<em>工作者</em> 。
      </p>
   </div>

  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="config" id="config">平衡器和BalancerMember配置</a></h2>
    

    <p>您可以通过在中定义的各种参数来调整<em>平衡器</em>和<em>工人的</em>许多配置细节。 <code class="directive"><a href="../mod/mod_proxy.html#proxypass">ProxyPass</a></code> 。例如，假设我们想要<code>http://www3.example.com:8080</code>为了处理3倍的流量（超时时间为1秒），我们将调整配置如下：</p>

    <pre class="prettyprint lang-config">&lt;Proxy balancer://myset&gt;
    BalancerMember http://www2.example.com:8080
    BalancerMember http://www3.example.com:8080 loadfactor=3 timeout=1
    ProxySet lbmethod=bytraffic
&lt;/Proxy&gt;

ProxyPass "/images"  "balancer://myset/"
ProxyPassReverse "/images"  "balancer://myset/"</pre>


  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="failover" id="failover">故障转移</a></h2>
    

    <p>您还可以微调各种故障转移方案，详细说明在这种情况下应使用哪些工作人员，甚至应使用哪些平衡器。例如，以下设置实现了2种故障转移情况：在第一种情况下， <code>http://hstandby.example.com:8080</code>仅当<em>myset</em>平衡器中的所有其他工作器都不可用时，才发送流量。如果该工作人员本身不可用，则只有<code>http://bkup1.example.com:8080</code>和<code>http://bkup2.example.com:8080</code>工人轮换：</p>

    <pre class="prettyprint lang-config">&lt;Proxy balancer://myset&gt;
    BalancerMember http://www2.example.com:8080
    BalancerMember http://www3.example.com:8080 loadfactor=3 timeout=1
    BalancerMember http://hstandby.example.com:8080 status=+H
    BalancerMember http://bkup1.example.com:8080 lbset=1
    BalancerMember http://bkup2.example.com:8080 lbset=1
    ProxySet lbmethod=byrequests
&lt;/Proxy&gt;

ProxyPass "/images/"  "balancer://myset/"
ProxyPassReverse "/images/"  "balancer://myset/"</pre>


    <p>故障转移设置的魔力在于设定<code>http://hstandby.example.com:8080</code>与<code>+H</code>状态标志，将其置于<em>热备用</em>模式，并设置2 <code>bkup#</code> ＃1负载平衡器集的服务器部分（默认集为0）；对于故障转移，当所有常规工作线程都不可用时，首先使用热备用（如果存在）。总是首先尝试使用最低数量的负载均衡器集。
    </p>

  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="manager" id="manager">平衡经理</a></h2>
    

    <p>嵌入式<em>平衡器-管理器</em>应用程序是Apache httpd反向代理最独特和有用的功能之一。相似<code class="module"><a href="../mod/mod_status.html">mod_status</a></code> ， <em>balancer-manager</em>显示当前正在使用的平衡器和工作程序的工作配置以及状态。但是，它不仅可以显示这些参数，还可以对几乎所有参数进行动态，运行时，即时的重新配置，包括将新的<em>BalancerMembers</em> （工人）添加到现有的<em>Balancer中</em> 。要启用这些功能，需要在配置中添加以下内容：</p>

    <pre class="prettyprint lang-config">&lt;Location "/balancer-manager"&gt;
    SetHandler balancer-manager
    Require host localhost
&lt;/Location&gt;</pre>


    <div class="warning"><h3>警告</h3>
      <p>在<a href="../mod/mod_proxy.html#access">确保服务器安全</a>之前，请勿启用<em>平衡器管理器</em> 。特别是，请确保严格限制对URL的访问。</p>
    </div>

    <p>在该URL访问反向代理服务器时（例如： <code>http://rproxy.example.com/balancer-manager/</code> ，您将看到类似于以下内容的页面：</p>
    <p class="centered"><img src="../images/bal-man.png" alt="平衡器管理器页面"></p>

    <p>该表格允许devops管理员调整各种参数，使工作人员脱机，更改负载平衡方法并添加新作品。例如，单击平衡器本身，您将获得以下页面：</p>
    <p class="centered"><img src="../images/bal-man-b.png" alt="平衡器管理器页面"></p>

    <p>而单击工作人员，则显示此页面：</p>
    <p class="centered"><img src="../images/bal-man-w.png" alt="平衡器管理器页面"></p>

    <p>要使这些更改持续反向代理的重启，请确保<code class="directive"><a href="../mod/mod_proxy.html#balancerpersist">BalancerPersist</a></code>已启用。
    </p>

  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="health-check" id="health-check">动态健康检查</a></h2>
    

    <p>在httpd向工作人员代理请求之前，它可以通过设置httpd来<em>“测试”</em>该工作人员是否可用<code>ping</code>该工人使用的参数<code class="directive"><a href="../mod/mod_proxy.html#proxypass">ProxyPass</a></code> 。通常，以动态方式<em>带外</em>检查工人的健康状况会更有用。这是由Apache httpd通过<code class="module"><a href="../mod/mod_proxy_hcheck.html">mod_proxy_hcheck</a></code>模块。
    </p>

  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="status" id="status">平衡器成员状态标志</a></h2>
    

    <p>在<em>平衡管理器中</em> ，将显示工作人员的当前状态或<em>状态</em> ，并可对其进行设置/重置。这些状态的含义如下：</p>
      <table class="bordered">
      	<tbody><tr><th>旗</th><th>串</th><th>描述</th></tr>
      	<tr><td> </td><td><em>好</em></td><td>工人可用</td></tr>
      	<tr><td> </td><td><em>在里面</em></td><td>工作器已初始化</td></tr>
        <tr><td><code>D</code></td><td><em>迪斯</em></td><td>工作者被禁用，将不接受任何请求；将自动重试。</td></tr>
        <tr><td><code>S</code></td><td><em>停止</em></td><td>工人在行政上被停止；将不接受请求，也不会自动重试</td></tr>
        <tr><td><code>I</code></td><td><em>点火</em></td><td>Worker处于忽略错误模式，将始终被视为可用。</td></tr>
        <tr><td><code>H</code></td><td><em>斯特比</em></td><td>工作程序处于热备用模式，仅在没有其他可行的工作程序可用时才使用。</td></tr>
        <tr><td><code>E</code></td><td><em>呃</em></td><td>工作者处于错误状态，通常是由于请求前检查失败所致；请求不会被代理给该工作人员，但是将根据<code>retry</code>工人的环境。</td></tr>
        <tr><td><code>N</code></td><td><em>德恩</em></td><td>Worker处于耗尽模式，将仅接受发往其的现有粘性会话，而忽略所有其他请求。</td></tr>
        <tr><td><code>C</code></td><td><em>氟化氢</em></td><td>Worker动态健康检查失败，直到通过后续的健康检查后才会使用。</td></tr>
      </tbody></table>
  </div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>