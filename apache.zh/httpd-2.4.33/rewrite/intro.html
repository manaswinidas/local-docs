<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>Apache mod_rewrite简介-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP服务器</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> > <a href="./index.html">重写</a></div><div id="page-content"><div id="preamble"><h1>Apache mod_rewrite简介</h1>


<p>本文件是对<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code> <a href="../mod/mod_rewrite.html">参考文档</a> 。它描述了使用<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code> 。其他文档也有更详细的介绍，但是该文档应该可以帮助初学者入门。
</p>
</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#introduction">介绍</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#regex">常用表达</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#rewriterule">RewriteRule基础</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#flags">重写标志</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#rewritecond">改写条件</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#rewritemap">改写地图</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#htaccess">.htaccess文件</a></li>
</ul><h3>也可以看看</h3><ul class="seealso"><li><a href="../mod/mod_rewrite.html">模块文件</a></li><li><a href="remapping.html">重定向和重新映射</a></li><li><a href="access.html">控制访问</a></li><li><a href="vhosts.html">虚拟主机</a></li><li><a href="proxy.html">代理</a></li><li><a href="rewritemap.html">使用RewriteMap</a></li><li><a href="advanced.html">先进技术</a></li><li><a href="avoid.html">何时不使用mod_rewrite</a></li></ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="introduction" id="introduction">介绍</a></h2>
<p>Apache模块<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code>是一个非常强大且复杂的模块，它提供了一种进行URL操作的方法。有了它，您几乎可以完成可能需要的所有类型的URL重写。但是，它有些复杂，可能会对初学者造成威胁。还有一种趋向于将重写规则视为魔术咒语，在不真正理解其作用的情况下使用它们。</p>

<p>本文试图提供足够的背景知识，以便理解以下内容，而不是盲目地复制。
</p>

<p>请记住，许多常见的URL操作任务并不需要完整的功能和复杂性。 <code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code> 。有关简单任务，请参阅<code class="module"><a href="../mod/mod_alias.html">mod_alias</a></code>以及有关<a href="../urlmapping.html">将URL映射到文件系统</a>的文档。</p>

<p>最后，在继续之前，请务必进行配置<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code>使用的日志级别到跟踪级别之一<code class="directive"><a href="../mod/core.html#loglevel">LogLevel</a></code>指示。尽管这可以提供大量信息，但是在调试问题时必不可少<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code>配置，因为它将准确告诉您每个规则的处理方式。</p>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="regex" id="regex">常用表达</a></h2>

<p>mod_rewrite使用<a href="http://pcre.org/">Perl兼容的正则表达式</a>词汇表。在本文档中，我们不尝试提供对正则表达式的详细参考。为此，我们推荐<a href="http://shop.oreilly.com/product/9780596528126.do">Jeffrey Friedl撰写</a>的<a href="http://pcre.org/pcre.txt">PCRE手册页</a> ， <a href="http://perldoc.perl.org/perlre.html">Perl正则表达式手册页</a>和<a href="http://shop.oreilly.com/product/9780596528126.do">Mastering正则表达式</a> 。</p>

<p>在本文档中，我们尝试提供足够的正则表达式词汇，以帮助您入门而又不至于太过庞大，以期希望<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code> s将是科学公式，而不是魔咒。</p>

<h3><a name="regexvocab" id="regexvocab">正则表达式词汇</a></h3>

<p>以下是编写正则表达式和<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code> s。它们当然不能代表完整的正则表达式词汇，但是它们是一个很好的起点，应该可以帮助您阅读基本的正则表达式以及编写自己的正则表达式。</p>

<table>
<tbody><tr>
<th>字符</th>
<th>含义</th>
<th>例</th>
</tr>

<tr><td><code>.</code></td><td>匹配任何单个字符</td><td><code>c.t</code>将匹配<code>cat</code> ， <code>cot</code> ， <code>cut</code>等</td></tr>
<tr><td><code>+</code></td><td>重复上一场比赛一次或多次</td><td><code>a+</code>火柴<code>a</code> ， <code>aa</code> ， <code>aaa</code>等</td></tr>
<tr><td><code>*</code></td><td>重复上一次匹配零次或多次。</td><td><code>a*</code>匹配所有相同的东西<code>a+</code>匹配，但也会匹配一个空字符串。</td></tr>
<tr><td><code>?</code></td><td>使匹配为可选。</td><td>
<code>colou?r</code>将匹配<code>color</code>和<code>colour</code> 。</td>
</tr>
<tr><td><code>^</code></td><td>称为锚，匹配字符串的开头</td><td><code>^a</code>匹配以开头的字符串<code>a</code></td></tr>
<tr><td><code>$</code></td><td>另一个锚点，它匹配字符串的结尾。</td><td><code>a$</code>匹配以结尾的字符串<code>a</code> 。</td></tr>
<tr><td><code>( )</code></td><td>将几个字符分组为一个单元，并捕获一个匹配项以用于向后引用。</td><td><code>(ab)+</code>火柴<code>ababab</code> - 那就是<code>+</code>适用于该组。有关反向引用的更多信息，请参见<a href="#InternalBackRefs">下文</a> 。</td></tr>
<tr><td><code>[ ]</code></td><td>字符类-匹配字符之一</td><td><code>c[uoa]t</code>火柴<code>cut</code> ， <code>cot</code>要么<code>cat</code> 。</td></tr>
<tr><td><code>[^ ]</code></td><td>负字符类-匹配未指定的任何字符</td><td><code>c[^/]t</code>火柴<code>cat</code>要么<code>c=t</code>但不是<code>c/t</code></td></tr>
</tbody></table>

<p>在<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code>的<code>!</code>可以在正则表达式之前使用字符来取反它。也就是说，仅当字符串与表达式的其余部分不匹配时，才认为字符串已匹配。</p>



<h3><a name="InternalBackRefs" id="InternalBackRefs">正则表达式反向引用可用性</a></h3>

      <p>这里要记住的一件事是：每当在<em>Pattern</em>或<em>CondPattern</em>之一中使用括号时，内部都会创建可与字符串一起使用的反向引用。 <code>$N</code>和<code>%N</code> （见下文）。这些可用于创建a的<em>Substitution</em>参数。 <code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>或一个的<em>TestString</em>参数<code class="directive"><a href="../mod/mod_rewrite.html#rewritecond">RewriteCond</a></code> 。</p>
      <p>捕获在<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>模式（反常）可用于所有先前<code class="directive"><a href="../mod/mod_rewrite.html#rewritecond">RewriteCond</a></code>指令，因为<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>在各个条件之前评估表达。</p>

      <p>图1显示了将反向引用扩展到哪个位置，并说明了RewriteRule，RewriteCond匹配的流程。在下一章中，我们将探索如何使用这些反向引用，因此，如果一开始对您似乎有些陌生，请不要担心。
      </p>

<p class="figure">
      <img src="../images/rewrite_backreferences.png" alt="RewriteRule和RewriteCond匹配的流程"><br>
      <dfn>图1：</dfn>规则的反向引用流程。<br>在此示例中， <code>/test/1234</code>会变成<code>/admin.foo?page=test&id=1234&host=admin.example.com</code> 。
</p>


</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="rewriterule" id="rewriterule">RewriteRule基础</a></h2>
<p>一种<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>由以空格分隔的三个参数组成。参数是</p>
<ol>
<li><var>Pattern</var> ：哪些传入网址应受规则影响；</li>
<li><var>Substitution</var> ：匹配的请求应该发送到哪里；</li>
<li><var>[flags]</var> ：影响重写请求的选项。</li>
</ol>

<p>的<var>Pattern</var>是一个<a href="#regex">正则表达式</a> 。它最初（对于第一个重写规则或直到发生替换）与传入请求的URL路径（主机名之后但在任何表示查询字符串开头的问号之前的部分）匹配，或者在每个目录中匹配上下文，相对于相对于定义规则的目录的请求路径。一旦发生替换，则将遵循的规则与替换值进行匹配。
</p>

<p class="figure">
      <img src="../images/syntax_rewriterule.png" alt="RewriteRule指令的语法"><br>
      <dfn>图2：</dfn> RewriteRule指令的语法。
</p>


<p>的<var>Substitution</var>本身可以是三件事之一：</p>

<dl>
<dt>资源的完整文件系统路径</dt>
<dd>
<pre class="prettyprint lang-config">RewriteRule "^/games" "/usr/local/games/web"</pre>

<p>这会将请求映射到文件系统上的任意位置，就像<code class="directive"><a href="../mod/mod_alias.html#alias">Alias</a></code>指示。</p>
</dd>

<dt>资源的网络路径</dt>
<dd>
<pre class="prettyprint lang-config">RewriteRule "^/foo$" "/bar"</pre>

<p>如果<code class="directive"><a href="../mod/core.html#documentroot">DocumentRoot</a></code>被设定为<code>/usr/local/apache2/htdocs</code> ，则此指令将映射对<code>http://example.com/foo</code>到这条路<code>/usr/local/apache2/htdocs/bar</code> 。</p>
</dd>

<dt>绝对网址</dt>
<dd>
<pre class="prettyprint lang-config">RewriteRule "^/product/view$" "http://site2.example.com/seeproduct.html" [R]</pre>

<p>这告诉客户端对指定的URL发出新请求。</p>
</dd>
</dl>

<p>的<var>Substitution</var>还可以包含<em>反向引用</em>到由匹配输入的URL路径的部分<var>Pattern</var> 。考虑以下：</p>
<pre class="prettyprint lang-config">RewriteRule "^/product/(.*)/view$" "/var/web/productdb/$1"</pre>

<p>变量<code>$1</code>将被替换为括号中的表达式所匹配的任何文本<var>Pattern</var> 。例如，要求<code>http://example.com/product/r14df/view</code>将被映射到路径<code>/var/web/productdb/r14df</code> 。</p>

<p>如果括号中有多个表达式，则它们在变量中按顺序可用<code>$1</code> ， <code>$2</code> ， <code>$3</code> ， 等等。</p>


</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="flags" id="flags">重写标志</a></h2>
<p>一个的行为<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>可以通过在规则末尾应用一个或多个标志来进行修改。例如，规则的匹配行为可以通过应用<code>[NC]</code>旗：</p>
<pre class="prettyprint lang-config">RewriteRule "^puppy.html" "smalldog.html" [NC]</pre>


<p>有关可用标志，它们的含义和示例的更多详细信息，请参阅“ <a href="flags.html">重写标志”</a>文档。</p>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="rewritecond" id="rewritecond">改写条件</a></h2>
<p>一个或多个<code class="directive"><a href="../mod/mod_rewrite.html#rewritecond">RewriteCond</a></code>指令可用于限制将受到以下限制的请求类型<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code> 。第一个参数是描述请求特征的变量，第二个参数是必须与变量匹配的<a href="#regex">正则表达式</a> ，第三个可选参数是标志列表，用于修改匹配的计算方式。</p>

<p class="figure">
      <img src="../images/syntax_rewritecond.png" alt="RewriteCond指令的语法"><br>
      <dfn>图3：</dfn> RewriteCond指令的语法</p>

<p>例如，要将所有请求从特定IP范围发送到其他服务器，可以使用：</p>
<pre class="prettyprint lang-config">RewriteCond "%{REMOTE_ADDR}" "^10\.2\."
RewriteRule "(.*)" "http://intranet.example.com$1"</pre>


<p>当一个以上<code class="directive"><a href="../mod/mod_rewrite.html#rewritecond">RewriteCond</a></code>被指定，它们必须全部匹配<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>要施加。例如，要拒绝在查询字符串中包含单词“ hack”的请求，除非它们还包含包含单词“ go”的cookie，则可以使用：</p>
<pre class="prettyprint lang-config">RewriteCond "%{QUERY_STRING}" "hack"
RewriteCond "%{HTTP_COOKIE}" "!go"
RewriteRule "." "-" [F]</pre>

<p>请注意，感叹号指定了否定匹配，因此仅当cookie不包含“ go”时才应用该规则。</p>

<p>匹配包含在正则表达式中的<code class="directive"><a href="../mod/mod_rewrite.html#rewritecond">RewriteCond</a></code>可以用作的一部分<var>Substitution</var>在里面<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>使用变量<code>%1</code> ， <code>%2</code> ，等等。例如，这将根据用于访问该站点的主机名将请求定向到另一个目录：</p>
<pre class="prettyprint lang-config">RewriteCond "%{HTTP_HOST}" "(.*)"
RewriteRule "^/(.*)" "/sites/%1/$1"</pre>

<p>如果要求是<code>http://example.com/foo/bar</code> ， 然后<code>%1</code>将包含<code>example.com</code>和<code>$1</code>将包含<code>foo/bar</code> 。</p>



</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="rewritemap" id="rewritemap">改写地图</a></h2>

<p>的<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>指令提供了一种调用外部函数的方法，可以这么说，为您进行重写。<a href="rewritemap.html">RewriteMap补充文档中</a>对此进行了更详细的讨论。</p>
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="htaccess" id="htaccess">.htaccess文件</a></h2>

<p>重写通常是在主服务器配置设置中配置的（任何其他<code class="directive"><a href="../mod/core.html#directory"><Directory></a></code>部分）或内部<code class="directive"><a href="../mod/core.html#virtualhost"><VirtualHost></a></code>容器。这是最简单的重写方法，建议使用。但是，可以在内部进行重写<code class="directive"><a href="../mod/core.html#directory"><Directory></a></code>部分或<a href="../howto/htaccess.html"><code>.htaccess</code>文件会</a>增加一些复杂性。此技术称为按目录重写。</p>

<p>每台服务器重写的主要区别在于，包含<code>.htaccess</code>在匹配之前先剥离文件<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code> 。除此之外<code class="directive"><a href="../mod/mod_rewrite.html#rewritebase">RewriteBase</a></code>应该用于确保正确映射了请求。</p>

</div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>