<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>Apache mod_rewrite技术详细信息-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP服务器</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> > <a href="./index.html">重写</a></div><div id="page-content"><div id="preamble"><h1>Apache mod_rewrite技术细节</h1>


<p>本文档讨论了mod_rewrite和URL匹配的一些技术细节。</p>
</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#InternalAPI">API阶段</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#InternalRuleset">规则集处理</a></li>
</ul><h3>也可以看看</h3><ul class="seealso"><li><a href="../mod/mod_rewrite.html">模块文件</a></li><li><a href="intro.html">mod_rewrite简介</a></li><li><a href="remapping.html">重定向和重新映射</a></li><li><a href="access.html">控制访问</a></li><li><a href="vhosts.html">虚拟主机</a></li><li><a href="proxy.html">代理</a></li><li><a href="rewritemap.html">使用RewriteMap</a></li><li><a href="advanced.html">先进技术</a></li><li><a href="avoid.html">何时不使用mod_rewrite</a></li></ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="InternalAPI" id="InternalAPI">API阶段</a></h2>

    <p>Apache HTTP Server分几个阶段处理请求。在这些阶段的每个阶段，可以调用一个或多个模块来处理请求生命周期的这一部分。阶段包括URL到文件名的转换，身份验证，授权，内容和日志记录。（这不是详尽的清单。）</p>

    <p>mod_rewrite在这两个阶段（或经常被称为“钩子”）中起作用，以影响URL的重写方式。</p>

    <p>首先，它使用URL到文件名转换挂钩，该挂钩在读取HTTP请求之后但开始任何授权之前发生。其次，它使用Fixup钩子，该钩子在授权阶段之后，在每个目录的配置文件之后（ <code>.htaccess</code>文件）已被读取，但是在调用内容处理程序之前。</p>

    <p>因此，在请求进入并确定了相应的服务器或虚拟主机之后，重写引擎将开始处理任何<code>mod_rewrite</code>每服务器配置中显示的指令。 （即在主服务器配置文件中<code class="directive"><a href="../mod/core.html#virtualhost"><Virtualhost></a></code>部分。）这发生在URL到文件名阶段。</p>

    <p>几步后，找到最终数据目录后，按目录配置指令（ <code>.htaccess</code>文件和<code class="directive"><a href="../mod/core.html#directory"><Directory></a></code>块）。这发生在修复阶段。</p>

    <p>在上述每种情况下，mod_rewrite都会重写<code>REQUEST_URI</code>或新网址或文件名。</p>

    <p>在每个目录的上下文中（即，在<code>.htaccess</code>文件和<code>Directory</code>块），则在将URL转换为文件名后将应用这些规则。因此，mod_rewrite最初比较的URL路径<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>指令反对是已翻译文件名的完整文件系统路径，并且当前目录路径（包括斜杠）从前面删除。</p>

    <p>举例说明：如果规则位于/var/www/foo/.htaccess中，并且正在处理对/ foo / bar / baz的请求，则匹配^ bar / baz $之类的表达式。</p>

    <p>如果在每个目录上下文中进行替换，则会使用新的URL发出新的内部子请求，从而重新开始请求阶段的处理。如果替代是相对路径，则<code class="directive"><a href="../mod/mod_rewrite.html#rewritebase">RewriteBase</a></code>指令确定替换之前的URL路径前缀。在每个目录的上下文中，必须小心创建规则，这些规则最终（在将来的每个目录重写处理中）将不执行替换操作以避免循环。（有关此问题的进一步讨论，请参见<a href="http://wiki.apache.org/httpd/RewriteLooping">RewriteLooping</a> 。）</p>

    <p>由于在每个目录上下文中对URL进行了进一步的处理，因此您需要注意在该上下文中以不同的方式编写重写规则。特别是，请记住，将删除重写规则将看到的URL的开头目录路径。请考虑以下示例以进一步说明。</p>

    <table class="bordered">

        <tbody><tr>
            <th>规则位置</th>
            <th>规则</th>
        </tr>

        <tr>
            <td>VirtualHost部分</td>
            <td>RewriteRule“ ^ / images /（。+）\。jpg“” /images/$1.gif“</td>
        </tr>

        <tr>
            <td>文件根目录中的.htaccess文件</td>
            <td>RewriteRule“ ^ images /（。+）\。jpg“” images / $ 1.gif“</td>
        </tr>

        <tr>
            <td>.htaccess文件在images目录中</td>
            <td>RewriteRule“ ^（。+）\。jpg“” $ 1.gif“</td>
        </tr>

    </tbody></table>

    <p>要进一步了解mod_rewrite如何在不同上下文中操纵URL，您应该查阅重写期间创建的<a href="../mod/mod_rewrite.html#logging">日志条目</a> 。</p>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="InternalRuleset" id="InternalRuleset">规则集处理</a></h2>

      <p>现在，当在这两个API阶段中触发mod_rewrite时，它将从其配置结构中读取已配置的规则集（该规则集本身是在针对每个服务器上下文启动时创建的，或者是针对每个目录上下文在Apache内核的目录遍历期间创建的）。然后，使用包含的规则集（一个或多个规则及其条件）启动URL重写引擎。对于两个配置上下文，URL重写引擎本身的操作是完全相同的。仅最终结果处理有所不同。</p>

      <p>规则集中的规则顺序很重要，因为重写引擎以特殊（但不是很明显）的顺序处理它们。规则是这样的：重写引擎按规则遍历规则集（ <code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>指令），并在匹配特定规则时有选择地遍历现有的相应条件（ <code>RewriteCond</code>指令）。由于历史原因，首先要给出条件，因此控制流程有些冗长。有关更多详细信息，请参见图1。</p>
<p class="figure">
      <img src="../images/rewrite_process_uri.png" alt="RewriteRule和RewriteCond匹配的流程"><br>
      <dfn>图1：</dfn>重写规则集的控制流</p>
      <p>首先，URL与每个规则的<em>模式</em>匹配。如果失败，则mod_rewrite立即停止处理此规则，并继续执行下一个规则。如果<em>模式</em>匹配，则mod_rewrite查找相应的规则条件（RewriteCond指令，出现在配置中RewriteRule的紧上方）。如果不存在，则将URL <em>替换</em>为由字符串<em>Substitution</em>构造的新值，然后继续进行规则循环。但是，如果条件存在，它将启动一个内部循环以按列出的顺序对其进行处理。对于条件，逻辑是不同的：我们没有将模式与当前URL匹配。相反，我们首先通过扩展变量，反向引用，映射查找<em>等来</em>创建字符串<em>TestString</em> ，然后尝试将<em>CondPattern</em>与之匹配。如果模式不匹配，则完整的条件集和相应的规则将失败。如果模式匹配，则处理下一个条件，直到没有其他条件可用为止。如果所有条件都匹配，则继续处理，将URL <em>替换为Substitution</em> 。</p>

</div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>