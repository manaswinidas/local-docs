<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>使用RewriteMap-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP服务器</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> > <a href="./index.html">重写</a></div><div id="page-content"><div id="preamble"><h1>使用RewriteMap</h1>



    <p>本文件是对<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code> <a href="../mod/mod_rewrite.html">参考文档</a> 。它描述了<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>指令，并提供各种示例<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>类型。</p>

    <div class="warning">请注意，这些示例中的许多示例在您的特定服务器配置中都不会起作用，因此，理解它们，而不只是将示例剪切并粘贴到您的配置中，这一点很重要。</div>

  </div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#introduction">介绍</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#int">int：内部函数</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#txt">txt：纯文本地图</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#rnd">rnd：随机纯文本</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#dbm">dbm：DBM哈希文件</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#prg">prg：外部重写程序</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#dbd">dbd或fastdbd：SQL查询</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#summary">摘要</a></li>
</ul><h3>也可以看看</h3><ul class="seealso"><li><a href="../mod/mod_rewrite.html">模块文件</a></li><li><a href="intro.html">mod_rewrite简介</a></li><li><a href="remapping.html">重定向和重新映射</a></li><li><a href="access.html">控制访问</a></li><li><a href="vhosts.html">虚拟主机</a></li><li><a href="proxy.html">代理</a></li><li><a href="advanced.html">先进技术</a></li><li><a href="avoid.html">何时不使用mod_rewrite</a></li></ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="introduction" id="introduction">介绍</a></h2>
    

   <p>的<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>指令定义了可以在以下情况下调用的外部函数<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>要么<code class="directive"><a href="../mod/mod_rewrite.html#rewritecond">RewriteCond</a></code>指令来执行过于复杂或过于专业化而无法仅由正则表达式执行的重写。查找的来源可以是以下各节中列出的任何类型，并在<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>参考文档。</p>

   <p>的语法<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>指令如下：</p>

<pre class="prettyprint lang-config">RewriteMap <em>MapName</em> <em>MapType</em>:<em>MapSource</em>
</pre>


    <p><a id="mapfunc" name="mapfunc"><em>MapName</em></a>是分配给地图的任意名称，稍后将在指令中使用。参数通过以下语法传递给地图：</p>

    <p class="indent">
      <strong>
        <code>${</code> <em>地图名</em> <code>:</code> <em>查找键</em> <code>}</code> <br> <code>${</code> <em>地图名</em> <code>:</code> <em>查找键</em> <code>|</code> <em>默认值</em> <code>}</code>
      </strong>
    </p>

    <p>当发生这种构造时，将查询映射<em>MapName</em>并查找键<em>LookupKey</em> 。如果找到了键，则将map-function构造替换为<em>SubstValue</em> 。如果没有找到关键则其由<em>默认值</em>或由空字符串如果没有指定<em>默认值</em>取代。</p>

    <p>例如，您可以定义一个<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>如：</p>
    <pre class="prettyprint lang-config">RewriteMap examplemap "txt:/path/to/file/map.txt"</pre>

    <p>然后，您将可以在<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>如下：</p>
      <pre class="prettyprint lang-config">RewriteRule "^/ex/(.*)" "${examplemap:$1}"</pre>


<p>如果在地图中找不到任何内容，则可以指定默认值：</p>

<pre class="prettyprint lang-config">RewriteRule "^/ex/(.*)" "${examplemap:$1|/not_found.html}"</pre>


<div class="note"><h3>每个目录和.htaccess上下文</h3>
<p>的<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>指令不能在<code class="directive"><a href="../mod/core.html#directory"><Directory></a></code>部分或<code>.htaccess</code>文件。您必须在服务器或虚拟主机上下文中声明映射。您可以在创建后使用地图<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>和<code class="directive"><a href="../mod/mod_rewrite.html#rewritecond">RewriteCond</a></code>在这些范围内的指令。您只是不能在这些范围内<strong>声明</strong>它。</p>
</div>

<p>以下各节描述了可以使用的各种<em>MapType</em> ，并给出了每个示例。</p>
  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="int" id="int">int：内部函数</a></h2>
    

    <p>当MapType为<code>int</code>使用时，MapSource是可用的内部之一<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>功能。模块作者可以通过向开发者注册来提供其他内部功能。 <code>ap_register_rewrite_mapfunc</code> API。默认情况下提供的功能是：</p>

    <ul>
      <li><strong>toupper</strong> ：<br>将密钥转换为全部大写。</li>
      <li><strong>降低</strong> ：<br>将密钥转换为所有小写字母。</li>
      <li><strong>逃脱</strong> ：<br>将密钥中的特殊字符转换为十六进制编码。</li>
      <li><strong>unescape</strong> ：<br>将密钥中的十六进制编码转换回特殊字符。</li>
    </ul>

    <p>要使用这些功能之一，请创建一个<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>引用int函数，然后在您的<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code> ：</p>

   <p> <strong>将URI重定向到自身的全小写版本</strong></p>
    <pre class="prettyprint lang-config">RewriteMap lc int:tolower
RewriteRule "(.*)" "${lc:$1}" [R]</pre>


    <div class="note">
    <p>请注意，此处提供的示例仅用于说明目的，而不是建议。如果要使网址不区分大小写，请考虑使用<code class="module"><a href="../mod/mod_speling.html">mod_speling</a></code>代替。
    </p>
    </div>

  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="txt" id="txt">txt：纯文本地图</a></h2>
    

    <p>当MapType为<code>txt</code>使用MapSource时，它是纯文本映射文件的文件系统路径，每行包含一个以空格分隔的键/值对。可选地，一行可以包含以“＃”字符开头的注释。</p>

    <p>有效的文本重写映射文件将具有以下语法：</p>

    <div class="example"><p><code># Comment line<br> <strong><em>MatchingKey</em> <em>SubstValue</em></strong><br> <strong><em>MatchingKey</em> <em>SubstValue</em></strong> # comment<br></code></p></div>

    <p>当。。。的时候<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>被调用时，在一行的第一个参数中寻找该参数，如果找到，则返回替换值。</p>

    <p>例如，我们可以使用以下配方使用映射文件将产品名称转换为易于识别的URL的产品ID：</p>
<p><strong>产品到ID的配置</strong></p>
    <pre class="prettyprint lang-config">RewriteMap product2id "txt:/etc/apache2/productmap.txt"
RewriteRule "^/product/(.*)" "/prods.php?id=${product2id:$1|NOTFOUND}" [PT]</pre>


    <p>我们在这里假设<code>prods.php</code>脚本收到参数后就知道该怎么办<code>id=NOTFOUND</code>在查找映射中找不到产品时。</p>

    <p>文件<code>/etc/apache2/productmap.txt</code>然后包含以下内容：</p>

    <div class="example"><h3>产品到ID的映射</h3><p><code>##<br> ## productmap.txt - Product to ID map file<br> ##<br> <br> television 993<br> stereo 198<br> fishingrod 043<br> basketball 418<br> telephone 328</code></p></div>

    <p>因此，当<code>http://example.com/product/television</code>被要求， <code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>应用，并且该请求在内部映射到<code>/prods.php?id=993</code> 。</p>

    <div class="note"><h3>注意：.htaccess文件</h3>给出的示例旨在用于服务器或虚拟主机范围。如果您打算在<code>.htaccess</code>文件，您需要从重写模式中删除前导斜杠以使其与任何内容匹配：<pre class="prettyprint lang-config">RewriteRule "^product/(.*)" "/prods.php?id=${product2id:$1|NOTFOUND}" [PT]</pre>

    </div>

    <div class="note"><h3>缓存的查询</h3>
    <p>查找的密钥由httpd缓存，直到<code>mtime</code> （修改时间）的映射文件更改，或重新启动httpd服务器。这样可确保在许多请求调用的地图上具有更好的性能。
    </p>
    </div>

  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="rnd" id="rnd">rnd：随机纯文本</a></h2>
    

    <p>当MapType为<code>rnd</code>使用MapSource时，它是纯文本映射文件的文件系统路径，该文件的每一行都包含一个键，以及一个或多个值，用<code>|</code> 。如果密钥匹配，将随机选择这些值之一。</p>

    <p>例如，您可以使用以下映射文件和指令通过反向代理在多个后端服务器之间提供随机负载平衡。图像发送到“静态”池中的一台服务器，而其他所有内容都发送到“动态”池中的一台。</p>

    <div class="example"><h3>改写地图文件</h3><p><code>##<br> ## map.txt -- rewriting map<br> ##<br> <br> static www1|www2|www3|www4<br> dynamic www5|www6</code></p></div>
<p><strong>配置指令</strong></p>
    <pre class="prettyprint lang-config">RewriteMap servers "rnd:/path/to/file/map.txt"

RewriteRule "^/(.*\.(png|gif|jpg))" "http://${servers:static}/$1"  [NC,P,L]
RewriteRule "^/(.*)"                "http://${servers:dynamic}/$1" [P,L]</pre>


    <p>因此，当请求图像并且这些规则中的第一个匹配时， <code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>查找字符串<code>static</code>在地图文件中，该文件随机返回指定的主机名之一，然后在<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>目标。</p>

    <p>如果您希望选择其中一台服务器的可能性更高（例如，如果其中一台服务器比其他服务器具有更多的内存，因此可以处理更多请求），只需在映射文件中多次列出它即可。</p>

    <div class="example"><p><code>static www1|www1|www2|www3|www4</code></p></div>

  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="dbm" id="dbm">dbm：DBM哈希文件</a></h2>
    

    <p>当MapType为<code>dbm</code>如果使用，则MapSource是DBM数据库文件的文件系统路径，该文件包含要在映射中使用的键/值对。这与<code>txt</code>映射，但是速度更快，因为对DBM进行了索引，而对文本文件则未进行索引。这样可以更快速地访问所需的密钥。</p>

    <p>您可以选择指定特定的dbm类型：</p>

 <pre class="prettyprint lang-config">RewriteMap examplemap "dbm=sdbm:/etc/apache/mapfile.dbm"</pre>


    <p>类型可以是<code>sdbm</code> ， <code>gdbm</code> ， <code>ndbm</code>要么<code>db</code> 。但是，建议您仅使用Apache HTTP Server随附的<a href="../programs/httxt2dbm.html">httxt2dbm</a>实用程序，因为它会使用正确的DBM库，该库与构建httpd本身时使用的库相匹配。</p>

    <p>要创建dbm文件，请首先创建一个文本映射文件，如<a href="#txt">txt</a>部分中所述。然后跑<code>httxt2dbm</code> ：</p>

<div class="example"><p><code>$ httxt2dbm -i mapfile.txt -o mapfile.map</code></p></div>

<p>然后，您可以在<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>指示：</p>

<pre class="prettyprint lang-config">RewriteMap mapname "dbm:/etc/apache/mapfile.map"</pre>


<div class="note">
<p>请注意，对于某些dbm类型，将生成多个文件，并且具有通用的基本名称。例如，您可能有两个名为<code>mapfile.map.dir</code>和<code>mapfiile.map.pag</code> 。这是正常现象，您只需要使用基本名称<code>mapfile.map</code>在你的<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>指示。</p>
</div>

<div class="note"><h3>缓存的查询</h3>
<p>查找的密钥由httpd缓存，直到<code>mtime</code> （修改时间）的映射文件更改，或重新启动httpd服务器。这样可确保在许多请求调用的地图上具有更好的性能。
</p>
</div>

  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="prg" id="prg">prg：外部重写程序</a></h2>

    <p>当MapType为<code>prg</code>使用MapSource时，它将是可执行程序的文件系统路径，该程序将提供映射行为。这可以是已编译的二进制文件，也可以是解释语言（例如Perl或Python）的程序。</p>

    <p>启动Apache HTTP Server时，该程序将启动一次，然后通过以下方式与重写引擎进行通信<code>STDIN</code>和<code>STDOUT</code> 。也就是说，对于每个映射函数查找，它期望通过<code>STDIN</code> ，并且应在上返回一个换行符终止的响应字符串<code>STDOUT</code> 。如果没有相应的查找值，则映射程序应返回四个字符的字符串“ <code>NULL</code> ”来表示这一点。</p>

    <p>如果外部重写程序是在没有上下文的环境中定义的，则它们不会启动<code class="directive"><a href="../mod/mod_rewrite.html#rewriteengine">RewriteEngine</a></code>调成<code>on</code> 。</p>

    <p>默认情况下，外部重写程序以root身份启动。在UNIX系统上，可以通过将用户名和组名作为第三个参数传递给来更改此设置。 <code class="directive"><a href="../mod/mod_rewrite.html#rewritemap"> RewriteMap</a></code>在里面<code>username:groupname</code>格式。</p>

    <p>此功能利用了<code>rewrite-map</code>互斥体，这是与程序进行可靠通信所必需的。互斥锁机制和锁定文件可以使用<code class="directive"><a href="../mod/core.html#mutex">Mutex</a></code>指示。</p>

    <p>此处显示了一个简单的示例，该示例将在请求URI中用下划线替换所有破折号。</p>

    <p><strong>重写配置</strong></p>
    <pre class="prettyprint lang-config">RewriteMap d2u "prg:/www/bin/dash2under.pl" apache:apache
RewriteRule "-" "${d2u:%{REQUEST_URI}}"</pre>


    <p><strong>dash2under.pl</strong></p>
    <pre class="prettyprint lang-perl">#!/usr/bin/perl
$| = 1; # Turn off I/O buffering
while (&lt;STDIN&gt;) {
    s/-/_/g; # Replace dashes with underscores
    print $_;
}</pre>


<div class="note"><h3>警告！</h3>
<ul>
<li>使您的重写映射程序尽可能简单。如果程序挂起，它将导致httpd无限期地等待来自映射的响应，从而导致httpd停止响应请求。</li>
<li>确保关闭程序中的缓冲。在Perl中，这是通过示例脚本的第二行完成的： <code>$| = 1;</code>当然，其他语言也会有所不同。缓冲的I / O将使httpd等待输出，因此它将挂起。</li>
<li>请记住，只有在服务器启动时才启动该程序的一个副本。所有请求都需要克服这一瓶颈。如果许多请求必须经过此过程，或者脚本本身非常慢，则这可能会导致严重的速度下降。</li>
</ul>
</div>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="dbd" id="dbd">dbd或fastdbd：SQL查询</a></h2>
    

    <p>当MapType为<code>dbd</code>要么<code>fastdbd</code>使用MapSource时，它是一个SQL SELECT语句，它使用单个参数并返回单个值。</p>

    <p><code class="module"><a href="../mod/mod_dbd.html">mod_dbd</a></code>将需要配置为指向正确的数据库以执行此语句。</p>

    <p>此MapType有两种形式。使用的MapType <code>dbd</code>使查询在每个地图请求中执行，同时使用<code>fastdbd</code>内部缓存数据库查找。所以，虽然<code>fastdbd</code>效率更高，因此速度也更快，直到重新启动服务器后，数据库才会对数据库进行更改。</p>

    <p>如果查询返回多行，则使用结果集中的随机行。</p>

    <div class="example"><h3>例</h3><pre class="prettyprint lang-config">RewriteMap myquery "fastdbd:SELECT destination FROM rewrite WHERE source = %s"</pre>
</div>

  </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="summary" id="summary">摘要</a></h2>
    

    <p>的<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>指令可以多次出现。对于每个映射功能，请使用一个<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>指令声明其重写mapfile。</p>

    <p>虽然无法在每个目录的上下文中<strong>声明</strong>映射（ <code>.htaccess</code>文件或<code class="directive"><a href="../mod/core.html#directory"><Directory></a></code>块），则可以在每个目录的上下文中<strong>使用</strong>此映射。</p>

  </div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>