<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>使用mod_rewrite的动态大量虚拟主机-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP服务器</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> > <a href="./index.html">重写</a></div><div id="page-content"><div id="preamble"><h1>使用mod_rewrite的动态批量虚拟主机</h1>



<p>本文件是对<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code> <a href="../mod/mod_rewrite.html">参考文档</a> 。它描述了如何使用<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code>创建动态配置的虚拟主机。</p>

<div class="warning">mod_rewrite不是配置虚拟主机的最佳方法。在采用mod_rewrite之前，您应该首先考虑<a href="../vhosts/mass.html">替代方案</a> 。另请参阅“ <a href="avoid.html#vhosts">如何避免使用mod_rewrite</a>文档”。</div>

</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#per-hostname">任意主机名的虚拟主机</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#simple.rewrite">动态虚拟主机使用<code class="module"></code></a><code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code></li>
<li><img alt="" src="../images/down.gif"> <a href="#xtra-conf">使用单独的虚拟主机配置文件</a></li>
</ul><h3>也可以看看</h3><ul class="seealso"><li><a href="../mod/mod_rewrite.html">模块文件</a></li><li><a href="intro.html">mod_rewrite简介</a></li><li><a href="remapping.html">重定向和重新映射</a></li><li><a href="access.html">控制访问</a></li><li><a href="proxy.html">代理</a></li><li><a href="rewritemap.html">重写地图</a></li><li><a href="advanced.html">先进技术</a></li><li><a href="avoid.html">何时不使用mod_rewrite</a></li></ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="per-hostname" id="per-hostname">任意主机名的虚拟主机</a></h2>

  

  <dl>
    <dt>描述：</dt>

    <dd>
    <p>我们希望为在我们域中解析的每个主机名自动创建一个虚拟主机，而不必创建新的VirtualHost部分。</p>

    <p>在此食谱中，我们假设将使用主机名<code>www.<strong>SITE</strong>.example.com</code>为每个用户提供服务，并从<code>/home/<strong>SITE</strong>/www</code> 。</p>
    </dd>

    <dt>解：</dt>

    <dd>

<pre class="prettyprint lang-config">RewriteEngine on

RewriteMap    lowercase int:tolower

RewriteCond   "${lowercase:%{<strong>HTTP_HOST</strong>}}"   "^www\.<strong>([^.]+)</strong>\.example\.com$"
RewriteRule   "^(.*)" "/home/<strong>%1</strong>/www$1"</pre>
</dd>

<dt>讨论区</dt>
    <dd>

    <div class="warning">您将需要注意DNS解析-Apache不处理名称解析。您需要为每个主机名创建CNAME记录，或DNS通配符记录。创建DNS记录超出了本文档的范围。</div>

<p>内置的<code>tolower</code> RewriteMap指令用于确保所使用的主机名全部为小写字母，从而在必须创建的目录结构中不存在歧义。</p>

<p>括号用于<code class="directive"><a href="../mod/mod_rewrite.html#rewritecond">RewriteCond</a></code>被捕获到反向引用中<code>%1</code> ， <code>%2</code>等等，而括号用于<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>被捕获到反向引用中<code>$1</code> ， <code>$2</code>等</p>

<p>与本文档中讨论的许多技术一样，mod_rewrite确实不是完成此任务的最佳方法。您应该考虑使用<code class="module"><a href="../mod/mod_vhost_alias.html">mod_vhost_alias</a></code>取而代之的是，它可以更优雅地处理除提供静态文件之外的所有内容，例如任何动态内容和别名解析。
</p>
    </dd>
  </dl>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="simple.rewrite" id="simple.rewrite">动态虚拟主机使用<code class="module"></code></a><code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code></h2>

    <p>这是从<code>httpd.conf</code> <a href="#per-hostname">与第一个例子</a>做同样的事情。前半部分与上面的相应部分非常相似，只不过有些变化是向后兼容和<code>mod_rewrite</code>部分工作正常；下半部分配置<code>mod_rewrite</code>做实际的工作。</p>

    <p>因为<code>mod_rewrite</code>在其他URI转换模块（例如， <code>mod_alias</code> ）， <code>mod_rewrite</code>必须告知他们明确忽略那些模块会处理的所有URL。而且，因为否则这些规则将绕过任何<code>ScriptAlias</code>指令，我们必须有<code>mod_rewrite</code>明确制定这些映射。</p>

<pre class="prettyprint lang-config"># get the server name from the Host: header
UseCanonicalName Off

# splittable logs
LogFormat "%{Host}i %h %l %u %t \"%r\" %s %b" vcommon
CustomLog "logs/access_log" vcommon

&lt;Directory "/www/hosts"&gt;
    # ExecCGI is needed here because we can't force
    # CGI execution in the way that ScriptAlias does
    Options FollowSymLinks ExecCGI
&lt;/Directory&gt;

RewriteEngine On

# a ServerName derived from a Host: header may be any case at all
RewriteMap  lowercase  int:tolower

## deal with normal documents first:
# allow Alias "/icons/" to work - repeat for other aliases
RewriteCond  "%{REQUEST_URI}"  "!^/icons/"
# allow CGIs to work
RewriteCond  "%{REQUEST_URI}"  "!^/cgi-bin/"
# do the magic
RewriteRule  "^/(.*)$"  "/www/hosts/${lowercase:%{SERVER_NAME}}/docs/$1"

## and now deal with CGIs - we have to force a handler
RewriteCond  "%{REQUEST_URI}"  "^/cgi-bin/"
RewriteRule  "^/(.*)$"  "/www/hosts/${lowercase:%{SERVER_NAME}}/cgi-bin/$1"  [H=cgi-script]</pre>


</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="xtra-conf" id="xtra-conf">使用单独的虚拟主机配置文件</a></h2>

    <p>这种安排使用更高级<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code>可以从单独的配置文件计算出从虚拟主机到文档根目录的转换功能。这提供了更大的灵活性，但是需要更复杂的配置。</p>

    <p>的<code>vhost.map</code>文件应如下所示：</p>

<div class="example"><p><code>customer-1.example.com /www/customers/1<br> customer-2.example.com /www/customers/2<br> # ...<br> customer-N.example.com /www/customers/N<br></code></p></div>

    <p>的<code>httpd.conf</code>应包含以下内容：</p>

<pre class="prettyprint lang-config">RewriteEngine on

RewriteMap   lowercase  int:tolower

# define the map file
RewriteMap   vhost      "txt:/www/conf/vhost.map"

# deal with aliases as above
RewriteCond  "%{REQUEST_URI}"               "!^/icons/"
RewriteCond  "%{REQUEST_URI}"               "!^/cgi-bin/"
RewriteCond  "${lowercase:%{SERVER_NAME}}"  "^(.+)$"
# this does the file-based remap
RewriteCond  "${vhost:%1}"                  "^(/.*)$"
RewriteRule  "^/(.*)$"                      "%1/docs/$1"

RewriteCond  "%{REQUEST_URI}"               "^/cgi-bin/"
RewriteCond  "${lowercase:%{SERVER_NAME}}"  "^(.+)$"
RewriteCond  "${vhost:%1}"                  "^(/.*)$"
RewriteRule  "^/cgi-bin/(.*)$"                      "%1/cgi-bin/$1" [H=cgi-script]</pre>


</div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>