<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>使用mod_rewrite控制访问-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP服务器</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> > <a href="./index.html">重写</a></div><div id="page-content"><div id="preamble"><h1>使用mod_rewrite控制访问</h1>



<p>本文件是对<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code> <a href="../mod/mod_rewrite.html">参考文档</a> 。它描述了如何使用<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code>以控制对各种资源和其他相关技术的访问。这包括mod_rewrite常用用法的许多示例，包括每种用法的详细说明。</p>

<div class="warning">请注意，这些示例中的许多示例在您的特定服务器配置中都不会起作用，因此，理解它们，而不只是将示例剪切并粘贴到您的配置中，这一点很重要。</div>

</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#blocked-inline-images">禁止图片“热链接”</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#blocking-of-robots">机器人封锁</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#host-deny">拒绝黑名单中的主机</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#referer-deflector">基于引用者的偏转器</a></li>
</ul><h3>也可以看看</h3><ul class="seealso"><li><a href="../mod/mod_rewrite.html">模块文件</a></li><li><a href="intro.html">mod_rewrite简介</a></li><li><a href="remapping.html">重定向和重新映射</a></li><li><a href="vhosts.html">虚拟主机</a></li><li><a href="proxy.html">代理</a></li><li><a href="rewritemap.html">使用RewriteMap</a></li><li><a href="advanced.html">先进技术</a></li><li><a href="avoid.html">何时不使用mod_rewrite</a></li></ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="blocked-inline-images" id="blocked-inline-images">禁止图片“热链接”</a></h2>

      

      <dl>
        <dt>描述：</dt>

        <dd>
          <p>以下技术禁止在其他网站上进行其他操作，包括在页面中内嵌图像。这种做法通常称为“热链接”，导致您的带宽被用于为其他人的站点提供内容。</p>
        </dd>

        <dt>解：</dt>

        <dd>
          <p>此技术依赖于<code>HTTP_REFERER</code>变量，这是可选的。因此，某些人有可能规避此限制。但是，大多数用户将遇到失败的请求，随着时间的流逝，这将导致从该其他站点删除该图像。</p>
          <p>有几种方法可以处理这种情况。</p>

    <p>在第一个示例中，如果请求不是从我们网站上的页面发起的，我们只是拒绝该请求。就本示例而言，我们假设我们的网站是<code>www.example.com</code> 。</p>



<pre class="prettyprint lang-config">RewriteCond "%{HTTP_REFERER}" "!^$"
RewriteCond "%{HTTP_REFERER}" "!www.example.com" [NC]
RewriteRule "\.(gif|jpg|png)$"    "-"   [F,NC]</pre>


    <p>在第二个示例中，我们显示替代图像，而不是失败请求。</p>

<pre class="prettyprint lang-config">RewriteCond "%{HTTP_REFERER}" "!^$"
RewriteCond "%{HTTP_REFERER}" "!www.example.com" [NC]
RewriteRule "\.(gif|jpg|png)$"    "/images/go-away.png"   [R,NC]</pre>


    <p>在第三个示例中，我们将请求重定向到其他站点上的图像。</p>

<pre class="prettyprint lang-config">RewriteCond "%{HTTP_REFERER}" "!^$"
RewriteCond "%{HTTP_REFERER}" "!www.example.com" [NC]
RewriteRule "\.(gif|jpg|png)$" "http://other.example.com/image.gif"   [R,NC]</pre>


    <p>在这些技术中，最后两种趋于最有效地使人们停止热链接您的图像，因为他们将根本看不到他们期望看到的图像。</p>

        </dd>

        <dt>讨论：</dt>

        <dd>
        <p>如果您只想拒绝对该资源的访问，而不是将该请求重定向到其他位置，则可以在不使用mod_rewrite的情况下完成此操作：</p>

        <pre class="prettyprint lang-config">SetEnvIf Referer "example\.com" localreferer
&lt;FilesMatch "\.(jpg|png|gif)$"&gt;
    Require env localreferer
&lt;/FilesMatch&gt;</pre>

        </dd>
      </dl>

    </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="blocking-of-robots" id="blocking-of-robots">机器人封锁</a></h2>

      

      <dl>
        <dt>描述：</dt>

        <dd>
        <p>在本食谱中，我们讨论如何阻止来自特定机器人或用户代理的持久性请求。</p>

        <p>机器人排除标准定义了一个文件， <code>/robots.txt</code>指定您希望排除漫游器的网站部分。但是，某些机械手不遵守这些文件。
        </p>

        <p>请注意，有一些完成此操作的方法不使用mod_rewrite。还请注意，任何依赖客户端的技术<code>USER_AGENT</code>可以很容易地规避字符串，因为可以更改该字符串。</p>
        </dd>

        <dt>解：</dt>

        <dd>
        <p>我们使用一个规则集来指定要保护的目录，并使用客户端<code>USER_AGENT</code>标识恶意或持久性机器人。</p>

        <p>在此示例中，我们阻止了一个名为<code>NameOfBadRobot</code>从一个位置<code>/secret/files</code> 。如果试图仅从特定来源阻止该用户代理，则也可以指定IP地址范围。</p>

<pre class="prettyprint lang-config">RewriteCond "%{HTTP_USER_AGENT}"   "^NameOfBadRobot"
RewriteCond "%{REMOTE_ADDR}"       "=123\.45\.67\.[8-9]"
RewriteRule "^/secret/files/"   "-"   [F]</pre>

        </dd>

      <dt>讨论：</dt>

      <dd>
      <p>无需为此使用mod_rewrite，您可以使用替代方法来完成相同的目的，如下所示：</p>
      <pre class="prettyprint lang-config">SetEnvIfNoCase User-Agent "^NameOfBadRobot" goaway
&lt;Location "/secret/files"&gt;
    &lt;RequireAll&gt;
        Require all granted
        Require not env goaway
    &lt;/RequireAll&gt;
&lt;/Location&gt;</pre>

      <p>如上所述，通过简单地修改<code>USER_AGENT</code>请求标头。如果遭受持续攻击，则应考虑在较高级别（例如在防火墙上）将其阻止。
      </p>

      </dd>

      </dl>

    </div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="host-deny" id="host-deny">拒绝黑名单中的主机</a></h2>

  

  <dl>
    <dt>描述：</dt>

    <dd>
      <p>我们希望维护一个主机黑名单，而不是像<code>hosts.deny</code> ，并阻止这些主机访问我们的服务器。</p>
    </dd>

    <dt>解：</dt>

    <dd>
<pre class="prettyprint lang-config">RewriteEngine on
RewriteMap    hosts-deny  "txt:/path/to/hosts.deny"
RewriteCond   "${hosts-deny:%{REMOTE_ADDR}|NOT-FOUND}" "!=NOT-FOUND" [OR]
RewriteCond   "${hosts-deny:%{REMOTE_HOST}|NOT-FOUND}" "!=NOT-FOUND"
RewriteRule   "^"  "-"  [F]</pre>


<div class="example"><p><code>##<br> ## hosts.deny<br> ##<br> ## ATTENTION! This is a map, not a list, even when we treat it as such.<br> ## mod_rewrite parses it for key/value pairs, so at least a<br> ## dummy value "-" must be present for each entry.<br> ##<br> <br> 193.102.180.41 -<br> bsdti1.sdm.de -<br> 192.76.162.40 -<br></code></p></div>
    </dd>

    <dt>讨论：</dt>
    <dd>
    <p>第二个RewriteCond假定您已打开HostNameLookups，以便将解析客户端IP地址。如果不是这种情况，则应删除第二个RewriteCond，然后删除<code>[OR]</code>来自第一个RewriteCond的标志。
    </p>
    </dd>
  </dl>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="referer-deflector" id="referer-deflector">基于引用者的偏转器</a></h2>

  

  <dl>
    <dt>描述：</dt>

    <dd>
      <p>根据请求来自的引荐来源重定向请求，每个引荐来源具有不同的目标。</p>
    </dd>

    <dt>解：</dt>

    <dd>
  <p>以下规则集使用映射文件将每个Referer与重定向目标相关联。</p>

<pre class="prettyprint lang-config">RewriteMap  deflector "txt:/path/to/deflector.map"

RewriteCond "%{HTTP_REFERER}" !=""
RewriteCond "${deflector:%{HTTP_REFERER}}" "=-"
RewriteRule "^" "%{HTTP_REFERER}" [R,L]

RewriteCond "%{HTTP_REFERER}" !=""
RewriteCond "${deflector:%{HTTP_REFERER}|NOT-FOUND}" "!=NOT-FOUND"
RewriteRule "^" "${deflector:%{HTTP_REFERER}}" [R,L]</pre>


      <p>映射文件列出了每个引荐来源网址的重定向目标，或者，如果我们仅希望重定向回它们的来源，则在映射中放置一个“-”：</p>

<pre class="prettyprint lang-config">##
##  deflector.map
##

http://badguys.example.com/bad/index.html    -
http://badguys.example.com/bad/index2.html   -
http://badguys.example.com/bad/index3.html   http://somewhere.example.com/</pre>


    </dd>
  </dl>

</div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>