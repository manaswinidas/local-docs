<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>mod_rewrite的高级技术-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP服务器</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> > <a href="./index.html">重写</a></div><div id="page-content"><div id="preamble"><h1>使用mod_rewrite的高级技术</h1>



<p>本文件是对<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code> <a href="../mod/mod_rewrite.html">参考文档</a> 。它使用mod_rewrite提供了一些高级技术。</p>

<div class="warning">请注意，这些示例中的许多示例在您的特定服务器配置中都不会起作用，因此，理解它们，而不只是将示例剪切并粘贴到您的配置中，这一点很重要。</div>

</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#sharding">跨多个后端的基于URL的分片</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#on-the-fly-content">即时内容再生</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#load-balancing">负载均衡</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#structuredhomedirs">结构化用户目录</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#redirectanchors">重定向锚点</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#time-dependent">时间相关的重写</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#setenvvars">根据URL部分设置环境变量</a></li>
</ul><h3>也可以看看</h3><ul class="seealso"><li><a href="../mod/mod_rewrite.html">模块文件</a></li><li><a href="intro.html">mod_rewrite简介</a></li><li><a href="remapping.html">重定向和重新映射</a></li><li><a href="access.html">控制访问</a></li><li><a href="vhosts.html">虚拟主机</a></li><li><a href="proxy.html">代理</a></li><li><a href="rewritemap.html">使用RewriteMap</a></li><li><a href="avoid.html">何时不使用mod_rewrite</a></li></ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="sharding" id="sharding">跨多个后端的基于URL的分片</a></h2>

  

  <dl>
    <dt>描述：</dt>

    <dd>
      <p>分配服务器负载或存储空间负担的常用技术称为“分片”。使用此方法时，前端服务器将使用url一致地“分片”用户或对象以分离后端服务器。</p>
    </dd>

    <dt>解：</dt>

    <dd>
      <p>在外部映射文件中维护着从用户到目标服务器的映射。他们看起来像：</p>

<div class="example"><p><code>user1 physical_host_of_user1<br> user2 physical_host_of_user2<br> : :</code></p></div>

  <p>我们将其放入<code>map.users-to-hosts</code>文件。目的是绘制地图。</p>

<div class="example"><p><code>/u/user1/anypath</code></p></div>

  <p>至</p>

<div class="example"><p><code>http://physical_host_of_user1/u/user/anypath</code></p></div>

      <p>因此，每个URL路径不必在每个后端物理主机上都有效。以下规则集借助地图文件为我们完成此操作，假设server0是默认服务器，如果用户在地图中没有任何条目，将使用该默认服务器：</p>

<pre class="prettyprint lang-config">RewriteEngine on
RewriteMap      users-to-hosts   "txt:/path/to/map.users-to-hosts"
RewriteRule   "^/u/([^/]+)/?(.*)"   "http://${users-to-hosts:$1|server0}/u/$1/$2"</pre>

    </dd>
  </dl>

  <p>见<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>有关此指令语法的更多讨论的文档。</p>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="on-the-fly-content" id="on-the-fly-content">即时内容再生</a></h2>

  

  <dl>
    <dt>描述：</dt>

    <dd>
      <p>我们希望动态生成内容，但是一旦生成内容就将其静态存储。该规则将检查静态文件是否存在，如果不存在，请生成该文件。如果需要，可以定期删除静态文件（例如，通过cron），并将按需重新生成。</p>
    </dd>

    <dt>解：</dt>

    <dd>这是通过以下规则集完成的：<pre class="prettyprint lang-config"># This example is valid in per-directory context only
RewriteCond "%{REQUEST_URI}"   "!-U"
RewriteRule "^(.+)\.html$"          "/regenerate_page.cgi"   [PT,L]</pre>


    <p>的<code>-U</code>运算符确定测试字符串（在这种情况下， <code>REQUEST_URI</code> ）是有效的网址。它通过子请求来完成。如果此子请求失败-也就是说，所请求的资源不存在-该规则将调用CGI程序<code>/regenerate_page.cgi</code> ，它会生成请求的资源并将其保存到文档目录中，以便下次请求该资源时，可以提供静态副本。</p>

    <p>这样，可以以静态形式提供不经常更新的文档。如果需要刷新文档，可以将它们从文档目录中删除，然后在下次请求时重新生成它们。</p>
    </dd>
  </dl>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="load-balancing" id="load-balancing">负载均衡</a></h2>

  

  <dl>
    <dt>描述：</dt>

    <dd>
      <p>我们希望使用mod_rewrite在多个服务器之间随机分配负载。</p>
    </dd>

    <dt>解：</dt>

    <dd>
      <p>我们将使用<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code>以及完成此任务的服务器列表。</p>

<pre class="prettyprint lang-config">RewriteEngine on
RewriteMap lb "rnd:/path/to/serverlist.txt"
RewriteRule "^/(.*)" "http://${lb:servers}/$1" [P,L]</pre>


<p><code>serverlist.txt</code>将包含服务器列表：</p>

<div class="example"><p><code>## serverlist.txt<br> <br> servers one.example.com|two.example.com|three.example.com<br></code></p></div>

<p>如果您希望一台特定的服务器获得比其他服务器更多的负载，请将其添加到列表中的次数更多。</p>

   </dd>

   <dt>讨论区</dt>
   <dd>
<p>Apache带有负载平衡模块- <code class="module"><a href="../mod/mod_proxy_balancer.html">mod_proxy_balancer</a></code> -这比使用mod_rewrite可以拼凑的任何东西都更加灵活和功能丰富。</p>
   </dd>
  </dl>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="structuredhomedirs" id="structuredhomedirs">结构化用户目录</a></h2>

  

  <dl>
    <dt>描述：</dt>

    <dd>
      <p>一些具有数千个用户的站点使用结构化的homedir布局， <em>即</em>每个homedir位于子目录中，该子目录（例如）以用户名的第一个字符开头。所以， <code>/~larry/anypath</code>是<code>/home/<strong>l</strong>/larry/public_html/anypath</code>而<code>/~waldo/anypath</code>是<code>/home/<strong>w</strong>/waldo/public_html/anypath</code> 。</p>
    </dd>

    <dt>解：</dt>

    <dd>
      <p>我们使用以下规则集将波浪号URL扩展为上述布局。</p>

<pre class="prettyprint lang-config">RewriteEngine on
RewriteRule   "^/~(<strong>([a-z])</strong>[a-z0-9]+)(.*)"  "/home/<strong>$2</strong>/$1/public_html$3"</pre>

    </dd>
  </dl>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="redirectanchors" id="redirectanchors">重定向锚点</a></h2>

  

  <dl>
    <dt>描述：</dt>

    <dd>
    <p>默认情况下，重定向到HTML锚不起作用，因为mod_rewrite会转义<code>#</code>角色，将其变成<code>%23</code> 。反过来，这破坏了重定向。</p>
    </dd>

    <dt>解：</dt>

    <dd>
      <p>使用<code>[NE]</code>标记<code>RewriteRule</code> 。NE代表不逃脱。
      </p>
    </dd>

    <dt>讨论：</dt>
    <dd>当然，该技术还可以与默认情况下使用mod_rewrite URL编码的其他特殊字符一起使用。</dd>
  </dl>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="time-dependent" id="time-dependent">时间相关的重写</a></h2>

  

  <dl>
    <dt>描述：</dt>

    <dd>
      <p>我们希望使用mod_rewrite根据一天中的时间提供不同的内容。</p>
    </dd>

    <dt>解：</dt>

    <dd>
      <p>有很多名为<code>TIME_xxx</code>用于重写条件。结合特殊的字典比较模式<code><STRING</code> ， <code>>STRING</code>和<code>=STRING</code>我们可以进行与时间有关的重定向：</p>

<pre class="prettyprint lang-config">RewriteEngine on
RewriteCond   "%{TIME_HOUR}%{TIME_MIN}" "&gt;0700"
RewriteCond   "%{TIME_HOUR}%{TIME_MIN}" "&lt;1900"
RewriteRule   "^foo\.html$"             "foo.day.html" [L]
RewriteRule   "^foo\.html$"             "foo.night.html"</pre>


      <p>这提供了内容<code>foo.day.html</code>在网址下<code>foo.html</code>从<code>07:01-18:59</code>其余时间的内容<code>foo.night.html</code> 。</p>

      <div class="warning"><code class="module"><a href="../mod/mod_cache.html">mod_cache</a></code> ，中间代理和浏览器可能各自缓存响应，并导致在配置的时间窗口之外显示任一页面。
      <code class="module"><a href="../mod/mod_expires.html">mod_expires</a></code>可以用来控制这种效果。当然，您只需要动态地提供内容并根据一天中的时间对其进行自定义，就会更好。</div>

    </dd>
  </dl>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="setenvvars" id="setenvvars">根据URL部分设置环境变量</a></h2>

  

  <dl>
    <dt>描述：</dt>

    <dd>
      <p>有时，我们希望在执行重写时保持某种状态。例如，您想记下您已经完成了重写，以便稍后可以查看是否可以通过该重写进行请求。一种方法是设置环境变量。</p>
    </dd>

    <dt>解：</dt>

    <dd>
      <p>使用[E]标志设置环境变量。</p>

<pre class="prettyprint lang-config">RewriteEngine on
RewriteRule   "^/horse/(.*)"   "/pony/$1" [E=<strong>rewritten:1</strong>]</pre>


    <p>稍后在规则集中，您可以使用RewriteCond检查此环境变量：</p>

<pre class="prettyprint lang-config">RewriteCond "%{ENV:rewritten}" "=1"</pre>


    <p>请注意，环境变量无法在外部重定向中幸免。您可以考虑使用[CO]标志来设置Cookie。</p>

    </dd>
  </dl>

</div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>