<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>动态配置的大规模虚拟主机-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP服务器</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> > <a href="./index.html">虚拟主机</a></div><div id="page-content"><div id="preamble"><h1>动态配置的大规模虚拟主机</h1>



    <p>本文档介绍了如何通过Apache HTTP Server有效地为任意数量的虚拟主机提供服务。<a href="../rewrite/vhosts.html">单独的文档</a>讨论了使用<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code>创建动态批量虚拟主机。
    </p>

</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#motivation">动机</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#overview">总览</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#simple">使用mod_vhost_alias的动态虚拟主机</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#homepages">简化的动态虚拟主机</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#combinations">在同一服务器上使用多个虚拟主机系统</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#ipbased">基于IP的更高效虚拟主机</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#rewrite">使用mod_rewrite的大量虚拟主机</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#macro">使用mod_macro批量虚拟主机</a></li>
</ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="motivation" id="motivation">动机</a></h2>

    <p>如果您的应用<code>httpd.conf</code>包含许多<code><VirtualHost></code>基本上相同的部分，例如：</p>

<pre class="prettyprint lang-config">&lt;VirtualHost 111.22.33.44&gt;
    ServerName                 customer-1.example.com
    DocumentRoot        "/www/hosts/customer-1.example.com/docs"
    ScriptAlias  "/cgi-bin/"  "/www/hosts/customer-1.example.com/cgi-bin"
&lt;/VirtualHost&gt;

&lt;VirtualHost 111.22.33.44&gt;
    ServerName                 customer-2.example.com
    DocumentRoot        "/www/hosts/customer-2.example.com/docs"
    ScriptAlias  "/cgi-bin/"  "/www/hosts/customer-2.example.com/cgi-bin"
&lt;/VirtualHost&gt;

&lt;VirtualHost 111.22.33.44&gt;
    ServerName                 customer-N.example.com
    DocumentRoot        "/www/hosts/customer-N.example.com/docs"
    ScriptAlias  "/cgi-bin/"  "/www/hosts/customer-N.example.com/cgi-bin"
&lt;/VirtualHost&gt;</pre>


    <p>我们希望替换这些倍数<code><VirtualHost></code>具有动态解决问题的机制。这具有许多优点：</p>

    <ol>
      <li>您的配置文件较小，因此Apache启动速度更快，并且使用的内存更少。也许更重要的是，较小的配置更易于维护，并且留出更少的错误空间。</li>

      <li>添加虚拟主机仅需在文件系统中创建适当的目录，并在DNS中创建条目即可-无需重新配置或重新启动Apache。</li>
    </ol>

    <p>主要缺点是每个虚拟主机不能有不同的日志文件。但是，如果您有许多虚拟主机，则由于<a href="fd-limits.html">所需的文件描述符数量众多</a> ，因此无论如何都是一个坏主意。最好<a href="../logs.html#piped">记录到管道或fifo</a> ，并在另一端安排该过程，以将每个虚拟主机的日志文件拆分为一个。可以在<a href="../programs/split-logfile.html">split-logfile</a>实用程序中找到这种过程的一个示例。</p>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="overview" id="overview">总览</a></h2>

    <p>虚拟主机由两部分信息定义：其IP地址和虚拟主机的内容。 <code>Host:</code> HTTP请求中的标头。此处使用的动态批量虚拟主机技术基于自动将此信息插入用于满足请求的文件的路径名中。使用以下命令可以最轻松地完成此操作<code class="module"><a href="../mod/mod_vhost_alias.html">mod_vhost_alias</a></code>与Apache httpd。或者， <a href="../rewrite/vhosts.html">可以使用mod_rewrite</a> 。</p>
    <p>默认情况下，这两个模块都是禁用的。如果要使用此技术，则在配置和构建Apache httpd时必须启用其中之一。</p>

    <p>为了使动态虚拟主机看起来像普通主机，需要从请求中确定几件事。最重要的是服务器名称，服务器使用它来生成自引用网址等。它使用<code>ServerName</code>指令，并且可以通过<code>SERVER_NAME</code>环境变量。运行时使用的实际值由<code class="directive"><a href="../mod/core.html#usecanonicalname">UseCanonicalName</a></code>设置。用<code>UseCanonicalName Off</code> ，服务器名称取自<code>Host:</code>请求中的标头。用<code>UseCanonicalName DNS</code> ，它取自虚拟主机IP地址的反向DNS查找。前一种设置用于基于名称的动态虚拟主机，而后一种设置用于基于IP的主机。如果httpd无法计算服务器名称，因为没有<code>Host:</code>标头，或DNS查找失败，则使用<code>ServerName</code>改为使用。</p>

    <p>要确定的另一件事是文档根目录（使用<code>DocumentRoot</code>并可以通过CGI脚本使用<code>DOCUMENT_ROOT</code>环境变量）。在正常配置中，核心模块在将URI映射到文件名时会使用它，但是当服务器配置为进行动态虚拟主机时，该工作必须由另一个模块接管（ <code class="module"><a href="../mod/mod_vhost_alias.html">mod_vhost_alias</a></code>要么<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code> ），它具有不同的映射方式。这两个模块都不负责设置<code>DOCUMENT_ROOT</code>环境变量，因此，如果任何CGI或SSI文档使用它，它们将获得误导性的价值。</p>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="simple" id="simple">使用mod_vhost_alias的动态虚拟主机</a></h2>

    <p>这是从<code>httpd.conf</code>使用以下内容实现上述“ <a href="#motivation">动机”</a>部分中概述的虚拟主机安排<code class="module"><a href="../mod/mod_vhost_alias.html">mod_vhost_alias</a></code> 。</p>

<pre class="prettyprint lang-config"># get the server name from the Host: header
UseCanonicalName Off

# this log format can be split per-virtual-host based on the first field
# using the split-logfile utility.
LogFormat "%V %h %l %u %t \"%r\" %s %b" vcommon
CustomLog "logs/access_log" vcommon

# include the server name in the filenames used to satisfy requests
VirtualDocumentRoot "/www/hosts/%0/docs"
VirtualScriptAlias  "/www/hosts/%0/cgi-bin"</pre>


    <p>只需将以下配置更改为基于IP的虚拟主机解决方案即可<code>UseCanonicalName Off</code>进入<code>UseCanonicalName DNS</code> 。然后，从虚拟主机的IP地址派生到文件名中的服务器名称。变量<code>%0</code>引用请求的服务器名，如<code>Host:</code>标头。</p>

<p>见<code class="module"><a href="../mod/mod_vhost_alias.html">mod_vhost_alias</a></code>有关更多用法示例的文档。</p>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="homepages" id="homepages">简化的动态虚拟主机</a></h2>

    <p>这是针对ISP的Web托管服务器量身定制的上述系统的调整。使用<code>%2</code> ，我们可以选择服务器名的子字符串以在文件名中使用，例如， <code>www.user.example.com</code>被发现在<code>/home/user/www</code> 。它使用一个<code>cgi-bin</code>目录，而不是每个虚拟主机一个。</p>

<pre class="prettyprint lang-config">UseCanonicalName Off

LogFormat "%V %h %l %u %t \"%r\" %s %b" vcommon
CustomLog "logs/access_log" vcommon

# include part of the server name in the filenames
VirtualDocumentRoot "/home/%2/www"

# single cgi-bin directory
ScriptAlias  "/cgi-bin/"  "/www/std-cgi/"</pre>


    <p>有更复杂的例子<code>VirtualDocumentRoot</code>中的设置<code class="module"><a href="../mod/mod_vhost_alias.html">mod_vhost_alias</a></code>文档。</p>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="combinations" id="combinations">在同一服务器上使用多个虚拟主机系统</a></h2>

    <p>通过更复杂的设置，您可以使用httpd的常规<code><VirtualHost></code>指令来控制各种虚拟主机配置的范围。例如，通过以下设置，您可以为普通客户的主页提供一个IP地址，为商业客户提供一个IP地址。这可以与常规<code><VirtualHost></code>配置部分，如下所示。</p>

<pre class="prettyprint lang-config">UseCanonicalName Off

LogFormat "%V %h %l %u %t \"%r\" %s %b" vcommon

&lt;Directory "/www/commercial"&gt;
    Options FollowSymLinks
    AllowOverride All
&lt;/Directory&gt;

&lt;Directory "/www/homepages"&gt;
    Options FollowSymLinks
    AllowOverride None
&lt;/Directory&gt;

&lt;VirtualHost 111.22.33.44&gt;
    ServerName www.commercial.example.com

    CustomLog "logs/access_log.commercial" vcommon

    VirtualDocumentRoot "/www/commercial/%0/docs"
    VirtualScriptAlias  "/www/commercial/%0/cgi-bin"
&lt;/VirtualHost&gt;

&lt;VirtualHost 111.22.33.45&gt;
    ServerName www.homepages.example.com

    CustomLog "logs/access_log.homepages" vcommon

    VirtualDocumentRoot "/www/homepages/%0/docs"
    ScriptAlias         "/cgi-bin/" "/www/std-cgi/"
&lt;/VirtualHost&gt;</pre>


<div class="note">
    <h3>注意</h3>
    <p>如果第一个虚拟主机块<em>不</em>包括<code class="directive"><a href="../mod/core.html#servername">ServerName</a></code>指令，将使用相关IP的反向DNS。如果这不是您要使用的服务器名称，则为假条目（例如。 <code>ServerName none.example.com</code> ）可以添加以解决此问题。</p>
</div>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="ipbased" id="ipbased">基于IP的更高效虚拟主机</a></h2>

    <p>建议进行配置更改，以将<a href="#simple">第一个示例</a>转换为基于IP的虚拟主机设置，从而导致设置效率低下。每个请求都需要一个新的DNS查找。为了避免这种开销，可以将文件系统安排为与IP地址相对应，而不是与主机名相对应，从而消除了DNS查找的需要。日志记录也必须进行调整以适合此系统。</p>

<pre class="prettyprint lang-config"># get the server name from the reverse DNS of the IP address
UseCanonicalName DNS

# include the IP address in the logs so they may be split
LogFormat "%A %h %l %u %t \"%r\" %s %b" vcommon
CustomLog "logs/access_log" vcommon

# include the IP address in the filenames
VirtualDocumentRootIP "/www/hosts/%0/docs"
VirtualScriptAliasIP  "/www/hosts/%0/cgi-bin"</pre>


</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="rewrite" id="rewrite">使用mod_rewrite的大量虚拟主机</a></h2>

<p>大规模虚拟主机也可以使用<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code> ，要么使用简单<code class="directive"><a href="../mod/mod_rewrite.html#rewriterule">RewriteRule</a></code>指令，或使用更复杂的技术，例如在外部存储vhost定义并通过以下方式访问它们<code class="directive"><a href="../mod/mod_rewrite.html#rewritemap">RewriteMap</a></code> 。这些技术在<a href="../rewrite/vhosts.html">重写文档中</a>进行了讨论。</p>
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="macro" id="macro">使用mod_macro批量虚拟主机</a></h2>

<p>动态生成的虚拟主机的另一种选择是<code class="module"><a href="../mod/mod_macro.html">mod_macro</a></code> ，您可以使用它创建一个虚拟主机模板，并为多个主机名调用它。模块文档的“ <strong>用法”</strong>部分提供了一个示例。
</p>
</div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>