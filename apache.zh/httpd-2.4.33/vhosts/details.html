<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>虚拟主机匹配的深入讨论-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP服务器</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> > <a href="./index.html">虚拟主机</a></div><div id="page-content"><div id="preamble"><h1>虚拟主机匹配的深入讨论</h1>



    <p>本文档试图确切地解释Apache HTTP Server在决定服务于哪个虚拟主机的请求时所执行的操作。</p>

    <p>大多数用户应该阅读有关<a href="name-based.html#namevip">与基于IP的虚拟主机为基础的名称</a>来决定他们想要使用哪种类型，然后阅读更多关于<a href="name-based.html">基于名称</a>或<a href="ip-based.html">基于IP</a> virtualhosts，然后看<a href="examples.html">一些例子</a> 。</p>

    <p>如果您想了解所有详细信息，则可以返回此页面。</p>

</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#configparsing">配置文件</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#hostmatching">虚拟主机匹配</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#tips">提示</a></li>
</ul><h3>也可以看看</h3><ul class="seealso"><li><a href="ip-based.html">基于IP的虚拟主机支持</a></li><li><a href="name-based.html">基于名称的虚拟主机支持</a></li><li><a href="examples.html">常见设置的虚拟主机示例</a></li><li><a href="mass.html">动态配置的大规模虚拟主机</a></li></ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="configparsing" id="configparsing">配置文件</a></h2>

    <p>有一个<em>主服务器</em> ，其中包含出现在外部的所有定义<code><VirtualHost></code>部分。</p>

    <p>有称为<em>vhosts的</em>虚拟服务器，由<code class="directive"><a href="../mod/core.html#virtualhost"><VirtualHost></a></code>部分。</p>

    <p>每<code>VirtualHost</code>指令包括一个或多个地址和可选端口。</p>

    <p>可以在虚拟主机定义中使用主机名代替IP地址，但是在启动时会解析它们，如果任何名称解析失败，这些虚拟主机定义将被忽略。因此，不建议这样做。</p>

    <p>该地址可以指定为<code>*</code> ，如果没有其他虚拟主机具有在其上接收到请求的显式地址，则它将与请求匹配。</p>

    <p>该地址出现在<code>VirtualHost</code>指令可以具有可选端口。如果未指定端口，则将其视为通配符端口，也可以使用来明确指示<code>*</code> 。通配符端口与任何端口匹配。</p>

    <p>（端口号在<code>VirtualHost</code>指令不影响Apache监听的端口号，它们仅控制哪个<code>VirtualHost</code>将被选择来处理请求。使用<code class="directive"><a href="../mod/mpm_common.html#listen">Listen</a></code>指令来控制服务器监听的地址和端口。）
    </p>

    <p>整个地址集（包括来自DNS查找的多个结果）统称为vhost的<em>地址集</em> 。</p>

    <p>Apache根据HTTP自动区分<code>Host</code>只要在多个虚拟主机中列出了IP地址和端口组合的最特定匹配项，客户端提供的标头。</p>

    <p>的<code class="directive"><a href="../mod/core.html#servername">ServerName</a></code>指令可能出现在服务器定义内的任何位置。但是，每个外观都会覆盖先前的外观（在该服务器内）。如果不<code>ServerName</code>指定后，服务器将尝试从服务器的IP地址推断出它。</p>

    <p>给定IP：端口对的配置文件中第一个基于名称的虚拟主机很重要，因为它用于该地址和端口上接收到的所有请求，而该IP：端口对没有其他虚拟主机具有匹配的ServerName或ServerAlias。如果服务器不支持<a class="glossarylink" href="../glossary.html#servernameindication" title="见词汇">服务器名称指示，</a>它也可用于所有SSL连接。</p>

    <p>名称中的完整列表<code>VirtualHost</code>指令被视为（非通配符） <code>ServerAlias</code> （但不会被任何<code>ServerAlias</code>声明）。</p>

    <p>为每个虚拟主机设置各种默认值。特别是：</p>

    <ol>
      <li>如果虚拟主机没有<code class="directive"><a href="../mod/core.html#serveradmin">ServerAdmin</a></code> ， <code class="directive"><a href="../mod/core.html#timeout">Timeout</a></code> ， <code class="directive"><a href="../mod/core.html#keepalivetimeout">KeepAliveTimeout</a></code> ， <code class="directive"><a href="../mod/core.html#keepalive">KeepAlive</a></code> ， <code class="directive"><a href="../mod/core.html#maxkeepaliverequests">MaxKeepAliveRequests</a></code> ， <code class="directive"><a href="../mod/mpm_common.html#receivebuffersize">ReceiveBufferSize</a></code> ， 要么<code class="directive"><a href="../mod/mpm_common.html#sendbuffersize">SendBufferSize</a></code>指令，则各自的值将从主服务器继承。（也就是说，继承自主服务器中该值的最终设置。）</li>

      <li>定义虚拟主机默认目录权限的“查找默认值”与主服务器的目录权限合并。这包括任何模块的任何按目录的配置信息。</li>

      <li>主服务器中每个模块的每服务器配置都合并到vhost服务器中。</li>
    </ol>

    <p>本质上，主服务器被视为构建每个虚拟主机的“默认值”或“基础”。但是，这些主服务器定义在config文件中的位置基本上无关紧要-当最终合并发生时，已经解析了主服务器的整个配置。因此，即使主服务器定义出现在虚拟主机定义之后，它也可能会影响虚拟主机定义。</p>

    <p>如果主服务器没有<code>ServerName</code>在这一点上，然后是该机器的主机名<code class="program"><a href="../programs/httpd.html">httpd</a></code>正在运行。我们将称呼<em>主服务器地址</em>为DNS查询返回的IP地址。 <code>ServerName</code>主服务器。</p>

    <p>对于任何未定义的<code>ServerName</code>字段中，基于名称的虚拟主机默认为在<code>VirtualHost</code>定义虚拟主机的语句。</p>

    <p>任何包含魔术的虚拟主机<code>_default_</code>通配符被赋予相同的<code>ServerName</code>作为主服务器。</p>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="hostmatching" id="hostmatching">虚拟主机匹配</a></h2>

    <p>服务器确定要用于请求的虚拟主机，如下所示：</p>

    <h3><a name="hashtable" id="hashtable">IP地址查询</a></h3>

    <p>首次在某个地址和端口上收到连接时，服务器将查找所有<code>VirtualHost</code>具有相同IP地址和端口的定义。</p>

    <p>如果地址和端口不完全匹配，则通配符（ <code>*</code> ）的比赛。</p>

    <p>如果未找到匹配项，则该请求由主服务器处理。</p>

    <p>如果有<code>VirtualHost</code>对于IP地址的定义，下一步是确定我们是否必须处理基于IP的虚拟主机或基于名称的虚拟主机。</p>

    

    <h3><a name="ipbased" id="ipbased">基于IP的虚拟主机</a></h3>

    <p>如果有一个<code>VirtualHost</code>指令列出了确定为最匹配的IP地址和端口组合，不执行其他操作，并且从匹配的虚拟主机提供请求。</p>

    

    <h3><a name="namebased" id="namebased">基于名称的虚拟主机</a></h3>

    <p>如果有多个<code>VirtualHost</code>指令列出了确定为最匹配的IP地址和端口组合，其余步骤中的“列表”指的是匹配的虚拟主机的列表，按照它们在配置文件中的顺序排列。</p>

    <p>如果连接使用SSL，则服务器支持<a class="glossarylink" href="../glossary.html#servernameindication" title="见词汇">Server Name Indication</a> ，并且SSL客户端握手包括带有请求的主机名的TLS扩展名，则该主机名在下面使用，就像<code>Host:</code>标头将用于非SSL连接。否则，地址匹配的第一个基于名称的虚拟主机将用于SSL连接。这很重要，因为虚拟主机确定服务器将使用哪个证书进行连接。</p>

    <p>如果请求中包含<code>Host:</code>标头字段，在列表中搜索具有匹配项的第一个虚拟主机<code>ServerName</code>要么<code>ServerAlias</code> ，然后从该虚拟主机提供请求。一种<code>Host:</code>标头字段可以包含端口号，但是Apache始终忽略它，并与客户端向其发送请求的实际端口相匹配。</p>

    <p>具有指定IP地址的配置文件中的第一个虚拟主机具有最高优先级，并捕获对未知服务器名称的任何请求，或者捕获没有<code>Host:</code>标头字段（例如HTTP / 1.0请求）。</p>

    

    <h3><a name="persistent" id="persistent">持久连接</a></h3>

    <p>对于特定的TCP / IP会话，上述<em>IP查找</em>仅执行<em>一次</em> ，而在KeepAlive /持久连接期间，将对<em>每个</em>请求进行<em>名称查找</em> 。换句话说，客户端可以在单个持久连接期间从不同的基于名称的虚拟主机请求页面。</p>

    

    <h3><a name="absoluteURI" id="absoluteURI">绝对URI</a></h3>

    <p>如果来自请求的URI是绝对URI，和它的主机名和端口匹配主服务器或配置的虚拟主机之一<em>并</em>匹配到客户端发送的请求，则该计划/主机名/端口前缀是地址和端口剥离后，剩余的相对URI由相应的主服务器或虚拟主机提供。如果不匹配，则URI保持不变，并且该请求被视为代理请求。</p>


<h3><a name="observations" id="observations">观察结果</a></h3>

    <ul>
      <li>基于名称的虚拟主机是在服务器选择最匹配的基于IP的虚拟主机之后应用的过程。</li>

      <li>如果您不关心客户端连接到的IP地址，请使用“ *”作为每个虚拟主机的地址，并且基于名称的虚拟主机将应用于所有已配置的虚拟主机。</li>

      <li><code>ServerName</code>和<code>ServerAlias</code>永远不会对基于IP的虚拟主机执行检查。</li>

      <li>仅特定地址集的基于名称的虚拟主机的顺序很重要。在配置文件中排在首位的基于名称的虚拟主机具有最高的优先级为其对应的地址集。</li>

      <li>中的任何端口<code>Host:</code>标头字段在匹配过程中永远不会使用。Apache始终使用客户端向其发送请求的实际端口。</li>

      <li>如果两个虚拟主机具有一个公共地址，则这些公共地址将隐式充当基于名称的虚拟主机。从2.3.11开始，这是新行为。</li>

      <li>仅当客户端连接的IP地址和端口号与任何虚拟主机（包括主机）不匹配时，主服务器才用于处理请求。 <code>*</code>虚拟主机）。换句话说，主服务器仅捕获对未指定地址/端口组合的请求（除非存在<code>_default_</code>与该端口匹配的虚拟主机）。</li>

      <li>您永远不要在<code>VirtualHost</code>指令，因为它将强制您的服务器依靠DNS进行引导。此外，如果您不控制列出的所有域的DNS，则会构成安全威胁。关于此主题以及接下来的两个主题，有<a href="../dns-caveats.html">更多</a>可用<a href="../dns-caveats.html">信息</a> 。</li>

      <li><code>ServerName</code>应该始终为每个虚拟主机设置。否则，每个虚拟主机都需要进行DNS查找。</li>
      </ul>
      

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="tips" id="tips">提示</a></h2>

    <p>除了“ <a href="../dns-caveats.html#tips">DNS问题”</a>页面上的提示之外，这里还有一些其他提示：</p>

    <ul>
      <li>将所有主服务器定义放在任何<code>VirtualHost</code>定义。（这是为了提高配置的可读性-配置后合并过程使得不清楚虚拟主机周围混合的定义可能会影响所有虚拟主机。）</li>
    </ul>

</div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>