<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>Apache HTTP Server 2.x中的请求处理-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP Server</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> > <a href="./index.html">开发人员文档</a></div><div id="page-content"><div id="preamble"><h1>Apache HTTP Server 2.x中的请求处理</h1>


    <div class="warning"><h3>警告</h3>
      <p>警告-这是第一（快速）草案，需要进一步修订！</p>
    </div>

    <p>2.0及更高版本中的一些更改会影响内部请求处理机制。模块作者需要了解这些更改，以便他们可以利用这些优化和安全性增强功能。</p>

    <p>第一个主要变化是子请求和重定向机制。Apache HTTP Server 1.3中有许多不同的代码路径，以尝试优化子请求或重定向行为。在2.0版中引入了补丁程序之后，由于这种重复代码，这些优化（以及服务器行为）很快就被破坏了。所有重复的代码均已折回<code>ap_process_request_internal()</code>以防止代码再次不同步。</p>

    <p>这意味着现有的许多代码都是“未优化的”。创建HTTP服务器RFC的可靠且正确的实现是Apache HTTP项目的首要目标。其他目标包括安全性，可伸缩性和优化。寻求了新的方法来优化服务器（超过1.3的性能），而又不引入脆弱或不安全的代码。</p>
</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#processing">请求处理周期</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#parsing">请求解析阶段</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#security">安全阶段</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#preparation">准备阶段</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#handler">处理程序阶段</a></li>
</ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="processing" id="processing">请求处理周期</a></h2>
    <p>所有请求均通过<code>ap_process_request_internal()</code>在<code>server/request.c</code> ，包括子请求和重定向。如果某个模块未通过此代码传递生成的请求，则警告作者，该模块可能会因将来对请求处理的更改而被破坏。</p>

    <p>为了简化请求，模块作者可以利用提供的<a href="./modguide.html#hooking">钩子</a>来提早退出请求周期，或者绕过无关紧要的核心钩子（在CPU方面代价高昂）。</p>
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="parsing" id="parsing">请求解析阶段</a></h2>
    <h3><a name="unescape" id="unescape">取消转义网址</a></h3>
      <p>请求的<code>parsed_uri</code>在内部请求处理开始时，一次仅对路径进行转义。</p>

      <p>如果设置了proxyreq标志，或者<code>parsed_uri.path</code>元素未设置。该模块无法对此单次转义操作进行进一步的控制，或者无法转义或多次对URL进行转义会导致安全后果。</p>
    

    <h3><a name="strip" id="strip">从URI中剥离Parent和This元素</a></h3>
      <p>所有<code>/../</code>和<code>/./</code>元素被删除<code>ap_getparents()</code> 。这有助于确保在请求处理继续之前（几乎）绝对路径。</p>

      <p>无法跳过此步骤。</p>
    

    <h3><a name="inital-location-walk" id="inital-location-walk">初始URI位置步行</a></h3>
      <p>每个请求都必须遵守<code>ap_location_walk()</code>呼叫。这样可以确保<code class="directive"><a href="../mod/core.html#location"><Location></a></code>部分对所有请求都统一执行。如果请求是内部重定向或子请求，则它可以从上一个或父请求的ap_location_walk借用部分或全部处理，因此此步骤在处理主请求后通常非常有效。</p>
    

    <h3><a name="translate_name" id="translate_name">翻译名称</a></h3>
      <p>模块可以确定文件名，或在此步骤中更改给定的URI。例如， <code class="module"><a href="../mod/mod_vhost_alias.html">mod_vhost_alias</a></code>会将URI的路径转换为已配置的虚拟主机， <code class="module"><a href="../mod/mod_alias.html">mod_alias</a></code>会将路径转换为别名路径，如果请求回退到核心，则<code class="directive"><a href="../mod/core.html#documentroot">DocumentRoot</a></code>放在请求资源之前。</p>

      <p>如果所有模块<code>DECLINE</code>在此阶段，将向浏览器返回错误500，并自动记录“无法翻译名称”错误。</p>
    

    <h3><a name="map_to_storage" id="map_to_storage">挂钩：map_to_storage</a></h3>
      <p>确定文件或正确的URI之后，将适当的每个目录配置合并在一起。例如， <code class="module"><a href="../mod/mod_proxy.html">mod_proxy</a></code>比较并合并适当的<code class="directive"><a href="../mod/mod_proxy.html#proxy"><Proxy></a></code>部分。如果URI只不过是本地的（非代理） <code>TRACE</code>请求，核心处理请求并返回<code>DONE</code> 。如果没有模块回答这个钩子<code>OK</code>要么<code>DONE</code> ，核心将针对<code class="directive"><a href="../mod/core.html#directory"><Directory></a></code>和<code class="directive"><a href="../mod/core.html#files"><Files></a></code>部分。如果请求的“文件名”不是合法的绝对文件名，则会设置注释以供以后终止。</p>
    

    <h3><a name="location-walk" id="location-walk">URI位置步行</a></h3>
      <p>每个请求都会在一秒钟内变硬<code>ap_location_walk()</code>呼叫。这样可以确保翻译后的请求仍受配置<code class="directive"><a href="../mod/core.html#location"><Location></a></code>部分。该请求再次从其先前请求中借用了部分或全部处理<code>location_walk</code>因此，除非已翻译的URI映射到实质上不同的路径或虚拟主机，否则此步骤几乎总是非常高效。</p>
    

    <h3><a name="header_parser" id="header_parser">挂钩：header_parser</a></h3>
      <p>然后，主请求解析客户端的标头。这将准备其余的请求处理步骤，以更好地服务于客户的请求。</p>
    
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="security" id="security">安全阶段</a></h2>
    <p>需要文档。代码是：</p>

    <pre class="prettyprint lang-c">if ((access_status = ap_run_access_checker(r)) != 0) {
    return decl_die(access_status, "check access", r);
}

if ((access_status = ap_run_check_user_id(r)) != 0) {
    return decl_die(access_status, "check user", r);
}

if ((access_status = ap_run_auth_checker(r)) != 0) {
    return decl_die(access_status, "check authorization", r);
}</pre>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="preparation" id="preparation">准备阶段</a></h2>
    <h3><a name="type_checker" id="type_checker">挂钩：type_checker</a></h3>
      <p>模块有机会针对目标资源测试URI或文件名，并为请求设置mime信息。都<code class="module"><a href="../mod/mod_mime.html">mod_mime</a></code>和<code class="module"><a href="../mod/mod_mime_magic.html">mod_mime_magic</a></code>使用此阶段可以将文件名或内容与管理员的配置进行比较，并设置内容类型，语言，字符集和请求处理程序。某些模块此时可能会设置其过滤器或其他请求处理参数。</p>

      <p>如果所有模块<code>DECLINE</code>在此阶段，错误500返回到浏览器，并自动记录“找不到类型”错误。</p>
    

    <h3><a name="fixups" id="fixups">挂钩：修正</a></h3>
      <p>在上面的某个阶段，许多模块被“删节了”。模块使用修正阶段来“重新声明”其所有权或将请求的字段强制为适当的值。它并不总是最干净的机制，但有时是唯一的选择。</p>
    
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="handler" id="handler">处理程序阶段</a></h2>
    <p>此阶段<strong>不</strong>属于<code>ap_process_request_internal()</code> 。许多模块在创建任何内容之前都会准备一个或多个子请求。后核心，还是模块调用<code>ap_process_request_internal()</code>然后它调用<code>ap_invoke_handler()</code>生成请求。</p>

    <h3><a name="insert_filter" id="insert_filter">挂钩：insert_filter</a></h3>
      <p>以某种方式转换内容的模块可以插入其值并覆盖现有过滤器，这样，如果用户无序配置了更高级的过滤器，则该模块可以根据需要移动其顺序。没有结果代码，因此最好信任此挂钩中的操作以始终成功。</p>
    

    <h3><a name="hook_handler" id="hook_handler">挂钩：处理程序</a></h3>
      <p>该模块最终有机会在其处理程序挂钩中处理该请求。请注意，并非每个准备好的请求都发送到处理程序挂钩。许多模块，例如<code class="module"><a href="../mod/mod_autoindex.html">mod_autoindex</a></code>会为给定的URI创建子请求，然后再不提供该子请求，而只是为用户列出该子请求。切记不要将上面的钩子所需的拆解放入该模块中，而应在请求池中注册池清理以根据需要释放资源。</p>
    
</div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>