<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>Apache HTTP Server 2.x线程安全问题-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP Server</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> > <a href="./index.html">开发人员文档</a></div><div id="page-content"><div id="preamble"><h1>Apache HTTP Server 2.x线程安全问题</h1>


    <p>在Apache HTTP Server 2.x中使用任何线程mpms时，从Apache调用的每个函数都是线程安全的，这一点很重要。链接第3方扩展时，可能很难确定结果服务器是否是线程安全的。随便测试通常也不会告诉您这两种情况，因为线程安全性问题可能导致微妙的竞争状况，而这种竞争状况仅在重载下的某些状况下才会出现。</p>
</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#variables">全局和静态变量</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#errno">埃尔诺</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#functions">常见标准麻烦功能</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#commonlibs">通用第三方图书馆</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#liblist">图书馆清单</a></li>
</ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="variables" id="variables">全局和静态变量</a></h2>
    <p>在编写模块或尝试确定模块或第三方库是否是线程安全的时，请记住一些常见的事项。</p>

    <p>首先，您需要认识到在线程模型中，每个单独的线程都有其自己的程序计数器，堆栈和寄存器。局部变量位于堆栈上，因此可以。您需要注意任何静态或全局变量。这并不意味着绝对不允许您使用静态或全局变量。有时候您确实希望某些东西影响所有线程，但是如果您希望代码是线程安全的，通常就需要避免使用它们。</p>

    <p>如果您有一个需要全局变量并被所有线程访问的全局变量，则在更新它时要非常小心。例如，如果它是一个递增计数器，则需要自动对其进行递增，以避免与其他线程发生竞争。您可以使用互斥锁（互斥）来执行此操作。锁定互斥锁，读取当前值，将其递增并写回，然后解锁互斥锁。任何其他想要修改该值的线程都必须首先检查互斥量并阻塞，直到将其清除为止。</p>

    <p>如果您使用的是<a href="http://apr.apache.org/">APR</a> ，请查看<code>apr_atomic_<var>*</var></code>功能和<code>apr_thread_mutex_<var>*</var></code>功能。</p>
    
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="errno" id="errno">埃尔诺</a></h2>
    <p>这是一个通用全局变量，用于保存最近发生的错误的错误号。如果一个线程调用设置errno的低级函数，然后另一个线程对其进行检查，则我们会将错误号从一个线程渗入另一个线程。要解决此问题，请确保您的模块或库定义<code>_REENTRANT</code>或使用<code>-D_REENTRANT</code> 。这将使errno成为每个线程的变量，并有望对代码透明。它通过执行以下操作来做到这一点：</p>

    <div class="example"><p><code>#define errno (*(__errno_location()))</code></p></div>

    <p>这意味着访问errno将调用<code>__errno_location()</code>这是由libc提供的。设置<code>_REENTRANT</code>也迫使他们重新定义了一些其他功能<code><var>*</var>_r</code>等同物，有时会改变共同点<code>getc</code> / <code>putc</code>宏转换为更安全的函数调用。检查您的libc文档以了解详细信息。代替或补充<code>_REENTRANT</code>可能影响此的符号是<code>_POSIX_C_SOURCE</code> ， <code>_THREAD_SAFE</code> ， <code>_SVID_SOURCE</code>和<code>_BSD_SOURCE</code> 。</p>
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="functions" id="functions">常见标准麻烦功能</a></h2>
    <p>事情不仅必须是线程安全的，而且还必须是可重入的。 <code>strtok()</code>是显而易见的。您第一次使用分隔符来调用它，然后它会记住该分隔符，并且在随后的每次调用中，它将返回下一个标记。显然，如果有多个线程在调用它，您将遇到问题。大多数系统都具有该函数的可重入版本<code>strtok_r()</code>您传入一个额外的参数，其中包含已分配的<code>char *</code>函数将使用它来代替其自己的静态存储来维护令牌化状态。如果您使用的是<a href="http://apr.apache.org/">APR</a> ，则可以使用<code>apr_strtok()</code> 。</p>

    <p><code>crypt()</code>是另一个倾向于不可重入的函数，因此，如果您在库中遇到对该函数的调用，请当心。在某些系统上，它是可重入的，因此并不总是一个问题。如果您的系统有<code>crypt_r()</code>您应该使用它，或者如果可能的话，只需使用md5来避免整个混乱。</p>
    
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="commonlibs" id="commonlibs">通用第三方图书馆</a></h2>
    <p>以下是第三方Apache模块使用的常见库的列表。您可以使用以下工具检查模块是否正在使用潜在不安全的库<code>ldd(1)</code>和<code>nm(1)</code> 。例如，对于<a href="http://www.php.net/">PHP</a> ，请尝试以下操作：</p>

    <div class="example"><p><code>% ldd libphp4.so<br> libsablot.so.0 => /usr/local/lib/libsablot.so.0 (0x401f6000)<br> libexpat.so.0 => /usr/lib/libexpat.so.0 (0x402da000)<br> libsnmp.so.0 => /usr/lib/libsnmp.so.0 (0x402f9000)<br> libpdf.so.1 => /usr/local/lib/libpdf.so.1 (0x40353000)<br> libz.so.1 => /usr/lib/libz.so.1 (0x403e2000)<br> libpng.so.2 => /usr/lib/libpng.so.2 (0x403f0000)<br> libmysqlclient.so.11 => /usr/lib/libmysqlclient.so.11 (0x40411000)<br> libming.so => /usr/lib/libming.so (0x40449000)<br> libm.so.6 => /lib/libm.so.6 (0x40487000)<br> libfreetype.so.6 => /usr/lib/libfreetype.so.6 (0x404a8000)<br> libjpeg.so.62 => /usr/lib/libjpeg.so.62 (0x404e7000)<br> libcrypt.so.1 => /lib/libcrypt.so.1 (0x40505000)<br> libssl.so.2 => /lib/libssl.so.2 (0x40532000)<br> libcrypto.so.2 => /lib/libcrypto.so.2 (0x40560000)<br> libresolv.so.2 => /lib/libresolv.so.2 (0x40624000)<br> libdl.so.2 => /lib/libdl.so.2 (0x40634000)<br> libnsl.so.1 => /lib/libnsl.so.1 (0x40637000)<br> libc.so.6 => /lib/libc.so.6 (0x4064b000)<br> /lib/ld-linux.so.2 => /lib/ld-linux.so.2 (0x80000000)</code></p></div>

    <p>除了这些库之外，您还需要查看静态链接到模块中的所有库。您可以使用<code>nm(1)</code>在模块中查找单个符号。</p>
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="liblist" id="liblist">图书馆清单</a></h2>
    <p>如果您对此列表进行了补充或更正，请在<a href="http://httpd.apache.org/lists.html#http-dev">dev@httpd.apache.org</a>上添加注释。</p>

    <table class="bordered"><tbody><tr class="header"><th>图书馆</th><th>版</th><th>线程安全吗？</th><th>笔记</th></tr>
<tr><td><a href="http://aspell.sourceforge.net/">拼写/拼写</a></td>
        <td> </td>
        <td>？</td>
        <td> </td></tr>
<tr class="odd"><td><a href="http://www.sleepycat.com/">伯克利DB</a></td>
        <td>3.x，4.x</td>
        <td>是</td>
        <td>跨线程共享连接时要小心。</td></tr>
<tr><td><a href="http://sources.redhat.com/bzip2/index.html">bzip2</a></td>
        <td> </td>
        <td>是</td>
        <td>低级和高级API都是线程安全的。但是，高级API需要对errno进行线程安全的访问。</td></tr>
<tr class="odd"><td><a href="http://cr.yp.to/cdb.html">数据库</a></td>
        <td> </td>
        <td>？</td>
        <td> </td></tr>
<tr><td><a href="http://www.washington.edu/imap/">客户</a></td>
        <td> </td>
        <td>也许</td>
        <td>客户使用<code>strtok()</code>和<code>gethostbyname()</code>在大多数C库实现中不是线程安全的。 c客户端的静态数据旨在跨线程共享。如果<code>strtok()</code>和<code>gethostbyname()</code>在您的操作系统上是线程安全的，c-client <em>可能</em>是线程安全的。</td></tr>
<tr class="odd"><td><a href="http://www.ijg.org/files/">libcrypt的</a></td>
        <td> </td>
        <td>？</td>
        <td> </td></tr>
<tr><td><a href="http://expat.sourceforge.net/">外籍人士</a></td>
        <td> </td>
        <td>是</td>
        <td>每个线程需要一个单独的解析器实例</td></tr>
<tr class="odd"><td><a href="http://www.freetds.org/">FreeTDS</a></td>
        <td> </td>
        <td>？</td>
        <td> </td></tr>
<tr><td><a href="http://www.freetype.org/">自由类型</a></td>
        <td> </td>
        <td>？</td>
        <td> </td></tr>
<tr class="odd"><td><a href="http://www.boutell.com/gd/">GD 1.8.x</a></td>
        <td> </td>
        <td>？</td>
        <td> </td></tr>
<tr><td><a href="http://www.boutell.com/gd/">GD 2.0.x</a></td>
        <td> </td>
        <td>？</td>
        <td> </td></tr>
<tr class="odd"><td><a href="http://www.gnu.org/software/gdbm/gdbm.html">gdbm</a></td>
        <td> </td>
        <td>没有</td>
        <td>通过静态返回的错误<code>gdbm_error</code>变量</td></tr>
<tr><td><a href="http://www.imagemagick.org/">图像魔术</a></td>
        <td>5.2.2</td>
        <td>是</td>
        <td>ImageMagick文档声称它从5.2.2版本开始是线程安全的（请参阅<a href="http://www.imagemagick.com/www/changelog.html">更改日志</a> ）。
        </td></tr>
<tr class="odd"><td><a href="http://www.enlightenment.org/p.php?p=about/efl&l=en">Imlib2</a></td>
        <td> </td>
        <td>？</td>
        <td> </td></tr>
<tr><td><a href="http://www.ijg.org/files/">libjpeg</a></td>
        <td>v6b</td>
        <td>？</td>
        <td> </td></tr>
<tr class="odd"><td><a href="http://mysql.com">libmysql客户端</a></td>
        <td> </td>
        <td>是</td>
        <td>使用mysqlclient_r库变量来确保线程安全。有关更多信息，请阅读<a href="http://dev.mysql.com/doc/mysql/en/Threaded_clients.html">http://dev.mysql.com/doc/mysql/en/Threaded_clients.html</a> 。</td></tr>
<tr><td><a href="http://www.opaque.net/ming/">明</a></td>
        <td>0.2a</td>
        <td>？</td>
        <td> </td></tr>
<tr class="odd"><td><a href="http://net-snmp.sourceforge.net/">网络SNMP</a></td>
        <td>5.0.x</td>
        <td>？</td>
        <td> </td></tr>
<tr><td><a href="http://www.openldap.org/">OpenLDAP</a></td>
        <td>2.1.x</td>
        <td>是</td>
        <td>使用<code>ldap_r</code>库变量以确保线程安全。</td></tr>
<tr class="odd"><td><a href="http://www.openssl.org/">的OpenSSL</a></td>
        <td>0.9.6克</td>
        <td>是</td>
        <td>需要正确使用<code>CRYPTO_num_locks</code> ， <code>CRYPTO_set_locking_callback</code> ，<code>CRYPTO_set_id_callback</code></td></tr>
<tr><td><a href="http://www.oracle.com/">liboci8（Oracle 8+）</a></td>
        <td>8.x，9.x</td>
        <td>？</td>
        <td> </td></tr>
<tr class="odd"><td><a href="http://pdflib.com/">pdflib</a></td>
        <td>5.0.x</td>
        <td>是</td>
        <td>PDFLib文档声称它是线程安全的； changes.txt表示自V1.91起，它已部分处于线程安全状态： <a href="http://www.pdflib.com/products/pdflib-family/pdflib/">http</a> ://www.pdflib.com/products/pdflib-family/pdflib/。</td></tr>
<tr><td><a href="http://www.libpng.org/pub/png/libpng.html">libpng</a></td>
        <td>1.0.x</td>
        <td>？</td>
        <td> </td></tr>
<tr class="odd"><td><a href="http://www.libpng.org/pub/png/libpng.html">libpng</a></td>
        <td>1.2.x</td>
        <td>？</td>
        <td> </td></tr>
<tr><td><a href="http://www.postgresql.org/docs/8.4/static/libpq-threading.html">libpq（PostgreSQL）</a></td>
        <td>8.x</td>
        <td>是</td>
        <td>不要跨线程共享连接并当心<code>crypt()</code>来电</td></tr>
<tr class="odd"><td><a href="http://www.gingerall.com/charlie/ga/xml/p_sab.xml">萨勃龙</a></td>
        <td>0.95</td>
        <td>？</td>
        <td></td></tr>
<tr><td><a href="http://www.gzip.org/zlib/">zlib</a></td>
        <td>1.1.4</td>
        <td>是</td>
        <td>依赖于线程安全的zalloc和zfree函数默认情况下使用线程安全的libc的calloc / free。</td></tr>
</tbody></table>
</div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>