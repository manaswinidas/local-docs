<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>将模块从Apache 1.3转换为Apache 2.0-Apache HTTP Server版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP Server</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="../index.html">版本2.4</a> > <a href="./index.html">开发人员文档</a></div><div id="page-content"><div id="preamble"><h1>将模块从Apache 1.3转换为Apache 2.0</h1>


    <p>这是尝试写我在尝试转换课程时学到的课程的第一次尝试<code>mod_mmap_static</code> Apache 2.0的模块。这绝不是确定的，在某些方面甚至可能都不正确，但这只是一个开始。</p>
</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="../images/down.gif"> <a href="#easy">更容易的改变...</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#messy">信使发生了变化...</a></li>
</ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="easy" id="easy">更容易的改变...</a></h2>

    <h3><a name="cleanup" id="cleanup">清理程序</a></h3>
      <p>这些现在必须是类型<code>apr_status_t</code>并返回该类型的值。通常，返回值为<code>APR_SUCCESS</code>除非有必要发出清除错误的信号。请注意，即使您发出错误信号，也并非所有代码都会检查错误并采取措施。</p>
    

    <h3><a name="init" id="init">初始化程序</a></h3>
      <p>现在应将其重命名，以更好地表明它们在整个过程中所处的位置。因此名称从<code>mmap_init</code>至<code>mmap_post_config</code> 。通过的论点发生了根本变化，现在看起来像</p>

      <ul>
        <li><code>apr_pool_t *p</code></li>
        <li><code>apr_pool_t *plog</code></li>
        <li><code>apr_pool_t *ptemp</code></li>
        <li><code>server_rec *s</code></li>
      </ul>
    

    <h3><a name="datatypes" id="datatypes">资料类型</a></h3>
      <p>许多数据类型已移至<a href="http://apr.apache.org/">APR中</a> 。这意味着某些名称已更改，例如上面显示的名称。以下是您可能需要进行的一些更改的简要列表。</p>

      <ul>
        <li><code>pool</code>变成<code>apr_pool_t</code></li>
        <li><code>table</code>变成<code>apr_table_t</code></li>
      </ul>
    
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="messy" id="messy">信使发生了变化...</a></h2>

    <h3><a name="register-hooks" id="register-hooks">注册钩子</a></h3>
      <p>新的体系结构使用一系列挂钩来调用您的函数。您需要通过新功能将这些添加到模块中， <code>static void register_hooks(void)</code> 。一旦您了解需要完成的功能，该功能实际上就相当简单。在请求处理的某个阶段需要调用的每个函数都需要注册，而处理程序则不需要。可以在多个阶段添加函数，对于每个阶段，您都可以高度控制地指定将调用函数的相对顺序。</p>

      <p>这是添加到的代码<code>mod_mmap_static</code> ：</p>
      <div class="example"><pre>static void register_hooks(void)
{
    static const char * const aszPre[]={ "http_core.c",NULL };
    ap_hook_post_config(mmap_post_config,NULL,NULL,HOOK_MIDDLE);
    ap_hook_translate_name(mmap_static_xlat,aszPre,NULL,HOOK_LAST);
};</pre></div>

      <p>这注册了两个需要调用的函数，其中一个<code>post_config</code>阶段（实际上每个模块都需要这个模块）和一个<code>translate_name</code>相。请注意，尽管函数名称不同，但每个函数的格式是相同的。那是什么格式？</p>

      <div class="example"><p><code>ap_hook_<var>phase_name</var>(<var>function_name</var>, <var>predecessors</var>, <var>successors</var>, <var>position</var>);</code></p></div>

      <p>定义了3个挂钩位置...</p>

      <ul>
        <li><code>HOOK_FIRST</code></li>
        <li><code>HOOK_MIDDLE</code></li>
        <li><code>HOOK_LAST</code></li>
      </ul>

      <p>要定义位置，请使用该位置，然后使用前任和后继进行修改。每个修饰符都可以是在函数运行之前（前继）或函数运行之后（后继）应调用的函数的列表。</p>

      <p>在里面<code>mod_mmap_static</code>如果我不在乎<code>post_config</code>阶段，但<code>mmap_static_xlat</code> <strong>必须</strong>在核心模块完成名称转换后调用，因此使用aszPre来定义位置的修饰符<code>HOOK_LAST</code> 。</p>
    

    <h3><a name="moddef" id="moddef">模块定义</a></h3>
      <p>现在，在创建模块定义时无需担心很多步骤。旧的定义看起来像</p>

      <div class="example"><pre>module MODULE_VAR_EXPORT <var>module_name</var>_module =
{
    STANDARD_MODULE_STUFF,
    /* initializer */
    /* dir config creater */
    /* dir merger --- default is to override */
    /* server config */
    /* merge server config */
    /* command handlers */
    /* handlers */
    /* filename translation */
    /* check_user_id */
    /* check auth */
    /* check access */
    /* type_checker */
    /* fixups */
    /* logger */
    /* header parser */
    /* child_init */
    /* child_exit */
    /* post read-request */
};</pre></div>

      <p>新结构要简单得多。</p>
      <div class="example"><pre>module MODULE_VAR_EXPORT <var>module_name</var>_module =
{
    STANDARD20_MODULE_STUFF,
    /* create per-directory config structures */
    /* merge per-directory config structures  */
    /* create per-server config structures    */
    /* merge per-server config structures     */
    /* command handlers */
    /* handlers */
    /* register hooks */
};</pre></div>

      <p>其中有些直接读懂，有些则不然。我将尝试总结下面应该做的事情。</p>

      <p>直接读取的阶段：</p>

      <dl>
        <dt><code>/* dir config creater */</code></dt>
        <dd><code>/* create per-directory config structures */</code></dd>

        <dt><code>/* server config */</code></dt>
        <dd><code>/* create per-server config structures */</code></dd>

        <dt><code>/* dir merger */</code></dt>
        <dd><code>/* merge per-directory config structures */</code></dd>

        <dt><code>/* merge server config */</code></dt>
        <dd><code>/* merge per-server config structures */</code></dd>

        <dt><code>/* command table */</code></dt>
        <dd><code>/* command apr_table_t */</code></dd>

        <dt><code>/* handlers */</code></dt>
        <dd><code>/* handlers */</code></dd>
      </dl>

      <p>其余的旧功能应注册为钩子。到目前为止，定义了以下钩子阶段...</p>

      <dl>
        <dt><code>ap_hook_pre_config</code></dt>
        <dd>在处理配置指令之前进行任何所需的设置</dd>

        <dt><code>ap_hook_check_config</code></dt>
        <dd>查看配置指令的相互依赖性</dd>

        <dt><code>ap_hook_test_config</code></dt>
        <dd>仅执行<code>-t</code>选项</dd>

        <dt><code>ap_hook_open_logs</code></dt>
        <dd>打开任何指定的日志</dd>

        <dt><code>ap_hook_post_config</code></dt>
        <dd>这是老地方<code>_init</code>例程被注册</dd>

        <dt><code>ap_hook_http_method</code></dt>
        <dd>从请求中检索http方法。 （遗产）</dd>

        <dt><code>ap_hook_auth_checker</code></dt>
        <dd>检查资源是否需要授权</dd>

        <dt><code>ap_hook_access_checker</code></dt>
        <dd>检查特定于模块的限制</dd>

        <dt><code>ap_hook_check_user_id</code></dt>
        <dd>检查用户名和密码</dd>

        <dt><code>ap_hook_default_port</code></dt>
        <dd>检索服务器的默认端口</dd>

        <dt><code>ap_hook_pre_connection</code></dt>
        <dd>在处理之前但在接受之后进行所需的任何设置</dd>

        <dt><code>ap_hook_process_connection</code></dt>
        <dd>运行正确的协议</dd>

        <dt><code>ap_hook_child_init</code></dt>
        <dd>孩子刚开始就打电话</dd>

        <dt><code>ap_hook_create_request</code></dt>
        <dd>??</dd>

        <dt><code>ap_hook_fixups</code></dt>
        <dd>在生成内容之前修改内容的最后机会</dd>

        <dt><code>ap_hook_handler</code></dt>
        <dd>产生内容</dd>

        <dt><code>ap_hook_header_parser</code></dt>
        <dd>让模块查看大多数模块不使用的标头，因为它们使用<code>post_read_request</code>为了这</dd>

        <dt><code>ap_hook_insert_filter</code></dt>
        <dd>将过滤器插入过滤器链</dd>

        <dt><code>ap_hook_log_transaction</code></dt>
        <dd>记录有关请求的信息</dd>

        <dt><code>ap_hook_optional_fn_retrieve</code></dt>
        <dd>检索注册为可选的任何功能</dd>

        <dt><code>ap_hook_post_read_request</code></dt>
        <dd>在读取请求之后，在任何其他阶段之前调用</dd>

        <dt><code>ap_hook_quick_handler</code></dt>
        <dd>在任何请求处理之前调用，由缓存模块使用。</dd>

        <dt><code>ap_hook_translate_name</code></dt>
        <dd>将URI转换为文件名</dd>

        <dt><code>ap_hook_type_checker</code></dt>
        <dd>确定和/或设置文档类型</dd>
      </dl>
    
</div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>