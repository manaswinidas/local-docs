<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>mod_dbd-Apache HTTP服务器版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body >
<div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="&lt;-" alt="&lt;-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> &gt; <a href="http://httpd.apache.org/">HTTP服务器</a> &gt; <a href="http://httpd.apache.org/docs/">文档</a> &gt; <a href="../index.html">版本2.4</a> &gt; <a href="./index.html">模块</a></div>
<div id="page-content">
<div id="preamble"><h1>Apache模块mod_dbd</h1>

<table class="module"><tr><th><a href="module-dict.html#Description">描述：</a></th><td>管理SQL数据库连接</td></tr>
<tr><th><a href="module-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="module-dict.html#ModuleIdentifier">模块�标识符：</a></th><td>dbd_module</td></tr>
<tr><th><a href="module-dict.html#SourceFile">源文件：</a></th><td>mod_dbd.c</td></tr>
<tr><th><a href="module-dict.html#Compatibility">兼容性：</a></th><td>2.1版及更高版本</td></tr></table>
<h3>摘要</h3>

    <p><code class="module"><a href="../mod/mod_dbd.html">mod_dbd</a></code>使用<a class="glossarylink" href="../glossary.html#apr" title="见词汇">APR</a>管理SQL数据库连接。它根据需要提供与需要SQL数据库功能的模块的数据库连接，并负责以最佳效率和可伸缩性管理线程和非线程MPM的数据库。有关详细信息，请参见<a href="http://apr.apache.org/">APR</a>网站和原始开发人员对<a href="http://people.apache.org/~niq/dbd.html">Apache DBD Framework</a>的概述。
</p>
</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><h3>话题</h3>
<ul id="topics">
<li><img alt="" src="../images/down.gif"> <a href="#pooling">连接池</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#connecting">连接中</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#API">Apache DBD API</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#prepared">SQL预备语句</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#security">安全警告</a></li>
</ul><h3 class="directives">指令</h3>
<ul id="toc">
<li><img alt="" src="../images/down.gif"> <a href="#dbdexptime">DBDExptime</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#dbdinitsql">DBDInitSQL</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#dbdkeep">DBDKeep</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#dbdmax">DBDMax</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#dbdmin">DBDMin</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#dbdparams">DBDParams</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#dbdpersist">DBDPersist</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#dbdpreparesql">DBDPrepareSQL</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#dbdriver">DBDriver</a></li>
</ul>
<h3>错误修正清单</h3><ul class="seealso"><li><a href="https://www.apache.org/dist/httpd/CHANGES_2.4">httpd更新日志</a></li><li><a href="https://bz.apache.org/bugzilla/buglist.cgi?bug_status=__open__&amp;list_id=144532&amp;product=Apache httpd-2&amp;query_format=specific&amp;order=changeddate DESC%2Cpriority%2Cbug_severity&amp;component=mod_dbd">已知的问题</a></li><li><a href="https://bz.apache.org/bugzilla/enter_bug.cgi?product=Apache httpd-2&amp;component=mod_dbd">报告错误</a></li></ul><h3>也可以看看</h3>
<ul class="seealso">
<li><a href="../misc/password_encryptions.html">密码格式</a></li>
</ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="pooling" id="pooling">连接池</a></h2>
    <p>该模块以针对平台优化的方式管理数据库连接。在非线程平台上，它以经典LAMP（Linux，Apache，Mysql，Perl / PHP / Python）的方式提供持久连接。在线程平台上，它提供了一个整体上更具可扩展性和效率的<em>连接池</em> ，如<a href="http://www.apachetutor.org/dev/reslist">本文在ApacheTutor上所述</a> 。请注意， <code class="module"><a href="../mod/mod_dbd.html">mod_dbd</a></code>取代了该文章中介绍的模块。</p>
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="connecting" id="connecting">连接中</a></h2>

    <p>要连接到数据库，您需要指定驱动程序和连接参数。这些因一个数据库引擎而异。例如，要连接到mysql，请执行以下操作：</p>

<pre class="prettyprint lang-config">DBDriver mysql
DBDParams host=localhost,dbname=pony,user=shetland,pass=appaloosa</pre>


    <p>然后，您可以在各种其他模块中使用此连接，包括<code class="module"><a href="../mod/mod_rewrite.html">mod_rewrite</a></code> ， <code class="module"><a href="../mod/mod_authn_dbd.html">mod_authn_dbd</a></code>和<code class="module"><a href="../mod/mod_lua.html">mod_lua</a></code> 。这些模块的每个文档中都提供了更多的用法示例。</p>

    <p>有关每个受支持的数据库驱动程序的连接字符串信息，请参见<code class="directive">DBDParams</code> 。</p>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="API" id="API">Apache DBD API</a></h2>
    <p><code class="module"><a href="../mod/mod_dbd.html">mod_dbd</a></code>导出五个函数供其他模块使用。API如下：</p>

<pre class="prettyprint lang-c">typedef struct {
    apr_dbd_t *handle;
    apr_dbd_driver_t *driver;
    apr_hash_t *prepared;
} ap_dbd_t;

/* Export functions to access the database */

/* acquire a connection that MUST be explicitly closed.
 * Returns NULL on error
 */
AP_DECLARE(ap_dbd_t*) ap_dbd_open(apr_pool_t*, server_rec*);

/* release a connection acquired with ap_dbd_open */
AP_DECLARE(void) ap_dbd_close(server_rec*, ap_dbd_t*);

/* acquire a connection that will have the lifetime of a request
 * and MUST NOT be explicitly closed.  Return NULL on error.
 * This is the preferred function for most applications.
 */
AP_DECLARE(ap_dbd_t*) ap_dbd_acquire(request_rec*);

/* acquire a connection that will have the lifetime of a connection
 * and MUST NOT be explicitly closed.  Return NULL on error.
 */
AP_DECLARE(ap_dbd_t*) ap_dbd_cacquire(conn_rec*);

/* Prepare a statement for use by a client module */
AP_DECLARE(void) ap_dbd_prepare(server_rec*, const char*, const char*);

/* Also export them as optional functions for modules that prefer it */
APR_DECLARE_OPTIONAL_FN(ap_dbd_t*, ap_dbd_open, (apr_pool_t*, server_rec*));
APR_DECLARE_OPTIONAL_FN(void, ap_dbd_close, (server_rec*, ap_dbd_t*));
APR_DECLARE_OPTIONAL_FN(ap_dbd_t*, ap_dbd_acquire, (request_rec*));
APR_DECLARE_OPTIONAL_FN(ap_dbd_t*, ap_dbd_cacquire, (conn_rec*));
APR_DECLARE_OPTIONAL_FN(void, ap_dbd_prepare, (server_rec*, const char*, const char*));</pre>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="prepared" id="prepared">SQL预备语句</a></h2>
    <p><code class="module"><a href="../mod/mod_dbd.html">mod_dbd</a></code>代表可能希望使用它们的模块支持SQL <code class="module"><a href="../mod/mod_dbd.html">mod_dbd</a></code>准备语句。每个准备好的声明中必须指定一个名称（标签），并将它们存储在哈希：在<code>prepared</code>一个领域<code>ap_dbd_t</code> 。哈希条目的类型为<code>apr_dbd_prepared_t</code> ，可以在任何apr_dbd准备语句SQL查询或选择命令中使用。</p>

    <p>dbd用户模块可以使用准备好的语句并记录可以在httpd.conf中指定的语句，或者提供自己的指令并使用<code>ap_dbd_prepare</code> 。</p>
	
	<div class="warning"><h3>警告</h3>当将预备语句与MySQL数据库一起使用时，最好在连接字符串中将<code>reconnect</code>设置为0，以避免由于MySQL客户端重新连接而未正确重置预备语句而引起的错误。如果设置为1，将尝试修复所有断开的连接，但是由于未通知mod_dbd，因此准备好的语句将无效。
	</div>
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="security" id="security">安全警告</a></h2>

    <p>任何Web /数据库应用程序都需要保护自己免受SQL注入攻击。在大多数情况下，Apache DBD是安全的，因为应用程序使用预准备的语句，而不受信任的输入仅用作数据。当然，如果通过第三方模块使用它，则应确定它们可能需要采取哪些预防措施。</p>
    <p>但是， <var>FreeTDS</var>驱动程序本质上是<strong>不安全的</strong> 。基础库不支持准备好的语句，因此驱动程序会对其进行仿真，并将不受信任的输入合并到SQL语句中。</p>
    <p>可以通过<em>取消</em>所有输入的<em>限制</em>来确保它的安全：这是受Perl的污染检查启发的过程。根据Perl习惯用法，每个输入都与一个正则表达式匹配，并且仅使用匹配项：</p>
    <div class="example"><pre><code>  $untrusted =~ /([a-z]+)/;
  $trusted = $1;</code></pre></div>
    <p>要使用此功能，必须在配置的准备好的语句中包含无限制的正则表达式。regexp紧跟在prepared语句中％之后，并用大括号{}括起来。例如，如果您的应用程序需要字母数字输入，则可以使用：</p>
    <div class="example"><p><code>
       <code>“ SELECT foo FROM条在哪里输入=％s”</code>
    </code></p></div>
    <p>与其他驱动程序一起使用，并且不会比查询失败更糟糕。但是使用FreeTDS，您需要：</p>
    <div class="example"><p><code>
       <code>“从输入的WHERE条中选择SELECT foo =％{（[[A-Za-z0-9] +）} s”</code>
    </code></p></div>
    <p>现在，所有与regexp的$ 1不匹配的内容都将被丢弃，因此该语句很安全。</p>
    <p>一种替代方法是第三方ODBC驱动程序，它提供了真正的预备语句的安全性。</p>
</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="DBDExptime" id="DBDExptime">DBDExptime</a> <a name="dbdexptime" id="dbdexptime">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>空闲连接的存活时间</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>DBDExptime <var>秒时间</var></code></td></tr>
<tr><th><a href="directive-dict.html#Default">默认：</a></th><td><code>DBDExptime 300</code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_dbd</td></tr>
</table>
    <p>设置超过DBDKeep中指定的连接数（仅线程平台）时保持空闲连接活动的时间。</p>

</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="DBDInitSQL" id="DBDInitSQL">DBDInitSQL</a> <a name="dbdinitsql" id="dbdinitsql">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>连接到数据库后执行SQL语句</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>DBDInitSQL <var>“ SQL语句”</var></code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_dbd</td></tr>
</table>
    <p>创建与数据库的连接时，需要的模块可以执行一个或多个SQL语句。用法的示例可能是初始化某些值或在与数据库建立新连接时添加日志条目。</p>

</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="DBDKeep" id="DBDKeep">DBDKeep</a> <a name="dbdkeep" id="dbdkeep">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>最大持续连接数</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>DBDKeep <var>编号</var></code></td></tr>
<tr><th><a href="directive-dict.html#Default">默认：</a></th><td><code>DBDKeep 2</code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_dbd</td></tr>
</table>
    <p>设置每个进程要维持的最大连接数，而不是用于处理高峰需求（仅线程平台）。</p>

</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="DBDMax" id="DBDMax">DBDMax</a> <a name="dbdmax" id="dbdmax">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>最大连接数</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>DBDMax <var>号</var></code></td></tr>
<tr><th><a href="directive-dict.html#Default">默认：</a></th><td><code>DBDMax 10</code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_dbd</td></tr>
</table>
    <p>设置每个进程的最大硬连接数（仅线程平台）。</p>

</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="DBDMin" id="DBDMin">DBDMin</a> <a name="dbdmin" id="dbdmin">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>最小连接数</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>DBDMin <var>号</var></code></td></tr>
<tr><th><a href="directive-dict.html#Default">默认：</a></th><td><code>DBDMin 1</code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_dbd</td></tr>
</table>
    <p>设置每个进程的最小连接数（仅线程平台）。</p>

</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="DBDParams" id="DBDParams">DBDParams</a> <a name="dbdparams" id="dbdparams">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>数据库连接参数</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>DBDParams <var>param1</var> = <var>value1</var> [， <var>param2</var> = <var>value2</var> ]</code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_dbd</td></tr>
</table>
    <p>根据底层驱动程序的要求。通常，这将用于传递用户名，密码，数据库名称，主机名和连接端口号中无法默认设置的任何内容。</p>
    <p>当前驱动程序的连接字符串参数包括：</p>
    <dl>
    <dt>FreeTDS（用于MSSQL和SyBase）</dt>
    <dd>用户名，密码，应用程序名称，dbname，主机，字符集，lang，服务器</dd>
    <dt>的MySQL</dt>
    <dd>主机，端口，用户，通过，dbname，sock，标志，fldsz，组，重新连接</dd>
    <dt>甲骨文</dt>
    <dd>用户，通过，dbname，服务器</dd>
    <dt>PostgreSQL的</dt>
    <dd>连接字符串直接传递到<code>PQconnectdb</code></dd>
    <dt>SQLite2</dt>
    <dd>连接字符串在冒号上分割，并且<code>part1:part2</code>用作<code>sqlite_open(part1, atoi(part2), NULL)</code></dd>
    <dt>SQLite3</dt>
    <dd>连接字符串直接传递到<code>sqlite3_open</code></dd>
    <dt>ODBC</dt>
    <dd>数据源，用户，密码，连接，ctimeout，stimeout，访问，txmode，bufsize</dd>
    </dl>

</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="DBDPersist" id="DBDPersist">DBDPersist</a> <a name="dbdpersist" id="dbdpersist">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>是否使用持久连接</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>DBDPersist开|关</code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_dbd</td></tr>
</table>
    <p>如果设置为“关”，则禁用持久连接和池连接。客户端请求时将打开一个新的数据库连接，并在发布时立即将其关闭。此选项用于调试和低使用率的服务器。</p>

    <p>默认设置是启用持久性连接池（对于非线程服务器，则启用单个LAMP风格的持久性连接），并且几乎应始终在操作中使用。</p>

    <p>在版本2.2.2之前，此伪指令仅接受值<code>0</code>和<code>1</code>而不分别接受<code>Off</code>和<code>On</code> 。</p>

</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="DBDPrepareSQL" id="DBDPrepareSQL">DBDPrepareSQL</a> <a name="dbdpreparesql" id="dbdpreparesql">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>定义一个SQL预准备语句</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>DBDPrepareSQL <var>“ SQL语句”</var> <var>标签</var></code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_dbd</td></tr>
</table>
    <p>对于重复使用单个SQL语句的身份验证等模块，可以通过在启动时而不是每次使用时准备该语句来实现最佳性能。该指令准备一个SQL语句并为其分配标签。</p>

</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="DBDriver" id="DBDriver">DBDriver</a> <a name="dbdriver" id="dbdriver">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>指定一个SQL驱动程序</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>DBDriver <var>名称</var></code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_dbd</td></tr>
</table>
    <p>通过名称选择apr_dbd驱动程序。该驱动程序必须安装在您的系统上（在大多数系统上，它将是共享对象或dll）。例如， <code>DBDriver mysql</code>将在apr_dbd_mysql.so中选择MySQL驱动程序。</p>

</div>
</div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>
</body></html>