<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>mod_proxy_hcheck-Apache HTTP服务器版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body >
<div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="&lt;-" alt="&lt;-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> &gt; <a href="http://httpd.apache.org/">HTTP服务器</a> &gt; <a href="http://httpd.apache.org/docs/">文档</a> &gt; <a href="../index.html">版本2.4</a> &gt; <a href="./index.html">模块</a></div>
<div id="page-content">
<div id="preamble"><h1>Apache模块mod_proxy_hcheck</h1>

<table class="module"><tr><th><a href="module-dict.html#Description">描述：</a></th><td>平衡器成员（工作人员）的动态健康检查，以获取<code class="module"><a href="../mod/mod_proxy.html">mod_proxy</a></code></td></tr>
<tr><th><a href="module-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="module-dict.html#ModuleIdentifier">模块�标识符：</a></th><td>proxy_hcheck_module</td></tr>
<tr><th><a href="module-dict.html#SourceFile">源文件：</a></th><td>mod_proxy_hcheck.c</td></tr>
<tr><th><a href="module-dict.html#Compatibility">兼容性：</a></th><td>在Apache 2.4.21及更高版本中可用</td></tr></table>
<h3>摘要</h3>

    <p>此模块提供对平衡器成员（工人）的动态运行状况检查。可以逐个工人启用此功能。运行状况检查与实际的反向代理请求无关。</p>

    <p>该模块<em>需要</em> <code class="module"><a href="../mod/mod_watchdog.html">mod_watchdog</a></code>的服务。</p>

<div class="note"><h3>参量</h3>
  <p>通过使用其他BalancerMember参数启用运行状况检查机制，这些参数通过<code class="directive"><a href="../mod/mod_proxy.html#proxypass">ProxyPass</a></code>以标准方式配置：</p>

  <p>通过以下模块定义了新的BalancerMember状态状态（标志）：“ <code>C</code> ”。当工作人员由于运行状况检查模块确定的故障而导致脱机时，将设置此标志，并可以通过<code>balancer-manager</code>查看（并修改）此标志。</p>

    <table>
    <tr><th>参数</th>
        <th>默认</th>
        <th>描述</th></tr>
    <tr><td>方法</td>
        <td>没有</td>
        <td>没有执行动态运行状况检查。选择是：<table>
        		<tr><th>方法</th><th>描述</th><th>注意</th></tr>
        		<tr><td>没有</td><td>没有进行动态健康检查</td><td></td></tr>
        		<tr><td>TCP协议</td><td>检查是否可以创建后端的套接字：例如“您在吗”</td><td></td></tr>
        		<tr><td>选件</td><td>发送<code>HTTP OPTIONS</code>请求到后端</td><td>*</td></tr>
        		<tr><td>头</td><td>向后端发送<code>HTTP HEAD</code>请求</td><td>*</td></tr>
        		<tr><td>得到</td><td>将<code>HTTP GET</code>请求发送到后端</td><td>*</td></tr>

				<tr><td colspan="3"></td></tr>
				<tr><td colspan="3">*：除非使用<code>hcexpr</code> ，否则2xx或3xx HTTP状态将被解释为<em>通过</em>运行状况检查</td></tr>
        	</table>
        </td></tr>
    <tr><td>hcpasses</td>
        <td>1个</td>
        <td>重新启用工作程序之前成功进行的健康检查测试的次数</td></tr>
    <tr><td>hcfails</td>
        <td>1个</td>
        <td>禁用工作人员之前健康检查失败的次数</td></tr>
    <tr><td>间隔</td>
        <td>30</td>
        <td>健康检查周期（以秒为单位）（例如，每30秒执行一次）</td></tr>
    <tr><td>胡里</td>
        <td> </td>
        <td>要附加到工作人员URL的其他URI，以进行健康检查。</td></tr>
    <tr><td>模板</td>
        <td> </td>
        <td>通过<code class="directive">ProxyHCTemplate</code>创建的模板名称，用于设置此工作程序的运行状况检查参数</td></tr>
    <tr><td>hcexpr</td>
        <td> </td>
        <td>通过<code class="directive">ProxyHCExpr</code>创建的表达式名称，用于检查响应头的运行状况。<br>
            <em>如果未使用，则2xx至3xx状态代码表示成功</em></td></tr>
    </table>
</div>

</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><h3>话题</h3>
<ul id="topics">
<li><img alt="" src="../images/down.gif"> <a href="#examples">用法示例</a></li>
</ul><h3 class="directives">指令</h3>
<ul id="toc">
<li><img alt="" src="../images/down.gif"> <a href="#proxyhcexpr">代理HCExpr</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#proxyhctemplate">代理HC模板</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#proxyhctpsize">代理HCTPsize</a></li>
</ul>
<h3>错误修正清单</h3><ul class="seealso"><li><a href="https://www.apache.org/dist/httpd/CHANGES_2.4">httpd更新日志</a></li><li><a href="https://bz.apache.org/bugzilla/buglist.cgi?bug_status=__open__&amp;list_id=144532&amp;product=Apache httpd-2&amp;query_format=specific&amp;order=changeddate DESC%2Cpriority%2Cbug_severity&amp;component=mod_proxy_hcheck">已知的问题</a></li><li><a href="https://bz.apache.org/bugzilla/enter_bug.cgi?product=Apache httpd-2&amp;component=mod_proxy_hcheck">报告错误</a></li></ul><h3>也可以看看</h3>
<ul class="seealso">
<li><code class="module"><a href="../mod/mod_proxy.html">mod_proxy</a></code></li>
</ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="examples" id="examples">用法示例</a></h2>

	
    <p>以下示例显示了如何配置各种后端服务器的运行状况检查：</p>

	
	<pre class="prettyprint lang-config">ProxyHCExpr ok234 {%{REQUEST_STATUS} =~ /^[234]/}
ProxyHCExpr gdown {%{REQUEST_STATUS} =~ /^[5]/}
ProxyHCExpr in_maint {hc('body') !~ /Under maintenance/}

&lt;Proxy balancer://foo&gt;
  BalancerMember http://www.example.com/  hcmethod=GET hcexpr=in_maint hcuri=/status.php
  BalancerMember http://www2.example.com/  hcmethod=HEAD hcexpr=ok234 hcinterval=10
  BalancerMember http://www3.example.com/ hcmethod=TCP hcinterval=5 hcpasses=2 hcfails=3
  BalancerMember http://www4.example.com/
&lt;/Proxy&gt;

ProxyPass "/" "balancer://foo"
ProxyPassReverse "/" "balancer://foo"</pre>


<p>在这种情况下，通过向该服务器发送<code>GET /status.php</code>请求并查看返回的页面不包含字符串<em>Under maintenance</em>来对<code>http://www.example.com/</code>进行健康检查。如果是这样，则该服务器将进入运行状况检查失败模式，并被禁用。此动态检查每30秒执行一次，这是默认设置。</p>

<p>通过每10秒发送一次简单的<code>HEAD</code>请求并确保响应状态为2xx，3xx或4xx来检查<code>http://www2.example.com/</code> 。每5秒钟检查一次<code>http://www3.example.com/</code> ，只需确保该服务器的套接字已启动即可。如果后端被标记为“关闭”，并且通过了2次健康检查，它将被重新启用并重新添加到负载均衡器中。要使服务器禁用并将其移出旋转，需要进行3次连续的运行状况检查失败。最后，根本不会动态检查<code>http://www4.example.com/</code> 。</p>

</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="ProxyHCExpr" id="ProxyHCExpr">ProxyHCExpr</a> <a name="proxyhcexpr" id="proxyhcexpr">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>创建一个命名条件表达式，用于根据其响应确定后端的运行状况。</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>ProxyHCExpr名称{ap_expr表达式}</code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_proxy_hcheck</td></tr>
</table>
    <p><code class="directive">ProxyHCExpr</code>指令允许创建一个命名条件表达式，该表达式检查后端服务器的响应标头以确定其运行状况。然后可以通过<code>hcexpr</code>参数将此命名条件分配给平衡器成员</p>

    <div class="example"><h3>ProxyHCExpr：允许2xx / 3xx / 4xx作为传递</h3><pre class="prettyprint lang-config">ProxyHCExpr ok234 {%{REQUEST_STATUS} =~ /^[234]/}
ProxyPass "/apps"     "http://backend.example.com/" hcexpr=ok234</pre>
</div>

    <div class="note">该<a href="../expr.html">表达式</a>可以使用大括号（“ {}”）作为引号之外的引号。
    </div>

    <p>如果使用运行状况检查方法（例如<code>GET</code> ）生成响应主体，则可以使用<code>hc()</code>表达式函数通过<code>ap_expr</code>检查该主体本身，该函数对于该模块是唯一的。</p>

    <p>在以下示例中，我们向后端发送<code>GET</code>请求，并且如果响应正文中包含短语<em>Under maintenance</em> ，则我们希望禁用后端。</p>

    <div class="example"><h3>ProxyHCExpr：检查响应正文</h3><pre class="prettyprint lang-config">ProxyHCExpr in_maint {hc('body') !~ /Under maintenance/}
ProxyPass "/apps"     "http://backend.example.com/" hcexpr=in_maint hcmethod=get hcuri=/status.php</pre>
</div>

    <p><em>注意：</em>由于响应主体可能很大，因此最好将其用于特定状态页面。</p>

</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="ProxyHCTemplate" id="ProxyHCTemplate">ProxyHCTemplate</a> <a name="proxyhctemplate" id="proxyhctemplate">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>创建一个命名模板以设置各种健康检查参数</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>ProxyHCTemplate名称参数=设置&lt;...&gt;</code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_proxy_hcheck</td></tr>
</table>
    <p><code class="directive">ProxyHCTemplate</code>指令允许创建命名检查（健康检查参数）（模板），然后可以通过<code>hctemplate</code>参数将其分配给平衡器成员</p>

    <div class="example"><h3>代理HC模板</h3><pre class="prettyprint lang-config">ProxyHCTemplate tcp5 hcmethod=tcp hcinterval=5
ProxyPass "/apps"     "http://backend.example.com/" hctemplate=tcp5</pre>
</div>


</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="ProxyHCTPsize" id="ProxyHCTPsize">ProxyHCTPsize</a> <a name="proxyhctpsize" id="proxyhctpsize">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>设置用于运行状况检查工作程序的线程池在服务器范围内的总大小。</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>ProxyHCTPsize &lt;大小&gt;</code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_proxy_hcheck</td></tr>
</table>
    <p>如果Apache httpd和APR带有线程支持，则运行状况检查模块会将实际检查的工作分流到与Watchdog进程关联的线程池中，从而允许并行检查。<code class="directive">ProxyHCTPsize</code>指令确定此<code class="directive">ProxyHCTPsize</code>的大小。如果设置为<code>0</code> ，则根本不使用线程池，从而导致序列化运行状况检查。默认大小为16。</p>

    <div class="example"><h3>代理HCTPsize</h3><pre class="prettyprint lang-config">ProxyHCTPsize 32</pre>
</div>


</div>
</div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>
</body></html>