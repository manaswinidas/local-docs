<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>mod_unique_id-Apache HTTP服务器版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body >
<div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="&lt;-" alt="&lt;-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> &gt; <a href="http://httpd.apache.org/">HTTP服务器</a> &gt; <a href="http://httpd.apache.org/docs/">文档</a> &gt; <a href="../index.html">版本2.4</a> &gt; <a href="./index.html">模块</a></div>
<div id="page-content">
<div id="preamble"><h1>Apache模块mod_unique_id</h1>

<table class="module"><tr><th><a href="module-dict.html#Description">描述：</a></th><td>为每个请求提供一个具有唯一标识符的环境变量</td></tr>
<tr><th><a href="module-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="module-dict.html#ModuleIdentifier">模块�标识符：</a></th><td>unique_id_module</td></tr>
<tr><th><a href="module-dict.html#SourceFile">源文件：</a></th><td>mod_unique_id.c</td></tr></table>
<h3>摘要</h3>


    <p>该模块为每个请求提供一个魔术令牌，该令牌在非常特定的条件下保证在“所有”请求中都是唯一的。唯一标识符甚至在正确配置的机器群集中的多台机器之间也是唯一的。环境变量<code>UNIQUE_ID</code>设置为每个请求的标识符。出于各种原因，唯一标识符很有用，这些原因超出了本文档的范围。</p>
</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><h3>话题</h3>
<ul id="topics">
<li><img alt="" src="../images/down.gif"> <a href="#theory">理论</a></li>
</ul><h3 class="directives">指令</h3>
<p>该模块不提供指令。</p>
<h3>错误修正清单</h3><ul class="seealso"><li><a href="https://www.apache.org/dist/httpd/CHANGES_2.4">httpd更新日志</a></li><li><a href="https://bz.apache.org/bugzilla/buglist.cgi?bug_status=__open__&amp;list_id=144532&amp;product=Apache httpd-2&amp;query_format=specific&amp;order=changeddate DESC%2Cpriority%2Cbug_severity&amp;component=mod_unique_id">已知的问题</a></li><li><a href="https://bz.apache.org/bugzilla/enter_bug.cgi?product=Apache httpd-2&amp;component=mod_unique_id">报告错误</a></li></ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="theory" id="theory">理论</a></h2>
    

    <p>首先简要回顾一下Apache服务器在Unix计算机上的工作方式。Windows NT当前不支持此功能。在Unix机器上，Apache创建多个子进程，这些子进程一次请求一个子进程。每个孩子在其一生中可以满足多个请求。出于讨论的目的，孩子们彼此之间没有共享任何数据。我们将这些子项称为<dfn>httpd进程</dfn> 。</p>

    <p>您的网站上有一台或多台由您管理的计算机，我们将它们统称为计算机集群。每台机器都可以运行Apache的多个实例。所有这些统称为“宇宙”，在某些假设下，我们将证明在此宇宙中，我们可以为每个请求生成唯一的标识符，而无需在集群中的机器之间进行广泛的通信。</p>

    <p>群集中的计算机应满足这些要求。（即使只有一台计算机，也应将其时钟与NTP同步。）</p>

    <ul>
      <li>机器的时间通过NTP或其他网络时间协议进行同步。</li>

      <li>机器的主机名各不相同，因此模块可以在主机名上进行主机名查找，并为群集中的每台机器接收不同的IP地址。</li>
    </ul>

    <p>就操作系统假设而言，我们假设pid（进程ID）适合32位。如果操作系统为pid使用的位数超过32位，则此修复很简单，但必须在代码中执行。</p>

    <p>根据这些假设，我们可以在单个时间点上从所有其他httpd进程中识别集群中任何计算机上的任何httpd进程。机器的IP地址和httpd进程的pid足以完成此操作。如果您使用多线程MPM，则httpd进程可以同时处理多个请求。为了识别线程，我们使用Apache httpd内部使用的线程索引。因此，为了生成请求的唯一标识符，我们只需要区分不同的时间点即可。</p>

    <p>为了区分时间，我们将使用Unix时间戳（自UTC 1970年1月1日以来的秒数）和一个16位计数器。时间戳仅具有一秒的粒度，因此该计数器用于在一秒钟内表示最多65536个值。四倍<em>（ip_addr，pid，time_stamp，counter）</em>足以枚举每个httpd进程每秒65536个请求。但是随着时间的推移，pid重用会出现问题，并且使用计数器来缓解此问题。</p>

    <p>创建httpd子代时，将使用（当前微秒除以10）以65536为模数初始化计数器（选择此公式是为了消除某些系统上微秒计时器的低序位引起的一些方差问题）。生成唯一标识符时，使用的时间戳是请求到达Web服务器的时间。每次生成标识符（并允许翻转）时，计数器都会递增。</p>

    <p>内核在派生该进程时会为每个进程生成一个pid，并且允许pid进行翻转（在许多Unix上，它们为16位，但较新的系统已扩展为32位）。因此，随着时间的流逝，相同的pid将被重用。但是，除非它在同一秒内被重用，否则它不会破坏我们四元组的唯一性。也就是说，我们假设系统不会在一秒钟的间隔内产生65536个进程（在某些Unix上它甚至可能是32768个进程，但即使这样也不太可能发生）。</p>

    <p>假设时间由于某种原因而重演。也就是说，假设系统的时钟搞砸了，并且它会重新查看过去的时间（或者它太向前了，已正确重置，然后重新考虑了将来的时间）。在这种情况下，我们可以轻松地表明我们可以获得pid和时间戳重用。选择计数器的初始化程序旨在帮助克服这一问题。请注意，我们确实希望使用随机数来初始化计数器，但是在大多数系统上没有任何可用的数字（ <em>即</em> ，您不能使用rand（），因为您需要对生成器进行种子设置，也无法对其进行种子设置时间，因为时间（至少以一秒的分辨率）已经重复了一次）。这不是一个完美的防御。</p>

    <p>防御有多好？假设您的一台计算机每秒最多可处理500个请求（在撰写本文时，这是一个非常合理的上限，因为系统通常不仅仅删除静态文件而已）。为此，将需要多个子代，具体取决于您有多少个并发客户端。但是我们会感到悲观，并假设一个孩子每秒能够处理500个请求。有1000个可能的起始计数器值，以使500个请求的两个序列重叠。因此，如果时间（以一秒的分辨率）重复一次，则此孩子有1.5％的机会重复该计数器值，并且唯一性将被破坏。这是一个非常悲观的例子，而按照现实世界的价值，它发生的可能性甚至更低。如果您的系统仍然很可能发生，那么也许您应该将计数器设置为32位（通过编辑代码）。</p>

    <p>您可能会担心在夏令时期间时钟会“倒退”。但这不是问题，因为这里使用的时间是UTC，“总是”向前发展。请注意，基于x86的Unix可能需要适当的配置才能实现-应当将它们配置为假定主板时钟为UTC并进行适当补偿。但是即使如此，如果您正在运行NTP，那么重新启动后不久，您的UTC时间也将正确。</p>

    
    <p><code>UNIQUE_ID</code>环境变量是通过使用字母<code>[A-Za-z0-9@-]</code>类似于MIME base64编码，产生24个字符。MIME base64字母表实际上是<code>[A-Za-z0-9+/]</code>但是<code>+</code>和<code>/</code>需要在URL中进行特殊编码，这使它们不太受欢迎。所有值均以网络字节顺序编码，因此该编码在不同字节顺序的体系结构之间具有可比性。编码的实际顺序为：时间戳，IP地址，PID，计数器。这种排序是有目的的，但是应该强调的是，应用程序不应剖析编码。应用程序应将整个编码的<code>UNIQUE_ID</code>视为一个不透明的令牌，可以将其与其他<code>UNIQUE_ID</code>进行比较，以确保相等。</p>

    <p>这样选择顺序，以便将来可以更改编码，而不必担心与现有<code>UNIQUE_ID</code>数据库的<code>UNIQUE_ID</code> 。新的编码还应将时间戳记保留为第一个元素，否则可以使用相同的字母和位长。由于时间戳从本质上讲是递增的序列，因此具有<em>秒标记</em>就足够了，群集中的所有计算机都停止服务任何请求，并停止使用旧的编码格式就足够了。之后，他们可以恢复请求并开始发布新的编码。</p>

    <p>我们认为这是解决此问题的相对便携式的解决方案。生成的标识符本质上具有无限的使用寿命，因为可以根据需要使将来的标识符更长。基本上，集群中的机器之间不需要通信（仅需要NTP同步，这是较低的开销），并且httpd进程之间也不需要通信（通信隐含在内核分配的pid值中）。在非常特殊的情况下，可以缩短标识符的长度，但是需要假设更多的信息（例如，对于任何站点，32位IP地址都是过大的，但是没有可移植的，更短的替换项）。</p>
</div>
</div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>
</body></html>