<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>mod_proxy_fcgi-Apache HTTP服务器版本2.4</title>
<link href="../style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="../style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="../style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="../style/css/prettify.css">
<script src="../style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body >
<div id="page-header">
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="../images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="&lt;-" alt="&lt;-" src="../images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> &gt; <a href="http://httpd.apache.org/">HTTP服务器</a> &gt; <a href="http://httpd.apache.org/docs/">文档</a> &gt; <a href="../index.html">版本2.4</a> &gt; <a href="./index.html">模块</a></div>
<div id="page-content">
<div id="preamble"><h1>Apache模块mod_proxy_fcgi</h1>

<table class="module"><tr><th><a href="module-dict.html#Description">描述：</a></th><td>用于<code class="module"><a href="../mod/mod_proxy.html">mod_proxy</a></code> FastCGI支持模块</td></tr>
<tr><th><a href="module-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="module-dict.html#ModuleIdentifier">模块�标识符：</a></th><td>proxy_fcgi_module</td></tr>
<tr><th><a href="module-dict.html#SourceFile">源文件：</a></th><td>mod_proxy_fcgi.c</td></tr>
<tr><th><a href="module-dict.html#Compatibility">兼容性：</a></th><td>在版本2.3及更高版本中可用</td></tr></table>
<h3>摘要</h3>

    <p>该模块<em>需要</em> <code class="module"><a href="../mod/mod_proxy.html">mod_proxy</a></code>服务。它提供对<a href="http://www.fastcgi.com/">FastCGI</a>协议的支持。</p>

    <p>因此，为了获得处理<code>FastCGI</code>协议的能力，服务器中必须存在<code class="module"><a href="../mod/mod_proxy.html">mod_proxy</a></code>和<code class="module"><a href="../mod/mod_proxy_fcgi.html">mod_proxy_fcgi</a></code> 。</p>

    <p>与<a href="http://httpd.apache.org/mod_fcgid/">mod_fcgid</a>和<a href="http://www.fastcgi.com/">mod_fastcgi</a>不同， <code class="module"><a href="../mod/mod_proxy_fcgi.html">mod_proxy_fcgi</a></code>没有启动应用程序的准备。 <code class="program"><a href="../programs/fcgistarter.html">fcgistarter</a></code>提供了<code class="program"><a href="../programs/fcgistarter.html">fcgistarter</a></code> （在某些平台上）。或者，可以在使用的FastCGI应用程序框架中使用外部启动或过程管理。</p>

    <div class="warning"><h3>警告</h3>
      <p>在<a href="mod_proxy.html#access">确保服务器安全</a>之前，请勿启用代理。开放式代理服务器对您的网络和整个Internet都是危险的。</p>
    </div>
</div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><h3>话题</h3>
<ul id="topics">
<li><img alt="" src="../images/down.gif"> <a href="#examples">例子</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#env">环境变量</a></li>
</ul><h3 class="directives">指令</h3>
<ul id="toc">
<li><img alt="" src="../images/down.gif"> <a href="#proxyfcgibackendtype">ProxyFCGIBackendType</a></li>
<li><img alt="" src="../images/down.gif"> <a href="#proxyfcgisetenvif">代理FCGISetEnvIf</a></li>
</ul>
<h3>错误修正清单</h3><ul class="seealso"><li><a href="https://www.apache.org/dist/httpd/CHANGES_2.4">httpd更新日志</a></li><li><a href="https://bz.apache.org/bugzilla/buglist.cgi?bug_status=__open__&amp;list_id=144532&amp;product=Apache httpd-2&amp;query_format=specific&amp;order=changeddate DESC%2Cpriority%2Cbug_severity&amp;component=mod_proxy_fcgi">已知的问题</a></li><li><a href="https://bz.apache.org/bugzilla/enter_bug.cgi?product=Apache httpd-2&amp;component=mod_proxy_fcgi">报告错误</a></li></ul><h3>也可以看看</h3>
<ul class="seealso">
<li><code class="program"><a href="../programs/fcgistarter.html">fcgistarter</a></code></li>
<li><code class="module"><a href="../mod/mod_proxy.html">mod_proxy</a></code></li>
<li><code class="module"><a href="../mod/mod_authnz_fcgi.html">mod_authnz_fcgi</a></code></li>
</ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="examples" id="examples">例子</a></h2>
    <p>请记住，为了使以下示例正常工作，必须启用<code class="module"><a href="../mod/mod_proxy.html">mod_proxy</a></code>和<code class="module"><a href="../mod/mod_proxy_fcgi.html">mod_proxy_fcgi</a></code> 。</p>

    <div class="example"><h3>单个应用程序实例</h3><pre class="prettyprint lang-config">ProxyPass "/myapp/" "fcgi://localhost:4000/"</pre>
</div>

    <p> 默认情况下， <code class="module"><a href="../mod/mod_proxy_fcgi.html">mod_proxy_fcgi</a></code>禁用连接重用，因此在请求完成后，该httpd子进程不会将连接保持打开状态，并且将不会重用该连接。如果FastCGI应用程序能够处理来自httpd的并发连接，则可以选择加入连接重用，如以下示例所示：</p>

    <div class="example"><h3>单个应用程序实例，连接重用（2.4.11及更高版本）</h3><pre class="prettyprint lang-config">ProxyPass "/myapp/" "fcgi://localhost:4000/" enablereuse=on</pre>
</div>

    <div class="note"><h3>启用与PHP-FPM之类的FCGI后端的连接重用</h3>
    <p>请记住，PHP-FPM（在撰写本文时为2018年2月）使用了一个prefork模型，即其每个工作进程都可以同时处理一个连接。<br>默认情况下，mod_proxy（使用<code>enablereuse=on</code>配置）允许在使用线程化的mpm（例如<code class="module"><a href="../mod/worker.html">worker</a></code>或<code class="module"><a href="../mod/event.html">event</a></code> ）时为每个httpd进程的<code class="directive"><a href="../mod/mpm_common.html#threadsperchild">ThreadsPerChild</a></code>连接提供到后端的连接池，因此应考虑以下用例：</p>
    <ul>
      <li>在HTTP / 1.1负载下，它可能会导致最多创建与FCGI后端的<code class="directive"><a href="../mod/mpm_common.html#maxrequestworkers">MaxRequestWorkers</a></code>连接。</li>
      <li>在HTTP / 2负载下，由于如何实现<code class="module"><a href="../mod/mod_http2.html">mod_http2</a></code> ，因此还有其他h2工作线程可能会强制创建其他后端连接。池中的连接总数可能会超过<code class="directive"><a href="../mod/mpm_common.html#maxrequestworkers">MaxRequestWorkers</a></code> 。</li>
    </ul>
    <p>需要明智地配置PHP-FPM工作进程的最大数量，因为它们有可能最终全部“忙”于处理空闲的持久连接，而没有建立新连接的余地，并且最终用户体验将一堆HTTP请求超时。</p>
    </div>

    <p>以下示例将请求URI作为要运行的PHP-FPM守护程序的文件系统路径传递。请求URL隐式添加到第二个参数。fcgi：//之后的主机名和端口是PHP-FPM监听的地方。连接池/重用已启用。</p>
    <div class="example"><h3>PHP-FPM</h3><pre class="prettyprint lang-config">ProxyPassMatch "^/myapp/.*\.php(/.*)?$" "fcgi://localhost:9000/var/www/" enablereuse=on</pre>
</div>

    <p>以下示例将请求URI作为要运行的PHP-FPM守护程序的文件系统路径传递。在这种情况下，PHP-FPM正在unix域套接字（UDS）上侦听。需要2.4.9或更高版本。使用此语法，将忽略主机名和fcgi：//之后的可选端口。</p>
    <div class="example"><h3>带有UDS的PHP-FPM</h3><pre class="prettyprint lang-config">ProxyPassMatch "^/(.*\.php(/.*)?)$" "unix:/var/run/php5-fpm.sock|fcgi://localhost/var/www/"</pre>
</div>

    <p>除上面列出的代理模块之外，平衡网关还需要<code class="module"><a href="../mod/mod_proxy_balancer.html">mod_proxy_balancer</a></code>和至少一个负载平衡器算法模块，例如<code class="module"><a href="../mod/mod_lbmethod_byrequests.html">mod_lbmethod_byrequests</a></code> 。 <code class="module"><a href="../mod/mod_lbmethod_byrequests.html">mod_lbmethod_byrequests</a></code>为<code class="module"><a href="../mod/mod_lbmethod_byrequests.html">mod_lbmethod_byrequests</a></code> ，它将用于此示例配置。</p>

    <div class="example"><h3>通往多个应用程序实例的平衡网关</h3><pre class="prettyprint lang-config">ProxyPass "/myapp/" "balancer://myappcluster/"
&lt;Proxy "balancer://myappcluster/"&gt;
    BalancerMember "fcgi://localhost:4000"
    BalancerMember "fcgi://localhost:4001"
&lt;/Proxy&gt;</pre>
</div>

      <p>您还可以通过创建合适的处理程序传递来强制将请求作为反向代理请求进行处理。下面的示例配置将使用反向代理将对PHP脚本的所有请求传递到指定的FastCGI服务器。Apache HTTP Server 2.4.10和更高版本中提供了此功能。由于性能原因，你将要定义一个<a href="mod_proxy.html#workers">工人</a>代表相同FCGI：//后端。这种形式的好处是，它允许在服务器中进行URI到文件名的常规映射，并将本地文件系统结果传递到后端。通过这种方式配置FastCGI后，服务器可以计算出最准确的PATH_INFO。</p>
    <div class="example"><h3>通过处理程序代理</h3><pre class="prettyprint lang-config">&lt;FilesMatch "\.php$"&gt;
    # Note: The only part that varies is /path/to/app.sock
    SetHandler  "proxy:unix:/path/to/app.sock|fcgi://localhost/"
&lt;/FilesMatch&gt;

# Define a matching worker.
# The part that is matched to the SetHandler is the part that
# follows the pipe. If you need to distinguish, "localhost; can
# be anything unique.
&lt;Proxy "fcgi://localhost/" enablereuse=on max=10&gt;
&lt;/Proxy&gt;

&lt;FilesMatch ...&gt;
    SetHandler  "proxy:fcgi://localhost:9000"
&lt;/FilesMatch&gt;

&lt;FilesMatch ...&gt;
    SetHandler  "proxy:balancer://myappcluster/"
&lt;/FilesMatch&gt;</pre>
</div>
</div><div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="section">
<h2><a name="env" id="env">环境变量</a></h2>
    <p>除了控制<code class="module"><a href="../mod/mod_proxy.html">mod_proxy</a></code>行为的配置指令之外，还有许多控制FCGI协议提供程序的<dfn>环境变量</dfn> ：</p>
    <dl>
        <dt>proxy-fcgi-pathinfo</dt>
        <dd>通过<code class="directive"><a href="../mod/mod_proxy.html#proxypass">ProxyPass</a></code>或<code class="directive"><a href="../mod/mod_proxy.html#proxypassmatch">ProxyPassMatch</a></code>配置时， <code class="module"><a href="../mod/mod_proxy_fcgi.html">mod_proxy_fcgi</a></code>不会设置<var>PATH_INFO</var>环境变量。这允许后端FCGI服务器正确确定<var>SCRIPT_NAME</var>和<var>Script-URI</var>并符合RFC 3875第3.3节。如果相反，您需要<code class="module"><a href="../mod/mod_proxy_fcgi.html">mod_proxy_fcgi</a></code>为<var>PATH_INFO</var>生成“最佳猜测”，请设置此env-var。这是某些FCGI实现中的错误的解决方法。可以将此变量设置为多个值，以调整如何选择最佳猜测（仅在2.4.11及更高版本中）：<dl>
          <dt>第一点</dt>
          <dd>PATH_INFO从<em>第一个</em> “。”之后的斜杠中分离出来。在网址中。</dd>
          <dt>最后一点</dt>
          <dd>PATH_INFO从<em>最后一个</em> “。”后面的斜杠中分离出来。在网址中。</dd>
          <dt>充分</dt>
          <dd>PATH_INFO是通过尝试将URL映射到本地文件系统来计算的。</dd>
          <dt>逃生</dt>
          <dd>PATH_INFO是URL的路径组成部分，未经转义/解码。</dd>
          <dt>任何其他值</dt>
          <dd>PATH_INFO与URL的路径部分相同。最初，这是唯一的proxy-fcgi-pathinfo选项。</dd>
         </dl>
        </dd>
    </dl>
</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="ProxyFCGIBackendType" id="ProxyFCGIBackendType">ProxyFCGIBackendType</a> <a name="proxyfcgibackendtype" id="proxyfcgibackendtype">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>指定后端FastCGI应用程序的类型</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>ProxyFCGIBackendType FPM | GENERIC</code></td></tr>
<tr><th><a href="directive-dict.html#Default">默认：</a></th><td><code>ProxyFCGIBackendType FPM</code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机，目录，.htaccess</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_proxy_fcgi</td></tr>
<tr><th><a href="directive-dict.html#Compatibility">兼容性：</a></th><td>在版本2.4.26和更高版本中可用</td></tr>
</table>
<p>该指令允许指定后端FastCGI应用程序的类型。某些FastCGI服务器（例如PHP-FPM）使用环境变量的历史记录来识别所使用的代理服务器的类型。如果您的非PHP-FPM应用程序在解释服务器设置的环境变量（例如SCRIPT_FILENAME或PATH_TRANSLATED）时遇到问题，请将此指令设置为“ GENERIC”。</p>

<p>根据此伪指令的设置更改的值的一个示例是SCRIPT_FILENAME。历史上使用<code class="module"><a href="../mod/mod_proxy_fcgi.html">mod_proxy_fcgi</a></code> ，SCRIPT_FILENAME的前缀为字符串“ proxy：fcgi：//”。一些通用FastCGI应用程序将这个变量作为脚本输入读取，但是PHP-FPM会删除前缀，然后记住它正在与Apache通讯。在2.4.21至2.4.25中，服务器自动剥离了该前缀，从而在某些情况下破坏了PHP-FPM检测Apache并与之交互的功能。</p>

</div>
<div class="top"><a href="#page-header"><img alt="最佳" src="../images/up.gif"></a></div>
<div class="directive-section"><h2><a name="ProxyFCGISetEnvIf" id="ProxyFCGISetEnvIf">ProxyFCGISetEnvIf</a> <a name="proxyfcgisetenvif" id="proxyfcgisetenvif">指令</a></h2>
<table class="directive">
<tr><th><a href="directive-dict.html#Description">描述：</a></th><td>允许修复发送给FastCGI服务器的变量</td></tr>
<tr><th><a href="directive-dict.html#Syntax">句法：</a></th><td><code>ProxyFCGISetEnvIf <var>条件表达式</var> [！]<var>环境变量名称</var> [ <var>value-expression</var> ]</code></td></tr>
<tr><th><a href="directive-dict.html#Context">内容：</a></th><td>服务器配置，虚拟主机，目录，.htaccess</td></tr>
<tr><th><a href="directive-dict.html#Status">状态：</a></th><td>延期</td></tr>
<tr><th><a href="directive-dict.html#Module">模块：</a></th><td>mod_proxy_fcgi</td></tr>
<tr><th><a href="directive-dict.html#Compatibility">兼容性：</a></th><td>在版本2.4.26和更高版本中可用</td></tr>
</table>
<p>在将请求传递到已配置的FastCGI服务器之前，Web服务器的核心会根据当前请求的详细信息设置许多环境变量。 FastCGI程序通常使用这些环境变量作为输入，以确定它们将处理的基础脚本或直接产生的输出。</p>
<p>值得注意的环境变量示例如下：</p>
<ul>
  <li>SCRIPT_NAME</li>
  <li>SCRIPT_FILENAME</li>
  <li>REQUEST_URI</li>
  <li>PATH_INFO</li>
  <li>PATH_TRANSLATED</li>
</ul>

<p>该指令允许覆盖上面的环境变量或任何其他感兴趣的环境变量。在设置了这些变量的初始值之后，将评估此伪指令，因此可以将它们用作条件表达式和值表达式的输入。</p>
<p>参数语法：</p>
<dl>
<dt>条件表达</dt>
<dd>指定一个表达式，该表达式控制是否修改后面的环境变量。有关表达式语法的信息，请参见以下示例或<a href="../expr.html">ap_expr</a>文档中的完整规范。
   </dd>
<dt>环境变量名称</dt>
<dd>指定要更改的CGI环境变量，例如PATH_INFO。如果前面带有感叹号，则该变量将未设置。</dd>
<dt>价值表达</dt>
<dd>指定前面的环境变量的替换值。可以从<var>条件表达式中的</var>正则表达式捕获中包含反向引用，例如“ $ 1”。如果省略，则变量将设置（或覆盖）为空字符串-但请参见下面的注释。</dd>
</dl>

<div class="example"><pre class="prettyprint lang-config"># A basic, unconditional override
ProxyFCGISetEnvIf "true" PATH_INFO "/example"

# Use an environment variable in the value
ProxyFCGISetEnvIf "true" PATH_INFO "%{reqenv:SCRIPT_NAME}"

# Use captures in the conditions and backreferences in the replacement
ProxyFCGISetEnvIf "reqenv('PATH_TRANSLATED') =~ m|(/.*prefix)(\d+)(.*)|" PATH_TRANSLATED "$1$3"</pre>
</div>

<div class="note"><h3>注意：未设置与空</h3>以下将取消设置<code>VARIABLE</code> ，从而阻止将其发送到FastCGI服务器：<pre class="prettyprint lang-config">ProxyFCGISetEnvIf true !VARIABLE</pre>而以下内容将擦除任何现有的<code>VARIABLE</code> <em>值</em> （通过将其设置为空字符串），但是空的<code>VARIABLE</code>仍将发送到服务器：<pre class="prettyprint lang-config">ProxyFCGISetEnvIf true VARIABLE</pre>CGI / 1.1规范<a href="https://tools.ietf.org/html/rfc3875#section-4.1">没有区分</a>具有空值的变量和不存在的变量。但是，许多CGI和FastCGI实现在两者之间进行区分（或允许脚本进行区分）。使用哪种选择取决于您的实现和修改变量的原因。
</div>


</div>
</div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="../mod/index.html">模块</a> | <a href="../mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="../glossary.html">词汇表</a> | <a href="../sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>
</body></html>