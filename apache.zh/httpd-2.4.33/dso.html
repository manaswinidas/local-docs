<html lang="zh-Hans"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>动态共享对象（DSO）支持-Apache HTTP Server版本2.4</title>
<link href="./style/css/manual-zip.css" rel="stylesheet" type="text/css" title="Main stylesheet" media="all">
<link href="./style/css/manual-zip-100pc.css" rel="alternate stylesheet" type="text/css" title="No Sidebar - Default font size" media="all">
<link href="./style/css/manual-print.css" rel="stylesheet" type="text/css" media="print"><link rel="stylesheet" type="text/css" href="./style/css/prettify.css">
<script src="./style/scripts/prettify.min.js" type="text/javascript">
</script>
</head>
<body id="manual-page" ><div id="page-header">
<p class="menu"><a href="./mod/index.html">模块</a> | <a href="./mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="./glossary.html">词汇表</a> | <a href="./sitemap.html">网站地图</a></p>
<p class="apache">Apache HTTP服务器版本2.4</p>
<img alt="" src="./images/feather.png"></div>
<div class="up"><a href="./index.html"><img title="<-" alt="<-" src="./images/left.gif"></a></div>
<div id="path">
<a href="http://www.apache.org/">Apache</a> > <a href="http://httpd.apache.org/">HTTP Server</a> > <a href="http://httpd.apache.org/docs/">文档</a> > <a href="./index.html">版本2.4</a></div><div id="page-content"><div id="preamble"><h1>动态共享对象（DSO）支持</h1>


    <p>Apache HTTP Server是一个模块化程序，管理员可以在其中选择一组模块来选择要包含在服务器中的功能。模块将被编译为与主对象分开存在的动态共享对象（DSO）。 <code class="program"><a href="./programs/httpd.html">httpd</a></code>二进制文件。DSO模块可以在构建服务器时进行编译，也可以在以后使用Apache扩展工具（ <code class="program"><a href="./programs/apxs.html">apxs</a></code> ）。</p>
    <p>或者，可以将模块静态编译为<code class="program"><a href="./programs/httpd.html">httpd</a></code>服务器构建时为二进制。</p>

    <p>本文档介绍了如何使用DSO模块以及其使用背后的理论。</p>
  </div>
<div id="quickview"><a href="https://www.apache.org/foundation/contributing.html" class="badge"><img src="https://www.apache.org/images/SupportApache-small.png" alt="支持Apache！"></a><ul id="toc"><li><img alt="" src="./images/down.gif"> <a href="#implementation">实作</a></li>
<li><img alt="" src="./images/down.gif"> <a href="#usage">使用摘要</a></li>
<li><img alt="" src="./images/down.gif"> <a href="#background">背景</a></li>
<li><img alt="" src="./images/down.gif"> <a href="#advantages">的优点和缺点</a></li>
</ul></div>
<div class="top"><a href="#page-header"><img alt="最佳" src="./images/up.gif"></a></div>
<div class="section">
<h2><a name="implementation" id="implementation">实作</a></h2>

<table class="related"><tbody><tr><th>相关模块</th><th>相关指令</th></tr><tr><td><ul><li><code class="module"><a href="./mod/mod_so.html">mod_so</a></code></li></ul></td><td><ul><li><code class="directive"><a href="./mod/mod_so.html#loadmodule">LoadModule</a></code></li></ul></td></tr></tbody></table>

    <p>DSO支持加载单个Apache httpd模块，该模块基于一个名为<code class="module"><a href="./mod/mod_so.html">mod_so</a></code>必须将其静态编译到Apache httpd内核中。这是除了唯一的模块<code class="module"><a href="./mod/core.html">core</a></code>不能放入DSO本身。实际上，所有其他分布式Apache httpd模块都将放入DSO。将模块编译成名为DSO的DSO之后<code>mod_foo.so</code>您可以使用<code class="module"><a href="./mod/mod_so.html">mod_so</a></code>的<code class="directive"><a href="./mod/mod_so.html#loadmodule">LoadModule</a></code>您的指令<code>httpd.conf</code>文件以在服务器启动或重新启动时加载此模块。</p>
    <p>可以通过以下方式禁用单个模块的DSO构建： <code class="program"><a href="./programs/configure.html">configure</a></code>的<code>--enable-mods-static</code> <a href="install.html">安装文档中</a>讨论的选项。</p>

    <p>为了简化为Apache httpd模块（尤其是第三方模块）创建DSO文件的过程，请使用一个名为<code class="program"><a href="./programs/apxs.html">apxs</a></code> （ <dfn>APache eXtenSion</dfn> ）可用。它可用于在Apache httpd源代码树<em>之外</em>构建基于DSO的模块。这个想法很简单：安装Apache HTTP Server时， <code class="program"><a href="./programs/configure.html">configure</a></code>的<code>make install</code>该过程将安装Apache httpd C头文件，并将用于构建DSO文件的平台相关的编译器和链接器标志放入<code class="program"><a href="./programs/apxs.html">apxs</a></code>程序。这样用户可以使用<code class="program"><a href="./programs/apxs.html">apxs</a></code>无需Apache httpd分发源树即可编译他的Apache httpd模块源代码，而无需摆弄DSO支持的平台相关编译器和链接器标志。</p>
</div><div class="top"><a href="#page-header"><img alt="最佳" src="./images/up.gif"></a></div>
<div class="section">
<h2><a name="usage" id="usage">使用摘要</a></h2>

    <p>为了让您大致了解Apache HTTP Server 2.x的DSO功能，以下是一个简短的摘要：</p>

    <ol>
      <li>
        <p>例如，构建并安装<em>分布式</em> Apache httpd模块<code>mod_foo.c</code> ，转换成自己的DSO <code>mod_foo.so</code> ：</p>

<div class="example"><p><code>$ ./configure --prefix=/path/to/install --enable-foo<br> $ make install</code></p></div>
      </li>

      <li>
      <p>在启用所有模块的情况下配置Apache HTTP Server。服务器启动期间将仅加载基本集。您可以通过激活或取消激活已加载的模块集来更改<code class="directive"><a href="./mod/mod_so.html#loadmodule">LoadModule</a></code>指令在<code>httpd.conf</code> 。</p>

<div class="example"><p><code>$ ./configure --enable-mods-shared=all<br> $ make install</code></p></div>
      </li>

      <li>
      <p>有些模块仅对开发人员有用，无法构建。使用模块时设置<em>全部</em> 。要构建包括开发人员模块在内的所有可用模块，请使用<em>realall</em> 。除此之外<code class="directive"><a href="./mod/mod_so.html#loadmodule">LoadModule</a></code>可以通过configure选项激活所有内置模块的指令<code>--enable-load-all-modules</code> 。</p>

<div class="example"><p><code>$ ./configure --enable-mods-shared=reallyall --enable-load-all-modules<br> $ make install</code></p></div>
      </li>

      <li>生成并安装<em>第三方</em> Apache httpd模块，例如<code>mod_foo.c</code> ，转换成自己的DSO <code>mod_foo.so</code> <em>在</em> Apache httpd源代码树之外使用<code class="program"><a href="./programs/apxs.html">apxs</a></code> ：<div class="example"><p><code>$ cd /path/to/3rdparty<br> $ apxs -cia mod_foo.c</code></p></div>
      </li>
    </ol>

    <p>在所有情况下，共享模块编译后，都必须使用<code class="directive"><a href="./mod/mod_so.html#loadmodule">LoadModule</a></code>指令中<code>httpd.conf</code>告诉Apache httpd激活该模块。</p>

    <p>有关更多详细信息，请参见<a href="programs/apxs.html">apxs文档</a> 。</p>
</div><div class="top"><a href="#page-header"><img alt="最佳" src="./images/up.gif"></a></div>
<div class="section">
<h2><a name="background" id="background">背景</a></h2>

    <p>在现代Unix派生工具上，存在一种称为动态链接/ <em>动态共享对象</em> （DSO）的机制，该机制提供了一种以特殊格式构建程序代码段的方法，以便在运行时将其加载到可执行程序的地址空间中。 。</p>

    <p>这种加载通常可以通过两种方式完成：由称为<code>ld.so</code>当可执行程序启动时，或通过系统调用通过编程系统接口从执行程序中手动地通过Unix加载程序从Unix加载器启动时<code>dlopen()/dlsym()</code> 。</p>

    <p>在第一种方式中，DSO通常称为<em>共享库</em>或<em>DSO库，</em>并命名为<code>libfoo.so</code>要么<code>libfoo.so.1.2</code> 。它们位于系统目录中（通常<code>/usr/lib</code> ），并在构建时通过指定指向可执行程序的链接<code>-lfoo</code>链接器命令。该硬代码库引用进入可执行程序文件，以便在启动时Unix加载程序能够找到<code>libfoo.so</code>在<code>/usr/lib</code> ，在通过链接器选项（例如， <code>-R</code>或在通过环境变量配置的路径中<code>LD_LIBRARY_PATH</code> 。然后，它解析DSO中可用的可执行程序中的任何符号（但尚未解析）。</p>

    <p>DSO通常不引用可执行程序中的符号（因为它是通用代码的可重用库），因此无需进行进一步的解析。可执行程序无需使用DSO中的符号就可以自己做任何事情，因为完整的解析是由Unix加载器完成的。（实际上，要调用的代码<code>ld.so</code>是运行时启动代码的一部分，该代码链接到已绑定为非静态的每个可执行程序中。动态加载通用库代码的优势非常明显：库代码只需要在系统库中存储一次，例如<code>libc.so</code> ，为每个程序节省磁盘空间。</p>

    <p>在第二种方式中，DSO通常被称为<em>共享对象</em>或<em>DSO文件，</em>并且可以使用任意扩展名进行命名（尽管规范名称是<code>foo.so</code> ）。这些文件通常位于特定于程序的目录中，并且没有自动建立指向使用它们的可执行程序的链接。相反，可执行程序在运行时通过以下方式手动将DSO加载到其地址空间中： <code>dlopen()</code> 。此时，尚未完成来自DSO的可执行程序符号解析。但是，相反，Unix加载器会自动从可执行程序及其已加载的DSO库导出的符号集中解析DSO中的任何（尚未解析的）符号（尤其是无处不在的所有符号） <code>libc.so</code> ）。这样，DSO就可以像直接将它静态链接一样，获取可执行程序符号集的知识。</p>

    <p>最后，要利用DSO的API，可执行程序必须通过以下方式解析DSO中的特定符号<code>dlsym()</code>供以后在调度表<em>等</em>内部使用<em>。</em>换句话说：可执行程序必须手动解析它需要使用的每个符号。这种机制的优点是，在相关程序需要可选程序部分之前，不需要加载它们（因此不会浪费内存）。必要时，可以动态加载这些程序部分以扩展基本程序的功能。</p>

    <p>尽管这种DSO机制听起来很简单，但这里至少有一个困难的步骤：使用DSO扩展程序时，从可执行程序中解析DSO的符号（第二种方法）。为什么？因为从可执行程序的符号集中“反向解析” DSO符号违反了库的设计（库不了解其所使用的程序），并且在所有平台上都不可用，也不是标准化的。实际上，可执行程序的全局符号通常不会重新导出，因此无法在DSO中使用。找到一种方法来强制链接器导出所有全局符号是使用DSO在运行时扩展程序时必须解决的主要问题。</p>

    <p>共享库方法是典型的方法，因为它是DSO机制的设计目的，因此几乎用于操作系统提供的所有类型的库。</p>

</div><div class="top"><a href="#page-header"><img alt="最佳" src="./images/up.gif"></a></div>
<div class="section">
<h2><a name="advantages" id="advantages">的优点和缺点</a></h2>

    <p>上述基于DSO的功能具有以下优点：</p>

    <ul>
      <li>服务器程序包在运行时更加灵活，因为可以在运行时通过以下步骤组装服务器进程<code class="directive"><a href="./mod/mod_so.html#loadmodule">LoadModule</a></code><code>httpd.conf</code>配置指令代替<code class="program"><a href="./programs/configure.html">configure</a></code>构建时的选项。例如，通过这种方式，仅安装一个Apache httpd即可运行不同的服务器实例（标准和SSL版本，简约和动态版本[mod_perl，mod_php] <em>等</em> ）。</li>

      <li>即使在安装后，也可以使用第三方模块轻松扩展服务器软件包。对于供应商软件包维护者来说，这是一个巨大的好处，他们可以创建一个Apache httpd核心软件包以及其他包含PHP，mod_perl，mod_security <em>等</em>扩展名的软件包<em>。</em></li>

      <li>由于使用了DSO /，因此Apache httpd模块的原型制作更加容易<code class="program"><a href="./programs/apxs.html">apxs</a></code>对，您都可以在Apache httpd源代码树之外工作，并且只需要<code>apxs -i</code>命令后跟一个<code>apachectl restart</code>将当前开发的模块的新版本引入正在运行的Apache HTTP Server。</li>
    </ul>

    <p>DSO具有以下缺点：</p>

    <ul>
      <li>由于符号解析现在需要Unix加载程序要做的工作，因此服务器在启动时会慢大约20％。</li>

      <li>在某些平台上，服务器的执行时间大约慢5％，这是因为位置无关代码（PIC）有时需要复杂的汇编技巧来进行相对寻址，但不一定要与绝对寻址一样快。</li>

      <li>由于DSO模块无法与其他基于DSO的库链接（ <code>ld -lfoo</code> ）在所有平台上（例如，基于a.out的平台通常不提供此功能，而基于ELF的平台则提供），您不能对所有类型的模块使用DSO机制。换句话说，编译为DSO文件的模块仅限于使用来自Apache httpd核心（来自C库）的符号（ <code>libc</code> ）以及Apache httpd核心使用的所有其他动态或静态库，或来自静态库归档文件（ <code>libfoo.a</code> ）包含与位置无关的代码。使用其他代码的唯一机会是确保httpd核心本身已经包含对它的引用，或者自己通过加载代码<code>dlopen()</code> 。</li>
    </ul>

</div></div>
<div id="footer">
<p class="apache">版权所有2018 The Apache Software Foundation。<br>根据<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache许可，版本2.0许可</a> 。</p>
<p class="menu"><a href="./mod/index.html">模块</a> | <a href="./mod/directives.html">指令</a> | <a href="http://wiki.apache.org/httpd/FAQ">常见问题</a> | <a href="./glossary.html">词汇表</a> | <a href="./sitemap.html">网站地图</a></p></div><script type="text/javascript"><!--//--><![CDATA[//><!--
if (typeof(prettyPrint) !== 'undefined') {
    prettyPrint();
}
//--><!]]></script>

</body></html>