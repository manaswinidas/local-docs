<html lang="en-us"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us"><!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--><head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta name="copyright" content="(C) Copyright 2005">
<meta name="DC.rights.owner" content="(C) Copyright 2005">
<meta name="security" content="public">
<meta name="Robots" content="index,follow">
<meta http-equiv="PICS-Label" content="(PICS-1.1 " http:="" ="" www.icra.org="" ratingsv02.htm="=" www.rsac.org="" ratingsv01.htm="=" (ss~~000="" 1)="=">
<meta name="DC.Type" content="concept">
<meta name="DC.Title" content="Transaction-based lock escalation">
<meta name="abstract" content="The optimizer makes its decisions for the scope of a single statement at compile time; the runtime overrides are also for the scope of a single statement.">
<meta name="description" content="The optimizer makes its decisions for the scope of a single statement at compile time; the runtime overrides are also for the scope of a single statement.">
<meta name="DC.subject" content="Lock escalation, at runtime (for transaction)">
<meta name="keywords" content="Lock escalation, at runtime (for transaction)">
<meta name="DC.Relation" scheme="URI" content="ctunoptimz27975.html">
<meta name="DC.Relation" scheme="URI" content="ctunoptimz11775.html">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="ctunoptimz42065">
<meta name="DC.Language" content="en-us">
<link href="commonltr.css" type="text/css" rel="stylesheet">
<title>基于事务的锁升级</title>
</head>
<body id="ctunoptimz42065" ><a name="ctunoptimz42065"><!-- --></a>


<h1 class="topictitle1">基于事务的锁升级</h1>



<div><p>优化器在编译时针对单个语句的范围做出决定。运行时覆盖也适用于单个语句的范围。</p>

<p>如您所知，一个事务可以跨越多个语句。对于以TRANSACTION_SERIALIZABLE隔离运行的连接以及进行大量插入或更新的连接，即使没有单个语句会接触到足够多的行以使优化程序为任何单个表选择表级锁定，事务也可以累积许多行锁。 。</p>

<p>但是，在事务期间， <span>Derby</span>系统会跟踪事务中所有表的锁定数量，并且当该数量超过阈值数量（您可以配置该阈值；请参阅“ <a href="ctunoptimz26019.html">锁定升级阈值”</a> ）时，系统会尝试至少升级锁定。从行级锁定到表级锁定的表之一。</p>

<p>系统尝试通过尝试获取相关的表锁，尝试将每个具有繁重锁的表升级为表级锁。如果系统可以不等待而锁定表，则系统将锁定整个表并释放该表的所有行锁。如果系统在不等待的情况下无法锁定表，则系统将保持行锁定不变。</p>

<p>在以任何一种模式锁定表之后，事务不会在表上获取任何后续的行级锁定。例如，如果您有一个名为<samp class="codeph">Hotels</samp>包含数千行的数据，并且事务将其以共享模式锁定整个表以读取数据，因此以后可能需要以独占模式锁定特定的行以更新该行。但是，以前的表级锁定<samp class="codeph">Hotels</samp>还将排他锁也强制为表级。</p>

<p>该基于事务的运行时决策独立于任何编译决策。</p>

<p>如果超过升级阈值时，系统由于必须等待而没有获得任何表锁，则下一次锁升级尝试将延迟，直到所持有的锁的数量增加了很多，例如从5000增加到6000。</p>

<p>以下是一些示例，假设升级阈值为5000。</p>
 
<p>在下表中，单个数据库表拥有大多数锁。</p>


<div class="tablenoborder"><table cellspacing="0" cellpadding="4" border="1" summary="This table shows an example of lock escalation when one table holds the majority of the locks." frame="border" rules="all"><caption>表格1。拥有大部分锁的单桌</caption>



<thead align="left">
<tr valign="bottom">
<th valign="bottom" width="28.999999999999996%" id="N100C1">表</th>

<th valign="bottom" width="47%" id="N100C8">行锁数量</th>

<th valign="bottom" width="24%" id="N100CF">升级？</th>
</tr>

</thead>

<tbody>
<tr>
<td valign="top" width="28.999999999999996%" headers="N100C1"><samp class="codeph">Hotels</samp></td>

<td valign="top" width="47%" headers="N100C8">4853</td>

<td valign="top" width="24%" headers="N100CF">是</td>
</tr>

<tr>
<td valign="top" width="28.999999999999996%" headers="N100C1"><samp class="codeph">Countries</samp></td>

<td valign="top" width="47%" headers="N100C8">3</td>

<td valign="top" width="24%" headers="N100CF">没有</td>
</tr>

<tr>
<td valign="top" width="28.999999999999996%" headers="N100C1"><samp class="codeph">Cities</samp></td>

<td valign="top" width="47%" headers="N100C8">12</td>

<td valign="top" width="24%" headers="N100CF">没有</td>
</tr>

</tbody>

</table>
</div>

<p>在下表中，两个数据库表拥有大多数锁。</p>


<div class="tablenoborder"><table cellspacing="0" cellpadding="4" border="1" summary="This table shows an example of lock escalation when two tables hold the majority of the locks." frame="border" rules="all"><caption>表2。两张桌子持有大部分锁</caption>



<thead align="left">
<tr valign="bottom">
<th valign="bottom" width="28.999999999999996%" id="N1017C">表</th>

<th valign="bottom" width="47%" id="N10183">行锁数量</th>

<th valign="bottom" width="24%" id="N1018A">升级？</th>
</tr>

</thead>

<tbody>
<tr>
<td valign="top" width="28.999999999999996%" headers="N1017C"><samp class="codeph">Hotels</samp></td>

<td valign="top" width="47%" headers="N10183">2349</td>

<td valign="top" width="24%" headers="N1018A">是</td>
</tr>

<tr>
<td valign="top" width="28.999999999999996%" headers="N1017C"><samp class="codeph">Countries</samp></td>

<td valign="top" width="47%" headers="N10183">3</td>

<td valign="top" width="24%" headers="N1018A">没有</td>
</tr>

<tr>
<td valign="top" width="28.999999999999996%" headers="N1017C"><samp class="codeph">Cities</samp></td>

<td valign="top" width="47%" headers="N10183">1800</td>

<td valign="top" width="24%" headers="N1018A">是</td>
</tr>

</tbody>

</table>
</div>

<p>在下表中，许多数据库表都拥有少量的锁。</p>


<div class="tablenoborder"><table cellspacing="0" cellpadding="4" border="1" summary="This table shows an example of lock escalation when many tables hold a small number of locks." frame="border" rules="all"><caption>表3。许多桌子上有少量的锁</caption>



<thead align="left">
<tr valign="bottom">
<th valign="bottom" width="27%" id="N10237">表</th>

<th valign="bottom" width="48%" id="N1023E">行锁数量</th>

<th valign="bottom" width="25%" id="N10245">升级？</th>
</tr>

</thead>

<tbody>
<tr>
<td valign="top" width="27%" headers="N10237"><samp class="codeph">table001</samp></td>

<td valign="top" width="48%" headers="N1023E">279</td>

<td valign="top" width="25%" headers="N10245">没有</td>
</tr>

<tr>
<td valign="top" width="27%" headers="N10237"><samp class="codeph">table002</samp></td>

<td valign="top" width="48%" headers="N1023E">142</td>

<td valign="top" width="25%" headers="N10245">没有</td>
</tr>

<tr>
<td valign="top" width="27%" headers="N10237"><samp class="codeph">table003</samp></td>

<td valign="top" width="48%" headers="N1023E">356</td>

<td valign="top" width="25%" headers="N10245">没有</td>
</tr>

<tr>
<td valign="top" width="27%" headers="N10237"><samp class="codeph">table004</samp></td>

<td valign="top" width="48%" headers="N1023E">79</td>

<td valign="top" width="25%" headers="N10245">没有</td>
</tr>

<tr>
<td valign="top" width="27%" headers="N10237"><samp class="codeph">table194</samp></td>

<td valign="top" width="48%" headers="N1023E">384</td>

<td valign="top" width="25%" headers="N10245">没有</td>
</tr>

<tr>
<td valign="top" width="27%" headers="N10237"><samp class="codeph">table195</samp></td>

<td valign="top" width="48%" headers="N1023E">416</td>

<td valign="top" width="25%" headers="N10245">没有</td>
</tr>

</tbody>

</table>
</div>

</div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>父主题：</strong> <a href="ctunoptimz27975.html" title="行级锁定提高了多用户系统中的并发性。但是，大量的行锁会降低性能。">锁定和性能</a></div>
</div>
<div class="relconcepts"><strong>相关概念</strong><br>
<div><a href="ctunoptimz11775.html" title="您可以使用LOCK TABLE语句在事务期间显式锁定表。">在事务期间锁定表</a></div>
</div>
</div>



</body></html>