<html lang="en-us"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us"><!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--><head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta name="copyright" content="(C) Copyright 2005">
<meta name="DC.rights.owner" content="(C) Copyright 2005">
<meta name="security" content="public">
<meta name="Robots" content="index,follow">
<meta http-equiv="PICS-Label" content="(PICS-1.1 " http:="" ="" www.icra.org="" ratingsv02.htm="=" www.rsac.org="" ratingsv01.htm="=" (ss~~000="" 1)="=">
<meta name="DC.Type" content="concept">
<meta name="DC.Title" content="Pitfalls of sharing a connection among threads">
<meta name="abstract" content="Here is a review of the potential pitfalls of sharing a single Connection among multiple threads.">
<meta name="description" content="Here is a review of the potential pitfalls of sharing a single Connection among multiple threads.">
<meta name="DC.Relation" scheme="URI" content="cdevconcepts65864.html">
<meta name="DC.Relation" scheme="URI" content="rdevconcepts600.html">
<meta name="DC.Relation" scheme="URI" content="cdevconcepts23499.html">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="cdevconcepts89498">
<meta name="DC.Language" content="en-us">
<link href="commonltr.css" type="text/css" rel="stylesheet">
<title>在线程之间共享连接的陷阱</title>
</head>
<body id="cdevconcepts89498" ><a name="cdevconcepts89498"><!-- --></a>


<h1 class="topictitle1">在线程之间共享连接的陷阱</h1>



<div><p>这里是对在多个线程之间共享一个<em>Connection</em>的潜在陷阱的回顾。</p>

<ul>
<li>提交或回滚事务会关闭所有打开的<em>ResultSet</em>对象和当前正在执行的<em>Statements</em> ，除非您使用保留的游标。<p>如果有一个线程提交，它将使用同一连接关闭所有其他线程的<em>Statements</em>和<em>ResultSets</em> 。</p>
</li>

<li>执行一条<em>语句会</em>自动关闭该<em>语句</em>的较早执行所生成的任何现有打开的<em>ResultSet</em> 。<p>如果线程共享<em>Statements</em> ，则一个线程可以关闭另一个线程的<em>ResultSet。</em></p>
</li>

</ul>

<p>在许多情况下，将每个线程分配给不同的<em>Connection</em>更为容易。如果线程<em>A进行的</em>数据库工作与线程<em>B</em>无关，则将它们分配给不同的<em>Connections</em> 。例如，如果线程<em>A</em>与允许用户删除酒店的用户输入窗口相关联，线程<em>B</em>与允许用户查看城市信息的用户窗口相关联，则将这些线程分配给不同的<em>Connections</em> 。这样，当线程<em>A</em>提交时，它不会影响线程B的任何<em>ResultSet</em>或<em>Statements</em> 。</p>

<p>另一种策略是让一个线程进行查询，而另一个线程进行更新。查询将持有共享锁，直到事务以SERIALIZABLE隔离模式提交为止；使用READ_COMMITTED代替。</p>

<p>还有另一种策略是只有一个线程可以进行数据库访问。让其他线程从数据库访问线程获取信息。</p>

<p>允许多个线程共享<em>Connection</em> ， <em>Statement</em>或<em>ResultSet</em> 。但是，应用程序程序员必须确保一个线程不影响其他线程的行为。</p>

<div class="section"><h2 class="sectiontitle">推荐做法</h2><p>以下是一些避免意外行为的提示：</p>
<ul>
<li>避免共享<em>声明</em> （以及它们的<samp class="codeph"><em>ResultSets</em></samp> ）。</li>

<li>每次线程执行一个<em>Statement时</em> ，它应该在放弃之前处理结果。 <samp class="codeph"><em>Connection</em></samp> 。</li>

<li>每次线程访问<em>Connection时</em> ，它都应根据应用程序协议一致地提交或不提交。</li>

<li>有一个线程是“管理”数据库<em>连接</em>线程，该线程应该处理更高级别的任务，例如建立<samp class="codeph"><em>Connection</em></samp> ，提交，回滚，更改<samp class="codeph"><em>Connection</em></samp>属性，例如自动提交，关闭<samp class="codeph"><em>Connection</em></samp> ，关闭数据库（在嵌入式环境中）等。</li>

<li>关闭<em>结果集</em>和<samp class="codeph"><em>Statements</em></samp>释放资源不再需要的资源。</li>

</ul>
</div>

</div>

<div>
<div class="familylinks">
<div class="parentlink"><strong>父主题：</strong> <a href="cdevconcepts23499.html" title="JDBC允许您在多个线程之间共享一个连接。">使用共享单个连接的多个线程</a></div>
</div>
<div class="relconcepts"><strong>相关概念</strong><br>
<div><a href="cdevconcepts65864.html" title="您可能正在多个线程之间共享一个连接，因为使用单独的事务时并发性很差。">多线程编程技巧</a></div>
</div>
<div class="relref"><strong>相关参考</strong><br>
<div><a href="rdevconcepts600.html" title="此示例显示了如果两个线程尝试共享一个Statement会发生什么。">线程共享语句的示例</a></div>
</div>
</div>



</body></html>