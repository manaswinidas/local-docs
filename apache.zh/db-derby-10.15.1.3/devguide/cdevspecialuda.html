<html lang="en-us"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us"><!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--><head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta name="copyright" content="(C) Copyright 2005">
<meta name="DC.rights.owner" content="(C) Copyright 2005">
<meta name="security" content="public">
<meta name="Robots" content="index,follow">
<meta http-equiv="PICS-Label" content="(PICS-1.1 " http:="" ="" www.icra.org="" ratingsv02.htm="=" www.rsac.org="" ratingsv01.htm="=" (ss~~000="" 1)="=">
<meta name="DC.Type" content="concept">
<meta name="DC.Title" content="Programming user-defined aggregates">
<meta name="abstract" content="Derby allows you to create custom aggregate operators, called user-defined aggregates (UDAs).">
<meta name="description" content="Derby allows you to create custom aggregate operators, called user-defined aggregates (UDAs).">
<meta name="DC.subject" content="aggregates, user-defined, user-defined aggregates, programming">
<meta name="keywords" content="aggregates, user-defined, user-defined aggregates, programming">
<meta name="DC.Relation" scheme="URI" content="cdevspecial.html">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="cdevspecialuda">
<meta name="DC.Language" content="en-us">
<link href="commonltr.css" type="text/css" rel="stylesheet">
<title>编程用户定义的聚合</title>
</head>
<body id="cdevspecialuda" ><a name="cdevspecialuda"><!-- --></a>


<h1 class="topictitle1">编程用户定义的聚合</h1>



<div><p><span>Derby</span>允许您创建自定义的聚合运算符，称为用户定义的聚合（UDA）。
</p>

<div class="section"><p>UDA是实现<em>org.apache.derby.agg的Java类<em>。聚合器</em>接口。</em></p><em>

<p><em>org.apache.derby.agg。聚合器</em>接口扩展了<em>java.io。可序列化</em> ，因此您必须确保UDA的所有状态都可序列化。当UDA在大量组上执行分组聚合时，可能会序列化到磁盘。也就是说，可以将中间结果序列化到磁盘以进行如下查询：</p>

<pre>SELECT a, myAggregate( b ) FROM myTable GROUP BY a</pre>

<p>如果UDA包含不可序列化的字段，则序列化将失败。</p>

<p>下列类提供了一个聚合，该聚合从对象列表中计算出中间值。这是一个通用类。它的参数必须是线性（ <em>Comparable</em> ）类型。</p>

<pre>import java.util.ArrayList;
import java.util.Collections;
import org.apache.derby.agg.Aggregator;

public class Median&lt;V extends Comparable&lt;V&gt;&gt; 
        implements Aggregator&lt;V,V,Median&lt;V&gt;&gt;
{
    private ArrayList&lt;V&gt; _values;

    public Median() {}

    public void init() { _values = new ArrayList&lt;V&gt;(); }

    public void accumulate( V value ) { _values.add( value ); }

    public void merge( Median&lt;V&gt; other )
    { 
        _values.addAll( other._values ); 
    }

    public V terminate()
    {
        Collections.sort( _values );

        int count = _values.size();
        
        if ( count == 0 ) { return null; }
        else { return _values.get( count/2 ); }
    }
}</pre>

<p>使用此通用类，我们可以为所有可排序的<span>Derby</span>数据类型声明UDA。例如：</p>

<pre><strong>create derby aggregate intMedian for int external name 'Median';
create derby aggregate varcharMedian for varchar( 32672 ) external name
  'Median';</strong>
</pre>

<p>然后，我们可以像内置<span>Derby</span>聚合一样使用这些UDA：</p>

<pre><strong>create table intValues( a int, b int );
create table varcharValues( a int, b varchar( 32672 ) );
insert into intValues values ( 1, 1 ), ( 1, 10 ), ( 1, 100 ), 
  ( 1, 1000 ), ( 2, 5 ), ( 2, 50 ), ( 2, 500 ), ( 2, 5000 );
insert into varcharValues values ( 1, 'a' ), ( 1, 'ab' ), ( 1, 'abc' ), 
  ( 2, 'a' ), ( 2, 'aa' ), ( 2, 'aaa' );

select a, intMedian( b ) from intValues group by a;</strong>
<tt class="sysout">A          |2
-----------------------
1          |100
2          |500
</tt>
<strong>select varcharMedian( b ) from varcharValues;</strong>
<tt class="sysout">1
---
aaa</tt>
</pre>

<p>有关更多信息，请参见《 <span><em>Derby参考手册</em></span> 》中的“ CREATE DERBY AGGREGATE语句”。</p>

</em></div><em>

</em></div><em>

<div>
<div class="familylinks">
<div class="parentlink"><strong>父主题：</strong> <a href="cdevspecial.html" title="本节讨论Derby的特殊编程。">Derby服务器端编程</a></div>
</div>
</div>



</em></body></html>