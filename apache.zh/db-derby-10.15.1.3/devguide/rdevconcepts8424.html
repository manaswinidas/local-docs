<html lang="en-us"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us">
<!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta name="copyright" content="(C) Copyright 2005">
<meta name="DC.rights.owner" content="(C) Copyright 2005">
<meta name="security" content="public">
<meta name="Robots" content="index,follow">
<meta http-equiv="PICS-Label" content="(PICS-1.1 &quot;http://www.icra.org/ratingsv02.html&quot; l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) &quot;http://www.rsac.org/ratingsv01.html&quot; l gen true r (n 0 s 0 v 0 l 0) &quot;http://www.classify.org/safesurf/&quot; l gen true r (SS~~000 1))">
<meta name="DC.Type" content="reference">
<meta name="DC.Title" content="Scope of locks">
<meta name="abstract" content="The amount of data locked by a statement can vary.">
<meta name="description" content="The amount of data locked by a statement can vary.">
<meta name="DC.subject" content="locks, table-level, row-level, range, table-level locks, row-level locks, range locks, isolation levels, REPEATABLE_READ, READ_COMMITTED, SERIALIZABLE, READ_UNCOMMITTED, transactions">
<meta name="keywords" content="locks, table-level, row-level, range, table-level locks, row-level locks, range locks, isolation levels, REPEATABLE_READ, READ_COMMITTED, SERIALIZABLE, READ_UNCOMMITTED, transactions">
<meta name="DC.Relation" scheme="URI" content="cdevconcepts15366.html">
<meta name="DC.Relation" scheme="URI" content="cdevconcepts842279.html">
<meta name="DC.Relation" scheme="URI" content="cdevconcepts842304.html">
<meta name="DC.Relation" scheme="URI" content="cdevconcepts842385.html">
<meta name="DC.Relation" scheme="URI" content="rdevconcepts2462.html">
<meta name="DC.Relation" scheme="URI" content="cdevconcepts842613.html">
<meta name="DC.Relation" scheme="URI" content="cdevconcepts36402.html">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="rdevconcepts8424">
<meta name="DC.Language" content="en-us">
<link href="commonltr.css" type="text/css" rel="stylesheet">
<title>锁范围</title>
</head>
<body id="rdevconcepts8424" ><a name="rdevconcepts8424"><!-- --></a>


<h1 class="topictitle1">锁范围</h1>



<div><p>语句锁定的数据量可能会有所不同。</p>

<div class="section"><h2 class="sectiontitle">餐桌锁</h2><p>一条语句可以锁定<em>整个表</em> 。</p>
<p>表级锁定系统始终锁定整个表。</p>
<p>如果语句的WHERE子句不能使用索引，则行级锁定系统可以锁定整个表。例如，不能使用索引的UPDATES会锁定整个表。</p>
<p>如果大量单行锁的效率不如单个表级锁，那么行级锁定系统可以锁定整个表。出于性能考虑，选择表级锁定而不是行级锁定称为<em>锁升级</em> 。有关此主题的更多信息，请参见<span><em>Tuning Derby中的</em></span> “关于系统对锁粒度的选择”和“基于事务的锁升级”。</p>
</div>

<div class="section"><h2 class="sectiontitle">单排锁</h2><p>一条语句一次只能锁定<em>一行</em> 。</p>
<div class="p">对于行级锁定系统：<ul>
<li>对于TRANSACTION_REPEATABLE_READ隔离，锁在事务结束时释放。</li>

<li>对于TRANSACTION_READ_COMMITTED隔离， <span>Derby</span>仅在应用程序逐步浏览结果中的行时锁定行。当前行被锁定。当应用程序转到下一行时，将释放行锁。</li>

<li>但是，对于TRANSACTION_SERIALIZABLE隔离， <span>Derby</span>会在应用程序开始逐步执行之前锁定整个集合。</li>

<li>对于TRANSACTION_READ_UNCOMMITTED，不请求任何行锁。</li>

</ul>
 </div>
<p><span>Derby</span>锁定INSERT语句的单行，保留每一行，直到提交事务为止。如果存在与该表关联的索引，则前一个键也将被锁定。</p>
</div>

<div class="section"><h2 class="sectiontitle">范围锁</h2><p>一条语句可以锁定<em>一定范围的行</em> （范围锁定）。</p>
<div class="p">对于行级锁定系统：<ul>
<li>对于<em>任何</em>隔离级别， <span>Derby都会</span>锁定<em>结果中的所有行</em>以及整个行范围以进行更新或删除。</li>

<li>对于TRANSACTION_SERIALIZABLE隔离级别， <span>Derby</span>锁定结果中的所有行以及表中用于SELECT的整个行范围，以防止不可重复的读取和幻像。</li>

</ul>
</div>
<p>例如，如果SELECT语句在<em>Employee</em>表中指定了<em>薪水</em>介于两个值之间的行，则系统可以锁定的不止是它返回结果中的实际行。它还必须锁定两个值之间的整个行<em>范围</em> ，以防止另一个事务插入，删除或更新该范围内的行。</p>
<p>索引必须可用于范围锁定。如果一个不可用， <span>Derby</span>将锁定整个表。</p>

<p>下表总结了锁定的类型和范围。</p>


<div class="tablenoborder"><table cellspacing="0" cellpadding="4" border="1" summary="This table shows the behavior of table-level locking and row-level locking for each transaction level." frame="border" rules="all"><caption>表格1。锁定的类型和范围</caption>



<thead align="left">
<tr valign="bottom">
<th valign="bottom" width="60%" id="N101BD">交易隔离级别</th>

<th valign="bottom" width="20%" id="N101C4">表级锁定</th>

<th valign="bottom" width="20%" id="N101CB">行级锁定</th>

</tr>

</thead>

<tbody>
<tr>
<td valign="top" width="60%" headers="N101BD">连接。TRANSACTION_READ_UNCOMMITTED（SQL：UR）</td>

<td valign="top" width="20%" headers="N101C4">对于SELECT语句，从不使用此隔离级别请求表级锁定。对于其他语句，与TRANSACTION_READ_COMMITTED相同。</td>

<td valign="top" width="20%" headers="N101CB">SELECT语句没有锁。对于其他语句，与TRANSACTION_READ_COMMITTED相同。</td>

</tr>

<tr>
<td valign="top" width="60%" headers="N101BD">连接。TRANSACTION_READ_COMMITTED（SQL：CS）</td>

<td valign="top" width="20%" headers="N101C4">SELECT语句在整个表上获得共享锁。当用户关闭<em>ResultSet</em>时，将释放这些锁。其他语句获得整个表的排他锁，在事务提交时释放。</td>

<td valign="top" width="20%" headers="N101CB">用户逐步浏览<em>ResultSet时，</em> SELECTs会锁定并释放单行。UPDATE和DELETE在一系列行上获得排他锁。INSERT语句在单行（有时在前面的行）上获得排他锁。</td>

</tr>

<tr>
<td valign="top" width="60%" headers="N101BD">连接。TRANSACTION_REPEATABLE_READ（SQL：RS）</td>

<td valign="top" width="20%" headers="N101C4">与TRANSACTION_SERIALIZABLE相同</td>

<td valign="top" width="20%" headers="N101CB">SELECT语句在满足WHERE子句的行上获得共享锁（但不阻止插入该范围）。UPDATE和DELETE在一系列行上获得排他锁。INSERT语句在单行（有时在前面的行）上获得排他锁。</td>

</tr>

<tr>
<td valign="top" width="60%" headers="N101BD">连接。TRANSACTION_SERIALIZABLE（SQL：RR）</td>

<td valign="top" width="20%" headers="N101C4">SELECT语句在整个表上获得共享锁。其他语句获得整个表的排他锁，在事务提交时释放。</td>

<td valign="top" width="20%" headers="N101CB">SELECT语句在一定范围的行上获得共享锁。UPDATE和DELETE语句在一定范围的行上获得排他锁。INSERT语句在单行（有时在前几行）上获得排他锁。</td>

</tr>

</tbody>

</table>
</div>
</div>

</div>

<div>
<div class="familylinks">
<div class="parentlink"><strong>父主题：</strong> <a href="cdevconcepts36402.html" title="Derby系统中有几种类型的锁，包括排他锁，共享锁和更新锁。">Derby系统中锁的类型和范围</a></div>
</div>
<div class="relconcepts"><strong>相关概念</strong><br>
<div><a href="cdevconcepts15366.html" title="Derby提供了四个事务隔离级别。通过设置连接的事务隔离级别，用户可以指定将用户的事务与其他事务隔离的严重程度。">隔离级别和并发</a></div>
<div><a href="cdevconcepts842279.html" title="当语句修改数据时，其事务将对数据持有排他锁，以防止其他事务访问该数据。">排他锁</a></div>
<div><a href="cdevconcepts842304.html" title="当语句读取数据而不进行任何修改时，其事务将获得对数据的共享锁。">共享锁</a></div>
<div><a href="cdevconcepts842385.html" title="用户定义的更新游标（通过FOR UPDATE子句或使用并发模式ResultSet创建时）。CONCUR_UPDATABLE）读取数据，它的事务获取对该数据的更新锁。">更新锁</a></div>
<div><a href="cdevconcepts842613.html" title="除了已经描述的锁之外，外键查找还需要在引用的表（行或表，具体取决于配置）上短暂持有共享锁。">锁定注意事项</a></div>
</div>
<div class="relref"><strong>相关参考</strong><br>
<div><a href="rdevconcepts2462.html" title="下表显示了锁类型之间的兼容性。 “是”表示锁类型兼容，而“否”表示锁类型不兼容。">锁兼容性</a></div>
</div>
</div>

</body>
</html>