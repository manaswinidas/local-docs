<html lang="en-us"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us"><!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--><head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta name="copyright" content="(C) Copyright 2005">
<meta name="DC.rights.owner" content="(C) Copyright 2005">
<meta name="security" content="public">
<meta name="Robots" content="index,follow">
<meta http-equiv="PICS-Label" content="(PICS-1.1 " http:="" ="" www.icra.org="" ratingsv02.htm="=" www.rsac.org="" ratingsv01.htm="=" (ss~~000="" 1)="=">
<meta name="DC.Type" content="concept">
<meta name="DC.Title" content="Roll-forward recovery">
<meta name="abstract" content="Derby supports roll-forward recovery to restore a damaged database to the most recent state before a failure occurred.">
<meta name="description" content="Derby supports roll-forward recovery to restore a damaged database to the most recent state before a failure occurred.">
<meta name="DC.subject" content="Online archived logs, Online archived logs, enabling, disabling, Backing up, Roll-forward recovery">
<meta name="keywords" content="Online archived logs, Online archived logs, enabling, disabling, Backing up, Roll-forward recovery">
<meta name="DC.Relation" scheme="URI" content="cadminhubbkup98797.html">
<meta name="DC.Relation" scheme="URI" content="cadminbckupdb.html">
<meta name="DC.Relation" scheme="URI" content="tadminhubbkup44.html">
<meta name="DC.Relation" scheme="URI" content="tadmincrtdbbkup.html">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="cadminrollforward">
<meta name="DC.Language" content="en-us">
<link href="commonltr.css" type="text/css" rel="stylesheet">
<title>前滚恢复</title>
</head>
<body id="cadminrollforward" ><a name="cadminrollforward"><!-- --></a>


<h1 class="topictitle1">前滚恢复</h1>



<div><p><span>Derby</span>支持前滚恢复，以将损坏的数据库还原到发生故障之前的最新状态。</p>

<p><span>Derby</span>从完全备份中还原数据库，并在备份后重播所有事务。备份后，所有日志文件都需要重播备份后的事务。默认情况下，数据库仅保留崩溃恢复所需的日志。为了成功进行前滚恢复，必须在备份后将所有日志文件存档。可以使用启用日志归档的备份功能调用来归档日志文件。</p>

<p>在前滚恢复中，日志归档模式可确保所有旧日志文件均可用。日志文件仅在启用日志归档模式后才可用。</p>

<div class="p"><span>Derby</span>使用以下信息来还原数据库：<ul>
<li>数据库的备份副本</li>

<li>归档日志集</li>

<li>当前的在线活动日志</li>

</ul>
</div>

<p>您不能使用前滚恢复来还原单个表。前滚恢复将恢复整个数据库。</p>

<p>要使用前滚恢复来还原数据库，您必须已经具有该数据库的备份副本，自创建备份以来的所有存档日志以及活动日志文件。所有日志文件都应位于数据库日志目录中。</p>

<p><span>Derby中</span>有两种类型的日志文件：活动日志和联机归档日志。</p>

<dl>
<dt class="dlterm">活动日志</dt>

<dd>在崩溃恢复期间使用活动日志，以防止可能导致数据库处于不一致状态的故障。前滚恢复还可以使用活动日志恢复到日志文件的末尾。活动日志位于数据库日志路径目录中。</dd>


<dt class="dlterm">在线存档日志</dt>

<dd>当崩溃恢复不再需要存储用于前滚恢复的日志文件时，可以使用它们。联机存档的日志也保存在数据库日志路径目录中。</dd>

</dl>

<div class="section"><h2 class="sectiontitle">启用日志存档模式</h2>
<p>仅当数据库启用了日志归档模式时，联机归档日志才可用。您可以使用以下系统过程来使数据库启用日志归档模式：</p>

<pre>SYSCS_UTIL.SYSCS_BACKUP_DATABASE_AND_ENABLE_LOG_ARCHIVE_MODE
(IN BACKUPDIR VARCHAR(32672), IN SMALLINT DELETE_ARCHIVED_LOG_FILES)</pre>

<div class="p">此过程的输入参数指定备份的存储位置，并指定数据库是否应保留备份的联机存档日志。如果此备份的输入参数值为，则将删除此备份之前创建的现有联机存档日志文件。 <samp class="codeph">DELETE_ARCHIVED_LOG_FILES</samp>参数不为零。仅在成功备份后才删除日志文件。
<div class="note"><span class="notetitle">注意：</span>选择日志文件删除选项时，请确保将备份数据库存储在安全的地方。</div>
</div>

<p>的<samp class="codeph">SYSCS_UTIL.SYSCS_BACKUP_DATABASE_AND_ENABLE_LOG_ARCHIVE_MODE</samp>如果与备份过程相同的事务中有任何未记录的操作，则该过程将发出错误。</p>

<p>如果开始备份时系统中其他事务中正在进行任何未记录的操作，则此过程将阻塞，直到这些事务完成后再执行备份。
如果未备份的操作在备份进行过程中启动，则<span>Derby会</span>自动将它们转换为已记录模式（在数据库中维护应用程序jar文件的操作除外）。在备份过程中，将阻止安装，替换和删除数据库中的jar文件的过程。</p>

<p>如果您不希望备份在其他事务中未记录的操作完成之前阻塞，请使用<samp class="codeph">SYSCS_UTIL.SYSCS_BACKUP_DATABASE_AND_ENABLE_LOG_ARCHIVE_MODE_NOWAIT</samp>程序。如果有任何事务正在执行未记录的操作，则此过程会在备份开始时立即发出错误，而不是等待这些事务完成。</p>

</div>

<div class="section"><h2 class="sectiontitle">禁用日志存档模式</h2>
<p>启用日志归档模式后，即使随后对其进行了引导或备份，数据库也将始终启用日志归档模式。禁用日志归档模式的唯一方法是运行以下过程：</p>

<pre>SYSCS_UTIL.SYSCS_DISABLE_LOG_ARCHIVE_MODE
(IN SMALLINT DELETE_ARCHIVED_LOG_FILES)</pre>

<p>如果输入参数，此系统过程将禁用日志归档模式并删除任何现有的联机归档日志文件<samp class="codeph">DELETE_ARCHIVED_LOG_FILES</samp>不为零。</p>

</div>

<div class="section"><h2 class="sectiontitle">执行前滚恢复</h2>
<p>如果您使用进行了备份<samp class="codeph">SYSCS_UTIL.SYSCS_BACKUP_DATABASE_AND_ENABLE_LOG_ARCHIVE_MODE</samp>要么<samp class="codeph">SYSCS_UTIL.SYSCS_BACKUP_DATABASE_AND_ENABLE_LOG_ARCHIVE_MODE_NOWAIT</samp> ，您可以使用完整的备份副本，归档的日志和活动的日志将其恢复到最新状态。通过指定连接URL属性来执行前滚恢复<samp class="codeph">rollForwardRecoveryFrom=<em>path</em></samp>在启动时。所有日志文件都应位于数据库日志路径目录中。</p>

<p>涉及的步骤如下。它们不显示启动命令<samp class="codeph">ij</samp> 。</p>

<ol>
<li><strong>在启用日志归档模式的情况下备份数据库。</strong>
<p>例如，您可以备份一个名为<samp class="codeph">wombat</samp>到<samp class="codeph">/backup</samp>目录如下。经过许多操作后，数据库崩溃。</p>

<pre>ij&gt; <strong>connect 'jdbc:derby:wombat;create=true';</strong>
ij&gt; <strong>create table t1(a int not null primary key);</strong>
0 rows inserted/updated/deleted
------------------DML/DDL Operations
ij&gt; <strong>CALL SYSCS_UTIL.SYSCS_BACKUP_DATABASE_AND_ENABLE_LOG_ARCHIVE_MODE
('/backup', 0);</strong>
0 rows inserted/updated/deleted
ij&gt; <strong>insert into t1 values(19);</strong>
1 row inserted/updated/deleted
ij&gt; <strong>create table t2(a int);</strong>
0 rows inserted/updated/deleted
-----------------DML/DDL Operations
-----------------Database Crashed (Media Corruption on data disks)</pre>

</li>

<li><strong>准备要还原的数据库。</strong>
<p>在还原数据库之前，请关闭原始数据库并重命名原始数据库目录。例如，关闭后，您可以在Linux Shell中发出以下命令：</p>

<pre><strong>mv /databases/wombat /databases/brokenwombat 
cd /databases</strong></pre>

</li>

<li><strong>使用前滚恢复还原数据库。</strong>
<p>由于您移动了数据库，因此需要指定<samp class="codeph">logDevice=<em>logDirectoryPath</em></samp>该属性以及<samp class="codeph">rollForwardRecoveryFrom=<em>path</em></samp>使用前滚恢复还原数据库时的“属性”属性。使用类似以下的命令（连接URL必须全部在一行上）：</p>

<pre>ij&gt; <strong>connect 'jdbc:derby:wombat;rollForwardRecoveryFrom=/backup/wombat;
logDevice=/databases/brokenwombat';</strong>
ij&gt; <strong>select * from t1;</strong>
A          
-----------
19         

1 row selected
---------------DML/DDL Operations</pre>

<p>从完全备份还原数据库后，将重播联机归档日志和活动日志中的事务。这将数据库恢复到最新状态。所有日志文件应位于目录指定的目录中。 <samp class="codeph">logDevice=<em>logDirectoryPath</em></samp>属性。</p>

</li>

</ol>

<p>有关更多信息，请参阅《 <span><em>Derby参考手册</em></span> 》中的“ rollForwardRecoveryFrom = path属性”和“ logDevice = logDirectoryPath属性”。</p>

</div>

</div>

<div>
<div class="familylinks">
<div class="parentlink"><strong>父主题：</strong> <a href="cadminhubbkup98797.html" title="Derby提供了一种在脱机或联机时备份数据库的方法。您也可以从指定位置还原完整备份。">备份和还原数据库</a></div>
</div>
<div class="relconcepts"><strong>相关概念</strong><br>
<div><a href="cadminbckupdb.html" title="您可以离线（关闭）或在线（正在运行）备份数据库。">备份资料库</a></div>
</div>
<div class="reltasks"><strong>相关任务</strong><br>
<div><a href="tadminhubbkup44.html" title="要通过从指定位置使用完整备份来还原数据库，请在启动时连接URL中指定restoreFrom = path属性。">从备份副本还原数据库</a></div>
<div><a href="tadmincrtdbbkup.html" title="要从指定位置的完整备份副本创建数据库，请在启动时连接URL中指定createFrom = path属性。">从备份副本创建数据库</a></div>
</div>
</div>



</body></html>