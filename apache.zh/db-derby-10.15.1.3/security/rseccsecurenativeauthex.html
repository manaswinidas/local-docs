<html lang="en-us"  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us"><!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--><head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta name="copyright" content="(C) Copyright 2005">
<meta name="DC.rights.owner" content="(C) Copyright 2005">
<meta name="security" content="public">
<meta name="Robots" content="index,follow">
<meta http-equiv="PICS-Label" content="(PICS-1.1 " http:="" ="" www.icra.org="" ratingsv02.htm="=" www.rsac.org="" ratingsv01.htm="=" (ss~~000="" 1)="=">
<meta name="DC.Type" content="reference">
<meta name="DC.Title" content="NATIVE authentication and SQL authorization example">
<meta name="abstract" content="This example consists of the program NativeAuthenticationExample.java, which shows how to use Derby's NATIVE user authentication and SQL authorization with either the embedded or the client driver.">
<meta name="description" content="This example consists of the program NativeAuthenticationExample.java, which shows how to use Derby's NATIVE user authentication and SQL authorization with either the embedded or the client driver.">
<meta name="DC.Relation" scheme="URI" content="csecauthorfine.html">
<meta name="DC.Relation" scheme="URI" content="cseccsecuregrantrevokeaccess.html">
<meta name="DC.Relation" scheme="URI" content="cseccsecureprivileges.html">
<meta name="DC.Relation" scheme="URI" content="cseccsecureroles.html">
<meta name="DC.Relation" scheme="URI" content="cseccsecuresqlauthupgrade.html">
<meta name="DC.Relation" scheme="URI" content="rseccsecuresqlauthexceptions.html">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="rseccsecurenativeauthex">
<meta name="DC.Language" content="en-us">
<link href="commonltr.css" type="text/css" rel="stylesheet">
<title>NATIVE身份验证和SQL授权示例</title>
</head>
<body id="rseccsecurenativeauthex" ><a name="rseccsecurenativeauthex"><!-- --></a>


<h1 class="topictitle1">NATIVE身份验证和SQL授权示例</h1>



<div><p>这个例子由程序组成<samp class="codeph">NativeAuthenticationExample.java</samp> ，显示了如何将<span>Derby</span>的NATIVE用户身份验证和SQL授权与嵌入式或客户端驱动程序一起使用。</p>

<div class="section">
<p>有关<a href="cseccsecurenativeauth.html">NATIVE认证</a>的信息，请参阅<a href="cseccsecurenativeauth.html">配置</a> NATIVE认证。有关使用SQL授权的更多信息，请参见“ <a href="csecauthorization.html#csecauthorization">配置用户授权”</a>下的其他主题。</p>

<p>该程序执行以下操作：</p>

<ol>
<li>使用系统属性将身份验证提供程序设置为<samp class="codeph">NATIVE:nativeAuthDB:LOCAL</samp> ， 意思是<samp class="codeph">nativeAuthDB</samp>是凭据数据库，所有用户凭据都存储在该数据库中。</li>

<li>如果使用客户端驱动程序运行程序，请启动网络服务器。</li>

<li>创建一个名为的数据库<samp class="codeph">nativeAuthDB</samp>作为用户<samp class="codeph">sysadm</samp> ，因此是<a href="cseccsecuredbowner.html">数据库所有者</a> 。只有数据库所有者有权设置和读取数据库属性。</li>

<li>呼叫<samp class="codeph">SYSCS_UTIL.SYSCS_CREATE_USER</samp>系统过程中创建多个用户： <samp class="codeph">noacc</samp> ， <samp class="codeph">guest</samp>和<samp class="codeph">sqlsam</samp> 。用户<samp class="codeph">sysadm</samp>已自动创建。</li>

<li>创建角色<samp class="codeph">adder</samp>和<samp class="codeph">viewer</samp> 。</li>

<li>授予角色<samp class="codeph">adder</samp>至<samp class="codeph">sqlsam</samp> ，并授予该角色<samp class="codeph">viewer</samp>至<samp class="codeph">guest</samp> 。</li>

<li>创建一个表， <samp class="codeph">accessibletbl</samp> ，然后在其中插入一个值。</li>

<li>授予SELECT和INSERT权限<samp class="codeph">accessibletbl</samp>至<samp class="codeph">adder</samp> 。</li>

<li>尝试在不提供凭据的情况下连接到数据库，并且按预期失败。</li>

<li>以尚未获得任何特权的用户身份连接到数据库。连接成功，但是用户不会尝试执行任何操作，因为不允许进行任何操作。</li>

<li>以以下方式连接到数据库<samp class="codeph">guest</samp> ，谁的角色<samp class="codeph">viewer</samp> 。</li>

<li>将当前角色设置为<samp class="codeph">viewer</samp> ;用户可以在表上成功执行SELECT语句，但不能执行INSERT语句。</li>

<li>以以下方式连接到数据库<samp class="codeph">sqlsam</samp> ，谁的角色<samp class="codeph">adder</samp> 。</li>

<li>将当前角色设置为<samp class="codeph">adder</samp> ;用户可以成功执行SELECT和INSERT语句，但是无法执行DELETE语句。</li>

<li>使用数据库所有者的连接<samp class="codeph">sysadm</samp> ，将删除表，两个角色以及之前创建的三个用户。</li>

<li>如果使用客户端驱动程序运行程序，请关闭网络服务器。</li>

<li>使用数据库所有者的凭据关闭连接并关闭<span>Derby</span> 。</li>

</ol>

<p>程序开头的注释中包含编译和运行程序的说明。 <samp class="codeph">DERBY_LIB</samp>是包含<span>Derby</span> jar文件的目录，通常是<samp class="codeph">DERBY_HOME/lib</samp> 。</p>

</div>

<div class="example"><h2 class="sectiontitle">的源代码<samp class="codeph">NativeAuthenticationExample.java</samp></h2>
<pre>// does not use derby.properties

import java.io.PrintWriter;
import java.sql.*;

import org.apache.derby.drda.NetworkServerControl;

/*
 * <p>
 * This program showcases how SQL authorization is automatically turned
 * on when you run with NATIVE authentication. You can run this program 
 * either embedded or client server.
 * </p>
 *
 * <p>
 * Here's how you compile the program:
 * </p>
 *
 * <pre>
 * javac -cp ${DERBY_LIB}/derbynet.jar NativeAuthenticationExample.java
 * </pre>
 *
 * <p>
 * Here's how you run the program embedded:
 * </p>
 *
 * <pre>
 * java -cp ${DERBY_LIB}/derby.jar:. NativeAuthenticationExample embedded
 * </pre>
 *
 * <p>
 * Here's how you run the program client/server:
 * </p>
 *
 * <pre>
 * java -cp \
 * ${DERBY_LIB}/derby.jar:${DERBY_LIB}/derbynet.jar:${DERBY_LIB}/derbyclient.jar:. \
 * NativeAuthenticationExample client
 * </pre>
 */
public class NativeAuthenticationExample
{
    /////////////////////////////////////////////////////////////////////
    //
    //  CONSTANTS
    //
    /////////////////////////////////////////////////////////////////////

    private static final String DB_NAME="nativeAuthDB";

    // stored as SYSADM
    private static final String DB_OWNER="sysadm"; 
    private static final String DB_OWNER_PASSWORD="shh123ihtybb87m";

    private static final String USER_WITHOUT_ROLE="NOACC";
    private static final String USER_WITHOUT_ROLE_PASSWORD="ajaxj3x9";

    private static final String READER="GUEST";
    private static final String READER_PASSWORD="java5w6x";

    private static final String WRITER="SQLSAM";
    private static final String WRITER_PASSWORD="light8q9bulb";

    private static final String EMBEDDED = "embedded";
    private static final String CLIENT = "client";

    /////////////////////////////////////////////////////////////////////
    //
    //  STATE
    //
    /////////////////////////////////////////////////////////////////////

    private boolean _runningEmbedded;
    private NetworkServerControl _server;

    /////////////////////////////////////////////////////////////////////
    //
    //  ENTRY POINT
    //
    /////////////////////////////////////////////////////////////////////

    public static void main( String... args )
    {
        NativeAuthenticationExample demo = parseArgs( args );

        if ( demo !=  null ) 
        { 
            demo.execute(); 
        }
        else 
        { 
            println( "Bad command line args." ); 
        }
    }
    
    private static NativeAuthenticationExample parseArgs( 
            String... args )
    {
        if ( (args == null) || (args.length != 1) ) 
        { 
            return null; 
        }

        String  mode = args[ 0 ];

        if ( EMBEDDED.equals( mode ) ) 
        { 
            return new NativeAuthenticationExample( true ); 
        }
        else if ( CLIENT.equals( mode ) ) 
        { 
            return new NativeAuthenticationExample( false ); 
        }
        else 
        { 
            return null; 
        }
    }
    
    /////////////////////////////////////////////////////////////////////
    //
    //  CONSTRUCTOR
    //
    /////////////////////////////////////////////////////////////////////

    private NativeAuthenticationExample( boolean runningEmbedded )
    {
        _runningEmbedded = runningEmbedded;
    }

    /////////////////////////////////////////////////////////////////////
    //
    //  FEATURE SHOWCASE
    //
    /////////////////////////////////////////////////////////////////////

    /** 
     * Run all of the experiments 
     */
    private void execute()
    {
        try
        {
            String  authenticationProvider = 
                                          "NATIVE:" + DB_NAME + ":LOCAL";
            
            // this turns on NATIVE authentication as well as 
            // SQL authorization
            println( "Setting authentication provider to " + 
                authenticationProvider );
            System.setProperty(  "derby.authentication.provider", 
                authenticationProvider );

            if ( !_runningEmbedded ) 
            { 
                startServer(); 
            }
            
            Connection  dboConn = createDatabase();

            createUsers( dboConn );
            createRoles( dboConn );
            createTable( dboConn );

            tryToConnectWithoutCredentials();   //should fail

            // a valid user can connect even if they haven't been 
            // assigned any roles
            getConnection( USER_WITHOUT_ROLE, 
                           USER_WITHOUT_ROLE_PASSWORD );

            verifyReaderPrivileges();
            verifyWriterPrivileges();

            println( "Using Database Owner connection again" );

            dropTable( dboConn );
            dropRoles( dboConn );
            dropUsers( dboConn );
            
            cleanUpAndShutDown();
            
        } catch (Exception e) 
        { 
            errorPrintAndExit( e ); 
        }
    }

    /**
     * Create more users. Note that the credentials for the Database
     * Owner were stored in the database automatically when the 
     * database was created.
     */
    public void createUsers( Connection conn ) 
        throws SQLException
    {
        println( "Storing some sample users in the database." );

        PreparedStatement   ps = prepare
            ( conn, "call syscs_util.syscs_create_user( ?, ? )" );

        createUser( ps, USER_WITHOUT_ROLE, USER_WITHOUT_ROLE_PASSWORD );
        createUser( ps, READER, READER_PASSWORD );
        createUser( ps, WRITER, WRITER_PASSWORD );

        ps.close();
    }
    
    private void createUser( PreparedStatement ps, String userName, 
            String password )
        throws SQLException
    {
        println( "Creating user " + userName );
        ps.setString( 1, userName );
        ps.setString( 2, password );
        ps.execute();
    }

    /** 
     * Create roles and grant them privileges. 
     */
    private void createRoles( Connection conn )
        throws SQLException
    {
        println( "Creating roles and granting privileges to them..." );
        
        execute( conn, "CREATE ROLE adder" );
        execute( conn, "CREATE ROLE viewer" );
        
        execute( conn, "GRANT adder TO " + WRITER );
        execute( conn, "GRANT viewer TO " + READER );
    }

    /** 
     * Create and populate a table and grant privileges related to it. 
     */
    private void createTable( Connection conn )
        throws SQLException
    {
        println("Creating table accessibletbl...");
        execute( conn, 
                 "CREATE TABLE accessibletbl(textcol VARCHAR(6))" );
        execute( conn, "INSERT INTO accessibletbl VALUES('hello')" );

        println( "Granting select/insert privileges to adder..." );
        execute( conn, 
                 "GRANT SELECT, INSERT ON accessibletbl TO adder" );

        println( "Granting select privileges to viewer" );
        execute( conn, "GRANT SELECT ON accessibletbl TO viewer" );
    }

    /**
     * Drop users except for Database Owner.
     */
    public void dropUsers( Connection conn ) 
        throws SQLException
    {
        println( "Dropping sample users from the database..." );

        PreparedStatement   ps = prepare
            ( conn, "call syscs_util.syscs_drop_user( ? )" );

        dropUser( ps, USER_WITHOUT_ROLE );
        dropUser( ps, READER );
        dropUser( ps, WRITER );

        ps.close();
    }
    
    private void dropUser( PreparedStatement ps, String userName )
        throws SQLException
    {
        println( "Dropping user " + userName );
        ps.setString( 1, userName );
        ps.execute();
    }

    /** 
     * Drop roles. 
     */
    private void dropRoles( Connection conn )
        throws SQLException
    {
        println( "Dropping roles..." );
        
        execute( conn, "DROP ROLE adder" );
        execute( conn, "DROP ROLE viewer" );
    }

    /** 
     * Drop the table. 
     */
    private void dropTable( Connection conn )
        throws SQLException
    {
        execute( conn, "DROP TABLE accessibletbl" );
    }

    /**
     * Try to connect without supplying credentials 
     */
    private void tryToConnectWithoutCredentials()
        throws Exception
    {
        println( "Trying to connect without supplying credentials..." );

        try {
            getConnection( null, null );
            println( "ERROR: Unexpectedly connected to database " + 
                     DB_NAME );
            cleanUpAndShutDown();
        } catch (SQLException e) 
        {
            if ( e.getSQLState().equals("08004") )
            {
                println
                    (
                     "As expected, could not get a connection without " +
                     "supplying credentials."
                     );
            } else
            {
                errorPrintAndExit( e );
            }
        }
    }

    /** 
     * Verify that the READER user can select but not insert 
     */
    private void verifyReaderPrivileges()
        throws Exception
    {
        Connection  readerConn = getConnection( READER, 
                                                READER_PASSWORD );

        println( "Setting role to VIEWER" );
        execute( readerConn, "SET ROLE VIEWER" );

        readRow( readerConn );    // should succeed
            
        try {
            writeRow( readerConn );
            println( "ERROR: Unexpectedly allowed to insert into table" );
            cleanUpAndShutDown();
        } catch (SQLException e) 
        {
            if ( e.getSQLState().equals("42500") ) 
            { 
                println( "As expected, failed to insert row." ); 
            }
            else 
            { 
                errorPrintAndExit(e); 
            }
        }

        readerConn.close();
    }

    /** 
     * Verify that the WRITER can read and write but not delete 
     */
    private void verifyWriterPrivileges()
        throws Exception
    {
        Connection  writerConn = getConnection( WRITER, 
                                                WRITER_PASSWORD );

        // set role to ADDER
        println( "Setting role to ADDER" );
        execute( writerConn, "SET ROLE ADDER" );

        // should succeed
        readRow( writerConn );
        writeRow( writerConn );
            
        try {
            deleteRow( writerConn );    // should fail
        
            println( "ERROR: Unexpectedly allowed to DELETE." );
            cleanUpAndShutDown();
        } catch (SQLException e) 
        {
            if ( e.getSQLState().equals("42500") ) 
            {
                println( "As expected, failed to delete rows." ); 
            }
            else 
            { 
                errorPrintAndExit(e); 
            }
        }

        writerConn.close();
    }
    
    private void readRow( Connection conn ) throws SQLException
    {
        PreparedStatement   ps = prepare
            ( conn, "SELECT * FROM sysadm.accessibletbl" );
        ResultSet   rs = ps.executeQuery();
        while( rs.next() )
        {
            println
                ( "Value of sysadm.accessibletbl/textcol = " + 
                    rs.getString( 1 ) );
        }
        rs.close();
        ps.close();
    }
    
    private void writeRow( Connection conn ) throws SQLException
    {
        execute( conn, 
                 "INSERT INTO sysadm.accessibletbl VALUES('guest')" );
    }
    
    private void    deleteRow( Connection conn ) throws SQLException
    {
        execute( conn, "DELETE FROM sysadm.accessibletbl" );
    }
    
    /////////////////////////////////////////////////////////////////////
    //
    //  SQL HELPERS
    //
    /////////////////////////////////////////////////////////////////////

    /** 
     * Execute a statement 
     */
    private void execute( Connection conn, String text )
        throws SQLException
    {
        PreparedStatement   ps = prepare( conn, text );

        ps.execute();
        ps.close();
    }

    /** 
     * Prepare a statement 
     */
    private PreparedStatement prepare( Connection conn, String text )
        throws SQLException
    {
        println( "    Preparing: " + text );
        return conn.prepareStatement( text );
    }
    
    /////////////////////////////////////////////////////////////////////
    //
    //  CONNECTION MANAGEMENT
    //
    /////////////////////////////////////////////////////////////////////

    /** 
     * Create the database 
     */
    private Connection createDatabase()
        throws SQLException
    {
        String  connectionURL = getConnectionURL
            ( DB_NAME, DB_OWNER, DB_OWNER_PASSWORD, true, false );

        println( "Creating database via this URL: " + connectionURL );

        return DriverManager.getConnection( connectionURL );
    }
    
    /** 
     * Shut down the engine and exit. 
     */
    private void cleanUpAndShutDown()
        throws Exception
    {
        // Shut down the server before the engine. this is so that
        // we can authenticate the shutdown credentials in the
        // booted database.
        if ( _server != null )
        { 
            stopServer(); 
        }

        // the engine should only be brought down locally
        _runningEmbedded = true;
        shutdownEngine();
        
        System.exit(1);
    }
    
    private void shutdownEngine()
    {
        String shutdownURL = getConnectionURL
            ( null, DB_OWNER, DB_OWNER_PASSWORD, false, true );

        try 
        {
            println( "Shutting down engine via this URL: " + 
                     shutdownURL );
            DriverManager.getConnection(  shutdownURL );
        } catch (SQLException se) 
        {
            if ( se.getSQLState().equals("XJ015") ) 
            { 
                println( "Derby engine shut down normally" ); 
            }
            else 
            { 
                printSQLException( se ); 
            }
        }
    }
    
    /** 
     * Get a connection to the database 
     */
    private Connection getConnection( String userName, String password )
        throws SQLException
    {
        String  connectionURL = getConnectionURL
            ( DB_NAME, userName, password, false, false );

        println( "Getting connection via this URL: " + connectionURL );

        return DriverManager.getConnection( connectionURL );
    }
    
    private String getConnectionURL( String dbName, String userName, 
        String password, boolean createDB, boolean shutdownDB )
    {
        String  connectionURL = _runningEmbedded ?
            "jdbc:derby:" : 
            "jdbc:derby://localhost:1527/";

        if ( dbName != null ) 
        { 
            connectionURL = connectionURL + DB_NAME; 
        }
        if ( userName != null ) 
        { 
            connectionURL = connectionURL + ";user=" + userName; 
        }
        if ( password != null) 
        { 
            connectionURL = connectionURL + ";password=" + password;
        }
        if ( createDB ) 
        { 
            connectionURL = connectionURL + ";create=true"; 
        }
        if ( shutdownDB ) 
        { 
            connectionURL = connectionURL + ";shutdown=true"; 
        }

        return connectionURL;
    }

    /////////////////////////////////////////////////////////////////////
    //
    //  SERVER MANAGEMENT
    //
    /////////////////////////////////////////////////////////////////////

    /** 
     * Start the Derby server 
     */
    private void startServer()
        throws Exception
    {
        _server = new NetworkServerControl( DB_OWNER, 
                                            DB_OWNER_PASSWORD );

        println( "Starting the Derby server..." );
        _server.start( new PrintWriter( System.out ) );

        // pause to let the server come up
        Thread.sleep( 5000L );
    }

    /** 
     * Shut down the Derby server 
     */
    private void stopServer()
        throws Exception
    {
        println( "Stopping the Derby server..." );
        _server.shutdown();

        // pause to let the server come down
        Thread.sleep( 5000L );
    }

    /////////////////////////////////////////////////////////////////////
    //
    //  DIAGNOSTIC PRINTING
    //
    /////////////////////////////////////////////////////////////////////

    /** 
     * Report exceptions and exit. 
     */
    private void errorPrintAndExit( Throwable e )
    {
        if ( e instanceof SQLException ) 
        { 
            printSQLException((SQLException) e); 
        }
        else
        {
            println("A non-SQL error occurred.");
            e.printStackTrace();
        }
        
        System.exit(1);
    }

    /** 
     * Print a list of SQLExceptions. 
     */
    private void printSQLException( SQLException sqle )
    {
        while (sqle != null)
        {
            println("\n---SQLException Caught---\n");
            println("    SQLState:   " + (sqle).getSQLState());
            println("    Severity: " + (sqle).getErrorCode());
            println("    Message:  " + (sqle).getMessage());

            sqle.printStackTrace();

            sqle = sqle.getNextException();
        }
    }

    /** 
     * Print a diagnostic line to the console 
     */
    private static void println( String text ) 
    { 
        System.out.println( text ); 
    }
}</pre>

</div>

</div>

<div>
<div class="familylinks">
<div class="parentlink"><strong>父主题：</strong> <a href="csecauthorfine.html" title="您可以使用细粒度的用户授权（也称为SQL标准授权）来限制对特定数据的访问。">配置细粒度的用户授权</a></div>
</div>
<div class="relconcepts"><strong>相关概念</strong><br>
<div><a href="cseccsecuregrantrevokeaccess.html" title="启用SQL标准授权模式后，对象所有者可以使用GRANT和REVOKE SQL语句来设置特定数据库对象或特定SQL操作的用户特权。他们还可以使用角色来管理特权。">使用细粒度的用户授权</a></div>
<div><a href="cseccsecureprivileges.html" title="视图，触发器，约束和生成的列以视图，触发器，约束或生成的列的所有者的特权运行。">视图，触发器，约束和生成的列的特权</a></div>
<div><a href="cseccsecureroles.html" title="启用SQL标准授权模式后，对象所有者可以使用SQL角色工具来管理特权。">使用SQL角色</a></div>
<div><a href="cseccsecuresqlauthupgrade.html" title="以后可以通过身份验证和SQL授权来屏蔽未受保护的旧数据库。">升级旧数据库以使用SQL标准授权</a></div>
</div>
<div class="relref"><strong>相关参考</strong><br>
<div><a href="rseccsecuresqlauthexceptions.html" title="SQL授权发生错误时，将返回SQL异常。">SQL标准授权例外</a></div>
</div>
</div>



</body></html>