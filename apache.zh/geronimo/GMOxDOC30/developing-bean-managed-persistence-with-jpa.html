<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="http://geronimo.apache.org/style/default.css">
    <LINK rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <LINK rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <META name="Description" content="Developing bean managed persistence with JPA" />
    <META name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi Developing bean managed persistence with JPA" />
    <META name="Owner" content="dev@geronimo.apache.org" />
    <META name="Robots" content="index, follow" />
    <META name="Security" content="Public" />
    <META name="Source" content="wiki template" />
    <META name="DC.Date" scheme="iso8601" content="2010-05-11" />
    <META name="DC.Language" scheme="rfc1766" content="en" />
    <META name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation" />
    <META http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html" l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html" l gen true r (n 0 s 0 v 0 l 0) "http://www.classify.org/safesurf/" l gen true r (SS~~000 1))'/>

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>


    <title>Apache Geronimo v3.0 Documentation: Developing bean managed persistence with JPA</title>
  </head>

  <body onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tr>
        <td valing="top" align="left">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" align="left" nowrap>
          <a href="/geronimo"> Home</a> >&nbsp;<a href="documentation.html">Documentation</a>&nbsp;&gt;&nbsp;<a href="developing.html">Developing</a>&nbsp;&gt;&nbsp;<a href="tutorials.html">Tutorials</a>&nbsp;&gt;&nbsp;<a href="developing-jpa-applications.html">Developing JPA applications</a>&nbsp;&gt;&nbsp;<a href="developing-bean-managed-persistence-with-jpa.html">Developing bean managed persistence with JPA</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
        </td>
      </tr> 
    </table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div style="margin: 0px 10px 0px 10px" class="smalltext">Apache Geronimo v3.0</div>
        <div style="margin: 0px 10px 8px 10px"  class="pagetitle">Developing bean managed persistence with JPA</div>

        <div class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
<!-- -->         
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645263">
            <img src="http://geronimo.apache.org/images/icons/notep_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Edit Page"></a>
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645263">Edit Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">
            <img src="http://geronimo.apache.org/images/icons/browse_space.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Browse Space"></a>
            <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">Browse Space</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645263">
            <img src="http://geronimo.apache.org/images/icons/add_page_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add Page"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645263">Add Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645263">
            <img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add News"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645263">Add News</a>
<!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent"><plain-text-body>{scrollbar}</plain-text-body>
<p>The Java Persistence API is a new programming model under EJB3.0 specification (JSR220) for the management of persistence and object/relational mapping with Java EE and Java SE. With JPA, developers can easily develop java applications that perform operations on relational database management systems using java objects and mapping. In that way, java applications developed using JPA are not only portable across different platforms, but also applications can be easily developed using simple yet powerful programming model provided by JPA. This greatly improves application maintainability against ever changing database world. JPA insulates applications from all the complexity and non-portable boilerplate code involved in database connectivity and operations.</p>

<p>Apache geronimo uses <a shape="rect" class="external-link" href="http://openjpa.apache.org/">OpenJPA</a> for providing Java Persistence API to Java EE applications deployed in the server. Even though JPA is a part of EJB3.0 spec, it is independent of it. Hence, JPA can be used in JavaSE, web and ejb applications in the same uniform way. </p>

<p>Below tutorial illustrates the use of application managed entity manager object. The <code>EntityManager</code> object is created from <code>EntityManagerFactory</code>. The <code>EntityManagerFactory</code> object is injected by the container when <code>@PersistenceUnit(unitName="&lt;PersistentUnitName&gt;")</code> annotation is used. The persistence context of the entity manager is not propagated along with any transaction that is currently active. If the transaction spans across components, all the entity manager object references that point to same persistence unit will have a different persistence context. Thus, any changes made to the entities through any entity manager reference, are not seen through other entity manager references. The persistence scope of the application managed entity manager is <code>Extended</code> by default. The <code>transaction-type</code> can be either <code>JTA</code> or <code>RESOURCE_LOCAL</code>. If the <code>transaction-type</code> is <code>JTA</code> the <code>EntityManager</code> can join the transaction by calling <code>joinTransaction()</code>  method. The <code>transaction-type</code> of <code>RESOURCE_LOCAL</code> is used in when the <code>EntityManager</code> is not interested to join the global transaction. This is typically used in non-JEE environments. In summary, the life cycle of the entity manager and the associated persistence context is not managed the container. It is the application's responsibility to close the <code>EntityManager</code> object explicitly. The persistence context spans beyond transactions by default.</p>

<p>The tutorial creates an enterprise application that has an ejb module and a web module. The ejb module uses <code>Account</code> entity and <code>Person</code> entity. The <code>Account</code> entity has <code>accountNumber</code>, <code>personId</code> and <code>balance</code> attributes. The <code>Person</code> entity has <code>personId</code>, <code>personName</code> and <code>address</code> attributes. The <code>personId</code> in <code>Account</code> entity refers to <code>personId</code> in <code>Person</code> entity. The <code>AccountBean</code> injects <code>EntityManagerFactory</code> from which it creates <code>EntityManager</code> object. It is a stateful session bean which has <code>Account</code> entity object, corresponding <code>Person</code> entity object, <code>EntityManager</code> object and <code>EntityManagerFactory</code> object as state fields. The bean has <code>updateAllValues(String address, String personName, double balance)</code> method that updates <code>Account</code> and <code>Person</code> entity attributes. It has also <code>deposit(double amount)</code> and <code>withdraw(double amount)</code> methods for withdrawing and depositing the amounts to the account. In all the above mentioned methods, the <code>EntityManager</code> object joins the active transaction using <code>joinTransaction()</code> method as the its <code>transaction-type</code> is <code>JTA</code> and bean's transaction is managed by the container. The <code>initialize(integer accountNumber)</code> initializes the bean with <code>Account</code> and <code>Person</code> entity objects corresponding to the <code>accountNumber</code> sent as the parameter. Finally, the <code>EntityManager</code> object is closed in the <code>destroy()</code> method.</p>

<p>The web module allows user to update the <code>Account</code> entity and <code>Person</code> entity attributes and transfer amount from one account to another using <code>AccountBean</code>. The <code>RetrieveAccount.jsp</code> performs update and the <code>TransferAmount.jsp</code> performs transfer of amount in a JTA transaction.</p>

<p>In order to develop, deploy and run the application, the following environment is required.</p>

<ul><li>Sun JDK 5.0+ (J2SE 1.5)</li><li>Eclipse 3.3.1.1 (Eclipse Classic package of Europa distribution), which is platform specific</li><li>Web Tools Platform (WTP) 2.0.1</li><li>Data Tools Platform (DTP) 1.5.1</li><li>Eclipse Modeling Framework (EMF) 2.3.1</li><li>Graphical Editing Framework (GEF) 3.3.1</li></ul>


<p>The tutorial is divided into the following sections.</p>

<ul><li>Setting the Eclipse environment</li><li>Creating ejb application with entities</li><li>Creating web application</li><li>Setting up the database tables and the Datasource.</li><li>Deploying the (ear) application</li><li>Running the application</li></ul>


<p>The entire application can be downloaded from this <a shape="rect" href="developing-bean-managed-persistence-with-jpa.data/BeanManagedJPA-EAR.ear?version=1&amp;modificationDate=1213679496000&amp;api=v2" data-linked-resource-id="20873807" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="BeanManagedJPA-EAR.ear" data-nice-type="Java Archive" data-linked-resource-content-type="application/octet-stream" data-linked-resource-container-id="20645263" data-linked-resource-container-version="22">link</a>.</p>

<h2 id="DevelopingbeanmanagedpersistencewithJPA-SettingtheEclipseenvironment">Setting the Eclipse environment</h2>

<p>1. Download Apache Geronimo2.1 and install it on the server. Look into the geronimo documentation for   <br clear="none">
   instructions.</p>

<p>2. Install the eclipse IDE and download geronimo eclipse plugin and install it on top of eclipse. Look into the<br clear="none">
   geronimo eclipse plugin documentation for instructions.</p>

<p>3. Create a runtime environment for Apache Geronimo2.1 in the eclipse. Look into the geronimo eclipse plugin <br clear="none">
   documentation for instructions to install a runtime for Apache Geronimo2.1.</p>

<h2 id="DevelopingbeanmanagedpersistencewithJPA-Creatingejbapplicationwithentities">Creating ejb application with entities</h2>

<p>1. Open the eclipse tool and change the perspective to <em>Java EE</em> by clicking on <br clear="none">
  <em>Windows =&gt; Open Perspective =&gt; Other</em>. It will open up <em>Open Perspective</em> wizard. Select <em>Java EE</em> from the <br clear="none">
   list and click <em>OK</em> button.</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/1.jpg"></span></p>

<p>2. Right click on the <em>Package Explorer</em> and select <em>EJB Project</em>. </p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/2.jpg"></span></p>

<p>3. This will open up the <em>New EJB Project</em> wizard. Provide the values for <em>Project Name</em>, <em>Target Runtime</em> as given in the screen shot below. Click on <em>Next</em> button.</p>
<rich-text-body>
<p>If target runtime is not setup, create a new target runtime pointing to geronimo installation directory. For more information, look at the geronimo documentation that explains setting up eclipse plugin for geronimo and setting up runtime environment. This setup is required to resolve class dependencies during compilation.</p></rich-text-body>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/3.jpg"></span></p>

<p>4. Select the check boxes as given in the screen shot below and click on the <em>Next</em> button.</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/4.jpg"></span></p>

<p>5. Select the checkboxes as given in the below screen shot and click on the <em>Next</em> button.</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/5.jpg"></span></p>


<p>6. Provide the following values in textboxes and click on the <em>Finish</em> button.</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/6.jpg"></span></p>

<p>7. Right click on the <em>BeanManagedJPA-EJB</em> project and navigate to <em>New =&gt; Class</em> option. Provide the <br clear="none">
   following values in the <em>New Java Class</em> wizard and click on <em>Finish</em> button.</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/7.jpg"></span></p>


<p>8. Copy the following contents into <code>Account.java</code>.</p>
<parameter ac:name="">JAVA</parameter><parameter ac:name="title">Account.java</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
package sample.jpa;

import java.io.Serializable;
import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.PostLoad;
import javax.persistence.PostUpdate;
import javax.persistence.PrePersist;
import javax.persistence.PreUpdate;
import javax.persistence.Table;


@Entity
@Table(name = "ACCOUNTBME")
public class Account implements Serializable {

 @Id
 public int accountNumber;
 public int personId;
 public double balance;

 public Account() {
 }

 public int getAccountNumber() {
  return accountNumber;
 }

 public void setAccountNumber(int accountNumber) {
  this.accountNumber = accountNumber;
 }

 public int getPersonId() {
  return personId;
 }

 public void setPersonId(int personId) {
  this.personId = personId;
 }

 public double getBalance() {
  return balance;
 }

 public void setBalance(double balance) {
  this.balance = balance;
 }
}
</plain-text-body>

<p>9. Similarly, as given in the previous step, create <code>Person.java</code> and add the following contents to it.</p>
<parameter ac:name="">JAVA</parameter><parameter ac:name="title">Person.java</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
package sample.jpa;

import java.io.Serializable;
import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.Table;


@Entity
@Table(name = "PERSONBME")
public class Person implements Serializable {

 @Id
 public int personId;
 public String personName;
 public String address;

 public Person() { }

 public int getPersonId() {
  return personId;
 }

 public void setPersonId(int personId) {
  this.personId = personId;
 }

 public String getPersonName() {
  return personName;
 }

 public void setPersonName(String personName) {
  this.personName = personName;
 }

 public String getAddress() {
  return address;
 }

 public void setAddress(String address) {
  System.out.println("Address="+address);
  this.address = address;
 }

}
</plain-text-body>

<p>9. Similarly, create <code>AccountInterface.java</code> and copy the following contents.</p>

<parameter ac:name="">JAVA</parameter><parameter ac:name="title">AccountInterface.java</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
package sample.jpa;

import java.util.Collection;

public interface AccountInterface {
 public void initialize(int accountNumber);
 public String getPersonName();
 public void setPersonName(String personName);
 public String getAddress();
 public void setAddress(String address);
 public double getBalance();
 public void setBalance(double balance);
 public void updateAllValues(String address, 
                             String personName, 
                             double balance);
 public void withdraw(double amount);
 public void deposit(double amount);
}
</plain-text-body>

<p>10. Similarly, create <code>AccountBean.java.java</code> and copy the following contents. Note that several lines have been truncated for display. </p>
<parameter ac:name="">JAVA</parameter><parameter ac:name="title">AccountBean.java</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
package sample.jpa;

import javax.annotation.PostConstruct;
import javax.ejb.Local;
import javax.ejb.Remove;
import javax.ejb.Stateful;
import javax.ejb.TransactionManagement;
import javax.ejb.TransactionManagementType;
import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.PersistenceUnit;


@Stateful
@TransactionManagement(TransactionManagementType.CONTAINER)
@Local(AccountInterface.class)
public class AccountBean implements AccountInterface{

 @PersistenceUnit(unitName="AccountUnit")
 private EntityManagerFactory emf;

 private EntityManager em;

 Account account;
 Person person;

 @PostConstruct
 public void init(){
  em = emf.createEntityManager();
 }

 public void initialize(int accountNumber){

  account = em.find(Account.class, accountNumber);

  if(account == null)throw new IllegalStateException
   ("Account number ("+accountNumber+") not found");

  person = em.find(Person.class, account.getPersonId());

  if(person == null)throw new 
   IllegalStateException("Person Id("+account.getPersonId()+") not found. There is a descripancy 
in the database for account number ("+accountNumber+")");
 }

 public String getPersonName(){
  return person.getPersonName();
 }

 public void setPersonName(String personName){
  person.setPersonName(personName);
 }

 public String getAddress(){
  return person.getAddress();
 }

 public void setAddress(String address){
  person.setAddress(address);
 }

 public void updateAllValues(String address, 
                             String personName, 
                             double balance){
  em.joinTransaction();
  setAddress(address);
  setPersonName(personName);
  setBalance(balance);
 }

 public double getBalance(){
  return account.getBalance();
 }

 public void setBalance(double balance){
  account.setBalance(balance);
 }

 public void withdraw(double amount){

  if(amount &gt; getBalance())throw new IllegalStateException ("The amount("+amount+") to be 
withdrawn is more than the available balance("+getBalance()+")");

  em.joinTransaction();
  setBalance(getBalance() - amount);

 }

 public void deposit(double amount){
  em.joinTransaction();
  setBalance(getBalance() + amount);
 }

 @Remove
 public void destroy(){
  em.close();
 }
}
</plain-text-body>

<p>11. As outlined above, right click on the <code>META_INF</code> directory of <code>BeanManagedJPA-EJB</code> project and  <br clear="none">
    create <code>persistence.xml</code>. Copy the following contents into <code>persistence.xml</code>.</p>

<parameter ac:name="title">persistence.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence"
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.0"
 xsi:schemaLocation="http://java.sun.com/xml/ns/persistence   
 http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd"&gt;

 &lt;persistence-unit name="AccountUnit" transaction-type="JTA"&gt;
  &lt;description&gt;ContainerManagedJPA&lt;/description&gt;
  &lt;provider&gt;org.apache.openjpa.persistence.PersistenceProviderImpl&lt;/provider&gt;
  &lt;jta-data-source&gt;AccountDS&lt;/jta-data-source&gt;
  &lt;class&gt;sample.jpa.Account&lt;/class&gt;
  &lt;class&gt;sample.jpa.Person&lt;/class&gt;
 &lt;/persistence-unit&gt;
&lt;/persistence&gt;
</plain-text-body>

<p>12. Since we are going to use EJB annotations, the <code>META-INF/ejb-jar.xml</code> will not have any declarations. The contents of the <code>META-INF/openejb-jar.xml</code> file should be as below. Otherwise, modify it accordingly.</p>

<parameter ac:name="title">openejb-jar.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;openejb-jar xmlns="http://openejb.apache.org/xml/ns/openejb-jar-2.2" 
 xmlns:naming="http://geronimo.apache.org/xml/ns/naming-1.2" 
 xmlns:sec="http://geronimo.apache.org/xml/ns/security-2.0" 
 xmlns:sys="http://geronimo.apache.org/xml/ns/deployment-1.2"&gt;

&lt;sys:environment&gt;
 &lt;sys:moduleId&gt;
  &lt;sys:groupId&gt;BeanManagedJPA&lt;/sys:groupId&gt;
  &lt;sys:artifactId&gt;EJB&lt;/sys:artifactId&gt;
  &lt;sys:version&gt;1.0&lt;/sys:version&gt;
  &lt;sys:type&gt;car&lt;/sys:type&gt;
 &lt;/sys:moduleId&gt;

 &lt;dependencies&gt;
  &lt;dependency&gt;
   &lt;groupId&gt;console.dbpool&lt;/groupId&gt;
   &lt;artifactId&gt;AccountDS&lt;/artifactId&gt;
  &lt;/dependency&gt;
 &lt;/dependencies&gt;
&lt;/sys:environment&gt;
&lt;enterprise-beans/&gt;
&lt;/openejb-jar&gt;
</plain-text-body>

<p>13. Finally the project <code>BeanManagedJPA-EJB</code> should like as below.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/8.jpg"></span></p>

<h2 id="DevelopingbeanmanagedpersistencewithJPA-Creatingwebapplication">Creating web application </h2>

<p>1. Right click on the <em>Project Explorer</em> and select <em>New =&gt; Project</em>. This will popup <em>New Project</em> wizard.  <br clear="none">
   Select <em>Dynamic Web Project</em> under option <em>Web</em>. Click on the <em>Next</em> button.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/9.jpg"></span></p>

<p>2. Provide the values as given in the screen shot below on the <em>New Dynamic Web Project</em> wizard. Please note that <em>Add project to an EAR</em> checkbox is check to add this web project to <em>BeanManagedJPA-EAR</em> created during the creation of <em>BeanManagedJPA-EJB</em> project.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/10.jpg"></span></p>

<p>3. In the next screen, select the <em>Version</em> values as given in the below figure and click on the <em>Next</em> button. </p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/11.jpg"></span></p>

<p>4. Check on the <em>Generate Deployment Descriptor</em> checkbox and click on the <em>Next</em> button. On the next screen, configure the deployment plan as follows. After this, click on the <em>Finish</em> button to complete creating web project</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/12.jpg"></span></p>


<p>5. Right click on the <em>WebContent</em> folder of the web project and navigate to <em>New =&gt; HTML</em> to create the index.html file as given in the screen shot. Click on the <em>Next</em> button and on the next screen click on the <em>Finish</em> button. The contents of the index.html is provided below the screen shot.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/13.jpg"></span></p>

<parameter ac:name="title">index.html</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;!DOCTYPE html PUBLIC 
 "-//W3C//DTD HTML 4.01 Transitional//EN" 
 "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
 &lt;head&gt;
  &lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
  &lt;title&gt;Bean Managed JPA&lt;/title&gt;
 &lt;/head&gt;

&lt;body&gt;

 &lt;font size=4&gt;
   &lt;a href="/BeanManagedJPA-WEB/ViewAccount.html"&gt;
    View Account Details
   &lt;/a&gt;
 &lt;/font&gt;&lt;br/&gt;

 &lt;font size=4&gt;
  &lt;a href="/BeanManagedJPA-WEB/TransferAmount.jsp"&gt;
    Transfer Amount
  &lt;/a&gt;
 &lt;/font&gt;

&lt;/body&gt;

&lt;/html&gt;
</plain-text-body>

<p>6. Right click on the <em>WebContent</em> folder of the web project and navigate to <em>New =&gt; HTML</em> to create the ViewAccount.html file as given in the screen shot. Click on the <em>Next</em> button and on the next screen click on the <em>Finish</em> button. The content of the ViewAccount.html is provided below the screen shot.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/14.jpg"></span></p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/15.jpg"></span></p>

<parameter ac:name="title">ViewAccount.html</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;!DOCTYPE html PUBLIC 
 "-//W3C//DTD HTML 4.01 Transitional//EN" 
 "http://www.w3.org/TR/html4/loose.dtd"&gt;

&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
&lt;title&gt;Bean Managed JPA&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;form name="input" 
 action="/BeanManagedJPA-WEB/RetrieveAccount.jsp"method="get"&gt;

&lt;table border="0"&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="4"&gt;Account Number&lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" name="accountNumber"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;input type="submit" value="Submit"&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;

&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</plain-text-body>

<p>9. Similarly, as illustrated in the previous steps, create <code>RetrieveAccount.jsp</code>. The contents of the of the jsp is as follows.</p>
<parameter ac:name="title">RetrieveAccount.jsp</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;%@ page language="java" contentType="text/html; 
    charset=ISO-8859-1" pageEncoding="ISO-8859-1"%&gt;
&lt;%@ page import="sample.jpa.AccountInterface"%&gt; 
&lt;%@ page import="javax.naming.Context"%&gt;  
&lt;%@ page import="javax.naming.InitialContext"%&gt; 


&lt;!DOCTYPE html PUBLIC 
 "-//W3C//DTD HTML 4.01 Transitional//EN" 
 "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" 
 content="text/html; 
 charset=ISO-8859-1"&gt;
&lt;title&gt;Retrieve and Update Account&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;%

String update = request.getParameter("Update");
String cancel = request.getParameter("Cancel");

System.out.println("update value="+update);
System.out.println("cancel value="+cancel);

String submitValue = null;
if(update != null) submitValue=update;
if(cancel != null) submitValue=cancel;

System.out.println("1 Submit value="+submitValue);

if(submitValue != null) {

 System.out.println("2 Submit value="+submitValue);
 if(submitValue.equals("Cancel")){
  System.out.println("3 Submit value="+submitValue);
  response.sendRedirect("/BeanManagedJPA-WEB/");
 }

else if(submitValue.equals("Update")){

 System.out.println("4 Submit value="+submitValue);
 System.out.println("Updating the Account Entity Started");

 Context ctx  = new InitialContext();

 System.out.println("Instantiating beans...");

 AccountInterface accountBean = (AccountInterface)
  ctx.lookup("java:comp/env/ejb/AccountInterface");

 int accountNumber = Integer.parseInt
  (request.getParameter("accountNumber"));

 accountBean.initialize(accountNumber);
 
 accountBean.updateAllValues(request.getParameter("address"), 
                             request.getParameter("personName"),
                             Double.parseDouble
                              (request.getParameter("balance")));

 System.out.println("Updating the Account Entity Ended");
 response.sendRedirect("/BeanManagedJPA-WEB/RetrieveAccount.jsp?
  accountNumber="+accountNumber);
}

} else{

 Context ctx  = new InitialContext();
 System.out.println("Instantiating beans...");
 AccountInterface accountBean = (AccountInterface)ctx.lookup("java:comp/env/ejb/AccountInterface");
 int accountNumber = Integer.parseInt(request.getParameter("accountNumber"));
 accountBean.initialize(accountNumber);
%&gt;

&lt;form name="input" action="/BeanManagedJPA-WEB/RetrieveAccount.jsp"&gt;
&lt;table border="0"&gt; 
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="4"&gt; Account Number :&lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;font color="red" size="4"&gt;&lt;%=accountNumber%&gt;&lt;/font&gt;
&lt;input type="hidden" name="accountNumber" value="&lt;%=accountNumber%&gt;"&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="4"&gt; Person Name :
 &lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;font color="red" size="4"&gt;
 &lt;%=accountBean.getPersonName()%&gt; 
 &lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="4"&gt; Update Person Name :
 &lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" name="personName"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="4"&gt; Address :
 &lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;font color="red" size="4"&gt;&lt;%=accountBean.getAddress()%&gt; 
 &lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="4"&gt; Update Address :
 &lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" name="address"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="4"&gt; Balance :
 &lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;font color="red" size="4"&gt;&lt;%=accountBean.getBalance()%&gt;
 &lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="4"&gt; Update Balance :
 &lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" name="balance"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;input type="submit" name="Update" 
 value="Update"&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="submit" name="Cancel" 
 value="Cancel"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;%} %&gt;
&lt;/body&gt;
&lt;/html&gt;
</plain-text-body>


<p>10. Similarly, as illustrated in the previous steps, create <code>TransferAmount.jsp</code>. The contents of the jsp is as follows.</p>
<parameter ac:name="title">TransferAmount.jsp</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;%@ page language="java" contentType="text/html; 
 charset=ISO-8859-1"
pageEncoding="ISO-8859-1"%&gt;
&lt;%@ page import="sample.jpa.AccountInterface"%&gt; 
&lt;%@ page import="javax.naming.Context"%&gt;  
&lt;%@ page import="javax.naming.InitialContext"%&gt;
&lt;%@ page import="javax.transaction.UserTransaction"%&gt;
&lt;!DOCTYPE html PUBLIC 
 "-//W3C//DTD HTML 4.01 Transitional//EN" 
 "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" 
 content="text/html; charset=ISO-8859-1"&gt;
&lt;title&gt;Transfer Amount&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;%
String submitValue = request.getParameter("Transfer");

if(submitValue!=null){

 int debitAccount = Integer.parseInt
 (request.getParameter("accountNumber1"));

 int creditAccount = Integer.parseInt
 (request.getParameter("accountNumber2"));

 double amount = Double.parseDouble
 (request.getParameter("amount"));

 Context ctx = new InitialContext();

 AccountInterface debitAccountBean = 
 (AccountInterface)ctx.lookup("java:comp/env/ejb/AccountInterface");

 debitAccountBean.initialize(debitAccount);

 AccountInterface creditAccountBean = 
 (AccountInterface)ctx.lookup("java:comp/env/ejb/AccountInterface");

 creditAccountBean.initialize(creditAccount);

 UserTransaction ut = 
 (UserTransaction)ctx.lookup("java:comp/UserTransaction");
 
 ut.begin();
 debitAccountBean.withdraw(amount);
 creditAccountBean.deposit(amount);
 ut.commit();

 response.sendRedirect("/BeanManagedJPA-WEB/");

}

else{

%&gt;
&lt;form name="input" action="/BeanManagedJPA-WEB/TransferAmount.jsp"
 method="get"&gt;
&lt;table border="0"&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="4"&gt;
  Debit Account Number :&lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" name="accountNumber1"&gt;
 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="4"&gt; 
 Credit Account Number:&lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" 
 name="accountNumber2"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="4"&gt; 
 Amount to be Transfered :&lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" name="amount"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;input type="submit" name="Transfer" 
 value="Transfer"&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;%} %&gt;
&lt;/body&gt;
&lt;/html&gt;
</plain-text-body>

<p>11. Right click on the <code>BeanManagedJPA-WEB</code> project and click on <em>Properties</em> to open <em>Properties for BeanManagedJPA-WEB</em> wizard. Click on the <em>Java Build Path</em> and <em>Projects</em> tab. Click on the <em>Add</em> button and add <code>BeanManagedJPA-EJB</code> project. Finally, click on the <em>OK</em> button on <em>Properties for BeanManagedJPA-WEB</em> wizard. This is required because, <code>BeanManagedJPA-WEB</code> projects looks up <code>AccountInterface</code> ejb in the <code>BeanManagedJPA-EJB</code> project. To resolve the dependency during compilation, the EJB project has to be added to the build path of the WEB project.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/16.jpg"></span></p>


<h2 id="DevelopingbeanmanagedpersistencewithJPA-SettingupthedatabasetablesandtheDatasource">Setting up the database tables and the Datasource</h2>

<p>1. Start the geronimo server and open the admin console on a browser window with the url  <br clear="none">
   <a shape="rect" class="external-link" href="http://localhost:8080/console" rel="nofollow">http://localhost:8080/console</a>.</p>

<p>2. Click on the <em>Embedded DB =&gt; DB Manager</em> on the <em>Console Navigation</em> portlet. </p>

<p>3. On the <em>Run SQL</em> portlet on the right side, enter <em>AccountDB</em> in the <em>Create DB</em> textbox and click on the <br clear="none">
  <em>Create</em> button.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/17.jpg"></span></p>

<p>4. The above step will create <code>AccountDB</code> database. On the same screen, enter the below SQL command on the <em>SQL Command/s</em> textarea and select <em>AccountDB</em> in the <em>Use DB</em> combo box and click on the <em>Run SQL</em> button. This will create <em>ACCOUNTCME</em> table in the <em>AccountDB</em> database.</p>

<parameter ac:name="borderStyle">solid</parameter><plain-text-body>
create table ACCOUNTBME (ACCOUNTNUMBER integer, PERSONID integer, balance decimal(15,2));
</plain-text-body>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/18.jpg"></span></p>

<p>5. Similarly, enter the below SQL command on the <em>SQL Command/s</em> textarea and select <em>AccountDB</em> in the <em>Use DB</em> combo box and click on the <em>Run SQL</em> button. This will create <em>PERSONBME</em> table in the <em>AccountDB</em> database.</p>

<parameter ac:name="borderStyle">solid</parameter><plain-text-body>
create table PERSONBME (PERSONID integer, PERSONNAME varchar(255), ADDRESS varchar(255));
</plain-text-body>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/19.jpg"></span></p>


<p>6. Insert the two rows using the below SQL command. </p>

<parameter ac:name="borderStyle">solid</parameter><plain-text-body>
insert into PERSONBME values (1, 'Shane Gibson', 'XXXX');
insert into PERSONBME values (2, 'Rameez Raza', 'YYYY');
insert into ACCOUNTBME values (10,1,6500);
insert into ACCOUNTBME values (11,2,9000);</plain-text-body>
<p>After inserting the rows, table will look like the below screen shot.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/20.jpg"></span></p>


<p>7. We need to deploy datasource over AccountDB database for JPA. This datasource will be used by JPA to connect to database and perform DML operations. Admin console can be used to deploy a datasource over AccountDB. Click on the <em>services =&gt; Database Pools</em> in the <em>Console =&gt; Navigation</em> portlet. This will display the list of database pools currently running in the server.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/21.jpg"></span></p>


<p>8. Click on the <em>Using the Geronimo database pool wizard</em> link. This will open up the <em>Database pools</em> portlet as follows. Provide the value for <em>Name of the Database pool</em> as <em>AccountDS</em> and select <em>Derby embedded</em> as below and click on the <em>Next</em> button.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/22.jpg"></span></p>


<p>9. On the next screen, select the JAR file listed in the <em>Driver JAR</em> select box and provide <em>AccountDB</em> as the value for Database Name and click on the <em>Deploy</em> button at the bottom. This will deploy the data source and display the list of datasources currently deployed on the server.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/23.jpg"></span></p>

<p>10. In the eclipse, open the <code>openejb-jar.xml</code> and provide the dependency to the <code>AccountDS</code>. Finally, the <code>openejb-jar.xml</code> should be as below. This configuration is already done in the step 12 of <em>Creating ejb application with entities</em> above.</p>

<h2 id="DevelopingbeanmanagedpersistencewithJPA-Deployingthe(ear)application">Deploying the (ear) application</h2>

<p>1. Deploy the EAR file as follows</p>
<parameter ac:name="borderStyle">solid</parameter><plain-text-body>
C:\Geronimo-2.1\bin&gt;deploy.bat --user system --password manager deploy c:\temp\BeanManagedJPA-EAR.ear
Using GERONIMO_BASE:   C:\Geronimo-2.1
Using GERONIMO_HOME:   C:\Geronimo-2.1
Using GERONIMO_TMPDIR: var\temp
Using JRE_HOME:        C:\SDK-May-31-2007\jre
    Deployed default/BeanManagedJPA-EAR/1.0/car
      `-&gt; BeanManagedJPA-WEB.war @ /BeanManagedJPA-WEB
      `-&gt; BeanManagedJPA-EJB.jar</plain-text-body>



<h2 id="DevelopingbeanmanagedpersistencewithJPA-Runningtheapplication">Running the application</h2>

<p>1. Open a browser window and hit the URL as <a shape="rect" class="external-link" href="http://localhost:8080/BeanManagedJPA-WEB/" rel="nofollow">http://localhost:8080/BeanManagedJPA-WEB/</a>. This brings upthe screen shot below. Click on the <em>View Account Details</em> link.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/24.jpg"></span></p>

<p>2. On this page, enter <em>10</em> in the <em>Account Number</em> text box as below and click on the button</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/25.jpg"></span></p>

<p>3. This will bring up the screen shot below. You can update the <em>Person Name</em>, <em>Address</em> and <em>Balance</em> values.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/26.jpg"></span></p>

<p>4. Enter the values given in the screen shot below and click on the <em>Update</em> button.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/27.jpg"></span></p>

<p>5. Once the <em>Update</em> button is pressed, the below screen shot is displayed with the updated values. Click on the <em>Cancel</em> button to go back to the main page.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/28.jpg"></span></p>

<p>6. Click on the <em>Transfer Amount</em> link on the main page. This will bring up the page as given in the screen shot below. Enter the values for <em>Debit Account Number</em>, <em>Credit Account Number</em> and  <em>Amount to be Transferred</em> as given in the screen shot and click on the <em>Transfer</em> button. This will transfer the specified amount from debit account to the credit account. You can verify this either in the database or use the <em>View Account Details</em> link shown earlier.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-bean-managed-persistence-with-jpa.data/29.jpg"></span></p></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="middle" class="footer">
            &nbsp;&nbsp;
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Delicious" />
            <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">Bookmark this on Delicious</a>
            &nbsp;&nbsp;
            <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="Digg!" />
            <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title)+'&amp;topic=programming');">Digg this</a>
            <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : Developing bean managed persistence with JPA';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
            &nbsp;&nbsp;
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">Privacy Policy</a>&nbsp;&nbsp;-&nbsp;&nbsp;
            Copyright &#169; 2003-2013, The Apache Software Foundation, Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0.</a>&nbsp;&nbsp;
          </td>
        </tr>
    </table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  </body>
</html>
