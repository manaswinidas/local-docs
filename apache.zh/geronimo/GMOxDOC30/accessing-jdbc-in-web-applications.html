<html lang="zh-Hans" ><head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link type="text/css" rel="stylesheet" href="asset?aid=0">
    <link rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <link rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <meta name="Description" content="Accessing JDBC in Web applications">
    <meta name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi Accessing JDBC in Web applications">
    <meta name="Owner" content="dev@geronimo.apache.org">
    <meta name="Robots" content="index, follow">
    <meta name="Security" content="Public">
    <meta name="Source" content="wiki template">
    <meta name="DC.Date" scheme="iso8601" content="2010-05-11">
    <meta name="DC.Language" scheme="rfc1766" content="en">
    <meta name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation">
    <meta http-equiv="PICS-Label" content="(PICS-1.1 " http:="" ="" www.icra.org="" ratingsv02.htm="=" www.rsac.org="" ratingsv01.htm="=" (ss~~000="" 1)="=">

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>

  <link href="asset?aid=1" rel="stylesheet" type="text/css">
  <link href="asset?aid=2" rel="stylesheet" type="text/css">
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shCore.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushJava.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushXml.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushPlain.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushBash.js' type='text/javascript'></script>
  
  <script type="text/javascript">
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all();
  </script>

    <title>Apache Geronimo v3.0文档：在Web应用程序中访问JDBC</title>
  </head>

  <body  onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tbody><tr>
        <td align="left" valing="top">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </tbody></table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tbody><tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" nowrap>
          <a href="/geronimo">主页</a> > <a href="documentation.html">文档</a> > <a href="developing.html">开发</a> > <a href="tutorials.html">教程</a> > <a href="developing-web-applications.html">开发Web应用程序</a> > <a href="accessing-jdbc-in-web-applications.html">在Web应用程序中访问JDBC</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8">
            <input type="hidden" name="oe" value="UTF-8">
            <input type="hidden" name="domains" value="">
            <input type="hidden" name="sitesearch" value="">
            <input type="text" name="q" value="" maxlength="255">        
            <input type="submit" name="btnG" value="谷歌搜索">
          </form>
        </td>
      </tr> 
    </tbody></table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding:6px 0px 0px 0px">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div class="smalltext" style="margin:0px 10px 0px 10px">Apache Geronimo v3.0</div>
        <div class="pagetitle" style="margin:0px 10px 8px 10px">在Web应用程序中访问JDBC</div>

        <div class="greynavbar" align="right" style="padding:2px 10px;margin:0px">
<!-- --> <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645264"><img src="http://geronimo.apache.org/images/icons/notep_16.gif" height="16" width="16" border="0" title="编辑页面"></a> <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645264">编辑页面</a> <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30"><img src="http://geronimo.apache.org/images/icons/browse_space.gif" height="16" width="16" border="0" title="浏览空间"></a> <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">浏览空间</a> <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645264"><img src="http://geronimo.apache.org/images/icons/add_page_16.gif" height="16" width="16" border="0" title="添加页面"></a> <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645264">添加页面</a> <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645264"><img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif" height="16" width="16" border="0" title="新增新闻"></a> <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645264">添加新闻</a> <!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent">
<p>该应用程序将处理在数据库中填充图像，然后从数据库中检索图像。本教程将帮助您了解如何处理Blob类型的数据。我们将在此应用程序中使用Derby数据库。请使用较小尺寸的图像上传到数据库。这是因为derby数据库存在一些限制。</p>

<p>要运行本教程，至少需要您安装以下必备软件：</p>

<ol><li>Sun JDK 6.0+（J2SE 1.6）</li><li>面向特定平台的Java EE开发人员的Eclipse IDE</li><li>Apache Geronimo Eclipse插件2.1.x</li><li>Apache Geronimo服务器2.1.x<div class="confluence-information-macro confluence-information-macro-note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"></span><div class="confluence-information-macro-body">
<p>在本教程中使用了Geronimo 2.1.x版，Java 1.5运行时和Eclipse Ganymede，但是可以使用其他版本（例如Geronimo 2.2版，Java 1.6，Eclipse Europa）</p></div></div></li></ol>


<p><a shape="rect" href="development-environment.html">开发环境</a>部分中提供了有关安装Eclipse的详细信息。本教程分为以下几节：</p>

<style type="text/css">/*<![CDATA[*/
div.rbtoc1572612942037 {padding: 0px;}
div.rbtoc1572612942037 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1572612942037 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class="toc-macro rbtoc1572612942037">
<ul class="toc-indentation"><li><a shape="rect" href="#AccessingJDBCinWebapplications-CreatingadynamicWebproject">创建一个动态Web项目</a></li><li><a shape="rect" href="#AccessingJDBCinWebapplications-Creatingadatabaseusingtheadministrativeconsole">使用管理控制台创建数据库</a></li><li><a shape="rect" href="#AccessingJDBCinWebapplications-Creatingadatasourceusingtheadministrativeconsole">使用管理控制台创建数据源</a></li><li><a shape="rect" href="#AccessingJDBCinWebapplications-Addingcodeforimageuploadtoderbydatabase">添加用于将图像上传到derby数据库的代码</a></li><li><a shape="rect" href="#AccessingJDBCinWebapplications-Codetoretrievetheimagefromderbydatabase">从derby数据库检索图像的代码</a></li><li><a shape="rect" href="#AccessingJDBCinWebapplications-Modifyingdeploymentplan">修改部署计划</a></li><li><a shape="rect" href="#AccessingJDBCinWebapplications-Deployandrun">部署并运行</a></li></ul>
</div>

<h2 id="AccessingJDBCinWebapplications-CreatingadynamicWebproject">创建一个动态Web项目</h2>
<ol><li>启动Eclipse。选择<strong>文件->新建->项目</strong> 。<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createproj.png"></span>
<br class="atl-forced-newline" clear="none"></li><li>选择<strong>Web->动态Web项目</strong> 。选择<strong>下一步</strong> 。<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createproj2.png"></span><br class="atl-forced-newline" clear="none"> </li><li>在下一个屏幕上，将项目名称命名为<em>WebJDBC</em> 。<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createproj3.png"></span>
<br class="atl-forced-newline" clear="none"> </li><li>选择所有其他字段的默认值。最后选择<strong>完成</strong> 。<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createproj4.png"></span> 
<br class="atl-forced-newline" clear="none"> </li></ol>


<h2 id="AccessingJDBCinWebapplications-Creatingadatabaseusingtheadministrativeconsole">使用管理控制台创建数据库</h2>
<ol><li>启动服务器并使用URL <a shape="rect" class="external-link" href="http://localhost:8080/console" rel="nofollow">http：// localhost：8080 / console</a>启动管理<a shape="rect" class="external-link" href="http://localhost:8080/console" rel="nofollow">控制台</a> 。</li><li>输入默认的用户名和密码。</li><li>在欢迎页面的“ <em>嵌入式数据库”下</em> ，选择“ <strong>数据库管理器”</strong> 。<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createDB1.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>在下一页上创建一个数据库<em>userdbs</em>并选择<strong>Create</strong> 。<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createDB2.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>完成后，您可以在<em>Databases</em>下的DB Viewer portlet中看到<em>userdbs</em>数据库。这确认数据库已成功创建。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createDB3.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>如下图所示，从下拉框中选择<strong>userdbs</strong> 。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createDB4.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>如图所示运行查询。该查询将创建带有列<em>名称</em>和<em>pic的</em>表<em>PICTURES</em> 。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createDB5.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>CreateTable.sql</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
create table pictures(name varchar(32) not null primary key, pic blob(16M));
</pre>
</div></div>
 <br class="atl-forced-newline" clear="none"></li></ol>


<h2 id="AccessingJDBCinWebapplications-Creatingadatasourceusingtheadministrativeconsole">使用管理控制台创建数据源</h2>
<ol><li>启动服务器并使用URL <a shape="rect" class="external-link" href="http://localhost:8080/console" rel="nofollow">http：// localhost：8080 / console</a>启动管理<a shape="rect" class="external-link" href="http://localhost:8080/console" rel="nofollow">控制台</a> 。</li><li>输入默认的用户名和密码。</li><li>进入欢迎页面。在控制台导航中，在“ <em>服务”下</em> ，选择“ <strong>数据库池”</strong> 。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createDS.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>在下一个屏幕上， <strong>使用Geronimo数据库池向导</strong>创建一个新的数据库池。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createDS2.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>在下一个屏幕上，如图<em>jdbc / userds</em>中的建议输入名称。这将启动创建Derby Embedded XA数据源的过程。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createDS3.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>选择<strong>驱动程序Jar</strong> ，并将数据库名称命名为<em>userdbs</em> （请记住，这是我们在上一步中创建的数据库）。所有其他字段都可以设置为默认值。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createDS4.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>选择<strong>部署</strong>以部署连接器计划。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createDS5.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>完成后，您可以在可用数据库池中看到数据库池<em>jdbc / userds</em> 。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/createDS6.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li></ol>


<h2 id="AccessingJDBCinWebapplications-Addingcodeforimageuploadtoderbydatabase">添加用于将图像上传到derby数据库的代码</h2>
<ol><li>右键单击<strong>WebContent，</strong>然后选择<strong>New-</strong> <strong>> JSP</strong> 。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/Code1.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>将JSP命名为<em>index.jsp</em>并选择<strong>Next</strong> 。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/code2.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>选择<strong>完成</strong> 。这将为创建模板<code>index.jsp</code> 。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/code3.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>将以下代码添加到<code>index.jsp</code> 。
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>index.jsp</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
&lt;%@ page language="java" contentType="text/html; charset=ISO-8859-1"
    pageEncoding="ISO-8859-1"%&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
&lt;title&gt;Image Upload&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h2&gt;Select a Image and Upload it&lt;/h2&gt;
&lt;form action="/WebJDBC/ImageUpload"&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;
Location of the Image(full path)
&lt;/td&gt;
&lt;td&gt;
&lt;Input type="text" name="ImageLoc"&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;
Name of the Image(Unique Name)
&lt;/td&gt;
&lt;td&gt;
&lt;Input type="text" name="ImageName"&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;
&lt;Input type="submit" value="submit"&gt;
&lt;/td&gt;
&lt;tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
</div></div>的<strong><form action="/WebJDBC/ImageUpload"></form></strong>建议一旦提交表单，请求将传递给<strong>ImageUpload</strong> 。下一步是添加Servlet <strong>ImageUpload</strong>以处理JSP客户端发送的请求。</li><li>右键单击<strong>Java Resources，</strong>然后选择<strong>New-> other</strong> 。<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/code4.png"></span><br class="atl-forced-newline" clear="none"> </li><li>选择<strong>Web-> Servlet</strong> 。选择<strong>下一步</strong> 。<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/code5.png"></span><br class="atl-forced-newline" clear="none"> </li><li>将Java包命名为<em>jdbc</em> ，将类命名为<em>ImageUpload</em> 。选择<strong>下一步->下一步</strong> 。<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/code6.png"></span><br class="atl-forced-newline" clear="none"> </li><li>选择<strong>完成</strong> 。<br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/code7.png"></span> <br class="atl-forced-newline" clear="none"> </li><li>将以下代码添加到<code>ImageUpload.java</code> 。
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>ImageUpload.java</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
package jdbc;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import javax.annotation.Resource;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.sql.DataSource;

public class ImageUpload extends javax.servlet.http.HttpServlet implements javax.servlet.Servlet {
	@Resource(name="jdbc/userds")
	 private DataSource ds;
   static final long serialVersionUID = 1L;
   
 	public ImageUpload() {
		super();
	}   	
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
doProcess(request, response);
	}  	
	
	protected void doProcess(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		Connection dbconnect = null;
		PreparedStatement stmnt = null;
		String pic=request.getParameter("ImageLoc");
		String name=request.getParameter("ImageName");
		try{
			File f= new File(pic);
			FileInputStream fis=new FileInputStream(f);
			dbconnect= ds.getConnection();
			stmnt = dbconnect.prepareStatement("INSERT INTO PICTURES (" + "NAME," + "PIC )" + " VALUES(?,?)");
			stmnt.setString(1, name);
			stmnt.setBinaryStream(2, fis, (int)f.length());
			stmnt.execute();
			PrintWriter out= response.getWriter();
			out.println("Congratulations your image has been successfully uploaded");			
		}
		catch(Exception e)
		{
			e.printStackTrace();
		}
		finally
		{
		try{
    		dbconnect.close();
    		stmnt.close();
    	}catch(SQLException e){
    		e.printStackTrace();
    	}    
		}
	}
		
	
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
doProcess(request, response);
	}   	  	    
}
</pre>
</div></div></li></ol>


<p>提交请求后<code>index.jsp</code>对于具有名称和图像确切位置的图像上传，请求将发送到<strong>ImageUpload</strong> servlet。</p>
<ul><li>字符串pic = request.getParameter（“ ImageLoc”）;-检索图像的位置</li><li>字符串名称= request.getParameter（“ ImageName”）;-检索图像的名称</li></ul>


<p>一旦有了可用的图像，就会从该图像创建一个新的File对象。此后，将图像文件读取为二进制流。<strong>PreparedStatement</strong>用于将图像插入数据库。这样就完成了<strong>ImageUpload</strong>的代码。</p>

<h2 id="AccessingJDBCinWebapplications-Codetoretrievetheimagefromderbydatabase">从derby数据库检索图像的代码</h2>
<ol><li>创建一个名称为<strong>JSP的</strong>页面<code>ImageDownload.jsp</code> 。</li><li>将以下代码添加到<code>ImageDownload.jsp</code> ：<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>ImageDownload.jsp</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
&lt;%@ page language="java" contentType="text/html; charset=ISO-8859-1"
    pageEncoding="ISO-8859-1"%&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
&lt;title&gt;Download Image&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h2&gt;Name a Image to download&lt;/h2&gt;
&lt;form action="/WebJDBC/ImageDownload"&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;
Name of the Image
&lt;/td&gt;
&lt;td&gt;
&lt;Input type="text" name="ImageName"&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;
&lt;Input type="submit" value="submit"&gt;
&lt;/td&gt;
&lt;tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
</div></div>从中可以看出<strong><form action="/WebJDBC/ImageDownload"></form></strong>提交表单时，此JSP请求<strong>ImageDownload</strong> servlet。</li><li>创建一个新的servlet <code>ImageDownload.java</code>并添加以下代码：<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>ImageDownload.java</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
package jdbc;

import java.io.IOException;
import java.io.OutputStream;
import java.sql.Blob;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import javax.annotation.Resource;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.sql.DataSource;

 public class ImageDownload extends javax.servlet.http.HttpServlet implements javax.servlet.Servlet {
	 @Resource(name = "jdbc/userds")
		private DataSource ds;
   static final long serialVersionUID = 1L;
   
	public ImageDownload() {
		super();
	}   	
	
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		doProcess(request, response);	
	}  	
	protected void doProcess(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		Connection dbconnect = null;
		ResultSet rs = null;
		PreparedStatement stmnt = null;
		try {
			dbconnect = ds.getConnection();
			String s=request.getParameter("ImageName");
			stmnt = dbconnect.prepareStatement("SELECT PIC FROM PICTURES WHERE NAME=?");
			stmnt.setString(1, s);
			rs = stmnt.executeQuery();
			if (rs.next()) {
				// Get as a BLOB
				Blob aBlob = rs.getBlob(1);
				byte[] b = new byte[4096];
				java.io.InputStream ip = aBlob.getBinaryStream();
				OutputStream out = null;
				int c = 0;
				out = response.getOutputStream();
				response.setContentType("image/jpeg");
				while (c != -1) {
                                     c = ip.read(b);
                                     if (c &gt; 0) {
                                       out.write(b, 0, c);
                                       out.flush();
				         }
				ip.close();
				
			}

		} catch (Exception e) {
			e.printStackTrace();
		} finally {
        	try{
        		dbconnect.close();
        		stmnt.close();
        	    rs.close();
        	}catch(SQLException e){
        		e.printStackTrace();
        	}        	        	
        }

	} 
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		doProcess(request, response);
	}   	  	    
}
</pre>
</div></div></li></ol>


<p><strong>发送</strong>请求后， <strong>ImageDownload</strong> servlet的工作方式类似<code>ImageDownload.jsp</code>对此。servlet使用</p>
<ul><li>字符串s = request.getParameter（“ ImageName”）;-检索要下载的图像的名称</li><li>rs = stmnt.executeQuery（）;-执行PreparedStatement</li><li>Blob aBlob = rs.getBlob（1）;-数据存储为Blob数据类型</li><li>java.io。InputStream ip = aBlob.getBinaryStream（）;-将Blob数据作为二进制流检索</li><li>response.setContentType（“ image / jpeg”）;-将输出内容类型设置为Image数据类型</li><li>c = ip.read（b）; out.write（b）; out.flush（）;-数据作为字节缓冲区读取并写入网页。每次写完后，将刷新自助餐。</li></ul>


<p>这样就完成了图像下载的代码。</p>

<h2 id="AccessingJDBCinWebapplications-Modifyingdeploymentplan">修改部署计划</h2>
<p>下一步是修改<code>geronimo-web.xml</code>部署计划。我们需要为<strong>JDBC</strong>资源添加依赖项元素。我们还需要为<em>userds</em>数据源添加资源引用元素。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>geronimo-web.xml</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns="http://geronimo.apache.org/xml/ns/j2ee/web-2.0.1"
         xmlns:nam="http://geronimo.apache.org/xml/ns/naming-1.2"
         xmlns:sec="http://geronimo.apache.org/xml/ns/security-2.0" 
         xmlns:sys="http://geronimo.apache.org/xml/ns/deployment-1.2"&gt;
  &lt;sys:environment&gt;
    &lt;sys:moduleId&gt;
      &lt;sys:groupId&gt;default&lt;/sys:groupId&gt;
      &lt;sys:artifactId&gt;WebJDBC&lt;/sys:artifactId&gt;
      &lt;sys:version&gt;1.0&lt;/sys:version&gt;
      &lt;sys:type&gt;car&lt;/sys:type&gt;
    &lt;/sys:moduleId&gt;
   &lt;sys:dependencies&gt;
            &lt;sys:dependency&gt;
                &lt;sys:groupId&gt;console.dbpool&lt;/sys:groupId&gt;
                &lt;sys:artifactId&gt;jdbc_userds&lt;/sys:artifactId&gt;
            &lt;/sys:dependency&gt;
    &lt;/sys:dependencies&gt;
  &lt;/sys:environment&gt;
  &lt;context-root&gt;/WebJDBC&lt;/context-root&gt;
  &lt;nam:resource-ref&gt;
        &lt;nam:ref-name&gt;jdbc/userds&lt;/nam:ref-name&gt;
        &lt;nam:pattern&gt;
          &lt;nam:groupId&gt;console.dbpool&lt;/nam:groupId&gt;
          &lt;nam:artifactId&gt;jdbc_userds&lt;/nam:artifactId&gt;
          &lt;nam:name&gt;jdbc/userds&lt;/nam:name&gt;
        &lt;/nam:pattern&gt;
    &lt;/nam:resource-ref&gt;
&lt;/web-app&gt;
</pre>
</div></div>
<ul><li><sys:dependency>-依赖性元素是建议应用程序对数据库池的依赖性。在我们的案例中，我们将<strong>userds</strong>作为依赖项模块。</sys:dependency></li><li><nam:resource-ref>-此元素用于使用用户定义的名称映射JDBC连接池。在我们的情况下，我们已将<strong>jdbc / userds</strong>与<strong>jdbc_userds</strong>映射。</nam:resource-ref></li></ul>


<h2 id="AccessingJDBCinWebapplications-Deployandrun">部署并运行</h2>
<ol><li>在Eclipse中启动服务器。</li><li>右键单击<strong>WebJDBC</strong>项目，然后选择<strong>“运行方式->在服务器上运行”</strong> 。</li><li>完成后，该应用程序将部署在服务器上。</li><li>使用以下链接启动应用程序<a shape="rect" class="external-link" href="http://localhost:8080/WebJDBC/" rel="nofollow">http：// localhost：8080 / WebJDBC /</a><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/run1.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>用图像位置和名称填写表格。用图像数据填充数据库时，将使用相同的名称。选择完成后<strong>提交</strong> 。<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/run2.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>如果您的图像已成功插入数据库，您将收到一条祝贺消息。<br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/run3.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>要从数据库检索图像，请启动以下portlet <a shape="rect" class="external-link" href="http://localhost:8080/WebJDBC/ImageDownload.jsp" rel="nofollow">http：// localhost：8080 / WebJDBC / ImageDownload.jsp</a> 。选择完成后<strong>提交</strong> 。<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="accessing-jdbc-in-web-applications.data/run4.png"></span><br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"> <br class="atl-forced-newline" clear="none"></li><li>这将在浏览器中显示图像。</li></ol></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tbody><tr>
          <td align="left" valign="middle" class="footer">
              
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="美味的"> <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&noui&jump=close&url='+encodeURIComponent(location.href)+'&title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">在Delicious上添加书签</a> <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="掘客！"> <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&title='+encodeURIComponent(document.title)+'&topic=programming');">挖这个</a> <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : Accessing JDBC in Web applications';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
              
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">隐私权政策</a> -版权所有©2003-2013，Apache软件基金会，根据<a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0</a>许可<a href="http://www.apache.org/licenses/LICENSE-2.0">。</a>  
          </td>
        </tr>
    </tbody></table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  

</body></html>