<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="http://geronimo.apache.org/style/default.css">
    <LINK rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <LINK rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <META name="Description" content="Tomcat Native Clustering" />
    <META name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi Tomcat Native Clustering" />
    <META name="Owner" content="dev@geronimo.apache.org" />
    <META name="Robots" content="index, follow" />
    <META name="Security" content="Public" />
    <META name="Source" content="wiki template" />
    <META name="DC.Date" scheme="iso8601" content="2010-05-11" />
    <META name="DC.Language" scheme="rfc1766" content="en" />
    <META name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation" />
    <META http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html" l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html" l gen true r (n 0 s 0 v 0 l 0) "http://www.classify.org/safesurf/" l gen true r (SS~~000 1))'/>

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>

  <link href='http://geronimo.apache.org/resources/highlighter/styles/shCoreGeronimo.css' rel='stylesheet' type='text/css' />
  <link href='http://geronimo.apache.org/resources/highlighter/styles/shThemeGeronimo.css' rel='stylesheet' type='text/css' />
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shCore.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushJava.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushXml.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushPlain.js' type='text/javascript'></script>
  
  <script type="text/javascript">
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all();
  </script>

    <title>Apache Geronimo v3.0 Documentation: Tomcat Native Clustering</title>
  </head>

  <body onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tr>
        <td valing="top" align="left">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" align="left" nowrap>
          <a href="/geronimo"> Home</a> >&nbsp;<a href="documentation.html">Documentation</a>&nbsp;&gt;&nbsp;<a href="configuring-and-administering.html">Configuring and administering</a>&nbsp;&gt;&nbsp;<a href="configuring-and-administering-the-apache-geronimo-server.html">Configuring and administering the Apache Geronimo Server</a>&nbsp;&gt;&nbsp;<a href="clustering-and-farming.html">Clustering and farming</a>&nbsp;&gt;&nbsp;<a href="tomcat-native-clustering.html">Tomcat Native Clustering</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
        </td>
      </tr> 
    </table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div style="margin: 0px 10px 0px 10px" class="smalltext">Apache Geronimo v3.0</div>
        <div style="margin: 0px 10px 8px 10px"  class="pagetitle">Tomcat Native Clustering</div>

        <div class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
<!-- -->         
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645454">
            <img src="http://geronimo.apache.org/images/icons/notep_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Edit Page"></a>
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645454">Edit Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">
            <img src="http://geronimo.apache.org/images/icons/browse_space.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Browse Space"></a>
            <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">Browse Space</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645454">
            <img src="http://geronimo.apache.org/images/icons/add_page_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add Page"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645454">Add Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645454">
            <img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add News"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645454">Add News</a>
<!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent">

<p>The Tomcat Web container provides a native clustering solution that can be configured through Geronimo by using gbean definitions within <code>config.xml</code> or by using <code>server.xml</code> starting from v2.2 just like you did for a standalone Tomcat server.  This document will go through the available GBeans and how to configure them for clustering in a Geronimo server with a tomcat web container.</p>

<style type="text/css">/*<![CDATA[*/
div.rbtoc1572612986319 {padding: 0px;}
div.rbtoc1572612986319 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1572612986319 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class="toc-macro rbtoc1572612986319">
<ul class="toc-indentation"><li><a shape="rect" href="#TomcatNativeClustering-ClusterConfigurationElements">Cluster Configuration Elements</a></li><li><a shape="rect" href="#TomcatNativeClustering-Settingupaclusteringenvironment">Setting up a clustering environment</a>
<ul class="toc-indentation"><li><a shape="rect" href="#TomcatNativeClustering-Planningyourcluster">Planning your cluster</a></li><li><a shape="rect" href="#TomcatNativeClustering-PreparingyourWebapplication">Preparing your Web application</a>
<ul class="toc-indentation"><li><a shape="rect" href="#TomcatNativeClustering-Enablingsessionaffinity">Enabling session affinity</a></li></ul>
</li><li><a shape="rect" href="#TomcatNativeClustering-Engagingloadbalancingandfailover">Engaging load balancing and failover</a></li></ul>
</li><li><a shape="rect" href="#TomcatNativeClustering-Configuringtheclusteratapplicationlevel">Configuring the cluster at application level</a>
<ul class="toc-indentation"><li><a shape="rect" href="#TomcatNativeClustering-SampleTomcatclusteringwithmulticastConfiguration">Sample Tomcat clustering with multicast Configuration</a></li><li><a shape="rect" href="#TomcatNativeClustering-SampleTomcatclusteringwithunicastconfiguration">Sample Tomcat clustering with unicast configuration</a></li></ul>
</li><li><a shape="rect" href="#TomcatNativeClustering-ConfiguringtheclusteratEngineorHostlevel">Configuring the cluster at Engine or Host level</a>
<ul class="toc-indentation"><li><a shape="rect" href="#TomcatNativeClustering-Samplemulticastconfigurationcode">Sample multicast configuration code</a></li><li><a shape="rect" href="#TomcatNativeClustering-Sampleunicastconfigurationcode">Sample unicast configuration code</a></li></ul>
</li></ul>
</div>

<h1 id="TomcatNativeClustering-ClusterConfigurationElements">Cluster Configuration Elements</h1>

<p>Following are parameters or attributes that you will need to configure for a Tomcat native clustering. </p>

<ul><li>Cluster
	<ul><li>ClusterListenerChain</li><li>TomcatValveChain</li><li>Channel
		<ul><li>Membership</li><li>Receiver</li><li>Sender</li><li>ChannelInterceptor
			<ul><li>StaticMember</li></ul>
			</li></ul>
		</li><li>ClusterManager</li></ul>
	</li></ul>


<p>Although sufficient for many applications, Tomcat clusters have some limitations:</p>
<ul><li>This feature does not replicate stateful session Enterprise JavaBeans (EJBs). Do not use stateful session EJBs in your distributed applications.</li><li>This feature does not replicate dynamic updates to the Java Naming and Directory Interface (JNDI). You will have to configure all the JNDI names that are used by your distributed applications in every node of the cluster.</li><li>This feature does not replicate distributable Web applications to other nodes in the cluster. You will have to deploy your distributable Web applications to every node.</li></ul>


<p>Consider a cluster configuration to improve the scalability and availability of your Web application. The following sections provide detailed instructions about how to set up your cluster nodes.</p>


<h1 id="TomcatNativeClustering-Settingupaclusteringenvironment">Setting up a clustering environment</h1>
<p>To set up a small cluster, you need at least 2 nodes and 1 HTTP server.  The HTTP server is used to serve requests from clients and ensure well-balanced traffic load among different nodes. Similarly, each node is configured to use the same logical Tomcat engine and enable session affinity.</p>

<h2 id="TomcatNativeClustering-Planningyourcluster">Planning your cluster</h2>

<p>The Tomcat cluster replicates HTTP session data by memory-to-memory multicast communication.</p>

<p>Every node transmits its session data to every other node in the cluster. This algorithm is efficient only when the clusters are small. If the clusters grow too large, the overhead in storage utilization and network traffic becomes excessive. To avoid excessive overhead, consider dividing your nodes into several smaller clusters.</p>

<p>HTTP session data is replicated among the nodes in the cluster by using a multicast broadcast. All nodes in the cluster must be on the same physical subnet and multicast broadcast must be supported by that subnet.</p>

<h2 id="TomcatNativeClustering-PreparingyourWebapplication">Preparing your Web application</h2>

<p>To participate in a cluster configuration, your Web application must be implemented correctly.</p>
<ul><li>Ensure that every object placed in the HTTP session implements java.io.Serializable. The clustering feature serializes the objects when it distributes them to the other nodes in the cluster.</li><li>The deployment descriptor for your Web application, that is the <code>web.xml</code> file in the Web archive, must indicate that your Web application is distributable. To do this, insert the <strong>distributable</strong> element in the deployment descriptor.
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>Excerpt from web.xml</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;!DOCTYPE web-app
    PUBLIC "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"
    "http://java.sun.com/dtd/web-app_2_3.dtd"&gt;

&lt;web-app&gt;
    &lt;display-name&gt; ... &lt;/display-name&gt;
    &lt;description&gt; ... &lt;/description&gt;
    &lt;distributable&gt; &lt;distributable/&gt;
  ...
&lt;/web-app&gt;
</pre>
</div></div></li><li>Do not use stateful session Enterprise JavaBeans (EJBs). The clustering feature does not replicate stateful EJBs among the nodes in the cluster.</li><li>If your Web application uses a database, every node in the cluster can access the database. Ensure that the JDBC drivers are installed on every node and that the datasource objects are defined correctly on every node.</li><li>Do not depend on dynamic updates to the Java Naming and Directory Interface (JNDI). You need to configure all the JNDI names used by your application in every node of the cluster. The clustering feature does not replicate JNDI changes among the nodes in the cluster.</li></ul>


<h3 id="TomcatNativeClustering-Enablingsessionaffinity">Enabling session affinity</h3>

<p>Support for <em>session affinity</em>, also known as <em>sticky session</em> support, allows a load balancing service to route an HTTP request back to the same node that created the HTTP session associated with that request until that node fails. You must use session affinity if you configure an asynchronous type of session replication. With asynchronous replication, the reply is returned before the HTTP session is replicated, and the next request using that session might arrive before the replication is complete. In this case, route the request to the node that sent the reply to the last request and originated the replication to ensure that the request is processed using the correct session data..</p>

<p>In Geronimo servers, users can have the same experiences as in Tomcat Web container to configure session affinity. To enable session affinity, you must modify <code>servel.xml</code> under the <code>&lt;GERONIMO_HOME&gt;/var/catalina</code> directory and configure the <strong>&lt;Engine&gt;</strong> with a <strong>jvmRoute</strong> attribute value that is unique for each node in the cluster. The load balancer will return this value in the session cookie or the encoded URL returned to the browser. When a related request arrives, it can use the value to route the request to the correct node. See the following example:</p>

<ol><li>For every node in the cluster, update <code>server.xml</code> as follows after the server is stopped:
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>Excerpt from server.xml</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
 ...
 &lt;Engine name="Catalina" defaultHost="${ServerHostname}" jvmRoute="nodeId"&gt;
 ...
</pre>
</div></div>
where
	<ul><li><em>nodeId</em> is a node identifier that is unique among all the nodes in the cluster. If you are using mod_jk, make sure that the jvmRoute attribute value matches your worker name in <code>workers.properties</code>.</li></ul>
	</li><li>Restart the server to enable the new configuration.</li></ol>


<h2 id="TomcatNativeClustering-Engagingloadbalancingandfailover">Engaging load balancing and failover</h2>

<p>Initially, the server configuration includes an <em>AJP connector</em> suitable for exchanging messages with a load balancing service. See <a shape="rect" href="configuring-a-remote-apache-http-server.html">Configuring a remote Apache HTTP server</a> for more information about the HTTP server configuration.</p>


<h1 id="TomcatNativeClustering-Configuringtheclusteratapplicationlevel">Configuring the cluster at application level</h1>

<p>To configure application level clustering, you have to input all related GBean settings in your deployment plan to make sure HTTP sessions are replicated successfully. Moreover, you must use the gbean definitions within deployment plans to configure the cluster configuration elements of Tomcat Web containers. If you want to deploy your Web application to a cluster, install your WAR files to the appropriate cluster member, assuring that you use the correct deployment plan for each member. </p>

<h2 id="TomcatNativeClustering-SampleTomcatclusteringwithmulticastConfiguration">Sample Tomcat clustering with multicast Configuration</h2>
<p>The template for your Web application deployment plan is shown as follows. See <a shape="rect" href="creating-deployment-plans-for-web-applications.html">Creating deployment plans for Web applications</a> for more information about the parameters.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>geronimo-web.xml</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
&lt;web-app xmlns="http://geronimo.apache.org/xml/ns/j2ee/web/tomcat-1.2"
         xmlns:dep="http://geronimo.apache.org/xml/ns/deployment-1.2"&gt;

    &lt;dep:environment&gt;
      &lt;dep:moduleId&gt;
        &lt;dep:groupId&gt;org.mygroup&lt;/dep:groupId&gt;
        &lt;dep:artifactId&gt;web-cluster-server1&lt;/dep:artifactId&gt;
        &lt;dep:version&gt;2.2&lt;/dep:version&gt;
        &lt;dep:type&gt;war&lt;/dep:type&gt;
      &lt;/dep:moduleId&gt;
      &lt;dep:dependencies&gt;
      	&lt;dep:dependency&gt;
      	&lt;dep:groupId&gt;console.realm&lt;/dep:groupId&gt;
        &lt;dep:artifactId&gt;geronimo-properties-realm&lt;/dep:artifactId&gt;
        &lt;dep:version&gt;1.0&lt;/dep:version&gt;
        &lt;dep:type&gt;car&lt;/dep:type&gt;
        &lt;/dep:dependency&gt;
      &lt;/dep:dependencies&gt;
      &lt;dep:hidden-classes/&gt;
      &lt;dep:non-overridable-classes/&gt;
    &lt;/dep:environment&gt;

    &lt;context-root&gt;/servlet-examples-cluster&lt;/context-root&gt;

    &lt;security-realm-name&gt;geronimo-properties-realm&lt;/security-realm-name&gt;
    &lt;security&gt;
      &lt;default-principal&gt;
        &lt;principal name="anonymous" class="org.apache.geronimo.security.realm.providers.GeronimoUserPrincipal"/&gt;
      &lt;/default-principal&gt;
      &lt;role-mappings&gt;
        &lt;role role-name="tomcat"&gt;
          &lt;principal name="admin" class="org.apache.geronimo.security.realm.providers.GeronimoGroupPrincipal"/&gt;
        &lt;/role&gt;
      &lt;/role-mappings&gt;
    &lt;/security&gt;

    &lt;cluster&gt;TomcatCluster&lt;/cluster&gt;
    &lt;gbean class="org.apache.geronimo.tomcat.cluster.CatalinaClusterGBean" name="TomcatCluster"&gt;
        &lt;attribute name="className"&gt;org.apache.catalina.ha.tcp.SimpleTcpCluster&lt;/attribute&gt;
        &lt;attribute name="initParams"/&gt;
        &lt;reference name="ClusterManager"&gt;          
            &lt;name&gt;TomcatClusterManager&lt;/name&gt;                
        &lt;/reference&gt;
        &lt;reference name="TomcatValveChain"&gt;
            &lt;name&gt;ReplicationValve&lt;/name&gt;
        &lt;/reference&gt;
        &lt;reference name="ClusterListenerChain"&gt;
            &lt;name&gt;ClusterSessionListener&lt;/name&gt;
        &lt;/reference&gt;
        &lt;reference name="Channel"&gt;
            &lt;name&gt;TomcatGroupChannel&lt;/name&gt;
        &lt;/reference&gt;
    &lt;/gbean&gt;
  &lt;!-- Cluster Manager --&gt;
    &lt;gbean name="TomcatClusterManager" class="org.apache.geronimo.tomcat.cluster.ClusterManagerGBean"&gt;
        &lt;attribute name="className"&gt;org.apache.catalina.ha.session.DeltaManager&lt;/attribute&gt;
        &lt;attribute name="initParams"&gt;name=${clusterName}
           channelSendOptions=6
           expireSessionsOnShutdown=false
           notifyListenersOnReplication=true
           mapSendOptions=6&lt;/attribute&gt;
    &lt;/gbean&gt;
  &lt;!-- Cluster Channel --&gt;
    &lt;gbean class="org.apache.geronimo.tomcat.cluster.ChannelGBean" name="TomcatGroupChannel"&gt;
        &lt;attribute name="className"&gt;org.apache.catalina.tribes.group.GroupChannel&lt;/attribute&gt;
        &lt;attribute name="initParams"/&gt;
        &lt;reference name="Membership"&gt;
            &lt;name&gt;TomcatMembership&lt;/name&gt;
        &lt;/reference&gt;
        &lt;reference name="Receiver"&gt;
            &lt;name&gt;TomcatReceiver&lt;/name&gt;
        &lt;/reference&gt;
        &lt;reference name="Sender"&gt;
            &lt;name&gt;TomcatSender&lt;/name&gt;
        &lt;/reference&gt;
        &lt;reference name="ChannelInterceptor"&gt;
            &lt;name&gt;TomcatChannelInterceptor&lt;/name&gt;
        &lt;/reference&gt;
    &lt;/gbean&gt;
  &lt;!-- Cluster Membership --&gt;
    &lt;gbean class="org.apache.geronimo.tomcat.cluster.MembershipServiceGBean" name="TomcatMembership"&gt;
        &lt;attribute name="className"&gt;org.apache.catalina.tribes.membership.McastService&lt;/attribute&gt;
        &lt;attribute name="initParams"&gt;
            mcastAddr=228.0.0.4
            mcastPort=45564
            mcastFrequency=500
            mcastDropTime=3000
        &lt;/attribute&gt;
    &lt;/gbean&gt;
  &lt;!-- Cluster Receiver --&gt;
    &lt;gbean class="org.apache.geronimo.tomcat.cluster.ReceiverGBean" name="TomcatReceiver"&gt;
        &lt;attribute name="className"&gt;org.apache.catalina.tribes.transport.nio.NioReceiver&lt;/attribute&gt;
        &lt;attribute name="initParams"&gt;
            tcpListenAddress=auto
            tcpListenPort=4001
            tcpSelectorTimeout=100
            tcpThreadCount=6
        &lt;/attribute&gt;
    &lt;/gbean&gt;
  &lt;!-- Cluster Sender --&gt;
    &lt;gbean class="org.apache.geronimo.tomcat.cluster.SenderGBean" name="TomcatSender"&gt;
        &lt;attribute name="className"&gt;org.apache.catalina.tribes.transport.ReplicationTransmitter&lt;/attribute&gt;
        &lt;attribute name="initParams"&gt;
            replicationMode=pooled
            waitForAck=true
        &lt;/attribute&gt;
    &lt;/gbean&gt;
  &lt;!-- Cluster Valves--&gt;
    &lt;gbean class="org.apache.geronimo.tomcat.ValveGBean" name="ReplicationValve"&gt;
        &lt;attribute name="className"&gt;org.apache.catalina.ha.tcp.ReplicationValve&lt;/attribute&gt;
        &lt;attribute name="initParams"&gt;filter=.*\.gif;.*\.js;.*\.css;.*\.png;.*\.jpeg;.*\.jpg;.*\.htm;.*\.html;.*\.txt;&lt;/attribute&gt;
        &lt;reference name="NextValve"&gt;
        	&lt;name&gt;JvmRouteBinderValve&lt;/name&gt;
        &lt;/reference&gt;
    &lt;/gbean&gt;
  &lt;!-- Cluster Route Binder --&gt;
    &lt;gbean class="org.apache.geronimo.tomcat.ValveGBean" name="JvmRouteBinderValve"&gt;
        &lt;attribute name="className"&gt;org.apache.catalina.ha.session.JvmRouteBinderValve&lt;/attribute&gt;
        &lt;attribute name="initParams"&gt;enabled=true&lt;/attribute&gt;
    &lt;/gbean&gt;
  &lt;!-- Cluster Listener --&gt;
    &lt;gbean class="org.apache.geronimo.tomcat.cluster.ClusterListenerGBean" name="ClusterSessionListener"&gt;
        &lt;attribute name="className"&gt;org.apache.catalina.ha.session.ClusterSessionListener&lt;/attribute&gt;
        &lt;reference name="NextListener"&gt;
            &lt;name&gt;JvmRouteSessionIDBinderListener&lt;/name&gt;
        &lt;/reference&gt;
    &lt;/gbean&gt;
  &lt;!-- Cluster Binder Listener--&gt;
    &lt;gbean class="org.apache.geronimo.tomcat.cluster.ClusterListenerGBean" name="JvmRouteSessionIDBinderListener"&gt;
        &lt;attribute name="className"&gt;org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener&lt;/attribute&gt;
    &lt;/gbean&gt;
  &lt;!-- Cluster Channel Interceptor --&gt;
    &lt;gbean class="org.apache.geronimo.tomcat.cluster.ChannelInterceptorGBean" name="TomcatChannelInterceptor"&gt;
        &lt;attribute name="className"&gt;org.apache.catalina.tribes.group.interceptors.TcpFailureDetector&lt;/attribute&gt;
    &lt;/gbean&gt;
&lt;/web-app&gt;
</pre>
</div></div>
<p>where </p>
<ul><li><em>web-cluster-server1</em> should match the WAR file name. It can be different for each node in the cluster.</li></ul>


<p>On each node, deploy your Web application, by using either the administration console or the <strong>deploy</strong> command, following this syntax:</p>
<div class="panel" style="border-style: solid;border-width: 1px;"><div class="panelContent">
<p><code>deploy --user <em>name</em> --password <em>word</em> deploy <em>archive</em> <em>plan</em></code></p>
</div></div>
<p>where </p>
<ul><li><em>name</em> is replaced with a user name authorized to manage the server. If you omit this option, you will be prompted to enter a user name.</li><li><em>word</em> is replaced with the password used to authenticate the user. If you omit this option, you will be prompted to enter a password.</li><li><em>archive</em> is replaced with a file specification to your Web application WAR file.</li><li><em>plan</em> is replaced with a file specification to your deployment plan.</li></ul>


<p>Note: After the server installation, the default user name is <strong>system</strong>, and the default password is <strong>manager</strong>.</p>

<h2 id="TomcatNativeClustering-SampleTomcatclusteringwithunicastconfiguration">Sample Tomcat clustering with unicast configuration</h2>

<p>The following code snippet is part of a clustering example that uses unicast configuration. Static members are defined using <code>org.apache.geronimo.tomcat.cluster.StaticMemberGBean</code>. You have to define each static member within your deployment plan to make sure that your application is clustered successfully, and make sure that TCP ports for session replication are defined consistently on each node.</p>

<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>excerpt from geronimo-web.xml</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
...
    &lt;cluster&gt;TomcatCluster&lt;/cluster&gt;
        &lt;gbean name="TomcatCluster" class="org.apache.geronimo.tomcat.cluster.CatalinaClusterGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.ha.tcp.SimpleTcpCluster&lt;/attribute&gt;
            &lt;attribute name="initParams"/&gt;
            &lt;reference name="ClusterListenerChain"&gt; 
                    &lt;name&gt;TomcatClusterListenerChain&lt;/name&gt;
            &lt;/reference&gt;
            &lt;reference name="TomcatValveChain"&gt;
                    &lt;name&gt;ReplicationValve&lt;/name&gt;  
            &lt;/reference&gt;
            &lt;reference name="Channel"&gt;
                    &lt;name&gt;TomcatChannel&lt;/name&gt;
            &lt;/reference&gt;
            &lt;reference name="ClusterManager"&gt; 
                    &lt;name&gt;TomcatClusterManager&lt;/name&gt;
            &lt;/reference&gt;
        &lt;/gbean&gt;

        &lt;gbean name="TomcatClusterListenerChain" class="org.apache.geronimo.tomcat.cluster.ClusterListenerGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.ha.session.ClusterSessionListener&lt;/attribute&gt;
            &lt;attribute name="initParams"/&gt;
        &lt;/gbean&gt;

        &lt;gbean name="ReplicationValve" class="org.apache.geronimo.tomcat.ValveGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.ha.tcp.ReplicationValve&lt;/attribute&gt;
            &lt;attribute name="initParams"&gt;.*\.gif;.*\.js;.*\.jpg;.*\.png;.*\.htm;.*\.html;.*\.css;.*\.txt;&lt;/attribute&gt;
            &lt;reference name="NextValve"&gt;
        			&lt;type&gt;TomcatValve&lt;/type&gt;
            	                &lt;name&gt;JvmRouteBinderValve&lt;/name&gt;
            &lt;/reference&gt;
        &lt;/gbean&gt;

        &lt;gbean name="JvmRouteBinderValve" class="org.apache.geronimo.tomcat.ValveGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.ha.session.JvmRouteBinderValve&lt;/attribute&gt;
            &lt;attribute name="initParams"&gt;enabled=true&lt;/attribute&gt;
        &lt;/gbean&gt;

        &lt;gbean name="TomcatClusterManager" class="org.apache.geronimo.tomcat.cluster.ClusterManagerGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.ha.session.DeltaManager&lt;/attribute&gt;
            &lt;attribute name="initParams"&gt;name=${clusterName}
                                         channelSendOptions=6
                                         expireSessionsOnShutdown=false
                                         notifyListenersOnReplication=true
                                         mapSendOptions=6
            &lt;/attribute&gt;
        &lt;/gbean&gt;

        &lt;gbean name="TomcatChannel" class="org.apache.geronimo.tomcat.cluster.ChannelGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.tribes.group.GroupChannel&lt;/attribute&gt;
            &lt;attribute name="initParams"/&gt;
            &lt;reference name="Membership"&gt; 
                    &lt;name&gt;ClusterMembership&lt;/name&gt;
            &lt;/reference&gt;
            &lt;reference name="Receiver"&gt;
                    &lt;name&gt;ClusterReceiver&lt;/name&gt;                
            &lt;/reference&gt;
            &lt;reference name="Sender"&gt;                
                    &lt;name&gt;ClusterSender&lt;/name&gt;
            &lt;/reference&gt;
            &lt;reference name="ChannelInterceptor"&gt;
                    &lt;name&gt;DisableMcastInterceptor&lt;/name&gt;                
            &lt;/reference&gt;
        &lt;/gbean&gt;

        &lt;gbean name="ClusterMembership" class="org.apache.geronimo.tomcat.cluster.MembershipServiceGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.tribes.membership.McastService&lt;/attribute&gt;
            &lt;attribute name="initParams"&gt;address=228.0.0.4
                                         port=45564
                                         frequency=500
                                         dropTime=3000
            &lt;/attribute&gt;
        &lt;/gbean&gt;

        &lt;gbean name="ClusterReceiver" class="org.apache.geronimo.tomcat.cluster.ReceiverGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.tribes.transport.nio.NioReceiver&lt;/attribute&gt;
            &lt;attribute name="initParams"&gt;address=IPAddress1
                                         port=TCP_port1
                                         selectorTimeout=100
                                         maxThreads=6
            &lt;/attribute&gt;
        &lt;/gbean&gt;

        &lt;gbean name="ClusterSender" class="org.apache.geronimo.tomcat.cluster.SenderGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.tribes.transport.ReplicationTransmitter&lt;/attribute&gt;
        &lt;/gbean&gt;

        &lt;gbean name="DisableMcastInterceptor" class="org.apache.geronimo.tomcat.cluster.ChannelInterceptorGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.geronimo.tomcat.interceptor.DisableMcastInterceptor&lt;/attribute&gt;
            &lt;attribute name="initParams"/&gt;
            &lt;reference name="NextInterceptor"&gt;
                    &lt;name&gt;TcpPingInterceptor&lt;/name&gt;                
            &lt;/reference&gt;
        &lt;/gbean&gt;

        &lt;gbean name="TcpPingInterceptor" class="org.apache.geronimo.tomcat.cluster.ChannelInterceptorGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.tribes.group.interceptors.TcpPingInterceptor&lt;/attribute&gt;
            &lt;attribute name="initParams"&gt;Interval=60&lt;/attribute&gt;
            &lt;reference name="NextInterceptor"&gt;
                    &lt;name&gt;TcpFailureDetector&lt;/name&gt;                
            &lt;/reference&gt;
        &lt;/gbean&gt;

        &lt;gbean name="TcpFailureDetector" class="org.apache.geronimo.tomcat.cluster.ChannelInterceptorGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.tribes.group.interceptors.TcpFailureDetector&lt;/attribute&gt;
            &lt;attribute name="initParams"/&gt;
            &lt;reference name="NextInterceptor"&gt;                
                    &lt;name&gt;StaticMember1Interceptor&lt;/name&gt;                
            &lt;/reference&gt;
        &lt;/gbean&gt;

        &lt;gbean name="StaticMember1Interceptor" class="org.apache.geronimo.tomcat.cluster.ChannelInterceptorGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.tribes.group.interceptors.StaticMembershipInterceptor&lt;/attribute&gt;
            &lt;attribute name="initParams"/&gt;
            &lt;reference name="StaticMember"&gt;
                    &lt;name&gt;StaticMember2&lt;/name&gt;                
            &lt;/reference&gt;
            &lt;reference name="NextInterceptor"&gt;                
                    &lt;name&gt;MessageDispatch15Interceptor&lt;/name&gt; 
            &lt;/reference&gt;
        &lt;/gbean&gt;

        &lt;gbean name="MessageDispatch15Interceptor" class="org.apache.geronimo.tomcat.cluster.ChannelInterceptorGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor&lt;/attribute&gt;
            &lt;attribute name="initParams"/&gt;
            &lt;reference name="NextInterceptor"&gt;
                    &lt;name&gt;ThroughputInterceptor&lt;/name&gt;                
            &lt;/reference&gt;
        &lt;/gbean&gt;

        &lt;gbean name="ThroughputInterceptor" class="org.apache.geronimo.tomcat.cluster.ChannelInterceptorGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.tribes.group.interceptors.ThroughputInterceptor&lt;/attribute&gt;
            &lt;attribute name="initParams"/&gt;
        &lt;/gbean&gt;

        &lt;gbean name="StaticMember2" class="org.apache.geronimo.tomcat.cluster.StaticMemberGBean"&gt;
            &lt;attribute name="className"&gt;org.apache.catalina.tribes.membership.StaticMember&lt;/attribute&gt;
            &lt;attribute name="initParams"&gt;port=TCP_port2
                                         securePort=-1
                                         host=IPAddress2
                                         domain=test-domain
                                         UniqueId={2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
            &lt;/attribute&gt;
        &lt;/gbean&gt;
...
</pre>
</div></div>

<p>Where</p>
<ul><li><em>IPAddress1</em> is the IP address or host name of the current static member.</li><li><em>TCP_port1</em> is the TCP port on the current node to listen for session replication data from other static members.</li><li><em>IPAddress2</em> is the IP address or host name of the second static member.</li><li><em>TCP_port2</em> is the TCP port on the second static member to listen for session replication data from other static members</li></ul>


<p>To convert this example to a multicast configuration, removed the DisableMCastInterceptor, StaticMemberInterceptor, and StaticMember definitions. Also, change the value for the "address" attribute for the TomcatReceiver definition to "auto". </p>

<h1 id="TomcatNativeClustering-ConfiguringtheclusteratEngineorHostlevel">Configuring the cluster at Engine or Host level</h1>
<p>You can configure the cluster just like you always did for a standalone Tomcat Web container. Input all the clustering configuration into the <code>var/catalina/server.xml</code> file according to your requirements in Geronimo. Both multicast and unicat are supported.  See the following sample codes when you want to configure an Engine or Host level cluster. Make sure that these segments are enclosed within the <strong>&lt;Engine&gt;</strong> or <strong>&lt;Host&gt;</strong> element in <code>server.xml</code>. <em>${clusterName}</em> is from <code>var/config/config-substitutions.properties</code>, which should be identical within all nodes in a cluster.</p>

<p>Details about each component of the cluster and configuration options can be found in the tomcat documentation at <a shape="rect" class="external-link" href="http://tomcat.apache.org/tomcat-6.0-doc/cluster-howto.html" title="Tomcat6 Clustering">Tomcat6 clustering</a>.</p>

<h2 id="TomcatNativeClustering-Samplemulticastconfigurationcode">Sample multicast configuration code</h2>
<div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>server.xml</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
...
     &lt;Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster" channelSendOptions="8"&gt;
                    &lt;Manager className="org.apache.catalina.ha.session.DeltaManager" expireSessionsOnShutdown="false" notifyListenersOnReplication="true" name="${clusterName}" channelSendOptions="6" mapSendOptions="6"/&gt;
                    &lt;Channel className="org.apache.catalina.tribes.group.GroupChannel"&gt;
                        &lt;Membership className="org.apache.catalina.tribes.membership.McastService" address="228.0.0.4" port="45564" frequency="500" dropTime="3000" /&gt;
                        &lt;Receiver className="org.apache.catalina.tribes.transport.nio.NioReceiver" address="auto" port="4000" autoBind="100" selectorTimeout="5000" maxThreads="6" /&gt;
                        &lt;Sender className="org.apache.catalina.tribes.transport.ReplicationTransmitter"&gt;
                            &lt;Transport className="org.apache.catalina.tribes.transport.nio.PooledParallelSender" /&gt;
                        &lt;/Sender&gt;                        
                        &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.TcpFailureDetector" interval="60"/&gt;                        
                        
                        &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor" /&gt;
                        &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.ThroughputInterceptor" /&gt;                        
                    &lt;/Channel&gt;
                    &lt;Valve className="org.apache.catalina.ha.tcp.ReplicationValve" filter=".*\.gif;.*\.js;.*\.jpg;.*\.png;.*\.htm;.*\.html;.*\.css;.*\.txt;" /&gt;
                    &lt;Valve className="org.apache.catalina.ha.session.JvmRouteBinderValve" /&gt;
                    &lt;ClusterListener className="org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener" /&gt;
                    &lt;ClusterListener className="org.apache.catalina.ha.session.ClusterSessionListener" /&gt;
      &lt;/Cluster&gt;
...
</pre>
</div></div>

<h2 id="TomcatNativeClustering-Sampleunicastconfigurationcode">Sample unicast configuration code</h2>
<div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>server.xml</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
...
    &lt;Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster" channelSendOptions="8"&gt;
                    &lt;Manager className="org.apache.catalina.ha.session.DeltaManager" expireSessionsOnShutdown="false" notifyListenersOnReplication="true" name="${clusterName}" channelSendOptions="6" mapSendOptions="6"/&gt;
                    &lt;Channel className="org.apache.catalina.tribes.group.GroupChannel"&gt;
                        &lt;Membership className="org.apache.catalina.tribes.membership.McastService" address="228.0.0.4" port="45564" frequency="500" dropTime="3000" /&gt;
                        &lt;Receiver className="org.apache.catalina.tribes.transport.nio.NioReceiver" address="auto" port="4000" autoBind="100" selectorTimeout="5000" maxThreads="6" /&gt;
                        &lt;Sender className="org.apache.catalina.tribes.transport.ReplicationTransmitter"&gt;
                            &lt;Transport className="org.apache.catalina.tribes.transport.nio.PooledParallelSender" /&gt;
                        &lt;/Sender&gt;
                        &lt;Interceptor className="org.apache.geronimo.tomcat.interceptor.DisableMcastInterceptor" /&gt;
                        &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.TcpFailureDetector" interval="60"/&gt;                        
                        &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.StaticMembershipInterceptor"&gt;
                            &lt;Member port="TCP_port" securePort="-1" host="IPAddress" domain="test-domain" UniqueId="{1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}" /&gt;
                        &lt;/Interceptor&gt;
                        &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor" /&gt;
                        &lt;Interceptor className="org.apache.catalina.tribes.group.interceptors.ThroughputInterceptor" /&gt;                        
                    &lt;/Channel&gt;
                    &lt;Valve className="org.apache.catalina.ha.tcp.ReplicationValve" filter=".*\.gif;.*\.js;.*\.jpg;.*\.png;.*\.htm;.*\.html;.*\.css;.*\.txt;" /&gt;
                    &lt;Valve className="org.apache.catalina.ha.session.JvmRouteBinderValve" /&gt;
                    &lt;ClusterListener className="org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener" /&gt;
                    &lt;ClusterListener className="org.apache.catalina.ha.session.ClusterSessionListener" /&gt;
      &lt;/Cluster&gt;
...
</pre>
</div></div>

<p>Where</p>
<ul><li><em>IPAddress</em> is the IP address or host name of the second static member.</li><li><em>TCP_port</em> is the TCP port on the second static member to listen for session replication data from other static members.</li></ul></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="middle" class="footer">
            &nbsp;&nbsp;
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Delicious" />
            <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">Bookmark this on Delicious</a>
            &nbsp;&nbsp;
            <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="Digg!" />
            <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title)+'&amp;topic=programming');">Digg this</a>
            <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : Tomcat Native Clustering';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
            &nbsp;&nbsp;
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">Privacy Policy</a>&nbsp;&nbsp;-&nbsp;&nbsp;
            Copyright &#169; 2003-2013, The Apache Software Foundation, Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0.</a>&nbsp;&nbsp;
          </td>
        </tr>
    </table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  </body>
</html>
