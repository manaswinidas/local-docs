<html lang="zh-Hans" ><head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link type="text/css" rel="stylesheet" href="asset?aid=0">
    <link rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <link rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <meta name="Description" content="Connectors and Transaction Management">
    <meta name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi Connectors and Transaction Management">
    <meta name="Owner" content="dev@geronimo.apache.org">
    <meta name="Robots" content="index, follow">
    <meta name="Security" content="Public">
    <meta name="Source" content="wiki template">
    <meta name="DC.Date" scheme="iso8601" content="2010-05-11">
    <meta name="DC.Language" scheme="rfc1766" content="en">
    <meta name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation">
    <meta http-equiv="PICS-Label" content="(PICS-1.1 " http:="" ="" www.icra.org="" ratingsv02.htm="=" www.rsac.org="" ratingsv01.htm="=" (ss~~000="" 1)="=">

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>


    <title>Apache Geronimo v3.0文档：连接器和事务管理</title>
  </head>

  <body  onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tbody><tr>
        <td align="left" valing="top">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </tbody></table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tbody><tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" nowrap>
          <a href="/geronimo">Home</a> > <a href="documentation.html">文档</a> > <a href="reference.html">参考</a> > <a href="geronimo-architecture.html">Geronimo体系结构</a> > <a href="connectors-and-transaction-management.html">连接器和事务管理</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8">
            <input type="hidden" name="oe" value="UTF-8">
            <input type="hidden" name="domains" value="">
            <input type="hidden" name="sitesearch" value="">
            <input type="text" name="q" value="" maxlength="255">        
            <input type="submit" name="btnG" value="谷歌搜索">
          </form>
        </td>
      </tr> 
    </tbody></table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding:6px 0px 0px 0px">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div class="smalltext" style="margin:0px 10px 0px 10px">Apache Geronimo v3.0</div>
        <div class="pagetitle" style="margin:0px 10px 8px 10px">连接器和交易管理</div>

        <div class="greynavbar" align="right" style="padding:2px 10px;margin:0px">
<!-- --> <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645477"><img src="http://geronimo.apache.org/images/icons/notep_16.gif" height="16" width="16" border="0" title="编辑页面"></a> <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645477">编辑页面</a> <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30"><img src="http://geronimo.apache.org/images/icons/browse_space.gif" height="16" width="16" border="0" title="浏览空间"></a> <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">浏览空间</a> <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645477"><img src="http://geronimo.apache.org/images/icons/add_page_16.gif" height="16" width="16" border="0" title="添加页面"></a> <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645477">添加页面</a> <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645477"><img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif" height="16" width="16" border="0" title="新增新闻"></a> <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645477">新增新闻</a> <!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent"><h1 id="ConnectorsandTransactionManagement-Overview">总览</h1>
<p>Geronimo中的入站和出站连接通过J2CA连接器框架进行管理。这涵盖了JDBC，JMS，数据源，EIS连接性和连接池。通过将JDBC XADataSource，ConnectionPoolDataSource，DataSource或Driver实现包装在J2CA连接器包装中，可以实现JDBC连接。我们使用的包装器来自<a shape="rect" class="external-link" href="http://tranql.codehaus.org/" rel="nofollow">codehaus Tranql</a>项目。</p>

<h1 id="ConnectorsandTransactionManagement-TransactionManager">交易经理</h1>
<p>应用程序可以通过应用程序管理的UserTransactions或ejbs容器管理器事务将事务管理委托给服务器基础结构。服务器使用事务管理器将事务边界的此应用程序视图与对特定事务内的特定数据存储完成的工作的资源管理器视图进行协调。Geronimo使用通过以下三种方式扩展的JTA TransactionManager实现：</p>
<ol><li>J2CA入站连接器要求所要求的事务流入</li><li>可插拔事务日志记录，默认情况下使用HOWL（高速ObjectWeb Logger）用于服务器中的可恢复事务管理器，而在应用程序客户端中使用非日志记录的“记录器”</li><li>当连接器在故障之后启动时，增量恢复不确定事务。这样，即使重新启动了使用已部署连接器的子集的事务，即使某些其他资源管理器尚不可用，它们也可以在恢复后立即完全恢复。</li></ol>


<h2 id="ConnectorsandTransactionManagement-RequirementsforXAResourceimplementationstoenablerecovery">XAResource实施以实现恢复的要求</h2>
<p>XA规范没有提供任何方法来确定不确定事务中的xid与哪个XAResource关联。为了在没有此信息的情况下恢复工作，需要所有资源管理器的全局注册表，并且恢复只能在所有资源管理器启动并连接到事务管理器后才能开始。为了避免需要这种永久性注册表以及对整个环境的依赖，geronimo将每个xid与与其一起使用的XAResource关联起来。通过要求每个XAResource都有一个名称，实现NamedXAResource（一个geronimo接口）来完成此操作。而且，每个连接器（或XAResource的其他“源”）在启动时都需要向事务管理器注册NamedXAResource。该名称与xid一起存储，因此，一旦特定事务中使用的所有XAResources已注册，即可完成特定事务的恢复。<br clear="none">NamedXAResource提供的名称在重新启动后必须稳定，并且对于资源管理器而言是唯一的。在geronimo中，我们对出站连接使用ManagedConnectionFactoryWrapper的gbean名称，对入站连接器使用ResourceAdapter gbean的名称。</p>

<h2 id="ConnectorsandTransactionManagement-Configuringtheidentityofthetransactionmanager">配置事务管理器的身份</h2>
<p>如果针对一个XADatabase之类的资源管理器运行多个geronimo实例，则需要确保该资源管理器可以区分哪个geronimo实例正在发出每个请求。您可以通过设置事务管理器身份来做到这一点。请参阅<a shape="rect" href="configuring-the-transaction-manager-identity.html">配置事务管理器身份</a></p>

<h1 id="ConnectorsandTransactionManagement-Connectorframework">连接器框架</h1>
<p>J2CA连接器规范为配置和池化出站连接以及配置和管理入站消息传递提供了一种合理的方法。Geronimo通过使用tranql项目包装器将jdbc构件包装在所需的J2CA构件中，将其用于jdbc连接支持。</p>
<h2 id="ConnectorsandTransactionManagement-ConnectionPooling(outboundconnectors)">连接池（出站连接器）</h2>
<p>通常，与旧版EIS系统和数据库的连接建立起来的连接非常昂贵。通常，您使用连接池而不是在每次需要时都与外部系统建立新的连接：当需要连接时，池中会提供未使用的连接，当应用程序完成后，将连接放回去在游泳池。J2CA规范通过以下组件支持此想法：</p>

<h3 id="ConnectorsandTransactionManagement-ConnectionFactory">连接工厂</h3>
<p>连接工厂（例如DataSource）是应用程序用来获取其可以使用的“连接”的组件。这些连接是对基础“物理”托管连接的短暂，轻量级的句柄或包装。当应用程序调用datasource.getConnection（）时，连接工厂会将请求路由到连接管理器，连接管理器从高速缓存的，池化的或新的连接中提供合适的连接句柄。</p>

<h3 id="ConnectorsandTransactionManagement-Connectionmanager">连接管理器</h3>
<p>连接管理器从连接工厂收到连接请求，并弄清楚如何适应它们。它还接收事务事件的通知以及应用程序组件（例如ejbs）之间的控制权转移。<br clear="none">通常，如果环境中存在缓存的ManagedConnection，则连接管理器将新的句柄返回到缓存的ManagedConnection。否则，它将在池中寻找合适的ManagedConnection，并返回该连接的句柄（如果存在）。否则，它将创建一个新的连接。</p>

<h4 id="ConnectorsandTransactionManagement-Transactionsupport">交易支持</h4>
<p>可以为geronimo中的连接管理器配置xa，本地或不支持事务。</p>

<h5 id="ConnectorsandTransactionManagement-Notransaction">没有交易</h5>
<p>没有事务支持意味着连接永远不会注册到jta事务中，并且提交这样的jta事务对连接管理器管理的任何连接都没有影响。在这种情况下，连接管理器不进行缓存，并且每个连接请求都是独立处理的。</p>

<h5 id="ConnectorsandTransactionManagement-Localtransaction">本地交易</h5>
<p>本地事务支持依赖于j2ca本地事务控制的连接器支持。这映射到非xa jdbc驱动程序，DataSource和ConnectionPoolDataSource实现。在这种情况下，geronimo构造了一个“伪” XAResource，它使JTA事务管理器可以控制本地事务，但是未实现xa功能，如准备阶段和提交阶段分离以及恢复。由于资源管理器没有让它区分正在进行的事务工作的事务标识符，因此连接管理器必须通过缓存jta事务中注册的所有连接来跟踪此事务。在jta事务中，只要您的应用程序请求连接，连接管理器都会检查该事务中是否注册了一个现有连接，如果找到，则会为它提供附加的句柄。如果没有关联，则从池中获取一个连接（或重新创建一个连接）并与事务一起缓存。此外，关闭这些连接句柄中的一个或全部将不会导致将连接返回到池中。仅当所有句柄都已关闭并且jta事务完成时，连接才会返回到池中。</p>

<h5 id="ConnectorsandTransactionManagement-XAtransaction">XA交易</h5>
<p>从理论上讲，XA事务支持不应要求与事务进行缓存连接，但实际上通常需要。XA规范表明，任何连接都应能够在任何时间处理任何事务中的工作，但是几乎没有能够XA的资源管理器实际实现此功能。通常，您必须在同一物理连接上针对给定的资源管理器在JTA事务中完成所有工作。设置事务缓存将确保发生这种缓存。<br clear="none">XAResource上的enlist / delist方法的目的似乎是支持在线程进入和离开“ Requires New”事务边界时重用线程中的连接。默认情况下，geronimo不会尝试以这种方式重用连接：与上一个事务关联的连接保持与之关联，新的连接请求从池中获得新的ManagedConnections。有一个实验配置可以重用已经与线程关联的连接。</p>

<h4 id="ConnectorsandTransactionManagement-Security(Credentials)">安全性（凭据）</h4>
<p>在J2CA 1.5规范中，安全性考虑仅限于提供出站连接的凭据。没有为入站消息传递凭据流入的准备。下一个规范修订版将解决此漏洞。<br clear="none">有三种可能的出站连接凭据来源：</p>
<ol><li>ManagedConnectionFactory配置。大多数ManagedConnectionFactory实现都包括用户和密码配置属性。在没有其他凭据的情况下，这些凭据将用于向资源管理器进行身份验证。这些属性的值通常很难安全地隐藏，因为它们位于磁盘上的某些geronimo配置文件中，并且需要geronimo可以访问以创建连接。但是，这是迄今为止最常用的选项。这将导致您的数据库中的所有工作都由同一用户完成，这基本上代表了geronimo服务器的身份。</li><li>应用程序管理的安全性。许多连接工厂（例如DataSource）提供了一种方法来请求具有特定安全性上下文的连接，例如dataSource.getConnection（user，password）。这要求您的应用程序具有所需凭据的详细知识，而这几乎是不合适的。</li><li>容器管理的安全性。使用此方案，您可以部署特定于所使用连接器的LoginModule，该模块将在登录时将适当的凭据安装到Subject中。当请求连接时，这些凭据将从主题中提取出来，并用于获取连接。这里可以使用多种方案，包括<ul><li>固定凭证。每个主题都具有相同的凭据。这与默认凭据方案具有相同的效果，除了可以更轻松地将凭据存储在外部更安全的位置。</li><li>用户凭证。凭据是用户本身的用户名和密码。在这种情况下，将以用户自己的身份在资源管理器（数据库）中完成工作。除非连接器支持重新认证（在现有连接上更改用户），否则这将阻止有效的连接池。</li><li>映射的凭证。资源管理器的凭据是根据用户身份确定的。例如，资源管理器用户可能依赖于该用户是特定企业角色或组的成员。在这种情况下，应在没有重新认证支持的情况下建立连接池，以便每个资源管理器用户都获得一个单独的池。
<div class="confluence-information-macro confluence-information-macro-note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"></span><div class="confluence-information-macro-body">
<p>TODO容器管理的安全性示例</p></div></div></li></ul>
	</li></ol>


<h4 id="ConnectorsandTransactionManagement-Poolingconfiguration">池配置</h4>
<p>有效的连接池依赖于池中的所有连接实际上是相同的。我们将不在这里讨论重新认证支持的影响：我知道唯一可用的地方是在某些Oracle连接器中，并且只能通过使用一些特殊的程序包进行。Geronimo允许您为具有一个或多个池的单个连接管理器/ ManagedConnectionFactory设置池。通过凭据将多个池与应用程序管理的安全性或容器管理的安全性区分开。给定一个请求，geronimo会寻找一个具有匹配凭据的池，如果没有，则创建一个池。特别是，这意味着池大小是按凭据集设置的，因此，如果有10个不同的用户且池大小为10，则多个池中可能有100个连接。<br clear="none">在单个池中，您可以指定geronimo如何努力工作以确保连接与请求匹配。</p>
<ul><li>如果确定所有连接都完全相同，请指定“选择一个假设匹配”，并且geronimo将不进行匹配。这是最快的选项，但如果连接实际上不相同，则会导致错误。</li><li>如果连接大致相同，但是您不太确定，则match-one将从池中选择一个连接并将其与请求匹配。如果匹配失败，则所选连接将被破坏。</li><li>如果连接不相同，请使用全部匹配。Geronimo将匹配每个请求，将所有合并的连接选择为最佳匹配。这对于并发负载可能无法正常工作。</li></ul>


<h2 id="ConnectorsandTransactionManagement-ManagedConnectionFactoryandManagedConnection">ManagedConnectionFactory和ManagedConnection</h2>
<p>出站连接器包括ManagedConnectionFactory和ManagedConnection实现。ManagedConnection表示与资源管理器（数据库）的实际“物理”连接。ManagedConnectionFactory包含所需ManagedConnections的配置，例如资源管理器的位置。它还包含匹配代码，用于从一组连接中选择一个与请求匹配的连接。ManagedConnection还可以提供连接工厂可以返回的连接句柄。<br clear="none">在geronimo中，我们用gbean包装ManagedConnectionFactory，以便可以像配置其他geronimo组件一样对其进行配置。</p>

<h1 id="ConnectorsandTransactionManagement-JDBC">JDBC</h1>
<p>通常，通过将JDBC工件包装在codehaus tranql项目的J2CA工件中来提供JDBC支持。一些数据库（例如Firebird）也提供可以直接部署的J2CA实现。Tranql提供了一个用于构造出站资源适配器和各种已发布适配器的框架。</p>
<h2 id="ConnectorsandTransactionManagement-GenericWrapper">通用包装</h2>
<p>所有JDBC实现都至少提供一个Driver实现。Tranql提供了一个通用连接器org.tranql：tranql-connector-ra：1.4：rar，可以与任何Driver实现一起使用。这仅提供本地事务支持，并且要求您在jdbc url中编码任何特定的连接属性。</p>
<h2 id="ConnectorsandTransactionManagement-Databasespecificwrappers">数据库特定的包装器</h2>
<p>大多数JDBC实现还提供DataSource，ConnectionPoolDataSource或XADataSource实现。tranql框架旨在简化为这些类编写数据库特定的包装程序的过程。使用此类包装器，可以在这些连接工厂或“托管连接工厂”上设置的属性显示为ManagedConnectionFactory的配置属性，并可以在ra.xml中进行记录。当前，tranql为DB2（xa），Derby（本地和xa，嵌入式和客户端），mysql（本地和xa），oracle（本地和xa）和postgres（本地和xa）提供包装。</p>

<h1 id="ConnectorsandTransactionManagement-JMS">JMS</h1>
<p>从J2EE 1.4开始，预计JMS实现将提供一个Java EE环境中使用的J2CA资源适配器。Geronimo依靠此获得JMS支持。Geronimo提供ActiveMQ作为默认的JMS提供程序。</p>

<h1 id="ConnectorsandTransactionManagement-EIS">信息系统</h1>
<p>J2CA规范设想通过J2CA连接器在EE服务器和EIS之间建立连接。J2CA提供了已经描述的出站连接以及到MDB的入站连接。与可以在容器控制的事务中传递消息的JMS样式异步入站消息传递一起，可以在适配器提供的事务中执行消息传递。当前没有用于安全上下文导入的工具，但是在下一个J2CA规范修订版中有望实现。</p></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tbody><tr>
          <td align="left" valign="middle" class="footer">
              
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="美味的"> <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&noui&jump=close&url='+encodeURIComponent(location.href)+'&title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">在Delicious上添加书签</a> <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="掘客！"> <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&title='+encodeURIComponent(document.title)+'&topic=programming');">挖这个</a> <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : Connectors and Transaction Management';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
              
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">隐私权政策</a> -版权所有©2003-2013，Apache软件基金会，根据<a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0</a>许可<a href="http://www.apache.org/licenses/LICENSE-2.0">。</a>  
          </td>
        </tr>
    </tbody></table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  

</body></html>