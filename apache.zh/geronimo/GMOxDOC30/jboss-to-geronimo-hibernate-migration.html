<html lang="zh-Hans" ><head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link type="text/css" rel="stylesheet" href="asset?aid=2">
    <link rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <link rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <meta name="Description" content="JBoss to Geronimo - Hibernate Migration">
    <meta name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi JBoss to Geronimo - Hibernate Migration">
    <meta name="Owner" content="dev@geronimo.apache.org">
    <meta name="Robots" content="index, follow">
    <meta name="Security" content="Public">
    <meta name="Source" content="wiki template">
    <meta name="DC.Date" scheme="iso8601" content="2010-05-11">
    <meta name="DC.Language" scheme="rfc1766" content="en">
    <meta name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation">
    <meta http-equiv="PICS-Label" content="(PICS-1.1 " http:="" ="" www.icra.org="" ratingsv02.htm="=" www.rsac.org="" ratingsv01.htm="=" (ss~~000="" 1)="=">

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>


    <title>Apache Geronimo v3.0文档：从JBoss到Geronimo-Hibernate迁移</title>
  </head>

  <body  onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tbody><tr>
        <td align="left" valing="top">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </tbody></table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tbody><tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" nowrap>
          <a href="/geronimo">Home</a> > <a href="documentation.html">文档</a> > <a href="migrating-to-apache-geronimo.html">迁移到Apache Geronimo</a> > <a href="migrating-from-jboss-to-geronimo.html">从JBoss</a> <a href="migrating-to-apache-geronimo.html">迁移到Geronimo</a> > <a href="migrating-from-jboss-to-geronimo.html">从</a> <a href="jboss-to-geronimo-hibernate-migration.html">JBoss到Geronimo-Hibernate迁移</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8">
            <input type="hidden" name="oe" value="UTF-8">
            <input type="hidden" name="domains" value="">
            <input type="hidden" name="sitesearch" value="">
            <input type="text" name="q" value="" maxlength="255">        
            <input type="submit" name="btnG" value="谷歌搜索">
          </form>
        </td>
      </tr> 
    </tbody></table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding:6px 0px 0px 0px">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div class="smalltext" style="margin:0px 10px 0px 10px">Apache Geronimo v3.0</div>
        <div class="pagetitle" style="margin:0px 10px 8px 10px">从JBoss到Geronimo-休眠迁移</div>

        <div class="greynavbar" align="right" style="padding:2px 10px;margin:0px">
<!-- --> <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645282"><img src="http://geronimo.apache.org/images/icons/notep_16.gif" height="16" width="16" border="0" title="编辑页面"></a> <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645282">编辑页面</a> <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30"><img src="http://geronimo.apache.org/images/icons/browse_space.gif" height="16" width="16" border="0" title="浏览空间"></a> <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">浏览空间</a> <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645282"><img src="http://geronimo.apache.org/images/icons/add_page_16.gif" height="16" width="16" border="0" title="添加页面"></a> <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645282">添加页面</a> <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645282"><img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif" height="16" width="16" border="0" title="新增新闻"></a> <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645282">添加新闻</a> <!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent"><p><span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-top"></span><br clear="none">本文将帮助您将使用Hibernate 4.1作为ORM工具的应用程序从JBoss Application Server 7.0迁移到Apache Geronimo 3.0。</p>

<p>Hibernate是功能强大的高性能对象/关系持久性和查询服务。它有助于开发持久性（POJO）类，该类具有用于属性的getter和setter方法，然后将其映射到数据库中的字段。您可能会遵循面向对象的习惯用法-包括关联，继承，多态性，组成和集合。Hibernate允许您使用自己的可移植SQL扩展（HQL），本机SQL或面向对象的Criteria and Example API来表达查询。</p>

<p>基本上，Hibernate将Java类映射到数据库表。它还提供了数据查询和检索功能，大大减少了开发时间。它自然适合于JAVA中间层中面向对象的代码开发模式。Hibernate的独特之处在于它促进了透明的持久性，使应用程序可以切换到任何数据库，无论是MySQL，Oracle还是DB2。Hibernate可以用于Java Swing应用程序，基于Java Servlet的应用程序或使用EJB会话bean（在本例中为基于Java Servlet的应用程序）的Java EE应用程序中。</p>

<p>为了说明迁移所涉及的步骤，提供了一个示例应用程序，我们将首先在JBoss中进行部署，然后再迁移到Geronimo。该示例应用程序将是我们已经在JDBC迁移示例中使用的Online Brokerage应用程序。此应用程序已更改为使用Hibernate进行持久化。</p>

<p>本文分为以下几节：</p>
<ul><li><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-implementation">Hibernate实现分析</a></li><li><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-sampleApp">样品申请</a></li><li><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-JBoss">JBoss环境</a></li><li><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-Geronimo">Geronimo环境</a></li><li><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-migration">分步迁移</a></li><li><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-summary">摘要</a></li></ul>


<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h1 id="JBosstoGeronimo-HibernateMigration-Hibernateimplementationanalysisimplementation">Hibernate实现分析<span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-implementation"></span></h1>

<p>Hibernate可以提供以下服务：</p>
<ul><li>连接管理</li><li>交易管理</li><li>对象关系映射</li></ul>


<p>它也非常灵活，我们可以使用这些服务的任何组合。在本文中，我们将配置休眠状态以仅提供O / R映射功能，而JBoss / Geronimo将同时提供事务管理和连接管理。这是带有应用程序服务器的Hibernate最常用的配置。Hibernate需要一个配置文件<code>hibernate.cfg.xml</code>这将创建连接池并设置所需的环境。它包含诸如数据库驱动程序，连接URL，方言（指定使用哪个RDBMS），用户名，密码，池大小等参数。它还包含映射文件的位置<code>*.hbm.xml</code> 。映射文件用于将数据库表中的字段映射到持久类属性。</p>

<p>这些特性是<strong>共同</strong>的任何应用程序服务器，包括<strong>Apache Geronimo的3.0版</strong> 。</p>

<p>但是，JBoss（更具体地说是Hibernate MBean）提供了<strong>两个</strong>附加的部署机制。</p>

<p>第一个是Hibernate Archive（HAR文件）。在这里，所有的Hibernate类和映射文件都打包在一个特殊的归档文件HAR文件中。JBoss部署该归档文件的方式与处理EAR或WAR文件的方式相同。</p>

<p>HAR文件的替代方法是简单地将所有Hibernate类和映射文件与其他应用程序类放在一起，例如在EAR中。Hibernate MBean将被单独配置，并被告知在所有应用程序JAR中搜索映射文件。两种部署机制都允许您将Hibernate对象提供给应用程序代码，而无需执行任何手动配置或编写通常需要的安装代码。</p>

<p>从结构上讲，HAR文件类似于JBoss服务档案（SAR文件）。HAR文件包含Hibernate类文件和映射文件（* .hbm.xml）以及标准文件<code>jboss-service.xml</code>该文件包含为创建的Hibernate应用程序的需求而配置的Hibernate MBean的定义。在最新的JBoss发行版中，它已重命名为<code>hibernate-service.xml</code> ，但保留相同的结构和目的。</p>

<p>Hibernate归档文件可以作为顶级程序包或EAR文件的组件进行部署。由于Hibernate档案不是标准的J2EE部署类型，因此我们需要在<code>jboss-app.xml</code> EAR文件的文件以在该上下文中使用它们。</p>

<p>下表提供了这两个应用服务器之间的功能对比。</p>
<div class="table-wrap"><table class="confluenceTable"><tbody><tr><th colspan="1" rowspan="1" class="confluenceTh"><p>特征</p></th><th colspan="1" rowspan="1" class="confluenceTh"><p>Apache Geronimo v3.0</p></th><th colspan="1" rowspan="1" class="confluenceTh"><p>JBoss v7.0</p></th></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p>容器管理的数据源</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>支持的。Hibernate能够使用给定了JNDI名称的数据源。这是因为它在与应用程序相同的线程中运行。</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>支持的。给定其JNDI名称，Hibernate可以从JNDI查找数据源。</p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p>自动JNDI绑定</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>不支持。</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>支持的。设置属性后，会话工厂将绑定到JNDI上下文。</p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p>JTA会话绑定</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>开箱即用不支持此功能。我们需要为Geronimo Transaction Manager写一个查询来启用它。</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>开箱即用的支持。Hibernate为JBoss Transaction Manager提供了一个查找类。</p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p>JMX部署</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>不支持开箱即用。<strong>可以通过编写GBean和Hibernate Connection Provider类来实现</strong> 。</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>支持的。Hibernate与<code>org.hibernate.jmx.HibernateService</code>可以部署在JBoss上。</p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p>休眠档案（HAR）</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>不支持。Hibernate类被部署为J2EE归档文件的一部分。</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>支持的。HAR打包了配置和映射文件，从而为部署提供了额外的服务器支持。</p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p>快取</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>您可以使用hibernate提供的缓存机制。</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>您可以使用hibernate提供的缓存机制。还支持与JBoss Cache集成。</p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p>会话管理</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>不支持。需要手动打开会话。只有交易需要关闭。</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>Hibernate Session的生命周期可以自动绑定到<br class="atl-forced-newline" clear="none">JTA交易。这意味着您不再需要手动打开和关闭Session，这成为JBoss EJB拦截器的工作。</p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p>休眠映射文件</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>我们需要指定Hibernate映射文件的位置。</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>如果我们使用HAR部署，那么JBoss将自动查找Hibernate映射文件。</p></td></tr></tbody></table></div>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h1 id="JBosstoGeronimo-HibernateMigration-SampleapplicationsampleApp">样品申请<span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-sampleApp"></span></h1>

<p>本文包含一个示例应用程序，以演示从JBoss迁移到Geronimo的应用程序，称为<a shape="rect" href="jboss-to-geronimo-hibernate-migration.data/brokerage.zip?version=1&modificationDate=1204180993000&api=v2" data-linked-resource-id="20874015" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="brokerage.zip" data-nice-type="Zip Archive" data-linked-resource-content-type="application/zip" data-linked-resource-container-id="20645282" data-linked-resource-container-version="5">Online Brokerage</a> 。它代表一种在线交易场景，用户可以在其中买卖股票。该应用程序具有以下五个页面：</p>
<ul><li>登录页面</li><li>注册页面</li><li>用户信息页面</li><li>可用库存页面</li><li>用户组合页面</li></ul>


<p>下图说明了应用程序流程：<span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" src="jboss-to-geronimo-hibernate-migration.data/brokerage.jpg" data-image-src="/confluence/download/attachments/20645282/brokerage.jpg?version=1&modificationDate=1204180993000&api=v2" data-unresolved-comment-count="0" data-linked-resource-id="20874014" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="brokerage.jpg" data-base-url="https://cwiki.apache.org/confluence" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="20645282" data-linked-resource-container-version="5"></span><br clear="none">首先，用户访问“登录”页面。用户从“登录”页面输入用户名和密码。如果用户名或密码无效，则应用程序将引发错误消息并拒绝用户的登录尝试。如果用户名和密码正确，则该用户将被带到“可用库存”页面，在该页面上他/她可以查看当时所有待售的库存。<br clear="none">通过单击“购买”按钮，用户可以根据帐户中的可用资金选择购买所需数量的股票。交易成功完成后，用户将被带回到“可用库存”页面，在该页面他/她可以根据需要购买更多股票。如果用户资金不足以购买股票，则应用程序将引发错误，并且不会处理交易。错误消息显示在“可用库存”页面的顶部。此页面上有一个“用户信息”按钮。通过单击此按钮，用户将被带到“用户信息”页面并显示用户详细信息。<br clear="none">在“可用股票”页面上，有一个“查看您的投资组合”链接，显示用户拥有的所有股票。在该页面中，用户可以选择要出售的库存和数量。此页面还在“用户现金”字段中显示用户的可用现金。如果用户尝试出售多于自己的库存，则应用程序将引发错误。错误消息将显示在同一页面上。对于每次成功的销售，将销售金额添加到用户的现金余额中。数量文本框显示用户拥有的特定公司的股票数量。“要出售的数量”字段允许用户输入要出售给特定公司的库存数量。对于买卖，应检查单选按钮。输入值后应执行此操作。如果未填满要售数量文本框或未选中选择框，然后按销售，则将触发JavaScript警报，提示必填字段为空。输入非数字字符表示数量时，将触发另一个警报。对于“可用库存”页面，此行为也类似。<br clear="none">新用户可以通过单击登录页面中的“注册”按钮进行注册。在“注册”页面中，用户将输入用户ID，用户名，密码，地址和可用现金。<br clear="none">
<a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>
<h2 id="JBosstoGeronimo-HibernateMigration-ApplicationclassesandJSPpages">应用程序类和JSP页面</h2>

<p>Online Brokerage示例应用程序包含以下软件包：</p>
<ul><li>com.dev.trade.bo<ul><li>库存-代表公司的库存。</li><li>用户-代表用户。</li><li>UserStock-代表用户拥有的库存。</li></ul>
	</li></ul>


<ul><li>com.dev.trade.dao<ul><li>TradeDAO-包含所有数据库访问方法。</li></ul>
	</li></ul>


<ul><li>com.dev.trade.exception<ul><li>DBException-为所有数据库异常引发的定制异常类。</li></ul>
	</li></ul>


<ul><li>com.dev.trade.servlet<ul><li>TradeDispatcherServlet-执行所需的数据库功能后，将所有请求分派到JSP。</li></ul>
	</li></ul>


<p>在线经纪业务还包括以下JSP页面：</p>
<ul><li>login.jsp-应用程序的登录页面。</li><li>error.jsp-应用程序的默认错误页面。</li><li>register.jsp-用户注册页面。</li><li>stocks.jsp-用户可以从中购买股票的“可用股票”页面。</li><li>userstocks.jsp-用户投资组合页面，显示用户的股票。用户可以从该页面出售股票。</li></ul>


<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Toolsused">使用的工具</h2>

<p>用于开发和构建示例应用程序的工具是：</p>

<h3 id="JBosstoGeronimo-HibernateMigration-ApacheAnt">阿帕奇蚂蚁</h3>

<p>Ant是一个纯Java构建工具。它用于构建war文件并为Online Brokerage应用程序填充数据库。可以从以下URL下载Ant：</p>

<p><a shape="rect" class="external-link" href="http://ant.apache.org">http://ant.apache.org</a></p>

<h3 id="JBosstoGeronimo-HibernateMigration-Hibernate">冬眠</h3>

<p>在撰写本文时，Hibernate 4.1是可用的最新版本，可以从以下URL下载：<br clear="none">
<a shape="rect" class="external-link" href="http://www.hibernate.org" rel="nofollow">http://www.hibernate.org</a></p>

<p>可以在以下URL上找到有关Hibernate的其他文档：<br clear="none">
<a shape="rect" class="external-link" href="http://www.hibernate.org/docs" rel="nofollow">http://www.hibernate.org/docs</a></p>

<p>下载并安装Hibernate，安装目录以后将称为<strong><hibernate_home></hibernate_home></strong> 。</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Sampledatabase">样本数据库</h2>

<p>用于演示此应用程序的数据库是MySQL。示例数据库名称为<strong>adi</strong> ，由以下三个表STOCKS，USERS和USERSTOCKS组成。这些表中的每个字段的说明如下。</p>
<div class="table-wrap"><table class="confluenceTable"><tbody><tr><th colspan="1" rowspan="1" class="confluenceTh"><p>表名</p></th><th colspan="1" rowspan="1" class="confluenceTh"><p>领域</p></th></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p>股票</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>ID（主键）<br class="atl-forced-newline" clear="none">名称<br class="atl-forced-newline" clear="none">价钱</p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p>用户</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>USERID（主密钥）<br class="atl-forced-newline" clear="none">名称<br class="atl-forced-newline" clear="none">密码<br class="atl-forced-newline" clear="none">地址<br class="atl-forced-newline" clear="none">现金</p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p>用户库存</p></td><td colspan="1" rowspan="1" class="confluenceTd"><p>ID（主键）<br class="atl-forced-newline" clear="none">USERID（主密钥）<br class="atl-forced-newline" clear="none">名称<br class="atl-forced-newline" clear="none">价钱<br class="atl-forced-newline" clear="none">数量</p></td></tr></tbody></table></div>

<p>USERSTOCKS表用于存储每个用户拥有的股票。USERS和STOCKS表用于存储用户和库存详细信息。因为这只是一个示例应用程序，所以在用户注册期间，用户自己输入了用户所拥有的金额。</p>

<p>用于填充此数据库的DDL文件是<strong>db.sql</strong> ，它位于<brokerage_home>\ sql目录中。</brokerage_home></p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h1 id="JBosstoGeronimo-HibernateMigration-TheJBossenvironmentJBoss">JBoss环境<span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-JBoss"></span></h1>

<p>本节向您展示示例JBoss参考环境的安装方式和安装位置，以便您可以将这种情况映射到您自己的实现中。</p>

<p>产品文档中提供了有关安装，配置和管理JBoss的详细说明。在产品网站上查看最新文档。</p>

<p>以下列表突出显示了您需要完成的常规任务，以安装和配置<br clear="none">初始环境作为部署示例应用程序的起点。</p>
<ol><li>按照产品文档指南中的说明下载并安装JBoss v7.0。从现在开始<br clear="none">安装目录将称为<strong><jboss_home></jboss_home></strong></li><li>创建默认的JBoss v7.0应用程序服务器的副本。将<strong><jboss_home>\ server \ default</jboss_home></strong>递归复制到<strong><jboss_home>\ server \<your_server_name></your_server_name></jboss_home></strong></li><li>通过运行以下命令启动新服务器<code><strong>run.sh -c <your_server_name></strong></code> <strong><jboss_home>\ bin</jboss_home></strong>目录中的命令。</li><li>服务器启动后，可以通过打开Web浏览器并将其指向以下URL来验证它是否正在运行： <a shape="rect" class="external-link" href="http://localhost:8080" rel="nofollow">http：// localhost：8080</a> 。您应该看到JBoss Welcome窗口，并且能够访问JBoss控制台。</li><li>一旦应用程序服务器启动并运行，下一步就是安装和配置示例应用程序所需的所有其余必备软件。下一节将介绍此步骤。</li></ol>


<h2 id="JBosstoGeronimo-HibernateMigration-Installandconfigureprerequisitesoftware">安装和配置必备软件</h2>

<p>为了构建和运行本文中包含的Library应用程序，您需要安装和配置构建工具以及该应用程序使用的数据库。</p>

<h3 id="JBosstoGeronimo-HibernateMigration-Installthedatabase">安装数据库</h3>

<p>如本文前面所述，此应用程序正在使用可从以下URL下载的MySQL数据库：</p>

<p><a shape="rect" class="external-link" href="http://www.mysql.com" rel="nofollow">http://www.mysql.com</a></p>

<p>注意：根据您的MySQL版本，还应该下载适当版本的MySQL Connector / J（3.1、5.0或5.1）。</p>

<p>该MySQL连接器也必须放在<jboss_home>/ server / default / lib中。</jboss_home></p>

<p>MySQL的安装和配置非常直观，并且在以下URL的《 MySQL参考手册》中有详细记录：</p>

<p><a shape="rect" class="external-link" href="http://dev.mysql.com/doc/mysql/en" rel="nofollow">http://dev.mysql.com/doc/mysql/zh</a></p>

<p><strong>注意：</strong>在实例配置期间，我修改了安全设置，并指定“密码”作为root用户的密码。此用户ID和密码以后将用于从示例应用程序访问数据库。</p>

<h3 id="JBosstoGeronimo-HibernateMigration-Createsampledatabase">创建样本数据库</h3>

<p>配置完MySQL实例后，您需要创建将由Library应用程序使用的示例数据库。在命令行中，键入以下命令以启动MySQL监视器：</p>

<p><code><strong>mysql -u root -ppassword</strong></code></p>

<p>请注意，标志-p和密码之间没有空格。</p>

<p>这将打开MySQL命令界面，如以下示例所示：</p>
<div class="preformatted panel" style="border-style:solid;border-width:1px"><div class="preformattedHeader panelHeader" style="border-bottom-width:1px;border-bottom-style:solid"><b>MySQL监视器界面</b></div><div class="preformattedContent panelContent">
<pre>Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 7 to server version: 4.1.14-nt

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql&gt;
</pre>
</div></div>
<p>在MySQL命令界面中，通过键入以下命令来创建<strong>adi</strong>示例数据库：</p>

<p><code><strong>mysql> create database adi;</strong></code></p>

<h3 id="JBosstoGeronimo-HibernateMigration-ConfigureAnt">配置蚂蚁</h3>

<p>如前所述，Apache Ant用于构建Online Brokerage应用程序的二进制文件。如果您没有安装Ant，那么这是个不错的时机，并确保将<strong><ant_home>\ bin</ant_home></strong>目录添加到系统的path变量中。</p>

<p>可以从以下URL下载Apache Ant：</p>

<p><a shape="rect" class="external-link" href="http://ant.apache.org">http://ant.apache.org</a></p>

<h3 id="JBosstoGeronimo-HibernateMigration-ConfigureHibernate">配置休眠</h3>

<p>JBoss与Hibernate捆绑在一起，因此无需为Hibernate下载单独的jar。</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Buildthesampleapplication">构建示例应用程序</h2>

<p>本文随附的Online Brokerage应用程序提供了一个Ant脚本，您可以使用该脚本来构建该应用程序并填充数据库。通过浏览<a shape="rect" href="jboss-to-geronimo-hibernate-migration.data/brokerage.zip?version=1&modificationDate=1204180993000&api=v2" data-linked-resource-id="20874015" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="brokerage.zip" data-nice-type="Zip Archive" data-linked-resource-content-type="application/zip" data-linked-resource-container-id="20645282" data-linked-resource-container-version="5">Online Brokerage</a>下载示例应用程序。</p>

<p>解压缩zip文件后，将创建一个经纪人目录，在本文的其余部分中，我们将该目录称为<strong><brokerage_home></brokerage_home></strong> 。在该目录中，打开<strong>build.properties</strong>文件，然后编辑属性以匹配您的环境，如以下示例所示：</p>
<div class="preformatted panel" style="border-style:solid;border-width:1px"><div class="preformattedHeader panelHeader" style="border-bottom-width:1px;border-bottom-style:solid"><b>build.properties</b></div><div class="preformattedContent panelContent">
<pre>#Replace java.home with your jdk directory
java.home=&lt;java_home&gt;

#Replace jboss.home with the parent directory of lib/j2ee.jar
jboss.home=&lt;jboss_home&gt;/server/&lt;your_server_name&gt;

#Replace geronimo.home with the geronimo home directory.
geronimo.home=&lt;geronimo_home&gt;

#Fully qualified name of the JDBC driver class
db.driver=com.mysql.jdbc.Driver

#database url
db.url=jdbc:mysql://localhost:3306/adi

#database userId
db.userid=root

#database password
db.password=password

#script file for creating the tables
sql.file=sql/db.sql

#location of the jdbc driver jar.
driver.classpath=&lt;mysql-connector_home&gt;/mysql-connector-java-3.1.14-bin.jar

#location of the hibernate jars.
dependency.dir=&lt;hibernate_home&gt;/lib
</pre>
</div></div>
<p>请注意，Hibernate jars的路径由<code><strong>dependency.dir</strong></code> Geronimo必需使用标记，JBoss随附了它自己的Hibernate副本。仍然需要将位于目录中的<strong>hibernate3.jar</strong>文件复制到该目录。 <strong><hibernate_home></hibernate_home></strong>目录。</p>
<div class="confluence-information-macro confluence-information-macro-note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p><strong>要点：</strong>在此文件中指定路径时，请确保使用正斜杠“ <strong>/</strong> ”，否则会出现编译错误。</p></div></div>
<p>从命令提示符或Shell更改目录到<brokerage_home>并运行<strong>ant</strong>命令。这将建立war，har和ear文件，并将它们放置在<strong><brokerage_home>\ jboss-artefact</brokerage_home></strong>目录中。由<strong>ant</strong>构建引起的战争在WAR的WEB-INF目录中包含一个JBoss特定的部署描述符<strong>jboss-web.xml</strong>文件。 HAR在META-INF目录中包含特定于JBoss的<strong>hibernate-service.xml</strong>文件，而EAR包含特定于JBoss的部署描述符<strong>jboss-app.xml</strong> 。这些文件如下所示。</brokerage_home></p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>jboss-web.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;jboss-web&gt;
  &lt;context-root&gt;/brokerage&lt;/context-root&gt;
  &lt;resource-ref&gt;
      &lt;res-ref-name&gt;jdbc/HibernateDB&lt;/res-ref-name&gt;
      &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
      &lt;jndi-name&gt;jdbc/HibernateDS&lt;/jndi-name&gt;
  &lt;/resource-ref&gt;
&lt;/jboss-web&gt;
]]></script>
</div></div>
<p>resource-ref元素用于将web.xml文件中名称为<strong>jdbc / HibernateDB</strong>引用的资源映射到JNDI名称为<strong>java：jdbc /</strong> <strong>HibernateDS的资源</strong> ，例如MySQL数据源。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>hibernate-service.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;server&gt;
    &lt;mbean code=&quot;org.jboss.hibernate.jmx.Hibernate&quot;
           name=&quot;jboss.har:service=Hibernate&quot;&gt;
        &lt;attribute name=&quot;DatasourceName&quot;&gt;java:jdbc/HibernateDS&lt;/attribute&gt;

        &lt;attribute name=&quot;Dialect&quot;&gt;
            org.hibernate.dialect.MySQLDialect
        &lt;/attribute&gt;
        &lt;attribute name=&quot;SessionFactoryName&quot;&gt;
            java:/hibernate/BrokerageSessionFactory
        &lt;/attribute&gt;
        &lt;attribute name=&quot;CacheProviderClass&quot;&gt;
            org.hibernate.cache.HashtableCacheProvider
        &lt;/attribute&gt;
         &lt;!-- &lt;attribute name=&quot;ScanForMappingsEnabled&quot;&gt;true&lt;/attribute&gt; --&gt;
        &lt;attribute name=&quot;ShowSqlEnabled&quot;&gt;true&lt;/attribute&gt;
    &lt;/mbean&gt;
&lt;/server&gt;
]]></script>
</div></div>
<p>该文件包含需要设置的休眠属性。属性名称及其功能为：</p>
<ul><li><strong>DatasourceName</strong> -Hibernate应该使用的数据源的JNDI名称。</li><li><strong>方言</strong> -应该使用的SQL方言。</li><li><strong>SessionFactoryName-</strong>会话工厂应绑定到的JNDI名称。</li><li><strong>CacheProviderClass-</strong>缓存提供程序的类</li><li><strong>ShowSqlEnabled-</strong>在输出中显示执行的SQL语句。</li></ul>


<p><strong>hibernate-service.xml</strong>文件应该位于EAR的META-INF目录中。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>jboss-app.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;!DOCTYPE jboss-app PUBLIC &quot;-//JBoss//DTD J2EE Application 1.4//EN&quot; &quot;http://www.jboss.org/j2ee/dtd/jboss-app_4_0.dtd&quot;&gt;
&lt;jboss-app&gt;
    &lt;module&gt;
        &lt;har&gt;brokerage.har&lt;/har&gt;
    &lt;/module&gt;
&lt;/jboss-app&gt;
]]></script>
</div></div>
<p>EAR的META-INF目录中的<strong>jboss-app.xml</strong>文件指定EAR中存在的har文件的名称。</p>

<p>以下示例显示了此应用程序中使用的部署描述符<strong>web.xml</strong> 。位于以下位置的WEB-INF目录中的<strong>web.xml</strong>文件： <code><strong>brokerage.war</strong></code>是部署描述符，您可以在其中指定应用程序的servlet名称和默认JSP。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>web.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app xmlns=&quot;http://java.sun.com/xml/ns/j2ee&quot; version=&quot;2.4&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&quot;&gt;
    &lt;display-name&gt;brokerage&lt;/display-name&gt;
    &lt;servlet&gt;
        &lt;display-name&gt;Trade-Dispatcher&lt;/display-name&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.dev.trade.servlet.TradeDispatcherServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/login&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/stocks&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/userstocks&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/buy&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/sell&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/register&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;welcome-file-list&gt;
  &lt;welcome-file&gt;/login.jsp&lt;/welcome-file&gt;
    &lt;/welcome-file-list&gt;
    &lt;error-page&gt;
     &lt;exception-type&gt;javax.servlet.ServletException&lt;/exception-type&gt;
     &lt;location&gt;/error.jsp&lt;/location&gt;
    &lt;/error-page&gt;

    &lt;resource-ref&gt;
        &lt;res-ref-name&gt;jdbc/HibernateDB&lt;/res-ref-name&gt;
        &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
        &lt;res-auth&gt;Container&lt;/res-auth&gt;
        &lt;res-sharing-scope&gt;Shareable&lt;/res-sharing-scope&gt;
    &lt;/resource-ref&gt;
&lt;/web-app&gt;
]]></script>
</div></div>
<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Populatesampledata">填充样本数据</h2>

<p>如前所述，提供了<strong>db.sql</strong>脚本来填充样本数据。该文件的位置已经在<strong>build.properties中</strong>由标记<strong>sql.file定义</strong> 。要填充示例数据，只需从<strong><brokerage_home></brokerage_home></strong>目录。</p>

<p><code><strong>ant populateDB</strong></code></p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Deploythesampleapplication">部署样本应用程序</h2>

<p>在部署示例应用程序之前，您需要配置此应用程序所需的数据源。要在JBoss中部署数据源配置，请将<strong><brokerage_home>\ plan</brokerage_home></strong>目录中的<strong>mysql-ds.xml</strong>文件复制到以下目录：</p>

<p><code><strong><jboss_home>\server\<your_server_name>\deploy</strong></code></p>

<p>与数据库部署类似，要在JBoss中部署Online Brokerage应用程序，请将刚用Ant构建的<strong>brokerage.ear</strong>文件复制到以下目录：</p>

<p><code><strong><jboss_home>\server\<your_server_name>\deploy</strong></code></p>

<p>如果JBoss已经启动，它将自动部署并启动应用程序；否则，该应用程序将被部署并在下次启动时启动。</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Testthesampleapplication">测试示例应用程序</h2>

<p>要测试该应用程序，请打开Web浏览器并访问以下URL：</p>

<p><a shape="rect" class="external-link" href="http://localhost:8080/brokerage" rel="nofollow">http：// localhost：8080 / brokerage</a></p>

<p>这将打开Online Brokerage应用程序的登录屏幕。输入j2ee作为用户名，输入password作为密码，然后单击login。这将带您到下图所示的可用库存页面。现在，该应用程序已配置并正在运行。<span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" src="jboss-to-geronimo-hibernate-migration.data/available.jpg" data-image-src="/confluence/download/attachments/20645282/available.jpg?version=1&modificationDate=1204180993000&api=v2" data-unresolved-comment-count="0" data-linked-resource-id="20874016" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="available.jpg" data-base-url="https://cwiki.apache.org/confluence" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="20645282" data-linked-resource-container-version="5"></span><br clear="none">
<a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>
<h1 id="JBosstoGeronimo-HibernateMigration-TheGeronimoenvironmentGeronimo">Geronimo环境<span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-Geronimo"></span></h1>

<p>从以下URL下载并安装Geronimo：</p>

<p><a shape="rect" class="external-link" href="http://geronimo.apache.org/downloads.html">http://geronimo.apache.org/downloads.html</a></p>

<p>那里提供的发行说明提供了有关系统要求以及如何安装和启动Geronimo的明确说明。在本文的其余部分中，我们将Geronimo安装目录称为<strong><geronimo_home></geronimo_home></strong> 。</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-ConfigureResources">配置资源</h2>

<p>为了在Geronimo中运行Online Brokerage应用程序，您将使用与JBoss一起使用的相同MySQL数据库。因此，要准备Geronimo环境，您需要做的第一个任务是配置数据源。</p>

<h3 id="JBosstoGeronimo-HibernateMigration-Configurethedatasource">配置数据源</h3>

<p>您需要将MySQL数据库驱动程序复制到Geronimo存储库中，以便可以在数据源部署计划中引用它。Geronimo存储库位于<strong><geronimo_home>/ repository</geronimo_home></strong>目录中。在此目录中，创建一个名为<strong>mysql / jars</strong>的新目录，并将<strong>mysql-connector-java-3.1.14-bin.jar</strong>文件复制到其中。</p>

<p>现在，您需要定义一个数据源部署计划。为了您的方便，示例应用程序已经在<strong><brokerage_home>\ plan</brokerage_home></strong>目录中提供了名为<strong>mysql-geronimo-plan.xml</strong>的部署计划。以下示例显示了此部署计划的内容。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>mysql-geronimo-plan.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;connector xmlns=&quot;http://geronimo.apache.org/xml/ns/j2ee/connector-1.2&quot;&gt;
  &lt;dep:environment xmlns:dep=&quot;http://geronimo.apache.org/xml/ns/deployment-1.1&quot;&gt;
    &lt;dep:moduleId&gt;
	  &lt;dep:groupId&gt;user&lt;/dep:groupId&gt;
	  &lt;dep:artifactId&gt;database-pool-HibernateDB&lt;/dep:artifactId&gt;
	  &lt;dep:version&gt;2.0&lt;/dep:version&gt;
	  &lt;dep:type&gt;car&lt;/dep:type&gt;
	&lt;/dep:moduleId&gt;
	&lt;dep:dependencies&gt;
	  &lt;dep:dependency
	    &lt;dep:groupId&gt;mysql&lt;/dep:groupId&gt;
		&lt;dep:artifactId&gt;mysql-connector-java&lt;/dep:artifactId&gt;
		&lt;dep:version&gt;3.1.14-bin&lt;/dep:version&gt;
		&lt;dep:type&gt;jar&lt;/dep:type&gt;
	  &lt;/dep:dependency&gt;
	&lt;/dep:dependencies&gt;
  &lt;/dep:environment&gt;
  &lt;resourceadapter&gt;
    &lt;outbound-resourceadapter&gt;
      &lt;connection-definition&gt;
        &lt;connectionfactory-interface&gt;javax.sql.DataSource&lt;/connectionfactory-interface&gt;
        &lt;connectiondefinition-instance&gt;
          &lt;name&gt;HibernateDS&lt;/name&gt;
          &lt;config-property-setting name=&quot;Password&quot;&gt;password&lt;/config-property-setting&gt;
          &lt;config-property-setting name=&quot;CommitBeforeAutocommit&quot;&gt;false&lt;/config-property-setting&gt;
          &lt;config-property-setting name=&quot;Driver&quot;&gt;com.mysql.jdbc.Driver&lt;/config-property-setting&gt;
          &lt;config-property-setting name=&quot;ExceptionSorterClass&quot;&gt;org.tranql.connector.AllExceptionsAreFatalSorter&lt;/config-property-setting&gt;
          &lt;config-property-setting name=&quot;UserName&quot;&gt;root&lt;/config-property-setting&gt;
          &lt;config-property-setting name=&quot;ConnectionURL&quot;&gt;jdbc:mysql://localhost:3306/adi&lt;/config-property-setting&gt;
          &lt;connectionmanager&gt;
            &lt;local-transaction/&gt;
            &lt;single-pool&gt;
              &lt;max-size&gt;10&lt;/max-size&gt;
              &lt;min-size&gt;0&lt;/min-size&gt;
              &lt;blocking-timeout-milliseconds&gt;5000&lt;/blocking-timeout-milliseconds&gt;
              &lt;idle-timeout-minutes&gt;30&lt;/idle-timeout-minutes&gt;
              &lt;match-one/&gt;
            &lt;/single-pool&gt;
          &lt;/connectionmanager&gt;
        &lt;/connectiondefinition-instance&gt;
      &lt;/connection-definition&gt;
    &lt;/outbound-resourceadapter&gt;
  &lt;/resourceadapter&gt;
&lt;/connector&gt;
]]></script>
</div></div>
<p>现在您已经有了部署计划并复制了驱动程序，下一步是手动部署数据源连接池。如果尚未启动Geronimo，请通过运行以下命令来启动：</p>

<p><code><strong><geronimo_home>\bin\geronimo start</strong></code></p>

<p>要部署数据源连接池，请运行以下命令：</p>

<p><code><strong><geronimo_home>\bin\deploy --user system --password manager deploy <brokerage_home>\plan\mysql-geronimo-plan.xml ..\repository\org\tranql\tranql-connector-ra\1.3\tranql-connector-ra-1.3.rar</strong></code></p>

<p>根据您的环境，您应该看到类似于以下内容的确认消息：</p>
<div class="preformatted panel" style="background-color:#ffffff;border-style:solid;border-width:1px"><div class="preformattedContent panelContent" style="background-color:#ffffff">
<pre>C:\geronimo-3.0\bin&gt;deploy --user system --password manager deploy \brokerage\plan\mysql-geronimo-plan.xml
..\repository\org\tranql\tranql-connector-ra\1.3\tranql-connector-ra-1.3.rar
    Deployed user/database-pool-HibernateDS/2.0/car
</pre>
</div></div>
<p><span style="color:white"> </span></p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h1 id="JBosstoGeronimo-HibernateMigration-Step-by-stepmigrationmigration">分步迁移<span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-migration"></span></h1>

<p>Apache Geronimo不支持HAR存档，因此我们将所有类都包含在WAR存档中。我们需要编写两个类来使应用程序在Geronimo上运行。一个是Geronimo的TransactionManagerLookup类，另一个是用于获取SessionFactory的实用程序类HibernateUtil。除此之外，我们将需要对TradeDispatcherServlet和TradeDAO类进行一些更改。</p>

<p>第一步，我们将看到需要对应用程序进行的更改，如下表所示。</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-TradeDAO">#TradeDAO</a><br clear="none">
<a shape="rect" href="#JBosstoGeronimo-HibernateMigration-HibernateUtil">#HibernateUtil</a><br clear="none">
<a shape="rect" href="#JBosstoGeronimo-HibernateMigration-TradeDispatcherServlet">#TradeDispatcherServlet</a></p>

<h3 id="JBosstoGeronimo-HibernateMigration-TradeDAOTradeDAO">贸易署<span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-TradeDAO"></span></h3>

<p>在JBoss中，HibernateMBean将创建SessionFactory并将其绑定到全局JNDI上下文。因此，我们可以通过简单的查找来获取SessionFactory。然后，我们可以从SessionFactory获取会话。</p>

<p><code>TradeDAO.java</code>位于<code><brokerage_home>/src/com/dev/trade/dao</code>目录。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>JBoss的TradeDAO.java摘录</b></div><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
package com.dev.trade.dao;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Set;

import javax.naming.InitialContext;
import javax.naming.NamingException;

import org.hibernate.Query;
import org.hibernate.Session;
import org.hibernate.SessionFactory;

import com.dev.trade.bo.Stock;
import com.dev.trade.bo.User;
import com.dev.trade.bo.UserStock;
import com.dev.trade.exception.DBException;
import com.dev.trade.util.HibernateUtil;

public class TradeDAO {

	SessionFactory factory  = null;
	Session session = null;

	public TradeDAO() throws Exception {

		try {
			InitialContext ctx = new InitialContext();
		    factory  = (SessionFactory)ctx.lookup(&quot;java:hibernate/BrokerageSessionFactory&quot;);

		} catch (NamingException e1) {
			// TODO Auto-generated catch block
			e1.printStackTrace();
		}
	}

	public User getUserByUserId(String userId) throws DBException {

		session = factory.getCurrentSession();
		Query q = session.createQuery(&quot;from User u where u.userId=:userId&quot;);
		q.setString(&quot;userId&quot;, userId);
		return (User) q.uniqueResult();

	}
	...
]]></script>
</div></div>
<p>在Geronimo中，我们将编写一个新的实用程序类来创建SessionFactory，该类将是HibernateUtil类。它具有方法getCurrentSession（），它将返回会话。</p>

<p>修改的第一部分<code>TradeDAO.java</code>以匹配以下摘录中的更改。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>来自Geronimo的TradeDAO.java摘录</b></div><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
package com.dev.trade.dao;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Set;

import org.hibernate.Query;
import org.hibernate.Session;

import com.dev.trade.bo.Stock;
import com.dev.trade.bo.User;
import com.dev.trade.bo.UserStock;
import com.dev.trade.exception.DBException;
import com.dev.trade.util.HibernateUtil;

public class TradeDAO {


      Session session = null;

       public TradeDAO() throws Exception {

        }

       public User getUserByUserId(String userId) throws DBException {

            session = HibernateUtil.getCurrentSession();
                Query q = session.createQuery(&quot;from User u where u.userId=:userId&quot;);
                q.setString(&quot;userId&quot;, userId);
              return (User) q.uniqueResult();

       }
       ...
]]></script>
</div></div>
<p>搜索并替换，查找以下字符串：</p>

<p><code><strong>factory.getCurrentSession()</strong></code></p>

<p>并替换为</p>

<p><code><strong>HibernateUtil.getCurrentSession()</strong></code></p>

<p><em>您应该算上9个替补。</em></p>

<p>获取会话的差异将是代码库中要在Apache Geronimo中运行的应用程序的主要变化。</p>

<h3 id="JBosstoGeronimo-HibernateMigration-HibernateUtilHibernateUtil">HibernateUtil<span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-HibernateUtil"></span></h3>

<p>如上所述，我们将使用此类创建SessionFactory并为应用程序提供Hibernate会话。该类的源代码如下</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>用于Geronimo的HibernateUtil.java</b></div><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
package com.dev.trade.util;

import org.hibernate.HibernateException;
import org.hibernate.Session;
import org.hibernate.cfg.Configuration;

/**
 * Configures and provides access to Hibernate sessions, tied to the
 * current thread of execution.  Follows the Thread Local Session
 * pattern, see {@link http://hibernate.org/42.html}.
 */
public class HibernateUtil {

    /** location of the Hibernate Configuration File */
    private static String CONFIG_FILE_LOCATION = &quot;hibernate.cfg.xml&quot;;

    /** Holds a single instance of Session */
    private static final ThreadLocal threadLocal = new ThreadLocal();

    /** The single instance of hibernate configuration */
    private static final Configuration cfg = new Configuration();

    /** The single instance of hibernate SessionFactory */
    private static org.hibernate.SessionFactory sessionFactory;

    /**
     * Returns the ThreadLocal Session instance.  Lazy initialize
     * the &lt;code&gt;SessionFactory&lt;/code&gt; if needed.
     *
     *  @return Session
     *  @throws HibernateException
     */
    public static Session getCurrentSession() throws HibernateException {
        Session session = (Session) threadLocal.get();

        if (session == null || ! session.isConnected()) {
            if (sessionFactory == null) {
                try {
                    cfg.configure(CONFIG_FILE_LOCATION);
                    sessionFactory = cfg.buildSessionFactory();
                }
                catch (Exception e) {
                    System.err.println(&quot;%%%% Error Creating SessionFactory %%%%&quot;);
                    e.printStackTrace();
                }
            }
            session = sessionFactory.openSession();
            threadLocal.set(session);
        }

        return session;
    }

    /**
     *  Close the single hibernate session instance.
     *
     *  @throws HibernateException
     */
    public static void closeSession() throws HibernateException {
        Session session = (Session) threadLocal.get();


        if (session != null) {
            session.close();
        }
    }



}
]]></script>
</div></div>
<p><code>HibernateUtil.java</code>位于<code><brokerage_home>/src/com/dev/trade/util</code>目录。为了您的方便，示例应用程序已经提供了此文件的副本。</p>

<h3 id="JBosstoGeronimo-HibernateMigration-TradeDispatcherServletTradeDispatcherServlet">TradeDispatcherServlet<span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-TradeDispatcherServlet"></span></h3>

<p>在此类中，获取SessionFactory也将有所不同。在JBoss中，我们从JNDI Context中获得它，但在Geronimo中，我们将通过实用程序类获得它。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>JBoss的doGet方法</b></div><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
protected void doGet(HttpServletRequest request,
   HttpServletResponse response) throws ServletException, IOException {

   Session hsession = null;
   try {
         InitialContext ctx = new InitialContext();
         SessionFactory factory  =  (SessionFactory)ctx.lookup(&quot;java:hibernate/BrokerageSessionFactory&quot;);
         hsession = factory.openSession();
       } catch (NamingException e1) {
            e1.printStackTrace();
       }

    Transaction tr = hsession.beginTransaction();
]]></script>
</div></div>
<p><code>TradeDispatcherServlet.java</code>位于<code><brokerage_home>/src/com/dev/trade/servlet</code>目录。将doGet方法替换为以下示例中所示的方法。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>Geronimo的doGet方法</b></div><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
protected void doGet(HttpServletRequest request,
    HttpServletResponse response) throws ServletException, IOException {

    Transaction tr = HibernateUtil.getCurrentSession().getTransaction();
    tr.begin();
]]></script>
</div></div>
<p>Hibernate附带了许多应用程序服务器的事务管理器查找类。不幸的是，Hibernate 3.2没有特定于Apache Geronimo的查找类，因此我们需要编写自己的查找类。以下示例显示了Geronimo特定事务管理器查找的代码。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>GeronimoTransactionManagerLookup</b></div><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
package org.hibernate.transaction;

import java.util.Iterator;
import java.util.Properties;
import java.util.Set;

import javax.transaction.TransactionManager;
import org.hibernate.HibernateException;
import org.hibernate.transaction.TransactionManagerLookup;

import org.apache.geronimo.gbean.AbstractName;
import org.apache.geronimo.gbean.AbstractNameQuery;
import org.apache.geronimo.kernel.Kernel;
import org.apache.geronimo.kernel.KernelRegistry;
import org.apache.geronimo.kernel.proxy.ProxyManager;

public class GeronimoTransactionManagerLookup implements
        TransactionManagerLookup {

    public static final String UserTransactionName = &quot;java:comp/UserTransaction&quot;;

    public Object getTransactionIdentifier(Transaction arg0) {
		return null;
    }

    public TransactionManager getTransactionManager(Properties props) throws HibernateException {
       /*
         * try { Kernel kernel = KernelRegistry.getSingleKernel(); ProxyManager
         * proxyManager = kernel.getProxyManager(); AbstractNameQuery query =
         * new AbstractNameQuery(TransactionManager.class.getName()); Set names =
         * kernel.listGBeans(query); AbstractName name = null; for (Iterator it =
         * names.iterator(); it.hasNext();) name = (AbstractName) it.next();
         * Object transMg = (Object) proxyManager.createProxy(name,
         * TransactionManager.class); return (TransactionManager)transMg; }catch
         * (Exception e) { e.printStackTrace(); System.out.println(); throw new
         * HibernateException(&quot;Geronimo Transaction Manager Lookup Failed&quot;, e); }
         */
       try {
       Kernel kernel = KernelRegistry.getSingleKernel();
       AbstractNameQuery query = new AbstractNameQuery(TransactionManager.class.getName ());
       Set&lt;AbstractName&gt; names = kernel.listGBeans(query);
       if (names.size() != 1) {
           throw new IllegalStateException(&quot;Expected one transaction manager, not &quot; + names.size());
       }
       AbstractName name = names.iterator().next();
       TransactionManager transMg = (TransactionManager)
       kernel.getGBean(name);
       return (TransactionManager)transMg;
       } catch (Exception e) {
           e.printStackTrace();
           System.out.println();
           throw new HibernateException(&quot;Geronimo Transaction Manager Lookup Failed&quot;, e);
       }
   }

    public String getUserTransactionName() {
        return UserTransactionName;
    }
}
]]></script>
</div></div>
<p>为方便起见，该课程已在<code><brokerage_home>/TransactionManager</code>目录。创建以下目录结构并复制<code>GeronimoTransactionManagerLookup.java</code>那里。</p>

<p>*<code>brokerage_home>/src/org/hibernate/transaction</code></p>

<p>现在，您需要创建休眠配置文件hibernate-cfg.xml。在此文件中，您将指定所需的休眠配置属性。请注意<code>hibernate-service.xml</code>在JBoss中是做同样的事情。为了您的方便，此文件还随示例应用程序一起提供。 <code><brokerage_home>/hibrenate</code>目录。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>hibernate-cfg.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39;?&gt;
&lt;!DOCTYPE hibernate-configuration PUBLIC
        &quot;-//Hibernate/Hibernate Configuration DTD 3.0//EN&quot;
        &quot;http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd&quot;&gt;

&lt;hibernate-configuration&gt;
 &lt;session-factory&gt;
 &lt;!-- properties --&gt;
 &lt;property name=&quot;connection.datasource&quot;&gt;java:comp/env/jdbc/HibernateDB&lt;/property&gt;
 &lt;property name=&quot;hibernate.transaction.manager_lookup_class&quot;&gt;
    org.hibernate.transaction.GeronimoTransactionManagerLookup
 &lt;/property&gt;

  &lt;property name=&quot;hibernate.dialect&quot;&gt;org.hibernate.dialect.MySQLDialect&lt;/property&gt;

 &lt;!-- Disable the second-level cache  --&gt;
&lt;property name=&quot;hibernate.cache.provider_class&quot;&gt;org.hibernate.cache.NoCacheProvider&lt;/property&gt;
&lt;property name=&quot;hibernate.current_session_context_class&quot;&gt;org.hibernate.context.JTASessionContext&lt;/property&gt;
 &lt;!-- Echo all executed SQL to stdout --&gt;
 &lt;property name=&quot;hibernate.show_sql&quot;&gt;true&lt;/property&gt;

 &lt;!-- Drop and re-create the database schema on startup --&gt;
&lt;!--&lt;property name=&quot;hibernate.hbm2ddl.auto&quot;&gt;create&lt;/property&gt; --&gt;

 &lt;!-- mapping files --&gt;
 &lt;mapping resource=&quot;Stock.hbm.xml&quot;/&gt;
 &lt;mapping resource=&quot;UserStock.hbm.xml&quot;/&gt;
 &lt;mapping resource=&quot;User.hbm.xml&quot;/&gt;

 &lt;/session-factory&gt;
&lt;/hibernate-configuration&gt;
]]></script>
</div></div>
<p>有关每个属性的特定功能的其他详细信息，请参见休眠手册。</p>

<p>构建之前的最后一步是创建<strong>geronimo-web.xml</strong>文件，该文件是Geronimo特定的部署描述符，如以下示例所示。再次，为方便起见，此文件还随示例应用程序一起提供在<code><brokerage_home>/web/descriptors/geronimo</code>目录。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>geronimo-web.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;
&lt;web-app xmlns=&quot;http://geronimo.apache.org/xml/ns/j2ee/web-1.1&quot; xmlns:naming=&quot;http://geronimo.apache.org/xml/ns/naming-1.1&quot;&gt;
    &lt;dep:environment xmlns:dep=&quot;http://geronimo.apache.org/xml/ns/deployment-1.1&quot;&gt;
	    &lt;dep:moduleId&gt;
		    &lt;dep:groupId&gt;BrokerageApp&lt;/dep:groupId&gt;
			&lt;dep:artifactId&gt;MySqlDS&lt;/dep:artifactId&gt;
			&lt;dep:version&gt;2.0&lt;/dep:version&gt;
			&lt;dep:type&gt;car&lt;/dep:type&gt;
		&lt;/dep:moduleId&gt;

		&lt;dep:dependencies&gt;
		    &lt;dep:dependency&gt;
		        &lt;dep:groupId&gt;user&lt;/dep:groupId&gt;
			    &lt;dep:artifactId&gt;database-pool-HibernateDB&lt;/dep:artifactId&gt;
			    &lt;dep:version&gt;2.0&lt;/dep:version&gt;
			    &lt;dep:type&gt;car&lt;/dep:type&gt;
			&lt;/dep:dependency&gt;
		&lt;/dep:dependencies&gt;

		&lt;dep:hidden-classes&gt;
		    &lt;dep:filter&gt;org.springframework&lt;/dep:filter&gt;
			&lt;dep:filter&gt;META-INF/spring&lt;/dep:filter&gt;
			&lt;!--dep:filter&gt;antlr&lt;/dep:filter--&gt;
		&lt;/dep:hidden-classes&gt;
	&lt;/dep:environment&gt;

	&lt;context-root&gt;/brokerage&lt;/context-root&gt;

    &lt;resource-ref&gt;
        &lt;ref-name&gt;jdbc/HibernateDB&lt;/ref-name&gt;
        &lt;resource-link&gt;HibernateDS&lt;/resource-link&gt;
    &lt;/resource-ref&gt;
&lt;/web-app&gt;
]]></script>
</div></div>
<p>的<code><hidden-classes></code>元素用于防止战争类加载器看到Apache Geronimo附带的某些类，这可能会导致版本问题。</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Buildthemigratedsampleapplication">构建迁移的示例应用程序</h2>

<p>要构建应用程序，请运行以下命令</p>
<ul><li>将休眠jar添加到类路径。您现在需要使用以下命令构建休眠模式<code>GeronimoTransactionManagerLookup</code>类。如果尚未下载休眠源，则可以在将休眠jar放入类路径后编译该类，然后将其手动添加到休眠jar文件中。<br clear="none">
<code><strong>set CLASSPATH=%CLASSPATH%;<hibernate_home>/lib/hibernate3.jar</strong></code></li><li>将Geronimo内核添加到您的类路径中<br clear="none">
<code><strong>set CLASSPATH=%CLASSPATH%;<geronimo_home>/lib/geronimo-kernel-2.2.jar</strong></code></li></ul>


<ul><li>要手动添加类（尽管此特定示例不需要），可以使用自己喜欢的工具，并将GeronimoTransactionManagerLookup.class添加到<code>org\hibernate\transaction</code>目录中<code>hibernate_home>/lib/hibernate3.jar</code>文件。</li></ul>


<ul><li>现在，通过运行以下命令来构建迁移的应用程序：</li></ul>


<p><code><strong><brokerage_home>/ant war</strong></code></p>

<p>请注意，由于Online Brokerage示例应用程序只是一个Web应用程序，因此我们只是在建立<strong>战争</strong>目标。在JBoss部分中，我们用一只<strong>耳朵</strong>包装了<strong>war</strong>和<strong>har</strong> ，Apache Geronimo不支持最后一个。</p>

<p>这将在<strong><brokerage_home>/ geronimo-artefact</brokerage_home></strong>目录中创建一个<strong>brokerage.war</strong>文件。</p>

<p><strong><brokerage_home>/ solutions</brokerage_home></strong>目录中的源文件已经迁移到Apache Geronimo中进行编译和运行。</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Deploythemigratedsampleapplication">部署迁移的样本应用程序</h2>

<p>要部署迁移的Online Brokerage应用程序，请确保Geronimo服务器已启动并正在运行，并运行以下命令：</p>

<p><code><strong>deploy --user system --password manager deploy <brokerage_home>/geronimo-artefact/brokerage.war</strong></code></p>

<p>部署应用程序后，打开Web浏览器并访问以下URL：</p>

<p><a shape="rect" class="external-link" href="http://localhost:8080/brokerage" rel="nofollow">http：// localhost：8080 / brokerage</a></p>

<p>使用在JBoss中测试应用程序时使用的用户名和密码登录。</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p>

<h1 id="JBosstoGeronimo-HibernateMigration-Summarysummary">摘要<span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-summary"></span></h1>

<p>本文向您展示了如何将使用Hibernate作为其O / R映射层的示例应用程序从JBoss迁移到Apache Geronimo应用程序服务器。JBoss已经提供的某些功能可能尚未在Geronimo中实现，因此可能需要一些小的附加编码，但总体迁移复杂度很低。</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">回到顶部</a></p></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tbody><tr>
          <td align="left" valign="middle" class="footer">
              
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="美味的"> <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&noui&jump=close&url='+encodeURIComponent(location.href)+'&title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">在Delicious上添加书签</a> <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="掘客！"> <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&title='+encodeURIComponent(document.title)+'&topic=programming');">挖这个</a> <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : JBoss to Geronimo - Hibernate Migration';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
              
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">隐私权政策</a> -版权所有©2003-2013，Apache软件基金会，根据<a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0</a>许可<a href="http://www.apache.org/licenses/LICENSE-2.0">。</a>  
          </td>
        </tr>
    </tbody></table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  

</body></html>