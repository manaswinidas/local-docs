<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="http://geronimo.apache.org/style/default.css">
    <LINK rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <LINK rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <META name="Description" content="JBoss to Geronimo - Hibernate Migration" />
    <META name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi JBoss to Geronimo - Hibernate Migration" />
    <META name="Owner" content="dev@geronimo.apache.org" />
    <META name="Robots" content="index, follow" />
    <META name="Security" content="Public" />
    <META name="Source" content="wiki template" />
    <META name="DC.Date" scheme="iso8601" content="2010-05-11" />
    <META name="DC.Language" scheme="rfc1766" content="en" />
    <META name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation" />
    <META http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html" l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html" l gen true r (n 0 s 0 v 0 l 0) "http://www.classify.org/safesurf/" l gen true r (SS~~000 1))'/>

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>


    <title>Apache Geronimo v3.0 Documentation: JBoss to Geronimo - Hibernate Migration</title>
  </head>

  <body onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tr>
        <td valing="top" align="left">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" align="left" nowrap>
          <a href="/geronimo"> Home</a> >&nbsp;<a href="documentation.html">Documentation</a>&nbsp;&gt;&nbsp;<a href="migrating-to-apache-geronimo.html">Migrating to Apache Geronimo</a>&nbsp;&gt;&nbsp;<a href="migrating-from-jboss-to-geronimo.html">Migrating from JBoss to Geronimo</a>&nbsp;&gt;&nbsp;<a href="jboss-to-geronimo-hibernate-migration.html">JBoss to Geronimo - Hibernate Migration</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
        </td>
      </tr> 
    </table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div style="margin: 0px 10px 0px 10px" class="smalltext">Apache Geronimo v3.0</div>
        <div style="margin: 0px 10px 8px 10px"  class="pagetitle">JBoss to Geronimo - Hibernate Migration</div>

        <div class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
<!-- -->         
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645282">
            <img src="http://geronimo.apache.org/images/icons/notep_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Edit Page"></a>
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645282">Edit Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">
            <img src="http://geronimo.apache.org/images/icons/browse_space.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Browse Space"></a>
            <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">Browse Space</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645282">
            <img src="http://geronimo.apache.org/images/icons/add_page_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add Page"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645282">Add Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645282">
            <img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add News"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645282">Add News</a>
<!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent"><p><span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-top"></span><br clear="none">
This article will help you migrate applications using Hibernate 4.1 as the ORM tool from JBoss Application Server 7.0 to Apache Geronimo 3.0.</p>

<p>Hibernate is a powerful, high performance object/relational persistence and query service. It helps in the development of persistent (POJO) classes which have the getter and setter methods for attributes that are then mapped to fields in the database. You may follow object-oriented idiom - including association, inheritance, polymorphism, composition, and collections. Hibernate allows you to express queries in its own portable SQL extension (HQL), as well as in native SQL, or with an object-oriented Criteria and Example API.</p>

<p>Basically, Hibernate maps the Java classes to the database tables. It also provides the data query and retrieval facilities that significantly reduce the development time. It fits in naturally to the object-oriented mode of code development in the JAVA middle-tier. A unique feature of Hibernate is that it facilitates transparent persistence that enables the applications to switch to any database be it MySQL, Oracle or DB2. Hibernate can be used in Java Swing applications, Java Servlet-based applications, or Java EE applications using EJB session beans (Java Servlet based application in our case).</p>

<p>In order to illustrate the steps involved in the migration a sample application is provided which we will first deploy in JBoss and then migrate to Geronimo. The sample application will be the Online Brokerage Application which we already used in the JDBC migration example. This application has been changed to use Hibernate for persistence.</p>

<p>This article is organized in the following sections:</p>
<ul><li><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-implementation">Hibernate implementation analysis</a></li><li><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-sampleApp">Sample application</a></li><li><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-JBoss">The JBoss environment</a></li><li><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-Geronimo">The Geronimo environment</a></li><li><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-migration">Step-by-step migration</a></li><li><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-summary">Summary</a></li></ul>


<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h1 id="JBosstoGeronimo-HibernateMigration-Hibernateimplementationanalysisimplementation">Hibernate implementation analysis <span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-implementation"></span></h1>

<p>Hibernate can provide the following services:</p>
<ul><li>Connection Management</li><li>Transaction Management</li><li>Object Relational Mapping</li></ul>


<p>It is also very flexible and we can use any combinations of these services. In this article we will be configuring hibernate to provide only the O/R Mapping feature while JBoss/Geronimo will provide both Transaction Management and Connection Management. This is the most commonly used configuration of Hibernate with an application server. Hibernate requires a configuration file <code>hibernate.cfg.xml</code> which creates the connection pool and sets up the required environment. It contains parameters like the database driver, connection url, dialect (this specifies which RDBMS is being used), username, password, pool size among others. It also contains the location of the Mapping File <code>*.hbm.xml</code>. A Mapping File is used to map the fields in the database table to the persistent class attributes.</p>

<p>These properties are <strong>common</strong> to any application server including <strong>Apache Geronimo v3.0</strong>.</p>

<p>However, JBoss (more specifically the Hibernate MBean) provides <strong>two</strong> additional deployment mechanisms.</p>

<p>The first is the Hibernate Archive (HAR file). Here, all the Hibernate classes and mapping files are packaged in a special archive, the HAR file. JBoss deploys this archive in the same way as it does with an EAR or a WAR file.</p>

<p>The alternative to the HAR file is to simply put all the Hibernate classes and mapping files with the other application classes, like in an EAR for example. The Hibernate MBean would be separately configured and told to search all application JARs for mapping files. Both deployment mechanisms allow you to provide Hibernate objects to your application code without performing any manual configuration or writing of the setup code normally required.</p>

<p>Structurally, a HAR file resembles a JBoss service archive (SAR file). The HAR file contains the Hibernate class files and the mapping files (*.hbm.xml) along with the standard <code>jboss-service.xml</code> file containing a definition for the Hibernate MBean configured for the needs of the Hibernate application being created. In the latest JBoss distribution, it has been renamed as <code>hibernate-service.xml</code>, but it retains the same structure and purpose.</p>

<p>Hibernate archives can be deployed as top-level packages or as a component of an EAR file. Since Hibernate archives are not a standard J2EE deployment type, we need to declare them in the <code>jboss-app.xml</code> file of an EAR file to use them in that context.</p>

<p>The following table provides a feature-to-feature comparison between these two applicaiton servers.</p>
<div class="table-wrap"><table class="confluenceTable"><tbody><tr><th colspan="1" rowspan="1" class="confluenceTh"><p> Feature </p></th><th colspan="1" rowspan="1" class="confluenceTh"><p> Apache Geronimo v3.0 </p></th><th colspan="1" rowspan="1" class="confluenceTh"><p> JBoss v7.0 </p></th></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> Container-managed datasource </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> Supported. Hibernate is able to use a datasource given its JNDI name. This is because it is running in the same thread as the application. </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> Supported. Hibernate can lookup a datasource from JNDI given its JNDI name. </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> Automatic JNDI binding </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> Not Supported. </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> Supported. Once the property is set the session factory is bound to the JNDI context. </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> JTA Session binding </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> This feature is not supported out of the box. We need to write a lookup for the Geronimo Transaction Manager to enable this. </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> Supported out of the Box. Hibernate provides a lookup class for the JBoss Transaction Manager. </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> JMX deployment </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> Not Supported out of the box. <strong>Can be implemented by writing a GBean and a Hibernate Connection Provider class</strong>. </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> Supported. Hibernate is distributed with <code>org.hibernate.jmx.HibernateService</code> which can be deployed on JBoss. </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> Hibernate Archive (HAR) </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> Not Supported. Hibernate classes are deployed as a part of the J2EE archives. </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> Supported. A HAR packages the configuration and mapping files enabling extra server support to deployment. </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> Caching </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> You can use caching mechanisms provided by hibernate. </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> You can use caching mechanisms provided by hibernate. Integration with JBoss Cache is also supported. </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> Session Management </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> Not Supported. It is required to manually open sessions. Only the transaction needs to be closed. </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> The Hibernate Session's lifecycle can be automatically bound to the scope of a <br clear="none" class="atl-forced-newline">
JTA transaction. This means you no longer have to manually open and close the Session, this becomes the job of a JBoss EJB interceptor. </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> Hibernate Mapping Files </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> We need to specify the locations of the Hibernate mapping files. </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> If we use HAR deployment JBoss will automatically lookup the Hibernate mapping files. </p></td></tr></tbody></table></div>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h1 id="JBosstoGeronimo-HibernateMigration-SampleapplicationsampleApp">Sample application <span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-sampleApp"></span></h1>

<p>This article contains a sample application to demonstrate migrating an application from JBoss to Geronimo, called <a shape="rect" href="jboss-to-geronimo-hibernate-migration.data/brokerage.zip?version=1&amp;modificationDate=1204180993000&amp;api=v2" data-linked-resource-id="20874015" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="brokerage.zip" data-nice-type="Zip Archive" data-linked-resource-content-type="application/zip" data-linked-resource-container-id="20645282" data-linked-resource-container-version="5">Online Brokerage</a> . It represents an online trading scenario in which users can buy and sell stocks. The application has the following five pages:</p>
<ul><li>Login Page</li><li>Registration Page</li><li>User Information Page</li><li>Available Stocks Page</li><li>User Portfolio Page</li></ul>


<p>The following figure illustrates the application flow:<span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" src="jboss-to-geronimo-hibernate-migration.data/brokerage.jpg" data-image-src="/confluence/download/attachments/20645282/brokerage.jpg?version=1&amp;modificationDate=1204180993000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="20874014" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="brokerage.jpg" data-base-url="https://cwiki.apache.org/confluence" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="20645282" data-linked-resource-container-version="5"></span><br clear="none">
First, the user accesses the Login page. From the Login page the user enters the user name and password. If the user name or password is not valid the application throws an error message and rejects the user's login attempt. If the user name and password are correct, the user is taken to the Available Stocks page where he/she can view all the stocks that are present for sale at that time.<br clear="none">
The user can choose to buy as many stocks as wanted, depending on the available money in the account, by clicking the Buy button. After the transaction completes successfully the user is brought back to the Available Stocks page where he/she can buy more stocks if required. If the user has insufficient funds to buy stocks the application will throw an error and will not process the transaction. The error message is shown at the top of the Available Stocks page. There is a User Info button on this page. By clicking this button the user is taken to the User Info page and shown the user details.<br clear="none">
From the Available Stocks page there is a View your Portfolio link that shows all the stocks that the user owns. In that page, the user can select the stocks and quantity to sell. This page also shows the user's available cash in the User Cash field. If the user tries to sell more stocks than he/she has, the application will throw an error. The error message will be displayed on the same page. For each successful sale, the sale amount is added to the user's cash balance. The quantity text box shows the quantity of stocks of a particular company that the user has. The Quantity to Sell field allows the user to enter the quantity of stocks to sell for a specific company. For selling and buying, the radio button should be checked. This should be done after entering the values. If either the quantity to sell textbox is not filled or the selection box is not checked and you press on sell a JavaScript alert will be triggered saying that the required field is empty. On entering non numeric characters for quantity another alert will be triggered. This behavior is similar for the Available Stocks page as well.<br clear="none">
New users can register by clicking the Register button in the login page. In the Registration page the user will enter a user id, user name, password, address and available cash.<br clear="none">
<a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>
<h2 id="JBosstoGeronimo-HibernateMigration-ApplicationclassesandJSPpages">Application classes and JSP pages</h2>

<p>The Online Brokerage sample application consists of the following packages:</p>
<ul><li>com.dev.trade.bo
	<ul><li>Stock - Represents the stock of a company.</li><li>User - Represents the user.</li><li>UserStock - Represents the stock owned by a user.</li></ul>
	</li></ul>


<ul><li>com.dev.trade.dao
	<ul><li>TradeDAO - Contains all the database access methods.</li></ul>
	</li></ul>


<ul><li>com.dev.trade.exception
	<ul><li>DBException - Custom exception class that is thrown for all database exceptions.</li></ul>
	</li></ul>


<ul><li>com.dev.trade.servlet
	<ul><li>TradeDispatcherServlet - Dispatches all the requests to the JSPs after performing required database functions.</li></ul>
	</li></ul>


<p>The Online Brokerage also includes the following JSP pages:</p>
<ul><li>login.jsp - The login page of the application.</li><li>error.jsp - The default error page of the application.</li><li>register.jsp - The user registration page.</li><li>stocks.jsp - The Available Stocks page from where the user can buy stocks.</li><li>userstocks.jsp - The user portfolio page which shows the user's stocks. The user can sell stocks from this page.</li></ul>


<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Toolsused">Tools used</h2>

<p>The tools used for developing and building the sample application are:</p>

<h3 id="JBosstoGeronimo-HibernateMigration-ApacheAnt">Apache Ant</h3>

<p>Ant is a pure Java build tool. It is used for building the war files and populating the database for the Online Brokerage application. Ant can be downloaded from the following URL:</p>

<p><a shape="rect" class="external-link" href="http://ant.apache.org">http://ant.apache.org</a></p>

<h3 id="JBosstoGeronimo-HibernateMigration-Hibernate">Hibernate</h3>

<p>At the time of writing this article, Hibernate 4.1 is the latest version available and can be downloaded at the following URL:<br clear="none">
<a shape="rect" class="external-link" href="http://www.hibernate.org" rel="nofollow">http://www.hibernate.org</a></p>

<p>Additional documentation on Hibernate may be found at the following URL:<br clear="none">
<a shape="rect" class="external-link" href="http://www.hibernate.org/docs" rel="nofollow">http://www.hibernate.org/docs</a></p>

<p>Download and install Hibernate, the installation directory will be later referred as <strong>&lt;hibernate_home&gt;</strong>.</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Sampledatabase">Sample database</h2>

<p>The database used for demonstrating this application is MySQL. The sample database name is <strong>adi</strong> and it consists of the following three tables, STOCKS, USERS and USERSTOCKS. The fields for each of these tables are described below.</p>
<div class="table-wrap"><table class="confluenceTable"><tbody><tr><th colspan="1" rowspan="1" class="confluenceTh"><p> Table Name </p></th><th colspan="1" rowspan="1" class="confluenceTh"><p> Fields </p></th></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> STOCKS </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> ID (PRIMARY KEY) <br clear="none" class="atl-forced-newline">
 NAME <br clear="none" class="atl-forced-newline">
 PRICE </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> USERS </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> USERID (PRIMARY KEY) <br clear="none" class="atl-forced-newline">
 NAME <br clear="none" class="atl-forced-newline">
 PASSWORD <br clear="none" class="atl-forced-newline">
 ADDRESS <br clear="none" class="atl-forced-newline">
 CASH </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> USERSTOCKS </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> ID (PRIMARY KEY) <br clear="none" class="atl-forced-newline">
 USERID (PRIMARY KEY) <br clear="none" class="atl-forced-newline">
 NAME <br clear="none" class="atl-forced-newline">
 PRICE <br clear="none" class="atl-forced-newline">
 QUANTITY </p></td></tr></tbody></table></div>

<p>The USERSTOCKS table is used to store the stocks that are owned by each user. The USERS and STOCKS tables are used to store the user and stock details. Because this is just a sample application the amount of money that a user has is entered during user registration by the user itself.</p>

<p>The DDL file used for populating this database is <strong>db.sql</strong> and it is located in the &lt;brokerage_home&gt;\sql directory.</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h1 id="JBosstoGeronimo-HibernateMigration-TheJBossenvironmentJBoss">The JBoss environment <span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-JBoss"></span></h1>

<p>This section shows you how and where the sample JBoss reference environment was installed so you can map this scenario to your own implementation.</p>

<p>Detailed instructions for installing, configuring, and managing JBoss are provided in the product documentation. Check the product Web site for the most updated documents.</p>

<p>The following list highlights the general tasks you will need to complete to install and configure the<br clear="none">
initial environment as the starting point for deploying the sample application.</p>
<ol><li>Download and install JBoss v7.0 as explained in the product documentation guides. From now on the<br clear="none">
installation directory will be referred as <strong>&lt;jboss_home&gt;</strong></li><li>Create a copy of the default JBoss v7.0 application server. Copy recursively <strong>&lt;jboss_home&gt;\server\default</strong> to <strong>&lt;jboss_home&gt;\server\&lt;your_server_name&gt;</strong></li><li>Start the new server by running the <code><strong>run.sh -c &lt;your_server_name&gt;</strong></code> command from the <strong>&lt;jboss_home&gt;\bin</strong> directory.</li><li>Once the server is started, you can verify that it is running by opening a Web browser and pointing it to this URL: <a shape="rect" class="external-link" href="http://localhost:8080" rel="nofollow">http://localhost:8080</a>. You should see the JBoss Welcome window and be able to access the JBoss console.</li><li>Once the application server is up and running, the next step is to install and configure all the remaining prerequisite software required by the sample application. This step is described in the following section.</li></ol>


<h2 id="JBosstoGeronimo-HibernateMigration-Installandconfigureprerequisitesoftware">Install and configure prerequisite software</h2>

<p>In order to build and run the Library application included in this article, you need to install and configure the build tool and the database that is used by the application.</p>

<h3 id="JBosstoGeronimo-HibernateMigration-Installthedatabase">Install the database</h3>

<p>As mentioned earlier in the article, this application is using the MySQL database that can be downloaded from the following URL:</p>

<p><a shape="rect" class="external-link" href="http://www.mysql.com" rel="nofollow">http://www.mysql.com</a></p>

<p>Note: The appropriate version of the MySQL Connector/J should also be downloaded (3.1, 5.0, or 5.1), depending on your MySQL version.</p>

<p>This MySQL connector must also be placed in &lt;JBOSS_HOME&gt;/server/default/lib.&#160;</p>

<p>The Installation and configuration of MySQL is fairly intuitive and it is well documented in the MySQL Reference Manual available at the following URL:</p>

<p><a shape="rect" class="external-link" href="http://dev.mysql.com/doc/mysql/en" rel="nofollow">http://dev.mysql.com/doc/mysql/en</a></p>

<p><strong>Note:</strong> During the instance configuration I modified the security settings and specified "password" as the password for the root user. This user ID and password will later be used for accessing the database from the sample application.</p>

<h3 id="JBosstoGeronimo-HibernateMigration-Createsampledatabase">Create sample database</h3>

<p>Once the MySQL instance is configured you need to create the sample database that will be used by the Library application. From a command line, type the following command to start the MySQL monitor:</p>

<p><code><strong>mysql -u root -ppassword</strong></code></p>

<p>Note that there is no blank between the flag -p and the password.</p>

<p>This will bring up the MySQL command interface as shown in the following example:</p>
<div class="preformatted panel" style="border-style: solid;border-width: 1px;"><div class="preformattedHeader panelHeader" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>MySQL monitor interface</b></div><div class="preformattedContent panelContent">
<pre>Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 7 to server version: 4.1.14-nt

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql&gt;
</pre>
</div></div>
<p>From the MySQL command interface create the <strong>adi</strong> sample database by typing the following command:</p>

<p><code><strong>mysql&gt; create database adi;</strong></code></p>

<h3 id="JBosstoGeronimo-HibernateMigration-ConfigureAnt">Configure Ant</h3>

<p>As mentioned before, Apache Ant is used to build the binaries for the Online Brokerage application. If you do not have Ant installed this is a good time for doing it and make sure that <strong>&lt;ant_home&gt;\bin</strong> directory is added to the system's path variable.</p>

<p>Apache Ant can be downloaded from the following URL:</p>

<p><a shape="rect" class="external-link" href="http://ant.apache.org">http://ant.apache.org</a></p>

<h3 id="JBosstoGeronimo-HibernateMigration-ConfigureHibernate">Configure Hibernate</h3>

<p>JBoss comes bundled with Hibernate so there is no need to download separate jars for hibernate.</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Buildthesampleapplication">Build the sample application</h2>

<p>The Online Brokerage application included with this article provides an Ant script that you will use in order to build the application and populate the database. Download the sample application by cliking on <a shape="rect" href="jboss-to-geronimo-hibernate-migration.data/brokerage.zip?version=1&amp;modificationDate=1204180993000&amp;api=v2" data-linked-resource-id="20874015" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="brokerage.zip" data-nice-type="Zip Archive" data-linked-resource-content-type="application/zip" data-linked-resource-container-id="20645282" data-linked-resource-container-version="5">Online Brokerage</a>.</p>

<p>After extracting the zip file, a brokerage directory is created, throughout the rest of the article we will refer to this directory as <strong>&lt;brokerage_home&gt;</strong>. In that directory open the <strong>build.properties</strong> file and edit the properties to match your environment as shown in the following example:</p>
<div class="preformatted panel" style="border-style: solid;border-width: 1px;"><div class="preformattedHeader panelHeader" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>build.properties</b></div><div class="preformattedContent panelContent">
<pre>#Replace java.home with your jdk directory
java.home=&lt;java_home&gt;

#Replace jboss.home with the parent directory of lib/j2ee.jar
jboss.home=&lt;jboss_home&gt;/server/&lt;your_server_name&gt;

#Replace geronimo.home with the geronimo home directory.
geronimo.home=&lt;geronimo_home&gt;

#Fully qualified name of the JDBC driver class
db.driver=com.mysql.jdbc.Driver

#database url
db.url=jdbc:mysql://localhost:3306/adi

#database userId
db.userid=root

#database password
db.password=password

#script file for creating the tables
sql.file=sql/db.sql

#location of the jdbc driver jar.
driver.classpath=&lt;mysql-connector_home&gt;/mysql-connector-java-3.1.14-bin.jar

#location of the hibernate jars.
dependency.dir=&lt;hibernate_home&gt;/lib
</pre>
</div></div>
<p>Note that the path to the Hibernate jars defined by the <code><strong>dependency.dir</strong></code> tag are necessary by Geronimo, JBoss comes with it's own copy of Hibernate. Still you will need to copy to that directory the <strong>hibernate3.jar</strong> file located in the <strong>&lt;hibernate_home&gt;</strong> directory.</p>
<div class="confluence-information-macro confluence-information-macro-note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p><strong>Important:</strong> When specifying the paths in this file, make sure you use forward slash "<strong>/</strong>" otherwise you will get compilation errors.</p></div></div>
<p>From a command prompt or shell change directory to &lt;brokerage_home&gt; and run the <strong>ant</strong> command. This will build the war, har and ear files and place them in the <strong>&lt;brokerage_home&gt;\jboss-artefact</strong> directory. The war created by the <strong>ant</strong> build contains a JBoss specific deployment descriptor <strong>jboss-web.xml</strong> file in the WEB-INF directory of the WAR. The HAR contains a JBoss specific <strong>hibernate-service.xml</strong> file in the META-INF directory and the EAR contains a JBoss specific deployment descriptor <strong>jboss-app.xml</strong>. These files are shown below.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>jboss-web.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;jboss-web&gt;
  &lt;context-root&gt;/brokerage&lt;/context-root&gt;
  &lt;resource-ref&gt;
      &lt;res-ref-name&gt;jdbc/HibernateDB&lt;/res-ref-name&gt;
      &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
      &lt;jndi-name&gt;jdbc/HibernateDS&lt;/jndi-name&gt;
  &lt;/resource-ref&gt;
&lt;/jboss-web&gt;
]]></script>
</div></div>
<p>The resource-ref element is used to map the resource referred to by the name <strong>jdbc/HibernateDB</strong> in the web.xml file to the resource with the JNDI name <strong>java:jdbc/</strong> <strong>HibernateDS</strong>, for example MySQL datasource.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>hibernate-service.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;server&gt;
    &lt;mbean code=&quot;org.jboss.hibernate.jmx.Hibernate&quot;
           name=&quot;jboss.har:service=Hibernate&quot;&gt;
        &lt;attribute name=&quot;DatasourceName&quot;&gt;java:jdbc/HibernateDS&lt;/attribute&gt;

        &lt;attribute name=&quot;Dialect&quot;&gt;
            org.hibernate.dialect.MySQLDialect
        &lt;/attribute&gt;
        &lt;attribute name=&quot;SessionFactoryName&quot;&gt;
            java:/hibernate/BrokerageSessionFactory
        &lt;/attribute&gt;
        &lt;attribute name=&quot;CacheProviderClass&quot;&gt;
            org.hibernate.cache.HashtableCacheProvider
        &lt;/attribute&gt;
         &lt;!-- &lt;attribute name=&quot;ScanForMappingsEnabled&quot;&gt;true&lt;/attribute&gt; --&gt;
        &lt;attribute name=&quot;ShowSqlEnabled&quot;&gt;true&lt;/attribute&gt;
    &lt;/mbean&gt;
&lt;/server&gt;
]]></script>
</div></div>
<p>This file contains the hibernate properties that need to be set. The property names and their functions are:</p>
<ul><li><strong>DatasourceName</strong> - The JNDI name of the datasource that Hibernate should use.</li><li><strong>Dialect</strong> - The SQL Dialect that should be used.</li><li><strong>SessionFactoryName</strong> - JNDI name to which the session factory should be bound.</li><li><strong>CacheProviderClass</strong> - The Class of the Cache Provider</li><li><strong>ShowSqlEnabled</strong> - Show the executed SQL statements in the output.</li></ul>


<p>The <strong>hibernate-service.xml</strong> file should be present in the META-INF directory of the EAR.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>jboss-app.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;!DOCTYPE jboss-app PUBLIC &quot;-//JBoss//DTD J2EE Application 1.4//EN&quot; &quot;http://www.jboss.org/j2ee/dtd/jboss-app_4_0.dtd&quot;&gt;
&lt;jboss-app&gt;
    &lt;module&gt;
        &lt;har&gt;brokerage.har&lt;/har&gt;
    &lt;/module&gt;
&lt;/jboss-app&gt;
]]></script>
</div></div>
<p>The <strong>jboss-app.xml</strong> file located in the META-INF directory of the EAR specifies the name of the har file present in the EAR.</p>

<p>The following example shows the deployment descriptor <strong>web.xml</strong> used in this application. The <strong>web.xml</strong> file located in the WEB-INF directory of <code><strong>brokerage.war</strong></code> is the deployment descriptor where you specify, among other things, the servlets name and default JSP for the application.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>web.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app xmlns=&quot;http://java.sun.com/xml/ns/j2ee&quot; version=&quot;2.4&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&quot;&gt;
    &lt;display-name&gt;brokerage&lt;/display-name&gt;
    &lt;servlet&gt;
        &lt;display-name&gt;Trade-Dispatcher&lt;/display-name&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.dev.trade.servlet.TradeDispatcherServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/login&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/stocks&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/userstocks&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/buy&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/sell&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;TradeDispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/register&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;welcome-file-list&gt;
  &lt;welcome-file&gt;/login.jsp&lt;/welcome-file&gt;
    &lt;/welcome-file-list&gt;
    &lt;error-page&gt;
     &lt;exception-type&gt;javax.servlet.ServletException&lt;/exception-type&gt;
     &lt;location&gt;/error.jsp&lt;/location&gt;
    &lt;/error-page&gt;

    &lt;resource-ref&gt;
        &lt;res-ref-name&gt;jdbc/HibernateDB&lt;/res-ref-name&gt;
        &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
        &lt;res-auth&gt;Container&lt;/res-auth&gt;
        &lt;res-sharing-scope&gt;Shareable&lt;/res-sharing-scope&gt;
    &lt;/resource-ref&gt;
&lt;/web-app&gt;
]]></script>
</div></div>
<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Populatesampledata">Populate sample data</h2>

<p>As we mentioned before, the <strong>db.sql</strong> script is provided to populate the sample data. The location of this file is already defined in the <strong>build.properties</strong> by the tag <strong>sql.file</strong>. To populate the sample data simply run the following command from the <strong>&lt;brokerage_home&gt;</strong> directory.</p>

<p><code><strong>ant populateDB</strong></code></p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Deploythesampleapplication">Deploy the sample application</h2>

<p>Before you deploy the sample application you need to configure the datasource required by this application. To deploy the datasource configuration in JBoss copy the <strong>mysql-ds.xml</strong> file located in the <strong>&lt;brokerage_home&gt;\plan</strong> directory to the following directory:</p>

<p><code><strong>&lt;jboss_home&gt;\server\&lt;your_server_name&gt;\deploy</strong></code></p>

<p>Similarly to the database deployment, to deploy the Online Brokerage application in JBoss, copy the <strong>brokerage.ear</strong> file you just built with Ant to the following directory:</p>

<p><code><strong>&lt;jboss_home&gt;\server\&lt;your_server_name&gt;\deploy</strong></code></p>

<p>If JBoss is already started, it will automatically deploy and start the application; otherwise, the application will be deployed and started at the next startup.</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Testthesampleapplication">Test the sample application</h2>

<p>To test the application, open a Web browser and access the following URL:</p>

<p><a shape="rect" class="external-link" href="http://localhost:8080/brokerage" rel="nofollow">http://localhost:8080/brokerage</a></p>

<p>This brings up the login screen of the Online Brokerage application. Enter j2ee as the user name and password as the password and click on login. This takes you to the available stocks page illustrated in the following figure. The application is now configured and running.<span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" src="jboss-to-geronimo-hibernate-migration.data/available.jpg" data-image-src="/confluence/download/attachments/20645282/available.jpg?version=1&amp;modificationDate=1204180993000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="20874016" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="available.jpg" data-base-url="https://cwiki.apache.org/confluence" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="20645282" data-linked-resource-container-version="5"></span><br clear="none">
<a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>
<h1 id="JBosstoGeronimo-HibernateMigration-TheGeronimoenvironmentGeronimo">The Geronimo environment <span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-Geronimo"></span></h1>

<p>Download and install Geronimo from the following URL:</p>

<p><a shape="rect" class="external-link" href="http://geronimo.apache.org/downloads.html">http://geronimo.apache.org/downloads.html</a></p>

<p>The release notes available there provide clear instructions on system requirements and how to install and start Geronimo. Throughout the rest of this article we will refer to the Geronimo installation directory as <strong>&lt;geronimo_home&gt;</strong>.</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-ConfigureResources">Configure Resources</h2>

<p>For running the Online Brokerage application in Geronimo, you will be using the same MySQL database that was used with JBoss. So the first task you need to do in order to prepare the Geronimo environment is to configure the data source.</p>

<h3 id="JBosstoGeronimo-HibernateMigration-Configurethedatasource">Configure the datasource</h3>

<p>You need to copy the MySQL database driver into the Geronimo repository so that you can refer to it in the data source deployment plan. The Geronimo repository is located in the <strong>&lt;geronimo_home&gt;/repository</strong> directory. Inside this directory, create a new directory called <strong>mysql/jars</strong> and copy the <strong>mysql-connector-java-3.1.14-bin.jar</strong> file into it.</p>

<p>Now, you need to define a data source deployment plan. For your convenience, the sample application already provides a deployment plan called <strong>mysql-geronimo-plan.xml</strong> located in the <strong>&lt;brokerage_home&gt;\plan</strong> directory. The following example shows the content of this deployment plan.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>mysql-geronimo-plan.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;connector xmlns=&quot;http://geronimo.apache.org/xml/ns/j2ee/connector-1.2&quot;&gt;
  &lt;dep:environment xmlns:dep=&quot;http://geronimo.apache.org/xml/ns/deployment-1.1&quot;&gt;
    &lt;dep:moduleId&gt;
	  &lt;dep:groupId&gt;user&lt;/dep:groupId&gt;
	  &lt;dep:artifactId&gt;database-pool-HibernateDB&lt;/dep:artifactId&gt;
	  &lt;dep:version&gt;2.0&lt;/dep:version&gt;
	  &lt;dep:type&gt;car&lt;/dep:type&gt;
	&lt;/dep:moduleId&gt;
	&lt;dep:dependencies&gt;
	  &lt;dep:dependency
	    &lt;dep:groupId&gt;mysql&lt;/dep:groupId&gt;
		&lt;dep:artifactId&gt;mysql-connector-java&lt;/dep:artifactId&gt;
		&lt;dep:version&gt;3.1.14-bin&lt;/dep:version&gt;
		&lt;dep:type&gt;jar&lt;/dep:type&gt;
	  &lt;/dep:dependency&gt;
	&lt;/dep:dependencies&gt;
  &lt;/dep:environment&gt;
  &lt;resourceadapter&gt;
    &lt;outbound-resourceadapter&gt;
      &lt;connection-definition&gt;
        &lt;connectionfactory-interface&gt;javax.sql.DataSource&lt;/connectionfactory-interface&gt;
        &lt;connectiondefinition-instance&gt;
          &lt;name&gt;HibernateDS&lt;/name&gt;
          &lt;config-property-setting name=&quot;Password&quot;&gt;password&lt;/config-property-setting&gt;
          &lt;config-property-setting name=&quot;CommitBeforeAutocommit&quot;&gt;false&lt;/config-property-setting&gt;
          &lt;config-property-setting name=&quot;Driver&quot;&gt;com.mysql.jdbc.Driver&lt;/config-property-setting&gt;
          &lt;config-property-setting name=&quot;ExceptionSorterClass&quot;&gt;org.tranql.connector.AllExceptionsAreFatalSorter&lt;/config-property-setting&gt;
          &lt;config-property-setting name=&quot;UserName&quot;&gt;root&lt;/config-property-setting&gt;
          &lt;config-property-setting name=&quot;ConnectionURL&quot;&gt;jdbc:mysql://localhost:3306/adi&lt;/config-property-setting&gt;
          &lt;connectionmanager&gt;
            &lt;local-transaction/&gt;
            &lt;single-pool&gt;
              &lt;max-size&gt;10&lt;/max-size&gt;
              &lt;min-size&gt;0&lt;/min-size&gt;
              &lt;blocking-timeout-milliseconds&gt;5000&lt;/blocking-timeout-milliseconds&gt;
              &lt;idle-timeout-minutes&gt;30&lt;/idle-timeout-minutes&gt;
              &lt;match-one/&gt;
            &lt;/single-pool&gt;
          &lt;/connectionmanager&gt;
        &lt;/connectiondefinition-instance&gt;
      &lt;/connection-definition&gt;
    &lt;/outbound-resourceadapter&gt;
  &lt;/resourceadapter&gt;
&lt;/connector&gt;
]]></script>
</div></div>
<p>Now that you have a deployment plan and have copied the drivers the next step is to acutally deploy the datasource connection pool. If you have not yet started Geronimo please do so by running the following command:</p>

<p><code><strong>&lt;geronimo_home&gt;\bin\geronimo start</strong></code></p>

<p>To deploy the datasource connection pool run the following command:</p>

<p><code><strong>&lt;geronimo_home&gt;\bin\deploy --user system --password manager deploy &lt;brokerage_home&gt;\plan\mysql-geronimo-plan.xml ..\repository\org\tranql\tranql-connector-ra\1.3\tranql-connector-ra-1.3.rar</strong></code></p>

<p>Depending on your environment you should see a confirmation message similar to this one:</p>
<div class="preformatted panel" style="background-color: #FFFFFF;border-style: solid;border-width: 1px;"><div class="preformattedContent panelContent" style="background-color: #FFFFFF;">
<pre>C:\geronimo-3.0\bin&gt;deploy --user system --password manager deploy \brokerage\plan\mysql-geronimo-plan.xml
..\repository\org\tranql\tranql-connector-ra\1.3\tranql-connector-ra-1.3.rar
    Deployed user/database-pool-HibernateDS/2.0/car
</pre>
</div></div>
<p><span style="color: white;">&#160;</span></p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h1 id="JBosstoGeronimo-HibernateMigration-Step-by-stepmigrationmigration">Step-by-step migration <span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-migration"></span></h1>

<p>Apache Geronimo does not support HAR archives so we will be having all the classes inside a WAR archive. We need to write two classes for making the application work on Geronimo. One is a TransactionManagerLookup class for Geronimo and the other is a utility class HibernateUtil to get the SessionFactory. In addition to this we will need to make some changes to the TradeDispatcherServlet and TradeDAO classes.</p>

<p>As a first step we will see the changes that need to be made to the application as illustrated in the following list.</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-TradeDAO">#TradeDAO</a><br clear="none">
<a shape="rect" href="#JBosstoGeronimo-HibernateMigration-HibernateUtil">#HibernateUtil</a><br clear="none">
<a shape="rect" href="#JBosstoGeronimo-HibernateMigration-TradeDispatcherServlet">#TradeDispatcherServlet</a></p>

<h3 id="JBosstoGeronimo-HibernateMigration-TradeDAOTradeDAO">TradeDAO <span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-TradeDAO"></span></h3>

<p>In JBoss the HibernateMBean will create and bind the SessionFactory to the Global JNDI Context. So we can obtain the SessionFactory through a simple lookup. We can then get the session from the SessionFactory.</p>

<p><code>TradeDAO.java</code> is located in the <code>&lt;brokerage_home&gt;/src/com/dev/trade/dao</code> directory.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>Excerpt from TradeDAO.java for JBoss</b></div><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
package com.dev.trade.dao;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Set;

import javax.naming.InitialContext;
import javax.naming.NamingException;

import org.hibernate.Query;
import org.hibernate.Session;
import org.hibernate.SessionFactory;

import com.dev.trade.bo.Stock;
import com.dev.trade.bo.User;
import com.dev.trade.bo.UserStock;
import com.dev.trade.exception.DBException;
import com.dev.trade.util.HibernateUtil;

public class TradeDAO {

	SessionFactory factory  = null;
	Session session = null;

	public TradeDAO() throws Exception {

		try {
			InitialContext ctx = new InitialContext();
		    factory  = (SessionFactory)ctx.lookup(&quot;java:hibernate/BrokerageSessionFactory&quot;);

		} catch (NamingException e1) {
			// TODO Auto-generated catch block
			e1.printStackTrace();
		}
	}

	public User getUserByUserId(String userId) throws DBException {

		session = factory.getCurrentSession();
		Query q = session.createQuery(&quot;from User u where u.userId=:userId&quot;);
		q.setString(&quot;userId&quot;, userId);
		return (User) q.uniqueResult();

	}
	...
]]></script>
</div></div>
<p>In Geronimo we will write a new utility class to create the SessionFactory, this class will be the HibernateUtil class. It has a method getCurrentSession() that will return the session.</p>

<p>Modify the first part of <code>TradeDAO.java</code> to match the changes in the following excerpt.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>Excerpt from TradeDAO.java for Geronimo</b></div><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
package com.dev.trade.dao;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Set;

import org.hibernate.Query;
import org.hibernate.Session;

import com.dev.trade.bo.Stock;
import com.dev.trade.bo.User;
import com.dev.trade.bo.UserStock;
import com.dev.trade.exception.DBException;
import com.dev.trade.util.HibernateUtil;

public class TradeDAO {


      Session session = null;

       public TradeDAO() throws Exception {

        }

       public User getUserByUserId(String userId) throws DBException {

            session = HibernateUtil.getCurrentSession();
                Query q = session.createQuery(&quot;from User u where u.userId=:userId&quot;);
                q.setString(&quot;userId&quot;, userId);
              return (User) q.uniqueResult();

       }
       ...
]]></script>
</div></div>
<p>Do a search and replace, look for the following string:</p>

<p><code><strong>factory.getCurrentSession()</strong></code></p>

<p>and replace it with</p>

<p><code><strong>HibernateUtil.getCurrentSession()</strong></code></p>

<p><em>You should count 9 replacements.</em></p>

<p>This difference in obtaining the session will be the main change in the codebase for the application to run in Apache Geronimo.</p>

<h3 id="JBosstoGeronimo-HibernateMigration-HibernateUtilHibernateUtil">HibernateUtil <span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-HibernateUtil"></span></h3>

<p>As mentioned above we will use this class to create the SessionFactory and provide the application with Hibernate sessions. The source code for the class is given below</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>HibernateUtil.java for Geronimo</b></div><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
package com.dev.trade.util;

import org.hibernate.HibernateException;
import org.hibernate.Session;
import org.hibernate.cfg.Configuration;

/**
 * Configures and provides access to Hibernate sessions, tied to the
 * current thread of execution.  Follows the Thread Local Session
 * pattern, see {@link http://hibernate.org/42.html}.
 */
public class HibernateUtil {

    /** location of the Hibernate Configuration File */
    private static String CONFIG_FILE_LOCATION = &quot;hibernate.cfg.xml&quot;;

    /** Holds a single instance of Session */
    private static final ThreadLocal threadLocal = new ThreadLocal();

    /** The single instance of hibernate configuration */
    private static final Configuration cfg = new Configuration();

    /** The single instance of hibernate SessionFactory */
    private static org.hibernate.SessionFactory sessionFactory;

    /**
     * Returns the ThreadLocal Session instance.  Lazy initialize
     * the &lt;code&gt;SessionFactory&lt;/code&gt; if needed.
     *
     *  @return Session
     *  @throws HibernateException
     */
    public static Session getCurrentSession() throws HibernateException {
        Session session = (Session) threadLocal.get();

        if (session == null || ! session.isConnected()) {
            if (sessionFactory == null) {
                try {
                    cfg.configure(CONFIG_FILE_LOCATION);
                    sessionFactory = cfg.buildSessionFactory();
                }
                catch (Exception e) {
                    System.err.println(&quot;%%%% Error Creating SessionFactory %%%%&quot;);
                    e.printStackTrace();
                }
            }
            session = sessionFactory.openSession();
            threadLocal.set(session);
        }

        return session;
    }

    /**
     *  Close the single hibernate session instance.
     *
     *  @throws HibernateException
     */
    public static void closeSession() throws HibernateException {
        Session session = (Session) threadLocal.get();


        if (session != null) {
            session.close();
        }
    }



}
]]></script>
</div></div>
<p><code>HibernateUtil.java</code> is located in the <code>&lt;brokerage_home&gt;/src/com/dev/trade/util</code> directory. For your convenience, a copy of this file is already provided with the sample application.</p>

<h3 id="JBosstoGeronimo-HibernateMigration-TradeDispatcherServletTradeDispatcherServlet">TradeDispatcherServlet <span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-TradeDispatcherServlet"></span></h3>

<p>In this class there will also be a difference in getting the SessionFactory. In JBoss we get it from the JNDI Context but in Geronimo we will get it through the utility class.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>doGet method for JBoss</b></div><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
protected void doGet(HttpServletRequest request,
   HttpServletResponse response) throws ServletException, IOException {

   Session hsession = null;
   try {
         InitialContext ctx = new InitialContext();
         SessionFactory factory  =  (SessionFactory)ctx.lookup(&quot;java:hibernate/BrokerageSessionFactory&quot;);
         hsession = factory.openSession();
       } catch (NamingException e1) {
            e1.printStackTrace();
       }

    Transaction tr = hsession.beginTransaction();
]]></script>
</div></div>
<p><code>TradeDispatcherServlet.java</code> is located in the <code>&lt;brokerage_home&gt;/src/com/dev/trade/servlet</code> directory. Replace the doGet method for the one shown in the following example.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>doGet method for Geronimo</b></div><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
protected void doGet(HttpServletRequest request,
    HttpServletResponse response) throws ServletException, IOException {

    Transaction tr = HibernateUtil.getCurrentSession().getTransaction();
    tr.begin();
]]></script>
</div></div>
<p>Hibernate comes with transaction manager lookup classes for many application servers. Unfortunately Hibernate 3.2 does not have a lookup class specific for Apache Geronimo, so we need to write our own. The code for the Geronimo specific transaction manager lookup is shown in the following example.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>GeronimoTransactionManagerLookup</b></div><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
package org.hibernate.transaction;

import java.util.Iterator;
import java.util.Properties;
import java.util.Set;

import javax.transaction.TransactionManager;
import org.hibernate.HibernateException;
import org.hibernate.transaction.TransactionManagerLookup;

import org.apache.geronimo.gbean.AbstractName;
import org.apache.geronimo.gbean.AbstractNameQuery;
import org.apache.geronimo.kernel.Kernel;
import org.apache.geronimo.kernel.KernelRegistry;
import org.apache.geronimo.kernel.proxy.ProxyManager;

public class GeronimoTransactionManagerLookup implements
        TransactionManagerLookup {

    public static final String UserTransactionName = &quot;java:comp/UserTransaction&quot;;

    public Object getTransactionIdentifier(Transaction arg0) {
		return null;
    }

    public TransactionManager getTransactionManager(Properties props) throws HibernateException {
       /*
         * try { Kernel kernel = KernelRegistry.getSingleKernel(); ProxyManager
         * proxyManager = kernel.getProxyManager(); AbstractNameQuery query =
         * new AbstractNameQuery(TransactionManager.class.getName()); Set names =
         * kernel.listGBeans(query); AbstractName name = null; for (Iterator it =
         * names.iterator(); it.hasNext();) name = (AbstractName) it.next();
         * Object transMg = (Object) proxyManager.createProxy(name,
         * TransactionManager.class); return (TransactionManager)transMg; }catch
         * (Exception e) { e.printStackTrace(); System.out.println(); throw new
         * HibernateException(&quot;Geronimo Transaction Manager Lookup Failed&quot;, e); }
         */
       try {
       Kernel kernel = KernelRegistry.getSingleKernel();
       AbstractNameQuery query = new AbstractNameQuery(TransactionManager.class.getName ());
       Set&lt;AbstractName&gt; names = kernel.listGBeans(query);
       if (names.size() != 1) {
           throw new IllegalStateException(&quot;Expected one transaction manager, not &quot; + names.size());
       }
       AbstractName name = names.iterator().next();
       TransactionManager transMg = (TransactionManager)
       kernel.getGBean(name);
       return (TransactionManager)transMg;
       } catch (Exception e) {
           e.printStackTrace();
           System.out.println();
           throw new HibernateException(&quot;Geronimo Transaction Manager Lookup Failed&quot;, e);
       }
   }

    public String getUserTransactionName() {
        return UserTransactionName;
    }
}
]]></script>
</div></div>
<p>For your convenience this class is already provided in the <code>&lt;brokerage_home&gt;/TransactionManager</code> directory. Create the following directory structure and copy the <code>GeronimoTransactionManagerLookup.java</code> there.</p>

<p>*<code>brokerage_home&gt;/src/org/hibernate/transaction</code></p>

<p>Now you need to create the hibernate configuration file hibernate-cfg.xml. Inside this file you will specify the required hibernate configuration attributes. Note that the <code>hibernate-service.xml</code> in JBoss is for doing the same thing. For your convenience this file is also provided with the sample application in the <code>&lt;brokerage_home&gt;/hibrenate</code> directory.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>hibernate-cfg.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39;?&gt;
&lt;!DOCTYPE hibernate-configuration PUBLIC
        &quot;-//Hibernate/Hibernate Configuration DTD 3.0//EN&quot;
        &quot;http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd&quot;&gt;

&lt;hibernate-configuration&gt;
 &lt;session-factory&gt;
 &lt;!-- properties --&gt;
 &lt;property name=&quot;connection.datasource&quot;&gt;java:comp/env/jdbc/HibernateDB&lt;/property&gt;
 &lt;property name=&quot;hibernate.transaction.manager_lookup_class&quot;&gt;
    org.hibernate.transaction.GeronimoTransactionManagerLookup
 &lt;/property&gt;

  &lt;property name=&quot;hibernate.dialect&quot;&gt;org.hibernate.dialect.MySQLDialect&lt;/property&gt;

 &lt;!-- Disable the second-level cache  --&gt;
&lt;property name=&quot;hibernate.cache.provider_class&quot;&gt;org.hibernate.cache.NoCacheProvider&lt;/property&gt;
&lt;property name=&quot;hibernate.current_session_context_class&quot;&gt;org.hibernate.context.JTASessionContext&lt;/property&gt;
 &lt;!-- Echo all executed SQL to stdout --&gt;
 &lt;property name=&quot;hibernate.show_sql&quot;&gt;true&lt;/property&gt;

 &lt;!-- Drop and re-create the database schema on startup --&gt;
&lt;!--&lt;property name=&quot;hibernate.hbm2ddl.auto&quot;&gt;create&lt;/property&gt; --&gt;

 &lt;!-- mapping files --&gt;
 &lt;mapping resource=&quot;Stock.hbm.xml&quot;/&gt;
 &lt;mapping resource=&quot;UserStock.hbm.xml&quot;/&gt;
 &lt;mapping resource=&quot;User.hbm.xml&quot;/&gt;

 &lt;/session-factory&gt;
&lt;/hibernate-configuration&gt;
]]></script>
</div></div>
<p>Additional details for the specific functions of each of these properties can be found in the hibernate manual.</p>

<p>One last step before building is to create a <strong>geronimo-web.xml</strong> file which is the Geronimo specific deployment descriptor as illustrated in the following example. Once again, for your convenience this file is also provided with the sample application in the <code>&lt;brokerage_home&gt;/web/descriptors/geronimo</code> directory.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>geronimo-web.xml</b></div><div class="codeContent panelContent pdl">
<script class="brush: xml; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;
&lt;web-app xmlns=&quot;http://geronimo.apache.org/xml/ns/j2ee/web-1.1&quot; xmlns:naming=&quot;http://geronimo.apache.org/xml/ns/naming-1.1&quot;&gt;
    &lt;dep:environment xmlns:dep=&quot;http://geronimo.apache.org/xml/ns/deployment-1.1&quot;&gt;
	    &lt;dep:moduleId&gt;
		    &lt;dep:groupId&gt;BrokerageApp&lt;/dep:groupId&gt;
			&lt;dep:artifactId&gt;MySqlDS&lt;/dep:artifactId&gt;
			&lt;dep:version&gt;2.0&lt;/dep:version&gt;
			&lt;dep:type&gt;car&lt;/dep:type&gt;
		&lt;/dep:moduleId&gt;

		&lt;dep:dependencies&gt;
		    &lt;dep:dependency&gt;
		        &lt;dep:groupId&gt;user&lt;/dep:groupId&gt;
			    &lt;dep:artifactId&gt;database-pool-HibernateDB&lt;/dep:artifactId&gt;
			    &lt;dep:version&gt;2.0&lt;/dep:version&gt;
			    &lt;dep:type&gt;car&lt;/dep:type&gt;
			&lt;/dep:dependency&gt;
		&lt;/dep:dependencies&gt;

		&lt;dep:hidden-classes&gt;
		    &lt;dep:filter&gt;org.springframework&lt;/dep:filter&gt;
			&lt;dep:filter&gt;META-INF/spring&lt;/dep:filter&gt;
			&lt;!--dep:filter&gt;antlr&lt;/dep:filter--&gt;
		&lt;/dep:hidden-classes&gt;
	&lt;/dep:environment&gt;

	&lt;context-root&gt;/brokerage&lt;/context-root&gt;

    &lt;resource-ref&gt;
        &lt;ref-name&gt;jdbc/HibernateDB&lt;/ref-name&gt;
        &lt;resource-link&gt;HibernateDS&lt;/resource-link&gt;
    &lt;/resource-ref&gt;
&lt;/web-app&gt;
]]></script>
</div></div>
<p>The <code>&lt;hidden-classes&gt;</code> element is for preventing certain classes that come with Apache Geronimo from being visible to the war classloader which may result in version problems.</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Buildthemigratedsampleapplication">Build the migrated sample application</h2>

<p>To build the application run the following commands</p>
<ul><li>Add the hibernate jar to the classpath. You will now need to build hibernate with the <code>GeronimoTransactionManagerLookup</code> class. If you have not downloaded the hibernate source you can compile the class after putting the hibernate jar in the classpath and then manually add that class to the hibernate jar file.<br clear="none">
<code><strong>set CLASSPATH=%CLASSPATH%;&lt;hibernate_home&gt;/lib/hibernate3.jar</strong></code></li><li>Add the Geronimo kernel to your classpath<br clear="none">
<code><strong>set CLASSPATH=%CLASSPATH%;&lt;geronimo_home&gt;/lib/geronimo-kernel-2.2.jar</strong></code></li></ul>


<ul><li>To add the class manually, although not needed for this particular sample, you can use the tool of your preference and add the GeronimoTransactionManagerLookup.class to the <code>org\hibernate\transaction</code> directory in the <code>hibernate_home&gt;/lib/hibernate3.jar</code> file.</li></ul>


<ul><li>Now build the migrated application by running the following command:</li></ul>


<p><code><strong>&lt;brokerage_home&gt;/ant war</strong></code></p>

<p>Note that we are just building the <strong>war</strong> target because the Online Brokerage sample application is just a web application. In the JBoss section we used an <strong>ear</strong> to package the <strong>war</strong> and the <strong>har</strong>, this last one is not supported by Apache Geronimo.</p>

<p>This will create a <strong>brokerage.war</strong> file in the <strong>&lt;brokerage_home&gt;/geronimo-artefact</strong> directory.</p>

<p>The <strong>&lt;brokerage_home&gt;/solutions</strong> directory has the source files already migrated to compile for and run in Apache Geronimo.</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h2 id="JBosstoGeronimo-HibernateMigration-Deploythemigratedsampleapplication">Deploy the migrated sample application</h2>

<p>To deploy the migrated Online Brokerage application, make sure the Geronimo server is up and running and run the following command:</p>

<p><code><strong>deploy --user system --password manager deploy &lt;brokerage_home&gt;/geronimo-artefact/brokerage.war</strong></code></p>

<p>Once the application is deployed, open a Web browser and access the following URL:</p>

<p><a shape="rect" class="external-link" href="http://localhost:8080/brokerage" rel="nofollow">http://localhost:8080/brokerage</a></p>

<p>Login with the same user name and password you used when testing the application from JBoss.</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p>

<h1 id="JBosstoGeronimo-HibernateMigration-Summarysummary">Summary <span class="confluence-anchor-link" id="JBosstoGeronimo-HibernateMigration-summary"></span></h1>

<p>This article has shown you how to migrate a sample application that uses Hibernate as its O/R mapping layer, from JBoss to the Apache Geronimo application server. Some of the features/functionalities already provided by JBoss may not yet be implemented in Geronimo, as a consequence some minor additional coding may be required but the overall migration complexity is low.</p>

<p><a shape="rect" href="#JBosstoGeronimo-HibernateMigration-top">Back to Top</a></p></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="middle" class="footer">
            &nbsp;&nbsp;
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Delicious" />
            <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">Bookmark this on Delicious</a>
            &nbsp;&nbsp;
            <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="Digg!" />
            <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title)+'&amp;topic=programming');">Digg this</a>
            <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : JBoss to Geronimo - Hibernate Migration';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
            &nbsp;&nbsp;
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">Privacy Policy</a>&nbsp;&nbsp;-&nbsp;&nbsp;
            Copyright &#169; 2003-2013, The Apache Software Foundation, Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0.</a>&nbsp;&nbsp;
          </td>
        </tr>
    </table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  </body>
</html>
