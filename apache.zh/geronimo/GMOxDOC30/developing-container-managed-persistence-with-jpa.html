<html lang="zh-Hans" ><head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link type="text/css" rel="stylesheet" href="asset?aid=0">
    <link rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <link rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <meta name="Description" content="Developing container managed persistence with JPA">
    <meta name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi Developing container managed persistence with JPA">
    <meta name="Owner" content="dev@geronimo.apache.org">
    <meta name="Robots" content="index, follow">
    <meta name="Security" content="Public">
    <meta name="Source" content="wiki template">
    <meta name="DC.Date" scheme="iso8601" content="2010-05-11">
    <meta name="DC.Language" scheme="rfc1766" content="en">
    <meta name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation">
    <meta http-equiv="PICS-Label" content="(PICS-1.1 " http:="" ="" www.icra.org="" ratingsv02.htm="=" www.rsac.org="" ratingsv01.htm="=" (ss~~000="" 1)="=">

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>

  <link href="asset?aid=1" rel="stylesheet" type="text/css">
  <link href="asset?aid=2" rel="stylesheet" type="text/css">
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shCore.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushJava.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushXml.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushPlain.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushBash.js' type='text/javascript'></script>
  
  <script type="text/javascript">
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all();
  </script>

    <title>Apache Geronimo v3.0文档：使用JPA开发容器管理的持久性</title>
  </head>

  <body  onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tbody><tr>
        <td align="left" valing="top">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </tbody></table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tbody><tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" nowrap>
          <a href="/geronimo">主页</a> > <a href="documentation.html">文档</a> > <a href="developing.html">开发</a> > <a href="tutorials.html">教程</a> > <a href="developing-jpa-applications.html">开发JPA应用程序</a> > <a href="developing-container-managed-persistence-with-jpa.html">使用JPA开发容器管理的持久性</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8">
            <input type="hidden" name="oe" value="UTF-8">
            <input type="hidden" name="domains" value="">
            <input type="hidden" name="sitesearch" value="">
            <input type="text" name="q" value="" maxlength="255">        
            <input type="submit" name="btnG" value="谷歌搜索">
          </form>
        </td>
      </tr> 
    </tbody></table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding:6px 0px 0px 0px">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div class="smalltext" style="margin:0px 10px 0px 10px">Apache Geronimo v3.0</div>
        <div class="pagetitle" style="margin:0px 10px 8px 10px">使用JPA开发容器管理的持久性</div>

        <div class="greynavbar" align="right" style="padding:2px 10px;margin:0px">
<!-- --> <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645262"><img src="http://geronimo.apache.org/images/icons/notep_16.gif" height="16" width="16" border="0" title="编辑页面"></a> <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645262">编辑页面</a> <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30"><img src="http://geronimo.apache.org/images/icons/browse_space.gif" height="16" width="16" border="0" title="浏览空间"></a> <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">浏览空间</a> <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645262"><img src="http://geronimo.apache.org/images/icons/add_page_16.gif" height="16" width="16" border="0" title="添加页面"></a> <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645262">添加页面</a> <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645262"><img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif" height="16" width="16" border="0" title="新增新闻"></a> <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645262">新增新闻</a> <!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent">
<p>Java Persistence API是EJB3.0规范（JSR220）下的新编程模型，用于使用Java EE和Java SE管理持久性和对象/关系映射。使用JPA，开发人员可以轻松地开发Java应用程序，这些应用程序使用Java对象和映射在关系数据库管理系统上执行操作。这样，使用JPA开发的Java应用程序不仅可以跨不同平台移植，而且可以使用JPA提供的简单而强大的编程模型轻松开发应用程序。这极大地提高了应用程序在不断变化的数据库世界中的可维护性。JPA使应用程序与数据库连接和操作中涉及的所有复杂性和不可移植的样板代码隔离。</p>

<p>Apache geronimo使用<a shape="rect" class="external-link" href="http://openjpa.apache.org/">OpenJPA</a>向服务器中部署的Java EE应用程序提供Java Persistence API。即使JPA是EJB3.0规范的一部分，它也独立于JPA。因此，JPA可以以相同的统一方式用于JavaSE，Web和ejb应用程序。</p>

<p>下面的教程说明了容器管理的实体管理器对象的用法。使用@PersistenceContext批注时，容器将注入<code>EntityManager</code>反对参考。实体管理器的持久性上下文与当前活动的任何事务一起传播。如果事务跨组件，则指向同一持久性单元的所有实体管理器对象引用在整个事务中将具有相同的持久性上下文。因此，通过其他实体管理器引用可以看到通过任何实体管理器引用对实体所做的任何更改。容器管理的实体管理器的持久性范围是<code>Transaction</code>默认。的<code>transaction-type</code>总是<code>JTA</code> 。即，实体管理器对象总是向在实体管理器被调用时处于活动状态的事务注册。总之，容器自动管理实体管理器的生命周期和关联的持久性上下文。</p>

<p>本教程将创建一个具有ejb模块和Web模块的企业应用程序。ejb模块的用途<code>Account</code>与实体<code>AccountNumber</code>作为主键以及<code>OwnerName</code>和<code>Balance</code>属性以在中创建帐户<code>AccountDB</code>数据库。的<code>AccountDB</code>在嵌入式derby数据库中创建。的<code>AccountBean</code> ejb模块中的方法具有创建帐户实体，将金额存入帐户，从帐户中提取金额以及检索帐户中可用余额的方法。wed模块具有一个Servlet，可从用户那里检索源帐号，目标帐号和金额，并执行从源帐号到目标帐号的金额转移。</p>

<p>Web模块使用注入的容器<code>EntityManager</code>对象以检查源帐户是否有足够的可用余额来执行转帐。如果是，它将调用ejb从源帐户中提取金额并将相同的金额存入目标帐户。最后，servlet使用注入的<code>EntityManager</code>对象以打印源帐户和目标帐户中的余额。所有上述操作均在JTA事务内执行。因此，实体管理器的持久性上下文在Web和ejb模块之间传播。因此，在打印可用余额时，在Web模块中可以看到在ejb模块中对实体所做的任何更改。</p>

<p>为了开发，部署和运行该应用程序，需要以下环境。</p>

<ul><li>Sun JDK 5.0+（J2SE 1.5）</li><li>Eclipse 3.3.1.1（Europa发行版的Eclipse Classic软件包），特定于平台</li><li>Web工具平台（WTP）2.0.1</li><li>数据工具平台（DTP）1.5.1</li><li>Eclipse建模框架（EMF）2.3.1</li><li>图形编辑框架（GEF）3.3.1</li></ul>


<p>本教程分为以下几节。</p>
<style type="text/css">/*<![CDATA[*/
div.rbtoc1572612938584 {padding: 0px;}
div.rbtoc1572612938584 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1572612938584 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class="toc-macro rbtoc1572612938584">
<ul class="toc-indentation"><li><a shape="rect" href="#DevelopingcontainermanagedpersistencewithJPA-SettingtheEclipseenvironment">设置Eclipse环境</a></li><li><a shape="rect" href="#DevelopingcontainermanagedpersistencewithJPA-Creatingejbapplicationwithentities">使用实体创建ejb应用程序</a></li><li><a shape="rect" href="#DevelopingcontainermanagedpersistencewithJPA-Creatingwebapplication">创建Web应用程序</a></li><li><a shape="rect" href="#DevelopingcontainermanagedpersistencewithJPA-SettingupthedatabasetablesandtheDatasource">设置数据库表和数据源</a></li><li><a shape="rect" href="#DevelopingcontainermanagedpersistencewithJPA-Deployingthe(ear)application">部署（耳朵）应用程序</a></li></ul>
</div>

<p>可以从此<a shape="rect" href="developing-container-managed-persistence-with-jpa.data/ContainerManagedJPA-EAR.ear?version=1&modificationDate=1213308862000&api=v2" data-linked-resource-id="20873760" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="ContainerManagedJPA-EAR.ear" data-nice-type="Java Archive" data-linked-resource-content-type="application/octet-stream" data-linked-resource-container-id="20645262" data-linked-resource-container-version="47">链接</a>下载整个应用程序。</p>

<h2 id="DevelopingcontainermanagedpersistencewithJPA-SettingtheEclipseenvironment">设置Eclipse环境</h2>

<p>1。下载Apache Geronimo2.1并将其安装在服务器上。查看geronimo文档以了解<br clear="none">说明。</p>

<p>2。安装eclipse IDE，下载geronimo eclipse插件并将其安装在eclipse之上。看看<br clear="none">geronimo eclipse插件文档以获取指导。</p>

<p>3。在Eclipse中为Apache Geronimo2.1创建运行时环境。查看geronimo eclipse插件<br clear="none">有关为Apache Geronimo2.1安装运行时的说明的文档。</p>

<h2 id="DevelopingcontainermanagedpersistencewithJPA-Creatingejbapplicationwithentities">使用实体创建ejb应用程序</h2>

<p>1。打开eclipse工具，然后通过单击将透视图更改为<em>Java EE</em> 。<br clear="none">
   <em>Windows =>打开透视图=>其他</em> 。它将打开“ <em>打开透视图”</em>向导。<br clear="none">从列表中选择<em>Java EE</em> ，然后单击“ <em>确定”</em>按钮。</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/1.jpg"></span></p>

<p>2。右键单击<em>Package Explorer，</em>然后选择<em>EJB Project</em> 。</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/2.jpg"></span></p>

<p>3。这将打开“ <em>新建EJB项目”</em>向导。提供以下屏幕快照中给出的<em>Project Name</em> ， <em>Target Runtime</em>的值。单击<em>下一步</em>按钮。</p>
<div class="confluence-information-macro confluence-information-macro-note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"></span><div class="confluence-information-macro-body">
<p>如果未设置目标运行时，请创建一个指向geronimo安装目录的新目标运行时。有关更多信息，请参阅geronimo文档，该文档说明了为geronimo设置eclipse插件和设置运行时环境。需要此设置来解决编译期间的类依赖关系。</p></div></div>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/3.jpg"></span></p>

<p>4。选中下面的屏幕截图中给出的复选框，然后单击<em>下一步</em>按钮。</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/4.jpg"></span></p>

<p>5，选中以下屏幕截图中给出的复选框，然后单击<em>下一步</em>按钮。</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/5.jpg"></span></p>


<p>6。在文本框中提供以下值，然后单击“ <em>完成”</em>按钮。</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/6.jpg"></span></p>

<p>7。右键单击<em>ContainerManagedJPA-EJB</em>项目，然后导航到<em>New => Class</em>选项。提供<br clear="none">在<em>New Java Class</em>向导中输入以下值，然后单击<em>Finish</em>按钮。</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/7.jpg"></span></p>


<p>8。将以下内容复制到<code>Account.java</code> 。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>sample.jpa。Account.java</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
package sample.jpa;

import java.io.Serializable;
import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.PostLoad;
import javax.persistence.PostUpdate;
import javax.persistence.PrePersist;
import javax.persistence.PreUpdate;
import javax.persistence.Table;


@Entity
@Table(name = "ACCOUNTCME")
public class Account implements Serializable {

 @Id
 public int accountNumber;
 public String ownerName;
 public double balance;


 public Account() {
  accountNumber = (int) System.nanoTime();
 }

 public String toString() {
 return "Acc.# " + accountNumber + ", owner" + ownerName 
        + ", balance: " + balance
        + " $";
 }

 @PrePersist
 public void prepersist() {
  System.out.println("pre persist!!");
 }

 @PreUpdate
 public void preupdate() {
  System.out.println("pre update!!");
 }

 @PostUpdate
 public void postupdate() {
  System.out.println("post update!!");
 }

 @PostLoad
 public void postload() {
  System.out.println("post load!!");
 }

 public int getAccountNumber() {
  return accountNumber;
 }

 public void setAccountNumber(int accountNumber) {
  this.accountNumber = accountNumber;
 }

 public String getOwnerName() {
  return ownerName;
 }

 public void setOwnerName(String ownerName) {
  this.ownerName = ownerName;
 }

 public void setBalance(double balance) {
  this.balance = balance;
 }

 public double getBalance() {
 return balance;
 }
}
</pre>
</div></div>

<p>9。同样，创建<code>AccountInterface.java</code>并复制以下内容。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>sample.jpa。AccountInterface.java</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
package sample.jpa;

public interface AccountInterface {

 public Account open(int accountNumber) ;
 public double getBalance(int accountNumber);
 public void deposit(int accountNumber,double amount) ;
 public double withdraw(int accountNumber,double amount) ;
}
</pre>
</div></div>
<p>10。同样，创建<code>AccountBean.java.java</code>并复制以下内容。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>sample.jpa。AccountBean.java</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
package sample.jpa;


import javax.ejb.EJBException;
import javax.ejb.Remote;
import javax.ejb.Stateless;
import javax.ejb.TransactionAttribute;
import javax.ejb.TransactionAttributeType;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.PersistenceContextType;


@Stateless
@Remote(AccountInterface.class)
public class AccountBean implements AccountInterface { 

 @PersistenceContext(type=PersistenceContextType.TRANSACTION)    
 private EntityManager manager;


 @TransactionAttribute(TransactionAttributeType.REQUIRED)    
 public Account open(int accountNumber) {
  Account account = manager.find(Account.class, accountNumber);
  if(account == null){
   account = new Account();
   account.ownerName = "anonymous";
   account.accountNumber = accountNumber;
   manager.persist(account);
   return account;
  }else{
   throw new EJBException("Account already exists..!!. Account Number = "+accountNumber);
  }
 }    

 @TransactionAttribute(TransactionAttributeType.REQUIRED)    
 public double getBalance(int accountNumber) {
  Account account = manager.find(Account.class, accountNumber);
  if(account==null)
   throw new EJBException("Account not found..!!. Account Number = "+accountNumber);
  return account.balance;
 }

 @TransactionAttribute(TransactionAttributeType.REQUIRED)
 public void deposit(int accountNumber, double amount) {
  Account account = manager.find(Account.class, accountNumber);
  if(account==null)
   throw new EJBException("Account not found..!!. Account Number = "+accountNumber);
  double new_balance = account.getBalance() + amount;
  account.setBalance(new_balance);
 }

 @TransactionAttribute(TransactionAttributeType.REQUIRED)    
 public double withdraw(int accountNumber, double  amount) { 
  Account account = manager.find(Account.class, accountNumber);
  if(account==null)
   throw new EJBException("Account not found..!!. Account Number = "+accountNumber);
  if (amount &gt; account.getBalance()) {
   return 0;
  }else {
   double new_balance = account.getBalance() - amount;
   account.setBalance(new_balance);
   return amount;
  }
 }
}
</pre>
</div></div>

<p>11。如上所述，右键单击<code>META_INF</code>目录<code>ContainerManagedJPA-EJB</code>项目和<br clear="none">创建<code>persistence.xml</code> 。将以下内容复制到<code>persistence.xml</code> 。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>persistence.xml</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence"
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.0"
 xsi:schemaLocation="http://java.sun.com/xml/ns/persistence  
 http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd"&gt;

 &lt;persistence-unit name="AccountUnit" transaction-type="JTA"&gt;
  &lt;description&gt;ContainerManagedJPA&lt;/description&gt;
  &lt;provider&gt;org.apache.openjpa.persistence.PersistenceProviderImpl&lt;/provider&gt;
  &lt;jta-data-source&gt;AccountDS&lt;/jta-data-source&gt;
  &lt;class&gt;sample.jpa.Account&lt;/class&gt;
 &lt;/persistence-unit&gt;
&lt;/persistence&gt;
</pre>
</div></div>

<p>12由于我们将使用EJB注释，因此<code>META-INF/ejb-jar.xml</code>将没有任何声明。的内容<code>META-INF/openejb-jar.xml</code>文件应如下所示。否则，请进行相应的修改。</p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>openejb-jar.xml</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;openejb-jar xmlns="http://openejb.apache.org/xml/ns/openejb-jar-2.2" 
 xmlns:naming="http://geronimo.apache.org/xml/ns/naming-1.2" 
 xmlns:sec="http://geronimo.apache.org/xml/ns/security-2.0" 
 xmlns:sys="http://geronimo.apache.org/xml/ns/deployment-1.2"&gt;
 
 &lt;sys:environment&gt;
  &lt;sys:moduleId&gt;
   &lt;sys:groupId&gt;ContainerManagedJPA&lt;/sys:groupId&gt;
   &lt;sys:artifactId&gt;EJB&lt;/sys:artifactId&gt;
   &lt;sys:version&gt;1.0&lt;/sys:version&gt;
   &lt;sys:type&gt;car&lt;/sys:type&gt;
  &lt;/sys:moduleId&gt;

  &lt;dependencies&gt;
   &lt;dependency&gt;
    &lt;groupId&gt;console.dbpool&lt;/groupId&gt;
    &lt;artifactId&gt;AccountDS&lt;/artifactId&gt;
   &lt;/dependency&gt;
  &lt;/dependencies&gt;

 &lt;/sys:environment&gt;
 &lt;enterprise-beans/&gt;
 &lt;/openejb-jar&gt;
</pre>
</div></div>

<p>13最后的项目<code>ContainerManagedJPA-EJB</code>应该如下。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/8.jpg"></span></p>


<h2 id="DevelopingcontainermanagedpersistencewithJPA-Creatingwebapplication">创建Web应用程序</h2>

<p>1。右键单击<em>Project Explorer，</em>然后选择<em>New => Project</em> 。这将弹出“ <em>新建项目”</em>向导。<br clear="none">选择选项<em>Web</em>下的<em>Dynamic Web Project</em> 。单击<em>下一步</em>按钮。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/9.jpg"></span></p>

<p>2。提供下面的“ <em>新建动态Web项目”</em>向导中的屏幕快照中给出的值。请注意，选中“ <em>将项目添加到EAR”</em>复选框将此Web项目添加到在创建<em>ContainerManagedJPA-EJB</em>项目期间创建的<em>ContainerManagedJPA-</em> <em>EAR</em> 。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/10.jpg"></span></p>

<p>3。在下一个屏幕中，选择下图所示的“ <em>版本”</em>值，然后单击“ <em>下一步”</em>按钮。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/11.jpg"></span></p>

<p>4。选中<em>Generate Deployment Descriptor</em>复选框，然后单击<em>Next</em>按钮。在下一个屏幕上，如下配置部署计划。之后，单击“ <em>完成”</em>按钮以完成创建Web项目。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/12.jpg"></span></p>


<p>5，右键单击Web项目的<em>WebContent</em>文件夹，然后导航到<em>New => HTML</em>以创建如屏幕快照中所示的index.html文件。单击<em>下一步</em>按钮，然后在下一个屏幕上单击<em>完成</em>按钮。屏幕截图下方提供了index.html的内容。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/13.jpg"></span></p>

<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>index.html</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
&lt;title&gt;Input Account Numbers and Amount&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;form name="input" action="/ContainerManagedJPA-WEB/Test"method="get"&gt;
&lt;table border="0"&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="5"&gt; Debit Account Number&lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" name="account1"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="5"&gt; Credit Account Number&lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" name="account2"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="5"&gt; Amount to be Transfered &lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" name="amount"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;input type="submit" value="Submit"&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
</div></div>


<p>6。右键单击Web项目，然后导航到<em>New => Servlet</em>并单击它。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/14.jpg"></span></p>


<p>7。在“ <em>创建Servlet”</em>向导中，提供以下屏幕快照中给出的值，然后单击“ <em>下一步”</em>按钮。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/15.jpg"></span></p>

<p>8。在接下来的屏幕中选择默认值，最后单击“ <em>完成”</em>按钮。</p>


<p>9。将以下内容复制到servlet中<code>Test.java</code></p>
<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px;border-bottom-style:solid"><b>Test.java</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
package sample.jpa;

import java.io.IOException;
import java.io.PrintWriter;

import javax.ejb.EJB;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.transaction.UserTransaction;

public class Test extends javax.servlet.http.HttpServlet 
 implements javax.servlet.Servlet {

 static final long serialVersionUID = 1L;

 @PersistenceContext(unitName="AccountUnit")
 private EntityManager em;

 @EJB AccountInterface accountBean;

 public Test() {
  super();
 }   	

 protected void doGet(HttpServletRequest request, 
                      HttpServletResponse response) 
                      throws ServletException, 
                      IOException {


 PrintWriter out = response.getWriter();

 int accNo1 = Integer.parseInt(
              request.getParameter("account1"));
 int  accNo2 = Integer.parseInt(
              request.getParameter("account2"));
 double amount = Double.parseDouble(
                 request.getParameter("amount"));

 try{
  Context ctx = new InitialContext();
  UserTransaction ut = (UserTransaction)
                        ctx.lookup("java:comp/UserTransaction");
  ut.begin();

  Account account = em.find(Account.class, accNo1);
  if(account.getBalance() &lt; amount){
   throw new Exception("&lt;font size=5&gt;Account "+accNo1+
         " does not have enough balance "+amount+"&lt;/font&gt;");
  }else{
   outputText(out, "2", "green", 
              "Message : Getting the balance amount available in Account Number "
              +accNo1+" in the Test Servlet");

   outputText(out, "5", "black","Account ="+
              accNo1+" : Current balance "+account.getBalance());
   out.println("&lt;br/&gt;");

   outputText(out, "2", "green","Message : Withdrawing amount ("+
              amount+") using AccountBean from the Account Number "+accNo1);

   accountBean.withdraw(accNo1, amount);

   outputText(out, "2", "green",
     "Message : Getting the balance amount available in Account Number "+accNo1+
     " in the Test Servlet after withdrawing");

   double balance = account.getBalance();
   outputText(out, "5", "black","Account ="+accNo1+
   " : After withdrawing the balance is "+balance);
   out.println("&lt;br/&gt;");

   outputText(out, "2", "green",
    "Message : Getting the balance amount available in Account Number "+
    accNo2+" in the Test Servlet");

   Account account2 = em.find(Account.class, accNo2);
   outputText(out, "5", "black","Account ="+
    accNo2+" : Current balance "+account2.getBalance());
   
   out.println("&lt;br/&gt;");

   outputText(out, "2", "green",
    "Message : depositing amount ("+amount+
    ") using AccountBean to the Account Number "+accNo2);

   accountBean.deposit(accNo2, amount);
   outputText(out, "2", "green",
   "Message : Getting the balance amount available in Account Number "+
   accNo2+" in the Test Servlet after depositing");

   outputText(out, "5", "black","Account ="+
              accNo2+" : After depositing the balance is "+
              account2.getBalance());

   out.println("&lt;br/&gt;");
   }
  ut.commit();
  }catch(Exception e){
  throw new ServletException(e);
 }
}  	

 protected void doPost(HttpServletRequest request, 
                       HttpServletResponse response) 
                       throws ServletException, IOException {
 }   	

 private void outputText(PrintWriter out, 
                         String fontsize, 
                         String color,
                         String text){
  out.println("&lt;font size="+fontsize+" color="+
                color+"&gt;"+text+"&lt;/font&gt;"+"&lt;br/&gt;");
 }
}
</pre>
</div></div>

<p>10。右键点击<code>ContainerManagedJPA-WEB</code>项目，然后单击<em>属性</em>以打开<em>ContainerManagedJPA-WEB</em>向导的<em>属性</em> 。单击<em>Java构建路径</em>和<em>项目</em>选项卡。单击<em>添加</em>按钮并添加<code>ContainerManagedJPA-EJB</code>项目。最后，在<em>ContainerManagedJPA-WEB</em>向导的<em>Properties</em>上单击<em>OK</em>按钮。这是必需的，因为， <code>ContainerManagedJPA-WEB</code>项目查找<code>AccountInterface</code> ejb在<code>ContainerManagedJPA-EJB</code>项目。为了解决编译期间的依赖性，必须将EJB项目添加到WEB项目的构建路径。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/16.jpg"></span></p>


<h2 id="DevelopingcontainermanagedpersistencewithJPA-SettingupthedatabasetablesandtheDatasource">设置数据库表和数据源</h2>

<p>1。启动geronimo服务器，并在带有url的浏览器窗口中打开管理控制台<br clear="none">
   <a shape="rect" class="external-link" href="http://localhost:8080/console" rel="nofollow">http：// localhost：8080 / console</a> 。</p>

<p>2。单击<em>控制台导航</em> portlet上的<em>Embedded DB => DB Manager</em> 。</p>

<p>3。在右侧的<em>Run SQL</em> portlet上，在<em>Create DB</em>文本框中输入<em>AccountDB</em> ，然后单击<br clear="none">
  <em>创建</em>按钮。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/17.jpg"></span></p>

<p>4。上面的步骤将创建<code>AccountDB</code>数据库。在同一屏幕上，在“ <em>SQL命令”</em>文本区域中输入以下SQL命令，然后在“ <em>使用数据库”</em>组合框中选择<em>AccountDB</em> ，然后单击“ <em>运行SQL”</em>按钮。这将在<em>AccountDB</em>数据库中创建<em>ACCOUNTCME</em>表。</p>

<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
create table ACCOUNTCME (ACCOUNTNUMBER integer, OWNERNAME varchar(100), BALANCE decimal(15,2));
</pre>
</div></div>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/18.jpg"></span></p>

<p>5，另外，使用以下SQL命令插入两行。</p>

<div class="code panel pdl" style="border-style:solid;border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
insert into ACCOUNTCME values (1, 'Phani',2000);
insert into ACCOUNTCME values (2, 'Nag',2000);
</pre>
</div></div>

<p>插入行后，表格将如下图所示。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/19.jpg"></span></p>


<p>6。我们需要通过AccountDB数据库为JPA部署数据源。 JPA将使用此数据源连接到数据库并执行DML操作。管理控制台可用于通过AccountDB部署数据源。单击<em>控制台=>导航</em> portlet中的<em>服务=>数据库池</em> 。这将显示服务器中当前正在运行的数据库池的列表。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/20.jpg"></span></p>


<p>7。单击<em>使用Geronimo数据库池向导</em>链接。这将打开<em>数据库池</em> portlet，如下所示。将<em>“数据库池的名称”</em>的值提供为<em>AccountDS，</em>然后按如下所示选择“ <em>嵌入式Derby”</em> ，然后单击“ <em>下一步”</em>按钮。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/21.jpg"></span></p>


<p>8。在下一个屏幕上，选择“ <em>驱动程序JAR”</em>选择框中列出的JAR文件，并提供<em>AccountDB</em>作为“数据库名称”的值，然后单击底部的“ <em>部署”</em>按钮。这将部署数据源并显示服务器上当前部署的数据源列表。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/22.jpg"></span></p>

<p>9。在月食中，打开<code>openejb-jar.xml</code>并提供对<code>AccountDS</code> 。最后， <code>openejb-jar.xml</code>应该如下。<em>使用</em>上述<em>实体</em>在<em>创建ejb应用程序</em>的步骤12中已经完成了此配置</p>

<h2 id="DevelopingcontainermanagedpersistencewithJPA-Deployingthe(ear)application">部署（耳朵）应用程序</h2>

<p>1。如下部署EAR文件</p>
<div class="preformatted panel" style="border-style:solid;border-width:1px"><div class="preformattedContent panelContent">
<pre>C:\Geronimo-2.1\bin&gt;deploy.bat --user system --password manager deploy c:\temp\ContainerManagedJPA-EAR.ear
Using GERONIMO_BASE:   C:\Geronimo-2.1
Using GERONIMO_HOME:   C:\Geronimo-2.1
Using GERONIMO_TMPDIR: var\temp
Using JRE_HOME:        C:\SDK-May-31-2007\jre
    Deployed default/ContainerManagedJPA-EAR/1.0/car
      `-&gt; ContainerManagedJPA-WEB.war @ /ContainerManagedJPA-WEB
      `-&gt; ContainerManagedJPA-EJB.jar</pre>
</div></div>


<p>22运行应用程序</p>

<p>1。打开浏览器窗口，然后按<a shape="rect" class="external-link" href="http://localhost:8080/ContainerManagedJPA-WEB/" rel="nofollow">http：// localhost：8080 / ContainerManagedJPA-WEB /</a> <br clear="none">此页面显示html表单，其中包含<em>借方帐号</em> ， <em>贷方帐号</em>和<em>要转帐金额的</em>输入字段。输入以下屏幕截图中给出的值，然后单击<em>Submit</em>按钮。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/23.jpg"></span></p>

<p>2。在下一页上，显示以下消息。从消息中可以看到，持久性上下文随事务一起传播，因此在servlet中可以观察到ejb中对Account balance的更改。 <code>account.getBalance(accountNumber)</code>叫做。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/24.jpg"></span></p>

<p>3。余额字段中的值<code>ACCOUNTCME</code>交易后的表格如下。</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/25.jpg"></span></p></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tbody><tr>
          <td align="left" valign="middle" class="footer">
              
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="美味的"> <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&noui&jump=close&url='+encodeURIComponent(location.href)+'&title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">在Delicious上添加书签</a> <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="掘客！"> <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&title='+encodeURIComponent(document.title)+'&topic=programming');">挖这个</a> <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : Developing container managed persistence with JPA';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
              
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">隐私权政策</a> -版权所有©2003-2013，Apache软件基金会，根据<a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0</a>许可<a href="http://www.apache.org/licenses/LICENSE-2.0">。</a>  
          </td>
        </tr>
    </tbody></table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  

</body></html>