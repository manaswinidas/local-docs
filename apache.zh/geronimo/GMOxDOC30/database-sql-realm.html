<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="http://geronimo.apache.org/style/default.css">
    <LINK rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <LINK rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <META name="Description" content="Database (SQL) Realm" />
    <META name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi Database (SQL) Realm" />
    <META name="Owner" content="dev@geronimo.apache.org" />
    <META name="Robots" content="index, follow" />
    <META name="Security" content="Public" />
    <META name="Source" content="wiki template" />
    <META name="DC.Date" scheme="iso8601" content="2010-05-11" />
    <META name="DC.Language" scheme="rfc1766" content="en" />
    <META name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation" />
    <META http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html" l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html" l gen true r (n 0 s 0 v 0 l 0) "http://www.classify.org/safesurf/" l gen true r (SS~~000 1))'/>

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>


    <title>Apache Geronimo v3.0 Documentation: Database (SQL) Realm</title>
  </head>

  <body onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tr>
        <td valing="top" align="left">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" align="left" nowrap>
          <a href="/geronimo"> Home</a> >&nbsp;<a href="documentation.html">Documentation</a>&nbsp;&gt;&nbsp;<a href="configuring-and-administering.html">Configuring and administering</a>&nbsp;&gt;&nbsp;<a href="administering-security.html">Administering Security</a>&nbsp;&gt;&nbsp;<a href="administering-security-realms.html">Administering security realms</a>&nbsp;&gt;&nbsp;<a href="database-sql-realm.html">Database (SQL) Realm</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
        </td>
      </tr> 
    </table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div style="margin: 0px 10px 0px 10px" class="smalltext">Apache Geronimo v3.0</div>
        <div style="margin: 0px 10px 8px 10px"  class="pagetitle">Database (SQL) Realm</div>

        <div class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
<!-- -->         
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645338">
            <img src="http://geronimo.apache.org/images/icons/notep_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Edit Page"></a>
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645338">Edit Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">
            <img src="http://geronimo.apache.org/images/icons/browse_space.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Browse Space"></a>
            <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">Browse Space</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645338">
            <img src="http://geronimo.apache.org/images/icons/add_page_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add Page"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645338">Add Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645338">
            <img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add News"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645338">Add News</a>
<!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent"><plain-text-body>{scrollbar}</plain-text-body>
<p>In this section we will focus on the use a database for verifying and retrieving user names and passwords.</p>

<p>For this example we created a new database called <strong>SecurityDatabase</strong> using the built-in Derby database. The following steps summarize the procedure performed to create the database and tables, load some sample data and create the connection pool. Detailed instructions on how to define database connection pools are described in the Configuring database pools section.</p>

<h3 id="Database(SQL)Realm-Createdatabaseandloadsampledata">Create database and load sample data</h3>

<ul><li>In the <strong>Console Navigation</strong> menu on the left click on <strong>DB Manager</strong>.</li><li>Enter <strong>SecurityDatabase</strong> in the <strong>Create DB:</strong> field and click <strong>Create</strong>.</li><li>Select the <strong>SecurityDatabase</strong> database from the <strong>Use DB:</strong> pull-down menu, enter the following commands and click <strong>Run SQL</strong>.
<plain-text-body>
create table users(username varchar(15),
                   password varchar(15));
create table groups(username varchar(15),
                   groupname varchar(15));
insert into users values('userone','p1');
insert into users values('usertwo','p2');
insert into users values('userthree','p3');
insert into groups values('userone','admin');
insert into groups values('usertwo','admin');
insert into groups values('userthree','user');
</plain-text-body></li></ul>


<h3 id="Database(SQL)Realm-Createconnectionpool">Create connection pool</h3>

<ul><li>In the <strong>Console Navigation</strong> menu on the left click on <strong>Database Pools</strong>.</li><li>Click on <strong>Using the Geronimo database pool wizard</strong>.</li><li>Enter <strong>SecurityDatabasePool</strong> as the database pool name.</li><li>Select <strong>Derby embedded XA</strong> from the database pool type pull-down menu and click <strong>Next</strong>.</li><li>From the Driver JAR scroll box select <strong>org.apache.geronimo.configs/system-database/2.1.1-SNAPSHOT/car</strong>.</li><li>Leave <strong>blank</strong> the DB user name and password.</li><li>Enter <strong>SecurityDatabase</strong> as the database name.</li><li>Click <strong>Deploy</strong>.</li></ul>


<h3 id="Database(SQL)Realm-Addanewsecurityrealm">Add a new security realm</h3>

<p>To create a new security realm click on <strong>Add new security realm</strong> from the <strong>Security Realms</strong> portlet.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="database-sql-realm.data/consoleDBSecurityRealmAdd.png"></span></p>

<p>Enter <strong>derby_security_realm</strong> in the <strong>Name of Security Realm:</strong> field and select <strong>Database (SQL) Realm</strong> from the <strong>Realm type:</strong> pull-down menu and click <strong>Next</strong>.</p>

<p>The following screen configures the login module. The first two field you need to fill may vary from one database type to another. In this case we are using the embedded Derby database so the User and Group select SQL should read as follows:</p>

<p><strong>User SELECT SQL:</strong> <code>select username, password from users where username=?</code><br clear="none">
<strong>Group SELECT SQL:</strong> <code>select username, groupname from groups where username=?</code></p>

<p>Once you entered the SQL statements for retrieving users and groups you need to select from the <strong>Database Pool</strong> pull-down menu the database connection pool you created in the previous step. Add the required values as shown below and click <strong>Next</strong>.</p>

<p><strong>Database Pool:</strong> <strong><code>SecurityDatabasePool</code></strong></p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="database-sql-realm.data/consoleSecurityConfigureLogin.png"></span></p>

<p>The following step will allow you to enable auditing for monitoring the login attempts via this realm. In this step you can also configure the account lockout based on the number of failed loging attempts withing a specified timeframe. If you enable <strong>Store Password</strong>, then it will allow the realm to store the user's password in a private credential in the "Subject". If you enable <strong>Naming Credential</strong>, in addition to the user's password, this option will use private credentials to store user names too.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="database-sql-realm.data/consoleSecurityAdvancedConfiguration.png"></span></p>

<p>At this point you have configured this new security realm, the next step i to test it and then deploy it. Click on <strong>Test a Login</strong>.</p>

<p>Enter a valid user name and password to be retrieved from the database and click <strong>Next</strong>.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="database-sql-realm.data/consoleSecurityUserTest.png"></span></p>

<p>You should receive a confirmation message that the login succeeded, click on <strong>Deploy Realm</strong> to load this configuration to the server.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="database-sql-realm.data/consoleSecurityUserTestSuccess.png"></span></p>

<p>Now you have a new, fully configured, security realm that retrieves user names and passwords from the build in Derby database.</p>

<rich-text-body><p>If you get an error the first time you try to validate this realm, you will very likely see the <strong><code>SQL Exception: Failed to start database ...</code></strong> error in the terminal and logs. This is a know issue with Derby, you will need to restart Geronimio so the new database can communicate properly.</p></rich-text-body>

<p>The following example shows the deployment plan for this security realm. As an alternative to the Geronimo Administration Console, you can save this example to a file (i.e. derby_security_realm.xml) and deploy it with the <a shape="rect" href="tools-and-commands.html">Deployer tool</a> by running the following command:</p>

<parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;geronimo_home&gt;\bin\deploy --user system --password manager deploy derby_security_realm.xml
</plain-text-body>

<parameter ac:name="">xml</parameter><parameter ac:name="title">derby_security_realm</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;module xmlns="http://geronimo.apache.org/xml/ns/deployment-1.2"&gt;
    &lt;environment&gt;
        &lt;moduleId&gt;
            &lt;groupId&gt;console.realm&lt;/groupId&gt;
            &lt;artifactId&gt;derby_security_realm&lt;/artifactId&gt;
            &lt;version&gt;1.0&lt;/version&gt;
            &lt;type&gt;car&lt;/type&gt;
        &lt;/moduleId&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.apache.geronimo.framework&lt;/groupId&gt;
                &lt;artifactId&gt;j2ee-security&lt;/artifactId&gt;
                &lt;type&gt;car&lt;/type&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;console.dbpool&lt;/groupId&gt;
                &lt;artifactId&gt;SecurityDatabasePool&lt;/artifactId&gt;
                &lt;version&gt;1.0&lt;/version&gt;
                &lt;type&gt;car&lt;/type&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/environment&gt;
    &lt;gbean name="derby_security_realm" class="org.apache.geronimo.security.realm.GenericSecurityRealm" xsi:type="dep:gbeanType"
           xmlns:dep="http://geronimo.apache.org/xml/ns/deployment-1.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;
        &lt;attribute name="realmName"&gt;derby_security_realm&lt;/attribute&gt;
        &lt;reference name="ServerInfo"&gt;
            &lt;name&gt;ServerInfo&lt;/name&gt;
        &lt;/reference&gt;
        &lt;xml-reference name="LoginModuleConfiguration"&gt;
            &lt;log:login-config xmlns:log="http://geronimo.apache.org/xml/ns/loginconfig-2.0"&gt;
                &lt;log:login-module control-flag="REQUIRED" wrap-principals="false"&gt;
                    &lt;log:login-domain-name&gt;derby_security_realm&lt;/log:login-domain-name&gt;
                    &lt;log:login-module-class&gt;org.apache.geronimo.security.realm.providers.SQLLoginModule&lt;/log:login-module-class&gt;
                    &lt;log:option name="dataSourceName"&gt;SecurityDatabasePool&lt;/log:option&gt;
                    &lt;log:option name="dataSourceApplication"&gt;null&lt;/log:option&gt;
                    &lt;log:option name="groupSelect"&gt;select username, groupname from groups where username=?&lt;/log:option&gt;
                    &lt;log:option name="userSelect"&gt;select username, password from users where username=?&lt;/log:option&gt;
                &lt;/log:login-module&gt;
                &lt;log:login-module control-flag="OPTIONAL" wrap-principals="false"&gt;
                    &lt;log:login-domain-name&gt;derby_security_realm-Audit&lt;/log:login-domain-name&gt;
                    &lt;log:login-module-class&gt;org.apache.geronimo.security.realm.providers.FileAuditLoginModule&lt;/log:login-module-class&gt;
                    &lt;log:option name="file"&gt;var/log/derby_security_realm.log&lt;/log:option&gt;
                &lt;/log:login-module&gt;
                &lt;log:login-module control-flag="REQUISITE" wrap-principals="false"&gt;
                    &lt;log:login-domain-name&gt;derby_security_realm-Lockout&lt;/log:login-domain-name&gt;
                    &lt;log:login-module-class&gt;org.apache.geronimo.security.realm.providers.RepeatedFailureLockoutLoginModule&lt;/log:login-module-class&gt;
                    &lt;log:option name="failureCount"&gt;3&lt;/log:option&gt;
                    &lt;log:option name="failurePeriodSecs"&gt;10&lt;/log:option&gt;
                    &lt;log:option name="lockoutDurationSecs"&gt;60&lt;/log:option&gt;
                &lt;/log:login-module&gt;
            &lt;/log:login-config&gt;
        &lt;/xml-reference&gt;
    &lt;/gbean&gt;
&lt;/module&gt;
</plain-text-body>

<p>Once the security realm has been created, you can use the <strong>usage</strong> link to view samples of how to use the new realm in your applications.</p></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="middle" class="footer">
            &nbsp;&nbsp;
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Delicious" />
            <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">Bookmark this on Delicious</a>
            &nbsp;&nbsp;
            <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="Digg!" />
            <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title)+'&amp;topic=programming');">Digg this</a>
            <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : Database (SQL) Realm';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
            &nbsp;&nbsp;
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">Privacy Policy</a>&nbsp;&nbsp;-&nbsp;&nbsp;
            Copyright &#169; 2003-2013, The Apache Software Foundation, Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0.</a>&nbsp;&nbsp;
          </td>
        </tr>
    </table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  </body>
</html>
