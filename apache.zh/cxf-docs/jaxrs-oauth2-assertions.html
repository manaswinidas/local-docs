<html ><head>

<link type="text/css" rel="stylesheet" href="/resources/site.css">
<script src='/resources/space.js'></script>

<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<meta name="keywords" content="business integration, EAI, SOA, Service Oriented Architecture, web services, SOAP, JBI, JMS, WSDL, XML, EDI, Electronic Data Interchange, standards support, integration standards, application integration, middleware, software, solutions, services, CXF, open source">
<meta name="description" content="Apache CXF, Services Framework - JAXRS OAuth2 Assertions">


<link type="text/css" rel="stylesheet" href="/resources/highlighter/styles/shCoreCXF.css">
<link type="text/css" rel="stylesheet" href="/resources/highlighter/styles/shThemeCXF.css">

<script src='/resources/highlighter/scripts/shCore.js'></script>
<script src='/resources/highlighter/scripts/shBrushJava.js'></script>
<script src='/resources/highlighter/scripts/shBrushXml.js'></script>
<script src='/resources/highlighter/scripts/shBrushBash.js'></script>
<script>
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all();
</script>


    <title>Apache CXF-JAXRS OAuth2断言</title>
  </head>
<body  onload="init()">


<table width="100%" cellpadding="0" cellspacing="0">
  <tbody><tr>
    <td id="cell-0-0" colspan="2"> </td>
    <td id="cell-0-1"> </td>
    <td id="cell-0-2" colspan="2"> </td>
  </tr>
  <tr>
    <td id="cell-1-0"> </td>
    <td id="cell-1-1"> </td>
    <td id="cell-1-2">
      <!-- Banner -->
<div class="banner" id="banner"><div><table border="0" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td align="left" colspan="1" nowrap>
<a shape="rect" href="http://cxf.apache.org/" title="Apache CXF"><span style="font-weight:bold;font-size:170%;color:white">Apache CXF</span></a>
</td><td align="right" colspan="1" nowrap>
<a shape="rect" href="http://www.apache.org/" title="阿帕奇软件基金会"><img border="0" alt="ASF徽标" src="http://cxf.apache.org/images/asf-logo.png"></a>
</td></tr></tbody></table></div></div>
      <!-- Banner -->
      <div id="top-menu">
        <table border="0" cellpadding="1" cellspacing="0" width="100%">
          <tbody><tr>
            <td>
              <div align="left">
                <!-- Breadcrumbs --> <a href="index.html">索引</a> > <a href="restful-services.html">RESTful服务</a> > <a href="jax-rs.html">JAX-RS</a> > <a href="jax-rs-oauth2.html">JAX-RS OAuth2</a> > <a href="jaxrs-oauth2-assertions.html">JAXRS OAuth2断言</a> <!-- Breadcrumbs -->
              </div>
            </td>
            <td>
              <div align="right">
                <!-- Quicklinks -->
<div id="quicklinks"><p><a shape="rect" href="http://cxf.apache.org/download.html">下载</a> | <a shape="rect" href="http://cxf.apache.org/docs/index.html">文献资料</a></p></div>
                <!-- Quicklinks -->
              </div>
            </td>
          </tr>
        </tbody></table>
      </div>
    </td>
    <td id="cell-1-3"> </td>
    <td id="cell-1-4"> </td>
  </tr>
  <tr>
    <td id="cell-2-0" colspan="2"> </td>
    <td id="cell-2-1">
      <table>
        <tbody><tr valign="top">
          <td height="100%">
            <div id="wrapper-menu-page-right">
              <div id="wrapper-menu-page-top">
                <div id="wrapper-menu-page-bottom">
                  <div id="menu-page">
                    <!-- NavigationBar -->
<div id="navigation"><ul class="alternate"><li><a shape="rect" href="overview.html">总览</a></li><li><a shape="rect" href="how-tos.html">操作方法</a></li><li><a shape="rect" href="frontends.html">前端</a></li><li><a shape="rect" href="databindings.html">数据绑定</a></li><li><a shape="rect" href="transports.html">运输工具</a></li><li><a shape="rect" href="configuration.html">组态</a></li><li><a shape="rect" href="debugging-and-logging.html">调试和记录</a></li><li><a shape="rect" href="tools.html">工具类</a></li><li><a shape="rect" href="restful-services.html">RESTful服务</a></li><li><a shape="rect" href="wsdl-bindings.html">WSDL绑定</a></li><li><a shape="rect" href="service-routing.html">服务路由</a></li><li><a shape="rect" href="dynamic-languages.html">动态语言</a></li><li><a shape="rect" href="ws-support.html">WS- *支持</a></li><li><a shape="rect" href="advanced-integration.html">进阶整合</a></li><li><a shape="rect" href="deployment.html">部署方式</a></li><li><a shape="rect" href="schemas-and-namespaces.html">模式和命名空间的使用</a></li></ul><hr><ul class="alternate"><li><p>搜索</p></li></ul><form id="cse-search-box" enctype="application/x-www-form-urlencoded" method="get" action="http://www.google.com/cse">
  <div>
    <input type="hidden" name="cx" value="002890367768291051730:o99qiwa09y4">
    <input type="hidden" name="ie" value="UTF-8">
    <input type="text" name="q" size="21">
    <input type="submit" name="sa" value="搜索">
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script><hr><ul class="alternate"><li><a shape="rect" href="http://cxf.apache.org/javadoc/latest/">API 3.2.x（Javadoc）</a></li><li><a shape="rect" href="http://cxf.apache.org/javadoc/latest-3.1.x/">API 3.1.x（Javadoc）</a></li><li><a shape="rect" href="http://cxf.apache.org/">CXF网站</a></li></ul><p> </p><p><a shape="rect" class="external-link" href="http://www.apache.org/events/current-event.html"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image confluence-external-resource" src="http://www.apache.org/events/current-event-125x125.png" data-image-src="http://www.apache.org/events/current-event-125x125.png"></span></a></p></div>
                    <!-- NavigationBar -->
                  </div>
              </div>
            </div>
          </div>
         </td>
         <td height="100%">
           <!-- Content -->
           <div class="wiki-content">
<div id="ConfluenceContent"><h1 id="JAXRSOAuth2Assertions-JAXRS:OAuth2Assertions">JAXRS：OAuth2断言</h1><p><style type="text/css">/*<![CDATA[*/
div.rbtoc1524513436151 {padding: 0px;}
div.rbtoc1524513436151 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1524513436151 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style></p><div class="toc-macro rbtoc1524513436151">
<ul class="toc-indentation"><li><a shape="rect" href="#JAXRSOAuth2Assertions-JAXRS:OAuth2Assertions">JAXRS：OAuth2断言</a></li><li><a shape="rect" href="#JAXRSOAuth2Assertions-Introduction">介绍</a></li><li><a shape="rect" href="#JAXRSOAuth2Assertions-SAML2Bearer">SAML2承载</a>
<ul class="toc-indentation"><li><a shape="rect" href="#JAXRSOAuth2Assertions-Mavendependencies">Maven依赖</a></li><li><a shape="rect" href="#JAXRSOAuth2Assertions-AccessTokenGrant">访问令牌授予</a>
<ul class="toc-indentation"><li><a shape="rect" href="#JAXRSOAuth2Assertions-Clientcode">客户代码</a></li><li><a shape="rect" href="#JAXRSOAuth2Assertions-AccessTokenService">访问令牌服务</a></li></ul>
</li><li><a shape="rect" href="#JAXRSOAuth2Assertions-AuthenticationToken">认证令牌</a>
<ul class="toc-indentation"><li><a shape="rect" href="#JAXRSOAuth2Assertions-ClientCode">客户代码</a></li><li><a shape="rect" href="#JAXRSOAuth2Assertions-AccessTokenService.1">访问令牌服务</a></li></ul>
</li><li><a shape="rect" href="#JAXRSOAuth2Assertions-ClientActingonBehalfofItself">客户代表自己行事</a></li></ul>
</li><li><a shape="rect" href="#JAXRSOAuth2Assertions-JWTBearer">智威汤逊承载</a>
<ul class="toc-indentation"><li><a shape="rect" href="#JAXRSOAuth2Assertions-AccessTokenGrant.1">访问令牌授予</a>
<ul class="toc-indentation"><li><a shape="rect" href="#JAXRSOAuth2Assertions-Clientcode.1">客户代码</a></li><li><a shape="rect" href="#JAXRSOAuth2Assertions-AccessTokenService.2">访问令牌服务</a></li></ul>
</li><li><a shape="rect" href="#JAXRSOAuth2Assertions-AuthenticationToken.1">认证令牌</a>
<ul class="toc-indentation"><li><a shape="rect" href="#JAXRSOAuth2Assertions-ClientCode.1">客户代码</a></li><li><a shape="rect" href="#JAXRSOAuth2Assertions-AccessTokenService.3">访问令牌服务</a></li></ul>
</li></ul>
</li></ul>
</div><h1 id="JAXRSOAuth2Assertions-Introduction">介绍</h1><p><a shape="rect" class="external-link" href="https://tools.ietf.org/html/rfc6749" rel="nofollow">OAuth 2.0</a>支持不同类型的访问令牌授予。<a shape="rect" class="external-link" href="http://tools.ietf.org/html/rfc7521" rel="nofollow">OAuth2断言</a>规范“以新的客户端验证机制和新的授权授予类型的形式，为OAuth 2.0提供了使用断言的框架”。更具体地说， <a shape="rect" class="external-link" href="https://tools.ietf.org/html/rfc7522" rel="nofollow">用于OAuth2</a>的<a shape="rect" class="external-link" href="https://tools.ietf.org/html/rfc7522" rel="nofollow">SAML2 Bearer断言配置文件</a>规范提供了SAML2 Bearer断言的使用，以及<a shape="rect" class="external-link" href="http://tools.ietf.org/html/rfc7523" rel="nofollow">用于OAuth 2.0客户端身份验证和授权授予</a>规范提供者的<a shape="rect" class="external-link" href="http://tools.ietf.org/html/rfc7523" rel="nofollow">JSON Web令牌（JWT）概要文件</a> ，以使用JWT Bearer令牌。</p><p>这些断言可以用作令牌授予，也可以在需要时用于对第三方客户端进行身份验证。请注意，客户端可以将断言用作授予，但可以使用例如基本身份验证机制，或者使用授权码授予和断言来进行身份验证，最后，客户可以将断言用作授予和身份验证令牌。</p><p>当前，CXF支持SAML2 Bearer和JWT Bearer断言作为授权和认证令牌。</p><p>有关CXF中OAuth 2.0支持的信息，请参见<a shape="rect" href="jax-rs-oauth2.html">JAX-RS OAuth2</a>页面。也请检查<a shape="rect" href="jax-rs-saml.html">JAX-RS SAML</a>页面以获取有关SAML支持的更多信息。</p><p> </p><h1 id="JAXRSOAuth2Assertions-SAML2Bearer">SAML2承载</h1><h2 id="JAXRSOAuth2Assertions-Mavendependencies">Maven依赖</h2><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;dependency&gt;
  &lt;groupId&gt;org.apache.cxf&lt;/groupId&gt;
  &lt;artifactId&gt;cxf-rt-rs-security-oauth2-saml&lt;/artifactId&gt;
  &lt;version&gt;${cxf.version}&lt;/version&gt;
&lt;/dependency&gt;
</pre>
</div></div><h2 id="JAXRSOAuth2Assertions-AccessTokenGrant">访问令牌授予</h2><p><a shape="rect" class="external-link" href="http://tools.ietf.org/html/rfc7522#section-2.1" rel="nofollow">本节</a>说明如何将SAML2 Bearer断言用作令牌授予。grant_type参数的值是“ urn：ietf：params：oauth：grant-type：saml2-bearer”。</p><p>它实际上只是另一种授予类型，但其实际值是SAML断言。规范提供了一个这样的断言看起来像的<a shape="rect" class="external-link" href="http://tools.ietf.org/html/rfc7522#section-4" rel="nofollow">例子</a> 。</p><p>附加限制是必须使用Base64Url编码对断言进行编码。<br clear="none">请求如下所示：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">POST /token HTTP/1.1
Content-Type: application/x-www-form-urlencoded

grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Asaml2-bearer&amp;
assertion=Base64UrlEncoded-SAML2-Bearer-Assertion
</pre>
</div></div><h3 id="JAXRSOAuth2Assertions-Clientcode">客户代码</h3><p>下面的示例演示如何将SAML2 Bearer断言用作带有CXF OAuth2客户端代码的授予：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">import org.apache.cxf.jaxrs.client.WebClient;
import org.apache.cxf.rs.security.common.CryptoLoader;
import org.apache.cxf.rs.security.oauth2.client.OAuthClientUtils;
import org.apache.cxf.rs.security.oauth2.common.AccessTokenGrant;
import org.apache.cxf.rs.security.oauth2.common.ClientAccessToken;
import org.apache.cxf.rs.security.oauth2.grants.saml.Saml2BearerGrant;
import org.apache.cxf.rs.security.saml.SAMLUtils;
import org.apache.cxf.rs.security.saml.SAMLUtils.SelfSignInfo;
import org.apache.ws.security.components.crypto.Crypto;

//1: create web client
String address = "https://localhost:8080/oauth2/token";
WebClient wc = WebClient.create(address);
wc.type(MediaType.APPLICATION_FORM_URLENCODED).accept(MediaType.APPLICATION_JSON);

//2. Create and self-sign SAML assertion        
Crypto crypto = new CryptoLoader().loadCrypto(CRYPTO_RESOURCE_PROPERTIES);
SelfSignInfo signInfo = new SelfSignInfo(crypto, "alice", "password"); 
        
String assertion =  SAMLUtils.createAssertion(new SamlCallbackHandler(),
                                              signInfo).assertionToString();

//3. Send it as a token grant to Access Token Service and get some access token back
AccessTokenGrant grant = new Saml2BearerGrant(assertion);
ClientAccessToken at = OAuthClientUtils.getAccessToken(wc, 
                                                       new OAuthClientUtils.Consumer("alice", "alice"), 
                                                       grant,
                                                       false);
</pre>
</div></div><p>上面的代码为新的SAML声明准备了一个自签名信息，并加载了具有crypto <a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/systests/rs-security/src/test/resources/org/apache/cxf/systest/jaxrs/security/alice.properties">属性</a>的Crypto实例，并使用SAMLUtils创建和签名了该声明（使用Crypto以及用户别名和密码）。Saml2BearerGrant将获取用Base64Url编码的断言-除非断言已使用CXF Base64UrlUtility编码或通过IP编码-在这种情况下，必须使用接受“ encoded”属性的Saml2BearerGrant构造函数，其值设置为“ true” 。</p><p>这几乎与使用其他令牌授予一样简单，在涉及更多的情况下，通常将省略步骤2，因为身份提供商将负责发出OAuth2 SAML2 Bearer断言。例如，在测试或让客户<a shape="rect" class="external-link" href="http://tools.ietf.org/html/rfc7521#section-6.2" rel="nofollow">代表自己</a>行事时，需要执行步骤2。</p><p>除了使用SelfSignInfo实用程序外，还可以创建一个空的CXF消息并在其上设置所需的属性，然后将其传递给SAMLUtils-请参阅下面的示例，该示例说明如何使用SAML承载声明进行身份验证。</p><p>在执行步骤2时，主要的工作是填充SAML断言-使用像<a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/systests/rs-security/src/test/java/org/apache/cxf/systest/jaxrs/security/oauth2/SamlCallbackHandler.java">这样</a>的SAML回调处理程序，实际上很容易构建断言。</p><h3 id="JAXRSOAuth2Assertions-AccessTokenService">访问令牌服务</h3><p>以下是配置访问令牌服务的方式：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;bean id="dataProvider" class="org.apache.cxf.systest.jaxrs.security.oauth2.OAuthDataProviderImpl"/&gt;
&lt;bean id="samlGrantHandler" class="org.apache.cxf.rs.security.oauth2.grants.saml.Saml2BearerGrantHandler"&gt;
  &lt;property name="dataProvider" ref="dataProvider"/&gt;
&lt;/bean&gt;
&lt;bean id="oauthJson" class="org.apache.cxf.rs.security.oauth2.provider.OAuthJSONProvider"/&gt;

&lt;bean id="serviceBean" class="org.apache.cxf.rs.security.oauth2.services.AccessTokenService"&gt;
  &lt;property name="dataProvider" ref="dataProvider"/&gt;
  &lt;property name="grantHandlers"&gt;
     &lt;list&gt;
       &lt;ref bean="samlGrantHandler"/&gt;
     &lt;/list&gt;
  &lt;/property&gt;
&lt;/bean&gt;

&lt;jaxrs:server address="https://localhost:${testutil.ports.jaxrs-oauth2}/oauth2"&gt;
   &lt;jaxrs:serviceBeans&gt;
      &lt;ref bean="serviceBean"/&gt;
   &lt;/jaxrs:serviceBeans&gt;
   &lt;jaxrs:providers&gt;
      &lt;ref bean="oauthJson"/&gt;
   &lt;/jaxrs:providers&gt;
   &lt;jaxrs:properties&gt;
     &lt;entry key="security.signature.properties" value="org/apache/cxf/systest/jaxrs/security/alice.properties"/&gt;
   &lt;/jaxrs:properties&gt;
&lt;/jaxrs:server&gt;
</pre>
</div></div><h2 id="JAXRSOAuth2Assertions-AuthenticationToken">认证令牌</h2><p>如简介中所述，无论实际的授予类型如何，当请求访问令牌时，SAML2 Bearer断言也可以充当客户端身份验证凭据。例如：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">POST /token HTTP/1.1
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&amp;code=12345678
&amp;client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Asaml2-bearer
&amp;client_assertion=Base64UrlEncoded-SAML2-Bearer-Assertion
</pre>
</div></div><p>注意，值为“ urn：ietf：params：oauth：client-assertion-type：saml2-bearer”的“ client_assertion_type”表示用作身份验证令牌的断言类型为“ urn：ietf：params：oauth：client-assertion” -type：saml2-bearer”，而“ client_assertion”参数则携带令牌的实际值。</p><h3 id="JAXRSOAuth2Assertions-ClientCode">客户代码</h3><p>以下示例显示如何将SAML2 Bearer断言用作身份验证令牌：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">import org.apache.cxf.jaxrs.client.WebClient;
import org.apache.cxf.rs.security.common.CryptoLoader;
import org.apache.cxf.rs.security.oauth2.client.OAuthClientUtils;
import org.apache.cxf.rs.security.oauth2.common.AccessTokenGrant;
import org.apache.cxf.rs.security.oauth2.common.ClientAccessToken;
import org.apache.cxf.rs.security.oauth2.grants.saml.Saml2BearerGrant;
import org.apache.cxf.rs.security.oauth2.saml.Base64Utility;
import org.apache.cxf.rs.security.oauth2.saml.Constants;
import org.apache.cxf.rs.security.saml.SAMLUtils;
import org.apache.cxf.rs.security.saml.SAMLUtils.SelfSignInfo;
import org.apache.ws.security.components.crypto.Crypto;

//1: create web client
String address = "https://localhost:8080/oauth2/token";
WebClient wc = WebClient.create(address);
wc.type(MediaType.APPLICATION_FORM_URLENCODED).accept(MediaType.APPLICATION_JSON);

//2. Create and self-sign SAML assertion        
Crypto crypto = new CryptoLoader().loadCrypto(CRYPTO_RESOURCE_PROPERTIES);
SelfSignInfo signInfo = new SelfSignInfo(crypto, "alice", "password"); 
        
String assertion =  SAMLUtils.createAssertion(new SamlCallbackHandler(),
                                              signInfo).assertionToString();

// 3. Base64Url-encode it
String encodedAssertion = Base64UrlUtility.encode(assertion);
        
Map&lt;String, String&gt; extraParams = new HashMap&lt;String, String&gt;();
extraParams.put(Constants.CLIENT_AUTH_ASSERTION_TYPE, Constants.CLIENT_AUTH_SAML2_BEARER);
extraParams.put(Constants.CLIENT_AUTH_ASSERTION_PARAM, encodedAssertion);

// Use whatever token grant is required 
AccessTokenGrant accessTokenGrant = ...
       
ClientAccessToken at = OAuthClientUtils.getAccessToken(wc, 
                                                       accessTokenGrant,
                                                       extraParams);
</pre>
</div></div><p>上面的代码类似于将SAML2 Bearer断言用作授权时的示例，除了这次断言在代码中使用Base64Url编码-注意，断言来自IP时将不需要步骤2和步骤3。<br clear="none">接下来，将编码的断言用作令牌请求有效负载的一部分，请注意，实际上使用哪种授权类型都没有关系。</p><p>直接在客户端代码中处理断言的另一种方法是使用org.apache.cxf.rs.security.oauth2.auth.saml。Saml2BearerAuthOutInterceptor拦截器，它将断言添加到现有表单有效负载中，例如：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">JAXRSClientFactoryBean bean = new JAXRSClientFactoryBean();

Map&lt;String, Object&gt; properties = new HashMap&lt;String, Object&gt;();
properties.put("security.callback-handler", 
               "org.apache.cxf.systest.jaxrs.security.saml.KeystorePasswordCallback");
properties.put("security.saml-callback-handler", 
               "org.apache.cxf.systest.jaxrs.security.oauth2.SamlCallbackHandler2");
properties.put("security.signature.username", "alice");
properties.put("security.signature.properties", CRYPTO_RESOURCE_PROPERTIES);
properties.put("security.self-sign-saml-assertion", "true");
bean.setProperties(properties);
        
bean.getOutInterceptors().add(new Saml2BearerAuthOutInterceptor());
        
WebClient wc = bean.createWebClient();
wc.type(MediaType.APPLICATION_FORM_URLENCODED).accept(MediaType.APPLICATION_JSON);

// Use whatever token grant is required 
AccessTokenGrant accessTokenGrant = ...
       
ClientAccessToken at = OAuthClientUtils.getAccessToken(wc, 
                                                       accessTokenGrant);
</pre>
</div></div><h3 id="JAXRSOAuth2Assertions-AccessTokenService.1">访问令牌服务</h3><p>以下是配置访问令牌服务的方式：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;bean id="dataProvider" class="org.apache.cxf.systest.jaxrs.security.oauth2.OAuthDataProviderImpl"/&gt;
&lt;bean id="oauthJson" class="org.apache.cxf.rs.security.oauth2.provider.OAuthJSONProvider"/&gt;
&lt;bean id="samlAuthHandler" class="org.apache.cxf.rs.security.oauth2.auth.saml.Saml2BearerAuthHandler"/&gt;

&lt;bean id="serviceBean" class="org.apache.cxf.rs.security.oauth2.services.AccessTokenService"&gt;
  &lt;property name="dataProvider" ref="dataProvider"/&gt;
  &lt;property name="grantHandlers"&gt;
     &lt;list&gt;
       &lt;!-- list of required grant handlers --&gt;
     &lt;/list&gt;
  &lt;/property&gt;
&lt;/bean&gt;

&lt;jaxrs:server 
       address="https://localhost:${testutil.ports.jaxrs-oauth2}/oauth2-auth"&gt; 
       &lt;jaxrs:serviceBeans&gt;
          &lt;ref bean="serviceBean"/&gt;
       &lt;/jaxrs:serviceBeans&gt;
       &lt;jaxrs:providers&gt;
          &lt;ref bean="oauthJson"/&gt;
          &lt;ref bean="samlAuthHandler"/&gt;
       &lt;/jaxrs:providers&gt;
       
       &lt;jaxrs:properties&gt;
           &lt;entry key="security.signature.properties" 
                  value="org/apache/cxf/systest/jaxrs/security/alice.properties"/&gt;
       &lt;/jaxrs:properties&gt;
        
&lt;/jaxrs:server&gt;
</pre>
</div></div><h2 id="JAXRSOAuth2Assertions-ClientActingonBehalfofItself">客户代表自己行事</h2><p>在“ <a shape="rect" class="external-link" href="http://tools.ietf.org/html/rfc7521#section-6.2" rel="nofollow">代表自身行事</a>的<a shape="rect" class="external-link" href="http://tools.ietf.org/html/rfc7521#section-6.2" rel="nofollow">客户端”中，</a>使用org.apache.cxf.rs.security.oauth2.grants.saml。Saml2BearerClientCredentialsGrant：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">import org.apache.cxf.jaxrs.client.WebClient;
import org.apache.cxf.rs.security.common.CryptoLoader;
import org.apache.cxf.rs.security.oauth2.client.OAuthClientUtils;
import org.apache.cxf.rs.security.oauth2.common.AccessTokenGrant;
import org.apache.cxf.rs.security.oauth2.common.ClientAccessToken;
import org.apache.cxf.rs.security.oauth2.grants.saml.Saml2BearerClientCredentialsGrant;
import org.apache.cxf.rs.security.saml.SAMLUtils;
import org.apache.cxf.rs.security.saml.SAMLUtils.SelfSignInfo;
import org.apache.ws.security.components.crypto.Crypto;

//1: create web client
String address = "https://localhost:8080/oauth2/token";
WebClient wc = WebClient.create(address);
wc.type(MediaType.APPLICATION_FORM_URLENCODED).accept(MediaType.APPLICATION_JSON);

//2. Create and self-sign SAML assertion        
Crypto crypto = new CryptoLoader().loadCrypto(CRYPTO_RESOURCE_PROPERTIES);
SelfSignInfo signInfo = new SelfSignInfo(crypto, "alice", "password"); 
        
String assertion =  SAMLUtils.createAssertion(new SamlCallbackHandler(),
                                              signInfo).assertionToString();

AccessTokenGrant accessTokenGrant = new Saml2BearerClientCredentialsGrant(assertion);
       
ClientAccessToken at = OAuthClientUtils.getAccessToken(wc, 
                                                       accessTokenGrant,
                                                       extraParams);
</pre>
</div></div><p>或ClientCredentialsGrant与Saml2BearerAuthOutInterceptor结合使用：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">JAXRSClientFactoryBean bean = new JAXRSClientFactoryBean();

Map&lt;String, Object&gt; properties = new HashMap&lt;String, Object&gt;();
properties.put("security.callback-handler", 
               "org.apache.cxf.systest.jaxrs.security.saml.KeystorePasswordCallback");
properties.put("security.saml-callback-handler", 
               "org.apache.cxf.systest.jaxrs.security.oauth2.SamlCallbackHandler2");
properties.put("security.signature.username", "alice");
properties.put("security.signature.properties", CRYPTO_RESOURCE_PROPERTIES);
properties.put("security.self-sign-saml-assertion", "true");
bean.setProperties(properties);
        
bean.getOutInterceptors().add(new Saml2BearerAuthOutInterceptor());
        
WebClient wc = bean.createWebClient();
wc.type(MediaType.APPLICATION_FORM_URLENCODED).accept(MediaType.APPLICATION_JSON);

// Use whatever token grant is required 
AccessTokenGrant accessTokenGrant = new ClientCredentialsGrant();
       
ClientAccessToken at = OAuthClientUtils.getAccessToken(wc, accessTokenGrant);
</pre>
</div></div><p> </p><h1 id="JAXRSOAuth2Assertions-JWTBearer">智威汤逊承载</h1><p>有关实现详细信息，请参<a shape="rect" href="https://cwiki.apache.org/confluence/display/CXF20DOC/JAX-RS+OAuth2#JAX-RSOAuth2-SAMLandJWTAssertions">见此CXF OAuth2部分</a> 。</p><h2 id="JAXRSOAuth2Assertions-AccessTokenGrant.1">访问令牌授予</h2><p><a shape="rect" class="external-link" href="http://tools.ietf.org/html/rfc7523#section-2.1" rel="nofollow">本节</a>说明如何将JWT Bearer令牌用作令牌授予。grant_type参数的值为“ urn：ietf：params：oauth：grant- type：jwt-bearer”。</p><p>它实际上只是另一种授予类型，但其实际值是JWT令牌。规范提供了一个这样的断言看起来像的<a shape="rect" class="external-link" href="http://tools.ietf.org/html/rfc7523#section-4" rel="nofollow">例子</a> 。</p><p>请求如下所示：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">POST /token HTTP/1.1
Content-Type: application/x-www-form-urlencoded

grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&amp;
assertion=X.Y.Z
</pre>
</div></div><h3 id="JAXRSOAuth2Assertions-Clientcode.1">客户代码</h3><p>CXF的BigQuery演示<a shape="rect" class="external-link" href="https://github.com/apache/cxf/blob/master/distribution/src/main/release/samples/jax_rs/big_query/src/main/java/demo/jaxrs/server/BigQueryServer.java#L75" rel="nofollow">显示</a>所谓的谷歌服务客户端如何令牌准备签署JWT，为了发出JWT承载赠款申请并获得新的访问令牌回用JwtBearerGrant。演示代码中使用了CXF WebClient，但也可以使用OAuthClientUtils。</p><h3 id="JAXRSOAuth2Assertions-AccessTokenService.2">访问令牌服务</h3><p>这是配置访问令牌服务的方式：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;bean id="dataProvider" class="org.apache.cxf.systest.jaxrs.security.oauth2.OAuthDataProviderImpl"/&gt;
&lt;bean id="jwtGrantHandler" class="org.apache.cxf.rs.security.oauth2.grants.jwt.JwtBearerGrantHandler"&gt;
  &lt;property name="dataProvider" ref="dataProvider"/&gt;
&lt;/bean&gt;
&lt;bean id="oauthJson" class="org.apache.cxf.rs.security.oauth2.provider.OAuthJSONProvider"/&gt;

&lt;bean id="serviceBean" class="org.apache.cxf.rs.security.oauth2.services.AccessTokenService"&gt;
  &lt;property name="dataProvider" ref="dataProvider"/&gt;
  &lt;property name="grantHandlers"&gt;
     &lt;list&gt;
       &lt;ref bean="jwtGrantHandler"/&gt;
     &lt;/list&gt;
  &lt;/property&gt;
&lt;/bean&gt;

&lt;jaxrs:server address="https://localhost:${testutil.ports.jaxrs-oauth2}/oauth2"&gt;
   &lt;jaxrs:serviceBeans&gt;
      &lt;ref bean="serviceBean"/&gt;
   &lt;/jaxrs:serviceBeans&gt;
   &lt;jaxrs:providers&gt;
      &lt;ref bean="oauthJson"/&gt;
   &lt;/jaxrs:providers&gt;
   &lt;jaxrs:properties&gt;
      &lt;entry key="rs.security.keystore.type" value="jks" /&gt;
      &lt;entry key="rs.security.keystore.alias" value="myclientkey"/&gt;
      &lt;entry key="rs.security.keystore.password" value="cspass"/&gt;
      &lt;entry key="rs.security.keystore.file" value="clientstore.jks" /&gt;
      &lt;entry key="rs.security.signature.algorithm" value="RS256" /&gt;
   &lt;/jaxrs:properties&gt;
&lt;/jaxrs:server&gt;
</pre>
</div></div><h2 id="JAXRSOAuth2Assertions-AuthenticationToken.1">认证令牌</h2><p>如引言中所述，当请求访问令牌时，无论实际的授予类型如何，JWT承载令牌都可以充当客户端身份验证凭据。例如：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">POST /token HTTP/1.1
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&amp;code=12345678
&amp;client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer
&amp;client_assertion=X.Y.Z
</pre>
</div></div><p>注意，值为“ urn：ietf：params：oauth：client-assertion-type：jwt-bearer”的“ client_assertion_type”表示用作身份验证令牌的断言类型为“ urn：ietf：params：oauth：client-assertion” -type：jwt-bearer”，而“ client_assertion”参数则携带令牌的实际值。</p><h3 id="JAXRSOAuth2Assertions-ClientCode.1">客户代码</h3><p>假设客户端有效地使用“客户端证书”授予，代表自己代表请求令牌。在这种情况下，它将使用<a shape="rect" class="external-link" href="https://github.com/apache/cxf/blob/master/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/jwt/JwtBearerClientCredentialsGrant.java" rel="nofollow">JwtBearerClientCredentialsGrant</a> 。</p><h3 id="JAXRSOAuth2Assertions-AccessTokenService.3">访问令牌服务</h3><p>以下是配置访问令牌服务的方式：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;bean id="dataProvider" class="org.apache.cxf.systest.jaxrs.security.oauth2.OAuthDataProviderImpl"/&gt;
&lt;bean id="oauthJson" class="org.apache.cxf.rs.security.oauth2.provider.OAuthJSONProvider"/&gt;
&lt;bean id="jwtAuthHandler" class="org.apache.cxf.rs.security.oauth2.grants.jwt.JwtBearerAuthHandler"/&gt;

&lt;bean id="serviceBean" class="org.apache.cxf.rs.security.oauth2.services.AccessTokenService"&gt;
  &lt;property name="dataProvider" ref="dataProvider"/&gt;
  &lt;property name="grantHandlers"&gt;
     &lt;list&gt;
       &lt;!-- list of required grant handlers --&gt;
     &lt;/list&gt;
  &lt;/property&gt;
&lt;/bean&gt;

&lt;jaxrs:server 
       address="https://localhost:${testutil.ports.jaxrs-oauth2}/oauth2-auth"&gt; 
       &lt;jaxrs:serviceBeans&gt;
          &lt;ref bean="serviceBean"/&gt;
       &lt;/jaxrs:serviceBeans&gt;
       &lt;jaxrs:providers&gt;
          &lt;ref bean="oauthJson"/&gt;
          &lt;ref bean="jwtAuthHandler"/&gt;
       &lt;/jaxrs:providers&gt;
       
       &lt;jaxrs:properties&gt;
           &lt;entry key="security.signature.properties" 
                  value="org/apache/cxf/systest/jaxrs/security/alice.properties"/&gt;
       &lt;/jaxrs:properties&gt;
        
&lt;/jaxrs:server&gt;
</pre>
</div></div></div>
           </div>
           <!-- Content -->
         </td>
        </tr>
      </tbody></table>
   </td>
   <td id="cell-2-2" colspan="2"> </td>
  </tr>
  <tr>
   <td id="cell-3-0"> </td>
   <td id="cell-3-1"> </td>
   <td id="cell-3-2">
     <div id="footer">
       <!-- Footer -->
       <div id="site-footer">
         <a href="http://cxf.apache.org/privacy-policy.html">隐私政策</a> -（ <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=30755503">编辑页面</a> ）（ <a href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=30755503&showComments=true&showCommentArea=true#addcomment">添加评论</a> ）<br>Apache CXF，CXF，Apache，Apache Feather徽标是The Apache Software Foundation的商标。<br>提及的所有其他商标可能是其各自所有者的商标或注册商标。
       </div>
       <!-- Footer -->
     </div>
   </td>
   <td id="cell-3-3"> </td>
   <td id="cell-3-4"> </td>
  </tr>
  <tr>
    <td id="cell-4-0" colspan="2"> </td>
    <td id="cell-4-1"> </td>
    <td id="cell-4-2" colspan="2"> </td>
  </tr>
</tbody></table>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-4458903-1");
pageTracker._trackPageview();
} catch(err) {}</script>




</body></html>