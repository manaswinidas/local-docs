<html ><head>

<link type="text/css" rel="stylesheet" href="/resources/site.css">
<script src='/resources/space.js'></script>

<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<meta name="keywords" content="business integration, EAI, SOA, Service Oriented Architecture, web services, SOAP, JBI, JMS, WSDL, XML, EDI, Electronic Data Interchange, standards support, integration standards, application integration, middleware, software, solutions, services, CXF, open source">
<meta name="description" content="Apache CXF, Services Framework - JAX-RS Failover">


<link type="text/css" rel="stylesheet" href="/resources/highlighter/styles/shCoreCXF.css">
<link type="text/css" rel="stylesheet" href="/resources/highlighter/styles/shThemeCXF.css">

<script src='/resources/highlighter/scripts/shCore.js'></script>
<script src='/resources/highlighter/scripts/shBrushJava.js'></script>
<script src='/resources/highlighter/scripts/shBrushXml.js'></script>
<script>
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all();
</script>


    <title>Apache CXF-JAX-RS故障转移</title>
  </head>
<body  onload="init()">


<table width="100%" cellpadding="0" cellspacing="0">
  <tbody><tr>
    <td id="cell-0-0" colspan="2"> </td>
    <td id="cell-0-1"> </td>
    <td id="cell-0-2" colspan="2"> </td>
  </tr>
  <tr>
    <td id="cell-1-0"> </td>
    <td id="cell-1-1"> </td>
    <td id="cell-1-2">
      <!-- Banner -->
<div class="banner" id="banner"><div><table border="0" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td align="left" colspan="1" nowrap>
<a shape="rect" href="http://cxf.apache.org/" title="Apache CXF"><span style="font-weight:bold;font-size:170%;color:white">Apache CXF</span></a>
</td><td align="right" colspan="1" nowrap>
<a shape="rect" href="http://www.apache.org/" title="阿帕奇软件基金会"><img border="0" alt="ASF徽标" src="http://cxf.apache.org/images/asf-logo.png"></a>
</td></tr></tbody></table></div></div>
      <!-- Banner -->
      <div id="top-menu">
        <table border="0" cellpadding="1" cellspacing="0" width="100%">
          <tbody><tr>
            <td>
              <div align="left">
                <!-- Breadcrumbs --> <a href="index.html">索引</a> > <a href="restful-services.html">RESTful服务</a> > <a href="jax-rs.html">JAX-RS</a> > <a href="jax-rs-failover.html">JAX-RS故障转移</a> <!-- Breadcrumbs -->
              </div>
            </td>
            <td>
              <div align="right">
                <!-- Quicklinks -->
<div id="quicklinks"><p><a shape="rect" href="http://cxf.apache.org/download.html">下载</a> | <a shape="rect" href="http://cxf.apache.org/docs/index.html">文献资料</a></p></div>
                <!-- Quicklinks -->
              </div>
            </td>
          </tr>
        </tbody></table>
      </div>
    </td>
    <td id="cell-1-3"> </td>
    <td id="cell-1-4"> </td>
  </tr>
  <tr>
    <td id="cell-2-0" colspan="2"> </td>
    <td id="cell-2-1">
      <table>
        <tbody><tr valign="top">
          <td height="100%">
            <div id="wrapper-menu-page-right">
              <div id="wrapper-menu-page-top">
                <div id="wrapper-menu-page-bottom">
                  <div id="menu-page">
                    <!-- NavigationBar -->
<div id="navigation"><ul class="alternate"><li><a shape="rect" href="overview.html">总览</a></li><li><a shape="rect" href="how-tos.html">操作方法</a></li><li><a shape="rect" href="frontends.html">前端</a></li><li><a shape="rect" href="databindings.html">数据绑定</a></li><li><a shape="rect" href="transports.html">运输工具</a></li><li><a shape="rect" href="configuration.html">组态</a></li><li><a shape="rect" href="debugging-and-logging.html">调试和记录</a></li><li><a shape="rect" href="tools.html">工具类</a></li><li><a shape="rect" href="restful-services.html">RESTful服务</a></li><li><a shape="rect" href="wsdl-bindings.html">WSDL绑定</a></li><li><a shape="rect" href="service-routing.html">服务路由</a></li><li><a shape="rect" href="dynamic-languages.html">动态语言</a></li><li><a shape="rect" href="ws-support.html">WS- *支持</a></li><li><a shape="rect" href="advanced-integration.html">进阶整合</a></li><li><a shape="rect" href="deployment.html">部署方式</a></li><li><a shape="rect" href="schemas-and-namespaces.html">模式和命名空间的使用</a></li></ul><hr><ul class="alternate"><li><p>搜索</p></li></ul><form id="cse-search-box" enctype="application/x-www-form-urlencoded" method="get" action="http://www.google.com/cse">
  <div>
    <input type="hidden" name="cx" value="002890367768291051730:o99qiwa09y4">
    <input type="hidden" name="ie" value="UTF-8">
    <input type="text" name="q" size="21">
    <input type="submit" name="sa" value="搜索">
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script><hr><ul class="alternate"><li><a shape="rect" href="http://cxf.apache.org/javadoc/latest/">API 3.2.x（Javadoc）</a></li><li><a shape="rect" href="http://cxf.apache.org/javadoc/latest-3.1.x/">API 3.1.x（Javadoc）</a></li><li><a shape="rect" href="http://cxf.apache.org/">CXF网站</a></li></ul><p> </p><p><a shape="rect" class="external-link" href="http://www.apache.org/events/current-event.html"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image confluence-external-resource" src="http://www.apache.org/events/current-event-125x125.png" data-image-src="http://www.apache.org/events/current-event-125x125.png"></span></a></p></div>
                    <!-- NavigationBar -->
                  </div>
              </div>
            </div>
          </div>
         </td>
         <td height="100%">
           <!-- Content -->
           <div class="wiki-content">
<div id="ConfluenceContent"><p><span style="font-size:2em;font-weight:bold">JAX-RS：故障转移</span>


 </p><p><style type="text/css">/*<![CDATA[*/
div.rbtoc1524513402079 {padding: 0px;}
div.rbtoc1524513402079 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1524513402079 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style></p><div class="toc-macro rbtoc1524513402079">
<ul class="toc-indentation"><li><a shape="rect" href="#JAX-RSFailover-Failover">故障转移</a>
<ul class="toc-indentation"><li><a shape="rect" href="#JAX-RSFailover-Spring">弹簧</a></li><li><a shape="rect" href="#JAX-RSFailover-Code">码</a></li></ul>
</li><li><a shape="rect" href="#JAX-RSFailover-CircuitBreakersFailover">断路器故障转移</a>
<ul class="toc-indentation"><li><a shape="rect" href="#JAX-RSFailover-Spring.1">弹簧</a></li><li><a shape="rect" href="#JAX-RSFailover-Code.1">码</a></li></ul>
</li><li><a shape="rect" href="#JAX-RSFailover-LoadDistribution">负荷分配</a></li></ul>
</div><p>从CXF 2.4.1开始，可以配置CXF JAX-RS客户端使其具有故障转移功能。<br clear="none">支持核心CXF故障转移和负载分配功能。</p><h1 id="JAX-RSFailover-Failover">故障转移</h1><p>代理和WebClient可以配置为在发生与连接有关的故障时故障转移到备用地址。<br clear="none">支持顺序和随机策略，实施者可以通过检索构建更复杂的故障转移功能<br clear="none">定位器和其他中介的备用地址。</p><h2 id="JAX-RSFailover-Spring">弹簧</h2><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jaxrs="http://cxf.apache.org/jaxrs"
       xmlns:clustering="http://cxf.apache.org/clustering"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="
http://cxf.apache.org/jaxrs http://cxf.apache.org/schemas/jaxrs.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"&gt;
    &lt;bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"/&gt;
    
    &lt;util:list id="addressList"&gt;
        &lt;value&gt;http://localhost:${testutil.ports.Server.1}/rest&lt;/value&gt;
        &lt;value&gt;http://localhost:${testutil.ports.Server.2}/rest&lt;/value&gt;
        &lt;value&gt;http://localhost:${testutil.ports.Server.3}/rest&lt;/value&gt;
    &lt;/util:list&gt;

    &lt;bean id="SequentialAddresses" class="org.apache.cxf.clustering.SequentialStrategy"&gt;
        &lt;property name="alternateAddresses"&gt;
            &lt;ref bean="addressList"/&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

    &lt;bean id="RandomAddresses" class="org.apache.cxf.clustering.RandomStrategy"&gt;
        &lt;property name="alternateAddresses"&gt;
            &lt;ref bean="addressList"/&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

    &lt;jaxrs:client id="failoverSequential" address="http://localhost:8080/initialAddress"&gt;
       &lt;jaxrs:features&gt;
           &lt;clustering:failover&gt;
                &lt;clustering:strategy&gt;
                    &lt;ref bean="SequentialAddresses"/&gt;
                &lt;/clustering:strategy&gt;
            &lt;/clustering:failover&gt;
       &lt;/jaxrs:features&gt;
    &lt;/jaxrs:client&gt;

    &lt;jaxrs:client id="failoverRandom" address="http://localhost:8080/initialAddress"&gt;
       &lt;jaxrs:features&gt;
           &lt;clustering:failover&gt;
                &lt;clustering:strategy&gt;
                    &lt;ref bean="RandomAddresses"/&gt;
                &lt;/clustering:strategy&gt;
            &lt;/clustering:failover&gt;
       &lt;/jaxrs:features&gt;
    &lt;/jaxrs:client&gt;

    &lt;bean id="myWebClient" class="org.apache.cxf.jaxrs.client.JAXRSClientFactoryBean" 
factory-method="createWebClient"&gt; 
        &lt;property name="address" value="http://some.base.url.that.responds/" /&gt; 
        &lt;property name="features"&gt;
            &lt;ref bean="failover1"/&gt; 
        &lt;/property&gt;  
    &lt;/bean&gt; 
&lt;/beans&gt;
</pre>
</div></div><h2 id="JAX-RSFailover-Code">码</h2><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">org.apache.cxf.jaxrs.features.clustering.FailoverFeature feature = 
    new org.apache.cxf.jaxrs.features.clustering.FailoverFeature();
List&lt;String&gt; alternateAddresses = new ArrayList&lt;String&gt;();
// addresses are alternate addresses provided at start-up
for (String s : address) {
    alternateAddresses.add(s);
}
SequentialStrategy strategy = new SequentialStrategy();
strategy.setAlternateAddresses(alternateAddresses);
feature.setStrategy(strategy);

JAXRSClientFactoryBean bean = new JAXRSClientFactoryBean();
bean.setAddress("http://localhost:8080/inactive-replica");
List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();
features.add(feature);
bean.setFeatures(features);

// create proxy:
bean.create(BookStore.class);
// create web client
bean.createWebClient();
</pre>
</div></div><h1 id="JAX-RSFailover-CircuitBreakersFailover">断路器故障转移</h1><p>CXF故障转移功能的最新添加是基于断路器的实现，更确切地说是基于Apache Zest（ <a shape="rect" class="external-link" href="https://zest.apache.org/">https://zest.apache.org/</a> ）库。从CXF 3.2.0开始可用。</p><p>该配置与常规故障转移策略非常相似，唯一的区别是使用<strong>clustering：circuit-breaker-failover</strong>元素。</p><h2 id="JAX-RSFailover-Spring.1">弹簧</h2><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jaxrs="http://cxf.apache.org/jaxrs"
       xmlns:clustering="http://cxf.apache.org/clustering"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="
http://cxf.apache.org/jaxrs http://cxf.apache.org/schemas/jaxrs.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"&gt;
    &lt;bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"/&gt;
    
    &lt;util:list id="addressList"&gt;
        &lt;value&gt;http://localhost:${testutil.ports.Server.1}/rest&lt;/value&gt;
        &lt;value&gt;http://localhost:${testutil.ports.Server.2}/rest&lt;/value&gt;
        &lt;value&gt;http://localhost:${testutil.ports.Server.3}/rest&lt;/value&gt;
    &lt;/util:list&gt;

    &lt;bean id="SequentialAddresses" class="org.apache.cxf.clustering.SequentialStrategy"&gt;
        &lt;property name="alternateAddresses"&gt;
            &lt;ref bean="addressList"/&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

    &lt;bean id="RandomAddresses" class="org.apache.cxf.clustering.RandomStrategy"&gt;
        &lt;property name="alternateAddresses"&gt;
            &lt;ref bean="addressList"/&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

    &lt;jaxrs:client id="failoverSequential" address="http://localhost:8080/initialAddress"&gt;
       &lt;jaxrs:features&gt;
           &lt;clustering:circuit-breaker-failover threshold="1" timeout="60000"&gt;
                &lt;clustering:strategy&gt;
                    &lt;ref bean="SequentialAddresses"/&gt;
                &lt;/clustering:strategy&gt;
            &lt;/clustering:circuit-breaker-failover&gt;
       &lt;/jaxrs:features&gt;
    &lt;/jaxrs:client&gt;

    &lt;jaxrs:client id="failoverRandom" address="http://localhost:8080/initialAddress"&gt;
       &lt;jaxrs:features&gt;
           &lt;clustering:circuit-breaker-failover threshold="1" timeout="60000"&gt;
                &lt;clustering:strategy&gt;
                    &lt;ref bean="RandomAddresses"/&gt;
                &lt;/clustering:strategy&gt;
            &lt;/clustering:circuit-breaker-failover&gt;
       &lt;/jaxrs:features&gt;
    &lt;/jaxrs:client&gt;

    &lt;bean id="myWebClient" class="org.apache.cxf.jaxrs.client.JAXRSClientFactoryBean" 
factory-method="createWebClient"&gt; 
        &lt;property name="address" value="http://some.base.url.that.responds/" /&gt; 
        &lt;property name="features"&gt;
            &lt;ref bean="failover1"/&gt; 
        &lt;/property&gt;  
    &lt;/bean&gt; 
&lt;/beans&gt;</pre>
</div></div><p>断路器已经推荐自己作为一种行之有效的策略来处理和监视与外部服务呼叫相关的故障，从而通过防止无休止的重试或超时，使外部系统有时间恢复。因此，可以调整两个配置参数：</p><ul><li><strong>阈值</strong> ：打开断路器的错误阈值</li><li><strong>timeout</strong> ：尝试下一次调用之前要等待的超时</li></ul><h2 id="JAX-RSFailover-Code.1">码</h2><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">org.apache.cxf.jaxrs.features.clustering.CircuitBreakerFailoverFeature feature = 
    new org.apache.cxf.jaxrs.features.clustering.CircuitBreakerFailoverFeature(1, 60000);
List&lt;String&gt; alternateAddresses = new ArrayList&lt;String&gt;();
// addresses are alternate addresses provided at start-up
for (String s : address) {
    alternateAddresses.add(s);
}
SequentialStrategy strategy = new SequentialStrategy();
strategy.setAlternateAddresses(alternateAddresses);
feature.setStrategy(strategy);

JAXRSClientFactoryBean bean = new JAXRSClientFactoryBean();
bean.setAddress("http://localhost:8080/inactive-replica");
List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();
features.add(feature);
bean.setFeatures(features);

// create proxy:
bean.create(BookStore.class);
// create web client
bean.createWebClient();</pre>
</div></div><h1 id="JAX-RSFailover-LoadDistribution">负荷分配</h1><p>CXF负载分配功能是一种故障转移功能，它不仅可以在发生故障的情况下，而且可以在成功调用之后，在其他地址进行迭代。</p><p>例：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jaxrs="http://cxf.apache.org/jaxrs"
       xmlns:clustering="http://cxf.apache.org/clustering"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="
http://cxf.apache.org/jaxrs http://cxf.apache.org/schemas/jaxrs.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"&gt;
    &lt;bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"/&gt;
    
    &lt;util:list id="addressList"&gt;
        &lt;value&gt;http://localhost:${testutil.ports.Server.1}/rest&lt;/value&gt;
        &lt;value&gt;http://localhost:${testutil.ports.Server.2}/rest&lt;/value&gt;
        &lt;value&gt;http://localhost:${testutil.ports.Server.3}/rest&lt;/value&gt;
    &lt;/util:list&gt;

    &lt;bean id="SequentialAddresses" class="org.apache.cxf.clustering.SequentialStrategy"&gt;
        &lt;property name="alternateAddresses"&gt;
            &lt;ref bean="addressList"/&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

    
    &lt;jaxrs:client id="loadDistributorClient" address="http://localhost:8080/initialAddress"&gt;
       &lt;jaxrs:features&gt;
           &lt;clustering:loadDistributor&gt;
                &lt;clustering:strategy&gt;
                    &lt;ref bean="RandomAddresses"/&gt;
                &lt;/clustering:strategy&gt;
            &lt;/clustering:loadDistributor&gt;
       &lt;/jaxrs:features&gt;
    &lt;/jaxrs:client&gt;
</pre>
</div></div><p>选择器可以通过如下代码设置：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">org.apache.cxf.jaxrs.features.clustering.FailoverFeature feature = 
    new org.apache.cxf.jaxrs.features.clustering.FailoverFeature();
feature.setSelector(new org.apache.cxf.clustering.LoadDistributorTargetSelector());
</pre>
</div></div></div>
           </div>
           <!-- Content -->
         </td>
        </tr>
      </tbody></table>
   </td>
   <td id="cell-2-2" colspan="2"> </td>
  </tr>
  <tr>
   <td id="cell-3-0"> </td>
   <td id="cell-3-1"> </td>
   <td id="cell-3-2">
     <div id="footer">
       <!-- Footer -->
       <div id="site-footer">
         <a href="http://cxf.apache.org/privacy-policy.html">隐私政策</a> -（ <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=26805872">编辑页面</a> ）（ <a href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=26805872&showComments=true&showCommentArea=true#addcomment">添加评论</a> ）<br>Apache CXF，CXF，Apache，Apache Feather徽标是The Apache Software Foundation的商标。<br>提及的所有其他商标可能是其各自所有者的商标或注册商标。
       </div>
       <!-- Footer -->
     </div>
   </td>
   <td id="cell-3-3"> </td>
   <td id="cell-3-4"> </td>
  </tr>
  <tr>
    <td id="cell-4-0" colspan="2"> </td>
    <td id="cell-4-1"> </td>
    <td id="cell-4-2" colspan="2"> </td>
  </tr>
</tbody></table>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-4458903-1");
pageTracker._trackPageview();
} catch(err) {}</script>




</body></html>