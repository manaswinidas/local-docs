<html ><head>

<link type="text/css" rel="stylesheet" href="/resources/site.css">
<script src='/resources/space.js'></script>

<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<meta name="keywords" content="business integration, EAI, SOA, Service Oriented Architecture, web services, SOAP, JBI, JMS, WSDL, XML, EDI, Electronic Data Interchange, standards support, integration standards, application integration, middleware, software, solutions, services, CXF, open source">
<meta name="description" content="Apache CXF, Services Framework - JAXRS Testing">


<link type="text/css" rel="stylesheet" href="/resources/highlighter/styles/shCoreCXF.css">
<link type="text/css" rel="stylesheet" href="/resources/highlighter/styles/shThemeCXF.css">

<script src='/resources/highlighter/scripts/shCore.js'></script>
<script src='/resources/highlighter/scripts/shBrushJava.js'></script>
<script src='/resources/highlighter/scripts/shBrushXml.js'></script>
<script src='/resources/highlighter/scripts/shBrushBash.js'></script>
<script>
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all();
</script>


    <title>Apache CXF-JAXRS测试</title>
  </head>
<body  onload="init()">


<table width="100%" cellpadding="0" cellspacing="0">
  <tbody><tr>
    <td id="cell-0-0" colspan="2"> </td>
    <td id="cell-0-1"> </td>
    <td id="cell-0-2" colspan="2"> </td>
  </tr>
  <tr>
    <td id="cell-1-0"> </td>
    <td id="cell-1-1"> </td>
    <td id="cell-1-2">
      <!-- Banner -->
<div class="banner" id="banner"><div><table border="0" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td align="left" colspan="1" nowrap>
<a shape="rect" href="http://cxf.apache.org/" title="Apache CXF"><span style="font-weight:bold;font-size:170%;color:white">Apache CXF</span></a>
</td><td align="right" colspan="1" nowrap>
<a shape="rect" href="http://www.apache.org/" title="阿帕奇软件基金会"><img border="0" alt="ASF徽标" src="http://cxf.apache.org/images/asf-logo.png"></a>
</td></tr></tbody></table></div></div>
      <!-- Banner -->
      <div id="top-menu">
        <table border="0" cellpadding="1" cellspacing="0" width="100%">
          <tbody><tr>
            <td>
              <div align="left">
                <!-- Breadcrumbs --> <a href="index.html">索引</a> > <a href="restful-services.html">RESTful服务</a> > <a href="jax-rs.html">JAX-RS</a> > <a href="jaxrs-testing.html">JAXRS测试</a> <!-- Breadcrumbs -->
              </div>
            </td>
            <td>
              <div align="right">
                <!-- Quicklinks -->
<div id="quicklinks"><p><a shape="rect" href="http://cxf.apache.org/download.html">下载</a> | <a shape="rect" href="http://cxf.apache.org/docs/index.html">文献资料</a></p></div>
                <!-- Quicklinks -->
              </div>
            </td>
          </tr>
        </tbody></table>
      </div>
    </td>
    <td id="cell-1-3"> </td>
    <td id="cell-1-4"> </td>
  </tr>
  <tr>
    <td id="cell-2-0" colspan="2"> </td>
    <td id="cell-2-1">
      <table>
        <tbody><tr valign="top">
          <td height="100%">
            <div id="wrapper-menu-page-right">
              <div id="wrapper-menu-page-top">
                <div id="wrapper-menu-page-bottom">
                  <div id="menu-page">
                    <!-- NavigationBar -->
<div id="navigation"><ul class="alternate"><li><a shape="rect" href="overview.html">总览</a></li><li><a shape="rect" href="how-tos.html">操作方法</a></li><li><a shape="rect" href="frontends.html">前端</a></li><li><a shape="rect" href="databindings.html">数据绑定</a></li><li><a shape="rect" href="transports.html">运输工具</a></li><li><a shape="rect" href="configuration.html">组态</a></li><li><a shape="rect" href="debugging-and-logging.html">调试和记录</a></li><li><a shape="rect" href="tools.html">工具类</a></li><li><a shape="rect" href="restful-services.html">RESTful服务</a></li><li><a shape="rect" href="wsdl-bindings.html">WSDL绑定</a></li><li><a shape="rect" href="service-routing.html">服务路由</a></li><li><a shape="rect" href="dynamic-languages.html">动态语言</a></li><li><a shape="rect" href="ws-support.html">WS- *支持</a></li><li><a shape="rect" href="advanced-integration.html">进阶整合</a></li><li><a shape="rect" href="deployment.html">部署方式</a></li><li><a shape="rect" href="schemas-and-namespaces.html">模式和命名空间的使用</a></li></ul><hr><ul class="alternate"><li><p>搜索</p></li></ul><form id="cse-search-box" enctype="application/x-www-form-urlencoded" method="get" action="http://www.google.com/cse">
  <div>
    <input type="hidden" name="cx" value="002890367768291051730:o99qiwa09y4">
    <input type="hidden" name="ie" value="UTF-8">
    <input type="text" name="q" size="21">
    <input type="submit" name="sa" value="搜索">
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script><hr><ul class="alternate"><li><a shape="rect" href="http://cxf.apache.org/javadoc/latest/">API 3.2.x（Javadoc）</a></li><li><a shape="rect" href="http://cxf.apache.org/javadoc/latest-3.1.x/">API 3.1.x（Javadoc）</a></li><li><a shape="rect" href="http://cxf.apache.org/">CXF网站</a></li></ul><p> </p><p><a shape="rect" class="external-link" href="http://www.apache.org/events/current-event.html"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image confluence-external-resource" src="http://www.apache.org/events/current-event-125x125.png" data-image-src="http://www.apache.org/events/current-event-125x125.png"></span></a></p></div>
                    <!-- NavigationBar -->
                  </div>
              </div>
            </div>
          </div>
         </td>
         <td height="100%">
           <!-- Content -->
           <div class="wiki-content">
<div id="ConfluenceContent"><p><span style="font-size:2em;font-weight:bold">JAX-RS测试</span>


 </p><p><style type="text/css">/*<![CDATA[*/
div.rbtoc1524513388886 {padding: 0px;}
div.rbtoc1524513388886 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1524513388886 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style></p><div class="toc-macro rbtoc1524513388886">
<ul class="toc-indentation"><li><a shape="rect" href="#JAXRSTesting-EmbeddedJetty">嵌入式码头</a></li><li><a shape="rect" href="#JAXRSTesting-LocalTransport">本地运输</a>
<ul class="toc-indentation"><li><a shape="rect" href="#JAXRSTesting-MockingHTTPcontexts">模拟HTTP上下文</a></li></ul>
</li></ul>
</div><p>使用嵌入式Jetty或CXF Local Transport可以轻松测试JAX-RS端点。</p><h1 id="JAXRSTesting-EmbeddedJetty">嵌入式码头</h1><div class="code panel pdl" style="border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px"><b>Maven依赖</b></div><div class="codeContent panelContent pdl">
<pre class="brush: xml; gutter: false; theme: Default" style="font-size:12px;">&lt;dependency&gt;
   &lt;groupId&gt;org.apache.cxf&lt;/groupId&gt;
   &lt;artifactId&gt;cxf-rt-transports-http-jetty&lt;/artifactId&gt;
   &lt;version&gt;3.0.0&lt;/version&gt;
&lt;/dependency&gt;</pre>
</div></div><p> </p><p> </p><div class="code panel pdl" style="border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px"><b>例</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">import javax.ws.rs.core.Response;

import org.apache.cxf.endpoint.Server;
import org.apache.cxf.jaxrs.JAXRSServerFactoryBean;
import org.apache.cxf.jaxrs.client.WebClient;
import org.apache.cxf.jaxrs.lifecycle.SingletonResourceProvider;

import org.junit.Test;
import org.junit.Assert;
import org.junit.BeforeClass;
import org.junit.AfterClass;

import custom.MyJaxrsResource;
import custom.Book;

public class JAXRSTest extends Assert {

private final static String ENDPOINT_ADDRESS = "http://localhost:8080/rest";
private final static String WADL_ADDRESS = ENDPOINT_ADDRESS + "?_wadl";
private static Server server;

@BeforeClass
public static void initialize() throws Exception {
     startServer();
     waitForWADL();
}

private static void startServer() throws Exception {
     JAXRSServerFactoryBean sf = new JAXRSServerFactoryBean();
     sf.setResourceClasses(MyJaxrsResource.class);
        
     List&lt;Object&gt; providers = new ArrayList&lt;Object&gt;();
     // add custom providers if any
     sf.setProviders(providers);
        
     sf.setResourceProvider(MyJaxrsResource.class.class,
                            new SingletonResourceProvider(new MyJaxrsResource(), true));
     sf.setAddress(ENDPOINT_ADDRESS);

     server = sf.create();
}

// Optional step - may be needed to ensure that by the time individual
// tests start running the endpoint has been fully initialized
private static void waitForWADL() throws Exception {
    WebClient client = WebClient.create(WADL_ADDRESS);
    // wait for 20 secs or so
    for (int i = 0; i &lt; 20; i++) {
        Thread.currentThread().sleep(1000);
        Response response = client.get();
        if (response.getStatus() == 200) {
            break;
        }
    }
    // no WADL is available yet - throw an exception or give tests a chance to run anyway
}


@AfterClass
public static void destroy() throws Exception {
   server.stop();
   server.destroy();
}

@Test
public void testGetBookWithWebClient() {
 WebClient client = WebClient.create(ENDPOINT_ADDRESS);
 client.accept("text/xml");
 client.path("somepath"); 
 Book book = client.get(Book.class);
 assertEquals(123L, book.getId());
}

@Test
public void testGetBookWithProxy() {
  MyJaxrsResource client = JAXRSClientFactory.create(ENDPOINT_ADDRESS, MyJaxrsResource.class);
  Book book = client.getBook();
  assertEquals(123L, book.getId());
}
}
</pre>
</div></div><p>设置服务器并开始对其进行测试非常容易。使用嵌入式Jetty的优点是可以进行完整的端到端往返，从而给所有CXF运行时带来了压力，但这是以增加服务器设置复杂性为代价的。</p><h1 id="JAXRSTesting-LocalTransport">本地运输</h1><p>从CXF 2.6.2开始，可以使用CXF本地传输来测试JAX-RS端点和客户端。<br clear="none">这避免了启动嵌入式servlet容器的需要，并且测试将运行得更快。</p><div class="code panel pdl" style="border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px"><b>Maven依赖</b></div><div class="codeContent panelContent pdl">
<pre class="brush: xml; gutter: false; theme: Default" style="font-size:12px;">&lt;dependency&gt;
   &lt;groupId&gt;org.apache.cxf&lt;/groupId&gt;
   &lt;artifactId&gt;cxf-rt-transports-local&lt;/artifactId&gt;
   &lt;version&gt;3.0.0&lt;/version&gt;
&lt;/dependency&gt;</pre>
</div></div><div class="code panel pdl" style="border-width:1px"><div class="codeHeader panelHeader pdl" style="border-bottom-width:1px"><b>例</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">import org.apache.cxf.endpoint.Server;
import org.apache.cxf.jaxrs.JAXRSServerFactoryBean;
import org.apache.cxf.jaxrs.client.WebClient;
import org.apache.cxf.jaxrs.lifecycle.SingletonResourceProvider;

import org.apache.cxf.transport.local.LocalConduit;

import org.junit.Test;
import org.junit.Assert;
import org.junit.BeforeClass;
import org.junit.AfterClass;

import custom.MyJaxrsResource;
import custom.Book;

public class JAXRSTest extends Assert {

private final static String ENDPOINT_ADDRESS = "local://books";
private static Server server;

@BeforeClass
public static void initialize() throws Exception {
     startServer();
}

private static void startServer() throws Exception {
     JAXRSServerFactoryBean sf = new JAXRSServerFactoryBean();
     sf.setResourceClasses(MyJaxrsResource.class);
        
     List&lt;Object&gt; providers = new ArrayList&lt;Object&gt;();
     // add custom providers if any
     sf.setProviders(providers);
        
     sf.setResourceProvider(MyJaxrsResource.class.class,
                            new SingletonResourceProvider(new MyJaxrsResource(), true));
     sf.setAddress(ENDPOINT_ADDRESS);

     server = sf.create();
}

@AfterClass
public static void destroy() throws Exception {
   server.stop();
   server.destroy();
}

@Test
public void testGetBookWithWebClientDirectDispatch() {
 WebClient client = WebClient.create(ENDPOINT_ADDRESS);
 WebClient.getConfig(client).getRequestContext().put(LocalConduit.DIRECT_DISPATCH, Boolean.TRUE);
 
 client.accept("text/xml");
 client.path("somepath"); 
 Book book = client.get(Book.class);
 assertEquals(123L, book.getId());
}

@Test
public void testGetBookViaPipe() {
 WebClient client = WebClient.create(ENDPOINT_ADDRESS);
 client.accept("text/xml");
 client.path("somepath"); 
 Book book = client.get(Book.class);
 assertEquals(123L, book.getId());
}



@Test
public void testAddBookWithProxyDirectDispatch() {
  MyJaxrsResource client = JAXRSClientFactory.create(ENDPOINT_ADDRESS, MyJaxrsResource.class);
  WebClient.getConfig(client).getRequestContext().put(LocalConduit.DIRECT_DISPATCH, Boolean.TRUE);
  Book book = client.echoBook(new Book(123));
  assertEquals(123L, book.getId());
}
}
</pre>
</div></div><p>请注意，设置LocalConduit。将DIRECT_DISPATCH属性设置为“ true”可确保在客户端出链完成后，调用立即进入服务链。<br clear="none">如果未设置此属性，则CXF LocalConduit设置一个管道，该管道通过客户端的初始写入操作启动。</p><p>在上面的代码示例中，本地传输是通过使用URI“ local：”方案（例如“ local：// books”）激活的。</p><p>或者，可以将地址设置为相对值，例如“ / books”，同时将server和client transportId属性设置为<br clear="none">“ http://cxf.apache.org/transports/local”。在这种情况下，创建客户端时，请使用JAXRSClientFactoryBean：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">private static void startServer() throws Exception {
     JAXRSServerFactoryBean sf = new JAXRSServerFactoryBean();
     sf.setTransportId(LocalTransportFactory.TRANSPORT_ID);
     sf.setAddress("/books");
     sf.setResourceClasses(MyJaxrsResource.class);
     server = sf.create();
}


@Test
    public void testProxyPipedDispatchGet() throws Exception {
        JAXRSClientFactoryBean bean = new JAXRSClientFactoryBean();
        bean.setTransportId(LocalTransportFactory.TRANSPORT_ID);
        bean.setAddress("/books");
        bean.setServiceClass(MyJaxrsResource.class);
        MyJaxrsResource localProxy = bean.create(MyJaxrsResource.class);
        Book book = localProxy.getBook("123");
        assertEquals(123L, book.getId());
    }
</pre>
</div></div><p> </p><h2 id="JAXRSTesting-MockingHTTPcontexts">模拟HTTP上下文</h2><p>如果您测试依赖于注入的HTTP上下文（例如HttpServletRequest）的代码，则必须对这些上下文进行模拟。</p><p>例如：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">JAXRSServerFactoryBean sf = new JAXRSServerFactoryBean();
sf.setInvoker(new Invoker() {

  Invoker jarsInvoker = new JAXRSInvoker();
  @Override
  public Object invoke(Exchange exchange, Object o) {

   HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
   Mockito.when(request.getRemoteHost()).thenReturn("host");
   exchange.getInMessage().put(AbstractHTTPDestination.HTTP_REQUEST, request);
   return jarsInvoker.invoke(exchange, o);
  }

});</pre>
</div></div><p> </p><p> </p></div>
           </div>
           <!-- Content -->
         </td>
        </tr>
      </tbody></table>
   </td>
   <td id="cell-2-2" colspan="2"> </td>
  </tr>
  <tr>
   <td id="cell-3-0"> </td>
   <td id="cell-3-1"> </td>
   <td id="cell-3-2">
     <div id="footer">
       <!-- Footer -->
       <div id="site-footer">
         <a href="http://cxf.apache.org/privacy-policy.html">隐私政策</a> -（ <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=27850867">编辑页面</a> ）（ <a href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27850867&showComments=true&showCommentArea=true#addcomment">添加评论</a> ）<br>Apache CXF，CXF，Apache，Apache Feather徽标是The Apache Software Foundation的商标。<br>提及的所有其他商标可能是其各自所有者的商标或注册商标。
       </div>
       <!-- Footer -->
     </div>
   </td>
   <td id="cell-3-3"> </td>
   <td id="cell-3-4"> </td>
  </tr>
  <tr>
    <td id="cell-4-0" colspan="2"> </td>
    <td id="cell-4-1"> </td>
    <td id="cell-4-2" colspan="2"> </td>
  </tr>
</tbody></table>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-4458903-1");
pageTracker._trackPageview();
} catch(err) {}</script>




</body></html>