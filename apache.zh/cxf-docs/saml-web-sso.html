<html ><head>

<link type="text/css" rel="stylesheet" href="/resources/site.css">
<script src='/resources/space.js'></script>

<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<meta name="keywords" content="business integration, EAI, SOA, Service Oriented Architecture, web services, SOAP, JBI, JMS, WSDL, XML, EDI, Electronic Data Interchange, standards support, integration standards, application integration, middleware, software, solutions, services, CXF, open source">
<meta name="description" content="Apache CXF, Services Framework - SAML Web SSO">


<link type="text/css" rel="stylesheet" href="/resources/highlighter/styles/shCoreCXF.css">
<link type="text/css" rel="stylesheet" href="/resources/highlighter/styles/shThemeCXF.css">

<script src='/resources/highlighter/scripts/shCore.js'></script>
<script src='/resources/highlighter/scripts/shBrushJava.js'></script>
<script src='/resources/highlighter/scripts/shBrushXml.js'></script>
<script>
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all();
</script>


    <title>Apache CXF-SAML Web SSO</title>
  </head>
<body  onload="init()">


<table width="100%" cellpadding="0" cellspacing="0">
  <tbody><tr>
    <td id="cell-0-0" colspan="2"> </td>
    <td id="cell-0-1"> </td>
    <td id="cell-0-2" colspan="2"> </td>
  </tr>
  <tr>
    <td id="cell-1-0"> </td>
    <td id="cell-1-1"> </td>
    <td id="cell-1-2">
      <!-- Banner -->
<div class="banner" id="banner"><div><table border="0" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td align="left" colspan="1" nowrap>
<a shape="rect" href="http://cxf.apache.org/" title="Apache CXF"><span style="font-weight:bold;font-size:170%;color:white">Apache CXF</span></a>
</td><td align="right" colspan="1" nowrap>
<a shape="rect" href="http://www.apache.org/" title="阿帕奇软件基金会"><img border="0" alt="ASF徽标" src="http://cxf.apache.org/images/asf-logo.png"></a>
</td></tr></tbody></table></div></div>
      <!-- Banner -->
      <div id="top-menu">
        <table border="0" cellpadding="1" cellspacing="0" width="100%">
          <tbody><tr>
            <td>
              <div align="left">
                <!-- Breadcrumbs --> <a href="index.html">索引</a> > <a href="securing-cxf-services.html">保护CXF服务</a> > <a href="saml-web-sso.html">SAML Web SSO</a> <!-- Breadcrumbs -->
              </div>
            </td>
            <td>
              <div align="right">
                <!-- Quicklinks -->
<div id="quicklinks"><p><a shape="rect" href="http://cxf.apache.org/download.html">下载</a> | <a shape="rect" href="http://cxf.apache.org/docs/index.html">文献资料</a></p></div>
                <!-- Quicklinks -->
              </div>
            </td>
          </tr>
        </tbody></table>
      </div>
    </td>
    <td id="cell-1-3"> </td>
    <td id="cell-1-4"> </td>
  </tr>
  <tr>
    <td id="cell-2-0" colspan="2"> </td>
    <td id="cell-2-1">
      <table>
        <tbody><tr valign="top">
          <td height="100%">
            <div id="wrapper-menu-page-right">
              <div id="wrapper-menu-page-top">
                <div id="wrapper-menu-page-bottom">
                  <div id="menu-page">
                    <!-- NavigationBar -->
<div id="navigation"><ul class="alternate"><li><a shape="rect" href="overview.html">总览</a></li><li><a shape="rect" href="how-tos.html">操作方法</a></li><li><a shape="rect" href="frontends.html">前端</a></li><li><a shape="rect" href="databindings.html">数据绑定</a></li><li><a shape="rect" href="transports.html">运输工具</a></li><li><a shape="rect" href="configuration.html">组态</a></li><li><a shape="rect" href="debugging-and-logging.html">调试和记录</a></li><li><a shape="rect" href="tools.html">工具类</a></li><li><a shape="rect" href="restful-services.html">RESTful服务</a></li><li><a shape="rect" href="wsdl-bindings.html">WSDL绑定</a></li><li><a shape="rect" href="service-routing.html">服务路由</a></li><li><a shape="rect" href="dynamic-languages.html">动态语言</a></li><li><a shape="rect" href="ws-support.html">WS- *支持</a></li><li><a shape="rect" href="advanced-integration.html">进阶整合</a></li><li><a shape="rect" href="deployment.html">部署方式</a></li><li><a shape="rect" href="schemas-and-namespaces.html">模式和命名空间的使用</a></li></ul><hr><ul class="alternate"><li><p>搜索</p></li></ul><form id="cse-search-box" enctype="application/x-www-form-urlencoded" method="get" action="http://www.google.com/cse">
  <div>
    <input type="hidden" name="cx" value="002890367768291051730:o99qiwa09y4">
    <input type="hidden" name="ie" value="UTF-8">
    <input type="text" name="q" size="21">
    <input type="submit" name="sa" value="搜索">
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script><hr><ul class="alternate"><li><a shape="rect" href="http://cxf.apache.org/javadoc/latest/">API 3.2.x（Javadoc）</a></li><li><a shape="rect" href="http://cxf.apache.org/javadoc/latest-3.1.x/">API 3.1.x（Javadoc）</a></li><li><a shape="rect" href="http://cxf.apache.org/">CXF网站</a></li></ul><p> </p><p><a shape="rect" class="external-link" href="http://www.apache.org/events/current-event.html"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image confluence-external-resource" src="http://www.apache.org/events/current-event-125x125.png" data-image-src="http://www.apache.org/events/current-event-125x125.png"></span></a></p></div>
                    <!-- NavigationBar -->
                  </div>
              </div>
            </div>
          </div>
         </td>
         <td height="100%">
           <!-- Content -->
           <div class="wiki-content">
<div id="ConfluenceContent"><p><span style="font-size:2em;font-weight:bold">JAX-RS：SAML Web SSO</span>


 </p><p> </p><p> </p><p><style type="text/css">/*<![CDATA[*/
div.rbtoc1524513417198 {padding: 0px;}
div.rbtoc1524513417198 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1524513417198 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style></p><div class="toc-macro rbtoc1524513417198">
<ul class="toc-indentation"><li><a shape="rect" href="#SAMLWebSSO-Introduction">介绍</a>
<ul class="toc-indentation"><li><a shape="rect" href="#SAMLWebSSO-TypicalFlow">典型流量</a></li></ul>
</li><li><a shape="rect" href="#SAMLWebSSO-Mavendependencies">Maven依赖</a></li><li><a shape="rect" href="#SAMLWebSSO-IdentityProvider">身份提供者</a></li><li><a shape="rect" href="#SAMLWebSSO-ServiceProviderSecurityFilter">服务提供商安全过滤器</a>
<ul class="toc-indentation"><li><a shape="rect" href="#SAMLWebSSO-RedirectBindingFilter">重定向绑定过滤器</a></li><li><a shape="rect" href="#SAMLWebSSO-POSTBindingFilter">POST绑定过滤器</a></li><li><a shape="rect" href="#SAMLWebSSO-SigningSAMLAuthenticationRequests">签名SAML身份验证请求</a></li><li><a shape="rect" href="#SAMLWebSSO-FiltersandStateManagement">筛选器和状态管理</a></li></ul>
</li><li><a shape="rect" href="#SAMLWebSSO-RequestAssertionConsumerService">请求断言消费者服务</a>
<ul class="toc-indentation"><li><a shape="rect" href="#SAMLWebSSO-DealingwithsignedSAMLResponses">处理已签名的SAML响应</a></li><li><a shape="rect" href="#SAMLWebSSO-SignatureKeyInfoValidation">签名密钥信息验证</a></li><li><a shape="rect" href="#SAMLWebSSO-UsingRACSasEndpointFilter">使用RACS作为端点过滤器</a></li></ul>
</li><li><a shape="rect" href="#SAMLWebSSO-SSOStateProvider">SSO国家提供者</a>
<ul class="toc-indentation"><li><a shape="rect" href="#SAMLWebSSO-DistributedStateManagement">分布式状态管理</a></li></ul>
</li><li><a shape="rect" href="#SAMLWebSSO-LogoutService">登出服务</a></li><li><a shape="rect" href="#SAMLWebSSO-MetadataService">元数据服务</a></li></ul>
</div><h1 id="SAMLWebSSO-Introduction">介绍</h1><p><a shape="rect" class="external-link" href="http://en.wikipedia.org/wiki/Single_sign-on" rel="nofollow">SSO</a>与用户在与可提供多个单独端点的自定义Web应用程序进行交互时仅登录一次有关。</p><p>CXF 2.6.1引入了对SAML Web SSO <a shape="rect" class="external-link" href="http://docs.oasis-open.org/security/saml/v2.0/saml-profiles-2.0-os.pdf" rel="nofollow">配置文件</a>的全面服务提供商（SP）支持。此<a shape="rect" class="external-link" href="http://en.wikipedia.org/wiki/SAML_2.0" rel="nofollow">页面</a>还提供了概要<a shape="rect" class="external-link" href="http://en.wikipedia.org/wiki/SAML_2.0#Web_Browser_SSO_Profile" rel="nofollow">文件</a>的良好概述。</p><p>支持HTTP重定向（通过GET）和POST绑定。该模块已经针对许多IDP提供商进行了测试，并且易于配置。</p><p>要获得SSO支持，需要以下组件：</p><ul class="alternate"><li>支持SAML SSO的身份提供者（IDP）</li><li>请求断言消费者服务（RACS）</li><li>服务提供商安全过滤器</li><li>SSO国家提供者</li></ul><p>以下各节将更详细地描述这些组件</p><h2 id="SAMLWebSSO-TypicalFlow">典型流量</h2><p>通常，以下流程表示实施SAML SSO的方式：</p><p>1。用户首次访问自定义应用程序<br clear="none">2。服务提供商安全筛选器检查安全上下文是否可用<br clear="none">并使用SAML SSO请求将用户重定向到IDP<br clear="none">3。IDP通过身份验证对话框向用户提出挑战，并将用户重定向到<br clear="none">用户验证后请求断言消费者服务（RACS）<br clear="none">4。RACS验证来自IDP的响应，建立安全上下文并重定向用户<br clear="none">到原始应用程序端点<br clear="none">5，服务提供商安全筛选器强制提供有效的安全上下文，并允许用户<br clear="none">访问自定义应用程序。</p><h1 id="SAMLWebSSO-Mavendependencies">Maven依赖</h1><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;dependency&gt;
  &lt;groupId&gt;org.apache.cxf&lt;/groupId&gt;
  &lt;artifactId&gt;cxf-rt-rs-security-sso-saml&lt;/artifactId&gt;
  &lt;version&gt;2.6.1&lt;/version&gt;
&lt;/dependency&gt;
</pre>
</div></div><h1 id="SAMLWebSSO-IdentityProvider">身份提供者</h1><p>身份提供者（IDP）是一项服务，它接受来自应用程序安全筛选器的重定向请求，对用户进行身份验证，然后将其重定向回“请求声明安全性服务”。</p><p>CXF不提供自己的IDP SAML Web SSO实现，但将来可能会作为<a shape="rect" href="http://cxf.apache.org/fediz.html">Fediz</a>项目的一部分提供。</p><p>但是，CXF已针对支持SAML SSO的许多流行IDP实现进行了测试，因此应可与特定生产环境中使用的任何IDP互操作。互操作性测试表明，某些IDP可能以不完全符合规范的方式处理SAML请求并生成SAML响应数据，因此CXF请求断言使用者服务（RACS）和服务提供商安全筛选器实现具有许多配置属性，可用于调整准备发送给IDP的SAML请求和处理来自IDP的SAML响应的方式。</p><h1 id="SAMLWebSSO-ServiceProviderSecurityFilter">服务提供商安全过滤器</h1><p>SP安全筛选器通过检查有效的SSO安全上下文是否可用来保护应用程序端点。如果是，则过滤器使请求继续，如果否，则它将当前用户重定向到IDP。</p><p>当过滤器将用户重定向到IDP时，它会创建一个SAML身份验证请求，请参见此<a shape="rect" class="external-link" href="http://en.wikipedia.org/wiki/SAML_2.0#Web_Browser_SSO_Profile" rel="nofollow">页面</a>的示例，并将其附加到IDP服务URI或将其发布到IDP。<br clear="none">此外，还包括一个指向当前用户请求状态的RelayState令牌，该IDP将<br clear="none">用户通过身份验证后，返回到请求断言消费者服务（RACS）。</p><p>CXF提供了两个SP安全筛选器，一个用于通过GET将用户重定向回IDP，另一个用于通过POST。</p><h2 id="SAMLWebSSO-RedirectBindingFilter">重定向绑定过滤器</h2><p>重定向绑定筛选器由org.apache.cxf.rs.security.saml.sso实现。SamlRedirectBindingFilter。</p><p>这是保护自定义JAX-RS端点的典型过滤器的示例：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;bean id="serviceBean" class="org.apache.cxf.samlp.sso.BookStore"/&gt;

&lt;jaxrs:server address="/app1"&gt; 
       &lt;jaxrs:serviceBeans&gt;
          &lt;ref bean="serviceBean"/&gt;
       &lt;/jaxrs:serviceBeans&gt;
       &lt;jaxrs:providers&gt;
          &lt;ref bean="redirectGetFilter"/&gt;
       &lt;/jaxrs:providers&gt;
&lt;/jaxrs:server&gt;

&lt;bean id="redirectGetFilter" class="org.apache.cxf.rs.security.saml.sso.SamlRedirectBindingFilter"&gt;
      &lt;property name="idpServiceAddress" value="https://localhost:9443/idp"/&gt;
      &lt;!-- both relative and absolute URIs are supported --&gt;
      &lt;property name="assertionConsumerServiceAddress" value="/racs/sso"/&gt;
      &lt;property name="stateProvider" ref="stateManager"/&gt;
&lt;/bean&gt;


&lt;bean id="stateManager" class="org.apache.cxf.rs.security.saml.sso.state.EHCacheSPStateManager"&gt;
    &lt;constructor-arg ref="cxf"/&gt;
&lt;/bean&gt;

</pre>
</div></div><p>请注意，过滤器至少需要设置3个属性：<br clear="none">1。IDP服务地址<br clear="none">2。RACS地址-如果并置了RACS，则可以是绝对地址或相对地址<br clear="none">（共享相同的Web应用程序上下文）与应用程序端点。<br clear="none">3。引用SSO状态提供程序。</p><p>还可以设置以下影响创建的SAML请求的可选属性：</p><ul><li>字符串issuerId-默认为受此过滤器保护的应用程序端点的基本URI，例如“ http：// localhost：8080 / services / app1”。</li><li><a shape="rect" class="external-link" href="http://svn.apache.org/viewvc/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/AuthnRequestBuilder.java?view=markup">AuthnRequestBuilder</a> authnRequestBuilder-构造SAML请求的构建器。它默认为<a shape="rect" class="external-link" href="http://svn.apache.org/viewvc/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/DefaultAuthnRequestBuilder.java?view=markup">DefaultAuthnRequestBuilder</a> 。</li></ul><p>过滤器会将用户重定向到IDP地址，而IDP将用户重定向到RACS地址。<br clear="none">RACS将设置安全上下文，并通过使用RelayState令牌将用户重定向回原始应用程序地址，该令牌在用户最初被重定向到IDP时包含在过滤器中。</p><h2 id="SAMLWebSSO-POSTBindingFilter">POST绑定过滤器</h2><p>POST绑定筛选器由org.apache.cxf.rs.security.saml.sso实现。SamlPostBindingFilter。</p><p>这是保护自定义JAX-RS端点的典型过滤器的示例。</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;bean id="serviceBean" class="org.apache.cxf.samlp.sso.BookStore"/&gt;
&lt;jaxrs:server address="/app2"&gt; 
    &lt;jaxrs:serviceBeans&gt;
       &lt;ref bean="serviceBean"/&gt;
     &lt;/jaxrs:serviceBeans&gt;
     &lt;jaxrs:providers&gt;
          &lt;ref bean="ssoRedirectPOST"/&gt;
          &lt;ref bean="samlRequestFormCreator"/&gt; 
     &lt;/jaxrs:providers&gt;
       
&lt;/jaxrs:server&gt;

&lt;bean id="ssoRedirectPOST" class="org.apache.cxf.rs.security.saml.sso.SamlPostBindingFilter"&gt;
        &lt;property name="idpServiceAddress" value="https://localhost:9443/idp"/&gt;
        &lt;property name="assertionConsumerServiceAddress" value="/racs/sso"/&gt;
        &lt;property name="stateProvider" ref="stateManager"/&gt;

        &lt;property name="useDeflateEncoding" value="true"/&gt;
&lt;/bean&gt;

&lt;bean id="samlRequestFormCreator" class="org.apache.cxf.jaxrs.provider.RequestDispatcherProvider"&gt;
      &lt;property name="dispatcherName" value="jsp"/&gt;
      &lt;property name="useClassNames" value="true"/&gt;
&lt;/bean&gt;
    
&lt;bean id="stateManager" class="org.apache.cxf.rs.security.saml.sso.state.EHCacheSPStateManager"&gt;
    &lt;constructor-arg ref="cxf"/&gt;
&lt;/bean&gt;


</pre>
</div></div><p>请注意，POST绑定过滤器具有与org.apache.cxf.rs.security.saml.sso相同的3个必需属性。SamlRedirectBindingFilter具有但还设置了“ useDeflateEncoding”属性，用于放缩SAML请求。某些IDP可能无法使用POST绑定重定向来处理缩小的SAML请求，因此可以选择禁用压缩。</p><p>在这种情况下，与基于GET的重定向实际上不同的是，过滤器准备了一个<a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/SamlRequestInfo.java">SAMLRequestInfo</a>实例，该实例随后通过JSP过滤器绑定到XHTML视图。该视图通常具有Java Script处理程序，当将其加载到浏览器中时，该处理程序实际上会将用户重定向到IDP。org.apache.cxf.jaxrs.provider促进了查看绑定的数据。RequestDispatcherProvider，请参阅<a shape="rect" href="http://cxf.apache.org/docs/jax-rs-redirection.html#JAX-RSRedirection-WithRequestDispatcherProvider">此页面</a>以获取更多信息。</p><p>如果禁止对IDP的SAML请求编码为URI参数，则可能更喜欢使用POST绑定过滤器。</p><p>这是用于绑定org.apache.cxf.rs.security.saml.sso的典型JSP处理程序。SAMLRequestInfo到视图：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;%@ page import="javax.servlet.http.HttpServletRequest,org.apache.cxf.rs.security.saml.sso.SamlRequestInfo" %&gt;

&lt;%
    SamlRequestInfo data = (SamlRequestInfo)request.getAttribute("samlrequestinfo");
%&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
&lt;body onLoad="document.forms[0].submit();"&gt;
   &lt;form action="&lt;%= data.getIdpServiceAddress() %&gt;" method="POST"&gt;
       &lt;div&gt;             
        &lt;input type="hidden" name="SAMLRequest"
                value="&lt;%= data.getSamlRequest() %&gt;"/&gt;
        &lt;input type="hidden" name="RelayState"
                value="&lt;%= data.getRelayState() %&gt;"/&gt;
       &lt;/div&gt;
        &lt;div&gt;
         &lt;input type="submit" value="Continue"/&gt;
       &lt;/div&gt;
   &lt;/form&gt;
 
&lt;/body&gt;
&lt;/html&gt;
</pre>
</div></div><h2 id="SAMLWebSSO-SigningSAMLAuthenticationRequests">签名SAML身份验证请求</h2><p>筛选器可以选择对SAML请求进行签名，可以设置以下配置属性：</p><ul><li>boolean signRequest-是否签名AuthnRequest。默认为false。</li><li>字符串signatureUsername-用于签署AuthnRequest的密钥库别名。</li><li>Crypto signatureCrypto-WSS4J加密对象，如果要对SAML AuthnRequest进行签名。</li><li>字符串signaturePropertiesFile-指向属性文件，如果要对SAML AuthnRequest进行签名，则该文件可用于加载Crypto实例。</li><li>CallbackHandler callbackHandler-一个CallbackHandler对象，用于检索用于签署请求的私钥密码。</li><li>String callbackHandlerClass-加载用作CallbackHandler对象的类名称。</li></ul><p>如果将“ signRequest”设置为true，则必须设置“ signatureCrypto”或“ signaturePropertiesFile”属性。同样，必须配置“ callbackHandler”或“ callbackHandlerClass”。</p><p>例：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;bean id="ssoSignedRedirectPOST" class="org.apache.cxf.rs.security.saml.sso.SamlPostBindingFilter"&gt;
        &lt;property name="idpServiceAddress" value="https://localhost:9443/idp"/&gt;
        &lt;property name="assertionConsumerServiceAddress" value="/racs/sso"/&gt;
        &lt;property name="stateProvider" ref="stateManager"/&gt;

        &lt;property name="signRequest" value="true"/&gt;

        &lt;property name="callbackHandlerClass" value="org.apache.cxf.samlp.sso.SSOCallbackHandler"/&gt;
        &lt;property name="signatureUsername" value="myservicekey"/&gt;
        &lt;property name="signaturePropertiesFile" value="serviceKeystore.properties"/&gt;
&lt;/bean&gt; 

&lt;bean id="stateManager" class="org.apache.cxf.rs.security.saml.sso.state.EHCacheSPStateManager"&gt;
    &lt;constructor-arg ref="cxf"/&gt;
&lt;/bean&gt;

</pre>
</div></div><h2 id="SAMLWebSSO-FiltersandStateManagement">筛选器和状态管理</h2><p>以下属性影响过滤器管理SSO状态的方式：</p><ul><li><a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/state/SPStateManager.java">SPStateManager</a> stateProvider</li><li>long stateTimeToLive-默认为2分钟（以毫秒为单位）。</li><li>字符串webAppDomain。</li><li>boolean addWebAppContext-默认为true。</li><li>boolean boolean addEndpointAddressToContext-默认为false。</li></ul><p>“ stateProvider”是指自定义<a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/state/SPStateManager.java">SPStateManager的</a>实现，用于过滤器和RACS，与过滤器进行协调以持久保存当前用户请求状态，RACS对其进行验证并持久化当前安全上下文状态，并且过滤器获取有关上下文的信息。过滤器和RACS使用“ RelayState”令牌来处理当前请求状态。RACS保留安全上下文，并且过滤器使用RACS还将其设置为指向此安全上下文的cookie检索并验证它。</p><p>请注意，“ stateTimeToLive”属性可用于控制当前安全上下文的有效期限。</p><p>筛选器和RACS均使用不透明cookie来引用原始请求和安全上下文状态，并且“ webAppDomain”，“ addWebAppContext”和“ addEndpointAddressToContext”会影响在多个SP定制应用程序之间共享这些cookie的方式。</p><p>例如，以下是Web应用程序向浏览器发出的典型Set Cookie请求：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">Set-Cookie: value; Domain=mydomain; Path=/accounts; Expires=Wed, 13-Jan-2021 22:23:01 GMT;
</pre>
</div></div><p>默认情况下，CXF会将Cookie的“路径”属性设置为类似于“ / services”的名称，其中“ services”是战争档案的实际名称。<br clear="none">可以将'addEndpointAddressToContext'属性进一步将此路径限制为类似“ / services / app1”，“ / services / app2”之类的路径，其中“ / app1”和“ / app2”是jaxrs：端点地址，可以方便地进行测试，一次战争中的每个jaxrs：endpoint具有自己的安全上下文。<br clear="none">如果自定义SP应用程序是“散布”在具有不同应用程序上下文名称的多个容器中，则可以将“ addWebAppContext”设置为“ false”，从而将Cookie的“ Path”参数设置为“ /”，并将“ webAppDomain”属性设置为一些共同的价值。</p><p>请注意，stateTimeToLive属性会影响Cookie的“ Expires”属性，但过滤器和RACS也会使用该属性来强制内部状态未过期。</p><h1 id="SAMLWebSSO-RequestAssertionConsumerService">请求断言消费者服务</h1><p>请求断言使用者服务从IDP接收SAML身份验证响应和RelayState令牌，使用该令牌针对原始SAML身份验证请求中可用的数据来验证响应，如果不存在针对其的安全上下文，则创建一个安全上下文<br clear="none">当前用户，将其保留，并将用户重定向回原始端点。</p><p>RACS处理SAML响应，并通过多种方式对其进行验证：</p><ul><li><a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/SAMLProtocolResponseValidator.java">SAMLProtocolResponseValidator</a>根据<a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/SAMLProtocolResponseValidator.java">规范</a>验证响应，并检查响应的签名（如果存在），并对响应的任何子断言执行相同的操作。它还验证响应的状态码。</li><li><a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/SAMLSSOResponseValidator.java">SAMLSSOResponseValidator</a>根据Web SSO配置文件验证响应。</li></ul><p>这是典型的RACS配置：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;bean id="consumerService" class="org.apache.cxf.rs.security.saml.sso.RequestAssertionConsumerService"&gt;
        &lt;property name="stateProvider" ref="stateManager"/&gt;
        &lt;!-- responses are expected to be deflated by default
        &lt;property name="supportDeflateEncoding" value="false"/&gt;
        --&gt;
        &lt;!-- 
           responses are expected to be base64 encoded by default
        --&gt;
        &lt;property name="supportBase64Encoding" value="false"/&gt;
&lt;/bean&gt;

&lt;bean id="stateManager" class="org.apache.cxf.rs.security.saml.sso.state.EHCacheSPStateManager"&gt;
    &lt;constructor-arg ref="cxf"/&gt;
&lt;/bean&gt;


&lt;jaxrs:server address="/racs"&gt; 
   &lt;jaxrs:serviceBeans&gt;
       &lt;ref bean="consumerService"/&gt; 
   &lt;/jaxrs:serviceBeans&gt;
&lt;/jaxrs:server&gt;
</pre>
</div></div><p>RACS被实现为JAX-RS服务器端点。它需要对SSO状态管理器的引用，并且默认情况下期望SAML响应已放气并且可以更改Base64编码。它与过滤器共享相同的“ stateTimeToLive”属性，可用于限制安全上下文状态的保留时间。</p><p>还可以设置以下属性：</p><ul><li>booleanforceKnownIssuer-响应（和子断言）的发布者是否对于RACS是“已知的”。将该值与在过滤器上配置的IDP URL进行比较。默认值是true。</li><li><a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/TokenReplayCache.java">TokenReplayCache</a> replayCache-一个TokenReplayCache实现，用于存储POST绑定的断言ID，以防止重放攻击。<a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/EHCacheTokenReplayCache.java">默认</a>使用基于EhCache的实现。</li></ul><h2 id="SAMLWebSSO-DealingwithsignedSAMLResponses">处理已签名的SAML响应</h2><p>可以设置RACS以支持验证签名的响应或响应中包含的签名的断言。同样，如果您希望支持解密加密的断言，则必须配置“ callbackHandler”或“ callbackHandlerClass”。例如：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;bean id="consumerService" class="org.apache.cxf.rs.security.saml.sso.RequestAssertionConsumerService"&gt;
        &lt;property name="stateProvider" ref="stateManager"/&gt;
        &lt;property name="supportBase64Encoding" value="false"/&gt;

        &lt;property name="signaturePropertiesFile" value="serviceKeystore.properties"/&gt;
        &lt;property name="enforceAssertionsSigned" value="false"/&gt;
        &lt;property name="callbackHandlerClass" value="org.apache.cxf.samlp.sso.SSOCallbackHandler"/&gt;
&lt;/bean&gt;
</pre>
</div></div><p>在此示例中，默认情况下禁用“ enforceAssertionsSigned”（强制已签名的断言包含在响应中），并且RACS仅验证实际的响应已签名。</p><h2 id="SAMLWebSSO-SignatureKeyInfoValidation">签名密钥信息验证</h2><p>默认情况下，ds：Signature应该包含ds：KeyInfo元素。</p><p>将“ keyInfoMustBeAvailable”属性设置为false将导致使用默认存储别名来加载用于验证签名的证书。</p><h2 id="SAMLWebSSO-UsingRACSasEndpointFilter">使用RACS作为端点过滤器</h2><p>从上面的文档中可以看到，RACS通常表示为独立的服务端点或服务Bean：在这种情况下，RACS将请求者重定向回实际的端点。</p><p>从CXF 3.0.0开始，可以将其设置为目标端点过滤器，只需添加org.apache.cxf.rs.security.saml.sso。RequestionAssertionConsumerFilter到其他端点提供程序的列表。</p><p>在这种情况下，身份验证筛选器不必设置其“ assertionConsumerServiceAddress”属性</p><h1 id="SAMLWebSSO-SSOStateProvider">SSO国家提供者</h1><p>SP安全筛选器和RACS依赖于自定义<a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/state/SPStateManager.java">SPStateManager</a>实现，以持久保存当前请求和安全上下文状态。</p><p>CXF提供了一个基本的<a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/state/MemorySPStateManager.java">MemorySPStateProvider</a>和一个基于<a shape="rect" class="external-link" href="http://ehcache.org/" rel="nofollow">EhCache</a>的<a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/state/EHCacheSPStateManager.java">实现</a> ，该<a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/state/EHCacheSPStateManager.java">实现</a>基于内存，并且可以选择溢出到磁盘。用户可以自定义EhCache提供程序，也可以根据需要注册自己的自定义SPStateProvider实现。</p><p>例如，默认情况下，EhCache提供程序会将数据溢出到系统temp目录中，并且不会在重新启动后持久保存数据。可以使用以下EhCache配置进行更改：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;ehcache xsi:noNamespaceSchemaLocation="ehcache.xsd" updateCheck="false" monitoring="autodetect" dynamicConfig="true"&gt;

    &lt;diskStore path="/home/username/work/ehcache"/&gt;

    &lt;defaultCache
            maxEntriesLocalHeap="5000"
            timeToIdleSeconds="3600"
            timeToLiveSeconds="3600"
            overflowToDisk="true"
            maxElementsOnDisk="10000000"
            diskPersistent="true"
            diskExpiryThreadIntervalSeconds="120"
            memoryStoreEvictionPolicy="LRU"
            /&gt;
&lt;/ehcache&gt;

Assuming this configuration is saved in WEB-INF/ehcache.xml, the EhCache provider can be configured as follows:

{code:xml}
&lt;bean id="stateManager" class="org.apache.cxf.rs.security.saml.sso.state.EHCacheSPStateManager"&gt;
    &lt;constructor-arg value="/WEB-INF/ehcache.xml"/&gt;
&lt;/bean&gt;
</pre>
</div></div><h2 id="SAMLWebSSO-DistributedStateManagement">分布式状态管理</h2><p>如果您有一个复杂的应用程序，该应用程序受到部署在不同容器中的大量战争的支持，则必须决定是拥有单个RequestAssertionConsumerService（RACS）端点，IDP在处理用户身份验证请求时将重定向到该端点，还是每个端点有一个单独的RACS端点Web应用程序，它们构成了一个更大的应用程序。</p><p>例如，假设您有server1，server2和server3，它们都支持更大的应用程序。可以有一个将托管RACS端点的serverRacs Web应用程序。接下来，当将用户重定向到IDP时，server1，server2和server3 SSO筛选器都将指向该独立的RACS端点，并且IDP最终会将用户重定向到RACS，后者又会将用户重定向到服务器或server2或服务器支持的原始目标URI。服务器3。</p><p>在这种情况下，必须决定如何共享保护单个服务器的SSO安全筛选器和RACS之间的状态。<br clear="none">一种方法是设置Ehcache提供程序以将<a shape="rect" class="external-link" href="http://ehcache.org/documentation/configuration/distributed-cache-configuration" rel="nofollow">Terracotta或RMI与多播一起使用，</a>或者实施完全不涉及Ehcache的替代方法。</p><p>CXF提供了一个简单的<a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/cxf/trunk/rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/state/HTTPSPStateManager.java">HTTPSPStateManager</a>提供程序，该提供程序可用于简化设置分布式状态缓存的任务，该概念可用于简单的分布式Web应用程序或在概念验证阶段支持更高级的应用程序。</p><p>例如，可以将以下jaxrs：endpoint与在其自己的Web应用程序中运行的RACS端点一起部署：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">    &lt;bean id="stateManager" class="org.apache.cxf.rs.security.saml.sso.state.HTTPSPStateManager"/&gt;

    &lt;bean id="consumerService" class="org.apache.cxf.rs.security.saml.sso.RequestAssertionConsumerService"&gt;
        &lt;property name="stateProvider" ref="stateManager"/&gt;
        &lt;property name="signaturePropertiesFile" value="serviceKeystore.properties"/&gt;
        &lt;property name="callbackHandlerClass" value="oauth2.sso.SSOCallbackHandler"/&gt;
    &lt;/bean&gt;
    
    &lt;jaxrs:server address="/"&gt; 
       &lt;jaxrs:serviceBeans&gt;
          &lt;ref bean="consumerService"/&gt;
          &lt;ref bean="stateManager"/&gt; 
       &lt;/jaxrs:serviceBeans&gt;
    &lt;/jaxrs:server&gt;
</pre>
</div></div><p>请注意，RACS bean本身直接使用HTTPSPStateManager，它也可用作所有SSO安全过滤器使用的HTTP端点。<br clear="none">以下是单个SSO筛选器端的SPStateManagers如何使用此HTTP终结点的示例：</p><div class="code panel pdl" style="border-width:1px"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default" style="font-size:12px;">&lt;jaxrs:client id="stateManager"
         address="https://localhost:${racs.port}/racs"
         serviceClass="org.apache.cxf.rs.security.saml.sso.state.HTTPSPStateManager"/&gt;
         
 &lt;bean id="ssoRedirectURI" class="org.apache.cxf.rs.security.saml.sso.SamlRedirectBindingFilter"&gt;
    &lt;property name="idpServiceAddress" value="${idp.address}"/&gt;
    &lt;property name="assertionConsumerServiceAddress" 
               value="https://localhost:${racs.port}/racs/sso"/&gt;
    &lt;property name="stateProvider" ref="stateManager"/&gt;
    &lt;property name="addWebAppContext" value="false"/&gt; 
 &lt;/bean&gt;

</pre>
</div></div><p>注意，HTTPSPStateManager端点的JAX-RS客户端代理用作SPStateManager参考。</p><p>设置分布式状态缓存的另一种方法是简单地将一个RACS端点与构成更大应用程序的每个单独的Web应用程序并置，请参阅前面的部分，介绍如何轻松设置SSO过滤器。一种可能的缺点是，将没有集中式存储来管理不同过滤器和RACS所要求的状态，从而使审核和记录跨所有较大应用程序的所有SSO相关活动变得更加困难。</p><p> </p><h1 id="SAMLWebSSO-LogoutService">登出服务</h1><p> </p><p>CXF 3.0.0引入了<a shape="rect" class="external-link" href="https://git-wip-us.apache.org/repos/asf?p=cxf.git;a=blob;f=rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/LogoutService.java;h=048f7c11ccc5f8dd8fd243e4b8344901420d6652;hb=HEAD">LogoutService</a> 。它将删除已登录用户的SSO状态，并且可以注册为独立的端点或服务Bean。</p><p>它返回预期由View处理程序处理的LogoutResponse bean。</p><p>例如，可以想象一个用户获得HTML页面以确认注销成功并链接到应用程序首页。</p><h1 id="SAMLWebSSO-MetadataService">元数据服务</h1><p> </p><p>CXF 3.1.0和3.0.5中提供了新的<a shape="rect" class="external-link" href="https://git-wip-us.apache.org/repos/asf?p=cxf.git;a=blob;f=rt/rs/security/sso/saml/src/main/java/org/apache/cxf/rs/security/saml/sso/MetadataService.java;h=63619c313b6e2adae48f1b72476d3d1de81212c6;hb=HEAD">MetadataService</a> ，可以为给定服务发布SAML SSO元数据。与注销服务类似，它被注册为独立的端点或服务Bean。在CXF系统测试中， <a shape="rect" class="external-link" href="https://git-wip-us.apache.org/repos/asf?p=cxf.git;a=blob;f=systests/rs-security/src/test/java/org/apache/cxf/systest/jaxrs/security/samlsso/metadata-server.xml;h=e130b3cb727051f6c0db3e7e3d571dc19cb536cc;hb=HEAD">此处</a>提供<a shape="rect" class="external-link" href="https://git-wip-us.apache.org/repos/asf?p=cxf.git;a=blob;f=systests/rs-security/src/test/java/org/apache/cxf/systest/jaxrs/security/samlsso/metadata-server.xml;h=e130b3cb727051f6c0db3e7e3d571dc19cb536cc;hb=HEAD">了</a>一个示例弹簧配置。</p></div>
           </div>
           <!-- Content -->
         </td>
        </tr>
      </tbody></table>
   </td>
   <td id="cell-2-2" colspan="2"> </td>
  </tr>
  <tr>
   <td id="cell-3-0"> </td>
   <td id="cell-3-1"> </td>
   <td id="cell-3-2">
     <div id="footer">
       <!-- Footer -->
       <div id="site-footer">
         <a href="http://cxf.apache.org/privacy-policy.html">隐私政策</a> -（ <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=27850442">编辑页面</a> ）（ <a href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27850442&showComments=true&showCommentArea=true#addcomment">添加评论</a> ）<br>Apache CXF，CXF，Apache，Apache Feather徽标是The Apache Software Foundation的商标。<br>提及的所有其他商标可能是其各自所有者的商标或注册商标。
       </div>
       <!-- Footer -->
     </div>
   </td>
   <td id="cell-3-3"> </td>
   <td id="cell-3-4"> </td>
  </tr>
  <tr>
    <td id="cell-4-0" colspan="2"> </td>
    <td id="cell-4-1"> </td>
    <td id="cell-4-2" colspan="2"> </td>
  </tr>
</tbody></table>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-4458903-1");
pageTracker._trackPageview();
} catch(err) {}</script>




</body></html>