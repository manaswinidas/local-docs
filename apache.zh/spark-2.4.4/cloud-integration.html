<html class="no-js" ><!--<![endif]--><head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>与云基础架构的集成-Spark 2.4.4文档</title>
        
          <meta name="description" content="Introduction to cloud storage support in Apache Spark 2.4.4">
        

        

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <style>
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
        </style>
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="css/bootstrap-responsive.min.css">
        <link rel="stylesheet" href="css/main.css">

        <script src="js/vendor/modernizr-2.6.1-respond-1.1.0.min.js"></script>

        <link rel="stylesheet" href="css/pygments-default.css">

        
        <!-- Google analytics script -->
        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-32518208-2']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>
        

    </head>
    <body >
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="https://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->

        <!-- This code is taken from http://twitter.github.com/bootstrap/examples/hero.html -->

        <div class="navbar navbar-fixed-top" id="topbar">
            <div class="navbar-inner">
                <div class="container">
                    <div class="brand"><a href="index.html"><img src="img/spark-logo-hd.png" style="height:50px"></a> <span class="version">2.4.4</span>
                    </div>
                    <ul class="nav">
                        <!--TODO(andyk): Add class="active" attribute to li some how.-->
                        <li><a href="index.html">总览</a></li>

                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">编程指南<b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="quick-start.html">快速开始</a></li>
                                <li><a href="rdd-programming-guide.html">RDD，累加器，广播变量</a></li>
                                <li><a href="sql-programming-guide.html">SQL，数据框和数据集</a></li>
                                <li><a href="structured-streaming-programming-guide.html">结构化流</a></li>
                                <li><a href="streaming-programming-guide.html">火花流（DStreams）</a></li>
                                <li><a href="ml-guide.html">MLlib（机器学习）</a></li>
                                <li><a href="graphx-programming-guide.html">GraphX（图形处理）</a></li>
                                <li><a href="sparkr.html">SparkR（Spark上的R）</a></li>
                            </ul>
                        </li>

                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">API文件<b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="api/scala/index.html#org.apache.spark.package">斯卡拉</a></li>
                                <li><a href="api/java/index.html">爪哇</a></li>
                                <li><a href="api/python/index.html">蟒蛇</a></li>
                                <li><a href="api/R/index.html">[R</a></li>
                                <li><a href="api/sql/index.html">SQL，内置函数</a></li>
                            </ul>
                        </li>

                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">部署中<b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="cluster-overview.html">总览</a></li>
                                <li><a href="submitting-applications.html">提交申请</a></li>
                                <li class="divider"></li>
                                <li><a href="spark-standalone.html">Spark独立</a></li>
                                <li><a href="running-on-mesos.html">梅索斯</a></li>
                                <li><a href="running-on-yarn.html">纱</a></li>
                                <li><a href="running-on-kubernetes.html">Kubernetes</a></li>
                            </ul>
                        </li>

                        <li class="dropdown">
                            <a href="api.html" class="dropdown-toggle" data-toggle="dropdown">更多<b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="configuration.html">组态</a></li>
                                <li><a href="monitoring.html">监控方式</a></li>
                                <li><a href="tuning.html">调音指南</a></li>
                                <li><a href="job-scheduling.html">作业调度</a></li>
                                <li><a href="security.html">安全</a></li>
                                <li><a href="hardware-provisioning.html">硬件配置</a></li>
                                <li class="divider"></li>
                                <li><a href="building-spark.html">建筑火花</a></li>
                                <li><a href="https://spark.apache.org/contributing.html">为Spark贡献</a></li>
                                <li><a href="https://spark.apache.org/third-party-projects.html">第三方项目</a></li>
                            </ul>
                        </li>
                    </ul>
                    <!--<p class="navbar-text pull-right"><span class="version-text">v2.4.4</span></p>-->
                </div>
            </div>
        </div>

        <div class="container-wrapper">

            
                <div class="content" id="content">
                    
                        <h1 class="title">与云基础架构集成</h1>
                    

                    <!--
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
-->

<ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">介绍</a>    <ul>
      <li><a href="#important-cloud-object-stores-are-not-real-filesystems" id="markdown-toc-important-cloud-object-stores-are-not-real-filesystems">重要：云对象存储不是真实的文件系统</a></li>
      <li><a href="#installation" id="markdown-toc-installation">安装</a></li>
      <li><a href="#authenticating" id="markdown-toc-authenticating">验证中</a></li>
    </ul>
  </li>
  <li><a href="#configuring" id="markdown-toc-configuring">配置中</a>    <ul>
      <li><a href="#recommended-settings-for-writing-to-object-stores" id="markdown-toc-recommended-settings-for-writing-to-object-stores">写入对象存储的推荐设置</a></li>
      <li><a href="#parquet-io-settings" id="markdown-toc-parquet-io-settings">实木复合地板I / O设置</a></li>
      <li><a href="#orc-io-settings" id="markdown-toc-orc-io-settings">ORC I / O设置</a></li>
    </ul>
  </li>
  <li><a href="#spark-streaming-and-object-storage" id="markdown-toc-spark-streaming-and-object-storage">Spark流和对象存储</a></li>
  <li><a href="#further-reading" id="markdown-toc-further-reading">进一步阅读</a></li>
</ul>

<h2 id="introduction">介绍</h2>

<p>所有主要的云提供商都在<em>对象存储中</em>提供持久的数据存储。这些不是经典的“ POSIX”文件系统。为了存储数百PB的数据而没有任何单点故障，对象存储库用一个更简单的模型替换了传统的文件系统目录树<code>object-name => data</code> 。为了启用远程访问，通常以（慢速）HTTP REST操作的形式提供对对象的操作。</p>

<p>Spark可以通过Hadoop中实现的或由基础架构供应商自己提供的文件系统连接器在对象存储中读取和写入数据。这些连接器使对象存储看起来<em>几乎</em>像文件系统，具有目录和文件以及其上的经典操作，例如列表，删除和重命名。</p>

<h3 id="important-cloud-object-stores-are-not-real-filesystems">重要：云对象存储不是真实的文件系统</h3>

<p>尽管存储看起来像是文件系统，但在它们的下面仍然是对象存储， <a href="https://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-common/filesystem/introduction.html">两者之间的区别非常明显</a></p>

<p><em>除非明确说明，否则</em>它们不能用作群集文件系统（例如HDFS）的直接替代。</p>

<p>主要区别在于：</p>

<ul>
  <li>在目录列表和实际数据访问中，可能都不会立即看到对存储对象的更改。</li>
  <li>仿真目录的方法可能会使使用它们的速度变慢。</li>
  <li>重命名操作可能非常慢，并且在失败时会使存储处于未知状态。</li>
  <li>在文件中查找可能需要新的HTTP调用，从而影响性能。</li>
</ul>

<p>这对Spark有何影响？</p>

<ol>
  <li>读写数据可能比使用普通文件系统慢得多。</li>
  <li>在查询拆分计算期间，某些目录结构可能效率很低。</li>
  <li>后续查询可能不会立即看到工作的输出。</li>
  <li>当保存RDD，DataFrame或Dataset时，Spark正常执行的基于重命名的算法可能既缓慢又不可靠。</li>
</ol>

<p>由于这些原因，将对象库用作查询的直接目的地或用作查询链中的中间存储并不总是安全的。请查阅对象库及其连接器的文档，以确定哪些使用被认为是安全的。</p>

<p>特别是： <em>如果没有某种形式的一致性层，则无法将Amazon S3安全地用作普通的基于重命名的提交者的直接工作目的地。</em></p>

<h3 id="installation">安装</h3>

<p>借助在类路径上的相关库以及配置了有效凭据的Spark，可以使用对象的URL作为数据路径来读取或写入对象。例如<code>sparkContext.textFile("s3a://landsat-pds/scene_list.gz")</code>将创建文件的RDD <code>scene_list.gz</code>使用s3a连接器存储在S3中。</p>

<p>要将相关库添加到应用程序的类路径，请包含<code>hadoop-cloud</code>模块及其依赖项。</p>

<p>在Maven中，将以下内容添加到<code>pom.xml</code>文件，假设<code>spark.version</code>设置为选定的Spark版本：</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;dependencyManagement&gt;</span>
  ...
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.spark<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>hadoop-cloud_2.11<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${spark.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
  ...
<span class="nt">&lt;/dependencyManagement&gt;</span></code></pre></figure>

<p>基于Apache Spark的商业产品通常直接设置用于与云基础架构通信的类路径，在这种情况下，可能不需要此模块。</p>

<h3 id="authenticating">验证中</h3>

<p>Spark作业必须通过对象存储进行身份验证才能访问其中的数据。</p>

<ol>
  <li>当Spark在云基础架构中运行时，通常会自动设置凭据。</li>
  <li><code>spark-submit</code>读<code>AWS_ACCESS_KEY</code> ， <code>AWS_SECRET_KEY</code>和<code>AWS_SESSION_TOKEN</code>环境变量，并为<code>s3n</code>和<code>s3a</code> Amazon S3的连接器。</li>
  <li>在Hadoop群集中，可以在<code>core-site.xml</code>文件。</li>
  <li>身份验证详细信息可以手动添加到Spark配置中<code>spark-defaults.conf</code></li>
  <li>另外，也可以通过编程方式在<code>SparkConf</code>用于配置应用程序的实例<code>SparkContext</code> 。</li>
</ol>

<p><em>重要提示：切勿将身份验证机密检入源代码存储库，尤其是公共存储库</em></p>

<p>有关相关的配置和安全性选项，请查阅<a href="https://hadoop.apache.org/docs/current/">Hadoop文档</a> 。</p>

<h2 id="configuring">配置中</h2>

<p>每个云连接器都有自己的一组配置参数，请再次查阅相关文档。</p>

<h3 id="recommended-settings-for-writing-to-object-stores">写入对象存储的推荐设置</h3>

<p>对于其一致性模型意味着基于重命名的提交是安全的对象存储，请使用<code>FileOutputCommitter</code> v2性能算法：</p>

<pre><code>spark.hadoop.mapreduce.fileoutputcommitter.algorithm.version 2
</code></pre>

<p>与“版本1”算法相比，此操作在工作结束时的重命名更少。由于它仍然使用<code>rename()</code>提交文件，如果对象存储库中的元数据/列表不一致，则使用它是不安全的。</p>

<p>提交者还可以设置为在清除临时文件时忽略失败；这减少了瞬态网络问题升级为作业失败的风险：</p>

<pre><code>spark.hadoop.mapreduce.fileoutputcommitter.cleanup-failures.ignored true
</code></pre>

<p>由于存储临时文件可能会增加费用；删除名为<code>"_temporary"</code>定期避免这种情况。</p>

<h3 id="parquet-io-settings">实木复合地板I / O设置</h3>

<p>为了在处理Parquet数据时获得最佳性能，请使用以下设置：</p>

<pre><code>spark.hadoop.parquet.enable.summary-metadata false
spark.sql.parquet.mergeSchema false
spark.sql.parquet.filterPushdown true
spark.sql.hive.metastorePartitionPruning true
</code></pre>

<p>这些将查询期间读取的数据量减到最少。</p>

<h3 id="orc-io-settings">ORC I / O设置</h3>

<p>为了在使用ORC数据时获得最佳性能，请使用以下设置：</p>

<pre><code>spark.sql.orc.filterPushdown true
spark.sql.orc.splits.include.file.footer true
spark.sql.orc.cache.stripe.details.size 10000
spark.sql.hive.metastorePartitionPruning true
</code></pre>

<p>同样，这些方法将查询期间读取的数据量减到最少。</p>

<h2 id="spark-streaming-and-object-storage">Spark流和对象存储</h2>

<p>Spark Streaming可以通过创建一个<code>FileInputDStream</code>通过调用来监视商店中的路径<code>StreamingContext.textFileStream()</code> 。</p>

<ol>
  <li>
    <p>扫描新文件的时间与路径下的文件数成正比，而不是与<em>新</em>文件数成正比，因此它可能会变慢。需要设置窗口的大小以处理此问题。</p>
  </li>
  <li>
    <p>文件只有在完全写入后才会出现在对象存储中。无需使用“先写后重命名”的工作流程来确保在仍在写入文件时不会拾取文件。应用程序可以直接写入受监视的目录。</p>
  </li>
  <li>
    <p>流应该仅被检查点指向实现了快速和原子的商店<code>rename()</code>操作。否则，检查点可能很慢并且可能不可靠。</p>
  </li>
</ol>

<h2 id="further-reading">进一步阅读</h2>

<p>这是来自Apache和云提供商的标准连接器的文档。</p>

<ul>
  <li><a href="https://hadoop.apache.org/docs/current/hadoop-openstack/index.html">OpenStack Swift</a> 。 Hadoop 2.6以上</li>
  <li><a href="https://hadoop.apache.org/docs/current/hadoop-aws/tools/hadoop-aws/index.html">Azure Blob存储</a> 。从Hadoop 2.7开始</li>
  <li><a href="https://hadoop.apache.org/docs/current/hadoop-azure-datalake/index.html">Azure数据湖</a> 。从Hadoop 2.8开始</li>
  <li><a href="https://hadoop.apache.org/docs/current/hadoop-aws/tools/hadoop-aws/index.html">通过S3A和S3N的Amazon S3</a> 。 Hadoop 2.6以上</li>
  <li><a href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-fs.html">Amazon EMR文件系统（EMRFS）</a> 。从亚马逊</li>
  <li><a href="https://cloud.google.com/hadoop/google-cloud-storage-connector">适用于Spark和Hadoop的Google云存储连接器</a> 。来自Google</li>
</ul>



                </div>
            
             <!-- /container -->
        </div>

        <script src="js/vendor/jquery-1.12.4.min.js"></script>
        <script src="js/vendor/bootstrap.min.js"></script>
        <script src="js/vendor/anchor.min.js"></script>
        <script src="js/main.js"></script>

        <!-- MathJax Section -->
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                TeX: { equationNumbers: { autoNumber: "AMS" } }
            });
        </script>
        <script>
            // Note that we load MathJax this way to work with local file (file://), HTTP and HTTPS.
            // We could use "//cdn.mathjax...", but that won't support "file://".
            (function(d, script) {
                script = d.createElement('script');
                script.type = 'text/javascript';
                script.async = true;
                script.onload = function(){
                    MathJax.Hub.Config({
                        tex2jax: {
                            inlineMath: [ ["$", "$"], ["\\\\(","\\\\)"] ],
                            displayMath: [ ["$$","$$"], ["\\[", "\\]"] ],
                            processEscapes: true,
                            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
                        }
                    });
                };
                script.src = ('https:' == document.location.protocol ? 'https://' : 'http://') +
                    'cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js' +
                    '?config=TeX-AMS-MML_HTMLorMML';
                d.getElementsByTagName('head')[0].appendChild(script);
            }(document));
        </script>
    

</body></html>