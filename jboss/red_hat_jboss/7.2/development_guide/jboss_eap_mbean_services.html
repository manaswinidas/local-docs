<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 8. JBoss EAP MBean Services</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="jboss_eap_mbean_services"/>Chapter 8. JBoss EAP MBean Services</h1></div></div></div><p>
			A managed bean, sometimes simply referred to as an MBean, is a type of JavaBean that is created with dependency injection. MBean services are the core building blocks of the JBoss EAP server.
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="writing_jboss_mbean_services"/>Writing JBoss MBean Services</h1></div></div></div><p>
				Writing a custom MBean service that relies on a JBoss service requires the service interface method pattern. A JBoss MBean service interface method pattern consists of a set of life cycle operations that inform an MBean service when it can <code class="literal">create</code>, <code class="literal">start</code>, <code class="literal">stop</code>, and <code class="literal">destroy</code> itself.
			</p><p>
				You can manage the dependency state using any of the following approaches:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						If you want specific methods to be called on your MBean, declare those methods in your MBean interface. This approach allows your MBean implementation to avoid dependencies on JBoss specific classes.
					</li><li class="listitem">
						If you are not bothered about dependencies on JBoss specific classes, then you can have your MBean interface extend the <code class="literal">ServiceMBean</code> interface and <code class="literal">ServiceMBeanSupport</code> class. The <code class="literal">ServiceMBeanSupport</code> class provides implementations of the service lifecycle methods like create, start, and stop. To handle a specific event like the <code class="literal">start()</code> event, you need to override <code class="literal">startService()</code> method provided by the <code class="literal">ServiceMBeanSupport</code> class.
					</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="a_standard_mbean_example"/>A Standard MBean Example</h2></div></div></div><p>
					This section develops two example MBean services packaged together in a service archive (<code class="literal">.sar</code>).
				</p><p>
					<code class="literal">ConfigServiceMBean</code> interface declares specific methods like the <code class="literal">start</code>, <code class="literal">getTimeout</code>, and <code class="literal">stop</code> methods to <code class="literal">start</code>, <code class="literal">hold</code>, and <code class="literal">stop</code> the MBean correctly without using any JBoss specific classes. <code class="literal">ConfigService</code> class implements <code class="literal">ConfigServiceMBean</code> interface and consequently implements the methods used within that interface.
				</p><p>
					The <code class="literal">PlainThread</code> class extends the <code class="literal">ServiceMBeanSupport</code> class and implements the <code class="literal">PlainThreadMBean</code> interface. <code class="literal">PlainThread</code> starts a thread and uses <code class="literal">ConfigServiceMBean.getTimeout()</code> to determine how long the thread should sleep.
				</p><div class="title"><strong>Example: MBean Services Class</strong></div><p>
						
</p><pre class="programlisting">package org.jboss.example.mbean.support;
public interface ConfigServiceMBean {
    int getTimeout();
    void start();
    void stop();
}
package org.jboss.example.mbean.support;
public class ConfigService implements ConfigServiceMBean {
    int timeout;
    @Override
    public int getTimeout() {
        return timeout;
    }
    @Override
    public void start() {
        //Create a random number between 3000 and 6000 milliseconds
        timeout = (int)Math.round(Math.random() * 3000) + 3000;
        System.out.println("Random timeout set to " + timeout + " seconds");
    }
    @Override
    public void stop() {
        timeout = 0;
    }
}

package org.jboss.example.mbean.support;
import org.jboss.system.ServiceMBean;
public interface PlainThreadMBean extends ServiceMBean {
    void setConfigService(ConfigServiceMBean configServiceMBean);
}

package org.jboss.example.mbean.support;
import org.jboss.system.ServiceMBeanSupport;
public class PlainThread extends ServiceMBeanSupport implements PlainThreadMBean {
    private ConfigServiceMBean configService;
    private Thread thread;
    private volatile boolean done;
    @Override
    public void setConfigService(ConfigServiceMBean configService) {
        this.configService = configService;
    }
    @Override
    protected void startService() throws Exception {
        System.out.println("Starting Plain Thread MBean");
        done = false;
        thread = new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    while (!done) {
                        System.out.println("Sleeping....");
                        Thread.sleep(configService.getTimeout());
                        System.out.println("Slept!");
                    }
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
        });
        thread.start();
    }
    @Override
    protected void stopService() throws Exception {
        System.out.println("Stopping Plain Thread MBean");
        done = true;
    }
}</pre><p>

					</p><p>
					The <code class="literal">jboss-service.xml</code> descriptor shows how the <code class="literal">ConfigService</code> class is injected into the <code class="literal">PlainThread</code> class using the <code class="literal">inject</code> tag. The <code class="literal">inject</code> tag establishes a dependency between <code class="literal">PlainThreadMBean</code> and <code class="literal">ConfigServiceMBean</code>, and thus allows <code class="literal">PlainThreadMBean</code> to use <code class="literal">ConfigServiceMBean</code> easily.
				</p><div class="title"><strong>Example: <code class="literal">jboss-service.xml</code> Service Descriptor</strong></div><p>
						
</p><pre class="programlisting">&lt;server xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="urn:jboss:service:7.0 jboss-service_7_0.xsd"
        xmlns="urn:jboss:service:7.0"&gt;
 &lt;mbean code="org.jboss.example.mbean.support.ConfigService" name="jboss.support:name=ConfigBean"/&gt;
 &lt;mbean code="org.jboss.example.mbean.support.PlainThread" name="jboss.support:name=ThreadBean"&gt;
  &lt;attribute name="configService"&gt;
   &lt;inject bean="jboss.support:name=ConfigBean"/&gt;
  &lt;/attribute&gt;
 &lt;/mbean&gt;
&lt;/server&gt;</pre><p>

					</p><p>
					After writing the MBeans example, you can package the classes and the <code class="literal">jboss-service.xml</code> descriptor in the <code class="literal">META-INF/</code> folder of a service archive (<code class="literal">.sar</code>).
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="deploying_jboss_mbean_services"/>Deploying JBoss MBean Services</h1></div></div></div><div class="title"><strong>Example: Deploy and Test MBeans in a Managed Domain</strong></div><p>
					Use the following command to deploy the example MBeans (<code class="literal">ServiceMBeanTest.sar</code>) in a managed domain:
				</p><pre class="screen">deploy ~/Desktop/ServiceMBeanTest.sar --all-server-groups</pre><div class="title"><strong>Example: Deploy and Test MBeans on a Standalone Server</strong></div><p>
					Use the following command to build and deploy the example MBeans (<code class="literal">ServiceMBeanTest.sar</code>) on a standalone server:
				</p><pre class="screen">deploy ~/Desktop/ServiceMBeanTest.sar</pre><div class="title"><strong>Example: Undeploy the MBeans Archive</strong></div><p>
					Use the following command to undeploy the MBeans example:
				</p><pre class="screen">undeploy ServiceMBeanTest.sar</pre></div></div></body></html>