<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 5. EJB Subsystem Tuning</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="ejb_subsystem_tuning"/>Chapter 5. EJB Subsystem Tuning</h1></div></div></div><p>
			JBoss EAP can cache Enterprise Java Beans (EJBs) to save initialization time. This is accomplished using bean pools.
		</p><p>
			There are two different bean pools that can be tuned in JBoss EAP: <a class="link" href="ejb_subsystem_tuning.html#bean_instance_pools" title="Bean Instance Pools">bean instance pools</a> and <a class="link" href="ejb_subsystem_tuning.html#bean_thread_pools" title="Bean Thread Pools">bean thread pools</a>.
		</p><p>
			Appropriate bean pool sizes depend on your environment and applications. It is recommended that you experiment with different bean pool sizes and perform stress testing in a development environment that emulates your expected real-world conditions.
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="bean_instance_pools"/>Bean Instance Pools</h1></div></div></div><p>
				Bean instance pools are used for Stateless Session Beans (SLSBs) and Message Driven Beans (MDBs). By default, SLSBs use the instance pool <code class="literal">default-slsb-instance-pool</code>, and MDBs use the instance pool <code class="literal">default-mdb-instance-pool</code>.
			</p><p>
				The size of a bean instance pool limits the number of instances of a particular EJB that can be created at one time. If the pool for a particular EJB is full, the client will block and wait for an instance to become available. If a client does not get an instance within the time set in the pool’s <code class="literal">timeout</code> attributes, an exception is thrown.
			</p><p>
				The size of a bean instance pool is configured using either <code class="literal">derive-size</code> or <code class="literal">max-pool-size</code>. The <code class="literal">derive-size</code> attribute allows you to configure the pool size using one of the following values:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<code class="literal">from-worker-pools</code>, which indicates that the maximum pool size is derived from the size of the total threads for all worker pools configured on the system.
					</li><li class="listitem">
						<code class="literal">from-cpu-count</code>, which indicates that the maximum pool size is derived from the total number of processors available on the system. Note that this is not necessarily a 1:1 mapping, and might be augmented by other factors.
					</li></ul></div><p>
				If <code class="literal">derive-size</code> is undefined, then the value of <code class="literal">max-pool-size</code> is used for the size of the bean instance pool.
			</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					The <code class="literal">derive-size</code> attribute overrides any value specified in <code class="literal">max-pool-size</code>. <code class="literal">derive-size</code> must be undefined for the <code class="literal">max-pool-size</code> value to take effect.
				</p></div><p>
				You can configure an EJB to use a specific instance pool. This allows for finer control of the instances available to each EJB type.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="creating_a_bean_instance_pool"/>Creating a Bean Instance Pool</h2></div></div></div><p>
					This section shows you how to create a new bean instance pool using the management CLI. You can also configure bean instance pools using the management console by navigating to the <span class="strong"><strong>EJB</strong></span> subsystem from the <span class="strong"><strong>Configuration</strong></span> tab, and then selecting the <span class="strong"><strong>Bean Pool</strong></span> tab.
				</p><p>
					To create a new instance pool, use one of the following commands:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
							To create a bean instance pool with a derived maximum pool size:
						</p><pre class="screen">/subsystem=ejb3/strict-max-bean-instance-pool=<span class="emphasis"><em>POOL_NAME</em></span>:add(derive-size=<span class="emphasis"><em>DERIVE_OPTION</em></span>,timeout-unit=<span class="emphasis"><em>TIMEOUT_UNIT</em></span>,timeout=<span class="emphasis"><em>TIMEOUT_VALUE</em></span>)</pre><p class="simpara">
							The following example creates a bean instance pool named <code class="literal">my_derived_pool</code> with a maximum size derived from the CPU count, and a timeout of 2 minutes:
						</p><pre class="screen">/subsystem=ejb3/strict-max-bean-instance-pool=my_derived_pool:add(derive-size=from-cpu-count,timeout-unit=MINUTES,timeout=2)</pre></li><li class="listitem"><p class="simpara">
							To create a bean instance pool with an explicit maximum pool size:
						</p><pre class="screen">/subsystem=ejb3/strict-max-bean-instance-pool=<span class="emphasis"><em>POOL_NAME</em></span>:add(max-pool-size=<span class="emphasis"><em>POOL_SIZE</em></span>,timeout-unit=<span class="emphasis"><em>TIMEOUT_UNIT</em></span>,timeout=<span class="emphasis"><em>TIMEOUT_VALUE</em></span>)</pre><p class="simpara">
							The following example creates a bean instance pool named <code class="literal">my_pool</code> with a maximum of 30 instances and a timeout of 30 seconds:
						</p><pre class="screen">/subsystem=ejb3/strict-max-bean-instance-pool=my_pool:add(max-pool-size=30,timeout-unit=SECONDS,timeout=30)</pre></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="specifying_bean_instance_pool"/>Specifying the Instance Pool a Bean Should Use</h2></div></div></div><p>
					You can set a specific instance pool that a particular bean will use either by using the <code class="literal">@org.jboss.ejb3.annotation.Pool</code> annotation, or by modifying the <code class="literal">jboss-ejb3.xml</code> deployment descriptor of the bean. See the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/developing_ejb_applications/#jboss_ejb3_xml_deployment_descriptor_reference"><code class="literal">jboss-ejb3.xml</code> Deployment Descriptor Reference</a> in <span class="emphasis"><em>Developing EJB Applications</em></span> for more information.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="disabling_the_default_bean_instance_pool"/>Disabling the Default Bean Instance Pool</h2></div></div></div><p>
					The default bean instance pool can be disabled, which results in EJBs not using any instance pool by default. Instead, a new EJB instance is created when a thread needs to invoke a method on an EJB. This might be useful if you do not want any limit on the number of EJB instances that are created.
				</p><p>
					To disable the default bean instance pool, use the following management CLI command:
				</p><pre class="screen">/subsystem=ejb3:undefine-attribute(name=default-slsb-instance-pool)</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						If a bean is <a class="link" href="ejb_subsystem_tuning.html#specifying_bean_instance_pool" title="Specifying the Instance Pool a Bean Should Use">configured to use a particular bean instance pool</a>, disabling the default instance pool does not affect the pool that the bean uses.
					</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="bean_thread_pools"/>Bean Thread Pools</h1></div></div></div><p>
				By default, a bean thread pool named <code class="literal">default</code> is used for asynchronous EJB calls and EJB timers.
			</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					From JBoss EAP 7 onward, remote EJB requests are handled in the worker defined in the <code class="literal">io</code> subsystem by default.
				</p></div><p>
				If required, you can configure each of these EJB services to use a different bean thread pool. This can be useful if you want finer control of each service’s access to a bean thread pool.
			</p><p>
				When determining an appropriate thread pool size, consider how many concurrent requests you expect will be processed at once.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="creating_a_bean_thread_pool"/>Creating a Bean Thread Pool</h2></div></div></div><p>
					This section shows you how to create a new bean thread pool using the management CLI. You can also configure bean thread pools using the management console by navigating to the <span class="strong"><strong>EJB</strong></span> subsystem from the <span class="strong"><strong>Configuration</strong></span> tab and selecting <span class="strong"><strong>Container</strong></span> → <span class="strong"><strong>Thread Pool</strong></span> in the left menu.
				</p><p>
					To create a new thread pool, use the following command:
				</p><pre class="screen">/subsystem=ejb3/thread-pool=<span class="emphasis"><em>POOL_NAME</em></span>:add(max-threads=<span class="emphasis"><em>MAX_THREADS</em></span>)</pre><p>
					The following example creates a bean thread pool named <code class="literal">my_thread_pool</code> with a maximum of 30 threads:
				</p><pre class="screen">/subsystem=ejb3/thread-pool=my_thread_pool:add(max-threads=30)</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring_ejb_services_to_use_a_specific_bean_thread_pool"/>Configuring EJB Services to Use a Specific Bean Thread Pool</h2></div></div></div><p>
					The EJB3 asynchronous invocation service and timer service can each be configured to use a specific bean thread pool. By default, both these services use the <code class="literal">default</code> bean thread pool.
				</p><p>
					This section shows you how to configure the above EJB services to use a specific bean thread pool using the management CLI. You can also configure these services using the management console by navigating to the <span class="strong"><strong>EJB</strong></span> subsystem from the <span class="strong"><strong>Configuration</strong></span> tab, selecting the <span class="strong"><strong>Services</strong></span> tab, and choosing the appropriate service.
				</p><p>
					To configure an EJB service to use a specific bean thread pool, use the following command:
				</p><pre class="screen">/subsystem=ejb3/service=<span class="emphasis"><em>SERVICE_NAME</em></span>:write-attribute(name=thread-pool-name,value=<span class="emphasis"><em>THREAD_POOL_NAME</em></span>)</pre><p>
					Replace <code class="literal">SERVICE_NAME</code> with the EJB service you want to configure:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<code class="literal">async</code> for the EJB3 asynchronous invocation service
						</li><li class="listitem">
							<code class="literal">timer-service</code> for the EJB3 timer service
						</li></ul></div><p>
					The following example sets the EJB3 async service to use the bean thread pool named <code class="literal">my_thread_pool</code>:
				</p><pre class="screen">/subsystem=ejb3/service=async:write-attribute(name=thread-pool-name,value=my_thread_pool)</pre></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="exceptions_that_indicate_ejb_subsystem_tuning_might_be_required"/>Exceptions That Indicate EJB Subsystem Tuning Might Be Required</h1></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
						<span class="strong"><strong>The Stateless EJB instance pool is not large enough or the timeout is too low</strong></span>
					</p><pre class="screen">javax.ejb.EJBException: JBAS014516: Failed to acquire a permit within 20 SECONDS
     at org.jboss.as.ejb3.pool.strictmax.StrictMaxPool.get(StrictMaxPool.java:109)</pre><p class="simpara">
						See <a class="link" href="ejb_subsystem_tuning.html#bean_instance_pools" title="Bean Instance Pools">Bean Instance Pools</a>.
					</p></li><li class="listitem"><p class="simpara">
						<span class="strong"><strong>The EJB thread pool is not large enough, or an EJB is taking longer to process than the invocation timeout</strong></span>
					</p><pre class="screen">java.util.concurrent.TimeoutException: No invocation response received in 300000 milliseconds</pre><p class="simpara">
						See <a class="link" href="ejb_subsystem_tuning.html#bean_thread_pools" title="Bean Thread Pools">Bean Thread Pools</a>.
					</p></li></ul></div></div></div></body></html>