<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 3. Diagnosing Performance Issues</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="diagnosing_performance_issues"/>Chapter 3. Diagnosing Performance Issues</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="enabling_garbage_collection"/>Enabling Garbage Collection Logging</h1></div></div></div><p>
				Examining garbage collection logs can be useful when attempting to troubleshoot Java performance issues, especially those related to memory usage.
			</p><p>
				Other than some additional disk I/O activity for writing the log files, enabling garbage collection logging does not significantly affect server performance.
			</p><p>
				Garbage collection logging is already enabled by default for a standalone JBoss EAP server running on OpenJDK or Oracle JDK. For a JBoss EAP managed domain, garbage collection logging can be enabled for the host controller, process controller, or individual JBoss EAP servers.
			</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
						Get the correct JVM options for enabling garbage collection logging for your JDK. Replace the path in the options below to where you want the log to be created.
					</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							The Red Hat Customer Portal has a <a class="link" href="https://access.redhat.com/labs/jvmconfig/">JVM Options Configuration Tool</a> that can help you generate optimal JVM settings.
						</p></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
								For OpenJDK or Oracle JDK:
							</p><pre class="screen">-verbose:gc -Xloggc:<span class="emphasis"><em>/path/to/gc.log</em></span> -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCApplicationStoppedTime</pre></li><li class="listitem"><p class="simpara">
								For IBM JDK:
							</p><pre class="screen">-verbose:gc -Xverbosegclog:<span class="emphasis"><em>/path/to/gc.log</em></span></pre></li></ul></div></li><li class="listitem"><p class="simpara">
						Apply the garbage collection JVM options to your JBoss EAP server.
					</p><p class="simpara">
						See the JBoss EAP <span class="emphasis"><em>Configuration Guide</em></span> for instructions on how to apply JVM options <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#jvm_settings_standalone_server">to a standalone server</a> or <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#jvm_settings_managed_domain">servers in a managed domain</a>.
					</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="heap_dumps"/>Java Heap Dumps</h1></div></div></div><p>
				A Java heap dump is a snapshot of a JVM heap created at a certain point in time. Creating and analyzing heap dumps can be useful for diagnosing and troubleshooting issues with Java applications.
			</p><p>
				Depending on which JDK you are using, there are different ways of creating and analyzing a Java heap dump for a JBoss EAP process. This section covers common methods for Oracle JDK, OpenJDK, and IBM JDK.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="creating_a_heap_dump"/>Creating a Heap Dump</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="openjdk_and_oracle_jdk"/>OpenJDK and Oracle JDK</h3></div></div></div><div class="title"><strong>Create an On-Demand Heap Dump</strong></div><p>
							You can use the <code class="literal">jcmd</code> command to create an on-demand heap dump for JBoss EAP running on OpenJDK or Oracle JDK.
						</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								Determine the process ID of the JVM that you want to create a heap dump from.
							</li><li class="listitem"><p class="simpara">
								Create the heap dump with the following command:
							</p><pre class="screen">$ jcmd <span class="emphasis"><em>JAVA_PID</em></span> GC.heap_dump -all=true <span class="emphasis"><em>FILENAME</em></span>.hprof</pre><p class="simpara">
								This creates a heap dump file in the HPROF format, usually located in <code class="literal"><span class="emphasis"><em>EAP_HOME</em></span></code> or <code class="literal"><span class="emphasis"><em>EAP_HOME</em></span>/bin</code>. Alternatively, you can specify a file path to another directory.
							</p></li></ol></div><div class="title"><strong>Create a Heap Dump Automatically on OutOfMemoryError</strong></div><p>
							You can use the <code class="literal">-XX:+HeapDumpOnOutOfMemoryError</code> JVM option to automatically create a heap dump when an <code class="literal">OutOfMemoryError</code> exception is thrown.
						</p><p>
						This creates a heap dump file in the HPROF format, usually located in <code class="literal"><span class="emphasis"><em>EAP_HOME</em></span></code> or <code class="literal"><span class="emphasis"><em>EAP_HOME</em></span>/bin</code>. Alternatively, you can set a custom path for the heap dump using <code class="literal">-XX:HeapDumpPath=<span class="emphasis"><em>/path/</em></span></code>. If you specify a file name using <code class="literal">-XX:HeapDumpPath</code>, for example, <code class="literal">-XX:HeapDumpPath=<span class="emphasis"><em>/path/filename.hprof</em></span></code>, the heap dumps will overwrite each other.
					</p><p>
						See the JBoss EAP <span class="emphasis"><em>Configuration Guide</em></span> for instructions on how to apply JVM options <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#jvm_settings_standalone_server">to a standalone server</a> or <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#jvm_settings_managed_domain">servers in a managed domain</a>.
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ibm_jdk"/>IBM JDK</h3></div></div></div><p>
						When using the IBM JDK, heap dumps are automatically generated when an <code class="literal">OutOfMemoryError</code> is thrown.
					</p><p>
						Heap dumps from the IBM JDK are saved in the <code class="literal">/tmp/</code> directory as a portable heap dump (PHD) formatted file.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="analyzing_a_heap_dump"/>Analyzing a Heap Dump</h2></div></div></div><div class="title"><strong>Heap Dump Analysis Tools</strong></div><p>
						There are many tools that can analyze heap dump files and help identify issues. Red Hat Support recommends using the <a class="link" href="https://www.eclipse.org/mat/">Eclipse Memory Analyzer tool (MAT)</a>, which can analyze heap dumps formatted in either HPROF or PHD formats.
					</p><p>
					For information on using Eclipse MAT, see the <a class="link" href="https://www.eclipse.org/mat/documentation/">Eclipse MAT documentation</a>.
				</p><div class="title"><strong>Heap Dump Analysis Tips</strong></div><p>
						Sometimes the cause of the heap performance issues are obvious, but other times you may need an understanding of your application’s code and the specific circumstances that cause issues like an <code class="literal">OutOfMemoryError</code>. This can help to identify whether an issue is a memory leak, or if the heap is just not large enough.
					</p><p>
					Some suggestions for identifying memory usage issues include:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							If a single object is not found to be consuming too much memory, try grouping by class to see if many small objects are consuming a lot of memory.
						</li><li class="listitem">
							Check if the biggest usage of memory is a thread. A good indicator of this is if the <code class="literal">OutOfMemoryError</code>-triggered heap dump is much smaller than the specified <code class="literal">Xmx</code> maximum heap size.
						</li><li class="listitem">
							A technique to make memory leaks more detectable is to temporarily double the normal maximum heap size. When an <code class="literal">OutOfMemoryError</code> occurs, the size of the objects related to the memory leak will be about half the size of the heap.
						</li></ul></div><p>
					When the source of a memory issue is identified, you can view the paths from garbage collection roots to see what is keeping the objects alive.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="identifying_high_cpu"/>Identifying High CPU Utilization by Java Threads</h1></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					For customers using JBoss EAP on Red Hat Enterprise Linux or Solaris, the <a class="link" href="https://access.redhat.com/labs/jvmpeg/">JVMPeg lab tool</a> on the Red Hat Customer Portal helps collect and analyze Java thread information to identify high CPU utilization. Follow the <a class="link" href="https://access.redhat.com/labsinfo/jvmpeg">instructions for using the JVMPeg lab tool</a> instead of using the following procedure.
				</p></div><p>
				For OpenJDK and Oracle JDK environments, Java thread diagnostic information is available using the <code class="literal">jstack</code> utility.
			</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
						Identify the process ID of the Java process that is utilizing a high percentage of the CPU.
					</p><p class="simpara">
						It can also be useful to obtain per-thread CPU data on high-usage processes. This can be done using the <code class="literal">top -H</code> command on Red Hat Enterprise Linux systems.
					</p></li><li class="listitem"><p class="simpara">
						Using the <code class="literal">jstack</code> utility, create a stack dump of the Java process. For example, on Linux and Solaris:
					</p><pre class="screen">jstack -l <span class="emphasis"><em>JAVA_PROCESS_ID</em></span> &gt; high-cpu-tdump.out</pre><p class="simpara">
						You might need to create multiple dumps at intervals to see any changes or trends over a period of time.
					</p></li><li class="listitem">
						Analyze the stack dumps. You can use a tool such as the <a class="link" href="https://github.com/irockel/tda">Thread Dump Analyzer (TDA)</a>.
					</li></ol></div></div></div></body></html>