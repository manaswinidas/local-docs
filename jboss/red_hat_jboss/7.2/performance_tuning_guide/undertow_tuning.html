<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. Undertow Subsystem Tuning</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="undertow_tuning"/>Chapter 9. Undertow Subsystem Tuning</h1></div></div></div><p>
			The non-blocking I/O <code class="literal">undertow</code> subsystem introduced in JBoss EAP 7 has greatly improved performance compared to the previous <code class="literal">web</code> subsystem in JBoss EAP 6. Opportunities for tuning the <code class="literal">undertow</code> subsystem for your environment include configuring <a class="link" href="undertow_tuning.html#undertow_buffer_caches" title="Buffer Caches">buffer caches</a>, <a class="link" href="undertow_tuning.html#undertow_jsp_settings" title="JSP Configuration">JSP settings</a>, and <a class="link" href="undertow_tuning.html#undertow_listeners" title="Listeners">listeners</a>.
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="undertow_buffer_caches"/>Buffer Caches</h1></div></div></div><p>
				A buffer cache is used to cache static files handled by the <code class="literal">undertow</code> subsystem. This includes images, static HTML, CSS, and JavaScript files. You can specify a default buffer cache for each Undertow servlet container. Having an optimized buffer cache for your servlet container can improve Undertow performance for serving static files.
			</p><p>
				Buffers in a buffer cache are allocated in regions, and are of a fixed size. There are three configurable attributes for each buffer cache:
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">buffer-size</code></span></dt><dd>
							The size of an individual buffer, in bytes. The default is 1024 bytes. Red Hat recommends that you set the buffer size to entirely store your largest static file.
						</dd><dt><span class="term"><code class="literal">buffers-per-region</code></span></dt><dd>
							The number of buffers per region. The default is 1024.
						</dd><dt><span class="term"><code class="literal">max-regions</code></span></dt><dd>
							The maximum number of regions, which sets a maximum amount of memory allocated to the buffer cache. The default is 10 regions.
						</dd></dl></div><p>
				You can calculate the maximum amount memory used by a buffer cache by multiplying the buffer size, the number of buffers per region, and the maximum number of regions. For example, the default buffer cache is 1024 bytes * 1024 buffers per region * 10 regions = 10MB.
			</p><p>
				Configure your buffer caches based on the size of your static files, and the results from testing expected loads in a development environment. When determining the effect on performance, consider the balance of the buffer cache performance benefit versus the memory used.
			</p><p>
				For instructions on using the management CLI to configure buffer caches, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#undertow-configure-buffer-caches">Configuring Buffer Caches</a> in the JBoss EAP <span class="emphasis"><em>Configuration Guide</em></span>.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="undertow_byte_buffer_pools"/>Configuring Byte Buffer Pools</h1></div></div></div><p>
				Undertow byte buffer pools are used to allocate pooled NIO <code class="literal">ByteBuffer</code> instances. All listeners have a byte buffer pool and you can use different buffer pools and workers for each listener. Byte buffer pools can be shared between different server instances.
			</p><p>
				For a full list of the attributes available for configuring byte buffer pools, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#byte_buffer_pool_attributes">Byte Buffer Pool Attributes</a> in the JBoss EAP <span class="emphasis"><em>Configuration Guide</em></span>.
			</p><p>
				The main byte buffer pool attribute that significantly affects performance is <code class="literal">buffer-size</code>. The default is calculated based on the RAM resources of your system, and is sufficient in most cases. If you are configuring this attribute manually, an ideal size for most servers is 16KB.
			</p><p>
				See the JBoss EAP <span class="emphasis"><em>Configuration Guide</em></span> for instructions on how to <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#configure_undertow_buffer_pools">create and configure byte buffer pools</a>.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="undertow_jsp_settings"/>JSP Configuration</h1></div></div></div><p>
				There are JSP configuration options for Undertow servlet containers that provide optimizations for how JSP pages are compiled into Java bytecode.
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">generate-strings-as-char-arrays</code></span></dt><dd>
							If your JSPs contain a lot of <code class="literal">String</code> constants, enabling this option optimizes scriplets by converting the <code class="literal">String</code> constants to <code class="literal">char</code> arrays.
						</dd><dt><span class="term"><code class="literal">optimize-scriptlets</code></span></dt><dd>
							If your JSPs contain many <code class="literal">String</code> concatenations, enabling this option optimizes scriplets by removing <code class="literal">String</code> concatenation for every JSP request.
						</dd><dt><span class="term"><code class="literal">trim-spaces</code></span></dt><dd>
							If your JSPs contain a lot of white space, enabling this option trims the white space from HTTP requests and reduces HTTP request payload.
						</dd></dl></div><div class="title"><strong>Configuring JSP Options</strong></div><p>
					You can enable these Undertow JSP configuration options using the management console or management CLI.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
						To enable them using the management console:
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								Navigate to <span class="strong"><strong>Configuration</strong></span> → <span class="strong"><strong>Subsystems</strong></span> → <span class="strong"><strong>Web (Undertow)</strong></span> → <span class="strong"><strong>Servlet Container</strong></span>.
							</li><li class="listitem">
								Select the servlet container you want to configure and click <span class="strong"><strong>View</strong></span>.
							</li><li class="listitem">
								Select <span class="strong"><strong>JSP</strong></span> and click <span class="strong"><strong>Edit</strong></span>.
							</li><li class="listitem">
								For each option you want to enable, set the field to <span class="strong"><strong>ON</strong></span> and then click <span class="strong"><strong>Save</strong></span>.
							</li></ol></div></li><li class="listitem"><p class="simpara">
						To enable them using the management CLI, use the following command:
					</p><pre class="screen">/subsystem=undertow/servlet-container=<span class="emphasis"><em>SERVLET_CONTAINER</em></span>/setting=jsp/:write-attribute(name=<span class="emphasis"><em>OPTION_NAME</em></span>,value=true)</pre><p class="simpara">
						For example, to enable <code class="literal">generate-strings-as-char-arrays</code> for the <code class="literal">default</code> servlet container, use the following command:
					</p><pre class="screen">/subsystem=undertow/servlet-container=default/setting=jsp/:write-attribute(name=generate-strings-as-char-arrays,value=true)</pre></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="undertow_listeners"/>Listeners</h1></div></div></div><p>
				Depending on your applications and environment, you can configure multiple listeners specific to certain types of traffic, for example, traffic on specific ports, and then configure options for each listener.
			</p><p>
				The following are selected performance-related options that can be configured on HTTP, HTTPS, and AJP listeners.
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">max-connections</code></span></dt><dd><p class="simpara">
							The maximum number of concurrent connections that the listener can handle. By default this attribute is undefined, which results in unlimited connections.
						</p><p class="simpara">
							You can use this option to set a ceiling on the number of connections a listener can handle, which might be useful to cap resource usage. In configuring this value you should consider your workload and traffic type. Also see <code class="literal">no-request-timeout</code> below.
						</p></dd><dt><span class="term"><code class="literal">no-request-timeout</code></span></dt><dd><p class="simpara">
							The length of time in milliseconds that a connection is idle before it is closed. The default value is 60000 milliseconds (1 minute).
						</p><p class="simpara">
							Tuning this option in your environment for optimal connection efficiency can help improve network performance. If idle connections are prematurely closed, there are overheads in re-establishing connections. If idle connections are open for too long, they unnecessarily use resources.
						</p></dd><dt><span class="term"><code class="literal">max-header-size</code></span></dt><dd><p class="simpara">
							The maximum size of a HTTP request header, in bytes. The default is 1048576 (1024KB).
						</p><p class="simpara">
							Limiting the header size can be useful to prevent certain types of denial of service attacks.
						</p></dd><dt><span class="term"><code class="literal">buffer-pool</code></span></dt><dd><p class="simpara">
							Specifies the buffer pool in the <code class="literal">io</code> subsystem to use for the listener. By default, all listeners use the <code class="literal">default</code> buffer pool.
						</p><p class="simpara">
							You can use this option to configure each listener to use a unique buffer pool, or have multiple listeners use the same buffer pool.
						</p></dd><dt><span class="term"><code class="literal">worker</code></span></dt><dd><p class="simpara">
							The <code class="literal">undertow</code> subsystem relies on the <code class="literal">io</code> subsystem to provide XNIO workers. This option specifies the XNIO worker that the listener uses. By default, a listener uses the <code class="literal">default</code> worker in the <code class="literal">io</code> subsystem.
						</p><p class="simpara">
							It might be useful to configure each listener to use a specific worker so you can assign different worker resources to certain types of network traffic.
						</p></dd></dl></div><div class="title"><strong>Configuring Listener Options</strong></div><p>
					You can configure listener options using the management console or management CLI.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
						To configure them using the management console:
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								Navigate to <span class="strong"><strong>Configuration</strong></span> → <span class="strong"><strong>Subsystems</strong></span> → <span class="strong"><strong>Web (Undertow)</strong></span> → <span class="strong"><strong>Server</strong></span>.
							</li><li class="listitem">
								Select the server you want to configure and click <span class="strong"><strong>View</strong></span>.
							</li><li class="listitem">
								In the left menu, select <span class="strong"><strong>Listener</strong></span> then select the type of listener to configure, for example <span class="strong"><strong>HTTP Listener</strong></span>, and select the listener in the table.
							</li><li class="listitem">
								CLick <span class="strong"><strong>Edit</strong></span>, modify the options you want to configure, and click <span class="strong"><strong>Save</strong></span>.
							</li></ol></div></li><li class="listitem"><p class="simpara">
						To configure them using the management CLI, use the following command:
					</p><pre class="screen">/subsystem=undertow/server=<span class="emphasis"><em>SERVER_NAME</em></span>/<span class="emphasis"><em>LISTENER_TYPE</em></span>=<span class="emphasis"><em>LISTENER_NAME</em></span>:write-attribute(name=<span class="emphasis"><em>OPTION_NAME</em></span>,value=<span class="emphasis"><em>OPTION_VALUE</em></span>)</pre><p class="simpara">
						For example, to set <code class="literal">max-connections</code> to <code class="literal">100000</code> for the <code class="literal">default</code> HTTP listener in the <code class="literal">default-server</code> Undertow server, use the following command:
					</p><pre class="screen">/subsystem=undertow/server=default-server/http-listener=default:write-attribute(name=max-connections,value=100000)</pre></li></ul></div></div></div></body></html>