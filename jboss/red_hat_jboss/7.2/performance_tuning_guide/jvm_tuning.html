<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 4. JVM Tuning</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="jvm_tuning"/>Chapter 4. JVM Tuning</h1></div></div></div><p>
			Configuring optimal JVM options for your applications and JBoss EAP environment is one of the most fundamental ways to tune performance. This chapter covers configuring some general JVM options.
		</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
				Many of the JVM options listed in this chapter can be easily generated using the <a class="link" href="https://access.redhat.com/labs/jvmconfig/">JVM Options Configuration Tool</a> on the Red Hat Customer Portal.
			</p></div><p>
			See the JBoss EAP <span class="emphasis"><em>Configuration Guide</em></span> for instructions on how to apply JVM options <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#jvm_settings_standalone_server">to a standalone server</a> or <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#jvm_settings_managed_domain">servers in a managed domain</a>.
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="setting_a_fixed_heap_size"/>Setting a Fixed Heap Size</h1></div></div></div><p>
				You must set an appropriate heap size to prevent out of memory errors.
			</p><p>
				The <code class="literal">-Xms</code> option sets the initial heap size, and <code class="literal">-Xmx</code> sets the maximum heap size. It is recommended for production environments that you set the initial and maximum heap size options to the same size, so that the heap size is fixed and pre-allocated.
			</p><p>
				For example, the following options set a 2048 MB heap size:
			</p><pre class="screen">-Xms2048M -Xmx2048M</pre><p>
				It is recommended that you test your applications under load in a development environment to determine the maximum memory usage. Your production heap size should be at least 25% higher than the tested maximum to allow room for overhead.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_the_garbage_collector"/>Configuring the Garbage Collector</h1></div></div></div><p>
				Although the parallel garbage collector, also known as the throughput garbage collector, is the <a class="link" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/ergonomics.html#ergonomics">default garbage collector in Java 8 for server-class machines</a>, Red Hat recommends using the G1 garbage collector, which is expected to be the default from Java 9 onward. The G1 garbage collector generally performs better than the CMS and parallel garbage collectors in most scenarios.
			</p><p>
				To enable the G1 collector, use the following JVM option:
			</p><pre class="screen">-XX:+UseG1GC</pre><h3><a id="garbage_collection_logging_options"/>Garbage Collection Logging Options</h3><p>
				Garbage collection logging is enabled by default for standalone JBoss EAP servers. To enable garbage collection logging for a JBoss EAP managed domain, see <a class="xref" href="diagnosing_performance_issues.html#enabling_garbage_collection" title="Enabling Garbage Collection Logging">the section called “Enabling Garbage Collection Logging”</a>.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="enabling_large_pages"/>Enabling Large Pages</h1></div></div></div><p>
				Enabling large pages for JBoss EAP JVMs results in pages that are locked in memory and cannot be swapped to disk like regular memory.
			</p><p>
				Especially for memory-intensive applications, the advantage of using large pages is that the heap cannot be paged or swapped to disk, and is thus always readily available.
			</p><p>
				One disadvantage of using large pages is that other processes running on the system might not have quick access to memory, which might result in excessive paging for these processes.
			</p><p>
				As with any other performance configuration change, it is recommended that you test the impact of the change in a testing environment.
			</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
						You must ensure that your operating system configuration allows for processes to use large pages.
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
								For Red Hat Enterprise Linux systems, you must explicitly configure <code class="literal">HugeTLB</code> pages to guarantee that JBoss EAP processes will have access to large pages.
							</p><p class="simpara">
								For information on configuring Red Hat Enterprise Linux memory options, see the <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html-single/Performance_Tuning_Guide/index.html#sect-Red_Hat_Enterprise_Linux-Performance_Tuning_Guide-Considerations-Page_size">Memory chapter</a> in the Red Hat Enterprise Linux <span class="emphasis"><em>Performance Tuning Guide</em></span>.
							</p></li><li class="listitem"><p class="simpara">
								For Windows Server systems, the user that is running JBoss EAP must have the large pages privilege assigned:
							</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
										Select <span class="strong"><strong>Control Panel</strong></span> → <span class="strong"><strong>Administrative Tools</strong></span> → <span class="strong"><strong>Local Security Policy</strong></span>.
									</li><li class="listitem">
										Select <span class="strong"><strong>Local Policies</strong></span> → <span class="strong"><strong>User Rights Assignment</strong></span>.
									</li><li class="listitem">
										Double-click <span class="strong"><strong>Lock pages in memory</strong></span>.
									</li><li class="listitem">
										Add the Windows Server users and user groups that you want to use large pages.
									</li><li class="listitem">
										Restart the machine.
									</li></ol></div></li></ul></div></li><li class="listitem"><p class="simpara">
						Enable or disable large page support:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
								To explicitly enable large page support for JBoss EAP JVMs, use the following JVM option:
							</p><pre class="screen">-XX:+UseLargePages</pre></li><li class="listitem"><p class="simpara">
								To explicitly disable large page support for JBoss EAP JVMs, use the following JVM option:
							</p><pre class="screen">-XX:-UseLargePages</pre></li></ul></div></li><li class="listitem"><p class="simpara">
						When starting JBoss EAP, ensure that there are no warnings related to reserving memory.
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
								On Red Hat Enterprise Linux, an error might look like:
							</p><pre class="screen">OpenJDK 64-Bit Server VM warning: Failed to reserve shared memory. (error = 1)</pre></li><li class="listitem"><p class="simpara">
								On Windows Server, an error might look like:
							</p><pre class="screen">Java HotSpot(TM) 64-Bit Server VM warning: JVM cannot use large page memory because it does not have enough privilege to lock pages in memory.</pre></li></ul></div><p class="simpara">
						If you do see warnings, verify that your operating system configuration and JVM options are configured correctly.
					</p></li></ol></div><p>
				For more information, see the <a class="link" href="http://www.oracle.com/technetwork/java/javase/tech/largememory-jsp-137182.html">Oracle documentation on Java support for large pages</a>.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="enabling_aggressive_optimizations"/>Enabling Aggressive Optimizations</h1></div></div></div><p>
				Using the aggressive optimizations (AggressiveOpts) JVM option can provide performance improvements for your environment. This option enables Java performance optimization features that are expected to become default in future Java releases.
			</p><p>
				To enable AggressiveOpts, use the following JVM option:
			</p><pre class="screen">-XX:+AggressiveOpts</pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="setting_ulimits"/>Setting ulimits</h1></div></div></div><p>
				For Red Hat Enterprise Linux and Solaris platforms, you must configure appropriate <code class="literal">ulimit</code> values for JBoss EAP JVM processes. The "soft" <code class="literal">ulimit</code> can be temporarily exceeded, while the "hard" <code class="literal">ulimit</code> is the strict ceiling for the usage of a resource. Appropriate <code class="literal">ulimit</code> values vary depending on your environment and applications.
			</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
					If you are using IBM JDK, it is important to note that IBM JDK uses the soft limit for the maximum number of open files used by a JVM process. On Red Hat Enterprise Linux, the default soft limit (<code class="literal">1024</code>) is considered too low for JBoss EAP processes using IBM JDK.
				</p></div><p>
				If the limits applied to JBoss EAP processes are too low, you will see a warning like the following when starting JBoss EAP:
			</p><pre class="screen">WARN  [org.jboss.as.warn.fd-limit] (main) WFLYSRV0071: The operating system has limited the number of open files to 1024 for this process; a value of at least 4096 is recommended.</pre><p>
				To see your current <code class="literal">ulimit</code> values, use the following commands:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
						For soft <code class="literal">ulimit</code> values:
					</p><pre class="screen">ulimit -Sa</pre></li><li class="listitem"><p class="simpara">
						For hard <code class="literal">ulimit</code> values:
					</p><pre class="screen">ulimit -Ha</pre></li></ul></div><p>
				To set the <code class="literal">ulimit</code> for the maximum number of open files, use the following commands with the number you want to apply:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
						To set the soft <code class="literal">ulimit</code> for the maximum number of open files:
					</p><pre class="screen">ulimit -Sn <span class="emphasis"><em>4096</em></span></pre></li><li class="listitem"><p class="simpara">
						To set the hard <code class="literal">ulimit</code> for the maximum number of open files:
					</p><pre class="screen">ulimit -Hn <span class="emphasis"><em>4096</em></span></pre></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					To guarantee that a <code class="literal">ulimit</code> setting is effective, it is recommended on production systems to set the soft and hard limits to the same value.
				</p></div><p>
				For more information on setting <code class="literal">ulimit</code> values using a configuration file, see <a class="link" href="https://access.redhat.com/solutions/61334">How to set ulimit values</a> on the Customer Portal.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="host_controller_and_process_controller_jvm_tuning"/>Host Controller and Process Controller JVM Tuning</h1></div></div></div><p>
				JBoss EAP managed domain hosts have separate JVMs for the host controller and process controller. See the JBoss EAP <span class="emphasis"><em>Configuration Guide</em></span> for more information on the roles of <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#about_host_controllers">host controllers</a> and <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#process_controllers">process controllers</a>.
			</p><p>
				You can tune the host controller and process controller JVM settings, but even for large managed domain environments, the default JVM configuration for the host controller and process controller should suffice.
			</p><p>
				The default configurations for host controller and process controller JVMs have been tested with a managed domain size of up to 20 JBoss EAP hosts each running 10 JBoss EAP servers, for a total domain size of 200 JBoss EAP servers.
			</p><p>
				If you experience issues with larger managed domains, you might need to <a class="link" href="monitoring_performance.html" title="Chapter 2. Monitoring Performance">monitor the host controller or process controller JVMs</a> in your environment to determine appropriate values for JVM options such as heap size.
			</p></div></div></body></html>