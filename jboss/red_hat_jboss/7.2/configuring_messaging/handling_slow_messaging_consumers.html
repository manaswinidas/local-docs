<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 26. Handling Slow Consumers</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="handling_slow_messaging_consumers"/>Chapter 26. Handling Slow Consumers</h1></div></div></div><p>
				A slow consumer with a server-side queue can pose a significant problem for server performance. As messages build up in the consumer’s server-side queue, memory usage increases. Consequently, the server can enter paging mode, which can negatively impact performance. Another significant problem is that messages sent to a client’s message buffer can remain waiting to be consumed if the <code class="literal">consumer-windows-size</code> attribute is greater than <code class="literal">0</code>. Criteria can be set so that consumers that do not consume messages quickly enough can be disconnected from the server.
			</p><p>
				In the case where the slow consumer is an MDB, the JBoss EAP server manages the connection. Once the MDB is disconnected, the messages are returned to the queue from which the MDB was consuming, the MDB automatically reconnects, and at this moment, messages are load balanced again to all of the MDBs on the queue. This same process holds for an MDB listening on a durable topic. In the case of a JMS consumer, if it is slow, then it is disconnected, and it reconnects only if the <code class="literal">reconnects-attempts</code> is set to <code class="literal">-1</code> or is greater than <code class="literal">0</code>.
			</p><p>
				In the case of a non-durable JMS subscriber or an MDB with non-durable subscription, the connection is disconnected, which results in the subscription being removed. If the non-durable subscriber reconnects, then a new non-durable subscription is created, and it starts to consume only new messages sent to the topic.
			</p><p>
				The calculation to determine whether or not a consumer is slow inspects only the number of messages that a particular consumer has acknowledged. It does not take into account whether flow control has been enabled on the consumer, or whether the consumer is streaming a large message, for example. Keep this in mind when configuring slow consumer detection.
			</p><p>
				Slow consumer checks are performed using the scheduled thread pool. Each queue on the server with slow consumer detection enabled will cause a new entry in the internal <code class="literal">java.util.concurrent.ScheduledThreadPoolExecutor</code> instance. If there are a high number of queues and the <code class="literal">slow-consumer-check-period</code> is relatively low, then there may be delays in executing some of the checks. However, this will not impact the accuracy of the calculations used by the detection algorithm. See <a class="link" href="server-side_thread_management.html" title="Chapter 24. Thread Management">Thread Management</a> for more details about this thread pool.
			</p><p>
				Slow consumer handling is on a per <code class="literal">address-setting</code> basis. See <a class="link" href="configure_address_settings.html" title="Chapter 6. Address Settings">Address Settings</a> for more information on configuring an <code class="literal">address-setting</code>, and refer to the appendix for the list of <a class="link" href="reference_material.html#address_setting_attributes" title="Address Setting Attributes"><code class="literal">address-setting</code> attributes</a>. There are three attributes used to configure the handling of slow consumers. They are:
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">slow-consumer-check-period</span></dt><dd>
							How often to check, in seconds, for slow consumers. The default is <code class="literal">5</code>.
						</dd><dt><span class="term">slow-consumer-policy</span></dt><dd><p class="simpara">
							Determines what happens when a slow consumer is identified. The valid options are <code class="literal">KILL</code> or <code class="literal">NOTIFY</code>:
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									<code class="literal">KILL</code> will kill the consumer’s connection, which will impact any client threads using that same connection.
								</li><li class="listitem">
									<code class="literal">NOTIFY</code> will send a <code class="literal">CONSUMER_SLOW</code> management notification to the client.
								</li></ul></div><p class="simpara">
							The default is <code class="literal">NOTIFY</code>.
						</p></dd><dt><span class="term">slow-consumer-threshold</span></dt><dd>
							The minimum rate of message consumption allowed before a consumer is considered slow. The default is <code class="literal">-1</code>, which is unbounded.
						</dd></dl></div><p>
				Use the management CLI to read the current values for any of the attributes. For example, use the following command to read the current <code class="literal">slow-consumer-policy</code> for the <code class="literal">address-setting</code> with the name <code class="literal">myAddress</code>.
			</p><pre class="screen">/subsystem=messaging-activemq/server=default/address-setting=myAddress:read-attribute(name=slow-consumer-policy)</pre><p>
				Likewise, use the following example to set the same <code class="literal">slow-consumer-policy</code>.
			</p><pre class="screen">/subsystem=messaging-activemq/server=default/address-setting=myAddress:write-attribute(name=slow-consumer-policy,value=&lt;NEW_VALUE&gt;)</pre></div></body></html>