<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 10. Configuring Persistence</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_persistence"/>Chapter 10. Configuring Persistence</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="about_persistence_in_messaging"/>About Persistence in JBoss EAP 7 Messaging</h1></div></div></div><p>
					JBoss EAP ships with two persistence options for storing binding data and messages:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							You can use the default <a class="link" href="configuring_persistence.html#messaging_journal_persistence_using_the_default_file_journal" title="Messaging Journal Persistence Using the Default File Journal">file-based journal</a>, which is highly optimized for messaging use cases and provides great performance. This option is provided by default and is used if you do not do any additional configuration.
						</li><li class="listitem">
							You can store the data in a <a class="link" href="configuring_persistence.html#messaging_journal_persistence_using_a_jdbc_database" title="Messaging Journal Persistence Using a JDBC Database">JDBC data store</a>, which uses JDBC to connect to a database of your choice. This option requires configuration of the <code class="literal">datasources</code> and <code class="literal">messaging-activemq</code> subsystems in the server configuration file.
						</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="messaging_journal_persistence_using_the_default_file_journal"/>Messaging Journal Persistence Using the Default File Journal</h1></div></div></div><p>
					JBoss EAP messaging ships with a high-performance, file-based journal that is optimized for messaging.
				</p><p>
					The JBoss EAP messaging journal has a configurable file size and is append only, which improves performance by enabling single write operations. It consists of a set of files on disk, which are initially pre-created to a fixed size and filled with padding. As server operations, such as add message, delete message, update message, are performed, records of the operations are appended to the journal until the journal file is full, at which point the next journal file is used.
				</p><p>
					A sophisticated garbage collection algorithm determines whether journal files can be reclaimed and re-used when all of their data has been deleted. A compaction algorithm removes dead space from journal files and compresses the data.
				</p><p>
					The journal also fully supports both local and XA transactions.
				</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="messaging_journal_file_system_implementations"/>Messaging Journal File System Implementations</h2></div></div></div><p>
						The majority of the journal is written in Java, but interaction with the file system has been abstracted to allow different pluggable implementations. The two implementations shipped with JBoss EAP messaging are:
					</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Java New I/O (NIO)</span></dt><dd>
									This implementation uses standard Java NIO to interface with the file system. It provides extremely good performance and runs on any platform with a Java 6 or later runtime. Note that JBoss EAP 7 requires Java 8. Using NIO is supported on any operating system that JBoss EAP supports.
								</dd><dt><span class="term">Linux Asynchronous IO (ASYNCIO)</span></dt><dd><p class="simpara">
									This implementation uses a native code wrapper to talk to the Linux asynchronous IO library (ASYNCIO). This implementation removes the need for explicit synchronization. ASYNCIO typically provides better performance than Java NIO.
								</p><p class="simpara">
									The following file systems have been tested and are supported only on Red Hat Enterprise Linux 6 and Red Hat Enterprise Linux 7 when using the <code class="literal">libaio</code> natives. They are not tested and are not supported on other operating systems.
								</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
											EXT4
										</li><li class="listitem">
											XFS
										</li><li class="listitem">
											NFSv4
										</li><li class="listitem">
											GFS2
										</li></ul></div><p class="simpara">
									The following table lists the HA shared store file systems that have been tested, both with and without the <code class="literal">libaio</code> natives, and whether they are supported.
								</p><div class="informaltable"><table border="1"><colgroup><col class="col_1"/><col class="col_2"/><col class="col_3"/><col class="col_4"/></colgroup><thead><tr><th style="text-align: left" valign="top">Operating System</th><th style="text-align: left" valign="top">File System</th><th style="text-align: left" valign="top">Supported Using <code class="literal">libaio</code> Natives? <br/> (journal-type="ASYNCIO")</th><th style="text-align: left" valign="top">Supported Without Using <code class="literal">libaio</code> Natives? <br/> (journal-type="NIO")</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
													Red Hat Enterprise Linux 6
												</p>
												 </td><td style="text-align: left" valign="top"> <p>
													NFSv4
												</p>
												 </td><td style="text-align: left" valign="top"> <p>
													Yes
												</p>
												 </td><td style="text-align: left" valign="top"> <p>
													Yes
												</p>
												 </td></tr><tr><td style="text-align: left" valign="top"> <p>
													Red Hat Enterprise Linux 7
												</p>
												 </td><td style="text-align: left" valign="top"> <p>
													NFSv4
												</p>
												 </td><td style="text-align: left" valign="top"> <p>
													Yes
												</p>
												 </td><td style="text-align: left" valign="top"> <p>
													Yes
												</p>
												 </td></tr><tr><td style="text-align: left" valign="top"> <p>
													Red Hat Enterprise Linux 6
												</p>
												 </td><td style="text-align: left" valign="top"> <p>
													GFS2
												</p>
												 </td><td style="text-align: left" valign="top"> <p>
													Yes
												</p>
												 </td><td style="text-align: left" valign="top"> <p>
													No
												</p>
												 </td></tr><tr><td style="text-align: left" valign="top"> <p>
													Red Hat Enterprise Linux 7
												</p>
												 </td><td style="text-align: left" valign="top"> <p>
													GFS2
												</p>
												 </td><td style="text-align: left" valign="top"> <p>
													Yes
												</p>
												 </td><td style="text-align: left" valign="top"> <p>
													No
												</p>
												 </td></tr></tbody></table></div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="standard_messaging_journal_file_system_instances"/>Standard Messaging Journal File System Instances</h2></div></div></div><p>
						The standard JBoss EAP messaging core server uses the following journal instances:
					</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Bindings Journal</span></dt><dd><p class="simpara">
									This journal is used to store bindings related data, including the set of queues that are deployed on the server and their attributes. It also stores data such as id sequence counters.
								</p><p class="simpara">
									The bindings journal is always a NIO journal as it is typically low throughput compared to the message journal.
								</p><p class="simpara">
									The files on this journal are prefixed as activemq-bindings. Each file has a bindings extension. File size is 1048576, and it is located at the bindings folder.
								</p></dd><dt><span class="term">JMS Journal</span></dt><dd><p class="simpara">
									This journal instance stores all JMS related data, such as any JMS queues,topics, connection factories and any JNDI bindings for these resources.
								</p><p class="simpara">
									Any JMS Resource created via the management API will be persisted to this journal. Any resource configured via configuration files will not. The JMS Journal will only be created if JMS is being used.
								</p><p class="simpara">
									The files on this journal are prefixed as activemq-jms. Each file has a jms extension. File size is 1048576, and it is located at the bindings folder.
								</p></dd><dt><span class="term">Message Journal</span></dt><dd><p class="simpara">
									This journal instance stores all message related data, including the message themselves and also duplicate-id caches.
								</p><p class="simpara">
									By default JBoss EAP messaging will try to use an ASYNCIO journal. If ASYNCIO is not available, for example the platform is not Linux with the correct kernel version or ASYNCIO has not been installed then it will automatically fall back to using Java NIO which is available on any Java platform.
								</p><p class="simpara">
									The files on this journal are prefixed as activemq-data. Each file has an amq extension. File size is by default 10485760 (configurable), and it is located at the journal folder.
								</p></dd></dl></div><p>
						For large messages, JBoss EAP messaging persists them outside the message journal. This is discussed in the section on <a class="link" href="work_with_large_messages.html" title="Chapter 12. Working with Large Messages">Large Messages</a>.
					</p><p>
						JBoss EAP messaging can also be configured to page messages to disk in low memory situations. This is discussed in the <a class="link" href="configuring_paging.html#about_paging" title="About Paging">Paging section</a>.
					</p><p>
						If no persistence is required at all, JBoss EAP messaging can also be configured not to persist any data at all to storage as discussed in the <a class="link" href="configuring_persistence.html#configuring-messaging-for-zero-persistence" title="Configuring JBoss EAP Messaging for Zero Persistence">Configuring JBoss EAP Messaging for Zero Persistence</a> section.
					</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure-bindings-journal"/>Configuring the Bindings and JMS Journals</h2></div></div></div><p>
						Because the bindings journal shares its configuration with the JMS journal, you can read the current configuration for both by using the single management CLI command below. The output is also included to highlight default configuration.
					</p><pre class="screen">/subsystem=messaging-activemq/server=default/path=bindings-directory:read-resource

{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "path" =&gt; "activemq/bindings",
        "relative-to" =&gt; "jboss.server.data.dir"
    }
}</pre><p>
						Note that by default the <code class="literal">path</code> to the journal is <code class="literal">activemq/bindings</code>. You can change the location for <code class="literal">path</code> by using the following management CLI command.
					</p><pre class="screen">/subsystem=messaging-activemq/server=default/path=bindings-directory:write-attribute(name=path,value=<span class="emphasis"><em>PATH_LOCATION</em></span>)</pre><p>
						Also note the <code class="literal">relative-to</code> attribute in the output above. When <code class="literal">relative-to</code> is used, the value of the <code class="literal">path</code> attribute is treated as relative to the file path specified by <code class="literal">relative-to</code>. By default this value is the JBoss EAP property <code class="literal">jboss.server.data.dir</code>. For standalone servers, <code class="literal">jboss.server.data.dir</code> is located at <code class="literal"><span class="emphasis"><em>EAP_HOME</em></span>/standalone/data</code>. For domains, each server will have its own <code class="literal">serverX/data/activemq</code> directory located under <code class="literal"><span class="emphasis"><em>EAP_HOME</em></span>/domain/servers</code>. You can change the value of <code class="literal">relative-to</code> using the following management CLI command.
					</p><pre class="screen">/subsystem=messaging-activemq/server=default/path=bindings-directory:write-attribute(name=relative-to,value=<span class="emphasis"><em>RELATIVE_LOCATION</em></span>)</pre><p>
						By default, JBoss EAP is configured to automatically create the bindings directory if it does not exist. Use the following management CLI command to toggle this behavior.
					</p><pre class="screen">/subsystem=messaging-activemq/server=default:write-attribute(name=create-bindings-dir,value=<span class="emphasis"><em>TRUE/FALSE</em></span>)</pre><p>
						Setting <code class="literal">value</code> to <code class="literal">true</code> will enable automatic directory creation. Setting <code class="literal">value</code> to <code class="literal">false</code> will disable it.
					</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configue-message-journal"/>Configuring the Message Journal Location</h2></div></div></div><p>
						You can read the location information for the message journal by using the management CLI command below. The output is also included to highlight default configuration.
					</p><pre class="screen">/subsystem=messaging-activemq/server=default/path=journal-directory:read-resource
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "path" =&gt; "activemq/journal",
        "relative-to" =&gt; "jboss.server.data.dir"
    }
}</pre><p>
						Note that by default the <code class="literal">path</code> to the journal is <code class="literal">activemq/journal</code>. You can change the location for <code class="literal">path</code> by using the following management CLI command.
					</p><pre class="screen">/subsystem=messaging-activemq/server=default/path=journal-directory:write-attribute(name=path,value=<span class="emphasis"><em>PATH_LOCATION</em></span>)</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							For the best performance, Red Hat recommends that the journal be located on its own physical volume in order to minimize disk head movement. If the journal is on a volume which is shared with other processes which might be writing other files, such as a bindings journal, database, or transaction coordinator, then the disk head may well be moving rapidly between these files as it writes them, thus drastically reducing performance.
						</p></div><p>
						Also note the <code class="literal">relative-to</code> attribute in the output above. When <code class="literal">relative-to</code> is used, the value of the <code class="literal">path</code> attribute is treated as relative to the file path specified by <code class="literal">relative-to</code>. By default this value is the JBoss EAP property <code class="literal">jboss.server.data.dir</code>. For standalone servers, <code class="literal">jboss.server.data.dir</code> is located at <code class="literal"><span class="emphasis"><em>EAP_HOME</em></span>/standalone/data</code>. For domains, each server will have its own <code class="literal">serverX/data/activemq</code> directory located under <code class="literal"><span class="emphasis"><em>EAP_HOME</em></span>/domain/servers</code>. You can change the value of <code class="literal">relative-to</code> using the following management CLI command.
					</p><pre class="screen">/subsystem=messaging-activemq/server=default/path=journal-directory:write-attribute(name=relative-to,value=<span class="emphasis"><em>RELATIVE_LOCATION</em></span>)</pre><p>
						By default, JBoss EAP is configured to automatically create the journal directory if it does not exist. Use the following management CLI command to toggle this behavior.
					</p><pre class="screen">/subsystem=messaging-activemq/server=default:write-attribute(name=create-journal-dir,value=<span class="emphasis"><em>TRUE/FALSE</em></span>)</pre><p>
						Setting <code class="literal">value</code> to <code class="literal">true</code> will enable automatic directory creation. Setting <code class="literal">value</code> to <code class="literal">false</code> will disable it.
					</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring_message_journal_attributes"/>Configuring Message Journal Attributes</h2></div></div></div><p>
						The attributes listed below are all child properties of the messaging server. Therefore, the command syntax for getting and setting their values using the management CLI is the same for each.
					</p><p>
						To read the current value of a given attribute, the syntax is as follows:
					</p><pre class="screen">/subsystem=messaging-activemq/server=default:read-attribute(name=<span class="emphasis"><em>ATTRIBUTE_NAME</em></span>)</pre><p>
						The syntax for writing an attribute’s value follows a corresponding pattern.
					</p><pre class="screen">/subsystem=messaging-activemq/server=default:write-attribute(name=<span class="emphasis"><em>ATTRIBUTE_NAME</em></span>,value=<span class="emphasis"><em>NEW_VALUE</em></span>)</pre><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
								<code class="literal">create-journal-dir</code>
							</p><p class="simpara">
								If this is set to <code class="literal">true</code>, the journal directory will be automatically created at the location specified in <code class="literal">journal-directory</code> if it does not already exist. The default value is <code class="literal">true</code>.
							</p></li><li class="listitem"><p class="simpara">
								<code class="literal">journal-buffer-timeout</code>
							</p><p class="simpara">
								Instead of flushing on every write that requires a flush, we maintain an internal buffer, and flush the entire buffer either when it is full, or when a timeout expires, whichever is sooner. This is used for both NIO and ASYNCIO and allows the system to scale better with many concurrent writes that require flushing.
							</p><p class="simpara">
								This parameter controls the timeout at which the buffer will be flushed if it has not filled already. ASYNCIO can typically cope with a higher flush rate than NIO, so the system maintains different defaults for both NIO and ASYNCIO. The default for NIO is <code class="literal">3333333</code> nanoseconds, or 300 times per second. The default for ASYNCIO is <code class="literal">500000</code> nanoseconds, or 2000 times per second.
							</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
									By increasing the timeout, you may be able to increase system throughput at the expense of latency, the default parameters are chosen to give a reasonable balance between throughput and latency.
								</p></div></li><li class="listitem"><p class="simpara">
								<code class="literal">journal-buffer-size</code>
							</p><p class="simpara">
								The size, in bytes, of the timed buffer on ASYNCIO. Both <code class="literal">journal-buffer-size</code> and <code class="literal">journal-file-size</code> must be set larger than <code class="literal">min-large-message-size</code>. Otherwise, messages will not be written to the journal. See <a class="link" href="work_with_large_messages.html#configuring_messaging_large_messages" title="Configuring Large Messages">Configuring Large Messages</a> for more information.
							</p></li><li class="listitem"><p class="simpara">
								<code class="literal">journal-compact-min-files</code>
							</p><p class="simpara">
								The minimal number of files before we can consider compacting the journal. The compacting algorithm won’t start until you have at least <code class="literal">journal-compact-min-files</code>.
							</p><p class="simpara">
								Setting this to <code class="literal">0</code> will disable the feature to compact completely. This could be dangerous though as the journal could grow indefinitely. Use it wisely!
							</p><p class="simpara">
								The default for this parameter is <code class="literal">10</code>
							</p></li><li class="listitem"><p class="simpara">
								<code class="literal">journal-compact-percentage</code>
							</p><p class="simpara">
								The threshold to start compacting. When less than this percentage is considered live data, we start compacting. Note also that compacting will not kick in until you have at least <code class="literal">journal-compact-min-files</code> data files on the journal
							</p><p class="simpara">
								The default for this parameter is <code class="literal">30</code>.
							</p></li><li class="listitem"><p class="simpara">
								<code class="literal">journal-file-size</code>
							</p><p class="simpara">
								The size of each journal file, in bytes. The default value for this is <code class="literal">10485760</code> bytes, or 10MB. Both <code class="literal">journal-file-size</code> and <code class="literal">journal-buffer-size</code> must be set larger than <code class="literal">min-large-message-size</code>. Otherwise, messages will not be written to the journal. See <a class="link" href="work_with_large_messages.html#configuring_messaging_large_messages" title="Configuring Large Messages">Configuring Large Messages</a> for more information.
							</p></li><li class="listitem"><p class="simpara">
								<code class="literal">journal-max-io</code>
							</p><p class="simpara">
								Write requests are queued up before being submitted to the system for execution. This parameter controls the maximum number of write requests that can be in the IO queue at any one time. If the queue becomes full then writes will block until space is freed up.
							</p><p class="simpara">
								The system maintains different defaults for this parameter depending on whether it’s NIO or ASYNCIO. The default for NIO is <code class="literal">1</code>, and the default for ASYNCIO is <code class="literal">500</code>.
							</p><p class="simpara">
								There is a limit and the total max ASYNCIO cannot be higher than what is configured at the OS level, found at /proc/sys/fs/aio-max-nr, usually <code class="literal">65536</code>.
							</p></li><li class="listitem"><p class="simpara">
								<code class="literal">journal-min-files</code>
							</p><p class="simpara">
								The minimum number of files the journal will maintain. When JBoss EAP starts and there is no initial message data, JBoss EAP will pre-create <code class="literal">journal-min-files</code> number of files. The default is <code class="literal">2</code>.
							</p><p class="simpara">
								Creating journal files and filling them with padding is a fairly expensive operation and we want to minimize doing this at run-time as files get filled. By pre-creating files, as one is filled the journal can immediately resume with the next one without pausing to create it.
							</p><p class="simpara">
								Depending on how much data you expect your queues to contain at steady state you should tune this number of files to match that total amount of data.
							</p></li><li class="listitem"><p class="simpara">
								<code class="literal">journal-pool-files</code>
							</p><p class="simpara">
								The number of journal files that can be reused. ActiveMQ will create as many files as needed however when reclaiming files it will shrink back to the value. The default is <code class="literal">-1</code>, which means no limit.
							</p></li><li class="listitem"><p class="simpara">
								<code class="literal">journal-sync-transactional</code>
							</p><p class="simpara">
								If this is set to true then JBoss EAP will make sure all transaction data is flushed to disk on transaction boundaries, such as a commit, prepare, or rollback. The default value is <code class="literal">true</code>.
							</p></li><li class="listitem"><p class="simpara">
								<code class="literal">journal-sync-non-transactional</code>
							</p><p class="simpara">
								If this is set to true then JBoss EAP will make sure non transactional message data, such as sends and acknowledgements, are flushed to disk each time. The default value is <code class="literal">true</code>.
							</p></li><li class="listitem"><p class="simpara">
								<code class="literal">journal-type</code>
							</p><p class="simpara">
								Valid values are <code class="literal">NIO</code> or <code class="literal">ASYNCIO</code>.
							</p><p class="simpara">
								Choosing <code class="literal">NIO</code> tells JBoss EAP to use a Java NIO journal. <code class="literal">ASYNCIO</code> tells it to use a Linux asynchronous IO journal. If you choose <code class="literal">ASYNCIO</code> but are not running Linux, or you do not have libaio installed, JBoss EAP will use a Java NIO journal.
							</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="diabling-disk-write-cache"/>Note on Disabling Disk Write Cache</h2></div></div></div><p>
						This happens irrespective of whether you have executed a <code class="literal">fsync()</code> from the operating system or correctly synced data from inside a Java program!
					</p><p>
						By default many systems ship with disk write cache enabled. This means that even after syncing from the operating system there is no guarantee the data has actually made it to disk, so if a failure occurs, critical data can be lost.
					</p><p>
						Some more expensive disks have non volatile or battery backed write caches which will not necessarily lose data on event of failure, but you need to test them!
					</p><p>
						If your disk does not have an expensive non volatile or battery backed cache and it’s not part of some kind of redundant array, for example RAID, and you value your data integrity you need to make sure disk write cache is disabled.
					</p><p>
						Be aware that disabling disk write cache can give you a nasty shock performance wise. If you’ve been used to using disks with write cache enabled in their default setting, unaware that your data integrity could be compromised, then disabling it will give you an idea of how fast your disk can perform when acting really reliably.
					</p><p>
						On Linux you can inspect or change your disk’s write cache settings using the tools <code class="literal">hdparm</code> for IDE disks, or <code class="literal">sdparm</code> or <code class="literal">sginfo</code> for SDSI/SATA disks.
					</p><p>
						On Windows, you can check and change the setting by right clicking on the disk and then clicking <span class="strong"><strong>properties</strong></span>.
					</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="installing_libaio"/>Installing libaio</h2></div></div></div><p>
						The Java NIO journal is highly performant, but if you are running JBoss EAP messaging using Linux Kernel 2.6 or later, Red Hat highly recommends that you use the ASYNCIO journal for the very best persistence performance.
					</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							JBoss EAP supports ASYNCIO only when installed on versions 6 or 7 of Red Hat Enterprise Linux and only when using the ext4, xfs, gfs2 or nfs4 file systems. It is not possible to use the ASYNCIO journal under other operating systems or earlier versions of the Linux kernel.
						</p></div><p>
						You will need <code class="literal">libaio</code> installed to use the ASYNCIO journal. You can easily install it using the following YUM command:
					</p><pre class="screen">yum install libaio</pre><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
							Do not place your messaging journals on a tmpfs file system, which is used for the <code class="literal">/tmp</code> directory for example. JBoss EAP will fail to start if the ASYNCIO journal is using tmpfs.
						</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring_nfs_shared_store_for_messaging"/>Configuring the NFS Shared Store for Messaging</h2></div></div></div><p>
						When using dedicated, shared store, high availability for data replication, you must configure both the live server and the backup server to use a shared directory on the NFS client. If you configure one server to use a shared directory on the NFS server and the other server to use a shared directory on the NFS client, the backup server cannot recognize when the live server starts or is running. So to work properly, both servers must specify a shared directory on the NFS client.
					</p><p>
						You must also configure the following options for the NFS client mount:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								<code class="literal">sync</code>: This option specifies that all changes are immediately flushed to disk.
							</li><li class="listitem">
								<code class="literal">intr</code>: This option allows NFS requests to be interrupted if the server goes down or cannot be reached.
							</li><li class="listitem">
								<code class="literal">noac</code>: This option disables attribute caching and is needed to achieve attribute cache coherence among multiple clients.
							</li><li class="listitem">
								<code class="literal">soft</code>: This option specifies that if the host serving the exported file system is unavailable, the error should be reported rather than waiting for the server to come back online.
							</li><li class="listitem">
								<code class="literal">lookupcache=none</code>: This option disables lookup caching.
							</li><li class="listitem">
								<code class="literal">timeo=<span class="emphasis"><em>n</em></span></code>: The time in deciseconds (tenths of a second) the NFS client waits for a response before it retries an NFS request. For NFS over TCP, the default <code class="literal">timeo</code> value is <code class="literal">600</code> (60 seconds). For NFS over UDP, the client uses an adaptive algorithm to estimate an appropriate timeout value for frequently used request types, such as read and write requests.
							</li><li class="listitem">
								<code class="literal">retrans=<span class="emphasis"><em>n</em></span></code>: The number of times the NFS client retries a request before it attempts further recovery action. If the <code class="literal">retrans</code> option is not specified, the NFS client tries each request three times.
							</li></ul></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
							It is important to use reasonable values when you configure the <code class="literal">timeo</code> and <code class="literal">retrans</code> options. A default <code class="literal">timeo</code> wait time of <code class="literal">600</code> deciseconds (60 seconds) combined with a <code class="literal">retrans</code> value of <code class="literal">5</code> retries can result in a five minute wait for ActiveMQ Artemis to detect an NFS disconnection.
						</p></div><p>
						See the <a class="link" href="messaging-ha.html#shared_store" title="Shared Store">Shared Store</a> section in this guide for more information about how to use a shared file system for high availability.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="messaging_journal_persistence_using_a_jdbc_database"/>Messaging Journal Persistence Using a JDBC Database</h1></div></div></div><p>
					You can configure JBoss EAP 7 messaging to use JDBC to persist messages and binding data to a database instead of using the default file-based journal. To do this, you must first configure the <code class="literal">datasource</code> element in the <code class="literal">datasources</code> subsystem, and then define a <code class="literal">journal-datasource</code> attribute on the <code class="literal">server</code> element in the <code class="literal">messaging-activemq</code> subsystem to use that datasource. The presence of the <code class="literal">journal-datasource</code> attribute notifies the messaging subsystem to persist the journal entries to the database instead of the file-based journal. The <code class="literal">journal-database</code> attribute on the <code class="literal">server</code> resource in the <code class="literal">messaging-activemq</code> subsystem defines the SQL dialect that will be used to communicate with the database. It is configured automatically using the datasource metadata.
				</p><p>
					When persisting messages to a file-based journal, the large message size is limited only by the size of the disk. However, when persisting messages to a database, the large message size is limited to the maximum size of the <code class="literal">BLOB</code> data type for that database.
				</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						JBoss EAP 7.2 currently supports only the Oracle 12c and IBM DB2 Enterprise databases.
					</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring_a_messaging_journal_jdbc_persistence_store"/>Configuring a Messaging Journal JDBC Persistence Store</h2></div></div></div><p>
						Follow these steps to configure JBoss EAP 7 messaging to use JDBC to persist messages and binding data to a database.
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								Configure a <code class="literal">datasource</code> in the <code class="literal">datasources</code> subsystem for use by the <code class="literal">messaging-activemq</code> subsystem. For information about how to create and configure a datasource, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#datasource_management">Datasource Management</a> in the JBoss EAP <span class="emphasis"><em>Configuration Guide</em></span>.
							</li><li class="listitem"><p class="simpara">
								Configure the <code class="literal">messaging-activemq</code> subsystem to use the new datasource.
							</p><pre class="screen">/subsystem=messaging-activemq/server=default:write-attribute(name=journal-datasource,value="MessagingOracle12cDS")</pre><p class="simpara">
								This creates the following configuration in the <code class="literal">messaging-activemq</code> subsystem of the server configuration file.
							</p><pre class="programlisting">&lt;server name="default"&gt;
  &lt;journal datasource="MessagingOracle12cDS"/&gt;
  ...
&lt;/server&gt;</pre></li></ol></div><p>
						JBoss EAP messaging is now configured to use the database to store messaging data.
					</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring_messaging_journal_jdbc_table_names"/>Configuring Messaging Journal Table Names</h2></div></div></div><p>
						JBoss EAP 7 messaging uses a separate JDBC table to store binding information, messages, large messages, and paging information. The names of these tables can be configured using the <code class="literal">journal-bindings-table</code>, <code class="literal">journal-jms-bindings-table</code>, <code class="literal">journal-messages-table</code>, <code class="literal">journal-large-messages-table</code>, and <code class="literal">journal-page-store-table</code> attributes on the <code class="literal">server</code> resource in the <code class="literal">messaging-activemq</code> subsystem of the server configuration file.
					</p><p>
						There are some restrictions on table names.
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								JBoss EAP 7 messaging generates identifiers for paging tables using pattern <span class="emphasis"><em>TABLE_NAME</em></span> + <span class="emphasis"><em>GENERATED_ID</em></span>, where the <span class="emphasis"><em>GENERATED_ID</em></span> can be up to 20 characters long. Because the maximum table name length in Oracle Database 12c is 30 characters, you must limit the table name to 10 characters. Otherwise, you might see the error <code class="literal">ORA-00972: identifier is too long</code> and paging will no longer work.
							</li><li class="listitem">
								Table names that do not follow <a class="link" href="https://docs.oracle.com/cd/B19306_01/server.102/b14200/sql_elements008.htm#i27570">Schema Object Naming Rules</a> for Oracle Database 12c must be enclosed within double quotes. Quoted identifiers can begin with any character and can contain any characters and punctuation marks as well as spaces. However, neither quoted nor nonquoted identifiers can contain double quotation marks or the null character (\0). It is important to note that quoted identifiers are case sensitive.
							</li><li class="listitem">
								If multiple JBoss EAP server instances use the same database to persist messages and binding data, the table names must be unique for each server instance. Multiple JBoss EAP servers cannot access the same tables.
							</li></ul></div><p>
						The following is an example of the management CLI command that configures the <code class="literal">journal-page-store-table</code> name using a quoted identifier.
					</p><pre class="screen">/subsystem=messaging-activemq/server=default:write-attribute(name=journal-page-store-table,value="\"PAGE_DATA\"")</pre><p>
						This creates the following configuration in the <code class="literal">messaging-activemq</code> subsystem of the server configuration file.
					</p><pre class="programlisting">&lt;server name="default"&gt;
  &lt;journal datasource="MessagingOracle12cDS" journal-page-store-table="&amp;quot;PAGED_DATA&amp;quot;"/&gt;
  ...
&lt;/server&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring_messaging_journals_in_a_managed_domain"/>Configuring Messaging Journals in a Managed Domain</h2></div></div></div><p>
						As mentioned previously in <a class="link" href="configuring_persistence.html#configuring_messaging_journal_jdbc_table_names" title="Configuring Messaging Journal Table Names">Configuring Messaging Journal Table Names</a>, multiple JBoss EAP servers cannot access the same database tables when using JDBC to persist messages and binding data to a database. Because, in a managed domain, all JBoss EAP server instances in a server group share the same profile configuration, you must use expressions to configure the messaging journal names or datasources.
					</p><p>
						If all servers are configured to use the same database to store messaging data, the table names must be unique for each server instance. The following is an example of a management CLI command that creates a unique <code class="literal">journal-page-store-table</code> table name for each server in a server group by using an expression that includes the unique node identifier in the name.
					</p><pre class="screen">/subsystem=messaging-activemq/server=default:write-attribute(name=journal-page-store-table,value="${env.NODE_ID}_page_store")</pre><p>
						If each server instance accesses a different database, you can use expressions to allow the messaging configuration for each server to connect to a different datasource. The following management CLI command uses the <code class="literal">DB_CONNECTION_URL</code> environment variable in the <code class="literal">connection-url</code> to connect to a different datasource.
					</p><pre class="screen">data-source add --name=messaging-journal --jndi-name=java:jboss/datasources/messaging-journal --driver-name=oracle12c  --connection-url=${env.DB_CONNECTION_URL}</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring_messaging_journal_jdbc_network_timeout"/>Configuring the Messaging Journal Network Timeout</h2></div></div></div><p>
						You can configure the maximum amount of time, in milliseconds, that the JDBC connection will wait for the database to reply a request. This is useful in the event that the network goes down or a connection between JBoss EAP messaging and the database is closed for any reason. When this occurs, clients are blocked until the timeout occurs.
					</p><p>
						You configure the timeout by updating the <code class="literal">journal-jdbc-network-timeout</code> attribute. The default value is <code class="literal">20000</code> milliseconds, or <code class="literal">20</code> seconds.
					</p><p>
						The following is an example of the management CLI command that sets the <code class="literal">journal-jdbc-network-timeout</code> attribute value to <code class="literal">10000</code> milliseconds, or <code class="literal">10</code> seconds.
					</p><pre class="screen">/subsystem=messaging-activemq/server=default:write-attribute(name=journal-jdbc-network-timeout,value=10000)</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="messaging_ha_jdbc_persistence"/>Configuring HA for Messaging JDBC Persistence Store</h2></div></div></div><p>
						The JBoss EAP <code class="literal">messaging-activemq</code> subsystem activates the JDBC HA shared store functionality when the broker is configured with a database store type. The broker then uses a shared database table to ensure that the live and backup servers coordinate actions over a shared JDBC journal store.
					</p><p>
						You can configure HA for JDBC persistence store using the following attributes:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								<code class="literal">journal-node-manager-store-table</code>: Name of the JDBC database table to store the node manager.
							</li><li class="listitem">
								<code class="literal">journal-jdbc-lock-expiration</code>: The time a JDBC lock is considered valid without keeping it alive. The default value is <code class="literal">20000</code> milliseconds.
							</li><li class="listitem">
								<code class="literal">journal-jdbc-lock-renew-period</code>: The period of the keep alive service of a JDBC lock. The default value is <code class="literal">2000</code> milliseconds.
							</li></ul></div><p>
						The default values are taken into account based on the value of the server’s <code class="literal">ha-policy</code> and <code class="literal">journal-datasource</code> attributes.
					</p><p>
						For backward compatibility, you can also specify their values using the respective Artemis-specific system properties:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								<code class="literal">brokerconfig.storeConfiguration.nodeManagerStoreTableName</code>
							</li><li class="listitem">
								<code class="literal">brokerconfig.storeConfiguration.jdbcLockExpirationMillis</code>
							</li><li class="listitem">
								<code class="literal">brokerconfig.storeConfiguration.jdbcLockRenewPeriodMillis</code>
							</li></ul></div><p>
						When configured, these system properties have precedence over the corresponding attribute’s default value.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="managing_journal_prepared_transactions"/>Managing Messaging Journal Prepared Transactions</h1></div></div></div><p>
					You can manage messaging journal prepared transactions using the following management CLI commands.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
							Commit a prepared transaction:
						</p><pre class="screen">/subsystem=messaging-activemq/server=default:commit-prepared-transaction(transaction-as-base-64=<span class="emphasis"><em>XID</em></span>)</pre></li><li class="listitem"><p class="simpara">
							Roll back a prepared transaction:
						</p><pre class="screen">/subsystem=messaging-activemq/server=default:rollback-prepared-transaction(transaction-as-base-64=<span class="emphasis"><em>XID</em></span>)</pre></li><li class="listitem"><p class="simpara">
							Show the details of all prepared transactions:
						</p><pre class="screen">/subsystem=messaging-activemq/server=default:list-prepared-transactions</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								You can also show the prepared transaction details in HTML format using the <code class="literal">list-prepared-transaction-details-as-html</code> operation, or in JSON format using the <code class="literal">list-prepared-transaction-details-as-json</code> operation.
							</p></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring-messaging-for-zero-persistence"/>Configuring JBoss EAP Messaging for Zero Persistence</h1></div></div></div><p>
					In some situations, zero persistence is required for a messaging system. Zero persistence means that no bindings data, message data, large message data, duplicate id caches, or paging data should be persisted.
				</p><p>
					To configure the <code class="literal">messaging-activemq</code> subsystem to perform zero persistence, set the <code class="literal">persistence-enabled</code> parameter to <code class="literal">false</code>.
				</p><pre class="screen">/subsystem=messaging-activemq/server=default:write-attribute(name=persistence-enabled,value=false)</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						Be aware that if persistence is disabled, but paging is enabled, page files continue to be stored in the location specified by the <code class="literal">paging-directory</code> element. Paging is enabled when the <code class="literal">address-full-policy</code> attribute is set to <code class="literal">PAGE</code>. If full zero persistence is required, be sure to configure the <code class="literal">address-full-policy</code> attribute of the <code class="literal">address-setting</code> element to use <code class="literal">BLOCK</code>, <code class="literal">DROP</code> or <code class="literal">FAIL</code>.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="importing_and_exporting_journal_data"/>Importing and Exporting Journal Data</h1></div></div></div><p>
					See the JBoss EAP 7 <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/migration_guide/">Migration Guide</a> for information on importing and exporting journal data.
				</p></div></div></body></html>