<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 16. Configuring Message Expiry</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="set_message_expiry"/>Chapter 16. Configuring Message Expiry</h1></div></div></div><p>
				Sent messages can be set to expire on the server if they are not delivered to a consumer after a specified amount of time. These expired messages can later be consumed for further inspection.
			</p><h2><a id="set_message_expiry_using_the_core_api"/>Set Message Expiry Using the Core API</h2><p>
				Using the core API, you can set an expiration time on a message using the <code class="literal">setExpiration</code> method.
			</p><pre class="programlisting">// The message will expire 5 seconds from now
message.setExpiration(System.currentTimeMillis() + 5000);</pre><h2><a id="set_message_expiry_using_jms"/>Set Message Expiry Using JMS</h2><p>
				You can set the time to live for the JMS <code class="literal">MessageProducer</code> to use when sending messages. You specify this value, in milliseconds, using the <code class="literal">setTimeToLive</code> method.
			</p><pre class="programlisting">// Messages sent by this producer will be retained for 5 seconds before expiring
producer.setTimeToLive(5000);</pre><p>
				You can also specify the message expiry on a per-message basis by setting the time to live on the producer’s <code class="literal">send</code> method.
			</p><pre class="programlisting">// The last parameter of the send method is the time to live, in milliseconds
producer.send(message, DeliveryMode.PERSISTENT, 0, 5000)</pre><p>
				Expired messages that are consumed from an expiry address have the following properties.
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
						<code class="literal">_AMQ_ORIG_ADDRESS</code>
					</p><p class="simpara">
						A <code class="literal">String</code> property containing the original address of the expired message.
					</p></li><li class="listitem"><p class="simpara">
						<code class="literal">_AMQ_ACTUAL_EXPIRY</code>
					</p><p class="simpara">
						A <code class="literal">Long</code> property containing the actual expiration time of the expired message.
					</p></li></ul></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="expiry_address"/>Expiry Address</h1></div></div></div><p>
					You can specify where to send expired messages by setting an expiry address. If a message expires and no expiry address is specified, the message is removed from the queue and dropped.
				</p><p>
					You can set an <code class="literal">expiry-address</code> for an <code class="literal">address-setting</code> using the management CLI. In the below example, expired messages in the <code class="literal">jms.queue.exampleQueue</code> queue will be sent to the <code class="literal">jms.queue.expiryQueue</code> expiry address.
				</p><pre class="screen">/subsystem=messaging-activemq/server=default/address-setting=jms.queue.exampleQueue:write-attribute(name=expiry-address,value=jms.queue.expiryQueue)</pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="expiry_reaper_thread-1"/>Expiry Reaper Thread</h1></div></div></div><p>
					A reaper thread periodically inspects the queues to check whether messages have expired. You can set the scan period and thread priority for the reaper thread using the management CLI.
				</p><p>
					Set the scan period for the expiry reaper thread, which is how often, in milliseconds, the queues will be scanned to detect expired messages. The default is <code class="literal">30000</code>. You can set this to <code class="literal">-1</code> to disable the reaper thread.
				</p><pre class="screen">/subsystem=messaging-activemq/server=default:write-attribute(name=message-expiry-scan-period,value=30000)</pre><p>
					Set the thread priority for the expiry reaper thread. Possible values are from <code class="literal">0</code> to <code class="literal">9</code>, with <code class="literal">9</code> being the highest priority. The default is <code class="literal">3</code>.
				</p><pre class="screen">/subsystem=messaging-activemq/server=default:write-attribute(name=message-expiry-thread-priority,value=3)</pre></div></div></body></html>