<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 19. Flow Control</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="flow_control"/>Chapter 19. Flow Control</h1></div></div></div><p>
				Flow control can be used to limit the flow of messaging data between a client and server so that messaging participants are not overwhelmed. You can manage the flow of data from both the consumer side and the producer side.
			</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="consumer_flow_control"/>Consumer Flow Control</h1></div></div></div><p>
					JBoss EAP messaging includes configuration that defines how much data to pre-fetch on behalf of consumers and that controls the rate at which consumers can consume messages.
				</p><h3><a id="window_based_flow_control"/>Window-based Flow Control</h3><p>
					JBoss EAP messaging pre-fetches messages into a buffer on each consumer. The size of the buffer is determined by the <code class="literal">consumer-window-size</code> attribute of a <code class="literal">connection-factory</code>. The example configuration below shows a <code class="literal">connection-factory</code> with the <code class="literal">consumer-window-size</code> attribute explicitly set.
				</p><pre class="programlisting">&lt;connection-factory name="MyConnFactory" ... consumer-window-size="1048576" /&gt;</pre><p>
					Use the management CLI to read and write the value of <code class="literal">consumer-window-size</code> attribute for a given <code class="literal">connection-factory</code>. The examples below show how this done using the <code class="literal">InVmConnectionFactory</code> connection factory, which is the default for consumers residing in the same virtual machine as the server, for example, a local <code class="literal">MessageDrivenBean</code>.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Read the <code class="literal">consumer-window-size</code> attribute of the <code class="literal">InVmConnectionFactory</code> from the management CLI
						</li></ul></div><pre class="screen">/subsystem=messaging-activemq/server=default/connection-factory=InVmConnectionFactory:read-attribute(name=consumer-window-size)
{
    "outcome" =&gt; "success",
    "result" =&gt; 1048576
}</pre><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Write the <code class="literal">consumer-window-size</code> attribute from the management CLI
						</li></ul></div><pre class="screen">/subsystem=messaging-activemq/server=default/connection-factory=InVmConnectionFactory:write-attribute(name=consumer-window-size,value=1048576)
{"outcome" =&gt; "success"}</pre><p>
					The value for <code class="literal">consumer-window-size</code> must be an integer. Some values have special meaning as noted in the table below.
				</p><div class="table"><a id="idm139716445006240"/><p class="title"><strong>Table 19.1. Values for consumer-window-size</strong></p><div class="table-contents"><table summary="Values for consumer-window-size" border="1"><colgroup><col class="col_1"/><col class="col_2"/></colgroup><thead><tr><th style="text-align: left" valign="top">Value</th><th style="text-align: left" valign="top">Description</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
									n
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									An integer value used to set the buffer’s size to <code class="literal">n</code> bytes. The default is <code class="literal">1048576</code>, which should be fine in most cases. Benchmarking will help you find an optimal value for the window size if the default value is not adequate.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									0
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Turns off buffering. This can help with slow consumers and can give deterministic distribution across multiple consumers.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									-1
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Creates an unbounded buffer. This can help facilitate very fast consumers that pull and process messages as quickly as they are received.
								</p>
								 </td></tr></tbody></table></div></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
						Setting <code class="literal">consumer-window-size</code> to <code class="literal">-1</code> can overflow the client memory if the consumer is not able to process messages as fast as it receives them.
					</p></div><p>
					If you are using the core API, the consumer window size can be set from the <code class="literal">ServerLocator</code> using its <code class="literal">setConsumerWindowSize()</code> method.
				</p><p>
					If you are using JMS, the client can specify the consumer window size by using the <code class="literal">setConsumerWindowSize()</code> method of the instantiated <code class="literal">ConnectionFactory</code>.
				</p><h3><a id="rate_limited_flow_control"/>Rate-limited Flow Control</h3><p>
					JBoss EAP messaging can regulate the rate of messages consumed per second, a flow control method known as throttling. Use the <code class="literal">consumer-max-rate</code> attribute of the appropriate <code class="literal">connection-factory</code> to ensure that a consumer never consumes messages at a rate faster than specified.
				</p><pre class="programlisting">&lt;connection-factory name="MyConnFactory" ... consumer-max-rate="10" /&gt;</pre><p>
					The default value is <code class="literal">-1</code>, which disables rate limited flow control.
				</p><p>
					The management CLI is the recommended way to read and write the <code class="literal">consumer-max-rate</code> attribute. The examples below show how this done using the <code class="literal">InVmConnectionFactory</code> connection factory, which is the default for consumers residing in the same virtual machine as the server, e.g. a local <code class="literal">MessageDrivenBean</code>.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Read the <code class="literal">consumer-max-rate</code> attribute using the management CLI
						</li></ul></div><pre class="screen">/subsystem=messaging-activemq/server=default/connection-factory=InVmConnectionFactory:read-attribute(name=consumer-max-rate)
{
    "outcome" =&gt; "success",
    "result" =&gt; -1
}</pre><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Write the <code class="literal">consumer-max-rate</code> attribute using the management CLI:
						</li></ul></div><pre class="screen">/subsystem=messaging-activemq/server=default/connection-factory=InVmConnectionFactory:write-attribute(name=consumer-max-rate,value=100)
{"outcome" =&gt; "success"}</pre><p>
					If you are using JMS the max rate size can be set using setConsumerMaxRate(int consumerMaxRate) method of the instantiated <code class="literal">ConnectionFactory</code>.
				</p><p>
					If you are using the Core API the rate can be set with the <code class="literal">ServerLocator.setConsumerMaxRate(int consumerMaxRate)</code> method.
				</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="producer_flow_control"/>Producer Flow Control</h1></div></div></div><p>
					JBoss EAP messaging can also limit the amount of data sent from a client in order to prevent the server from receiving too many messages.
				</p><h3><a id="window_based_flow_control_2"/>Window-based Flow Control</h3><p>
					JBoss EAP messaging regulates message producers by using an exchange of credits. Producers can send messages to an address as long as they have sufficient credits to do so. The amount of credits required to send a message is determined by its size. As producers run low on credits, they must request more from the server. Within the server configuration, the amount of credits a producer can request at one time is known as the <code class="literal">producer-window-size</code>, an attribute of the <code class="literal">connection-factory</code> element:
				</p><pre class="programlisting">&lt;connection-factory name="MyConnFactory" ... producer-window-size="1048576" /&gt;</pre><p>
					The window size determines the amount of bytes that can be in-flight at any one time, thus preventing the remote connection from overloading the server.
				</p><p>
					Use the management CLI to read and write the <code class="literal">producer-window-size</code> attribute of a given connection factory. The examples below use the <code class="literal">RemoteConnectionFactory</code>, which is included in the default configuration and intended for use by remote clients.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Read the <code class="literal">producer-window-size</code> attribute using the management CLI:
						</li></ul></div><pre class="screen">subsystem=messaging-activemq/server=default/connection-factory=RemoteConnectionFactory:read-attribute(name=producer-window-size)
{
    "outcome" =&gt; "success",
    "result" =&gt; 65536
}</pre><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Write the <code class="literal">producer-window-size</code> attribute using the management CLI:
						</li></ul></div><pre class="screen">/subsystem=messaging-activemq/server=default/connection-factory=RemoteConnectionFactory:write-attribute(name=producer-window-size,value=65536)
{"outcome" =&gt; "success"}</pre><p>
					If you are using JMS, the client can call the <code class="literal">setProducerWindowSize(int producerWindowSize)</code> method of the <code class="literal">ConnectionFactory</code> to set the window size directly.
				</p><p>
					If you are using the core API, the window size can be set using the <code class="literal">setProducerWindowSize(int producerWindowSize)</code> method of the <code class="literal">ServerLocator</code>.
				</p><h3><a id="blocking_producer_window_based_flow_control"/>Blocking Producer Window-based Flow Control</h3><p>
					Typically, the messaging server always provides the same number of credits that was requested. However, it is possible to limit the number of credits sent by the server, which can prevent it from running out of memory due to producers sending more messages than can be handled at one time.
				</p><p>
					For example, if you have a JMS queue called <code class="literal">myqueue</code> and you set the maximum memory size to 10MB, the server will regulate the number of messages in the queue so that its size never exceeds 10MB. When the address gets full, producers will block on the client side until sufficient space is freed up on the address.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Blocking producer flow control is an alternative approach to paging, which does not block producers but instead pages messages to storage. See <a class="link" href="configuring_paging.html#about_paging" title="About Paging">About Paging</a> for more information.
					</p></div><p>
					The <code class="literal">address-setting</code> configuration element contains the configuration for managing blocking producer flow control. An <code class="literal">address-setting</code> is used to apply a set of configuration to all queues registered to that address. See <a class="link" href="configure_address_settings.html" title="Chapter 6. Address Settings">Configuring Address Settings</a> for more information on how this is done.
				</p><p>
					For each <code class="literal">address-setting</code> requiring blocking producer flow control, you must include a value for the <code class="literal">max-size-bytes</code> attribute. The total memory for all queues bound to that address cannot exceed <code class="literal">max-size-bytes</code>. In the case of JMS topics, this means the total memory of all subscriptions in the topic cannot exceed <code class="literal">max-size-bytes</code>.
				</p><p>
					You must also set the <code class="literal">address-full-policy</code> attribute to <code class="literal">BLOCK</code> so the server knows that producers should be blocked if <code class="literal">max-size-bytes</code> is reached. Below is an example <code class="literal">address-setting</code> with both attributes set:
				</p><pre class="programlisting">&lt;address-setting ...
      name="myqueue"
      address-full-policy="BLOCK"
      max-size-bytes="100000" /&gt;</pre><p>
					The above example would set the maximum size of the JMS queue "myqueue" to <code class="literal">100000</code> bytes. Producers will be blocked from sending to that address once it has reached its maximum size.
				</p><p>
					Use the management CLI to set these attributes, as in the examples below:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Set <code class="literal">max-size-bytes</code> for a specified <code class="literal">address-setting</code>
						</li></ul></div><pre class="screen">/subsystem=messaging-activemq/server=default/address-setting=myqueue:write-attribute(name=max-size-bytes,value=100000)
{"outcome" =&gt; "success"}</pre><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Set <code class="literal">address-full-policy</code> for a specified <code class="literal">address-setting</code>
						</li></ul></div><pre class="screen">/subsystem=messaging-activemq/server=default/address-setting=myqueue:write-attribute(name=address-full-policy,value=BLOCK)
{"outcome" =&gt; "success"}</pre><h3><a id="rate_limited_flow_control_2"/>Rate-limited Flow Control</h3><p>
					JBoss EAP messaging limits the number of messages a producer can send per second if you specify a <code class="literal">producer-max-rate</code> for the <code class="literal">connection-factory</code> it uses, as in the example below:
				</p><pre class="programlisting">&lt;connection-factory name="MyConnFactory" producer-max-rate="1000" /&gt;</pre><p>
					The default value is <code class="literal">-1</code>, which disables rate limited flow control.
				</p><p>
					Use the management CLI to read and write the value for <code class="literal">producer-max-rate</code>. The examples below use the <code class="literal">RemoteConnectionFactory</code>, which is included in the default configuration and intended for use by remote clients.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Read the value of the <code class="literal">producer-max-rate</code> attribute:
						</li></ul></div><pre class="screen">/subsystem=messaging-activemq/server=default/connection-factory=RemoteConnectionFactory:read-attribute(name=producer-max-rate)
{
    "outcome" =&gt; "success",
    "result" =&gt; -1
}</pre><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Write the value of a <code class="literal">producer-max-rate</code> attribute:
						</li></ul></div><pre class="screen">/subsystem=messaging-activemq/server=default/connection-factory=RemoteConnectionFactory:write-attribute(name=producer-max-rate,value=100)
{"outcome" =&gt; "success"}</pre><p>
					If you use the core API, set the rate by using the method <code class="literal">ServerLocator.setProducerMaxRate(int producerMaxRate)</code>.
				</p><p>
					If you are using JNDI to instantiate and look up the connection factory, the max rate can be set on the client using the <code class="literal">setProducerMaxRate(int producerMaxRate)</code> method of the instantiated connection factory.
				</p></div></div></body></html>