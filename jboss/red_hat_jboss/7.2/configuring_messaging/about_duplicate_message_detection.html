<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 25. Configuring Duplicate Message Detection</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="about_duplicate_message_detection"/>Chapter 25. Configuring Duplicate Message Detection</h1></div></div></div><p>
				When a sender sends a message to another server, there can be a situation where the target server or the connection fails after sending the message, but before sending a response to the sender indicating that the process was successful. In these situations, it is very difficult for the sender to determine whether the message was sent successfully to the intended receiver. If the sender decides to resend the last message, it can result in a duplicate message being sent to the address.
			</p><p>
				You can configure duplicate message detection in JBoss EAP messaging so that your application does not need to provide the logic to filter duplicate messages.
			</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="using_duplicate_message_detection_for_sending_messages"/>Using Duplicate Message Detection for Sending Messages</h1></div></div></div><p>
					To enable duplicate message detection for sent messages, you need to set the value of the <code class="literal">org.apache.activemq.artemis.api.core.Message.HDR_DUPLICATE_DETECTION_ID</code> property, which resolves to <code class="literal">_AMQ_DUPL_ID</code>, to a unique value. When the target server receives the messages, if the <code class="literal">_AMQ_DUPL_ID</code> property is set, it will check its memory cache to see if it has already received a message with the value of that header. If it has, then this message will be ignored. See <a class="link" href="about_duplicate_message_detection.html#configuring_duplicate_id_cache" title="Configuring the Duplicate ID Cache">Configuring the Duplicate ID Cache</a> for more information.
				</p><p>
					The value of the <code class="literal">_AMQ_DUPL_ID</code> property can be of type <code class="literal">byte[]</code> or <code class="literal">SimpleString</code> if you are using the core API. If you are using JMS, it must be a <code class="literal">String</code>.
				</p><p>
					The following example shows how to set the property for core API.
				</p><pre class="programlisting">SimpleString myUniqueID = "This is my unique id";   // Can use a UUID for this

ClientMessage message = session.createMessage(true);
message.setStringProperty(HDR_DUPLICATE_DETECTION_ID, myUniqueID);</pre><p>
					The following example shows how to set the property for JMS clients.
				</p><pre class="programlisting">String myUniqueID = "This is my unique id";   // Can use a UUID for this

Message jmsMessage = session.createMessage();
message.setStringProperty(HDR_DUPLICATE_DETECTION_ID.toString(), myUniqueID);</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						Duplicate messages are <span class="emphasis"><em>not</em></span> detected when they are sent within the same transaction using the <code class="literal">HDR_DUPLICATE_DETECTION_ID</code> property.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_duplicate_id_cache"/>Configuring the Duplicate ID Cache</h1></div></div></div><p>
					The server maintains caches of received values of the <code class="literal">_AMQ_DUPL_ID</code> property that is sent to each address. Each address maintains its own address cache.
				</p><p>
					The cache is fixed in terms of size. The maximum size of cache is configured using the <code class="literal">id-cache-size</code> attribute. The default value of this parameter is <code class="literal">20000</code> elements. If the cache has a maximum size of <code class="literal">n</code> elements, then the (<code class="literal">n + 1</code>)th ID stored will overwrite the element <code class="literal">0</code> in the cache. The value is set using the following management CLI command:
				</p><pre class="screen">/subsystem=messaging-activemq/server=default:write-attribute(name=id-cache-size,value=<span class="emphasis"><em>SIZE</em></span>)</pre><p>
					The caches can also be configured to persist to disk. This can be configured by setting the <code class="literal">persist-id-cache</code> attribute using the following management CLI command.
				</p><pre class="screen">/subsystem=messaging-activemq/server=default:write-attribute(name=persist-id-cache,value=true)</pre><p>
					If this value is set to <code class="literal">true</code>, then each ID will be persisted to permanent storage as they are received. The default value for this parameter is <code class="literal">true</code>.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Set the size of the duplicate ID cache to a large size in order to ensure that resending of messages does not overwrite the previously sent messages stored in the cache.
					</p></div></div></div></body></html>