<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 4. Monitoring Transactions</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="monitoring_transactions"/>Chapter 4. Monitoring Transactions</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_logging_for_the_transaction_subsystem"/>Configuring Logging for the Transactions Subsystem</h1></div></div></div><p>
				You can control the amount of information logged about transactions, independent of other logging settings in JBoss EAP. You can configure the logging settings using the management console or the management CLI.
			</p><h3><a id="configuring_the_transaction_logger_using_the_management_console"/>Configuring the Transaction Logger Using the Management Console</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
						Navigate to the <span class="strong"><strong>Logging</strong></span> subsystem configuration.
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								In the management console, click the <span class="strong"><strong>Configuration</strong></span> tab. If you use a managed domain, you must choose the appropriate server profile.
							</li><li class="listitem">
								Select <span class="strong"><strong>Subsystems</strong></span> → <span class="strong"><strong>Logging</strong></span> → <span class="strong"><strong>Configuration</strong></span> and click <span class="strong"><strong>View</strong></span>.
							</li></ol></div></li><li class="listitem"><p class="simpara">
						Edit the <code class="literal">com.arjuna</code> attributes.
					</p><p class="simpara">
						Select the <span class="strong"><strong>Categories</strong></span> tab. The <code class="literal">com.arjuna</code> entry is already present. Select <code class="literal">com.arjuna</code> and click <span class="strong"><strong>Edit</strong></span>. You can change the log level and choose whether to use parent handlers or not.
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
								Log Level:
							</p><p class="simpara">
								As transactions can produce a lot of logging output, the default logging level is set to <code class="literal">WARN</code> so that the server log is not overwhelmed by transaction output. If you need to check transaction processing details, use the <code class="literal">TRACE</code> log level so that transaction IDs are shown.
							</p></li><li class="listitem"><p class="simpara">
								Use Parent Handlers:
							</p><p class="simpara">
								Parent handler indicates whether the logger should send its output to its parent logger. The default behavior is <code class="literal">true</code>.
							</p></li></ul></div></li><li class="listitem">
						Click <span class="strong"><strong>Save</strong></span> to save the changes.
					</li></ol></div><h3><a id="configuring_the_transaction_logger_using_the_management_cli"/>Configuring the Transaction Logger Using the Management CLI</h3><p>
				Use the following command to set the logging level from the management CLI. For a standalone server, remove the <code class="literal">/profile=default</code> from the command.
			</p><pre class="screen">/profile=default/subsystem=logging/logger=com.arjuna:write-attribute(name=level,value=<span class="emphasis"><em>VALUE</em></span>)</pre><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="enabling_trace_log_leve"/>Enabling the TRACE Log Level</h2></div></div></div><p>
					The <code class="literal">TRACE</code> level logging allows you diagnose JCA issues in JBoss EAP. You can execute the following command to enable the <code class="literal">TRACE</code> level logging for <code class="literal">com.arjuna</code> class:
				</p><pre class="screen">/profile=default/subsystem=logging/logger=com.arjuna:write-attribute(name=level,value=TRACE)</pre><p>
					For a standalone server, remove the <code class="literal">/profile=default</code> from the command.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="enabling_transaction_bridge_logger"/>Enabling the Transaction Bridge Logger</h2></div></div></div><p>
					The transaction bridge is a layer on top of the XTS and JTA/JTS components of the Transaction Manager. It interacts with other parts of JBoss EAP server. You can enable verbose logging of these components that interact with the Transaction Manager for a detailed explanation of the system’s operations.
				</p><p>
					The transaction bridge uses the <code class="literal">logging</code> subsystem. When running the JBoss EAP server, logging is configured from the <code class="literal">logging</code> subsystem configuration in the <code class="literal">standalone-xts.xml</code> file. Logging for the transaction bridge is useful for debugging purposes.
				</p><p>
					You can use the following management CLI command to configure the <code class="literal">org.jboss.jbossts.txbridge</code> logger to enable the transaction bridge logging:
				</p><pre class="screen">/subsystem=logging/logger=org.jboss.jbossts.txbridge:add(level=ALL)</pre><p>
					This generates the following XML in the server configuration file:
				</p><pre class="programlisting">&lt;logger category="org.jboss.jbossts.txbridge"&gt;
  &lt;level name="ALL" /&gt;
&lt;/logger&gt;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Deployment ordering issues may result in the Transaction Manager components becoming active before the <code class="literal">logging</code> subsystem is fully configured, including the transaction bridge. In such cases a default logging level gets applied during startup, thereby resulting in detailed debug messages being missed.
					</p></div><p>
					You can configure the <code class="literal">com.arjuna</code> logger to enable verbose logging using the following management CLI command:
				</p><pre class="screen">/subsystem=logging/logger=com.arjuna:write-attribute(name=level,value=ALL)</pre><p>
					This generates the following XML in the server configuration file:
				</p><pre class="programlisting">&lt;logger category="com.arjuna"&gt;
  &lt;level name="ALL" /&gt;
&lt;/logger&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="about_transaction_log_messages"/>Transaction Log Messages</h2></div></div></div><p>
					You can track the transaction status while keeping the log files readable by using the <code class="literal">DEBUG</code> log level for the transaction logger. For detailed debugging, use the <code class="literal">TRACE</code> log level. Refer to <a class="link" href="monitoring_transactions.html#configuring_logging_for_the_transaction_subsystem" title="Configuring Logging for the Transactions Subsystem">Configuring Logging for the Transactions Subsystem</a> for information on configuring the transaction logger.
				</p><p>
					Transaction Manager (TM) can generate a lot of logging information when configured to log in the <code class="literal">TRACE</code> log level. Following are some of the most commonly-seen messages. This list is not comprehensive, so you may see messages other than these.
				</p><div class="table"><a id="idm139754259849728"/><p class="title"><strong>Table 4.1. Transaction State Change</strong></p><div class="table-contents"><table summary="Transaction State Change" border="1"><colgroup><col class="col_1"/><col class="col_2"/></colgroup><tbody><tr><td style="text-align: left" valign="top"> <p>
									Transaction Begin
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									When a transaction begins, a method <code class="literal">Begin</code> of class <code class="literal">com.arjuna.ats.arjuna.coordinator.BasicAction</code> is executed and presented in the log with the message <code class="literal">BasicAction::Begin() for action-id &lt;transaction uid&gt;</code>.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									Transaction Commit
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									When a transaction commits, a method <code class="literal">Commit</code> of class <code class="literal">com.arjuna.ats.arjuna.coordinator.BasicAction</code> is executed and presented in the log with the message <code class="literal">BasicAction::Commit() for action-id &lt;transaction uid&gt;</code>.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									Transaction Rollback
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									When a transaction rolls back, a method <code class="literal">Rollback</code> of class <code class="literal">com.arjuna.ats.arjuna.coordinator.BasicAction</code> is executed and presented in the log with the message <code class="literal">BasicAction::Rollback() for action-id &lt;transaction uid&gt;</code>.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									Transaction Timeout
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									When a transaction times out, a method <code class="literal">doCancellations</code> of <code class="literal">com.arjuna.ats.arjuna.coordinator.TransactionReaper</code> is executed and presented in log as <code class="literal">Reaper Worker &lt;thread id&gt; attempting to cancel &lt;transaction uid&gt;</code>. You will then see the same thread rolling back the transaction as shown above.
								</p>
								 </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="decoding_transaction_log_files"/>Decoding Transaction Log Files</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="locating_xid_uid_of_transaction"/>Locating the XID/UID of a Transaction</h3></div></div></div><p>
						The <code class="literal">javax.transaction.TransactionManager</code> interface provides two ways to locate the transaction identifier:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								You can call the <code class="literal">toString</code> method to print complete information about the transaction, including the identifier.
							</li><li class="listitem"><p class="simpara">
								Alternatively, you can cast the <code class="literal">javax.transaction.Transaction</code> instance to a <code class="literal">com.arjuna.ats.jta.transaction.Transaction</code> and then call either the <code class="literal">get_uid</code> method, which returns the ArjunaCore Uid representation, or call the <code class="literal">getTxId</code> method, which returns the Xid for the global identifier, that is not the branch qualifier.
							</p><pre class="programlisting">com.arjuna.ats.jta.transaction.Transaction arjunaTM = (com.arjuna.ats.jta.transaction.Transaction)tx.getTransaction();
System.out.println("Transaction UID" +arjunaTM.get_uid());</pre></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="finding_the_transaction_status_and_resources"/>Finding the Transaction Status and Resources</h3></div></div></div><h5><a id="transactionstatusconnectionmanager"/>TransactionStatusConnectionManager</h5><p>
						The <code class="literal">TransactionStatusConnectionManager</code> object is used by the recovery modules to retrieve the status of the transaction. It acts like a proxy for <code class="literal">TransactionStatusManager</code> objects by maintaining a table of <code class="literal">TransactionStatusConnector</code> objects, each of which connects to a <code class="literal">TransactionStatusManager</code> object in the application process.
					</p><p>
						You can retrieve the transaction status using the <code class="literal">getTransactionStatus</code> method that takes a transaction Uid and, if available, a transaction type as parameters.
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								The process Uid field in the transactions Uid parameter is used to lookup the target <code class="literal">TransactionStatusManagerItem</code> host-port pair in the transaction object store.
							</li><li class="listitem">
								The host-port pair is used to make a TCP connection to the target <code class="literal">TransactionStatusManager</code> object by using a <code class="literal">TransactionStatusConnector</code> object.
							</li><li class="listitem">
								The <code class="literal">TransactionStatusConnector</code> passes the transaction Uid and the transaction type to the <code class="literal">TransactionStatusManager</code> in order to retrieve the status of the transactions.
							</li></ol></div><p>
						The following code example shows how to retrieve the <code class="literal">TransactionStatusConnectionManager</code> and check the transaction status:
					</p><pre class="programlisting">// Transaction id
Uid tx = new Uid();
. . . .
TransactionStatusConnectionManager tscm = new TransactionStatusConnectionManager();

// Check if the transaction aborted
assertEquals(tscm.getTransactionStatus(tx), ActionStatus.ABORTED);</pre><h5><a id="transactionstatusmanager"/>TransactionStatusManager</h5><p>
						The <code class="literal">TransactionStatusManager</code> object acts as an interface for the Recovery Manager to obtain the status of transactions from the running application processes. One <code class="literal">TransactionStatusManager</code> per application process is created by the <code class="literal">com.arjuna.ats.arjuna.coordinator.TxControl</code> class. A TCP connection is used for communication between the Recovery Manager and <code class="literal">TransactionStatusManager</code>. Any free port is used by the <code class="literal">TransactionStatusManager</code> by default. However, the port used can be fixed using the following the property:
					</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/standalone.sh -DRecoveryEnvironmentBean.transactionStatusManagerPort=<span class="emphasis"><em>NETWORK_PORT_NUMBER</em></span></pre><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								On creation, the <code class="literal">TransactionStatusManager</code> obtains a port that is stored with the host in the object store as a <code class="literal">TransactionStatusManagerItem</code>.
							</li><li class="listitem">
								A <code class="literal">Listener</code> thread is started which waits for a connection request from the <code class="literal">TransactionStatusConnector</code>.
							</li><li class="listitem">
								When the connection is established, a <code class="literal">Connection</code> thread is created that runs the <code class="literal">AtomicActionStatusService</code> service. This service accepts a transaction Uid and a transaction type, if available, from the <code class="literal">TransactionStatusConnector</code> object.
							</li><li class="listitem">
								The transaction status is obtained from the local transaction table and returned back to the <code class="literal">TransactionStatusConnector</code> object.
							</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="viewing_the_transaction_history"/>Viewing the Transaction History</h3></div></div></div><p>
						By default, the transaction service does not maintain any history about the transactions. However, you can set the <code class="literal">CoordinatorEnvironmentBean.enableStatistics</code> property variable to <code class="literal">true</code> for the transaction service to maintain information about the number of transactions created and their respective outcomes.
					</p><p>
						You can use the following management CLI command to enable the statistics:
					</p><pre class="screen">/subsystem=transactions:write-attribute(name=enable-statistics,value=true)</pre><p>
						You can obtain more detailed transaction statistics programmatically by using the <code class="literal">com.arjuna.ats.arjuna.coordinator.TxStats</code> class.
					</p><div class="title"><strong>Example: <code class="literal">TxStats</code> Class</strong></div><p>
							
</p><pre class="programlisting">public class TxStats
{
    /**
     * @return the number of transactions (top-level and nested) created so far.
     */

    public static int numberOfTransactions();

    /**
     * @return the number of nested (sub) transactions created so far.
     *

     public static int numberOfNestedTransactions();

     /**
     * @return the number of transactions which have terminated with heuristic
     *         outcomes.
     */

    public static int numberOfHeuristics();
    /**
     * @return the number of committed transactions.
     */

    public static int numberOfCommittedTransactions();

    /**
     * @return the total number of transactions which have rolled back.
     */

    public static int numberOfAbortedTransactions();

    /**
     * @return total number of inflight (active) transactions.
     */

    public static int numberOfInflightTransactions ();

    /**
     * @return total number of transactions rolled back due to timeout.
     */

    public static int numberOfTimedOutTransactions ();
    /**
     * @return the number of transactions rolled back by the application.
     */

    public static int numberOfApplicationRollbacks ();

    /**
     * @return number of transactions rolled back by participants.
     */

    public static int numberOfResourceRollbacks ();

    /**
     * Print the current information.
     */

    public static void printStatus(java.io.PrintWriter pw);
}</pre><p>

						</p><p>
						The <code class="literal">com.arjuna.ats.arjuna.coordinator.ActionManager</code> class provides further information about specific active transactions using the <code class="literal">getNumberOfInflightTransactions</code> method that returns the list of currently active transactions.
					</p></div></div></div></div></body></html>