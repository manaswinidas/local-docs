<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 7. Migrating to Elytron</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="migrating_to_elytron"/>Chapter 7. Migrating to Elytron</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="migrate_to_elytron_overview"/>Overview of Elytron</h1></div></div></div><p>
				JBoss EAP 7.1 introduced Elytron, which provides a single unified framework that can manage and configure access for both standalone servers and managed domains. It can also be used to configure security access for applications deployed to JBoss EAP servers.
			</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
					The architectures of Elytron and the legacy security subsystem that is based on PicketBox are very different. With Elytron, an attempt was made to create a solution that allows you to operate in the same security environments in which you currently operate; however, this does <span class="emphasis"><em>not</em></span> mean that every PicketBox configuration option has an equivalent configuration option in Elytron.
				</p><p>
					If you are not able to find information in the documentation to help you achieve similar functionality using Elytron that you had when using the legacy security implementation, you can find help in one of the following ways.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							If you have a <a class="link" href="https://access.redhat.com/support/offerings/developer/">Red Hat Development subscription</a>, you have access to <a class="link" href="https://access.redhat.com/support/cases/#/case/list">Support Cases</a>, <a class="link" href="https://access.redhat.com/solutions">Solutions</a>, and <a class="link" href="https://access.redhat.com/articles">Knowledge Articles</a> on the Red Hat Customer Portal. You can also open a case with <a class="link" href="https://access.redhat.com/support">Technical Support</a> and <a class="link" href="http://wildfly.org/gethelp/">get help</a> from the WildFly community as described below.
						</li><li class="listitem">
							If you do not have a Red Hat Development subscription, you can still access <a class="link" href="https://access.redhat.com/articles">Knowledge Articles</a> on the Red Hat Customer Portal. You can also join the <a class="link" href="http://wildfly.org/gethelp/">user forums and live chat</a> to ask questions of the WildFly community. The WildFly community offerings are actively monitored by the Elytron engineering team.
						</li></ul></div></div><p>
				Your JBoss EAP 7.0 server configuration and deployments that use the legacy <code class="literal">security</code> subsystem, which is based on PicketBox, should run without changes on JBoss EAP 7.1 and later. PicketBox continues to support security domains, which allows applications to continue to use existing login modules. Security realms, which are used by the management layer for security, are also carried over and emulated by Elytron. This allows you to define authentication in both the <code class="literal">elytron</code> and legacy <code class="literal">security</code> subsystems and use them in parallel. For more information about how to configure your application to use Elytron and legacy security, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_identity_management/#configure-app-authentication">Configure Web Applications to Use Elytron or Legacy Security for Authentication</a> in <span class="emphasis"><em>How to Configure Identity Management</em></span> for JBoss EAP.
			</p><p>
				Even though PicketBox authentication continues to be supported, you are encouraged to switch to Elytron when you are ready to migrate your applications. One of the advantages for using Elytron security is that it provides a consistent security solution across the server and your applications. For information on how to migrate PicketBox authentication and authorization to use Elytron, see <a class="link" href="migrating_to_elytron.html#migrate_authentication_configuration" title="Migrate Authentication Configuration">Migrate Authentication Configuration</a> in this guide.
			</p><p>
				For an overview of the new resources that are available in the <code class="literal">elytron</code> subsystem, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/security_architecture/#resources_in_the_elytron_subsystem">Resources in the Elytron Subsystem</a> in the JBoss EAP <span class="emphasis"><em>Security Architecture</em></span> guide.
			</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
					Be aware that if you do choose to use both the legacy <code class="literal">security</code> subsystem and Elytron in your deployments, invocations between deployments using different security architectures is not supported.
				</p><p>
					For more information about using these subsystems in parallel, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_identity_management/#using_elytron_and_legacy_security_subsystems_in_parallel">Using Elytron and Legacy Security Subsystems in Parallel</a> in <span class="emphasis"><em>How to Configure Identity Management</em></span> for JBoss EAP.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="migrate_secure_vaults_and_properties"/>Migrate Secure Vaults and Properties</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_vaults_to_secure_credential_storage"/>Migrate Vaults to Secure Credential Storage</h2></div></div></div><p>
					The vault that was used to store plain text string encryption in the legacy <code class="literal">security</code> subsystem in JBoss EAP 7.0 is not compatible with Elytron in JBoss EAP 7.1 or later, which uses a newly designed credential store to store strings. Credential stores safely encrypt credentials in a storage file outside of the JBoss EAP configuration files. You can use the implementation provided by Elytron or you can customize the configuration using the credential store APIs and SPIs. Each JBoss EAP server can contain multiple credential stores.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						If you previously used vault expressions to parameterize nonsensitive data, it is recommended that you replace the data with <a class="link" href="migrating_to_elytron.html#migrate_security_properties_to_elytron" title="Migrate Security Properties to Elytron">Elytron security properties</a>.
					</p></div><p>
					If you continue to use the legacy <code class="literal">security</code> subsystem, you should not need to modify or update your vault data. However, if you plan to migrate your application to use Elytron, you must convert your existing vaults to credential stores so that they can be processed by the <code class="literal">elytron</code> subsystem. For more information about credential stores, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_server_security/#credential_store">Credential Stores</a> in <span class="emphasis"><em>How to Configure Server Security</em></span> for JBoss EAP.
				</p><h4><a id="migrating_vault_data_using_the_elytron_tool"/>Migrating Vault Data Using the WildFly Elytron Tool</h4><p>
					The WildFly Elytron Tool that ships with JBoss EAP provides a <code class="literal">vault</code> command to help you migrate vault content to credential stores. You execute the tool by running the <code class="literal">elytron-tool</code> script, which is located in the <code class="literal"><span class="emphasis"><em>EAP_HOME</em></span>/bin</code> directory.
				</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/elytron-tool.sh vault <span class="emphasis"><em>VAULT_ARGUMENTS</em></span></pre><p>
					If you prefer, you can execute the tool by running the <code class="literal">java -jar</code> command.
				</p><pre class="screen">$ java -jar <span class="emphasis"><em>EAP_HOME</em></span>/bin/wildfly-elytron-tool.jar vault <span class="emphasis"><em>VAULT_ARGUMENTS</em></span></pre><p>
					You can use the following command to get a description of all of the available arguments.
				</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/elytron-tool.sh vault --help</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								The WildFly Elytron Tool cannot handle the first version of the security vault data files.
							</li><li class="listitem">
								You can enter the <code class="literal">--keystore-password</code> argument in masked format, as shown in the below example to migrate a single vault, or in clear text.
							</li><li class="listitem">
								The <code class="literal">--salt</code> and <code class="literal">--iteration</code> arguments are provided to supply information to decrypt the masked password or to generate a masked password in the output. If the <code class="literal">--salt</code> and <code class="literal">--iteration</code> arguments are omitted, default values are used.
							</li><li class="listitem">
								The <code class="literal">--summary</code> argument produces formatted management CLI commands that can be used to add the converted credential stores to the JBoss EAP configuration. Plain text passwords are masked in the summary output.
							</li></ul></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						Be aware that credential stores can only be used for securing passwords. They do not support the vault expression feature that could be used anywhere in the management model.
					</p></div><p>
					Choose one of the following migration options:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<a class="link" href="migrating_to_elytron.html#migrate_single_vault_to_secure_credential_storage" title="Migrate a Single Security Vault to a Credential Store">Migrate a Single Security Vault to a Credential Store</a>
						</li><li class="listitem">
							<a class="link" href="migrating_to_elytron.html#migrate_multiple_vault_to_secure_credential_storage_in_bulk" title="Migrate Multiple Security Vaults to a Credential Store in Bulk">Migrate Multiple Security Vaults to a Credential Store in Bulk</a>
						</li></ul></div><h5><a id="migrate_single_vault_to_secure_credential_storage"/>Migrate a Single Security Vault to a Credential Store</h5><p>
					The following is an example of the command used to convert a single security vault to a credential store.
				</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/elytron-tool.sh vault --enc-dir vault_data/ --keystore vault-jceks.keystore --keystore-password MASK-2hKo56F1a3jYGnJwhPmiF5 --iteration 34 --salt 12345678 --alias test --location cs-v1.store --summary</pre><p>
					This command converts the security vault to a credential store and prints the summary of the management CLI commands that were used to convert it in the output.
				</p><pre class="screen">Vault (enc-dir="vault_data/";keystore="vault-jceks.keystore") converted to credential store "cs-v1.store"
Vault Conversion summary:
--------------------------------------
Vault Conversion Successful
CLI command to add new credential store:
/subsystem=elytron/credential-store=test:add(relative-to=jboss.server.data.dir,create=true,modifiable=true,location="cs-v1.store",implementation-properties={"keyStoreType"=&gt;"JCEKS"},credential-reference={clear-text="MASK-2hKo56F1a3jYGnJwhPmiF5;12345678;34"})</pre><h5><a id="migrate_multiple_vault_to_secure_credential_storage_in_bulk"/>Migrate Multiple Security Vaults to a Credential Store in Bulk</h5><p>
					You can convert multiple vaults to a credential store using the <code class="literal">--bulk-convert</code> argument and pointing to a bulk conversion descriptor file.
				</p><p>
					The examples in this section use the following bulk conversion descriptor file.
				</p><div class="title"><strong>Example: <code class="literal">bulk-vault-conversion-descriptor.txt</code> File</strong></div><p>
						
</p><pre class="screen">keystore:vault-v1/vault-jceks.keystore
keystore-password:MASK-2hKo56F1a3jYGnJwhPmiF5
enc-dir:vault-v1/vault_data/
salt:12345678
iteration:34
location:v1-cs-1.store
alias:test

keystore:vault-v1/vault-jceks.keystore
keystore-password:secretsecret
enc-dir:vault-v1/vault_data/
location:v1-cs-2.store
alias:test

# different vault vault-v1-more
keystore:vault-v1-more/vault-jceks.keystore
keystore-password:MASK-2hKo56F1a3jYGnJwhPmiF5
enc-dir:vault-v1-more/vault_data/
salt:12345678
iteration:34
location:v1-cs-more.store
alias:test</pre><p>

					</p><p>
					A new conversion starts when each new <code class="literal">keystore:</code> line is encountered. All options are mandatory except for <code class="literal">salt</code>, <code class="literal">iteration</code>, and <code class="literal">properties</code>.
				</p><p>
					To perform the bulk conversion and generate output that formats the management CLI commands, execute the following command.
				</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/elytron-tool.sh vault --bulk-convert <span class="emphasis"><em>path/to/</em></span>bulk-vault-conversion-descriptor.txt --summary</pre><p>
					This command converts all of the security vaults specified in the file to a credential store and prints the summary of the management CLI commands that were used to convert them in the output.
				</p><pre class="screen">Vault (enc-dir="vault-v1/vault_data/";keystore="vault-v1/vault-jceks.keystore") converted to credential store "v1-cs-1.store"
Vault Conversion summary:
--------------------------------------
Vault Conversion Successful
CLI command to add new credential store:
/subsystem=elytron/credential-store=test:add(relative-to=jboss.server.data.dir,create=true,modifiable=true,location="v1-cs-1.store",implementation-properties={"keyStoreType"=&gt;"JCEKS"},credential-reference={clear-text="MASK-2hKo56F1a3jYGnJwhPmiF5;12345678;34"})
--------------------------------------

Vault (enc-dir="vault-v1/vault_data/";keystore="vault-v1/vault-jceks.keystore") converted to credential store "v1-cs-2.store"
Vault Conversion summary:
--------------------------------------
Vault Conversion Successful
CLI command to add new credential store:
/subsystem=elytron/credential-store=test:add(relative-to=jboss.server.data.dir,create=true,modifiable=true,location="v1-cs-2.store",implementation-properties={"keyStoreType"=&gt;"JCEKS"},credential-reference={clear-text="secretsecret"})
--------------------------------------

Vault (enc-dir="vault-v1-more/vault_data/";keystore="vault-v1-more/vault-jceks.keystore") converted to credential store "v1-cs-more.store"
Vault Conversion summary:
--------------------------------------
Vault Conversion Successful
CLI command to add new credential store:
/subsystem=elytron/credential-store=test:add(relative-to=jboss.server.data.dir,create=true,modifiable=true,location="v1-cs-more.store",implementation-properties={"keyStoreType"=&gt;"JCEKS"},credential-reference={clear-text="MASK-2hKo56F1a3jYGnJwhPmiF5;12345678;34"})
--------------------------------------</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_security_properties_to_elytron"/>Migrate Security Properties to Elytron</h2></div></div></div><p>
					The examples in this section assume that the <code class="literal">group.name</code> and <code class="literal">encoding.algorithm</code> security properties are defined as <code class="literal">security-properties</code> in the legacy <code class="literal">security</code> subsystem as follows.
				</p><div class="title"><strong>Example: Security Properties Defined in the <code class="literal">security</code> Subsystem</strong></div><p>
						
</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
    ...
    &lt;security-properties&gt;
        &lt;property name="group.name" value="engineering-group" /&gt;
        &lt;property name="encoding.algorithm" value="BASE64" /&gt;
    &lt;/security-properties&gt;
&lt;/subsystem&gt;</pre><p>

					</p><p>
					To define the same security properties in the <code class="literal">elytron</code> subsystem, set the <code class="literal">security-properties</code> attribute of the <code class="literal">elytron</code> subsystem using the following management CLI command.
				</p><pre class="screen">/subsystem=elytron:write-attribute(name=security-properties, value={ group.name = "engineering-group", encoding.algorithm = "BASE64" })</pre><p>
					This configures the following <code class="literal">security-properties</code> in the <code class="literal">elytron</code> subsystem in the server configuration file.
				</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    &lt;security-properties&gt;
        &lt;security-property name="group.name" value="engineering-group"/&gt;
        &lt;security-property name="encoding.algorithm" value="BASE64"/&gt;
    &lt;/security-properties&gt;
    ...
&lt;/subsystem&gt;</pre><p>
					The <code class="literal">write-attribute</code> operation used in the previous command overwrites the existing properties. To add or change a security property without impacting other security properties, use the <code class="literal">map</code> operation in the management CLI command.
				</p><pre class="screen">/subsystem=elytron:map-put(name=security-properties, key=group.name, value=technical-support)</pre><p>
					In a similar manner, you can remove a specific security property by using the <code class="literal">map-remove</code> operation.
				</p><pre class="screen">/subsystem=elytron:map-remove(name=security-properties, key=group.name)</pre></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="migrate_authentication_configuration"/>Migrate Authentication Configuration</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_properties_based_authentication_and_authorization"/>Migrate Properties-based Authentication and Authorization to Elytron</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="migrate_picketbox_properties_based_configuration"/>Migrate PicketBox Properties-based Configuration to Elytron</h3></div></div></div><p>
						This section describes how to migrate PicketBox properties-based authentication to Elytron. You can choose to <a class="link" href="migrating_to_elytron.html#partially_migrate_by_exposing_picketbox_security_domain_to_elytron" title="Partially Migrate by Exposing the PicketBox Security Domain to Elytron">partially migrate</a> properties-based authentication by only exposing the PicketBox security domain to Elytron or you can <a class="link" href="migrating_to_elytron.html#fully_migrate_properties_based_authentication_to_elytron" title="Fully Migrate Properties-based Authentication to Elytron">fully migrate</a> the properties-based authentication configurations to use Elytron.
					</p><p>
						The following procedures assume that the deployed web application you plan to migrate is configured to require form-based authentication. The application is referencing a PicketBox security domain and is using the <code class="literal">UsersRolesLoginModule</code> to load user information from the <code class="literal">example-users.properties</code> and <code class="literal">example-roles.properties</code> files. These examples also assume that the security domain is defined in the legacy <code class="literal">security</code> subsystem using the following management CLI commands.
					</p><div class="title"><strong>Example: PicketBox Properties-based Configuration Commands</strong></div><p>
							
</p><pre class="screen">/subsystem=security/security-domain=application-security:add
/subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=UsersRoles, flag=Required, module-options={usersProperties=file://${jboss.server.config.dir}/example-users.properties, rolesProperties=file://${jboss.server.config.dir}/example-roles.properties}}])</pre><p>

						</p><p>
						This results in the following server configuration.
					</p><div class="title"><strong>Example: PicketBox Properties-based Security Domain Configuration</strong></div><p>
							
</p><pre class="programlisting">&lt;security-domain name="application-security"&gt;
  &lt;authentication&gt;
    &lt;login-module code="UsersRoles" flag="required"&gt;
      &lt;module-option name="usersProperties" value="file://${jboss.server.config.dir}/example-users.properties"/&gt;
      &lt;module-option name="rolesProperties" value="file://${jboss.server.config.dir}/example-roles.properties"/&gt;
    &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</pre><p>

						</p><p>
						Choose one of the following migration options:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								<a class="link" href="migrating_to_elytron.html#partially_migrate_by_exposing_picketbox_security_domain_to_elytron" title="Partially Migrate by Exposing the PicketBox Security Domain to Elytron">Partially Migrate by Exposing the PicketBox Security Domain to Elytron</a>.
							</li><li class="listitem">
								<a class="link" href="migrating_to_elytron.html#fully_migrate_properties_based_authentication_to_elytron" title="Fully Migrate Properties-based Authentication to Elytron">Fully Migrate Properties-based Authentication to Elytron</a>
							</li></ul></div><h4><a id="partially_migrate_by_exposing_picketbox_security_domain_to_elytron"/>Partially Migrate by Exposing the PicketBox Security Domain to Elytron</h4><p>
						You can expose a PicketBox security domain as an Elytron security realm so that it can be wired into an Elytron configuration; however, doing so creates a dependency on the legacy <code class="literal">security</code> subsystem. If you are only migrating properties-based authentication, it is recommended that you <a class="link" href="migrating_to_elytron.html#fully_migrate_properties_based_authentication_to_elytron" title="Fully Migrate Properties-based Authentication to Elytron">fully migrate the application to Elytron</a> to avoid the unnecessary dependency on the legacy <code class="literal">security</code> subsystem. However, a partial migration can be an intermediate solution when it is not possible to fully migrate the application to use Elytron.
					</p><p>
						Follow this procedure to add an existing PicketBox security realm configuration as an Elytron security realm.
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Add a mapping to the Elytron security realm within the legacy <code class="literal">security</code> subsystem.
							</p><pre class="screen">/subsystem=security/elytron-realm=application-security:add(legacy-jaas-config=application-security)</pre><p class="simpara">
								This configures the following Elytron security realm in the <code class="literal">security</code> subsystem of the server configuration file.
							</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
  ...
  &lt;elytron-integration&gt;
    &lt;security-realms&gt;
      &lt;elytron-realm name="application-security" legacy-jaas-config="application-security"/&gt;
    &lt;/security-realms&gt;
  &lt;/elytron-integration&gt;
  ...
&lt;/subsystem&gt;</pre></li><li class="listitem"><p class="simpara">
								Define a security domain in the <code class="literal">elytron</code> subsystem that references the exported security realm.
							</p><pre class="screen">/subsystem=elytron/security-domain=application-security:add(realms=[{realm=application-security}], default-realm=application-security, permission-mapper=default-permission-mapper)</pre><p class="simpara">
								This results in the following <code class="literal">elytron</code> subsystem configuration in the server configuration file.
							</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" default-realm="application-security" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="application-security"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  ...
&lt;/subsystem&gt;</pre></li><li class="listitem"><p class="simpara">
								In the <code class="literal">undertow</code> subsystem, map the application security domain referenced by the deployment to the newly defined security domain.
							</p><pre class="screen">/subsystem=undertow/application-security-domain=application-security:add(security-domain=application-security)</pre><p class="simpara">
								This results in the following <code class="literal">undertow</code> subsystem configuration in the server configuration file.
							</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0"&gt;
  ...
  &lt;application-security-domains&gt;
    &lt;application-security-domain name="application-security" security-domain="application-security"/&gt;
  &lt;/application-security-domains&gt;
  ...
&lt;/subsystem&gt;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
									If the application was already deployed prior to this configuration, you must reload the server or redeploy the application for the new application security domain mapping to take effect.
								</p></div></li><li class="listitem"><p class="simpara">
								Verify the mapping was applied to the deployment using the following management CLI command. The deployment used in this example is <code class="literal">HelloWorld.war</code>. The output from the this command shows this deployment is referencing the Elytron mapping.
							</p><pre class="screen">/subsystem=undertow/application-security-domain=application-security:read-resource(include-runtime=true)

{
"outcome" =&gt; "success",
    "result" =&gt; {
        "enable-jacc" =&gt; false,
        "http-authentication-factory" =&gt; undefined,
        "override-deployment-config" =&gt; false,
        "referencing-deployments" =&gt; ["HelloWorld.war"],
        "security-domain" =&gt; "application-security",
        "setting" =&gt; undefined
    }
}</pre></li></ol></div><p>
						At this stage, the previously defined security domain is used for its <code class="literal">LoginModule</code> configuration, but it is wrapped by Elytron components, which take over authentication.
					</p><h4><a id="fully_migrate_properties_based_authentication_to_elytron"/>Fully Migrate Properties-based Authentication to Elytron</h4><p>
						Follow these steps to fully migrate the PicketBox properties-based authentication to Elytron. This procedure assumes you are starting with the legacy configuration described in the introduction to this section and have <span class="emphasis"><em>not</em></span> migrated to the <a class="link" href="migrating_to_elytron.html#partially_migrate_by_exposing_picketbox_security_domain_to_elytron" title="Partially Migrate by Exposing the PicketBox Security Domain to Elytron">partially migrated</a> solution. When you have complete this process, any security domain definition that exists in the legacy <code class="literal">security</code> subsystem remains completely independent from the Elytron configuration.
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Define a new security realm in the <code class="literal">elytron</code> subsystem that references the PicketBox properties files.
							</p><pre class="screen">/subsystem=elytron/properties-realm=application-properties:add(users-properties={path=example-users.properties, relative-to=jboss.server.config.dir, plain-text=true, digest-realm-name="Application Security"}, groups-properties={path=example-roles.properties, relative-to=jboss.server.config.dir}, groups-attribute=Roles)</pre></li><li class="listitem"><p class="simpara">
								Define a security domain subsystem in the <code class="literal">elytron</code> subsystem.
							</p><pre class="screen">/subsystem=elytron/security-domain=application-security:add(realms=[{realm=application-properties}], default-realm=application-properties, permission-mapper=default-permission-mapper)</pre><p class="simpara">
								This results in the following <code class="literal">elytron</code> subsystem configuration in the server configuration file.
							</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" default-realm="application-properties" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="application-properties"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  &lt;security-realms&gt;
    ...
    &lt;properties-realm name="application-properties" groups-attribute="Roles"&gt;
      &lt;users-properties path="example-users.properties" relative-to="jboss.server.config.dir" digest-realm-name="Application Security" plain-text="true"/&gt;
      &lt;groups-properties path="example-roles.properties" relative-to="jboss.server.config.dir"/&gt;
    &lt;/properties-realm&gt;
  &lt;/security-realms&gt;
  ...
&lt;/subsystem&gt;</pre></li><li class="listitem"><p class="simpara">
								Map the application security domain referenced by the deployment to the newly defined HTTP authentication factory in the <code class="literal">undertow</code> subsystem.
							</p><pre class="screen">/subsystem=undertow/application-security-domain=application-security:add(security-domain=application-security)</pre><p class="simpara">
								This results in the following <code class="literal">undertow</code> subsystem configuration in the server configuration file.
							</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:undertow:7.0"&gt;
  ...
  &lt;application-security-domains&gt;
    &lt;application-security-domain name="application-security" security-domain="application-security"/&gt;
  &lt;/application-security-domains&gt;
  ...
&lt;/subsystem&gt;</pre></li><li class="listitem">
								You must reload the server or redeploy the application for the new application security domain mapping to take effect.
							</li></ol></div><p>
						Authentication is now configured to be equivalent to the PicketBox configuration; however Elytron components are now used exclusively for authentication.
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="migrate_legacy_properties_based_configuration"/>Migrate Legacy Properties-based Configuration to Elytron</h3></div></div></div><p>
						This section describes how to migrate a legacy security realm that loads user, password, and group information from properties files to Elytron. This type of legacy security realm is typically used to secure either the management interfaces or remoting connectors.
					</p><p>
						These examples assume that the legacy security domain is defined using the following management CLI commands.
					</p><div class="title"><strong>Example: Legacy Security Realm Commands</strong></div><p>
							
</p><pre class="screen">/core-service=management/security-realm=ApplicationSecurity:add
/core-service=management/security-realm=ApplicationSecurity/authentication=properties:add(relative-to=jboss.server.config.dir, path=example-users.properties, plain-text=true)
/core-service=management/security-realm=ApplicationSecurity/authorization=properties:add(relative-to=jboss.server.config.dir, path=example-roles.properties)</pre><p>

						</p><p>
						This results in the following server configuration.
					</p><div class="title"><strong>Example: Legacy Security Realm Configuration</strong></div><p>
							
</p><pre class="programlisting">&lt;security-realm name="ApplicationSecurity"&gt;
  &lt;authentication&gt;
    &lt;properties path="example-users.properties" relative-to="jboss.server.config.dir" plain-text="true"/&gt;
  &lt;/authentication&gt;
  &lt;authorization&gt;
    &lt;properties path="example-roles.properties" relative-to="jboss.server.config.dir"/&gt;
  &lt;/authorization&gt;
&lt;/security-realm&gt;</pre><p>

						</p><p>
						One of the motivations for adding the Elytron security to the application server is to allow a consistent security solution to be used across the server. The initial steps to migrate a properties-based legacy security realm to Elytron are similar to those used to migrate a PicketBox properties-based authentication to Elytron. Follow these steps to migrate a properties-based legacy security realm to Elytron.
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Define a new security realm in the <code class="literal">elytron</code> subsystem that references the properties files.
							</p><pre class="screen">/subsystem=elytron/properties-realm=application-properties:add(users-properties={path=example-users.properties, relative-to=jboss.server.config.dir, plain-text=true, digest-realm-name="Application Security"}, groups-properties={path=example-roles.properties, relative-to=jboss.server.config.dir}, groups-attribute=Roles)</pre></li><li class="listitem"><p class="simpara">
								Define a security domain subsystem in the <code class="literal">elytron</code> subsystem.
							</p><pre class="screen">/subsystem=elytron/security-domain=application-security:add(realms=[{realm=application-properties}], default-realm=application-properties, permission-mapper=default-permission-mapper)</pre><p class="simpara">
								This results in the following Elytron configuration.
							</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" default-realm="application-properties" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="application-properties"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  &lt;security-realms&gt;
    ...
    &lt;properties-realm name="application-properties" groups-attribute="Roles"&gt;
      &lt;users-properties path="example-users.properties" relative-to="jboss.server.config.dir" digest-realm-name="Application Security" plain-text="true"/&gt;
      &lt;groups-properties path="example-roles.properties" relative-to="jboss.server.config.dir"/&gt;
    &lt;/properties-realm&gt;
  &lt;/security-realms&gt;
    ...
&lt;/subsystem&gt;</pre></li><li class="listitem"><p class="simpara">
								Define a <code class="literal">sasl-authentication-factory</code> so that the legacy security realm can also be used for Simple Authentication Security Layer (SASL) authentication.
							</p><pre class="screen">/subsystem=elytron/sasl-authentication-factory=application-security-sasl:add(sasl-server-factory=elytron, security-domain=application-security, mechanism-configurations=[{mechanism-name=PLAIN}])</pre><p class="simpara">
								This results in the following Elytron configuration.
							</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;sasl&gt;
    ...
    &lt;sasl-authentication-factory name="application-security-sasl" sasl-server-factory="elytron" security-domain="application-security"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="PLAIN"/&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/sasl-authentication-factory&gt;
    ...
  &lt;/sasl&gt;
&lt;/subsystem&gt;</pre></li><li class="listitem"><p class="simpara">
								Configure a remoting connector for the SASL authentication and remove the association with the legacy security realm.
							</p><pre class="screen">/subsystem=remoting/http-connector=http-remoting-connector:write-attribute(name=sasl-authentication-factory, value=application-security-sasl)
/subsystem=remoting/http-connector=http-remoting-connector:undefine-attribute(name=security-realm)</pre><p class="simpara">
								This results in the following configuration in the <code class="literal">remoting</code> subsystem of the server configuration file.
							</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:remoting:4.0"&gt;
  ...
  &lt;http-connector name="http-remoting-connector" connector-ref="default" sasl-authentication-factory="application-security-sasl"/&gt;
&lt;/subsystem&gt;</pre></li><li class="listitem"><p class="simpara">
								Add the two authentication factories and remove the legacy security realm references to secure the <code class="literal">http-interface</code> with Elytron.
							</p><pre class="screen">/core-service=management/management-interface=http-interface:write-attribute(name=http-authentication-factory, value=application-security-http)
/core-service=management/management-interface=http-interface:write-attribute(name=http-upgrade.sasl-authentication-factory, value=application-security-sasl)
/core-service=management/management-interface=http-interface:undefine-attribute(name=security-realm)</pre><p class="simpara">
								This results in the following configuration.
							</p><pre class="programlisting">&lt;management-interfaces&gt;
  &lt;http-interface http-authentication-factory="application-security-http"&gt;
    &lt;http-upgrade enabled="true" sasl-authentication-factory="application-security-sasl"/&gt;
    &lt;socket-binding http="management-http"/&gt;
  &lt;/http-interface&gt;
&lt;/management-interfaces&gt;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
									You should choose more suitable names than those used in these examples when securing management interfaces.
								</p></div></li></ol></div><p>
						The migration of the legacy properties-based configuration to Elytron is now complete.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_ldap_authentication_configuration_to_elytron"/>Migrate LDAP Authentication Configuration to Elytron</h2></div></div></div><p>
					This section describes how to migrate legacy LDAP authentication to Elytron so that it can manage the information as identity attributes. Much of the information provided in the section entitled <a class="link" href="migrating_to_elytron.html#migrate_properties_based_authentication_and_authorization" title="Migrate Properties-based Authentication and Authorization to Elytron">Migrate Properties-based Authentication and Authorization to Elytron</a> applies here, particularly regarding how to define security domains and authentication factories, and how to map them to be used for authentication. This section does not repeat those instructions, so be sure to read through that section before you continue.
				</p><p>
					The following examples assume that group or role information is loaded directly from LDAP and that the legacy LDAP authentication is configured as follows.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
							The LDAP server contains the following user and group entries.
						</p><div class="title"><strong>Example: LDAP Server User Entries</strong></div><p>
								
</p><pre class="screen">dn: uid=TestUserOne,ou=users,dc=group-to-principal,dc=wildfly,dc=org
objectClass: top
objectClass: inetOrgPerson
objectClass: uidObject
objectClass: person
objectClass: organizationalPerson
cn: Test User One
sn: Test User One
uid: TestUserOne
userPassword: {SSHA}UG8ov2rnrnBKakcARVvraZHqTa7mFWJZlWt2HA==</pre><p>

							</p><div class="title"><strong>Example: LDAP Server Group Entries</strong></div><p>
								
</p><pre class="screen">dn: uid=GroupOne,ou=groups,dc=group-to-principal,dc=wildfly,dc=org
objectClass: top
objectClass: groupOfUniqueNames
objectClass: uidObject
cn: Group One
uid: GroupOne
uniqueMember: uid=TestUserOne,ou=users,dc=group-to-principal,dc=wildfly,dc=org</pre><p>

							</p><p class="simpara">
							For authentication purposes the user name is matched against the <code class="literal">uid</code> attribute and the resulting group name is taken from the <code class="literal">uid</code> attribute of the group entry.
						</p></li><li class="listitem"><p class="simpara">
							The connection to the LDAP server and related security realm is defined using the following management CLI commands.
						</p><p><a id="ldap_security_realm_configuration_commands"/></p><div class="title"><strong>Example: LDAP Security Realm Configuration Commands</strong></div><p>
								
</p><pre class="screen">batch
/core-service=management/ldap-connection=MyLdapConnection:add(url="ldap://localhost:10389", search-dn="uid=admin,ou=system", search-credential="secret")

/core-service=management/security-realm=LDAPRealm:add
/core-service=management/security-realm=LDAPRealm/authentication=ldap:add(connection="MyLdapConnection", username-attribute=uid, base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org")

/core-service=management/security-realm=LDAPRealm/authorization=ldap:add(connection=MyLdapConnection)
/core-service=management/security-realm=LDAPRealm/authorization=ldap/username-to-dn=username-filter:add(attribute=uid, base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org")
/core-service=management/security-realm=LDAPRealm/authorization=ldap/group-search=group-to-principal:add(base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org", iterative=true, prefer-original-connection=true, principal-attribute=uniqueMember, search-by=DISTINGUISHED_NAME, group-name=SIMPLE, group-name-attribute=uid)
run-batch</pre><p>

							</p><p class="simpara">
							This results in the following server configuration.
						</p><div class="title"><strong>Example: LDAP Security Realm Configuration</strong></div><p>
								
</p><pre class="programlisting">&lt;management&gt;
  &lt;security-realms&gt;
    ...
    &lt;security-realm name="LDAPRealm"&gt;
      &lt;authentication&gt;
        &lt;ldap connection="MyLdapConnection" base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
          &lt;username-filter attribute="uid"/&gt;
        &lt;/ldap&gt;
      &lt;/authentication&gt;
      &lt;authorization&gt;
        &lt;ldap connection="MyLdapConnection"&gt;
          &lt;username-to-dn&gt;
            &lt;username-filter base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org" attribute="uid"/&gt;
          &lt;/username-to-dn&gt;
          &lt;group-search group-name="SIMPLE" iterative="true" group-name-attribute="uid"&gt;
            &lt;group-to-principal search-by="DISTINGUISHED_NAME" base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org" prefer-original-connection="true"&gt;
              &lt;membership-filter principal-attribute="uniqueMember"/&gt;
            &lt;/group-to-principal&gt;
          &lt;/group-search&gt;
        &lt;/ldap&gt;
      &lt;/authorization&gt;
    &lt;/security-realm&gt;
  &lt;/security-realms&gt;
  &lt;outbound-connections&gt;
    &lt;ldap name="MyLdapConnection" url="ldap://localhost:10389" search-dn="uid=admin,ou=system" search-credential="secret"/&gt;
  &lt;/outbound-connections&gt;
  ...
&lt;/management&gt;</pre><p>

							</p></li><li class="listitem"><p class="simpara">
							The following management CLI commands are used to configure a PicketBox security domain, which uses the <code class="literal">LdapExtLoginModule</code> to verify a user name and password.
						</p><p><a id="security_domain_configuration_commmands"/></p><div class="title"><strong>Example: Security Domain Configuration Commands</strong></div><p>
								
</p><pre class="screen">/subsystem=security/security-domain=application-security:add
/subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=LdapExtended, flag=Required, module-options={ java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory, java.naming.provider.url=ldap://localhost:10389, java.naming.security.authentication=simple, bindDN="uid=admin,ou=system", bindCredential=secret, baseCtxDN="ou=users,dc=group-to-principal,dc=wildfly,dc=org", baseFilter="(uid={0})", rolesCtxDN="ou=groups,dc=group-to-principal,dc=wildfly,dc=org", roleFilter="(uniqueMember={1})", roleAttributeID="uid" }}])</pre><p>

							</p><p class="simpara">
							This results in the following server configuration.
						</p><div class="title"><strong>Example: Security Domain Configuration</strong></div><p>
								
</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security"&gt;
      &lt;authentication&gt;
        &lt;login-module code="LdapExtended" flag="required"&gt;
          &lt;module-option name="java.naming.factory.initial" value="com.sun.jndi.ldap.LdapCtxFactory"/&gt;
          &lt;module-option name="java.naming.provider.url" value="ldap://localhost:10389"/&gt;
          &lt;module-option name="java.naming.security.authentication" value="simple"/&gt;
          &lt;module-option name="bindDN" value="uid=admin,ou=system"/&gt;
          &lt;module-option name="bindCredential" value="secret"/&gt;
          &lt;module-option name="baseCtxDN" value="ou=users,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;module-option name="baseFilter" value="(uid={0})"/&gt;
          &lt;module-option name="rolesCtxDN" value="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;module-option name="roleFilter" value="(uniqueMember={1})"/&gt;
          &lt;module-option name="roleAttributeID" value="uid"/&gt;
        &lt;/login-module&gt;
      &lt;/authentication&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
&lt;/subsystem&gt;</pre><p>

							</p></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="migrate_legacy_ldap_authentication_to_elytron"/>Migrate the Legacy LDAP Authentication to Elytron</h3></div></div></div><p>
						Follow these steps to migrate the previous LDAP authentication example configuration to Elytron. This section applies to the migration of a <a class="link" href="migrating_to_elytron.html#ldap_security_realm_configuration_commands" title="Example: LDAP Security Realm Configuration Commands">legacy security LDAP realm</a> as well as a <a class="link" href="migrating_to_elytron.html#security_domain_configuration_commmands" title="Example: Security Domain Configuration Commands">PicketBox LDAP security domain</a>.
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Define a connection to LDAP in the <code class="literal">elytron</code> subsystem.
							</p><pre class="screen">/subsystem=elytron/dir-context=ldap-connection:add(url=ldap://localhost:10389, principal="uid=admin, ou=system", credential-reference={clear-text=secret})</pre></li><li class="listitem"><p class="simpara">
								Create a security realm to search LDAP and verify the supplied password.
							</p><pre class="screen">/subsystem=elytron/ldap-realm=ldap-realm:add(dir-context=ldap-connection, direct-verification=true, identity-mapping={search-base-dn="ou=users, dc=group-to-principal, dc=wildfly, dc=org", rdn-identifier="uid", attribute-mapping=[{filter-base-dn="ou=groups, dc=group-to-principal, dc=wildfly, dc=org", filter="(uniqueMember={1})", from="uid", to="Roles"}]})</pre></li></ol></div><p>
						These steps result in the following <code class="literal">elytron</code> subsystem configuration in the server configuration file.
					</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-realms&gt;
    ...
    &lt;ldap-realm name="ldap-realm" dir-context="ldap-connection" direct-verification="true"&gt;
      &lt;identity-mapping rdn-identifier="uid" search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
        &lt;attribute-mapping&gt;
          &lt;attribute from="uid" to="Roles" filter="(uniqueMember={1})" filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
        &lt;/attribute-mapping&gt;
      &lt;/identity-mapping&gt;
    &lt;/ldap-realm&gt;
  &lt;/security-realms&gt;
  ...
  &lt;dir-contexts&gt;
    &lt;dir-context name="ldap-connection" url="ldap://localhost:10389" principal="uid=admin,ou=system"&gt;
      &lt;credential-reference clear-text="secret"/&gt;
    &lt;/dir-context&gt;
  &lt;/dir-contexts&gt;
&lt;/subsystem&gt;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							By default, if no <code class="literal">role-decoder</code> is defined for a given <code class="literal">security-domain</code>, the "Roles" identity attribute is mapped to the identity roles.
						</p></div><p>
						Information loaded from LDAP can now be associated with identities as attributes. These attributes can be mapped to roles, but they can also be loaded and used for other purposes. The newly created security realm can be used in a security domain in the same way as it is described in the <a class="link" href="migrating_to_elytron.html#migrate_properties_based_authentication_and_authorization" title="Migrate Properties-based Authentication and Authorization to Elytron">Migrate Properties-based Authentication and Authorization to Elytron</a> section of this guide.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_database_authentication_configuration_to_elytron"/>Migrate Database Authentication Configuration to Elytron</h2></div></div></div><p>
					This section describes how to migrate JDBC datasource-based PicketBox authentication to Elytron. Much of the information provided in the section entitled <a class="link" href="migrating_to_elytron.html#migrate_properties_based_authentication_and_authorization" title="Migrate Properties-based Authentication and Authorization to Elytron">Migrate Properties-based Authentication and Authorization to Elytron</a> applies here, particularly regarding how to define security domains and authentication factories, and how to map them to be used for authentication. This section does not repeat those instructions, so be sure to read through that section before you continue.
				</p><p>
					The following examples assume that the user authentication data is stored in a database table created using syntax similar to the following example.
				</p><div class="title"><strong>Example: Syntax to Create the Database User Table</strong></div><p>
						
</p><pre class="screen">CREATE TABLE User (
    id BIGINT NOT NULL,
    username VARCHAR(255),
    password VARCHAR(255),
    role ENUM('admin', 'manager', 'user'),
    PRIMARY KEY (id),
    UNIQUE (username)
)</pre><p>

					</p><p>
					For authentication purposes the username is matched against data stored in the <code class="literal">username</code> column, the password is expected to be stored as a hex-encoded MD5 hash in the <code class="literal">password</code> column, and the user role for authorization purposes is stored in the <code class="literal">role</code> column.
				</p><p>
					The PicketBox security domain is configured to use a JBDC datasource to retrieve data from the database table, and then use it to verify the username and password, and to assign roles. Assume the PicketBox security domain is configured using the following management CLI commands.
				</p><div class="title"><strong>Example: PicketBox Database LoginModule Configuration Commands</strong></div><p>
						
</p><pre class="screen">/subsystem=security/security-domain=application-security:add
/subsystem=security/security-domain=application-security/authentication=classic:add( login-modules=[ { code=Database, flag=Required, module-options={ dsJndiName="java:jboss/datasources/ExampleDS", principalsQuery="SELECT password FROM User WHERE username = ?", rolesQuery="SELECT role, 'Roles' FROM User WHERE username = ?", hashAlgorithm=MD5, hashEncoding=base64 } } ] )</pre><p>

					</p><p>
					This results in the following <code class="literal">login-module</code> configuration in the legacy <code class="literal">security</code> subsystem.
				</p><div class="title"><strong>Example: PicketBox LoginModule Configuration</strong></div><p>
						
</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security"&gt;
      &lt;authentication&gt;
        &lt;login-module code="Database" flag="required"&gt;
          &lt;module-option name="dsJndiName" value="java:jboss/datasources/ExampleDS"/&gt;
          &lt;module-option name="principalsQuery" value="SELECT password FROM User WHERE username = ?"/&gt;
          &lt;module-option name="rolesQuery" value="SELECT role, 'Roles' FROM User WHERE username = ?"/&gt;
          &lt;module-option name="hashAlgorithm" value="MD5"/&gt;
          &lt;module-option name="hashEncoding" value="base64"/&gt;
        &lt;/login-module&gt;
      &lt;/authentication&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
&lt;/subsystem&gt;</pre><p>

					</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="migrate_legacy_database_authentication_to_elytron"/>Migrate the Legacy Database Authentication to Elytron</h3></div></div></div><p>
						To migrate the previous database authentication example configuration to Elytron, you must define a JDBC realm to enable JDBC datasource access by Elytron.
					</p><p>
						Use the following management command to define the <code class="literal">jdbc-realm</code>.
					</p><pre class="screen">/subsystem=elytron/jdbc-realm=jdbc-realm:add(principal-query=[ { data-source=ExampleDS, sql="SELECT role, password FROM User WHERE username = ?", attribute-mapping=[{index=1, to=Roles } ] simple-digest-mapper={algorithm=simple-digest-md5, password-index=2} } ] )</pre><p>
						This results in the following <code class="literal">jdbc-realm</code> configuration in the <code class="literal">elytron</code> subsystem of the server configuration file.
					</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-realms&gt;
    ...
    &lt;jdbc-realm name="jdbc-realm"&gt;
      &lt;principal-query sql="SELECT role, password FROM User WHERE username = ?" data-source="ExampleDS"&gt;
        &lt;attribute-mapping&gt;
          &lt;attribute to="Roles" index="1"/&gt;
        &lt;/attribute-mapping&gt;
        &lt;simple-digest-mapper password-index="2"/&gt;
      &lt;/principal-query&gt;
    &lt;/jdbc-realm&gt;
    ...
  &lt;/security-realms&gt;
  ...
&lt;/subsystem&gt;</pre><p>
						Elytron now manages the database authentication using the JDBC realm configuration. Elytron is more efficient than PicketBox because it uses one SQL query to obtain all of the user attributes and credentials, and then extracts data from the SQL results and creates a mapping of the attributes to use for authentication.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_kerberos_authentication_to_elytron"/>Migrate Kerberos Authentication to Elytron</h2></div></div></div><p>
					When working with a Kerberos configuration, the JBoss EAP server can rely on configuration information from the environment, or the key configuration can be specified using system properties. This section discusses how to migrate <a class="link" href="migrating_to_elytron.html#migrate_kerberos_http_authentication" title="Migrate Kerberos HTTP Authentication">Kerberos HTTP</a> and <a class="link" href="migrating_to_elytron.html#migrate_kerberos_remoting_sasl_authentication" title="Migrate Kerberos Remoting SASL Authentication">Kerberos SASL</a> authentication.
				</p><p>
					The examples that follow assume that Kerberos is configured using the following system properties. These system properties are applicable to both the legacy configuration and the migrated Elytron configuration.
				</p><div class="title"><strong>Example: Kerberos System Properties Management CLI Commands</strong></div><p>
						
</p><pre class="screen"># Enable debugging
/system-property=sun.security.krb5.debug:add(value=true)
# Identify the Kerberos realm to use
/system-property=java.security.krb5.realm:add(value=ELYTRON.ORG)
# Identify the address of the KDC
/system-property=java.security.krb5.kdc:add(value=kdc.elytron.org)</pre><p>

					</p><div class="title"><strong>Example: Kerberos System Properties Server Configuration</strong></div><p>
						
</p><pre class="programlisting">&lt;system-properties&gt;
  &lt;property name="sun.security.krb5.debug" value="true"/&gt;
  &lt;property name="java.security.krb5.realm" value="ELYTRON.ORG"/&gt;
  &lt;property name="java.security.krb5.kdc" value="kdc.elytron.org"/&gt;
&lt;/system-properties&gt;</pre><p>

					</p><p>
					Choose one of the following migration options:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<a class="link" href="migrating_to_elytron.html#migrate_kerberos_http_authentication" title="Migrate Kerberos HTTP Authentication">Migrate Kerberos HTTP Authentication</a>.
						</li><li class="listitem">
							<a class="link" href="migrating_to_elytron.html#migrate_kerberos_remoting_sasl_authentication" title="Migrate Kerberos Remoting SASL Authentication">Migrate Kerberos Remoting SASL Authentication</a>.
						</li></ul></div><h4><a id="migrate_kerberos_http_authentication"/>Migrate Kerberos HTTP Authentication</h4><p>
					In legacy security configurations, you can define a security realm to enable SPNEGO authentication for the HTTP management interface as follows.
				</p><div class="title"><strong>Example: Enable SPNEGO authentication for the HTTP management interface</strong></div><p>
						
</p><pre class="screen">/core-service=management/security-realm=Kerberos:add
/core-service=management/security-realm=Kerberos/server-identity=kerberos:add
/core-service=management/security-realm=Kerberos/server-identity=kerberos/keytab=HTTP\/test-server.elytron.org@ELYTRON.ORG:add(path=<span class="emphasis"><em>/path/to/</em></span>test-server.keytab, debug=true)
/core-service=management/security-realm=Kerberos/authentication=kerberos:add(remove-realm=true)</pre><p>

					</p><div class="title"><strong>Example: Kerberos Security Realm Configuration</strong></div><p>
						
</p><pre class="programlisting">&lt;security-realms&gt;
  ...
  &lt;security-realm name="Kerberos"&gt;
    &lt;server-identities&gt;
      &lt;kerberos&gt;
        &lt;keytab principal="HTTP/test-server.elytron.org@ELYTRON.ORG" path="<span class="emphasis"><em>/path/to/</em></span>test-server.keytab" debug="true"/&gt;
      &lt;/kerberos&gt;
    &lt;/server-identities&gt;
    &lt;authentication&gt;
      &lt;kerberos remove-realm="true"/&gt;
    &lt;/authentication&gt;
  &lt;/security-realm&gt;
&lt;/security-realms&gt;</pre><p>

					</p><p>
					You can also define a pair of legacy security domains to allow applications to use Kerberos HTTP authentication.
				</p><div class="title"><strong>Example: Define Multiple Security Domains</strong></div><p>
						
</p><pre class="screen"># Define the first security domain
/subsystem=security/security-domain=host:add
/subsystem=security/security-domain=host/authentication=classic:add
/subsystem=security/security-domain=host/authentication=classic/login-module=1:add(code=Kerberos, flag=Required, module-options={storeKey=true, useKeyTab=true, principal=HTTP/test-server.elytron.org@ELYTRON.ORG, keyTab=<span class="emphasis"><em>path/to/</em></span>test-server.keytab, debug=true}

# Define the second SPNEGO security domain
/subsystem=security/security-domain=SPNEGO:add
/subsystem=security/security-domain=SPNEGO/authentication=classic:add
/subsystem=security/security-domain=SPNEGO/authentication=classic/login-module=1:add(code=SPNEGO, flag=requisite,  module-options={password-stacking=useFirstPass, serverSecurityDomain=host})
/subsystem=security/security-domain=SPNEGO/authentication=classic/login-module=1:write-attribute(name=module, value=org.jboss.security.negotiation)
/subsystem=security/security-domain=SPNEGO/authentication=classic/login-module=2:add(code=UsersRoles, flag=required, module-options={password-stacking=useFirstPass, usersProperties=  <span class="emphasis"><em>/path/to/</em></span>kerberos/spnego-users.properties, rolesProperties=  <span class="emphasis"><em>/path/to/</em></span>kerberos/spnego-roles.properties, defaultUsersProperties=  <span class="emphasis"><em>/path/to/</em></span>kerberos/spnego-users.properties, defaultRolesProperties=  <span class="emphasis"><em>/path/to/</em></span>kerberos/spnego-roles.properties})</pre><p>

					</p><div class="title"><strong>Example: Configuration Using a Pair of Security Domains</strong></div><p>
						
</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="host"&gt;
      &lt;authentication&gt;
        &lt;login-module name="1" code="Kerberos" flag="required"&gt;
          &lt;module-option name="storeKey" value="true"/&gt;
          &lt;module-option name="useKeyTab" value="true"/&gt;
          &lt;module-option name="principal" value="HTTP/test-server.elytron.org@ELYTRON.ORG"/&gt;
          &lt;module-option name="keyTab" value="<span class="emphasis"><em>/path/to/</em></span>test-server.keytab"/&gt;
          &lt;module-option name="debug" value="true"/&gt;
        &lt;/login-module&gt;
      &lt;/authentication&gt;
    &lt;/security-domain&gt;
    &lt;security-domain name="SPNEGO"&gt;
      &lt;authentication&gt;
        &lt;login-module name="1" code="SPNEGO" flag="requisite" module="org.jboss.security.negotiation"&gt;
          &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
          &lt;module-option name="serverSecurityDomain" value="host"/&gt;
        &lt;/login-module&gt;
        &lt;login-module name="2" code="UsersRoles" flag="required"&gt;
          &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
          &lt;module-option name="usersProperties" value="<span class="emphasis"><em>path/to</em></span>/kerberos/spnego-users.properties"/&gt;
          &lt;module-option name="rolesProperties" value="  <span class="emphasis"><em>/</em></span>path/to<span class="emphasis"><em>/</em></span>kerberos/spnego-roles.properties"/&gt;
          &lt;module-option name="defaultUsersProperties" value="  <span class="emphasis"><em>/</em></span>path/to<span class="emphasis"><em>/</em></span>kerberos/spnego-users.properties"/&gt;
          &lt;module-option name="defaultRolesProperties" value="  <span class="emphasis"><em>/</em></span>path/to<span class="emphasis"><em>/</em></span>kerberos/spnego-roles.properties"/&gt;
        &lt;/login-module&gt;
      &lt;/authentication&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
&lt;/subsystem&gt;</pre><p>

					</p><p>
					The legacy applications are then deployed referencing the SPNEGO security domain and secured with the SPNEGO mechanism.
				</p><h5><a id="migrate_kerberos_http_authentication_to_elytron"/>Migrate the Kerberos HTTP Authentication to Elytron</h5><p>
					Both the management interface and applications can be secured in Elytron by using a security realm and a Kerberos security factory.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Define a security realm to be used to load identity information.
						</p><pre class="screen">/subsystem=elytron/properties-realm=spnego-properties:add(users-properties={path=<span class="emphasis"><em>path/to/</em></span>spnego-users.properties, plain-text=true, digest-realm-name=ELYTRON.ORG}, groups-properties={path=<span class="emphasis"><em>path/to/</em></span>spnego-roles.properties})</pre></li><li class="listitem"><p class="simpara">
							Define a Kerberos security factory that allows the server to load its own Kerberos identity.
						</p><pre class="screen">/subsystem=elytron/kerberos-security-factory=test-server:add(path=<span class="emphasis"><em>path/to/</em></span>test-server.keytab, principal=HTTP/test-server.elytron.org@ELYTRON.ORG, debug=true)</pre></li><li class="listitem"><p class="simpara">
							Define a security domain to pull together the policy as well as an HTTP authentication factory for the authentication policy.
						</p><pre class="screen">/subsystem=elytron/security-domain=SPNEGODomain:add(default-realm=spnego-properties, realms=[{realm=spnego-properties, role-decoder=groups-to-roles}], permission-mapper=default-permission-mapper)
/subsystem=elytron/http-authentication-factory=spnego-http-authentication:add(security-domain=SPNEGODomain, http-server-mechanism-factory=global,mechanism-configurations=[{mechanism-name=SPNEGO, credential-security-factory=test-server}])</pre><p class="simpara">
							This results in the following configuration in the <code class="literal">elytron</code> subsystem of the server configuration file.
						</p><div class="title"><strong>Example: Migrated Elytron Configuration</strong></div><p>
								
</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
  ...
    &lt;security-domain name="SPNEGODomain" default-realm="spnego-properties" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="spnego-properties" role-decoder="groups-to-roles"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  &lt;security-realms&gt;
    ...
    &lt;properties-realm name="spnego-properties"&gt;
      &lt;users-properties path="<span class="emphasis"><em>path/to/</em></span>spnego-users.properties" digest-realm-name="ELYTRON.ORG" plain-text="true"/&gt;
      &lt;groups-properties path="<span class="emphasis"><em>path/to/</em></span>spnego-roles.properties"/&gt;
    &lt;/properties-realm&gt;
  &lt;/security-realms&gt;
  &lt;credential-security-factories&gt;
    &lt;kerberos-security-factory name="test-server" principal="HTTP/test-server.elytron.org@ELYTRON.ORG" path="<span class="emphasis"><em>path/to/</em></span>test-server.keytab" debug="true"/&gt;
  &lt;/credential-security-factories&gt;
  ...
  &lt;http&gt;
    ...
    &lt;http-authentication-factory name="spnego-http-authentication" http-server-mechanism-factory="global" security-domain="SPNEGODomain"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="SPNEGO" credential-security-factory="test-server"/&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/http-authentication-factory&gt;
    ...
  &lt;/http&gt;
  ...
&lt;/subsystem&gt;</pre><p>

							</p></li><li class="listitem">
							To secure the application, define an application security domain in the <code class="literal">undertow</code> subsystem to map security domains to this <code class="literal">http-authentication-factory</code>. The HTTP management interface can be updated to reference the <code class="literal">http-authentication-factory</code> defined in this configuration. This process is documented in the <a class="link" href="migrating_to_elytron.html#migrate_properties_based_authentication_and_authorization" title="Migrate Properties-based Authentication and Authorization to Elytron">Migrate Properties-based Authentication and Authorization to Elytron</a> section of this guide.
						</li></ol></div><h4><a id="migrate_kerberos_remoting_sasl_authentication"/>Migrate Kerberos Remoting SASL Authentication</h4><p>
					It is possible to define a legacy security realm for Kerberos / GSSAPI SASL authentication to be used for remoting authentication, such as the native management interface.
				</p><div class="title"><strong>Example: Kerberos Authentication for Remoting Management CLI Commands</strong></div><p>
						
</p><pre class="screen">/core-service=management/security-realm=Kerberos:add
/core-service=management/security-realm=Kerberos/server-identity=kerberos:add
/core-service=management/security-realm=Kerberos/server-identity=kerberos/keytab=remote\/test-server.elytron.org@ELYTRON.ORG:add(path=<span class="emphasis"><em>path/to</em></span>/remote-test-server.keytab, debug=true)
/core-service=management/security-realm=Kerberos/authentication=kerberos:add(remove-realm=true)</pre><p>

					</p><div class="title"><strong>Example: Kerberos Remoting Security Realm Configuration</strong></div><p>
						
</p><pre class="programlisting">&lt;management&gt;
  &lt;security-realms&gt;
    ...
    &lt;security-realm name="Kerberos"&gt;
      &lt;server-identities&gt;
        &lt;kerberos&gt;
          &lt;keytab principal="remote/test-server.elytron.org@ELYTRON.ORG" path="<span class="emphasis"><em>path/to</em></span>/remote-test-server.keytab" debug="true"/&gt;
        &lt;/kerberos&gt;
      &lt;/server-identities&gt;
      &lt;authentication&gt;
        &lt;kerberos remove-realm="true"/&gt;
      &lt;/authentication&gt;
    &lt;/security-realm&gt;
  &lt;/security-realms&gt;
  ...
&lt;/management&gt;</pre><p>

					</p><h5><a id="migrate_kerberos_remoting_sasl_authentication_to_elytron"/>Migrate the Kerberos Remoting SASL Authentication to Elytron</h5><p>
					The steps to define the equivalent Elytron configuration are very similar to those described in <a class="link" href="migrating_to_elytron.html#migrate_kerberos_http_authentication" title="Migrate Kerberos HTTP Authentication">Migrate Kerberos HTTP Authentication</a>.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Define a security realm to be used to load identity information.
						</p><pre class="screen">/path=kerberos:add(relative-to=user.home, path=src/kerberos)
/subsystem=elytron/properties-realm=kerberos-properties:add(users-properties={path=kerberos-users.properties, relative-to=kerberos, digest-realm-name=ELYTRON.ORG}, groups-properties={path=kerberos-groups.properties, relative-to=kerberos})</pre></li><li class="listitem"><p class="simpara">
							Define the Kerberos security factory for the server’s identity.
						</p><pre class="screen">/subsystem=elytron/kerberos-security-factory=test-server:add(relative-to=kerberos, path=remote-test-server.keytab, principal=remote/test-server.elytron.org@ELYTRON.ORG)</pre></li><li class="listitem"><p class="simpara">
							Define the security domain and a SASL authentication factory.
						</p><pre class="screen">/subsystem=elytron/security-domain=KerberosDomain:add(default-realm=kerberos-properties, realms=[{realm=kerberos-properties, role-decoder=groups-to-roles}], permission-mapper=default-permission-mapper)
/subsystem=elytron/sasl-authentication-factory=gssapi-authentication-factory:add(security-domain=KerberosDomain, sasl-server-factory=elytron, mechanism-configurations=[{mechanism-name=GSSAPI, credential-security-factory=test-server}])</pre></li></ol></div><p>
					This results in the following configuration in the <code class="literal">elytron</code> subsystem of the server configuration file.
				</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="KerberosDomain" default-realm="kerberos-properties" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="kerberos-properties" role-decoder="groups-to-roles"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  &lt;security-realms&gt;
   ...
     &lt;properties-realm name="kerberos-properties"&gt;
       &lt;users-properties path="kerberos-users.properties" relative-to="kerberos" digest-realm-name="ELYTRON.ORG"/&gt;
       &lt;groups-properties path="kerberos-groups.properties" relative-to="kerberos"/&gt;
     &lt;/properties-realm&gt;
   &lt;/security-realms&gt;
   &lt;credential-security-factories&gt;
     &lt;kerberos-security-factory name="test-server" principal="remote/test-server.elytron.org@ELYTRON.ORG" path="remote-test-server.keytab" relative-to="kerberos"/&gt;
   &lt;/credential-security-factories&gt;
   ...
   &lt;sasl&gt;
     ...
     &lt;sasl-authentication-factory name="gssapi-authentication-factory" sasl-server-factory="elytron" security-domain="KerberosDomain"&gt;
       &lt;mechanism-configuration&gt;
         &lt;mechanism mechanism-name="GSSAPI" credential-security-factory="test-server"/&gt;
       &lt;/mechanism-configuration&gt;
     &lt;/sasl-authentication-factory&gt;
     ...
   &lt;/sasl&gt;
 &lt;/subsystem&gt;</pre><p>
					The management interface or remoting connectors can now be updated to reference the SASL authentication factory.
				</p><p>
					The two Elytron examples defined here could also be combined to use a shared security domain and security realm and just use protocol-specific authentication factories each referencing their own Kerberos security factory.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_composite_stores_elytron"/>Migrate Composite Stores to Elytron</h2></div></div></div><p>
					This section describes how to migrate a <a class="link" href="migrating_to_elytron.html#composite_picketbox" title="PicketBox Composite Store Configuration">PicketBox</a> or <a class="link" href="migrating_to_elytron.html#composite_legacy_security_realm" title="Legacy Security Realm Composite Store Configuration">legacy security realm</a> configuration that uses multiple identity stores to <a class="link" href="migrating_to_elytron.html#composite_elytron" title="Elytron Aggregate Security Realm Configuration">Elytron</a>. When using either PicketBox or the legacy security realms, it is possible to define a configuration where authentication is performed against one identity store while the information used for authorization is loaded from a different store. When migrating to Elytron, this can be achieved by using an aggregate security realm.
				</p><p>
					The following examples perform user authentication using the <code class="literal">example-users.properties</code> properties file, and then query LDAP to load the group and role information.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						The configurations shown are based on the examples in the following sections, which provide additional background information:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								<a class="link" href="migrating_to_elytron.html#migrate_properties_based_authentication_and_authorization" title="Migrate Properties-based Authentication and Authorization to Elytron">Migrate Properties-based Authentication and Authorization to Elytron</a>
							</li><li class="listitem">
								<a class="link" href="migrating_to_elytron.html#migrate_ldap_authentication_configuration_to_elytron" title="Migrate LDAP Authentication Configuration to Elytron">Migrate LDAP Authentication Configuration to Elytron</a>
							</li></ul></div></div><h4><a id="composite_picketbox"/>PicketBox Composite Store Configuration</h4><p>
					The PicketBox security domain for this scenario is configured using the following management CLI commands.
				</p><div class="title"><strong>Example: PicketBox Configuration Commands</strong></div><p>
						
</p><pre class="screen">/subsystem=security/security-domain=application-security:add

/subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[ {code=UsersRoles, flag=Required, module-options={ password-stacking=useFirstPass, usersProperties=file://${jboss.server.config.dir}/example-users.properties}} {code=LdapExtended, flag=Required, module-options={ password-stacking=useFirstPass, java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory, java.naming.provider.url=ldap://localhost:10389, java.naming.security.authentication=simple, bindDN="uid=admin,ou=system", bindCredential=secret, baseCtxDN="ou=users,dc=group-to-principal,dc=wildfly,dc=org", baseFilter="(uid={0})", rolesCtxDN="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",roleFilter="(uniqueMember={1})", roleAttributeID="uid" }}])</pre><p>

					</p><p>
					This results in the following server configuration.
				</p><div class="title"><strong>Example: PicketBox Security Domain Configuration</strong></div><p>
						
</p><pre class="programlisting">&lt;security-domain name="application-security"&gt;
  &lt;authentication&gt;
    &lt;login-module code="UsersRoles" flag="required"&gt;
      &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
      &lt;module-option name="usersProperties" value="file://${jboss.server.config.dir}/example-users.properties"/&gt;
    &lt;/login-module&gt;
    &lt;login-module code="LdapExtended" flag="required"&gt;
      &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
      &lt;module-option name="java.naming.factory.initial" value="com.sun.jndi.ldap.LdapCtxFactory"/&gt;
      &lt;module-option name="java.naming.provider.url" value="ldap://localhost:10389"/&gt;
      &lt;module-option name="java.naming.security.authentication" value="simple"/&gt;
      &lt;module-option name="bindDN" value="uid=admin,ou=system"/&gt;
      &lt;module-option name="bindCredential" value="secret"/&gt;
      &lt;module-option name="baseCtxDN" value="ou=users,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
      &lt;module-option name="baseFilter" value="(uid={0})"/&gt;
      &lt;module-option name="rolesCtxDN" value="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
      &lt;module-option name="roleFilter" value="(uniqueMember={1})"/&gt;
      &lt;module-option name="roleAttributeID" value="uid"/&gt;
    &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</pre><p>

					</p><p>
					See <a class="link" href="migrating_to_elytron.html#composite_elytron" title="Elytron Aggregate Security Realm Configuration">Elytron Aggregate Security Realm Configuration</a> for how to configure an aggregate security realm in the <code class="literal">elytron</code> subsystem to accomplish this.
				</p><h4><a id="composite_legacy_security_realm"/>Legacy Security Realm Composite Store Configuration</h4><p>
					The legacy security realm configuration for this scenario is configured using the following management CLI commands.
				</p><div class="title"><strong>Example: Legacy Security Realm Configuration Commands</strong></div><p>
						
</p><pre class="screen">/core-service=management/ldap-connection=MyLdapConnection:add(url="ldap://localhost:10389", search-dn="uid=admin,ou=system", search-credential="secret")

/core-service=management/security-realm=ApplicationSecurity:add
/core-service=management/security-realm=ApplicationSecurity/authentication=properties:add(path=example-users.properties, relative-to=jboss.server.config.dir, plain-text=true)

batch
/core-service=management/security-realm=ApplicationSecurity/authorization=ldap:add(connection=MyLdapConnection)
/core-service=management/security-realm=ApplicationSecurity/authorization=ldap/username-to-dn=username-filter:add(attribute=uid, base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org")
/core-service=management/security-realm=ApplicationSecurity/authorization=ldap/group-search=group-to-principal:add(base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org", iterative=true, prefer-original-connection=true, principal-attribute=uniqueMember, search-by=DISTINGUISHED_NAME, group-name=SIMPLE, group-name-attribute=uid)
run-batch</pre><p>

					</p><p>
					This results in the following server configuration.
				</p><div class="title"><strong>Example: Legacy Security Realm Configuration</strong></div><p>
						
</p><pre class="programlisting">&lt;security-realms&gt;
  ...
  &lt;security-realm name="ApplicationSecurity"&gt;
    &lt;authentication&gt;
      &lt;properties path="example-users.properties" relative-to="jboss.server.config.dir" plain-text="true"/&gt;
    &lt;/authentication&gt;
    &lt;authorization&gt;
      &lt;ldap connection="MyLdapConnection"&gt;
        &lt;username-to-dn&gt;
          &lt;username-filter base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org" attribute="uid"/&gt;
        &lt;/username-to-dn&gt;
        &lt;group-search group-name="SIMPLE" iterative="true" group-name-attribute="uid"&gt;
          &lt;group-to-principal search-by="DISTINGUISHED_NAME" base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org" prefer-original-connection="true"&gt;
            &lt;membership-filter principal-attribute="uniqueMember"/&gt;
          &lt;/group-to-principal&gt;
        &lt;/group-search&gt;
      &lt;/ldap&gt;
    &lt;/authorization&gt;
  &lt;/security-realm&gt;
&lt;/security-realms&gt;
&lt;outbound-connections&gt;
  &lt;ldap name="MyLdapConnection" url="ldap://localhost:10389" search-dn="uid=admin,ou=system" search-credential="secret"/&gt;
&lt;/outbound-connections&gt;</pre><p>

					</p><p>
					See <a class="link" href="migrating_to_elytron.html#composite_elytron" title="Elytron Aggregate Security Realm Configuration">Elytron Aggregate Security Realm Configuration</a> for how to configure an aggregate security realm in the <code class="literal">elytron</code> subsystem to accomplish this.
				</p><h4><a id="composite_elytron"/>Elytron Aggregate Security Realm Configuration</h4><p>
					The equivalent Elytron configuration for this scenario is configured using the following management CLI commands.
				</p><div class="title"><strong>Example: Elytron Configuration Commands</strong></div><p>
						
</p><pre class="screen">/subsystem=elytron/dir-context=ldap-connection:add(url=ldap://localhost:10389, principal="uid=admin,ou=system", credential-reference={clear-text=secret})

/subsystem=elytron/ldap-realm=ldap-realm:add(dir-context=ldap-connection, direct-verification=true, identity-mapping={search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org", rdn-identifier="uid", attribute-mapping=[{filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",filter="(uniqueMember={1})",from="uid",to="Roles"}]})

/subsystem=elytron/properties-realm=application-properties:add(users-properties={path=example-users.properties, relative-to=jboss.server.config.dir, plain-text=true, digest-realm-name="Application Security"})

/subsystem=elytron/aggregate-realm=combined-realm:add(authentication-realm=application-properties, authorization-realm=ldap-realm)

/subsystem=elytron/security-domain=application-security:add(realms=[{realm=combined-realm}], default-realm=combined-realm, permission-mapper=default-permission-mapper)
/subsystem=elytron/http-authentication-factory=application-security-http:add(http-server-mechanism-factory=global, security-domain=application-security, mechanism-configurations=[{mechanism-name=BASIC}])</pre><p>

					</p><p>
					This results in the following server configuration.
				</p><div class="title"><strong>Example: Elytron Configuration</strong></div><p>
						
</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" default-realm="combined-realm" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="combined-realm"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  &lt;security-realms&gt;
    &lt;aggregate-realm name="combined-realm" authentication-realm="application-properties" authorization-realm="ldap-realm"/&gt;
      ...
      &lt;properties-realm name="application-properties"&gt;
        &lt;users-properties path="example-users.properties" relative-to="jboss.server.config.dir" digest-realm-name="Application Security" plain-text="true"/&gt;
      &lt;/properties-realm&gt;
      &lt;ldap-realm name="ldap-realm" dir-context="ldap-connection" direct-verification="true"&gt;
        &lt;identity-mapping rdn-identifier="uid" search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
          &lt;attribute-mapping&gt;
            &lt;attribute from="uid" to="Roles" filter="(uniqueMember={1})" filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;/attribute-mapping&gt;
        &lt;/identity-mapping&gt;
      &lt;/ldap-realm&gt;
  &lt;/security-realms&gt;
  ...
  &lt;http&gt;
    ...
    &lt;http-authentication-factory name="application-security-http" http-server-mechanism-factory="global" security-domain="application-security"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="BASIC"/&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/http-authentication-factory&gt;
    ...
  &lt;/http&gt;
  ...
  &lt;dir-contexts&gt;
    &lt;dir-context name="ldap-connection" url="ldap://localhost:10389" principal="uid=admin,ou=system"&gt;
      &lt;credential-reference clear-text="secret"/&gt;
    &lt;/dir-context&gt;
  &lt;/dir-contexts&gt;
&lt;/subsystem&gt;</pre><p>

					</p><p>
					In the <code class="literal">elytron</code> subsystem, an <code class="literal">aggregate-realm</code> has been defined that specifies which security realms to use for authentication and which to use for authorization decisions.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_security_domains_that_use_caching_to_elytron"/>Migrate Security Domains That Use Caching to Elytron</h2></div></div></div><p>
					When using PicketBox, it is possible to define a security domain and enable in-memory caching for its access. This allows you to access the identity data in memory and avoids additional direct access to the identity store. It is possible to achieve a similar configuration with Elytron. This section describes how to configure security domain caching when using Elytron.
				</p><h4><a id="picketbox_cached_security_domain_configuration"/>PicketBox Cached Security Domain Configuration</h4><p>
					The following commands show how to configure a PicketBox security domain that enables caching.
				</p><div class="title"><strong>Example: PicketBox Cached Security Domain Commands</strong></div><p>
						
</p><pre class="screen">/subsystem=security/security-domain=application-security:add(cache-type=default)
/subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=LdapExtended, flag=Required, module-options={ java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory, java.naming.provider.url=ldap://localhost:10389, java.naming.security.authentication=simple, bindDN="uid=admin,ou=system", bindCredential=secret, baseCtxDN="ou=users,dc=group-to-principal,dc=wildfly,dc=org", baseFilter="(uid={0})", rolesCtxDN="ou=groups,dc=group-to-principal,dc=wildfly,dc=org", roleFilter="(uniqueMember={1})", roleAttributeID="uid" }}])</pre><p>

					</p><p>
					This results in the following server configuration.
				</p><div class="title"><strong>Example: PicketBox Cached Security Domain Configuration</strong></div><p>
						
</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" cache-type="default"&gt;
      &lt;authentication&gt;
        &lt;login-module code="LdapExtended" flag="required"&gt;
          &lt;module-option name="java.naming.factory.initial" value="com.sun.jndi.ldap.LdapCtxFactory"/&gt;
          &lt;module-option name="java.naming.provider.url" value="ldap://localhost:10389"/&gt;
          &lt;module-option name="java.naming.security.authentication" value="simple"/&gt;
          &lt;module-option name="bindDN" value="uid=admin,ou=system"/&gt;
          &lt;module-option name="bindCredential" value="secret"/&gt;
          &lt;module-option name="baseCtxDN" value="ou=users,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;module-option name="baseFilter" value="(uid={0})"/&gt;
          &lt;module-option name="rolesCtxDN" value="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;module-option name="roleFilter" value="(uniqueMember={1})"/&gt;
          &lt;module-option name="roleAttributeID" value="uid"/&gt;
        &lt;/login-module&gt;
      &lt;/authentication&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
&lt;/subsystem&gt;</pre><p>

					</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						This command and resulting configuration is similar to the example shown in <a class="link" href="migrating_to_elytron.html#migrate_ldap_authentication_configuration_to_elytron" title="Migrate LDAP Authentication Configuration to Elytron">Migrate LDAP Authentication Configuration to Elytron</a>; however, here the attribute <code class="literal">cache-type</code> is defined with a value of <code class="literal">default</code>. The <code class="literal">default</code> cache type is an in-memory cache. When using PicketBox, you can also specify a <code class="literal">cache-type</code> of <code class="literal">infinispan</code>, however this type is not supported with Elytron.
					</p></div><h4><a id="elytron_cached_security_domain_configuration"/>Elytron Cached Security Domain Configuration</h4><p>
					Follow the steps below to create a similar configuration that caches a security domain when using Elytron.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Define a security realm and wrap the security realm in a caching realm. The caching realm can then be used in a security domain and subsequently in an authentication factory.
						</p><div class="title"><strong>Example: Elytron Security Realm Configuration Commands</strong></div><p>
								
</p><pre class="screen">/subsystem=elytron/dir-context=ldap-connection:add(url=ldap://localhost:10389, principal="uid=admin,ou=system", credential-reference={clear-text=secret})
/subsystem=elytron/ldap-realm=ldap-realm:add(dir-context=ldap-connection, direct-verification=true, identity-mapping={search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org", rdn-identifier="uid", attribute-mapping=[{filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",filter="(uniqueMember={1})",from="uid",to="Roles"}]})
/subsystem=elytron/caching-realm=cached-ldap:add(realm=ldap-realm)</pre><p>

							</p></li><li class="listitem"><p class="simpara">
							Define a security domain and an HTTP authentication factory that use the <code class="literal">cached-ldap</code> realm defined in the previous step.
						</p><div class="title"><strong>Example: Elytron Security Domain and Authentication Factory Configuration Commands</strong></div><p>
								
</p><pre class="screen">/subsystem=elytron/security-domain=application-security:add(realms=[{realm=cached-ldap}], default-realm=cached-ldap, permission-mapper=default-permission-mapper)
/subsystem=elytron/http-authentication-factory=application-security-http:add(http-server-mechanism-factory=global, security-domain=application-security, mechanism-configurations=[{mechanism-name=BASIC}])</pre><p>

							</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								In this step, it is important that you reference the <code class="literal">caching-realm</code> instead of the original realm. Otherwise, caching is bypassed.
							</p></div></li></ol></div><p>
					These commands result in the following additions to the server configuration.
				</p><div class="title"><strong>Example: Elytron Cached Security Domain Configuration</strong></div><p>
						
</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" default-realm="cached-ldap" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="cached-ldap"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  ...
  &lt;security-realms&gt;
    ....
  &lt;ldap-realm name="ldap-realm" dir-context="ldap-connection" direct-verification="true"&gt;
      &lt;identity-mapping rdn-identifier="uid" search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
        &lt;attribute-mapping&gt;
          &lt;attribute from="uid" to="Roles" filter="(uniqueMember={1})" filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
        &lt;/attribute-mapping&gt;
      &lt;/identity-mapping&gt;
    &lt;/ldap-realm&gt;
    &lt;caching-realm name="cached-ldap" realm="ldap-realm"/&gt;
  &lt;/security-realms&gt;
  ...
  &lt;http&gt;
    ...
    &lt;http-authentication-factory name="application-security-http" http-server-mechanism-factory="global" security-domain="application-security"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="BASIC"/&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/http-authentication-factory&gt;
    ...
  &lt;/http&gt;
   ...
  &lt;dir-contexts&gt;
    &lt;dir-context name="ldap-connection" url="ldap://localhost:10389" principal="uid=admin,ou=system"&gt;
      &lt;credential-reference clear-text="secret"/&gt;
    &lt;/dir-context&gt;
  &lt;/dir-contexts&gt;
  ...</pre><p>

					</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_security_jacc_to_elytron"/>Migrate JACC Security to Elytron</h2></div></div></div><p>
					By default, JBoss EAP uses the legacy <code class="literal">security</code> subsystem to configure the Java Authorization Contract for Containers (JACC) policy provider and factory. The default configuration maps to implementations from PicketBox.
				</p><p>
					The <code class="literal">elytron</code> subsystem provides a built-in policy provider based on the JACC specification. Before you configure your server to allow Elytron to manage JACC configurations and other policies, you must first disable JACC in the legacy <code class="literal">security</code> subsystem by using the following management CLI command.
				</p><pre class="screen">/subsystem=security:write-attribute(name=initialize-jacc, value=false)</pre><p>
					Failure to do so can result in the following error in the server log: <code class="literal">MSC000004: Failure during stop of service org.wildfly.security.policy: java.lang.StackOverflowError</code>.
				</p><p>
					For information about how to enable JACC and define a JACC policy provider in the <code class="literal">elytron</code> subsystem, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/development_guide/#enabling_jacc_using_elytron">Enabling JACC Using the <code class="literal">elytron</code> Subsystem</a> in the <span class="emphasis"><em>Development Guide</em></span> for JBoss EAP.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="migrate_application_clients"/>Migrate Application Clients</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_naming_client_configuration_to_elytron"/>Migrate a Naming Client Configuration to Elytron</h2></div></div></div><p>
					This section describes how to migrate a client application that performs a remote JNDI lookup using an <code class="literal">org.jboss.naming.remote.client.InitialContext</code> class, which is backed by an <code class="literal">org.jboss.naming.remote.client.InitialContextFactory</code> class, to Elytron.
				</p><p>
					The following examples assume that the <code class="literal">InitialContextFactory</code> class is created by specifying properties for the user credentials and for the URL of the naming provider that it connects to.
				</p><div class="title"><strong>Example: <code class="literal">InitialContext</code> Code Used in the Previous Release</strong></div><p>
						
</p><pre class="programlisting">Properties properties = new Properties();
properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.jboss.naming.remote.client.InitialContextFactory");
properties.put(Context.PROVIDER_URL,"http-remoting://127.0.0.1:8080");
properties.put(Context.SECURITY_PRINCIPAL, "bob");
properties.put(Context.SECURITY_CREDENTIALS, "secret");
InitialContext context = new InitialContext(properties);
Bar bar = (Bar) context.lookup("foo/bar");
...</pre><p>

					</p><p>
					You can choose from one of the following migration approaches:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<a class="link" href="migrating_to_elytron.html#migrate_naming_client_using_configuration_file_approach" title="Migrate the Naming Client Using the Configuration File Approach">Migrate the Naming Client Using the Configuration File Approach</a>
						</li><li class="listitem">
							<a class="link" href="migrating_to_elytron.html#migrate_naming_client_using_programmatic_approach" title="Migrate the Naming Client Using the Programmatic Approach">Migrate the Naming Client Using the Programmatic Approach</a>
						</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="migrate_naming_client_using_configuration_file_approach"/>Migrate the Naming Client Using the Configuration File Approach</h3></div></div></div><p>
						Follow these steps to migrate your naming client to Elytron using the configuration approach.
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Create a <code class="literal">wildfly-config.xml</code> file in the client application <code class="literal">META-INF/</code> directory. The file should contain the user credentials that are to be used when establishing a connection to the naming provider.
							</p><div class="title"><strong>Example: <code class="literal">wildfly-config.xml</code> File</strong></div><p>
									
</p><pre class="programlisting">&lt;configuration&gt;
  &lt;authentication-client xmlns="urn:elytron:client:1.2"&gt;
    &lt;authentication-rules&gt;
      &lt;rule use-configuration="namingConfig"&gt;
        &lt;match-host name="127.0.0.1"/&gt;
      &lt;/rule&gt;
    &lt;/authentication-rules&gt;
    &lt;authentication-configurations&gt;
      &lt;configuration name="namingConfig"&gt;
        &lt;set-user-name name="bob"/&gt;
        &lt;credentials&gt;
          &lt;clear-password password="secret"/&gt;
        &lt;/credentials&gt;
      &lt;/configuration&gt;
    &lt;/authentication-configurations&gt;
  &lt;/authentication-client&gt;
&lt;/configuration&gt;</pre><p>

								</p></li><li class="listitem"><p class="simpara">
								Create an <code class="literal">InitialContext</code> as in the following example. Note that the <code class="literal">InitialContext</code> is backed by the <code class="literal">org.wildfly.naming.client.WildFlyInitialContextFactory</code> class.
							</p><div class="title"><strong>Example: <code class="literal">InitialContext</code> Code</strong></div><p>
									
</p><pre class="programlisting">Properties properties = new Properties();
properties.put(Context.INITIAL_CONTEXT_FACTORY,"org.wildfly.naming.client.WildFlyInitialContextFactory");
properties.put(Context.PROVIDER_URL,"remote+http://127.0.0.1:8080");
InitialContext context = new InitialContext(properties);
Bar bar = (Bar) context.lookup("foo/bar");
...</pre><p>

								</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="migrate_naming_client_using_programmatic_approach"/>Migrate the Naming Client Using the Programmatic Approach</h3></div></div></div><p>
						Using this approach, you provide the user credentials that are used to establish a connection to the naming provider directly in the application code.
					</p><div class="title"><strong>Example: Code Using the Programmatic Approach</strong></div><p>
							
</p><pre class="programlisting">// Create the authentication configuration
AuthenticationConfiguration namingConfig = AuthenticationConfiguration.empty().useName("bob").usePassword("secret");

// Create the authentication context
AuthenticationContext context = AuthenticationContext.empty().with(MatchRule.ALL.matchHost("127.0.0.1"), namingConfig);

// Create a callable that creates and uses an InitialContext
Callable&lt;Void&gt; callable = () -&gt; {
    Properties properties = new Properties();
    properties.put(Context.INITIAL_CONTEXT_FACTORY,"org.wildfly.naming.client.WildFlyInitialContextFactory");
    properties.put(Context.PROVIDER_URL,"remote+http://127.0.0.1:8080");
    InitialContext context = new InitialContext(properties);
    Bar bar = (Bar) context.lookup("foo/bar");
    ...
    return null;
};

// Use the authentication context to run the callable
context.runCallable(callable);</pre><p>

						</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_security_ejb_client_to_elytron"/>Migrate an EJB Client to Elytron</h2></div></div></div><p>
					This migration example assumes that the client application is configured to invoke an EJB deployed to a remote server using a <code class="literal">jboss-ejb-client.properties</code> file. This file, which is located in the client application <code class="literal">META-INF/</code> directory, contains the following information needed to connect to the remote server.
				</p><div class="title"><strong>Example: <code class="literal">jboss-ejb-client.properties</code> File</strong></div><p>
						
</p><pre class="screen">remote.connectionprovider.create.options.org.xnio.Options.SSL_ENABLED=false
remote.connections=default
remote.connection.default.host=127.0.0.1
remote.connection.default.port = 8080
remote.connection.default.username=bob
remote.connection.default.password=secret</pre><p>

					</p><p>
					The client looks up the EJB and calls one of its methods using code similar to the following example.
				</p><div class="title"><strong>Example: Client Code That Calls a Remote EJB</strong></div><p>
						
</p><pre class="programlisting">// Create an InitialContext
Properties properties = new Properties();
properties.put(Context.URL_PKG_PREFIXES, "org.jboss.ejb.client.naming");
InitialContext context = new InitialContext(properties);

// Look up the EJB and invoke one of its methods
RemoteCalculator statelessRemoteCalculator = (RemoteCalculator) context.lookup(
    "ejb:/ejb-remote-server-side//CalculatorBean!" + RemoteCalculator.class.getName());
int sum = statelessRemoteCalculator.add(101, 202);</pre><p>

					</p><p>
					You can choose from one of the following migration approaches:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<a class="link" href="migrating_to_elytron.html#migrate_ejb_client_using_configuration_file_approach" title="Migrate the EJB Client Using the Configuration File Approach">Migrate the EJB Client Using the Configuration File Approach</a>
						</li><li class="listitem">
							<a class="link" href="migrating_to_elytron.html#migrate_ejb_client_using_programmatic_approach" title="Migrate the EJB Client Using the Programmatic Approach">Migrate the EJB Client Using the Programmatic Approach</a>
						</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="migrate_ejb_client_using_configuration_file_approach"/>Migrate the EJB Client Using the Configuration File Approach</h3></div></div></div><p>
						Follow these steps to migrate your naming client to Elytron using the configuration approach.
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Configure a <code class="literal">wildfly-config.xml</code> file in the client application <code class="literal">META-INF/</code> directory. The file should contain the user credentials that are to be used when establishing a connection to the naming provider.
							</p><div class="title"><strong>Example: <code class="literal">wildfly-config.xml</code> File</strong></div><p>
									
</p><pre class="programlisting">&lt;configuration&gt;
  &lt;authentication-client xmlns="urn:elytron:client:1.2"&gt;
    &lt;authentication-rules&gt;
      &lt;rule use-configuration="ejbConfig"&gt;
        &lt;match-host name="127.0.0.1"/&gt;
      &lt;/rule&gt;
    &lt;/authentication-rules&gt;
    &lt;authentication-configurations&gt;
      &lt;configuration name="ejbConfig"&gt;
        &lt;set-user-name name="bob"/&gt;
        &lt;credentials&gt;
          &lt;clear-password password="secret"/&gt;
        &lt;/credentials&gt;
      &lt;/configuration&gt;
    &lt;/authentication-configurations&gt;
  &lt;/authentication-client&gt;
  &lt;jboss-ejb-client xmlns="urn:jboss:wildfly-client-ejb:3.0"&gt;
    &lt;connections&gt;
      &lt;connection uri="remote+http://127.0.0.1:8080" /&gt;
    &lt;/connections&gt;
  &lt;/jboss-ejb-client&gt;
&lt;/configuration&gt;</pre><p>

								</p></li><li class="listitem"><p class="simpara">
								Create an <code class="literal">InitialContext</code> as in the following example. Note that the <code class="literal">InitialContext</code> is backed by the <code class="literal">org.wildfly.naming.client.WildFlyInitialContextFactory</code> class.
							</p><div class="title"><strong>Example: <code class="literal">InitialContext</code> Code</strong></div><p>
									
</p><pre class="programlisting">// Create an InitialContext
Properties properties = new Properties();
properties.put(Context.INITIAL_CONTEXT_FACTORY,"org.wildfly.naming.client.WildFlyInitialContextFactory");
InitialContext context = new InitialContext(properties);

// Look up an EJB and invoke one of its methods
// Note that this code is the same as before
RemoteCalculator statelessRemoteCalculator = (RemoteCalculator) context.lookup(
    "ejb:/ejb-remote-server-side//CalculatorBean!" + RemoteCalculator.class.getName());
int sum = statelessRemoteCalculator.add(101, 202);----</pre><p>

								</p></li><li class="listitem">
								You can now delete the obsolete <code class="literal">jboss-ejb-client.properties</code> file as that file is no longer needed.
							</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="migrate_ejb_client_using_programmatic_approach"/>Migrate the EJB Client Using the Programmatic Approach</h3></div></div></div><p>
						Using this approach, you provide the information needed to connect to the remote server directly in the application code.
					</p><div class="title"><strong>Example: Code Using the Programmatic Approach</strong></div><p>
							
</p><pre class="programlisting">// Create the authentication configuration
AuthenticationConfiguration ejbConfig = AuthenticationConfiguration.empty().useName("bob").usePassword("secret");

// Create the authentication context
AuthenticationContext context = AuthenticationContext.empty().with(MatchRule.ALL.matchHost("127.0.0.1"), ejbConfig);

// Create a callable that invokes the EJB
Callable&lt;Void&gt; callable = () -&gt; {

    // Create an InitialContext
    Properties properties = new Properties();
    properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.wildfly.naming.client.WildFlyInitialContextFactory");
    properties.put(Context.PROVIDER_URL, "remote+http://127.0.0.1:8080");
    InitialContext context = new InitialContext(properties);

    // Look up the EJB and invoke one of its methods
    // Note that this code is the same as before
    RemoteCalculator statelessRemoteCalculator = (RemoteCalculator) context.lookup(
        "ejb:/ejb-remote-server-side//CalculatorBean!" + RemoteCalculator.class.getName());
    int sum = statelessRemoteCalculator.add(101, 202);
    ...
    return null;
};

// Use the authentication context to run the callable
context.runCallable(callable);</pre><p>

						</p><p>
						You can now delete the obsolete <code class="literal">jboss-ejb-client.properties</code> file as that file is no longer needed.
					</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="migrate_ssl_configurations"/>Migrate SSL Configurations</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_simple_ssl_configuration_to_elytron"/>Migrate a Simple SSL Configuration to Elytron</h2></div></div></div><p>
					If you secured HTTP connections to the JBoss EAP server using a security realm, you can migrate that configuration to Elytron using the information provided in this section.
				</p><p>
					The following examples assume you have the following <code class="literal">keystore</code> configured in the <code class="literal">security-realm</code>.
				</p><div class="title"><strong>Example: SSL Configuration Using a Security Realm Keystore</strong></div><p>
						
</p><pre class="programlisting">&lt;security-realm name="ApplicationRealm"&gt;
  &lt;server-identities&gt;
    &lt;ssl&gt;
      &lt;keystore path="server.keystore" relative-to="jboss.server.config.dir" keystore-password="keystore_password" alias="server" key-password="key_password" /&gt;
    &lt;/ssl&gt;
  &lt;/server-identities&gt;
&lt;/security-realm&gt;</pre><p>

					</p><p>
					Follow the steps below to achieve the same configuration using Elytron.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Create a <code class="literal">key-store</code> in the <code class="literal">elytron</code> subsystem that specifies the location of the keystore and the password by which it is encrypted. This command assumes the keystore was generated using the keytool command and its type is <code class="literal">JKS</code>.
						</p><pre class="screen">/subsystem=elytron/key-store=LocalhostKeyStore:add(path=server.keystore,relative-to=jboss.server.config.dir,credential-reference={clear-text="keystore_password"},type=JKS)</pre></li><li class="listitem"><p class="simpara">
							Create a <code class="literal">key-manager</code> in the <code class="literal">elytron</code> subsystem that specifies the <code class="literal">key-store</code> defined in the previous step, the alias, and password of the key.
						</p><pre class="screen">/subsystem=elytron/key-manager=LocalhostKeyManager:add(key-store=LocalhostKeyStore,alias-filter=server,credential-reference={clear-text="key_password"})</pre></li><li class="listitem"><p class="simpara">
							Create a <code class="literal">server-ssl-context</code> in the <code class="literal">elytron</code> subsystem that references the <code class="literal">key-manager</code> that was defined in the previous step.
						</p><pre class="screen">/subsystem=elytron/server-ssl-context=LocalhostSslContext:add(key-manager=LocalhostKeyManager)</pre></li><li class="listitem"><p class="simpara">
							Switch the <code class="literal">https-listener</code> from the legacy <code class="literal">security-realm</code> to the newly created Elytron <code class="literal">ssl-context</code>.
						</p><pre class="screen">batch
/subsystem=undertow/server=default-server/https-listener=https:undefine-attribute(name=security-realm)
/subsystem=undertow/server=default-server/https-listener=https:write-attribute(name=ssl-context,value=LocalhostSslContext)
run-batch</pre></li><li class="listitem"><p class="simpara">
							Reload the server.
						</p><pre class="screen">reload</pre></li></ol></div><p>
					This results in the following <code class="literal">elytron</code> subsystem configuration in the server configuration file.
				</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" ...&gt;
  ...
  &lt;tls&gt;
    &lt;key-stores&gt;
      &lt;key-store name="LocalhostKeyStore"&gt;
        &lt;credential-reference clear-text="keystore_password"/&gt;
        &lt;implementation type="JKS"/&gt;
        &lt;file path="server.keystore" relative-to="jboss.server.config.dir"/&gt;
      &lt;/key-store&gt;
    &lt;/key-stores&gt;
    &lt;key-managers&gt;
      &lt;key-manager name="LocalhostKeyManager" key-store="LocalhostKeyStore"  alias-filter="server"&gt;
        &lt;credential-reference clear-text="key_password"/&gt;
      &lt;/key-manager&gt;
    &lt;/key-managers&gt;
    &lt;server-ssl-contexts&gt;
      &lt;server-ssl-context name="LocalhostSslContext" key-manager="LocalhostKeyManager"/&gt;
    &lt;/server-ssl-contexts&gt;
  &lt;/tls&gt;
&lt;/subsystem&gt;</pre><p>
					This results in the following <code class="literal">undertow</code> subsystem configuration in the server configuration file.
				</p><pre class="programlisting">&lt;https-listener name="https" socket-binding="https" ssl-context="LocalhostSslContext" enable-http2="true"/&gt;</pre><p>
					For more information, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_server_security/#elytron_subsystem">Elytron Subsystem</a> and <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_server_security/#secure_the_management_interfaces">How to Secure the Management Interfaces</a> in <span class="emphasis"><em>How to Configure Server Security</em></span> for JBoss EAP.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_client_cert_ssl_configuration_to_elytron"/>Migrate CLIENT-CERT SSL Authentication to Elytron</h2></div></div></div><p>
					To enable <code class="literal">CLIENT-CERT</code> SSL authentication, add a <code class="literal">truststore</code> element to the <code class="literal">authentication</code> element.
				</p><pre class="programlisting">&lt;security-realm name="ManagementRealm"&gt;
  &lt;server-identities&gt;
    &lt;ssl&gt;
      &lt;keystore path="server.keystore" relative-to="jboss.server.config.dir" keystore-password="<span class="emphasis"><em>KEYSTORE_PASSWORD</em></span>" alias="server" key-password="key_password" /&gt;
    &lt;/ssl&gt;
  &lt;/server-identities&gt;
  &lt;authentication&gt;
    &lt;truststore path="server.truststore" relative-to="jboss.server.config.dir" keystore-password="<span class="emphasis"><em>TRUSTSTORE_PASSWORD</em></span>" /&gt;
    &lt;local default-user="$local"/&gt;
    &lt;properties path="mgmt-users.properties" relative-to="jboss.server.config.dir"/&gt;
  &lt;/authentication&gt;
&lt;/security-realm&gt;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						With this configuration if the <code class="literal">CLIENT-CERT</code> authentication does not occur, clients can fall back to use either the local mechanism or the <code class="literal">username/password</code> authentication mechanism. To make <code class="literal">CLIENT-CERT</code> based authentication mandatory, remove the <code class="literal">local</code> and <code class="literal">properties</code> elements.
					</p></div><p>
					A legacy <code class="literal">truststore</code> can be used in two ways:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<a class="link" href="migrating_to_elytron.html#legacy_truststore_containing_CA" title="Legacy truststore Containing Only CA">Legacy <code class="literal">truststore</code> containing only CA</a>
						</li><li class="listitem">
							<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_identity_management/#configure_authentication_with_certificates">Legacy <code class="literal">truststore</code> containing client’s certificate</a>
						</li></ul></div><h4><a id="legacy_truststore_containing_CA"/>Legacy <code class="literal">truststore</code> Containing Only CA</h4><p>
					Follow these steps to configure the server to prevent users without a valid certificate and private key from accessing the server using Elytron.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Create a <code class="literal">key-store</code> in the <code class="literal">elytron</code> subsystem that specifies the location of the keystore and the password by which it is encrypted. This command assumes the keystore was generated using the keytool command and its type is <code class="literal">JKS</code>.
						</p><pre class="screen">/subsystem=elytron/key-store=LocalhostKeyStore:add(path=server.keystore,relative-to=jboss.server.config.dir,credential-reference={clear-text="keystore_password"},type=JKS)</pre></li><li class="listitem"><p class="simpara">
							Create a <code class="literal">key-store</code> in the <code class="literal">elytron</code> subsystem that specifies the location of the truststore and the password by which it is encrypted. This command assumes the keystore was generated using the keytool command and its type is <code class="literal">JKS</code>.
						</p><pre class="screen">/subsystem=elytron/key-store=TrustStore:add(path=server.truststore,relative-to=jboss.server.config.dir,credential-reference={clear-text="truststore_password"},type=JKS)</pre></li><li class="listitem"><p class="simpara">
							Create a <code class="literal">key-manager</code> in the <code class="literal">elytron</code> subsystem that specifies the previously defined <code class="literal">LocalhostKeyStore</code> keystore, the alias, and password of the key.
						</p><pre class="screen">/subsystem=elytron/key-manager=LocalhostKeyManager:add(key-store=LocalhostKeyStore,alias-filter=server,credential-reference={clear-text="key_password"})</pre></li><li class="listitem"><p class="simpara">
							Create a <code class="literal">trust-manager</code> in the <code class="literal">elytron</code> subsystem that specifies the <code class="literal">key-store</code> of the previously created truststore.
						</p><pre class="screen">/subsystem=elytron/trust-manager=TrustManager:add(key-store=TrustStore)</pre></li><li class="listitem"><p class="simpara">
							Create a <code class="literal">server-ssl-context</code> in the <code class="literal">elytron</code> subsystem that references the previously defined <code class="literal">key-manager</code>, sets the <code class="literal">trust-manager</code> attribute, and enables client authentication.
						</p><pre class="screen">/subsystem=elytron/server-ssl-context=LocalhostSslContext:add(key-manager=LocalhostKeyManager,trust-manager=TrustManager,need-client-auth=true)</pre></li><li class="listitem"><p class="simpara">
							Switch the <code class="literal">https-listener</code> from the legacy <code class="literal">security-realm</code> to the newly created Elytron <code class="literal">ssl-context</code>.
						</p><pre class="screen">batch
/subsystem=undertow/server=default-server/https-listener=https:undefine-attribute(name=security-realm)
/subsystem=undertow/server=default-server/https-listener=https:write-attribute(name=ssl-context,value=LocalhostSslContext)
run-batch</pre></li><li class="listitem"><p class="simpara">
							Reload the server.
						</p><pre class="screen">reload</pre></li></ol></div><p>
					This results in the following <code class="literal">elytron</code> subsystem configuration in the server configuration file.
				</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0"...&gt;
  ...
  &lt;tls&gt;
    &lt;key-stores&gt;
      &lt;key-store name="LocalhostKeyStore"&gt;
        &lt;credential-reference clear-text="keystore_password"/&gt;
        &lt;implementation type="JKS"/&gt;
        &lt;file path="server.keystore" relative-to="jboss.server.config.dir"/&gt;
      &lt;/key-store&gt;
      &lt;key-store name="TrustStore"&gt;
        &lt;credential-reference clear-text="truststore_password"/&gt;
        &lt;implementation type="JKS"/&gt;
        &lt;file path="server.truststore" relative-to="jboss.server.config.dir"/&gt;
      &lt;/key-store&gt;
    &lt;/key-stores&gt;
    &lt;key-managers&gt;
      &lt;key-manager name="LocalhostKeyManager" key-store="LocalhostKeyStore" alias-filter="server"&gt;
        &lt;credential-reference clear-text="key_password"/&gt;
      &lt;/key-manager&gt;
    &lt;/key-managers&gt;
    &lt;trust-managers&gt;
      &lt;trust-manager name="TrustManager" key-store="TrustStore"/&gt;
    &lt;/trust-managers&gt;
    &lt;server-ssl-contexts&gt;
      &lt;server-ssl-context name="LocalhostSslContext" need-client-auth="true" key-manager="LocalhostKeyManager" trust-manager="TrustManager"/&gt;
    &lt;/server-ssl-contexts&gt;
  &lt;/tls&gt;
&lt;/subsystem&gt;</pre><p>
					This results in the following <code class="literal">undertow</code> subsystem configuration in the server configuration file.
				</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:undertow:7.0"&gt;
...
&lt;https-listener name="https" socket-binding="https" ssl-context="LocalhostSslContext" enable-http2="true"/&gt;
...
&lt;/subsystem&gt;</pre><h4><a id="realms_and_domains"/>Realms and Domains</h4><p>
					To allow using the predefined Elytron <code class="literal">ManagementDomain</code> security domain and <code class="literal">ManagementRealm</code> security realm, users are stored in standard properties files.
				</p><pre class="programlisting">&lt;security-domains&gt;
    &lt;security-domain name="ManagementDomain" default-realm="ManagementRealm" permission-mapper="default-permission-mapper"&gt;
        &lt;realm name="ManagementRealm" role-decoder="groups-to-roles"/&gt;
        &lt;realm name="local"/&gt;
    &lt;/security-domain&gt;
&lt;/security-domains&gt;
&lt;security-realms&gt;
    &lt;properties-realm name="ManagementRealm"&gt;
        &lt;users-properties path="mgmt-users.properties" relative-to="jboss.server.config.dir" digest-realm-name="ManagementRealm"/&gt;
        &lt;groups-properties path="mgmt-groups.properties" relative-to="jboss.server.config.dir"/&gt;
    &lt;/properties-realm&gt;
&lt;/security-realms&gt;</pre><p>
					The security realm is used in two situations:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							When certificate authentication fails, the security realm is used in password fallback case.
						</li><li class="listitem">
							When authorization is done for password as well as certificate, the realm provides the roles of individual users.
						</li></ul></div><p>
					Thus, for any client certificate, a user must exist in the security realm.
				</p><h4><a id="principal_decoder"/>Principal Decoder</h4><p>
					When certificate authentication is used and the security realm accepts user names to resolve an identity, there has to be a defined way to obtain the <code class="literal">username</code> from a client certificate.
				</p><p>
					In this case the <code class="literal">CN</code> attribute is used in the certificate subject.
				</p><pre class="screen">/subsystem=elytron/x500-attribute-principal-decoder=x500-decoder:add(attribute-name=CN)</pre><h4><a id="http_authentication_factory"/>HTTP Authentication Factory</h4><p>
					For the HTTP connections, an HTTP authentication factory is defined, using the previously defined resources. It is configured to support <code class="literal">CLIENT_CERT</code> and <code class="literal">DIGEST</code> authentication.
				</p><p>
					Since a properties realm only verifies passwords and is not able to verify client certificates, you need to first add a configuring mechanism factory. This disables certificate verification against the security realm.
				</p><pre class="screen">/subsystem=elytron/configurable-http-server-mechanism-factory=configured-cert:add(http-server-mechanism-factory=global, properties={org.wildfly.security.http.skip-certificate-verification=true})</pre><p>
					The HTTP authentication can be created as:
				</p><pre class="screen">./subsystem=elytron/http-authentication-factory=client-cert-digest:add(http-server-mechanism-factory=configured-cert,security-domain=ManagementDomain,mechanism-configurations=[{mechanism-name=CLIENT_CERT,pre-realm-principal-transformer=x500-decoder},{mechanism-name=DIGEST, mechanism-realm-configurations=[{realm-name=ManagementRealm}]}])</pre><p>
					The above command results in:
				</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;http&gt;
    ...
    &lt;http-authentication-factory name="client-cert-digest" http-server-mechanism-factory="configured-cert" security-domain="ManagementDomain"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="CLIENT_CERT" pre-realm-principal-transformer="x500-decoder"/&gt;
        &lt;mechanism mechanism-name="DIGEST"&gt;
          &lt;mechanism-realm realm-name="ManagementRealm"/&gt;
        &lt;/mechanism&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/http-authentication-factory&gt;
    ...
    &lt;configurable-http-server-mechanism-factory name="configured-cert" http-server-mechanism-factory="configured-cert"&gt;
        &lt;properties&gt;
            &lt;property name="org.wildfly.security.http.skip-certificate-verification" value="true"/&gt;
        &lt;/properties&gt;
    &lt;/configurable-http-server-mechanism-factory&gt;
    ...
  &lt;/http&gt;
  ...
&lt;/subsystem&gt;</pre></div></div></div></body></html>