<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 5. Launching Clustered JBoss EAP</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="launching_clustered_jboss_eap"/>Chapter 5. Launching Clustered JBoss EAP</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="launch_clustered_AMIs_without_mod_cluster_and_VPC"/>Launch Clustered JBoss EAP AMIs (without mod_cluster and VPC)</h1></div></div></div><p>
				This topic lists the steps to launch clustered JBoss EAP AMIs without mod_cluster and VPC.
			</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							You can use the example configuration scripts that are provided with the image.
						</li></ul></div></div><p>
				See <a class="link" href="reference_material.html#system_paths" title="System Paths">System Paths</a> for more details about system paths.
			</p><p>
				See <a class="link" href="reference_material.html#configuring_subsystems_for_cloud_platforms" title="Configuring JBoss EAP Subsystems to Work on Cloud Platforms">Configuring JBoss EAP Subsystems to Work on Cloud Platforms</a> for information about configuring JBoss EAP subsystems for Amazon EC2.
			</p><p>
				To start clustered JBoss EAP AMI on a standalone server instance, you can use the example <code class="literal">/opt/rh/eap7/root/usr/share/wildfly/docs/examples/configs/standalone-ec2-ha.xml</code> file that contains a preconfigured S3_PING JGroups stack. For more information, see <a class="link" href="http://jgroups.org/manual/index.html#_s3_ping">S3_PING</a> in the <span class="emphasis"><em>Reliable group communication with JGroups</em></span> document. This <code class="literal">standalone-ec2-ha.xml</code> profile file must be copied from <code class="literal">/opt/rh/eap7/root/usr/share/wildfly/docs/examples/configs/</code> to the JBoss EAP configuration directory <code class="literal">/opt/rh/eap7/root/usr/share/wildfly/standalone/configuration/</code>. Then, you have to add the following line to the JBoss EAP service configuration file:
			</p><pre class="screen">WILDFLY_SERVER_CONFIG=standalone-ec2-ha.xml</pre><p>
				A unique <code class="literal">instance-id</code> needs to be set for each standalone server instance in the <code class="literal">undertow</code> subsystem. A value for the <code class="literal">instance-id</code> can be set manually by editing the <code class="literal">standalone-ec2-ha.xml</code> file or by using the management CLI. For example, you can set the <code class="literal">instance-id</code> using the management CLI as follows:
			</p><pre class="screen">/subsystem=undertow:write-attribute(name=instance-id,value={${jboss.jvmRoute}})</pre><p>
				A value for <code class="literal">jboss.jvmRoute</code> can then be specified in <code class="literal">standalone.conf</code> using the <code class="literal">JAVA_OPTS</code> variable.
			</p><p>
				The <code class="literal">jgroups</code> subsystem in the EC2 configuration file requires some <code class="literal">S3_PING</code> specific properties to discover cluster members. You must specify access key to S3, secret access key, and the S3 bucket to use for discovery. These properties can either be specified as Java options or put directly into the XML file by editing it or using CLI.
			</p><p>
				You need to create an S3 bucket for discovery. See <a class="link" href="https://aws.amazon.com/documentation/s3">Amazon Simple Storage Service Documentation</a> for more information. You may also have to configure the required permissions. The JGroups stack needs to be bound to an IP address, which is used to communicate with other nodes. This can be done by adding Java options, along with S3 Java options to the <code class="literal">/opt/rh/eap7/root/usr/share/wildfly/bin/standalone.conf</code> file. For example, if the private IP address was <code class="literal">10.10.10.10</code>, then you would add the following line to the <code class="literal">standalone.conf</code> file:
			</p><pre class="screen">JAVA_OPTS="$JAVA_OPTS -Djboss.bind.address.private=10.10.10.10"</pre><p>
				You can deploy a sample application: <code class="literal">/opt/rh/eap7/root/usr/share/java/eap7-jboss-ec2-eap-samples/cluster-demo.war</code> and observe the logs in <code class="literal">/opt/rh/eap7/root/usr/share/wildfly/standalone/log/server.log</code> to see that the JBoss EAP servers have created a cluster.
			</p><h3><a id="for_domain_controller_instance_2"/>For Domain Controller Instance</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
						Copy the <code class="literal">domain-ec2.xml</code> file from <code class="literal">/opt/rh/eap7/root/usr/share/wildfly/docs/examples/configs</code> to the JBoss EAP configuration directory.
					</li><li class="listitem"><p class="simpara">
						Set the following variables in the appropriate service configuration file:
					</p><pre class="screen">WILDFLY_SERVER_CONFIG=domain-ec2.xml
WILDFLY_HOST_CONFIG=host-master.xml</pre></li><li class="listitem"><p class="simpara">
						Add S3 domain controller discovery configuration to the <code class="literal">host-master.xml</code> file:
					</p><pre class="screen">&lt;local&gt;
    &lt;discovery-options&gt;
        &lt;discovery-option name="s3-discovery" module="org.jboss.as.host-controller" code="org.jboss.as.host.controller.discovery.S3Discovery"&gt;
            &lt;property name="access-key" value="S3_ACCESS_KEY"/&gt;
            &lt;property name="secret-access-key" value="S3_SECRET_ACCESS_KEY"/&gt;
            &lt;property name="location" value="S3_BUCKET_NAME"/&gt;
        &lt;/discovery-option&gt;
    &lt;/discovery-options&gt;
&lt;/local&gt;</pre></li><li class="listitem">
						Configure users and add the secret values for users to the host controller instances. For more information, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuration_guide/#create_a_managed_domain_on_two_machines">Create a Managed Domain on Two Machines</a> in the JBoss EAP <span class="emphasis"><em>Configuration Guide</em></span>.
					</li></ol></div><h3><a id="for_host_controller_instance"/>For Host Controller Instance</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
						Set the following variable in the appropriate service configuration file:
					</p><pre class="screen">WILDFLY_HOST_CONFIG=host-slave.xml</pre></li><li class="listitem"><p class="simpara">
						Add S3 domain controller discovery configuration to the <code class="literal">host-slave.xml</code> file:
					</p><pre class="screen">&lt;remote security-realm="ManagementRealm"&gt;
    &lt;discovery-options&gt;
        &lt;discovery-option name="s3-discovery" module="org.jboss.as.host-controller" code="org.jboss.as.host.controller.discovery.S3Discovery"&gt;
            &lt;property name="access-key" value="S3_ACCESS_KEY"/&gt;
            &lt;property name="secret-access-key" value="S3_SECRET_ACCESS_KEY"/&gt;
            &lt;property name="location" value="S3_BUCKET_NAME"/&gt;
        &lt;/discovery-option&gt;
    &lt;/discovery-options&gt;
&lt;/remote&gt;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							For information about S3 domain controller discovery, see <a class="link" href="launching_non_clustered_managed_domain.html#launch_one_or_more_instances_serve_as_host_controllers" title="Launch One or More Instances to Serve as Host Controllers">Launch One or More Instances to Serve as Host Controllers</a>.
						</p></div></li></ol></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
					Running a JBoss EAP cluster in a subnet with network mask smaller than 24-bits or spanning multiple subnets complicates acquiring a unique server peer ID for each cluster member.
				</p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
					The auto-scaling Amazon EC2 feature can be used with JBoss EAP cluster nodes. However, ensure it is tested before deployment. You should ensure that your particular workloads scale to the required number of nodes, and that the performance meets your needs for the instance type you are planning to use, different instance types receive a different share of the EC2 cloud resources.
				</p><p>
					Furthermore, instance locality and current network/storage/host machine/RDS utilization may affect cluster performance. Test with your expected real-life loads and try to account for unexpected conditions.
				</p></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
					The Amazon EC2 <span class="emphasis"><em>scale-down</em></span> action terminates the nodes without any chance to gracefully shut down and as some transactions might be interrupted, other cluster nodes and load balancers need time to fail over. This is likely to impact your application users' experience.
				</p><p>
					It is recommended that you either scale down the application cluster manually by disabling the server from the mod_cluster management interface until processed sessions are completed, or shut down the JBoss EAP instance gracefully using SSH access to the instance or Red Hat JBoss Operations Network.
				</p><p>
					Test your procedure for scaling down does not lead to adverse effects on your users' experience. Additional measures might be required for particular workloads, load balancers, and setups.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="launch_clustered_AMIs_with_mod_cluster_and_VPC"/>Launch Clustered JBoss EAP AMIs (with mod_cluster and VPC)</h1></div></div></div><p>
				This topic lists the steps to launch an Apache HTTP server instance to serve as a <code class="literal">mod_cluster</code> proxy and a NAT instance for the Virtual Private Cloud (VPC).
			</p><p>
				See <a class="link" href="reference_material.html#system_paths" title="System Paths">System Paths</a> for more details about system paths.
			</p><p>
				See <a class="link" href="reference_material.html#configuring_subsystems_for_cloud_platforms" title="Configuring JBoss EAP Subsystems to Work on Cloud Platforms">Configuring JBoss EAP Subsystems to Work on Cloud Platforms</a> for information about configuring JBoss EAP subsystems for Amazon EC2.
			</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							You can use the example configuration scripts that are provided with the image.
						</li></ul></div></div><p>
				An Amazon Virtual Private Cloud (Amazon VPC) is a feature of Amazon Web Services (AWS) that allows you to isolate a set of AWS resources in a private network. The topology and configuration of this private network can be customized to your needs.
			</p><p>
				See <a class="link" href="https://aws.amazon.com/vpc/">Amazon Virtual Private Cloud</a> for more information about Amazon VPC.
			</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					If you start a cluster with a <code class="literal">mod_cluster</code> load balancer inside a VPC, the JBoss EAP servers are inaccessible to public. The <code class="literal">mod_cluster</code> load balancer can be the only endpoint that is connected to the Internet.
				</p></div><p>
				See <a class="link" href="launching_non_clustered_managed_domain.html#launch_instance_to_serve_domain_controller" title="Launch an Instance to Serve as a Domain Controller">Launch an Instance to Serve as a Domain Controller</a> for setting up domain controller instance.
			</p><p>
				See <a class="link" href="launching_non_clustered_managed_domain.html#launch_one_or_more_instances_serve_as_host_controllers" title="Launch One or More Instances to Serve as Host Controllers">Launch One or More Instances to Serve as Host Controllers</a> for setting up host controller instance.
			</p><p>
				See <a class="link" href="launching_non_clustered_managed_domain.html#launch_one_or_more_instances_serve_as_host_controllers" title="Launch One or More Instances to Serve as Host Controllers">Launch One or More Instances to Serve as Host Controllers</a> for information about S3 domain controller discovery.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="discrete"/>To launch clustered AMIs with VPC and mod_cluster</h2></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Configuring the VPC is optional. See the <a class="link" href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/default-vpc.html#detecting-platform">Detecting Your Supported Platforms and Whether You Have a Default VPC</a> section in the Amazon VPC user guide for more information.
					</p></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
							Install <code class="literal">jbcs-httpd24-mod_cluster-native</code> package and all of its dependencies. The <code class="literal">mod_cluster</code> configuration file is installed in <code class="literal">/opt/rh/jbcs-httpd24/root/etc/httpd/conf.d/mod_cluster.conf</code>.
						</li></ol></div><p>
					See the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_core_services_apache_http_server/2.4/html-single/apache_http_server_installation_guide/"><span class="emphasis"><em>Apache HTTP Server Installation Guide</em></span></a> for more information about installation of Red Hat JBoss Core Services Apache HTTP Server.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Disable advertising for <code class="literal">mod_cluster</code>. Add the following to <code class="literal">VirtualHost</code> in the <code class="literal">/opt/rh/jbcs-httpd24/root/etc/httpd/conf.d/mod_cluster.conf</code> configuration file.
						</p><pre class="screen">ServerAdvertise Off
EnableMCPMReceive
# AdvertiseFrequency # comment out AdvertiseFrequency if present</pre></li><li class="listitem">
							Allow ports in <code class="literal">SELinux</code>. If required, configure the <code class="literal">iptables</code>. Ports can be allowed in SELinux by using the <code class="literal">semanage port -a -t http_port_t -p tcp $PORT_NR</code> command.
						</li><li class="listitem"><p class="simpara">
							Configure JBoss EAP to look for <code class="literal">mod_cluster</code> proxy on the address that <code class="literal">mod_cluster</code> listens on.
						</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								An <code class="literal">/opt/rh/eap7/root/usr/share/wildfly/docs/examples/configs/standalone-ec2-ha.xml</code> example configuration file is provided. You need to configure a list of <code class="literal">proxies</code> in the <code class="literal">modcluster</code> subsystem.
							</p><p>
								You can define a list of <code class="literal">proxies</code> using one of the following methods:
							</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
										Define an <code class="literal">outbound-socket-binding</code> called <code class="literal">mod-cluster-proxy1</code> with an appropriate host and port:
									</p><pre class="programlisting">&lt;outbound-socket-binding name="mod-cluster-proxy1"&gt;
    &lt;remote-destination host="${jboss.modcluster.proxy1.host}" port="${jboss.modcluster.proxy1.port}"/&gt;
&lt;/outbound-socket-binding&gt;</pre></li><li class="listitem"><p class="simpara">
										Set the <code class="literal">proxies</code> attribute in the <code class="literal">modcluster</code> subsystem to <code class="literal">mod-cluster-proxy1</code> with an appropriate host and port:
									</p><pre class="screen">/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=mod-cluster-proxy1:add(host={${jboss.modcluster.proxy1.host}}, port={${jboss.modcluster.proxy1.port}})</pre></li></ul></div></div></li></ol></div></div></div></div></body></html>