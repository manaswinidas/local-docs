<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Appendix A. Reference Material</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="appendix"><div class="titlepage"><div><div><h1 class="title"><a id="reference_material"/>Appendix A. Reference Material</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="amazon_EC2_AMIs_for_red_hat_cloud_access_program"/>Amazon EC2 AMIs for Red Hat Cloud Access Program</h1></div></div></div><p>
				AMIs are a basic RPM install of JBoss EAP + JDK in the Red Hat Enterprise Linux image, with potentially an Amazon EC2 example configuration. Advanced scripting is no longer available, however regular bash scripts can be used.
			</p><h3><a id="amis_for_platform_jdk_combinations"/>AMIs for Platform/JDK Combinations:</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						RHEL 6 + Open JDK 8 (1 image)
					</li><li class="listitem">
						RHEL 7 + Open JDK 8 (1 image)
					</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					Both platforms should be of 64-bit architecture.
				</p></div><h3><a id="maintenance_of_amis"/>Maintenance of AMIs</h3><p>
				<code class="literal">yum update</code> should be run regularly, to apply z releases (patches) on EC2. New AMIs for the y releases (minor releases) will be provided by Red Hat.
			</p><h3><a id="scenario_1_supported"/>Scenario 1 (Supported)</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
						Sign up for EC2.
					</li><li class="listitem">
						Sign up for Red Hat Cloud Accces.
					</li><li class="listitem">
						Select the Red Hat AMI from the list of available AMIs.
					</li><li class="listitem">
						(Optional) Customize JBoss EAP configuration using user scripts or <code class="literal">ssh</code>.
					</li><li class="listitem">
						Maintenance: <code class="literal">yum update</code> for z releases, new AMI for the y releases.
					</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="example_host_controller_and_domain_controller"/>Example Configuration Files and Deployments</h1></div></div></div><p>
				The following package adds example deployments for RHEL 7 AMI version:
			</p><pre class="screen">$ rpm -ql eap7-jboss-ec2-eap-samples
/opt/rh/eap7/root/usr/share/java/eap7-jboss-ec2-eap-samples/cluster-demo.war
/opt/rh/eap7/root/usr/share/java/eap7-jboss-ec2-eap-samples/hello.war
/opt/rh/eap7/root/usr/share/java/eap7-jboss-ec2-eap-samples/jboss-as-helloworld-mdb-7.0.0.ER5-redhat-1.war</pre><p>
				The JBoss EAP example configuration files contain a JGroups stack set up for the <code class="literal">S3_PING</code> protocol that can be used for creating clusters across EC2. For the exact location of the example configuration files, see <a class="link" href="reference_material.html#system_paths" title="System Paths">System Paths</a>.
			</p><p>
				Both the configuration files contain the <code class="literal">modcluster</code> subsystem to use proxy mod_cluster discovery instead of advertising, because multicast is disabled on EC2.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="system_paths"/>System Paths</h1></div></div></div><h3><a id="service_configuration_files"/>Service Configuration Files:</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						RHEL 6: /etc/sysconfig/*
					</li><li class="listitem">
						RHEL 7: /etc/opt/rh/eap7/wildfly/*
					</li></ul></div><h3><a id="jboss_eap_home"/>JBoss EAP Home:</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						/opt/rh/eap7/root/usr/share/wildfly/
					</li></ul></div><h3><a id="jboss_eap_configuration_locations"/>JBoss EAP Configuration Locations:</h3><div class="variablelist"><dl class="variablelist"><dt><span class="term">Standalone instance</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									/opt/rh/eap7/root/usr/share/wildfly/standalone/configuration
								</li><li class="listitem">
									/opt/rh/eap7/root/usr/share/wildfly/bin/standalone.conf
								</li></ul></div></dd><dt><span class="term">Managed domain</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									/opt/rh/eap7/root/usr/share/wildfly/bin/domain.conf
								</li><li class="listitem">
									/opt/rh/eap7/root/usr/share/wildfly/domain/configuration
								</li></ul></div></dd></dl></div><h3><a id="jboss_eap_example_configuration_locations"/>JBoss EAP Example Configuration Locations:</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						/opt/rh/eap7/root/usr/share/wildfly/docs/examples/configs/standalone-ec2-ha.xml
					</li><li class="listitem">
						/opt/rh/eap7/root/usr/share/wildfly/docs/examples/configs/standalone-ec2-full-ha.xml
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="launching_on_amazon_ec2_using_script"/>Launching JBoss EAP on Amazon EC2 Using a Script</h1></div></div></div><p>
				The following sample script can be used to start JBoss EAP bound to a public IP address when you launch a JBoss EAP instance on Amazon EC2.
			</p><pre class="screen">#!/bin/bash

# platform dependent variables
if [[ "`cat /etc/redhat-release`" = *"release 7"* ]]; then
    SERVICE_CONF_FILE=/etc/opt/rh/eap7/wildfly/eap7-standalone.conf
    START_COMMAND="systemctl start eap7-standalone"
else
    SERVICE_CONF_FILE=/etc/sysconfig/eap7-standalone
    START_COMMAND="service eap7-standalone start"
fi

# set up addresses
INTERNAL_IP_ADDRESS=`ip addr show | grep eth0 -A 2 | head -n 3 | tail -n 1 | awk '{ print $2 }' | sed "s-/24--g" | cut -d'/' -f1`
echo "JAVA_OPTS=\"$JAVA_OPTS -Djboss.bind.address=$INTERNAL_IP_ADDRESS -Djboss.bind.address.private=$INTERNAL_IP_ADDRESS -Djboss.bind.address.management=$INTERNAL_IP_ADDRESS\"" &gt;&gt; /opt/rh/eap7/root/usr/share/wildfly/bin/standalone.conf

# start EAP
$START_COMMAND</pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_subsystems_for_cloud_platforms"/>Configuring JBoss EAP Subsystems to Work on Cloud Platforms</h1></div></div></div><p>
				Some JBoss EAP subsystems must be configured to work properly on cloud platforms, such as Amazon EC2 and Microsoft Azure. This is required because a JBoss EAP server is usually bound to a cloud virtual machine’s private IP address, for example: <code class="literal">10.x.x.x</code>, which is only visible from within the cloud platform. For certain subsystems, this address must also be mapped to a server’s public IP address, which is visible from outside the cloud.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="web_services"/>Web Services</h2></div></div></div><p>
					When a client makes a web service request using <code class="literal">Service.create(wsdlURL, serviceName);</code>, the user connects to the server public IP address, but is subsequently redirected to an address defined in the server configuration files in the <code class="literal">webservices</code> subsystem. By default, this address is <code class="literal">${jboss.bind.address:127.0.0.1}</code>, which means that on a cloud platform, the caller will be redirected to the server’s private IP address and will be unable to resolve the request. The server’s public IP address has to be configured in the <code class="literal">wsdl-host</code> element, using the following command:
				</p><pre class="screen">/subsystem=webservices:write-attribute(name=wsdl-host,value=PUBLIC_IP_ADDRESS)</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="messaging"/>Messaging</h2></div></div></div><p>
					When using messaging on a cloud platform, the connection factory that the client uses must have a connector pointing to the server’s public IP address.
				</p><p>
					For this reason a new connector and socket binding must be created for JBoss EAP servers running a <code class="literal">full</code> profile.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							The referenced <code class="literal">http-public</code> socket binding must be created within the <code class="literal">socket-binding-group</code>:
						</p><pre class="screen">/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=http-public:add(host=PUBLIC_IP_ADDRESS,port=${jboss.http.port:8080})</pre></li><li class="listitem"><p class="simpara">
							Create the new <code class="literal">http-connector</code> element in the <code class="literal">messaging</code> subsystem:
						</p><pre class="screen">/subsystem=messaging-activemq/server=default/http-connector=http-public-connector:add(endpoint=http-acceptor, socket-binding=http-public)</pre></li><li class="listitem"><p class="simpara">
							Set the <code class="literal">connectors</code> in the <code class="literal">connection-factory</code>, which will be used by clients. For example, configuration of <code class="literal">RemoteConnectionFactory</code> as the default connection will be:
						</p><pre class="screen">/subsystem=messaging-activemq/server=default/connection-factory=RemoteConnectionFactory:write-attribute(name=connectors, value=["http-public-connector"]</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="remoting_configuration_for_high_availability"/>Remoting Configuration for High Availability</h2></div></div></div><p>
					If you are using JBoss EAP HA features with clustered EJBs on a cloud platform, some extra configuration for the <code class="literal">remoting</code> subsystem is required to ensure EJB clients can receive cluster view updates.
				</p><p>
					This is done by configuring <code class="literal">client-mappings</code> for the <code class="literal">remoting</code> subsystem socket binding:
				</p><pre class="screen">/socket-binding-group=standard-sockets/socket-binding=http:write-attribute(name=client-mappings,value=[{ "destination-address" =&gt; "PUBLIC_IP_ADDRESS", "destination-port" =&gt; "8080" }])</pre></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="example_user_data_clustered_eap_instances"/>Example User Data for Clustered JBoss EAP Instances</h1></div></div></div><p>
				The following examples show user data configured for several different server configurations.
			</p><h3><a id="example_file_for_standalone_mode_on_rhel6_7"/>Example: File for Standalone Mode on RHEL6/7</h3><pre class="screen">#!/usr/bin/env bash

# This is a sample script for the user data field for EC2, which demonstrates how to launch a standalone instance using the ec2-ha profile
# This file is for RHEL 6/7, standalone mode only
### This script makes use of the following four Bash variables for clustering setup,
### be sure to add in your own values for these variables here when copy/pasting this
### script into the EC2 user data field

ACCESS_KEY_ID=&lt;your AWS access key&gt;
SECRET_ACCESS_KEY=&lt;your AWS secret access key&gt;
S3_PING_BUCKET=&lt;your bucket name&gt;
NODE_NAME=&lt;your node name&gt;

#### No further modifications should be needed below to run this example ####
# Set the location of JBoss EAP
JBOSS_HOME=/opt/rh/eap7/root/usr/share/wildfly

# Set the internal IP address of this EC2 instance which is mapped to a public address
INTERNAL_IP_ADDRESS=`ip addr show | grep eth0 -A 2 | head -n 3 | tail -n 1 | awk '{ print $2 }' | sed "s-/24--g" | cut -d'/' -f1`

# Set the location of the standalone.conf file and set the command used to start EAP in standalone mode
if [[ "`cat /etc/redhat-release`" = *"release 7"* ]]; then
    SERVICE_CONF_FILE=/etc/opt/rh/eap7/wildfly/eap7-standalone.conf
    START_COMMAND="systemctl start eap7-standalone"
else
    SERVICE_CONF_FILE=/etc/sysconfig/eap7-standalone
    START_COMMAND="service eap7-standalone start"
fi

# Configure JBoss EAP to use the ec2-ha profile
cp /opt/rh/eap7/root/usr/share/wildfly/docs/examples/configs/standalone-ec2-ha.xml $JBOSS_HOME/standalone/configuration/standalone-ec2-ha.xml
echo "WILDFLY_SERVER_CONFIG=standalone-ec2-ha.xml" &gt;&gt; $SERVICE_CONF_FILE
echo "WILDFLY_BIND=$INTERNAL_IP_ADDRESS" &gt;&gt; $SERVICE_CONF_FILE
echo "JAVA_OPTS=\"\$JAVA_OPTS -Djboss.jgroups.s3_ping.access_key='$ACCESS_KEY_ID' -Djboss.jgroups.s3_ping.secret_access_key='$SECRET_ACCESS_KEY' -Djboss.jgroups.s3_ping.bucket='$S3_PING_BUCKET' -Djboss.jvmRoute=$NODE_NAME\"" &gt;&gt; $JBOSS_HOME/bin/standalone.conf
echo "JAVA_OPTS=\"\$JAVA_OPTS -Djboss.bind.address=$INTERNAL_IP_ADDRESS -Djboss.bind.address.private=$INTERNAL_IP_ADDRESS\"" &gt;&gt; $JBOSS_HOME/bin/standalone.conf

# Deploy the sample application from the local filesystem
cp /opt/rh/eap7/root/usr/share/java/eap7-jboss-ec2-eap-samples/cluster-demo.war $JBOSS_HOME/standalone/deployments/

# Start JBoss EAP, note that RHEL 7 does not wait for JBoss EAP to start before returning from the service start. In some cases, there could be a delay of more than 90 seconds.

$START_COMMAND</pre><h3><a id="example_file_for_starting_a_clustered_domain_instance_domain_controller"/>Example: File for Starting a Clustered Domain Instance (Domain Controller)</h3><pre class="screen">#!/usr/bin/env bash

# This is a sample script for the user data field for EC2, which demonstrates how to launch a domain controller with clustering enabled
# This file is for RHEL 6/7, domain controller, domain mode only
### This script makes use of the following Bash variables for clustering and domain
### controller discovery setup, be sure to add in your own values for these variables here
### when copy/pasting this script into the EC2 user data field

ACCESS_KEY_ID=&lt;your access key id&gt;
SECRET_ACCESS_KEY=&lt;your secret access key&gt;
S3_PING_BUCKET=&lt;your s3 ping bucket&gt;

#### No further modifications should be needed below to run this example ####
# Set the location of JBoss EAP
JBOSS_HOME=/opt/rh/eap7/root/usr/share/wildfly
CONF_FILE=/opt/rh/eap7/root/usr/share/wildfly/docs/examples/configs/domain-ec2.xml

# Set the internal IP address of this EC2 instance which is mapped to a public address

INTERNAL_IP_ADDRESS=`ip addr show | grep eth0 -A 2 | head -n 3 | tail -n 1 | awk '{ print $2 }' | sed "s-/24--g" | cut -d'/' -f1`



# Set the location of the domain.conf file and set the command used to start EAP in domain mode
if [[ "`cat /etc/redhat-release`" = *"release 7"* ]]; then
    SERVICE_CONF_FILE=/etc/opt/rh/eap7/wildfly/eap7-domain.conf
    START_COMMAND="systemctl start eap7-domain"
else
    SERVICE_CONF_FILE=/etc/sysconfig/eap7-domain
    START_COMMAND="service eap7-domain start"
fi

# Configure JBoss EAP to use the domain-ec2.xml and host-master.xml configuration files
cp ${CONF_FILE} $JBOSS_HOME/domain/configuration/domain-ec2.xml

echo "WILDFLY_SERVER_CONFIG=domain-ec2.xml" &gt;&gt; $SERVICE_CONF_FILE
echo "WILDFLY_HOST_CONFIG=host-master.xml" &gt;&gt; $SERVICE_CONF_FILE
echo "WILDFLY_BIND=$INTERNAL_IP_ADDRESS" &gt;&gt; $SERVICE_CONF_FILE
echo "JAVA_OPTS=\"\$JAVA_OPTS -Djboss.jgroups.s3_ping.access_key='$ACCESS_KEY_ID' -Djboss.jgroups.s3_ping.secret_access_key='$SECRET_ACCESS_KEY' -Djboss.jgroups.s3_ping.bucket='$S3_PING_BUCKET'\"" &gt;&gt; $JBOSS_HOME/bin/domain.conf

echo "JAVA_OPTS=\"\$JAVA_OPTS -Djboss.bind.address=$INTERNAL_IP_ADDRESS -Djboss.bind.address.private=$INTERNAL_IP_ADDRESS -Djboss.bind.address.management=$INTERNAL_IP_ADDRESS\"" &gt;&gt; $JBOSS_HOME/bin/domain.conf

echo 'HOST_CONTROLLER_JAVA_OPTS="$HOST_CONTROLLER_JAVA_OPTS $JAVA_OPTS"' &gt;&gt; $JBOSS_HOME/bin/domain.conf

# Add a management user with the following credentials:
# User name: admin
# Password: secret_Passw0rd
$JBOSS_HOME/bin/add-user.sh -u admin -p secret_Passw0rd -e -g Management

# Update the main-server-group in domain-ec2.xml to use the ec2-ha profile
$JBOSS_HOME/bin/jboss-cli.sh --commands="embed-host-controller --domain-config=domain-ec2.xml, /server-group=main-server-group:write-attribute(name=profile, value=ha)"

# Need to modify permissions since this script is executed as the root user
chgrp jboss $JBOSS_HOME/domain/configuration/domain_xml_history/
chgrp jboss $JBOSS_HOME/domain/configuration/host_xml_history/
chgrp jboss $JBOSS_HOME/domain/configuration/domain-ec2.xml
chgrp jboss $JBOSS_HOME/domain/log/audit.log
chgrp jboss $JBOSS_HOME/domain/log/host-controller.log
chown jboss $JBOSS_HOME/domain/configuration/domain_xml_history/
chown jboss $JBOSS_HOME/domain/configuration/host_xml_history/
chown jboss $JBOSS_HOME/domain/configuration/domain-ec2.xml
chown jboss $JBOSS_HOME/domain/log/audit.log
chown jboss $JBOSS_HOME/domain/log/host-controller.log

# Configure S3 domain controller discovery
yum install patch -y
cd $JBOSS_HOME/domain/configuration
echo "--- host-master.xml	2016-03-18 17:34:26.000000000 -0400
+++ host-master2.xml	2016-04-11 08:28:02.771000191 -0400
@@ -54,7 +54,15 @@
         &lt;/management-interfaces&gt;
     &lt;/management&gt;
     &lt;domain-controller&gt;
-        &lt;local/&gt;
+&lt;local&gt;
+    &lt;discovery-options&gt;
+        &lt;discovery-option name=\"s3-discovery\" module=\"org.jboss.as.host-controller\" code=\"org.jboss.as.host.controller.discovery.S3Discovery\"&gt;
+            &lt;property name=\"access-key\" value=\"$ACCESS_KEY_ID\"/&gt;
+            &lt;property name=\"secret-access-key\" value=\"$SECRET_ACCESS_KEY\"/&gt;
+            &lt;property name=\"location\" value=\"$S3_PING_BUCKET\"/&gt;
+        &lt;/discovery-option&gt;
+    &lt;/discovery-options&gt;
+&lt;/local&gt;
     &lt;/domain-controller&gt;
     &lt;interfaces&gt;
         &lt;interface name=\"management\"&gt;
" | patch host-master.xml

cd -

# Start JBoss EAP, do not forget that RHEL 7 does not wait for JBoss EAP to start before returning from the service start. In some cases, there could be a delay of more than 90 seconds.

$START_COMMAND
sleep 20
# Set up EC2 HA socket bindings for main server group
$JBOSS_HOME/bin/jboss-cli.sh -c --controller=$INTERNAL_IP_ADDRESS:9990 --timeout=120000 --command='/server-group=main-server-group:write-attribute(name=socket-binding-group,value=ha-sockets)'

# Deploy the sample application from the local filesystem to the main-server-group
$JBOSS_HOME/bin/jboss-cli.sh -c --controller=$INTERNAL_IP_ADDRESS:9990 --timeout=120000 --command='deploy /opt/rh/eap7/root/usr/share/java/eap7-jboss-ec2-eap-samples/cluster-demo.war --server-groups=main-server-group'</pre><h3><a id="example_file_for_starting_a_clustered_domain_instance_host_controller"/>Example: File for Starting a Clustered Domain Instance (Host Controller)</h3><pre class="screen">#!/usr/bin/env bash

# This is a sample script for the user data field for EC2, which demonstrates how to launch a host controller with clustering enabled
# This file is for RHEL 6/7, host controller, domain mode only
### This script makes use of the following Bash variables for clustering and domain
### controller discovery setup, be sure to add in your own values for these variables here
### when copy/pasting this script into the EC2 user data field

ACCESS_KEY_ID=&lt;your access key id&gt;
SECRET_ACCESS_KEY=&lt;your secret access key&gt;
S3_PING_BUCKET=&lt;your s3 ping bucket&gt;

#### No further modifications should be needed below to run this example ####
# Set the location of EAP
JBOSS_HOME=/opt/rh/eap7/root/usr/share/wildfly

# Set the internal IP address of this EC2 instance which is mapped to a public address
INTERNAL_IP_ADDRESS=`ip addr show | grep eth0 -A 2 | head -n 3 | tail -n 1 | awk '{ print $2 }' | sed "s-/24--g" | cut -d'/' -f1`

# Set the location of the domain.conf file and set the command used to start EAP in domain mode
if [[ "`cat /etc/redhat-release`" = *"release 7"* ]]; then
    SERVICE_CONF_FILE=/etc/opt/rh/eap7/wildfly/eap7-domain.conf
    START_COMMAND="systemctl start eap7-domain"
else
    SERVICE_CONF_FILE=/etc/sysconfig/eap7-domain
    START_COMMAND="service eap7-domain start"
fi

# Configure variables needed by JBoss EAP
echo "WILDFLY_BIND=$INTERNAL_IP_ADDRESS" &gt;&gt; $SERVICE_CONF_FILE
echo "WILDFLY_HOST_CONFIG=host-slave.xml" &gt;&gt; $SERVICE_CONF_FILE
echo "JAVA_OPTS=\"\$JAVA_OPTS -Djboss.jgroups.s3_ping.access_key='$ACCESS_KEY_ID' -Djboss.jgroups.s3_ping.secret_access_key='$SECRET_ACCESS_KEY' -Djboss.jgroups.s3_ping.bucket='$S3_PING_BUCKET'\"" &gt;&gt; $JBOSS_HOME/bin/domain.conf
echo "JAVA_OPTS=\"\$JAVA_OPTS -Djboss.bind.address=$INTERNAL_IP_ADDRESS -Djboss.bind.address.private=$INTERNAL_IP_ADDRESS -Djboss.bind.address.management=$INTERNAL_IP_ADDRESS\"" &gt;&gt; $JBOSS_HOME/bin/domain.conf
echo 'HOST_CONTROLLER_JAVA_OPTS="$HOST_CONTROLLER_JAVA_OPTS $JAVA_OPTS"' &gt;&gt; $JBOSS_HOME/bin/domain.conf

# Configure S3 domain controller discovery
yum install patch -y
cd $JBOSS_HOME/domain/configuration

echo "--- host-slave.xml.orig	2016-06-07 09:55:27.183390617 +0200
+++ host-slave.xml	2016-06-07 09:56:52.540170784 +0200
@@ -57,7 +57,11 @@
     &lt;domain-controller&gt;
         &lt;remote security-realm=\"ManagementRealm\"&gt;
             &lt;discovery-options&gt;
-                &lt;static-discovery name=\"primary\" protocol=\"\${jboss.domain.master.protocol:remote}\" host=\"\${jboss.domain.master.address}\" port=\"\${jboss.domain.master.port:9999}\"/&gt;
+                &lt;discovery-option name=\"s3-discovery\" module=\"org.jboss.as.host-controller\" code=\"org.jboss.as.host.controller.discovery.S3Discovery\"&gt;
+                    &lt;property name=\"access-key\" value=\"$ACCESS_KEY_ID\"/&gt;
+                    &lt;property name=\"secret-access-key\" value=\"$SECRET_ACCESS_KEY\"/&gt;
+                    &lt;property name=\"location\" value=\"$S3_PING_BUCKET\"/&gt;
+                &lt;/discovery-option&gt;
             &lt;/discovery-options&gt;
         &lt;/remote&gt;
     &lt;/domain-controller&gt;
" | patch host-slave.xml

sed -i 's/&lt;!--.*--&gt;//g' host-slave.xml # remove nasty '!' signs which break bash
sed -i '/^[ ]*$/d' host-slave.xml # remove nasty lines with ' ' whitespaces which break the patch

EAP_HOST_NAME=`$JBOSS_HOME/bin/jboss-cli.sh --commands="embed-host-controller --host-config=host-slave.xml, :read-resource" | grep \"host\" | cut -d\" -f4`
$JBOSS_HOME/bin/jboss-cli.sh --commands="embed-host-controller --host-config=host-slave.xml, /host=$EAP_HOST_NAME/core-service=management/security-realm=ManagementRealm/server-identity=secret:write-attribute(name=value,value=c2VjcmV0X1Bhc3N3MHJk)"

sed -i 's/&lt;host xmlns="urn:jboss:domain:8.0"&gt;/&lt;host xmlns="urn:jboss:domain:8.0" name="admin"&gt;/' host-slave.xml
sed -i 's/other-server-group/main-server-group/' host-slave.xml

cd -

# Need to modify permissions since this script is executed as the root user
chgrp jboss $JBOSS_HOME/domain/configuration/domain_xml_history/
chgrp jboss $JBOSS_HOME/domain/configuration/host_xml_history/
chgrp jboss $JBOSS_HOME/domain/configuration/domain-ec2.xml
chgrp jboss $JBOSS_HOME/domain/log/audit.log
chgrp jboss $JBOSS_HOME/domain/log/host-controller.log
chown jboss $JBOSS_HOME/domain/configuration/domain_xml_history/
chown jboss $JBOSS_HOME/domain/configuration/host_xml_history/
chown jboss $JBOSS_HOME/domain/configuration/domain-ec2.xml
chown jboss $JBOSS_HOME/domain/log/audit.log
chown jboss $JBOSS_HOME/domain/log/host-controller.log

# Start JBoss EAP, do not forget that RHEL 7 does not wait for JBoss EAP to start before returning from the service start. In some cases, there could be a delay of more than 90 seconds.
$START_COMMAND</pre><p>
				<br/><br/><br/><br/>
			</p><p>
				<span class="emphasis"><em><span class="right">Revised on 2019-05-02 08:51:38 UTC</span></em></span>
			</p></div></div></body></html>