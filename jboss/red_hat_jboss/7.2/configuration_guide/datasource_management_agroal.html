<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 13. Datasource Management With Agroal</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="datasource_management_agroal"/>Chapter 13. Datasource Management With Agroal</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="about_datasources_agroal"/>About the Agroal Datasources Subsystem</h1></div></div></div><p>
				A new <code class="literal">datasources-agroal</code> subsystem was introduced in JBoss EAP 7.2. This is a new high performance direct connection pool backed by the Agroal project. This can be used as an alternative to the current JCA-based <code class="literal">datasources</code> subsystem.
			</p><p>
				The <code class="literal">datasources-agroal</code> subsystem is not available by default and you must <a class="link" href="datasource_management_agroal.html#enable_datasources_agroal" title="Enabling the Agroal Datasources Subsystem">enable it</a> in order to use this new implementation.
			</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
					The <code class="literal">datasources-agroal</code> subsystem is provided as Technology Preview only. Technology Preview features are not supported with Red Hat production service level agreements (SLAs), might not be functionally complete, and Red Hat does not recommend to use them for production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.
				</p><p>
					See <a class="link" href="https://access.redhat.com/support/offerings/techpreview">Technology Preview Features Support Scope</a> on the Red Hat Customer Portal for information about the support scope for Technology Preview features.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="enable_datasources_agroal"/>Enabling the Agroal Datasources Subsystem</h1></div></div></div><p>
				The <code class="literal">datasources-agroal</code> subsystem is not enabled in the default JBoss EAP configuration. Use the following management CLI commands to enable it.
			</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
						Add the extension.
					</p><pre class="screen">/extension=org.wildfly.extension.datasources-agroal:add</pre></li><li class="listitem"><p class="simpara">
						Add the subsystem.
					</p><pre class="screen">/subsystem=datasources-agroal:add</pre></li><li class="listitem"><p class="simpara">
						Reload the server for the changes to take effect.
					</p><pre class="screen">reload</pre></li></ol></div><p>
				This adds the following XML in the server configuration file.
			</p><pre class="programlisting">&lt;server xmlns="urn:jboss:domain:8.0"&gt;
  &lt;extensions&gt;
    ...
    &lt;extension module="org.wildfly.extension.datasources-agroal"/&gt;
    ...
  &lt;/extensions&gt;
  ...
  &lt;subsystem xmlns="urn:jboss:domain:datasources-agroal:1.0"/&gt;
  ...
&lt;/server&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="install_a_jdbc_driver_as_a_core_module_agroal"/>Installing a JDBC Driver as a Core Module for Agroal Datasources</h1></div></div></div><p>
				Before defining Agroal datasources in JBoss EAP for your applications to use, you must first install the appropriate JDBC driver.
			</p><p>
				To install a JDBC driver as a core module for Agroal datasources, you must first <a class="link" href="datasource_management_agroal.html#add_jdbc_driver_core_module_datasources-agroal" title="Add the JDBC Driver as a Core Module">add the JDBC driver as a core module</a> and then <a class="link" href="datasource_management_agroal.html#register_jdbc_driver_agroal" title="Register the JDBC Driver for Agroal Datasources">register the JDBC driver</a> in the <code class="literal">datasources-agroal</code> subsystem.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="add_jdbc_driver_core_module_datasources-agroal"/>Add the JDBC Driver as a Core Module</h2></div></div></div><p>
					JDBC drivers can be installed as a core module using the management CLI using the following steps.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Download the JDBC driver.
						</p><p class="simpara">
							Download the appropriate JDBC driver from your database vendor. See <a class="link" href="datasource_management.html#jdbc_driver_download_locations" title="JDBC Driver Download Locations">JDBC Driver Download Locations</a> for standard download locations for JDBC drivers of common databases.
						</p><p class="simpara">
							Make sure to extract the archive if the JDBC driver JAR file is contained within a ZIP or TAR archive.
						</p></li><li class="listitem">
							Start the JBoss EAP server.
						</li><li class="listitem"><p class="simpara">
							Launch the management CLI.
						</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/jboss-cli.sh</pre></li><li class="listitem"><p class="simpara">
							Use the <code class="literal">module add</code> management CLI command to add the new core module.
						</p><pre class="screen">module add --name=<span class="emphasis"><em>MODULE_NAME</em></span> --resources=<span class="emphasis"><em>PATH_TO_JDBC_JAR</em></span> --dependencies=<span class="emphasis"><em>DEPENDENCIES</em></span></pre><p class="simpara">
							For example, the following command adds a MySQL JDBC driver module.
						</p><pre class="screen">module add --name=com.mysql --resources=<span class="emphasis"><em>/path/to</em></span>/mysql-connector-java-8.0.12.jar --dependencies=javax.api,javax.transaction.api</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
								Using the <code class="literal">module</code> management CLI command to add and remove modules is provided as Technology Preview only. This command is not appropriate for use in a managed domain or when connecting to the management CLI remotely. Modules should be <a class="link" href="overview_of_class_loading_and_modules.html#create_module_manually" title="Create a Custom Module Manually">added</a> and <a class="link" href="overview_of_class_loading_and_modules.html#remove_module_manually" title="Remove a Custom Module Manually">removed</a> manually in a production environment.
							</p><p>
								Technology Preview features are not supported with Red Hat production service level agreements (SLAs), might not be functionally complete, and Red Hat does not recommend to use them for production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.
							</p><p>
								See <a class="link" href="https://access.redhat.com/support/offerings/techpreview">Technology Preview Features Support Scope</a> on the Red Hat Customer Portal for information about the support scope for Technology Preview features.
							</p></div><p class="simpara">
							Execute <code class="literal">module --help</code> for more details on using this command to add and remove modules.
						</p></li></ol></div><p>
					You must next register it as a JDBC driver for it to be referenced by application datasources.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="register_jdbc_driver_agroal"/>Register the JDBC Driver for Agroal Datasources</h2></div></div></div><p>
					After the driver has been <a class="link" href="datasource_management_agroal.html#add_jdbc_driver_core_module_datasources-agroal" title="Add the JDBC Driver as a Core Module">installed as a core module</a>, you must register it as a JDBC driver using the following management CLI command. When running in a managed domain, be sure to precede this command with <code class="literal">/profile=<span class="emphasis"><em>PROFILE_NAME</em></span></code>.
				</p><pre class="screen">/subsystem=datasources-agroal/driver=<span class="emphasis"><em>DRIVER_NAME</em></span>:add(module=<span class="emphasis"><em>MODULE_NAME</em></span>,class=<span class="emphasis"><em>CLASS_NAME</em></span>)</pre><p>
					The <code class="literal"><span class="emphasis"><em>CLASS_NAME</em></span></code> must be a fully qualified class name that implements either <code class="literal">java.sql.Driver</code> or <code class="literal">javax.sql.DataSource</code> for non-XA datasources, or <code class="literal">javax.sql.XADataSource</code> for XA datasources.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="config_agroal_datasources"/>Configuring Agroal Non-XA Datasources</h1></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
					The use of Agroal datasources is provided as Technology Preview only. Technology Preview features are not supported with Red Hat production service level agreements (SLAs), might not be functionally complete, and Red Hat does not recommend to use them for production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.
				</p><p>
					See <a class="link" href="https://access.redhat.com/support/offerings/techpreview">Technology Preview Features Support Scope</a> on the Red Hat Customer Portal for information about the support scope for Technology Preview features.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="create_agroal_datasource"/>Create an Agroal Datasource</h2></div></div></div><p>
					The following management CLI command creates an Agroal datasource. When running in a managed domain, be sure to precede this command with <code class="literal">/profile=<span class="emphasis"><em>PROFILE_NAME</em></span></code>.
				</p><pre class="screen">/subsystem=datasources-agroal/datasource=<span class="emphasis"><em>DATASOURCE_NAME</em></span>:add(jndi-name=<span class="emphasis"><em>JNDI_NAME</em></span>,connection-factory={driver=<span class="emphasis"><em>DRIVER_NAME</em></span>,url=<span class="emphasis"><em>URL</em></span>},connection-pool={max-size=<span class="emphasis"><em>MAX_POOL_SIZE</em></span>})</pre><p>
					For a complete listing of all available Agroal datasource attributes, see the <a class="link" href="reference_material.html#datasources_agroal_attributes" title="Agroal Datasource Attributes">Agroal Datasource Attributes</a> section.
				</p><p>
					See <a class="link" href="datasource_management_agroal.html#example_mysql_agroal_datasource" title="Example MySQL Agroal Datasource">Example MySQL Agroal Datasource</a> for an example Agroal datasource configuration.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="remove_agroal_datasource"/>Remove an Agroal Datasource</h2></div></div></div><p>
					The following management CLI command removes an Agroal datasource. When running in a managed domain, be sure to precede this command with <code class="literal">/profile=<span class="emphasis"><em>PROFILE_NAME</em></span></code>.
				</p><pre class="screen">/subsystem=datasources-agroal/datasource=<span class="emphasis"><em>DATASOURCE_NAME</em></span>:remove</pre></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="config_agroal_xa_datasources"/>Configuring Agroal XA Datasources</h1></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
					The use of Agroal datasources is provided as Technology Preview only. Technology Preview features are not supported with Red Hat production service level agreements (SLAs), might not be functionally complete, and Red Hat does not recommend to use them for production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.
				</p><p>
					See <a class="link" href="https://access.redhat.com/support/offerings/techpreview">Technology Preview Features Support Scope</a> on the Red Hat Customer Portal for information about the support scope for Technology Preview features.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="create_agroal_xa_datasource"/>Create an Agroal XA Datasource</h2></div></div></div><p>
					The following management CLI command creates an Agroal XA datasource. When running in a managed domain, be sure to precede this command with <code class="literal">/profile=<span class="emphasis"><em>PROFILE_NAME</em></span></code>.
				</p><pre class="screen">/subsystem=datasources-agroal/xa-datasource=<span class="emphasis"><em>XA_DATASOURCE_NAME</em></span>:add(jndi-name=<span class="emphasis"><em>JNDI_NAME</em></span>,connection-factory={driver=<span class="emphasis"><em>DRIVER_NAME</em></span>,connection-properties={ServerName=<span class="emphasis"><em>HOST_NAME</em></span>,PortNumber=<span class="emphasis"><em>PORT</em></span>,DatabaseName=<span class="emphasis"><em>DATABASE_NAME</em></span>}},connection-pool={max-size=<span class="emphasis"><em>MAX_POOL_SIZE</em></span>})</pre><p>
					For a complete listing of all available Agroal datasource attributes, see the <a class="link" href="reference_material.html#datasources_agroal_attributes" title="Agroal Datasource Attributes">Agroal Datasource Attributes</a> section.
				</p><p>
					See <a class="link" href="datasource_management_agroal.html#example_mysql_agroal_xa_datasource" title="Example MySQL Agroal XA Datasource">Example MySQL Agroal XA Datasource</a> for an example Agroal XA datasource configuration.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="remove_agroal_xa_datasource"/>Remove an Agroal XA Datasource</h2></div></div></div><p>
					The following management CLI command removes an Agroal XA datasource. When running in a managed domain, be sure to precede this command with <code class="literal">/profile=<span class="emphasis"><em>PROFILE_NAME</em></span></code>.
				</p><pre class="screen">/subsystem=datasources-agroal/xa-datasource=<span class="emphasis"><em>DATASOURCE_NAME</em></span>:remove</pre></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="example_agroal_datasource_configurations"/>Example Agroal Datasource Configurations</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="example_mysql_agroal_datasource"/>Example MySQL Agroal Datasource</h2></div></div></div><p>
					This is an example of a MySQL Agroal datasource configuration with connection and basic security settings.
				</p><h4><a id="example_mysql_agroal_datasource_configuration"/>Example: MySQL Agroal Datasource Configuration</h4><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:datasources-agroal:1.0"&gt;
    &lt;datasource name="ExampleAgroalDS" jndi-name="java:jboss/datasources/ExampleAgroalDS"&gt;
        &lt;connection-factory driver="mysql" url="jdbc:mysql://localhost:3306/jbossdb" username="admin" password="admin"/&gt;
        &lt;connection-pool max-size="30"/&gt;
    &lt;/datasource&gt;
    &lt;drivers&gt;
        &lt;driver name="mysql" module="com.mysql" class="com.mysql.cj.jdbc.Driver"/&gt;
    &lt;/drivers&gt;
&lt;/subsystem&gt;</pre><h4><a id="example_mysql_jdbc_driver_literal_module_xml_literal_file_3"/>Example: MySQL JDBC Driver <code class="literal">module.xml</code> File</h4><pre class="programlisting">&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;module xmlns="urn:jboss:module:1.1" name="com.mysql"&gt;

    &lt;resources&gt;
        &lt;resource-root path="mysql-connector-java-8.0.12.jar"/&gt;
    &lt;/resources&gt;

    &lt;dependencies&gt;
        &lt;module name="javax.api"/&gt;
        &lt;module name="javax.transaction.api"/&gt;
    &lt;/dependencies&gt;
&lt;/module&gt;</pre><h4><a id="example_management_cli_commands_16"/>Example Management CLI Commands</h4><p>
					This example configuration can be achieved by using the following management CLI commands.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Add the MySQL JDBC driver as a core module.
						</p><pre class="screen">module add --name=com.mysql --resources=<span class="emphasis"><em>/path/to/mysql-connector-java-8.0.12.jar</em></span> --dependencies=javax.api,javax.transaction.api</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
								Using the <code class="literal">module</code> management CLI command to add and remove modules is provided as Technology Preview only. This command is not appropriate for use in a managed domain or when connecting to the management CLI remotely. Modules should be <a class="link" href="overview_of_class_loading_and_modules.html#create_module_manually" title="Create a Custom Module Manually">added</a> and <a class="link" href="overview_of_class_loading_and_modules.html#remove_module_manually" title="Remove a Custom Module Manually">removed</a> manually in a production environment.
							</p><p>
								Technology Preview features are not supported with Red Hat production service level agreements (SLAs), might not be functionally complete, and Red Hat does not recommend to use them for production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.
							</p><p>
								See <a class="link" href="https://access.redhat.com/support/offerings/techpreview">Technology Preview Features Support Scope</a> on the Red Hat Customer Portal for information about the support scope for Technology Preview features.
							</p></div></li><li class="listitem"><p class="simpara">
							Register the MySQL JDBC driver.
						</p><pre class="screen">/subsystem=datasources-agroal/driver=mysql:add(module=com.mysql,class=com.mysql.cj.jdbc.Driver)</pre></li><li class="listitem"><p class="simpara">
							Add the MySQL datasource.
						</p><pre class="screen">/subsystem=datasources-agroal/datasource=ExampleAgroalDS:add(jndi-name=java:jboss/datasources/ExampleAgroalDS,connection-factory={driver=mysql,url=jdbc:mysql://localhost:3306/jbossdb,username=admin,password=admin},connection-pool={max-size=30})</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="example_mysql_agroal_xa_datasource"/>Example MySQL Agroal XA Datasource</h2></div></div></div><p>
					This is an example of a MySQL Agroal XA datasource configuration with XA datasource properties and basic security settings.
				</p><h4><a id="example_mysql_agroal_xa_datasource_configuration"/>Example: MySQL Agroal XA Datasource Configuration</h4><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:datasources-agroal:1.0"&gt;
    &lt;xa-datasource name="ExampleAgroalXADS" jndi-name="java:jboss/datasources/ExampleAgroalXADS"&gt;
        &lt;connection-factory driver="mysqlXA" username="admin" password="admin"&gt;
            &lt;connection-properties&gt;
                &lt;property name="ServerName" value="localhost"/&gt;
                &lt;property name="PortNumber" value="3306"/&gt;
                &lt;property name="DatabaseName" value="jbossdb"/&gt;
            &lt;/connection-properties&gt;
        &lt;/connection-factory&gt;
        &lt;connection-pool max-size="30"/&gt;
    &lt;/xa-datasource&gt;
    &lt;drivers&gt;
        &lt;driver name="mysqlXA" module="com.mysql" class="com.mysql.cj.jdbc.MysqlXADataSource"/&gt;
    &lt;/drivers&gt;
&lt;/subsystem&gt;</pre><h4><a id="example_mysql_jdbc_driver_literal_module_xml_literal_file_4"/>Example: MySQL JDBC Driver <code class="literal">module.xml</code> File</h4><pre class="programlisting">&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;module xmlns="urn:jboss:module:1.1" name="com.mysql"&gt;

    &lt;resources&gt;
        &lt;resource-root path="mysql-connector-java-8.0.12.jar"/&gt;
    &lt;/resources&gt;

    &lt;dependencies&gt;
        &lt;module name="javax.api"/&gt;
        &lt;module name="javax.transaction.api"/&gt;
    &lt;/dependencies&gt;
&lt;/module&gt;</pre><h4><a id="example_management_cli_commands_17"/>Example Management CLI Commands</h4><p>
					This example configuration can be achieved by using the following management CLI commands.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Add the MySQL JDBC driver as a core module.
						</p><pre class="screen">module add --name=com.mysql --resources=<span class="emphasis"><em>/path/to/mysql-connector-java-8.0.12.jar</em></span> --dependencies=javax.api,javax.transaction.api</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
								Using the <code class="literal">module</code> management CLI command to add and remove modules is provided as Technology Preview only. This command is not appropriate for use in a managed domain or when connecting to the management CLI remotely. Modules should be <a class="link" href="overview_of_class_loading_and_modules.html#create_module_manually" title="Create a Custom Module Manually">added</a> and <a class="link" href="overview_of_class_loading_and_modules.html#remove_module_manually" title="Remove a Custom Module Manually">removed</a> manually in a production environment.
							</p><p>
								Technology Preview features are not supported with Red Hat production service level agreements (SLAs), might not be functionally complete, and Red Hat does not recommend to use them for production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.
							</p><p>
								See <a class="link" href="https://access.redhat.com/support/offerings/techpreview">Technology Preview Features Support Scope</a> on the Red Hat Customer Portal for information about the support scope for Technology Preview features.
							</p></div></li><li class="listitem"><p class="simpara">
							Register the MySQL XA JDBC driver.
						</p><pre class="screen">/subsystem=datasources-agroal/driver=mysqlXA:add(module=com.mysql,class=com.mysql.cj.jdbc.MysqlXADataSource)</pre></li><li class="listitem"><p class="simpara">
							Add the MySQL XA datasource.
						</p><pre class="screen">/subsystem=datasources-agroal/xa-datasource=ExampleAgroalXADS:add(jndi-name=java:jboss/datasources/ExampleAgroalXADS,connection-factory={driver=mysqlXA,connection-properties={ServerName=localhost,PortNumber=3306,DatabaseName=jbossdb},username=admin,password=admin},connection-pool={max-size=30})</pre></li></ol></div></div></div></div></body></html>