<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 22. Configuring Batch Applications</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_batch_applications"/>Chapter 22. Configuring Batch Applications</h1></div></div></div><p>
			JBoss EAP 7 introduced support for Java batch applications as defined by <a class="link" href="https://www.jcp.org/en/jsr/detail?id=352">JSR-352</a>. You can configure an environment for running batch applications and manage batch jobs using the <code class="literal">batch-jberet</code> subsystem.
		</p><p>
			For information on developing batch applications, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/development_guide/#java_batch_application_development">Java Batch Application Development</a> in the JBoss EAP <span class="emphasis"><em>Development Guide</em></span>.
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_batch_jobs"/>Configuring Batch Jobs</h1></div></div></div><p>
				You can configure settings for batch jobs using the <code class="literal">batch-jberet</code> subsystem, which is based on the JBeret implementation.
			</p><p>
				The default <code class="literal">batch-jberet</code> subsystem configuration defines an in-memory job repository and default thread pool settings.
			</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:batch-jberet:2.0"&gt;
    &lt;default-job-repository name="in-memory"/&gt;
    &lt;default-thread-pool name="batch"/&gt;
    &lt;job-repository name="in-memory"&gt;
        &lt;in-memory/&gt;
    &lt;/job-repository&gt;
    &lt;thread-pool name="batch"&gt;
        &lt;max-threads count="10"/&gt;
        &lt;keepalive-time time="30" unit="seconds"/&gt;
    &lt;/thread-pool&gt;
&lt;/subsystem&gt;</pre><p>
				By default, any batch jobs stopped during a server suspend will be restarted upon server resume. You can set the <code class="literal">restart-jobs-on-resume</code> property to <code class="literal">false</code> to leave jobs in the <code class="literal">STOPPED</code> state instead.
			</p><pre class="screen">/subsystem=batch-jberet:write-attribute(name=restart-jobs-on-resume,value=false)</pre><p>
				You can also configure the settings for batch <a class="link" href="configuring_batch_applications.html#configure_batch_job_repositories" title="Configure Batch Job Repositories">job repositories</a> and <a class="link" href="configuring_batch_applications.html#configure_batch_thread_pools" title="Configure Batch Thread Pools">thread pools</a>.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_batch_job_repositories"/>Configure Batch Job Repositories</h2></div></div></div><p>
					This section shows you how to configure in-memory and JDBC job repositories for storing batch job information using the management CLI. You can also configure job repositories using the management console by navigating to <span class="strong"><strong>Configuration</strong></span> → <span class="strong"><strong>Subsystems</strong></span> → <span class="strong"><strong>Batch (JBeret)</strong></span>, clicking <span class="strong"><strong>View</strong></span>, and selecting either <span class="strong"><strong>In Memory</strong></span> or <span class="strong"><strong>JDBC</strong></span> from the left-hand menu.
				</p><h4><a id="add_an_in_memory_job_repository"/>Add an In-memory Job Repository</h4><p>
					You can add a job repository that stores batch job information in memory.
				</p><pre class="screen">/subsystem=batch-jberet/in-memory-job-repository=<span class="emphasis"><em>REPOSITORY_NAME</em></span>:add</pre><h4><a id="add_a_jdbc_job_repository"/>Add a JDBC Job Repository</h4><p>
					You can add a job repository that stores batch job information in a database. You must specify the name of the datasource for connecting to the database.
				</p><pre class="screen">/subsystem=batch-jberet/jdbc-job-repository=<span class="emphasis"><em>REPOSITORY_NAME</em></span>:add(data-source=<span class="emphasis"><em>DATASOURCE</em></span>)</pre><h4><a id="set_a_default_job_repository"/>Set a Default Job Repository</h4><p>
					You can set an in-memory or JDBC job repository as the default job repository for batch applications.
				</p><pre class="screen">/subsystem=batch-jberet:write-attribute(name=default-job-repository,value=<span class="emphasis"><em>REPOSITORY_NAME</em></span>)</pre><p>
					This will require a server reload.
				</p><pre class="screen">reload</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_batch_thread_pools"/>Configure Batch Thread Pools</h2></div></div></div><p>
					This section shows you how to configure thread pools and thread factories to be used for batch jobs using the management CLI. You can also configure thread pools and thread factories using the management console by navigating to <span class="strong"><strong>Configuration</strong></span> → <span class="strong"><strong>Subsystems</strong></span> → <span class="strong"><strong>Batch (JBeret)</strong></span>, clicking <span class="strong"><strong>View</strong></span>, and selecting either <span class="strong"><strong>Thread Factory</strong></span> or <span class="strong"><strong>Thread Pool</strong></span> from the left-hand menu.
				</p><h4><a id="configure_a_thread_pool"/>Configure a Thread Pool</h4><p>
					When adding a thread pool, you must specify the <code class="literal">max-threads</code>, which should always be greater than <code class="literal">3</code> as two threads are reserved to ensure partition jobs can execute as expected.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Add a thread pool.
						</p><pre class="screen">/subsystem=batch-jberet/thread-pool=<span class="emphasis"><em>THREAD_POOL_NAME</em></span>:add(max-threads=10)</pre></li><li class="listitem"><p class="simpara">
							If desired, set a <code class="literal">keepalive-time</code> value.
						</p><pre class="screen">/subsystem=batch-jberet/thread-pool=<span class="emphasis"><em>THREAD_POOL_NAME</em></span>:write-attribute(name=keepalive-time,value={time=60,unit=SECONDS})</pre></li></ol></div><h4><a id="use_a_thread_factory"/>Use a Thread Factory</h4><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Add a thread factory.
						</p><pre class="screen">/subsystem=batch-jberet/thread-factory=<span class="emphasis"><em>THREAD_FACTORY_NAME</em></span>:add</pre></li><li class="listitem"><p class="simpara">
							Configure the desired attributes for the thread factory.
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									<code class="literal">group-name</code> - The name of a thread group to create for this thread factory.
								</li><li class="listitem">
									<code class="literal">priority</code> - The thread priority of created threads.
								</li><li class="listitem"><p class="simpara">
									<code class="literal">thread-name-pattern</code> - The template used to create names for threads. The following patterns may be used:
								</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
											<code class="literal">%%</code> - A percent sign
										</li><li class="listitem">
											<code class="literal">%t</code> - The per-factory thread sequence number
										</li><li class="listitem">
											<code class="literal">%g</code> - The global thread sequence number
										</li><li class="listitem">
											<code class="literal">%f</code> - The factory sequence number
										</li><li class="listitem">
											<code class="literal">%i</code> - The thread ID
										</li></ul></div></li></ul></div></li><li class="listitem"><p class="simpara">
							Assign the thread factory to a thread pool.
						</p><pre class="screen">/subsystem=batch-jberet/thread-pool=<span class="emphasis"><em>THREAD_POOL_NAME</em></span>:write-attribute(name=thread-factory,value=<span class="emphasis"><em>THREAD_FACTORY_NAME</em></span>)</pre><p class="simpara">
							This will require a server reload.
						</p><pre class="screen">reload</pre></li></ol></div><h4><a id="set_a_default_thread_pool"/>Set a Default Thread Pool</h4><p>
					You can set a different thread pool as the default thread pool.
				</p><pre class="screen">/subsystem=batch-jberet:write-attribute(name=default-thread-pool,value=<span class="emphasis"><em>THREAD_POOL_NAME</em></span>)</pre><p>
					This will require a server reload.
				</p><pre class="screen">reload</pre><h4><a id="view_thread_pool_statistics"/>View Thread Pool Statistics</h4><p>
					You can view runtime information about a batch thread pool using the <code class="literal">read-resource</code> management CLI operation. You must use the <code class="literal">include-runtime=true</code> parameter in order to see this runtime information.
				</p><pre class="screen">/subsystem=batch-jberet/thread-pool=<span class="emphasis"><em>THREAD_POOL_NAME</em></span>:read-resource(include-runtime=true)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "active-count" =&gt; 0,
        "completed-task-count" =&gt; 0L,
        "current-thread-count" =&gt; 0,
        "keepalive-time" =&gt; undefined,
        "largest-thread-count" =&gt; 0,
        "max-threads" =&gt; 15,
        "name" =&gt; "<span class="emphasis"><em>THREAD_POOL_NAME</em></span>",
        "queue-size" =&gt; 0,
        "rejected-count" =&gt; 0,
        "task-count" =&gt; 0L,
        "thread-factory" =&gt; "<span class="emphasis"><em>THREAD_FACTORY_NAME</em></span>"
    }
}</pre><p>
					You can also view runtime information for batch thread pools using the management console by navigating to the <span class="strong"><strong>Batch</strong></span> subsystem from the <span class="strong"><strong>Runtime</strong></span> tab.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="managing_batch_jobs"/>Managing Batch Jobs</h1></div></div></div><p>
				The <code class="literal">batch-jberet</code> subsystem resource for deployments allows you to start, stop, restart, and view execution details for batch jobs. Batch jobs can be managed from the <a class="link" href="configuring_batch_applications.html#manage_batch_cli" title="Manage Batch Jobs from the Management CLI">management CLI</a> or the <a class="link" href="configuring_batch_applications.html#manage_batch_console" title="Manage Batch Jobs from the Management Console">management console</a>.
			</p><h3><a id="manage_batch_cli"/>Manage Batch Jobs from the Management CLI</h3><h4><a id="restart_a_batch_job"/>Restart a Batch Job</h4><p>
				You can restart a job that is in a <code class="literal">STOPPED</code> or <code class="literal">FAILED</code> state by providing its execution ID and optionally any properties to use when restarting the batch job.
			</p><pre class="screen">/deployment=<span class="emphasis"><em>DEPLOYMENT_NAME</em></span>/subsystem=batch-jberet:restart-job(execution-id=<span class="emphasis"><em>EXECUTION_ID</em></span>,properties={<span class="emphasis"><em>PROPERTY</em></span>=<span class="emphasis"><em>VALUE</em></span>})</pre><p>
				The execution ID must be the most recent execution of the job instance.
			</p><h4><a id="start_a_batch_job"/>Start a Batch Job</h4><p>
				You can start a batch job by providing the job XML file and optionally any properties to use when starting the batch job.
			</p><pre class="screen">/deployment=<span class="emphasis"><em>DEPLOYMENT_NAME</em></span>/subsystem=batch-jberet:start-job(job-xml-name=<span class="emphasis"><em>JOB_XML_NAME</em></span>,properties={<span class="emphasis"><em>PROPERTY</em></span>=<span class="emphasis"><em>VALUE</em></span>})</pre><h4><a id="stop_a_batch_job"/>Stop a Batch Job</h4><p>
				You can stop a running batch job by providing its execution ID.
			</p><pre class="screen">/deployment=<span class="emphasis"><em>DEPLOYMENT_NAME</em></span>/subsystem=batch-jberet:stop-job(execution-id=<span class="emphasis"><em>EXECUTION_ID</em></span>)</pre><h4><a id="view_batch_job_execution_details"/>View Batch Job Execution Details</h4><p>
				You can view the details of batch job executions. You must use the <code class="literal">include-runtime=true</code> parameter on the <code class="literal">read-resource</code> operation in order to see this runtime information.
			</p><pre class="screen">/deployment=<span class="emphasis"><em>DEPLOYMENT_NAME</em></span>/subsystem=batch-jberet:read-resource(recursive=true,include-runtime=true)
{
    "outcome" =&gt; "success",
    "result" =&gt; {"job" =&gt; {"import-file" =&gt; {
        "instance-count" =&gt; 2,
        "running-executions" =&gt; 0,
        "execution" =&gt; {
            "2" =&gt; {
                "batch-status" =&gt; "COMPLETED",
                "create-time" =&gt; "2016-04-11T22:03:12.708-0400",
                "end-time" =&gt; "2016-04-11T22:03:12.718-0400",
                "exit-status" =&gt; "COMPLETED",
                "instance-id" =&gt; 58L,
                "last-updated-time" =&gt; "2016-04-11T22:03:12.719-0400",
                "start-time" =&gt; "2016-04-11T22:03:12.708-0400"
            },
            "1" =&gt; {
                "batch-status" =&gt; "FAILED",
                "create-time" =&gt; "2016-04-11T21:57:17.567-0400",
                "end-time" =&gt; "2016-04-11T21:57:17.596-0400",
                "exit-status" =&gt; "Error : org.hibernate.exception.ConstraintViolationException: could not execute statement",
                "instance-id" =&gt; 15L,
                "last-updated-time" =&gt; "2016-04-11T21:57:17.597-0400",
                "start-time" =&gt; "2016-04-11T21:57:17.567-0400"
            }
        }
    }}}
}</pre><h3><a id="manage_batch_console"/>Manage Batch Jobs from the Management Console</h3><p>
				To manage batch jobs from the management console, navigate to the <span class="strong"><strong>Runtime</strong></span> tab, select the server, select <span class="strong"><strong>Batch (JBeret)</strong></span>, and choose the job from the list.
			</p><h4><a id="restart_a_batch_job_2"/>Restart a Batch Job</h4><p>
				Restart a <code class="literal">STOPPED</code> job by selecting the execution and clicking <span class="strong"><strong>Restart</strong></span>.
			</p><h4><a id="start_a_batch_job_2"/>Start a Batch Job</h4><p>
				Start a new execution of a batch job by selecting the job and choosing <span class="strong"><strong>Start</strong></span> from the drop down.
			</p><h4><a id="stop_a_batch_job_2"/>Stop a Batch Job</h4><p>
				Stop a running batch job by selecting the execution and clicking <span class="strong"><strong>Stop</strong></span>.
			</p><h4><a id="view_batch_job_execution_details_2"/>View Batch Job Execution Details</h4><p>
				Job execution details are shown for each execution listed in the table.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configure_batch_job_security"/>Configure Security for Batch Jobs</h1></div></div></div><p>
				You can configure the <code class="literal">batch-jberet</code> subsystem to run batch jobs with an Elytron security domain. This allows batch jobs to be securely suspended and resumed by the same secured identity. For example, a secured RESTful endpoint is created to initiate batch jobs using the <code class="literal">batch-jberet</code> subsystem. If both the RESTful endpoint and <code class="literal">batch-jberet</code> subsystem were secured using the same security domain, or the <code class="literal">batch-jberet</code> security domain trusted the RESTful endpoint’s security domain, batch jobs initiated in this manner could be securely paused and resumed by the same secured identity.
			</p><p>
				Use the following management CLI command to update the <code class="literal">security-domain</code> attribute to configure security for batch jobs.
			</p><pre class="screen">/subsystem=batch-jberet:write-attribute(name=security-domain, value=ExampleDomain)

reload</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					Batch jobs require the <code class="literal">org.wildfly.extension.batch.jberet.deployment.BatchPermission</code> permission. It provides <code class="literal">start</code>, <code class="literal">stop</code>, <code class="literal">restart</code>, <code class="literal">abandon</code>, and <code class="literal">read</code> permissions that align with <code class="literal">javax.batch.operations.JobOperator</code>. The <code class="literal">default-permission-mapper</code> mapper provides the <code class="literal">org.wildfly.extension.batch.jberet.deployment.BatchPermission</code> permission.
				</p></div></div></div></body></html>