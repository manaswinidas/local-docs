<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 24. Configuring High Availability</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_high_availability"/>Chapter 24. Configuring High Availability</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="intro_to_ha"/>Introduction to High Availability</h1></div></div></div><p>
				JBoss EAP provides the following <span class="emphasis"><em>high availability</em></span> services to guarantee the availability of deployed Java EE applications.
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Load balancing</span></dt><dd>
							This allows a service to handle a large number of requests by spreading the workload across multiple servers. A client can have timely responses from the service even in the event of a high volume of requests.
						</dd><dt><span class="term">Failover</span></dt><dd>
							This allows a client to have uninterrupted access to a service even in the event of hardware or network failures. If the service fails, another cluster member takes over the client’s requests so that it can continue processing.
						</dd></dl></div><p>
				<span class="emphasis"><em>Clustering</em></span> is a term that encompasses all of these capabilities. Members of a cluster can be configured to share workloads, referred to as load balancing, and pick up client processing in the event of a failure of another cluster member, referred to as failover.
			</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					It is important to keep in mind that the JBoss EAP operating mode chosen, either <span class="emphasis"><em>standalone server</em></span> or <span class="emphasis"><em>managed domain</em></span>, pertains to how you want to manage your servers. High availability services can be configured in JBoss EAP regardless of its operating mode.
				</p></div><p>
				JBoss EAP supports high availability at several different levels using various components. Some of those components of the runtime and your applications that can be made highly-available are:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						Instances of the application server
					</li><li class="listitem">
						Web applications, when used in conjunction with the internal JBoss Web Server, Apache HTTP Server, Microsoft IIS, or Oracle iPlanet Web Server
					</li><li class="listitem">
						Stateful and stateless session Enterprise JavaBeans (EJBs)
					</li><li class="listitem">
						Single sign-on (SSO) mechanisms
					</li><li class="listitem">
						HTTP sessions
					</li><li class="listitem">
						JMS services and message-driven beans (MDBs)
					</li><li class="listitem">
						Singleton MSC services
					</li><li class="listitem">
						Singleton deployments
					</li></ul></div><p>
				Clustering is made available to JBoss EAP by the <a class="link" href="configuring_high_availability.html#cluster_communication_jgroups" title="Cluster Communication with JGroups"><code class="literal">jgroups</code></a>, <a class="link" href="configuring_high_availability.html#infinispan" title="Infinispan"><code class="literal">infinispan</code></a>, and <a class="link" href="configuring_high_availability.html#mod_cluster-config" title="The mod_cluster HTTP Connector"><code class="literal">modcluster</code></a> subsystems. The <span class="emphasis"><em>ha</em></span> and <span class="emphasis"><em>full-ha</em></span> profiles have these systems enabled. In JBoss EAP, these services start up and shut down on demand, but they will only start up if an application configured as <span class="emphasis"><em>distributable</em></span> is deployed on the servers.
			</p><p>
				See the JBoss EAP <span class="emphasis"><em>Development Guide</em></span> for how to <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/development_guide/#enable_session_replication_in_your_application">mark an application as distributable</a>.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="cluster_communication_jgroups"/>Cluster Communication with JGroups</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="about_jgroups"/>About JGroups</h2></div></div></div><p>
					JGroups is a toolkit for reliable messaging and can be used to create clusters whose nodes can send messages to each other.
				</p><p>
					The <code class="literal">jgroups</code> subsystem provides group communication support for high availability services in JBoss EAP. It allows you to configure named channels and protocol stacks as well as view runtime statistics for channels. The <code class="literal">jgroups</code> subsystem is available when using a configuration that provides high availability capabilities, such as the <span class="emphasis"><em>ha</em></span> or <span class="emphasis"><em>full-ha</em></span> profile in a managed domain, or the <code class="literal">standalone-ha.xml</code> or <code class="literal">standalone-full-ha.xml</code> configuration file for a standalone server.
				</p><p>
					JBoss EAP is preconfigured with two JGroups stacks:
				</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">udp </span></dt><dd>
								The nodes in the cluster use User Datagram Protocol (UDP) multicasting to communicate with each other. This is the default stack.
							</dd><dt><span class="term">tcp </span></dt><dd>
								The nodes in the cluster use Transmission Control Protocol (TCP) to communicate with each other.
							</dd></dl></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						TCP has more overhead and is often considered slower than UDP since it handles error checking, packet ordering, and congestion control itself. JGroups handles these features for UDP, whereas TCP guarantees them itself. TCP is a good choice when using JGroups on unreliable or high congestion networks, or when multicast is not available.
					</p></div><p>
					You can use the preconfigured stacks or define your own to suit your system’s specific requirements. For additional information on the available protocols and their attributes, see the following sections.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<a class="link" href="reference_material.html#jgroups_subsystem_attributes" title="JGroups Subsystem Attributes">JGroups Subsystem Attributes</a>
						</li><li class="listitem">
							<a class="link" href="reference_material.html#jgroups_protocols" title="JGroups Protocols">JGroups Protocols</a>
						</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="switch_default_jgroups_channel_tcp"/>Switch the Default JGroups Channel to Use TCP</h2></div></div></div><p>
					By default, cluster nodes communicate using the UDP protocol. The default <code class="literal">ee</code> JGroups channel uses the predefined <code class="literal">udp</code> protocol stack.
				</p><pre class="programlisting">&lt;channels default="ee"&gt;
  &lt;channel name="ee" stack="udp"/&gt;
&lt;/channels&gt;
&lt;stacks&gt;
  &lt;stack name="udp"&gt;
    &lt;transport type="UDP" socket-binding="jgroups-udp"/&gt;
    &lt;protocol type="PING"/&gt;
    ...
  &lt;/stack&gt;
  &lt;stack name="tcp"&gt;
    &lt;transport type="TCP" socket-binding="jgroups-tcp"/&gt;
    &lt;protocol type="MPING" socket-binding="jgroups-mping"/&gt;
    ...
  &lt;/stack&gt;
&lt;/stacks&gt;</pre><p>
					Some networks only allow TCP to be used. Use the following management CLI command to switch the <code class="literal">ee</code> channel to use the preconfigured <code class="literal">tcp</code> stack.
				</p><pre class="screen">/subsystem=jgroups/channel=ee:write-attribute(name=stack,value=tcp)</pre><p>
					This default <code class="literal">tcp</code> stack uses the <code class="literal">MPING</code> protocol, which uses IP multicast to discover the initial cluster membership. See the following sections for configuring stacks for alternative membership discovery protocols:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Using the <a class="link" href="configuring_high_availability.html#configure_tcpping_stack" title="Configure TCPPING">TCPPING</a> protocol to define a static cluster membership list.
						</li><li class="listitem">
							Using the <a class="link" href="configuring_high_availability.html#configure_tcpgossip_stack" title="Configure TCPGOSSIP">TCPGOSSIP</a> protocol to use an external gossip router to discover the members of a cluster.
						</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_tcpping_stack"/>Configure TCPPING</h2></div></div></div><p>
					This procedure creates a new JGroups stack that uses the <code class="literal">TCPPING</code> protocol to define a static cluster membership list. A base script is provided that creates a <code class="literal">tcpping</code> stack and sets the default <code class="literal">ee</code> channel to use this new stack. The management CLI commands in this script must be customized for your environment and will be processed as a batch.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Copy the following script into a text editor and save it to the local file system.
						</p><pre class="screen"># Define the socket bindings
/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=jgroups-host-a:add(host=<span class="emphasis"><em>HOST_A</em></span>,port=7600)
/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=jgroups-host-b:add(host=<span class="emphasis"><em>HOST_B</em></span>,port=7600)
batch
# Add the tcpping stack
/subsystem=jgroups/stack=tcpping:add
/subsystem=jgroups/stack=tcpping/transport=TCP:add(socket-binding=jgroups-tcp)
/subsystem=jgroups/stack=tcpping/protocol=TCPPING:add(socket-bindings=[jgroups-host-a,jgroups-host-b])
/subsystem=jgroups/stack=tcpping/protocol=MERGE3:add
/subsystem=jgroups/stack=tcpping/protocol=FD_SOCK:add
/subsystem=jgroups/stack=tcpping/protocol=FD_ALL:add
/subsystem=jgroups/stack=tcpping/protocol=VERIFY_SUSPECT:add
/subsystem=jgroups/stack=tcpping/protocol=pbcast.NAKACK2:add
/subsystem=jgroups/stack=tcpping/protocol=UNICAST3:add
/subsystem=jgroups/stack=tcpping/protocol=pbcast.STABLE:add
/subsystem=jgroups/stack=tcpping/protocol=pbcast.GMS:add
/subsystem=jgroups/stack=tcpping/protocol=MFC:add
/subsystem=jgroups/stack=tcpping/protocol=FRAG2:add
# Set tcpping as the stack for the ee channel
/subsystem=jgroups/channel=ee:write-attribute(name=stack,value=tcpping)
run-batch
reload</pre><p class="simpara">
							Note that the order of protocols defined is important. You can also insert a protocol at a particular index by passing an <code class="literal">add-index</code> value to the <code class="literal">add</code> command. The index is zero-based, so the following management CLI command adds the <code class="literal">UNICAST3</code> protocol as the seventh protocol.
						</p><pre class="screen">/subsystem=jgroups/stack=tcpping/protocol=UNICAST3:add(add-index=6)</pre></li><li class="listitem"><p class="simpara">
							Modify the script for your environment.
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									If you are running in a managed domain, you must specify which profile to update by preceding the <code class="literal">/subsystem=jgroups</code> commands with <code class="literal">/profile=<span class="emphasis"><em>PROFILE_NAME</em></span></code>.
								</li><li class="listitem"><p class="simpara">
									Adjust the following properties as appropriate for your environment:
								</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
											<code class="literal">socket-bindings</code>: A comma-separated list of the host and port combinations that are considered well-known and will be available to look up the initial membership. See <a class="link" href="network_and_port_configuration.html#configuring_socket_bindings" title="Configuring Socket Bindings">Configuring Socket Bindings</a> for more information on defining socket bindings.
										</li><li class="listitem">
											<code class="literal">initial_hosts</code>: A comma-separated list of the host and port combinations, using the syntax <code class="literal"><span class="emphasis"><em>HOST</em></span>[<span class="emphasis"><em>PORT</em></span>]</code>, that are considered well-known and will be available to look up the initial membership, for example, <code class="literal">host1[1000],host2[2000]</code>.
										</li><li class="listitem">
											<code class="literal">port_range</code>: This property is used to extend the <code class="literal">initial_hosts</code> port range by the specified value. For example, if you set the <code class="literal">initial_hosts</code> to <code class="literal">host1[1000],host2[2000]</code>, and the <code class="literal">port_range</code> to <code class="literal">1</code>, the <code class="literal">initial_hosts</code> setting expands to <code class="literal">host1[1000],host1[1001],host2[2000],host2[2001]</code>. This property only works with the <code class="literal">initial_hosts</code> property.
										</li></ul></div></li></ul></div></li><li class="listitem"><p class="simpara">
							Run the script by passing the script file to the management CLI.
						</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/jboss-cli.sh --connect --file=<span class="emphasis"><em>/path/to/SCRIPT_NAME</em></span></pre></li></ol></div><p>
					The TCPPING stack is now available and TCP is used for network communication.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_tcpgossip_stack"/>Configure TCPGOSSIP</h2></div></div></div><p>
					This procedure creates a new JGroups stack that uses the <code class="literal">TCPGOSSIP</code> protocol to use an external gossip router to discover the members of a cluster. A base script is provided that creates a <code class="literal">tcpgossip</code> stack and sets the default <code class="literal">ee</code> channel to use this new stack. The management CLI commands in this script must be customized for your environment and will be processed as a batch.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Copy the following script into a text editor and save it to the local file system.
						</p><pre class="screen"># Define the socket bindings
/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=jgroups-host-a:add(host=<span class="emphasis"><em>HOST_A</em></span>,port=13001)
batch
# Add the tcpgossip stack
/subsystem=jgroups/stack=tcpgossip:add
/subsystem=jgroups/stack=tcpgossip/transport=TCP:add(socket-binding=jgroups-tcp)
/subsystem=jgroups/stack=tcpgossip/protocol=TCPGOSSIP:add(socket-bindings=[jgroups-host-a])
/subsystem=jgroups/stack=tcpgossip/protocol=MERGE3:add
/subsystem=jgroups/stack=tcpgossip/protocol=FD_SOCK:add
/subsystem=jgroups/stack=tcpgossip/protocol=FD_ALL:add
/subsystem=jgroups/stack=tcpgossip/protocol=VERIFY_SUSPECT:add
/subsystem=jgroups/stack=tcpgossip/protocol=pbcast.NAKACK2:add
/subsystem=jgroups/stack=tcpgossip/protocol=UNICAST3:add
/subsystem=jgroups/stack=tcpgossip/protocol=pbcast.STABLE:add
/subsystem=jgroups/stack=tcpgossip/protocol=pbcast.GMS:add
/subsystem=jgroups/stack=tcpgossip/protocol=MFC:add
/subsystem=jgroups/stack=tcpgossip/protocol=FRAG2:add
# Set tcpgossip as the stack for the ee channel
/subsystem=jgroups/channel=ee:write-attribute(name=stack,value=tcpgossip)
run-batch
reload</pre><p class="simpara">
							Note that the order of protocols defined is important. You can also insert a protocol at a particular index by passing an <code class="literal">add-index</code> value to the <code class="literal">add</code> command. The index is zero-based, so the following management CLI command adds the <code class="literal">UNICAST3</code> protocol as the seventh protocol.
						</p><pre class="screen">/subsystem=jgroups/stack=tcpgossip/protocol=UNICAST3:add(add-index=6)</pre></li><li class="listitem"><p class="simpara">
							Modify the script for your environment.
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									If you are running in a managed domain, you must specify which profile to update by preceding the <code class="literal">/subsystem=jgroups</code> commands with <code class="literal">/profile=<span class="emphasis"><em>PROFILE_NAME</em></span></code>.
								</li><li class="listitem"><p class="simpara">
									Adjust the following properties as appropriate for your environment:
								</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
											<code class="literal">socket-bindings</code>: A comma-separated list of the host and port combinations that are considered well-known and will be available to look up the initial membership. See <a class="link" href="network_and_port_configuration.html#configuring_socket_bindings" title="Configuring Socket Bindings">Configuring Socket Bindings</a> for more information on defining socket bindings.
										</li><li class="listitem">
											<code class="literal">initial_hosts</code>: A comma-separated list of the host and port combinations, using the syntax <code class="literal"><span class="emphasis"><em>HOST</em></span>[<span class="emphasis"><em>PORT</em></span>]</code>, that are considered well-known and will be available to look up the initial membership, for example, <code class="literal">host1[1000],host2[2000]</code>.
										</li><li class="listitem">
											<code class="literal">port_range</code>: This property is used to extend the <code class="literal">initial_hosts</code> port range by the specified value. For example, if you set the <code class="literal">initial_hosts</code> to <code class="literal">host1[1000],host2[2000]</code>, and the <code class="literal">port_range</code> to <code class="literal">1</code>, the <code class="literal">initial_hosts</code> setting expands to <code class="literal">host1[1000],host1[1001],host2[2000],host2[2001]</code>. This property only works with the <code class="literal">initial_hosts</code> property.
										</li><li class="listitem">
											<code class="literal">reconnect_interval</code>: The interval in milliseconds by which a disconnected stub attempts to reconnect to the gossip router.
										</li><li class="listitem">
											<code class="literal">sock_conn_timeout</code>: The maximum time for socket creation. The default is <code class="literal">1000</code> milliseconds.
										</li><li class="listitem">
											<code class="literal">sock_read_timeout</code>: The maximum time in milliseconds to block on a read. A value of <code class="literal">0</code> will block indefinitely.
										</li></ul></div></li></ul></div></li><li class="listitem"><p class="simpara">
							Run the script by passing the script file to the management CLI.
						</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/jboss-cli.sh --connect --file=<span class="emphasis"><em>/path/to/SCRIPT_NAME</em></span></pre></li></ol></div><p>
					The TCPGOSSIP stack is now available and TCP is used for network communication. This stack is configured for use with a gossip router so that JGroups cluster members can find other cluster members.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="binding_jgroups_to_a_network_interface"/>Binding JGroups to a Network Interface</h2></div></div></div><p>
					By default, JGroups only binds to the <code class="literal">private</code> network interface, which points to localhost in the default configuration. For security reasons, JGroups will not bind to the network interface defined by the <code class="literal">-b</code> argument specified during JBoss EAP startup, as clustering traffic should not be exposed on a public network interface.
				</p><p>
					See the <a class="link" href="network_and_port_configuration.html" title="Chapter 4. Network and Port Configuration">Network and Port Configuration</a> chapter in this guide for information about how to configure network interfaces.
				</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						For security reasons, JGroups should only be bound to a non-public network interface. For performance reasons, we also recommend that the network interface for JGroups traffic should be part of a dedicated Virtual Local Area Network (VLAN).
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="securing_cluster"/>Securing a Cluster</h2></div></div></div><p>
					There are several concerns to address in order to run a cluster securely:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Preventing unauthorized nodes from joining the cluster. This is addressed by requiring <a class="link" href="configuring_high_availability.html#configure_jgroups_auth" title="Configuring Authentication">authentication</a>.
						</li><li class="listitem">
							Preventing non-members from communicating with cluster members. This is addressed by <a class="link" href="configuring_high_availability.html#configure_jgroups_encryption" title="Configuring Encryption">encrypting messages</a>.
						</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="configure_jgroups_auth"/>Configuring Authentication</h3></div></div></div><p>
						JGroups authentication is performed by the <code class="literal">AUTH</code> protocol. The purpose is to ensure that only authenticated nodes can join a cluster.
					</p><p>
						In the applicable server configuration file, add the <code class="literal">AUTH</code> protocol with the appropriate property settings. The <code class="literal">AUTH</code> protocol should be configured immediately before the <code class="literal">pbcast.GMS</code> protocol.
					</p><p>
						The following examples demonstrate using <code class="literal">AUTH</code> with different forms of authorization tokens.
					</p><h5><a id="auth_with_a_simple_token"/>AUTH with a Simple Token</h5><pre class="programlisting">...
&lt;protocol type="pbcast.STABLE"/&gt;
&lt;auth-protocol type="AUTH"&gt;
  &lt;plain-token&gt;
    &lt;shared-secret-reference clear-text="<span class="emphasis"><em>my_password</em></span>"/&gt;
  &lt;/plain-token&gt;
&lt;/auth-protocol&gt;
&lt;protocol type="pbcast.GMS"/&gt;
...</pre><h5><a id="auth_with_a_digest_algorithm_token"/>AUTH with a Digest Algorithm Token</h5><p>
						This format can be used with any digest algorithm, for example MD5 or SHA-2. The default digest algorithm in JBoss EAP 7.2 is SHA-256, the strongest digest algorithm required to be supported by the JVM. Many JVMs will additionally implement SHA-512.
					</p><pre class="programlisting">...
&lt;protocol type="pbcast.STABLE"/&gt;
&lt;auth-protocol type="AUTH"&gt;
  &lt;digest-token algorithm="SHA-512"&gt;
    &lt;shared-secret-reference clear-text="<span class="emphasis"><em>my_password</em></span>"/&gt;
  &lt;/digest-token&gt;
&lt;/auth-protocol&gt;
&lt;protocol type="pbcast.GMS"/&gt;
...</pre><h5><a id="auth_with_an_x509_token"/>AUTH with an X509 Token</h5><p>
						This example creates a new keystore in the <code class="literal">elytron</code> subsystem, and references it in the JGroups <code class="literal">AUTH</code> configuration.
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Create the keystore:
							</p><pre class="screen">$ keytool -genkeypair -alias jgroups_key -keypass my_password -storepass my_password -storetype jks -keystore jgroups.keystore -keyalg RSA</pre></li><li class="listitem"><p class="simpara">
								Add the keystore to the <code class="literal">elytron</code> subsystem using the management CLI:
							</p><pre class="screen">/subsystem=elytron/key-store=jgroups-token-store:add(type=jks,path=/path/to/jgroups.keystore,credential-reference={clear-text=my_password}, required=true)</pre></li><li class="listitem"><p class="simpara">
								In the JGroups stack definition, configure <code class="literal">AUTH</code> to use the keystore:
							</p><pre class="programlisting">...
&lt;protocol type="pbcast.STABLE"/&gt;
&lt;auth-protocol type="AUTH"&gt;
  &lt;cipher-token algorithm="RSA" key-alias="jgroups_key" key-store="jgroups-token-store"&gt;
    &lt;shared-secret-reference clear-text="my_password"/&gt;
    &lt;key-credential-reference clear-text="my_password"/&gt;
  &lt;/cipher-token&gt;
&lt;/auth-protocol&gt;
&lt;protocol type="pbcast.GMS"/&gt;
...</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="configure_jgroups_encryption"/>Configuring Encryption</h3></div></div></div><p>
						To encrypt messages, JGroups uses a secret key that is shared by the members of a cluster. The sender encrypts the message using the shared secret key, and the receiver decrypts the message using the same secret key. With <a class="link" href="configuring_high_availability.html#using_sym_encrypt" title="Using Symmetric Encryption">symmetric encryption</a>, which is configured using the <code class="literal">SYM_ENCRYPT</code> protocol, nodes use a shared keystore to retrieve the secret key. With <a class="link" href="configuring_high_availability.html#using_asym_encrypt" title="Using Asymmetric Encryption">asymmetric encryption</a>, which is configured using the <code class="literal">ASYM_ENCRYPT</code> protocol, nodes retrieve the secret key from the coordinator of the cluster after being authenticated using <code class="literal">AUTH</code>.
					</p><h5><a id="using_sym_encrypt"/>Using Symmetric Encryption</h5><p>
						In order to use <code class="literal">SYM_ENCRYPT</code>, you must set up a keystore that will be referenced in the JGroups configuration for each node.
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Create a keystore.
							</p><p class="simpara">
								In the following command, replace <code class="literal"><span class="emphasis"><em>VERSION</em></span></code> with the appropriate JGroups JAR version and <code class="literal"><span class="emphasis"><em>PASSWORD</em></span></code> with a keystore password.
							</p><pre class="screen">$ java -cp <span class="emphasis"><em>EAP_HOME</em></span>/modules/system/layers/base/org/jgroups/main/jgroups-<span class="emphasis"><em>VERSION</em></span>.jar org.jgroups.demos.KeyStoreGenerator --alg AES --size 128 --storeName defaultStore.keystore --storepass <span class="emphasis"><em>PASSWORD</em></span> --alias mykey</pre><p class="simpara">
								This will generate a <code class="literal">defaultStore.keystore</code> file that will be referenced in the JGroups configuration.
							</p></li><li class="listitem"><p class="simpara">
								Once the keystore has been generated it is defined in the <code class="literal">SYM_PROTOCOL</code> using one of two methods.
							</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
										Specify the keystore <a class="link" href="configuring_high_availability.html#using_sym_encrypt_by_directly_referencing_keystore" title="Using Symmetric Encryption by Directly Referencing the Keystore">directly in the configuration</a>.
									</li><li class="listitem">
										Reference the keystore <a class="link" href="configuring_high_availability.html#using_sym_encrypt_with_elytron" title="Using Symmetric Encryption with Elytron">using the Elytron subsystem</a>.
									</li></ul></div></li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							Configuring <code class="literal">AUTH</code> is optional when using <code class="literal">SYM_ENCRYPT</code>.
						</p></div><h5><a id="using_sym_encrypt_by_directly_referencing_keystore"/>Using Symmetric Encryption by Directly Referencing the Keystore</h5><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Configure the <code class="literal">SYM_ENCRYPT</code> protocol in the <code class="literal">jgroups</code> subsystem.
							</p><p class="simpara">
								In the applicable server configuration file, add the <code class="literal">SYM_ENCRYPT</code> protocol with the appropriate property settings. This protocol will reference the previously created keystore. The <code class="literal">SYM_ENCRYPT</code> protocol should be configured immediately before the <code class="literal">pbcast.NAKACK2</code> protocol.
							</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:jgroups:6.0"&gt;
  &lt;stacks&gt;
    &lt;stack name="udp"&gt;
      &lt;transport type="UDP" socket-binding="jgroups-udp"/&gt;
      &lt;protocol type="PING"/&gt;
      &lt;protocol type="MERGE3"/&gt;
      &lt;protocol type="FD_SOCK"/&gt;
      &lt;protocol type="FD_ALL"/&gt;
      &lt;protocol type="VERIFY_SUSPECT"/&gt;
      &lt;protocol type="SYM_ENCRYPT"&gt;
        &lt;property name="provider"&gt;SunJCE&lt;/property&gt;
        &lt;property name="sym_algorithm"&gt;AES&lt;/property&gt;
        &lt;property name="encrypt_entire_message"&gt;true&lt;/property&gt;
        &lt;property name="keystore_name"&gt;<span class="emphasis"><em>/path/to/defaultStore.keystore</em></span>&lt;/property&gt;
        &lt;property name="store_password"&gt;<span class="emphasis"><em>PASSWORD</em></span>&lt;/property&gt;
        &lt;property name="alias"&gt;mykey&lt;/property&gt;
      &lt;/protocol&gt;
      &lt;protocol type="pbcast.NAKACK2"/&gt;
      &lt;protocol type="UNICAST3"/&gt;
      &lt;protocol type="pbcast.STABLE"/&gt;
      &lt;protocol type="pbcast.GMS"/&gt;
      &lt;protocol type="UFC"/&gt;
      &lt;protocol type="MFC"/&gt;
      &lt;protocol type="FRAG2"/&gt;
    &lt;/stack&gt;
  &lt;/stacks&gt;
&lt;/subsystem&gt;</pre></li></ol></div><h5><a id="using_sym_encrypt_with_elytron"/>Using Symmetric Encryption with Elytron</h5><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Using the management CLI, create a keystore in the <code class="literal">elytron</code> subsystem that references the <code class="literal">defaultStore.keystore</code> created in <a class="link" href="configuring_high_availability.html#using_sym_encrypt" title="Using Symmetric Encryption">using symmetric encryption</a>.
							</p><pre class="screen">/subsystem=elytron/key-store=jgroups-keystore:add(path=/path/to/defaultStore.keystore,credential-reference={clear-text=<span class="emphasis"><em>PASSWORD</em></span>},type=JCEKS)</pre></li><li class="listitem"><p class="simpara">
								Add the <code class="literal">SYM_ENCRYPT</code> protocol in the <code class="literal">jgroups</code> subsystem with the appropriate property settings. The <code class="literal">SYM_ENCRYPT</code> protocol should be configured immediately before the <code class="literal">pbcast.NAKACK2</code> protocol, as seen in the following configuration.
							</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:jgroups:6.0"&gt;
  &lt;stacks&gt;
    &lt;stack name="udp"&gt;
      &lt;transport type="UDP" socket-binding="jgroups-udp"/&gt;
      &lt;protocol type="PING"/&gt;
      &lt;protocol type="MERGE3"/&gt;
      &lt;protocol type="FD_SOCK"/&gt;
      &lt;protocol type="FD_ALL"/&gt;
      &lt;protocol type="VERIFY_SUSPECT"/&gt;
      &lt;encrypt-protocol type="SYM_ENCRYPT" key-alias="mykey" key-store="jgroups-keystore"&gt;
        &lt;key-credential-reference clear-text="<span class="emphasis"><em>PASSWORD</em></span>"/&gt;
        &lt;property name="provider"&gt;SunJCE&lt;/property&gt;
        &lt;property name="encrypt_entire_message"&gt;true&lt;/property&gt;
      &lt;/encrypt-protocol&gt;
      &lt;protocol type="pbcast.NAKACK2"/&gt;
      &lt;protocol type="UNICAST3"/&gt;
      &lt;protocol type="pbcast.STABLE"/&gt;
      &lt;protocol type="pbcast.GMS"/&gt;
      &lt;protocol type="UFC"/&gt;
      &lt;protocol type="MFC"/&gt;
      &lt;protocol type="FRAG2"/&gt;
    &lt;/stack&gt;
  &lt;/stacks&gt;
&lt;/subsystem&gt;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
									The above example uses a clear text password; however, a credential store may also be defined to define the password outside of the configuration file. For more information on configuring this store, see the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_server_security/#credential_store">Credential Store</a> section in the <span class="emphasis"><em>How to Configure Server Security</em></span> guide.
								</p></div></li></ol></div><h5><a id="using_asym_encrypt"/>Using Asymmetric Encryption</h5><p>
						In order to use <code class="literal">ASYM_ENCRYPT</code> the <code class="literal">AUTH</code> protocol must be defined. See the <a class="link" href="configuring_high_availability.html#configure_jgroups_auth" title="Configuring Authentication">Configuring Authentication</a> section for instructions on configuring the <code class="literal">AUTH</code> protocol in the <code class="literal">jgroups</code> subsystem.
					</p><p>
						The <code class="literal">ASYM_ENCRYPT</code> is configured using one of two methods.
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								Generate a secret key and reference it <a class="link" href="configuring_high_availability.html#using_asym_encrypt_generating_secret_key" title="Using Asymmetric Encryption by Generating a Secret Key">directly in the configuration</a>.
							</li><li class="listitem">
								Create a keystore and reference it <a class="link" href="configuring_high_availability.html#using_asym_encrypt_with_elytron" title="Using Asymmetric Encryption with Elytron">using the Elytron subsystem</a>.
							</li></ul></div><h5><a id="using_asym_encrypt_generating_secret_key"/>Using Asymmetric Encryption by Generating a Secret Key</h5><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Configure the <code class="literal">ASYM_ENCRYPT</code> protocol in the <code class="literal">jgroups</code> subsystem.
							</p><p class="simpara">
								In the applicable server configuration file, add the <code class="literal">ASYM_ENCRYPT</code> protocol with the appropriate property settings. The <code class="literal">ASYM_ENCRYPT</code> protocol should be configured immediately before the <code class="literal">pbcast.NAKACK2</code> protocol, as seen in the following configuration.
							</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:jgroups:6.0"&gt;
  &lt;stacks&gt;
    &lt;stack name="udp"&gt;
      &lt;transport type="UDP" socket-binding="jgroups-udp"/&gt;
      &lt;protocol type="PING"/&gt;
      &lt;protocol type="MERGE3"/&gt;
      &lt;protocol type="FD_SOCK"/&gt;
      &lt;protocol type="FD_ALL"/&gt;
      &lt;protocol type="VERIFY_SUSPECT"/&gt;
      &lt;protocol type="ASYM_ENCRYPT"&gt;
        &lt;property name="encrypt_entire_message"&gt;true&lt;/property&gt;
        &lt;property name="sym_keylength"&gt;128&lt;/property&gt;
        &lt;property name="sym_algorithm"&gt;AES/ECB/PKCS5Padding&lt;/property&gt;
        &lt;property name="asym_keylength"&gt;512&lt;/property&gt;
        &lt;property name="asym_algorithm"&gt;RSA&lt;/property&gt;
      &lt;/protocol&gt;
      &lt;protocol type="pbcast.NAKACK2"/&gt;
      &lt;protocol type="UNICAST3"/&gt;
      &lt;protocol type="pbcast.STABLE"/&gt;
      &lt;!-- Configure AUTH protocol here --&gt;
      &lt;protocol type="pbcast.GMS"/&gt;
      &lt;protocol type="UFC"/&gt;
      &lt;protocol type="MFC"/&gt;
      &lt;protocol type="FRAG2"/&gt;
    &lt;/stack&gt;
  &lt;/stacks&gt;
&lt;/subsystem&gt;</pre></li></ol></div><h5><a id="using_asym_encrypt_with_elytron"/>Using Asymmetric Encryption with Elytron</h5><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Create a keystore to contain the key pair. The following command creates a keystore with the <code class="literal">mykey</code> entry.
							</p><pre class="screen">$ keytool -genkeypair -alias mykey -keyalg RSA -keysize 1024 -keystore defaultKeystore.keystore -dname "CN=localhost" -keypass secret -storepass secret</pre></li><li class="listitem"><p class="simpara">
								Using the management CLI, create a keystore in the <code class="literal">elytron</code> subsystem that references the <code class="literal">defaultStore.keystore</code>.
							</p><pre class="screen">/subsystem=elytron/key-store=jgroups-keystore:add(path=/path/to/defaultStore.keystore,credential-reference={clear-text=<span class="emphasis"><em>PASSWORD</em></span>},type=JCEKS)</pre></li><li class="listitem"><p class="simpara">
								Add the <code class="literal">ASYM_ENCRYPT</code> protocol in the <code class="literal">jgroups</code> subsystem with the appropriate property settings. The <code class="literal">ASYM_ENCRYPT</code> protocol should be configured immediately before the <code class="literal">pbcast.NAKACK2</code> protocol, as seen in the following configuration.
							</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:jgroups:6.0"&gt;
  &lt;stacks&gt;
    &lt;stack name="udp"&gt;
      &lt;transport type="UDP" socket-binding="jgroups-udp"/&gt;
      &lt;protocol type="PING"/&gt;
      &lt;protocol type="MERGE3"/&gt;
      &lt;protocol type="FD_SOCK"/&gt;
      &lt;protocol type="FD_ALL"/&gt;
      &lt;protocol type="VERIFY_SUSPECT"/&gt;
      &lt;encrypt-protocol type="ASYM_ENCRYPT" key-alias="mykey" key-store="jgroups-keystore"&gt;
        &lt;key-credential-reference clear-text="secret" /&gt;
        &lt;property name="encrypt_entire_message"&gt;true&lt;/property&gt;
      &lt;/encrypt-protocol&gt;
      &lt;protocol type="pbcast.NAKACK2"/&gt;
      &lt;protocol type="UNICAST3"/&gt;
      &lt;protocol type="pbcast.STABLE"/&gt;
      &lt;!-- Configure AUTH protocol here --&gt;
      &lt;protocol type="pbcast.GMS"/&gt;
      &lt;protocol type="UFC"/&gt;
      &lt;protocol type="MFC"/&gt;
      &lt;protocol type="FRAG2"/&gt;
    &lt;/stack&gt;
  &lt;/stacks&gt;
&lt;/subsystem&gt;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
									The above example uses a clear text password; however, a credential store may also be defined to define the password outside of the configuration file. For more information on configuring this store, see the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_server_security/#credential_store">Credential Store</a> section in the <span class="emphasis"><em>How to Configure Server Security</em></span> guide.
								</p></div></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_jgroups_thread_pools"/>Configure JGroups Thread Pools</h2></div></div></div><p>
					The <code class="literal">jgroups</code> subsystem contains the <code class="literal">default</code>, <code class="literal">internal</code>, <code class="literal">oob</code>, and <code class="literal">timer</code> thread pools. These pools can be configured for any JGroups stack.
				</p><p>
					The following table lists the attributes you can configure for each thread pool and the default value for each.
				</p><div class="informaltable"><table border="1"><colgroup><col class="col_1"/><col class="col_2"/><col class="col_3"/><col class="col_4"/><col class="col_5"/></colgroup><thead><tr><th style="text-align: left" valign="top">Thread Pool Name</th><th style="text-align: left" valign="top">keepalive-time</th><th style="text-align: left" valign="top">max-threads</th><th style="text-align: left" valign="top">min-threads</th><th style="text-align: left" valign="top">queue-length</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
									default
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									60000L
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									300
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									20
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									100
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									internal
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									60000L
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									4
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									2
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									100
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									oob
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									60000L
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									300
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									20
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									0
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									timer
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									5000L
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									4
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									2
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									500
								</p>
								 </td></tr></tbody></table></div><p>
					Use the following syntax to configure a JGroups thread pool using the management CLI.
				</p><pre class="screen">/subsystem=jgroups/stack=<span class="emphasis"><em>STACK_TYPE</em></span>/transport=<span class="emphasis"><em>TRANSPORT_TYPE</em></span>/thread-pool=<span class="emphasis"><em>THREAD_POOL_NAME</em></span>:write-attribute(name=<span class="emphasis"><em>ATTRIBUTE_NAME</em></span>, value=<span class="emphasis"><em>ATTRIBUTE_VALUE</em></span>)</pre><p>
					The following is an example of the management CLI command to set the <code class="literal">max-threads</code> value to <code class="literal">500</code> in the <code class="literal">default</code> thread pool for the <code class="literal">udp</code> stack.
				</p><pre class="screen">/subsystem=jgroups/stack=udp/transport=UDP/thread-pool=default:write-attribute(name="max-threads", value="500")</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_jgroups_send_receive_buffers"/>Configure JGroups Send and Receive Buffers</h2></div></div></div><h4><a id="resolving_buffer_size_warnings"/>Resolving Buffer Size Warnings</h4><p>
					By default, JGroups is configured with certain send and receive buffer values; however, your operating system may limit the available buffer sizes and JBoss EAP may not be able to use its configured buffer values. In this situation you will see warnings in the JBoss EAP logs similar to the following:
				</p><pre class="screen">WARNING [org.jgroups.protocols.UDP] (ServerService Thread Pool -- 68)
JGRP000015: the send buffer of socket DatagramSocket was set to 640KB, but the OS only allocated 212.99KB.
This might lead to performance problems. Please set your max send buffer in the OS correctly (e.g. net.core.wmem_max on Linux)
WARNING [org.jgroups.protocols.UDP] (ServerService Thread Pool -- 68)
JGRP000015: the receive buffer of socket DatagramSocket was set to 20MB, but the OS only allocated 212.99KB.
This might lead to performance problems. Please set your max receive buffer in the OS correctly (e.g. net.core.rmem_max on Linux)</pre><p>
					To resolve this, consult your operating system documentation for instructions on how to increase the buffer size. For Red Hat Enterprise Linux systems, edit <code class="literal">/etc/sysctl.conf</code> as the root user to configure maximum values for buffer sizes that will survive system restarts. For example:
				</p><pre class="screen"># Allow a 25MB UDP receive buffer for JGroups
net.core.rmem_max = 26214400
# Allow a 1MB UDP send buffer for JGroups
net.core.wmem_max = 1048576</pre><p>
					After modifying <code class="literal">/etc/sysctl.conf</code>, run <code class="literal">sysctl -p</code> for the changes to take effect.
				</p><h4><a id="configuring_jgroups_buffer_sizes"/>Configuring JGroups Buffer Sizes</h4><p>
					You can configure the JGroups buffer sizes that JBoss EAP uses by setting the following transport properties on the UDP and TCP JGroups stacks.
				</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">UDP Stack</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
										<code class="literal">ucast_recv_buf_size</code>
									</li><li class="listitem">
										<code class="literal">ucast_send_buf_size</code>
									</li><li class="listitem">
										<code class="literal">mcast_recv_buf_size</code>
									</li><li class="listitem">
										<code class="literal">mcast_send_buf_size</code>
									</li></ul></div></dd><dt><span class="term">TCP Stack</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
										<code class="literal">recv_buf_size</code>
									</li><li class="listitem">
										<code class="literal">send_buf_size</code>
									</li></ul></div></dd></dl></div><p>
					JGroups buffer sizes can be configured using the management console or the management CLI.
				</p><p>
					Use the following syntax to set a JGroups buffer size property using the management CLI.
				</p><pre class="screen">/subsystem=jgroups/stack=<span class="emphasis"><em>STACK_NAME</em></span>/transport=<span class="emphasis"><em>TRANSPORT</em></span>/property=<span class="emphasis"><em>PROPERTY_NAME</em></span>:add(value=<span class="emphasis"><em>BUFFER_SIZE</em></span>)</pre><p>
					The following is an example management CLI command to set the <code class="literal">recv_buf_size</code> property to <code class="literal">20000000</code> on the <code class="literal">tcp</code> stack.
				</p><pre class="screen">/subsystem=jgroups/stack=tcp/transport=<span class="emphasis"><em>TRANSPORT</em></span>/property=recv_buf_size:add(value=20000000)</pre><p>
					JGroups buffer sizes can also be configured using the management console by navigating to the <span class="strong"><strong>JGroups</strong></span> subsystem from the <span class="strong"><strong>Configuration</strong></span> tab, clicking <span class="strong"><strong>View</strong></span>, selecting the <span class="strong"><strong>Stack</strong></span> tab, choosing the appropriate stack, clicking <span class="strong"><strong>Transport</strong></span>, and editing the <span class="strong"><strong>Properties</strong></span> field.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="tuning_jgroups_subsystem"/>Tuning the JGroups Subsystem</h2></div></div></div><p>
					For tips on monitoring and optimizing performance for the <code class="literal">jgroups</code> subsystem, see the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/performance_tuning_guide/#jgroups_tuning">JGroups Subsystem Tuning</a> section of the <span class="emphasis"><em>Performance Tuning Guide</em></span>.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="jgroups_troubleshooting"/>JGroups Troubleshooting</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="jgroups_nodes_do_not_form_cluster"/>Nodes Do Not Form a Cluster</h3></div></div></div><p>
						Make sure your machine is set up correctly for IP multicast. There are two test programs that ship with JBoss EAP that can be used to test IP multicast: <code class="literal">McastReceiverTest</code> and <code class="literal">McastSenderTest</code>.
					</p><p>
						In a terminal, start <code class="literal">McastReceiverTest</code>.
					</p><pre class="screen">$ java -cp <span class="emphasis"><em>EAP_HOME</em></span>/bin/client/jboss-client.jar org.jgroups.tests.McastReceiverTest -mcast_addr 230.11.11.11 -port 5555</pre><p>
						Then in another terminal window, start <code class="literal">McastSenderTest</code>.
					</p><pre class="screen">$ java -cp <span class="emphasis"><em>EAP_HOME</em></span>/bin/client/jboss-client.jar org.jgroups.tests.McastSenderTest -mcast_addr 230.11.11.11 -port 5555</pre><p>
						If you want to bind to a specific network interface card (NIC), use <code class="literal">-bind_addr <span class="emphasis"><em>YOUR_BIND_ADDRESS</em></span></code>, where <code class="literal"><span class="emphasis"><em>YOUR_BIND_ADDRESS</em></span></code> is the IP address of the NIC to which you want to bind. Use this parameter in both the sender and the receiver.
					</p><p>
						When you type in the <code class="literal">McastSenderTest</code> terminal window, you should see the output in the <code class="literal">McastReceiverTest</code> window. If you do not, try the following steps.
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								Increase the time-to-live for multicast packets by adding <code class="literal">-ttl <span class="emphasis"><em>VALUE</em></span></code> to the sender command. The default used by this test program is <code class="literal">32</code> and the <code class="literal"><span class="emphasis"><em>VALUE</em></span></code> must be no greater than <code class="literal">255</code>.
							</li><li class="listitem">
								If the machines have multiple interfaces, verify that you are using the correct interface.
							</li><li class="listitem">
								Contact a system administrator to make sure that multicast will work on the interface you have chosen.
							</li></ul></div><p>
						Once you know multicast is working properly on each machine in your cluster, you can repeat the above test to test the network, putting the sender on one machine and the receiver on another.
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="jgroups_missing_heartbeats_fd"/>Causes of Missing Heartbeats in Failure Detection</h3></div></div></div><p>
						Sometimes a cluster member is suspected by failure detection (FD) because a heartbeat acknowledgement has not been received for some time <code class="literal">T</code>, which is defined by <code class="literal">timeout</code> and <code class="literal">max_tries</code>.
					</p><p>
						For an example cluster of nodes A, B, C, and D, where A pings B, B pings C, C pings D, and D pings A, C can be suspected for any of the following reasons:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								B or C are running at 100% CPU for more than <code class="literal">T</code> seconds. So even if C sends a heartbeat acknowledgement to B, B may not be able to process it because it is at 100% CPU usage.
							</li><li class="listitem">
								B or C are garbage collecting, which results in the same situation as above.
							</li><li class="listitem">
								A combination of the two cases above.
							</li><li class="listitem">
								The network loses packets. This usually happens when there is a lot of traffic on the network, and the switch starts dropping packets, usually broadcasts first, then IP multicasts, and TCP packets last.
							</li><li class="listitem">
								B or C are processing a callback. For example, if C received a remote method call over its channel that takes <code class="literal">T</code> + 1 seconds to process, during this time C will not process any other messages, including heartbeats. Therefore, B will not receive the heartbeat acknowledgement and will suspect C.
							</li></ul></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="infinispan"/>Infinispan</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="about_infinispan"/>About Infinispan</h2></div></div></div><p>
					Infinispan is a Java data grid platform that provides a <a class="link" href="http://www.jcp.org/en/jsr/detail?id=107">JSR-107</a>-compatible cache interface for managing cached data. For more information about Infinispan functionality and configuration options see the <a class="link" href="http://infinispan.org/docs/8.1.x/index.html">Infinispan Documentation</a>.
				</p><p>
					The <code class="literal">infinispan</code> subsystem provides caching support for JBoss EAP. It allows you to configure and view runtime metrics for named cache containers and caches.
				</p><p>
					When using a configuration that provides high availability capabilities, such as the <span class="emphasis"><em>ha</em></span> or <span class="emphasis"><em>full-ha</em></span> profile in a managed domain, or the <code class="literal">standalone-ha.xml</code> or <code class="literal">standalone-full-ha.xml</code> configuration file for a standalone server, the <code class="literal">infinispan</code> subsystem provides caching, state replication, and state distribution support. In non-high-availability configurations, the <code class="literal">infinispan</code> subsystem provides local caching support.
				</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						Infinispan is delivered as a private module in JBoss EAP to provide the caching capabilities of JBoss EAP. Infinispan is not supported for direct use by applications.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="cache_containers"/>Cache Containers</h2></div></div></div><p>
					A cache container is a repository for the caches used by a subsystem. Each cache container defines a default cache to be used.
				</p><p>
					JBoss EAP 7 defines the following default Infinispan cache containers:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<code class="literal">server</code> for singleton caching
						</li><li class="listitem">
							<code class="literal">web</code> for web session clustering
						</li><li class="listitem">
							<code class="literal">ejb</code> for stateful session bean clustering
						</li><li class="listitem">
							<code class="literal">hibernate</code> for entity caching
						</li></ul></div><div class="title"><strong>Example: Default Infinispan Configuration</strong></div><p>
						
</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:infinispan:7.0"&gt;
  &lt;cache-container name="server" aliases="singleton cluster" default-cache="default" module="org.wildfly.clustering.server"&gt;
    &lt;transport lock-timeout="60000"/&gt;
    &lt;replicated-cache name="default"&gt;
      &lt;transaction mode="BATCH"/&gt;
    &lt;/replicated-cache&gt;
  &lt;/cache-container&gt;
  &lt;cache-container name="web" default-cache="dist" module="org.wildfly.clustering.web.infinispan"&gt;
    &lt;transport lock-timeout="60000"/&gt;
    &lt;distributed-cache name="dist"&gt;
      &lt;locking isolation="REPEATABLE_READ"/&gt;
      &lt;transaction mode="BATCH"/&gt;
      &lt;file-store/&gt;
    &lt;/distributed-cache&gt;
  &lt;/cache-container&gt;
  &lt;cache-container name="ejb" aliases="sfsb" default-cache="dist" module="org.wildfly.clustering.ejb.infinispan"&gt;
    &lt;transport lock-timeout="60000"/&gt;
    &lt;distributed-cache name="dist"&gt;
      &lt;locking isolation="REPEATABLE_READ"/&gt;
      &lt;transaction mode="BATCH"/&gt;
      &lt;file-store/&gt;
    &lt;/distributed-cache&gt;
  &lt;/cache-container&gt;
  &lt;cache-container name="hibernate" default-cache="local-query" module="org.hibernate.infinispan"&gt;
    &lt;transport lock-timeout="60000"/&gt;
    &lt;local-cache name="local-query"&gt;
      &lt;eviction strategy="LRU" max-entries="10000"/&gt;
      &lt;expiration max-idle="100000"/&gt;
    &lt;/local-cache&gt;
    &lt;invalidation-cache name="entity"&gt;
      &lt;transaction mode="NON_XA"/&gt;
      &lt;eviction strategy="LRU" max-entries="10000"/&gt;
      &lt;expiration max-idle="100000"/&gt;
    &lt;/invalidation-cache&gt;
    &lt;replicated-cache name="timestamps" mode="ASYNC"/&gt;
  &lt;/cache-container&gt;
&lt;/subsystem&gt;</pre><p>

					</p><p>
					Note the default cache defined in each cache container. For example, the <code class="literal">web</code> cache container defines the <code class="literal">dist</code> distributed cache as the default. The <code class="literal">dist</code> cache will therefore be used when clustering web sessions.
				</p><p>
					See <a class="link" href="configuring_high_availability.html#configure_cache_containers" title="Configure Cache Containers">Configure Cache Containers</a> for information on changing the default cache and adding additional caches.
				</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						You can add additional caches and cache containers, for example, for HTTP sessions, stateful session beans, or singleton services or deployments. It is not supported to use these caches directly by user applications.
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="configure_cache_containers"/>Configure Cache Containers</h3></div></div></div><p>
						Cache containers and cache attributes can be configured using the management console or management CLI.
					</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
							You should avoid changing cache or cache container names, as other components in the configuration may reference them.
						</p></div><h5><a id="configure_caches_using_the_management_console"/>Configure Caches Using the Management Console</h5><p>
						Once you navigate to the <span class="strong"><strong>Infinispan</strong></span> subsystem from the <span class="strong"><strong>Configuration</strong></span> tab in the management console, you can configure caches and cache containers. In a managed domain, make sure to select the appropriate profile to configure.
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
								Add a cache container.
							</p><p class="simpara">
								Click the Add (<span class="strong"><strong>+</strong></span>) button next to the <span class="strong"><strong>Cache Container</strong></span> heading, choose <span class="strong"><strong>Add Cache Container</strong></span>, and enter the settings for the new cache container.
							</p></li><li class="listitem"><p class="simpara">
								Update cache container settings.
							</p><p class="simpara">
								Choose the appropriate cache container and click <span class="strong"><strong>View</strong></span>. Configure the cache container settings as necessary.
							</p></li><li class="listitem"><p class="simpara">
								Update cache container transport settings.
							</p><p class="simpara">
								Choose the appropriate cache container and click <span class="strong"><strong>View</strong></span>. Select the <span class="strong"><strong>Transport</strong></span> tab and configure the cache container transport settings as necessary.
							</p></li><li class="listitem"><p class="simpara">
								Configure caches.
							</p><p class="simpara">
								Choose the appropriate cache container and click <span class="strong"><strong>View</strong></span>. From the appropriate cache tab, for example, <span class="strong"><strong>Replicated Cache</strong></span>, you can add, update, and remove caches.
							</p></li></ul></div><h5><a id="configure_caches_using_the_management_cli"/>Configure Caches Using the Management CLI</h5><p>
						You can configure caches and cache containers using the management CLI. In a managed domain, you must specify the profile to update by preceding these commands with <code class="literal">/profile=<span class="emphasis"><em>PROFILE_NAME</em></span></code>.
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
								Add a cache container.
							</p><pre class="screen">/subsystem=infinispan/cache-container=<span class="emphasis"><em>CACHE_CONTAINER</em></span>:add</pre></li><li class="listitem"><p class="simpara">
								Add a replicated cache.
							</p><pre class="screen">/subsystem=infinispan/cache-container=<span class="emphasis"><em>CACHE_CONTAINER</em></span>/replicated-cache=<span class="emphasis"><em>CACHE</em></span>:add(mode=<span class="emphasis"><em>MODE</em></span>)</pre></li><li class="listitem"><p class="simpara">
								Set the default cache for a cache container.
							</p><pre class="screen">/subsystem=infinispan/cache-container=<span class="emphasis"><em>CACHE_CONTAINER</em></span>:write-attribute(name=default-cache,value=<span class="emphasis"><em>CACHE</em></span>)</pre></li><li class="listitem"><p class="simpara">
								Configure batching for a replicated cache.
							</p><pre class="screen">/subsystem=infinispan/cache-container=<span class="emphasis"><em>CACHE_CONTAINER</em></span>/replicated-cache=<span class="emphasis"><em>CACHE</em></span>/component=transaction:write-attribute(name=mode,value=BATCH)</pre></li></ul></div><p>
						The following example shows how to add a <code class="literal">concurrent</code> distributed cache to the <code class="literal">web</code> cache container. This cache configuration relaxes the locking constraints of the default cache, which allows multiple concurrent requests to access the same web session simultaneously. It achieves this by permitting lock-free reads and obtaining exclusive locks more frequently, but for a shorter duration.
					</p><p>
						Use the following management CLI commands to add the <code class="literal">concurrent</code> distributed cache to the <code class="literal">web</code> cache container.
					</p><pre class="screen">batch
/subsystem=infinispan/cache-container=web/distributed-cache=concurrent:add
/subsystem=infinispan/cache-container=web/distributed-cache=concurrent/store=file:add
run-batch</pre><p>
						This results in the following server configuration.
					</p><pre class="programlisting">&lt;cache-container name="web" default-cache="dist" module="org.wildfly.clustering.web.infinispan"&gt;
  ...
  &lt;distributed-cache name="concurrent"&gt;
      &lt;file-store/&gt;
  &lt;/distributed-cache&gt;
&lt;/cache-container&gt;</pre><h5><a id="change_the_default_ejb_cache_container"/>Change the Default EJB Cache Container</h5><p>
						You can use cache containers in the <code class="literal">ejb3</code> subsystem as described below:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								To support passivation of EJB session beans, you can use the <code class="literal">ejb</code> cache container defined in the <code class="literal">infinispan</code> subsystem to store the sessions.
							</li><li class="listitem">
								For remote EJB clients connecting to a clustered deployment on a server, you must provide the cluster topology information to these clients, so that they can fail over to other nodes in the cluster if the node they are interacting with fails.
							</li></ul></div><p>
						If you are changing or renaming the default cache container, named <code class="literal">ejb</code>, which supports passivation and the provision of topology information, you must add the <code class="literal">cache-container</code> attribute to the <code class="literal">passivation-stores</code> element and the <code class="literal">cluster</code> attribute to the <code class="literal">remote</code> element, as shown in the example below. If you are just adding a new cache for your own use, you need not make those changes.
					</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:ejb3:5.0"&gt;
    &lt;passivation-stores&gt;
        &lt;passivation-store name="infinispan" cache-container="ejb-cltest" max-size="10000"/&gt;
    &lt;/passivation-stores&gt;

    &lt;remote cluster="ejb-cltest" connector-ref="http-remoting-connector" thread-pool-name="default"/&gt;
&lt;/subsystem&gt;

&lt;subsystem xmlns="urn:jboss:domain:infinispan:7.0"&gt;
    ...
    &lt;cache-container name="ejb-cltest" aliases="sfsb" default-cache="dist" module="org.wildfly.clustering.ejb.infinispan"&gt;
&lt;/subsystem&gt;</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="clustering_modes"/>Clustering Modes</h2></div></div></div><p>
					Clustering can be configured in two different ways in JBoss EAP using Infinispan. The best method for your application will depend on your requirements. There is a trade-off between availability, consistency, reliability and scalability with each mode. Before choosing a clustering mode, you must identify what are the most important features of your network for you, and balance those requirements.
				</p><h4><a id="cache_modes"/>Cache Modes</h4><div class="variablelist"><dl class="variablelist"><dt><span class="term">Replication</span></dt><dd>
								Replication mode automatically detects and adds new instances on the cluster. Changes made to these instances will be replicated to all nodes on the cluster. Replication mode typically works best in small clusters because of the amount of information that has to be replicated over the network. Infinispan can be configured to use UDP multicast, which alleviates network traffic congestion to a degree.
							</dd><dt><span class="term">Distribution</span></dt><dd><p class="simpara">
								Distribution mode allows Infinispan to scale the cluster linearly. Distribution mode uses a consistent hash algorithm to determine where in a cluster a new node should be placed. The number of copies, or owners, of information to be kept is configurable. There is a trade-off between the number of copies kept, durability of the data, and performance. The more copies that are kept, the more impact on performance, but the less likely you are to lose data in a server failure. The hash algorithm also works to reduce network traffic by locating entries without multicasting or storing metadata.
							</p><p class="simpara">
								You should consider using distribution mode as a caching strategy when the cluster size exceeds 6-8 nodes. With distribution mode, data is distributed to only a subset of nodes within the cluster, as opposed to all nodes.
							</p></dd><dt><span class="term">Scattered</span></dt><dd><p class="simpara">
								Scattered mode is similar to distribution mode in that it uses a consistent hash algorithm to determine ownership. However, ownership is limited to two members, and the originator, or node receiving the request for a given session, always assumes ownership for coordinating locking and cache entry updates. The cache write algorithm used in scattered mode guarantees that a write operation results in only a single RPC call, where distribution caches with two owners can often use two RPC calls. This can be useful for distributed web sessions because load balancer failover tends to direct traffic to a non-primary owner or even a backup node. This can potentially reduce contention and improve performance following a cluster topology change.
							</p><p class="simpara">
								Scattered mode does not support transactions or L1 caching. However, it does support biased reads, which allow the node that originates a cache write for a given entry to continue to service reads for that entry for some duration even though it is not the owner according to the consistent hash. The effect is similar to L1 caching, although the configuration attributes for biased reads versus L1 caching are distinct.
							</p></dd></dl></div><h4><a id="synchronous_and_asynchronous_replication"/>Synchronous and Asynchronous Replication</h4><p>
					Replication can be performed either in synchronous or asynchronous mode, and the mode chosen depends on your requirements and your application.
				</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Synchronous replication</span></dt><dd>
								With synchronous replication, the replication process runs in the same thread that handles the user request. Session replication is initiated after the completed response is sent back to the client, and the thread is released only after the replication is completed. Synchronous replication has an impact on network traffic because it requires a response from each node in the cluster. It has the advantage, however, of ensuring that all modifications have been made to all nodes in the cluster.
							</dd><dt><span class="term">Asynchronous replication</span></dt><dd>
								With asynchronous replication, Infinispan uses a thread pool to carry out replication in the background. The sender does not wait for replies from other nodes in the cluster. However, cache reads for the same session will block until the previous replication completes so that stale data is not read. Replication is triggered either on a time basis or by queue size. Failed replication attempts are written to a log, not notified in real time.
							</dd></dl></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="configure_the_cache_mode"/>Configure the Cache Mode</h3></div></div></div><p>
						You can change the default cache using the management CLI.
					</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							This section shows instructions specific to configuring the web session cache, which defaults to distribution mode. The steps and management CLI commands can easily be adjusted to apply to other cache containers.
						</p></div><h5><a id="change_to_replication_cache_mode"/>Change to Replication Cache Mode</h5><p>
						The default JBoss EAP 7 configuration for the web session cache does not include a <code class="literal">repl</code> replicated cache. This cache must first be added.
					</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							The below management CLI commands are for a standalone server. When running in a managed domain, you must specify which profile to update by preceding the <code class="literal">/subsystem=infinispan</code> commands with <code class="literal">/profile=<span class="emphasis"><em>PROFILE_NAME</em></span></code>.
						</p></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Add the <code class="literal">repl</code> replication cache and set it as the default cache.
							</p><pre class="screen">batch
/subsystem=infinispan/cache-container=web/replicated-cache=repl:add(mode=ASYNC)
/subsystem=infinispan/cache-container=web/replicated-cache=repl/component=transaction:add(mode=BATCH)
/subsystem=infinispan/cache-container=web/replicated-cache=repl/component=locking:add(isolation=REPEATABLE_READ)
/subsystem=infinispan/cache-container=web/replicated-cache=repl/store=file:add
/subsystem=infinispan/cache-container=web:write-attribute(name=default-cache,value=repl)
run-batch</pre></li><li class="listitem"><p class="simpara">
								Reload the server.
							</p><pre class="screen">reload</pre></li></ol></div><h5><a id="change_to_distribution_cache_mode"/>Change to Distribution Cache Mode</h5><p>
						The default JBoss EAP 7 configuration for the web session cache already includes a <code class="literal">dist</code> distributed cache.
					</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							The below management CLI commands are for a standalone server. When running in a managed domain, you must specify which profile to update by preceding the <code class="literal">/subsystem=infinispan</code> commands with <code class="literal">/profile=<span class="emphasis"><em>PROFILE_NAME</em></span></code>.
						</p></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Change the default cache to the <code class="literal">dist</code> distribution cache.
							</p><pre class="screen">/subsystem=infinispan/cache-container=web:write-attribute(name=default-cache,value=dist)</pre></li><li class="listitem"><p class="simpara">
								Set the number of owners for the distribution cache. The following command sets <code class="literal">5</code> owners. The default is <code class="literal">2</code>.
							</p><pre class="screen">/subsystem=infinispan/cache-container=web/distributed-cache=dist:write-attribute(name=owners,value=5)</pre></li><li class="listitem"><p class="simpara">
								Reload the server.
							</p><pre class="screen">reload</pre></li></ol></div><h5><a id="change_to_scattered_cache_mode"/>Change to Scattered Cache Mode</h5><p>
						The default JBoss EAP configuration for the web session cache does not include a <code class="literal">scattered-cache</code>. The example below shows the management CLI commands to add a scattered cache and set it as the default cache.
					</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							The below management CLI commands are for a standalone server using the HA profile. When running in a managed domain, you must specify which profile to update by preceding the <code class="literal">/subsystem=infinispan</code> commands with <code class="literal">/profile=<span class="emphasis"><em>PROFILE_NAME</em></span></code>.
						</p></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Create the scattered cache with a read bias lifespan equal to the default web session timeout value of 30 minutes .
							</p><pre class="screen">/subsystem=infinispan/cache-container=web/scattered-cache=scattered:add(bias-lifespan=1800000)</pre></li><li class="listitem"><p class="simpara">
								Set <code class="literal">scattered</code> as the default cache.
							</p><pre class="screen">/subsystem=infinispan/cache-container=web:write-attribute(name=default-cache,value=scattered)</pre></li></ol></div><p>
						This results in the following server configuration.
					</p><pre class="programlisting">&lt;cache-container name="web" default-cache="scattered" module="org.wildfly.clustering.web.infinispan"&gt;
    ...
    &lt;scattered-cache name="scattered" bias-lifespan="1800000"/&gt;
    ...
&lt;/cache-container&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="cache_strategy_performance"/>Cache Strategy Performance</h3></div></div></div><p>
						When using a <code class="literal">SYNC</code> caching strategy, the cost of replication is easy to measure and directly seen in response times since the request does not complete until the replication completes.
					</p><p>
						Although it seems that the <code class="literal">ASYNC</code> caching strategy should result in lower response times than the <code class="literal">SYNC</code> caching strategy, this is only true under the right conditions. The <code class="literal">ASYNC</code> caching strategy is more difficult to measure, but it can provide better performance than the <code class="literal">SYNC</code> strategy when the duration between requests is long enough for the cache operation to complete. This is because the cost of replication is not immediately seen in response times.
					</p><p>
						If requests for the same session are made too quickly, the cost of replication for the previous request is shifted to the front of the subsequent request since it must wait for the replication from the previous request to complete. For rapidly fired requests where a subsequent request is sent immediately after a response is received, the <code class="literal">ASYNC</code> caching strategy will perform worse than the <code class="literal">SYNC</code> caching strategy. Consequently, there is a threshold for the period of time between requests for the same session where the <code class="literal">SYNC</code> caching strategy will actually perform better than the <code class="literal">ASYNC</code> caching strategy. In real world usage, requests for the same session are not normally received in rapid succession. Instead, there is typically a period of time in the order of a few seconds or more between the requests. In this case, the <code class="literal">ASYNC</code> caching strategy is a sensible default and provides the fastest response times.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="state_transfer"/>State Transfer</h2></div></div></div><p>
					State transfer is both a basic data grid and clustered cache function. Without state transfer, data would be lost as nodes are added to or removed from the cluster.
				</p><p>
					State transfer adjusts the cache’s internal state in response to a change in the cache membership. This change automatically occurs when a node joins or leaves the cluster, when two or more cluster partitions merge, or after any combination of these events. The initial state transfer for a newly started cache is the most expensive, as the new cache must receive the maximum amount of state, based on the cache’s mode as discussed below.
				</p><p>
					The <code class="literal">timeout</code> attribute can be used to control how long the newly started cache waits to receive its state. If the <code class="literal">timeout</code> attribute is a positive number, then the cache will wait to receive all of its initial state before being made available to service requests. If the state transfer does not complete in the specified time, the default being <code class="literal">240000</code> milliseconds, then the cache will throw an error and cancel the startup. If <code class="literal">timeout</code> is set to <code class="literal">0</code>, then the cache is immediately available, and it will receive its initial state during background operations. Until the initial state transfer is complete, any requests for cache entries that the cache has not yet received will need to be fetched from a remote node.
				</p><p>
					The <code class="literal">timeout</code> attribute can be set to <code class="literal">0</code> with the following command.
				</p><pre class="programlisting">/subsystem=infinispan/cache-container=server/<span class="emphasis"><em>CACHE_TYPE</em></span>=<span class="emphasis"><em>CACHE</em></span>/component=state-transfer:write-attribute(name=timeout,value=0)</pre><p>
					The state transfer behavior is determined by the cache’s mode.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							In replication mode a new node joining the cache receives the entire cache state from the existing nodes. When a node leaves the cluster there is no state transfer.
						</li><li class="listitem">
							In distribution mode the new node receives only a part of the state from the existing nodes, and the existing nodes remove some of their state in order to keep <code class="literal">owners</code> copies of each key in the cache, as determined through consistent hashing. When a node leaves the cluster, a distribution cache needs to make additional copies of the keys that were stored on that node, so that owners of each key continue to exist.
						</li><li class="listitem">
							In invalidation mode the initial state transfer is similar to replication mode, the only difference being that the nodes are not guaranteed to have the same state. When a node leaves the cluster there is no state transfer.
						</li></ul></div><p>
					A state transfer transfers both in-memory and persistent state by default, but both can be disabled in the configuration. When state transfer is disabled, a <code class="literal">ClusterLoader</code> must be configured, otherwise a node will become the owner or backup owner of a key without the data being loaded into its cache. In addition, if state transfer is disabled in distribution mode then a key will occasionally have less than <code class="literal">owners</code> copies in the cache.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_infinispan_thread_pools"/>Configure Infinispan Thread Pools</h2></div></div></div><p>
					The <code class="literal">infinispan</code> subsystem contains the <code class="literal">async-operations</code>, <code class="literal">expiration</code>, <code class="literal">listener</code>, <code class="literal">persistence</code>, <code class="literal">remote-command</code>, <code class="literal">state-transfer</code>, and <code class="literal">transport</code> thread pools. These pools can be configured for any Infinispan cache container.
				</p><p>
					The following table lists the attributes you can configure for each thread pool in the <code class="literal">infinispan</code> subsystem and the default value for each.
				</p><div class="informaltable"><table border="1"><colgroup><col class="col_1"/><col class="col_2"/><col class="col_3"/><col class="col_4"/><col class="col_5"/></colgroup><thead><tr><th style="text-align: left" valign="top">Thread Pool Name</th><th style="text-align: left" valign="top">keepalive-time</th><th style="text-align: left" valign="top">max-threads</th><th style="text-align: left" valign="top">min-threads</th><th style="text-align: left" valign="top">queue-length</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
									async-operations
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									60000L
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									25
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									25
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									1000
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									expiration
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									60000L
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									1
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									N/A
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									N/A
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									listener
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									60000L
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									1
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									1
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									100000
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									persistence
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									60000L
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									4
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									1
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									0
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									remote-command
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									60000L
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									200
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									1
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									0
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									state-transfer
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									60000L
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									60
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									1
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									0
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									transport
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									60000L
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									25
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									25
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									100000
								</p>
								 </td></tr></tbody></table></div><p>
					Use the following syntax to configure an Infinispan thread pool using the management CLI.
				</p><pre class="screen">/subsystem=infinispan/cache-container=<span class="emphasis"><em>CACHE_CONTAINER_NAME</em></span>/thread-pool=<span class="emphasis"><em>THREAD_POOL_NAME</em></span>:write-attribute(name=<span class="emphasis"><em>ATTRIBUTE_NAME</em></span>, value=<span class="emphasis"><em>ATTRIBUTE_VALUE</em></span>)</pre><p>
					The following is an example of the management CLI command to set the <code class="literal">max-threads</code> value to <code class="literal">10</code> in the <code class="literal">persistence</code> thread pool for the <code class="literal">server</code> cache container.
				</p><pre class="screen">/subsystem=infinispan/cache-container=server/thread-pool=persistence:write-attribute(name="max-threads", value="10")</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="infinispan_statistics"/>Infinispan Statistics</h2></div></div></div><p>
					Runtime statistics about Infinispan caches and cache containers can be enabled for monitoring purposes. Statistics collection is not enabled by default for performance reasons.
				</p><p>
					Statistics collection can be enabled for each cache container, cache, or both. The statistics option for each cache overrides the option for the cache container. Enabling or disabling statistics collection for a cache container will cause all caches in that container to inherit the setting, unless they explicitly specify their own.
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="enable_infinispan_statistics"/>Enable Infinispan Statistics</h3></div></div></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
							Enabling Infinispan statistics may have a negative impact on the performance of the <code class="literal">infinispan</code> subsystem. Statistics should be enabled only when required.
						</p></div><p>
						You can enable or disable the collection of Infinispan statistics using the management console or the management CLI. From the management console, navigate to the <span class="strong"><strong>Infinispan</strong></span> subsystem from the <span class="strong"><strong>Configuration</strong></span> tab, select the appropriate cache or cache container, and edit the <span class="strong"><strong>Statistics Enabled</strong></span> attribute. Use the below commands to enable statistics using the management CLI.
					</p><p>
						Enable statistics collection for a cache container. A server reload will be required.
					</p><pre class="screen">/subsystem=infinispan/cache-container=<span class="emphasis"><em>CACHE_CONTAINER</em></span>:write-attribute(name=statistics-enabled,value=true)</pre><p>
						Enable statistics collection for a cache. A server reload will be required.
					</p><pre class="screen">/subsystem=infinispan/cache-container=<span class="emphasis"><em>CACHE_CONTAINER</em></span>/<span class="emphasis"><em>CACHE_TYPE</em></span>=<span class="emphasis"><em>CACHE</em></span>:write-attribute(name=statistics-enabled,value=true)</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							You can use the following command to undefine the <code class="literal">statistics-enabled</code> attribute of a cache so that it will inherit the settings of its cache container’s <code class="literal">statistics-enabled</code> attribute.
						</p><pre class="screen">/subsystem=infinispan/cache-container=<span class="emphasis"><em>CACHE_CONTAINER</em></span>/<span class="emphasis"><em>CACHE_TYPE</em></span>=<span class="emphasis"><em>CACHE</em></span>:undefine-attribute(name=statistics-enabled)</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="infinispan_partition_handling"/>Infinispan Partition Handling</h2></div></div></div><p>
					An <span class="emphasis"><em>Infinispan cluster</em></span> is built out of several nodes where data is stored. To prevent data loss if multiple nodes fail, Infinispan copies the same data over multiple nodes. This level of data redundancy is configured using the <code class="literal">owners</code> attribute. As long as fewer than the configured number of nodes crash simultaneously, Infinispan will have a copy of the data available.
				</p><p>
					However, there are potential catastrophic situations that could occur when too many nodes disappear from the cluster:
				</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Split brain</span></dt><dd><p class="simpara">
								This splits the cluster in two or more partitions, or sub-clusters, that operate independently. In these circumstances, multiple clients reading and writing from different partitions see different versions of the same cache entry, which for many applications is problematic.
							</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
									There are ways to alleviate the possibility for the split brain to happen, such as redundant networks or <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/s2-networkscripts-interfaces-chan.html">IP bonding</a>; however, these only reduce the window of time for the problem to occur.
								</p></div></dd><dt><span class="term">Multiple nodes crash in sequence</span></dt><dd>
								If multiple nodes, specifically the number of owners, crash in rapid sequence and Infinispan does not have the time to properly rebalance its state between crashes, the result is partial data loss.
							</dd></dl></div><p>
					The goal is to avoid situations in which incorrect data is returned to the user as a result of either split brain or multiple nodes crashing in rapid sequence.
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="split_brain"/>Split Brain</h3></div></div></div><p>
						In a split brain situation, each network partition will install its own JGroups view, removing the nodes from the other partitions. We do not have a direct way to determine whether the cluster has been split into two or more partitions, since the partitions are unaware of each other. Instead, we assume the cluster has split when one or more nodes disappear from the JGroups cluster without sending an explicit leave message.
					</p><p>
						With partition handling disabled, each such partition would continue to function as an independent cluster. Each partition may only see a part of the data, and each partition could write conflicting updates in the cache.
					</p><p>
						With partition handling enabled, if we detect a split, each partition does not start a rebalance immediately, but first checks whether it should enter degraded mode instead:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								If at least one segment has lost all its owners, meaning that at least the number of owners specified has left since the last rebalance ended, the partition enters degraded mode.
							</li><li class="listitem">
								If the partition does not contain a simple majority of the nodes (floor(numNodes/2) + 1) in the <span class="emphasis"><em>latest stable topology</em></span>, the partition also enters degraded mode.
							</li><li class="listitem">
								Otherwise, the partition keeps functioning normally and starts a rebalance.
							</li></ul></div><p>
						The <span class="emphasis"><em>stable topology</em></span> is updated every time a rebalance operation ends and the coordinator determines that another rebalance is not necessary. These rules ensure that at most, one partition stays in available mode, and the other partitions enter degraded mode.
					</p><p>
						When a partition is in degraded mode, it only allows access to the keys that are wholly owned:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								Requests (reads and writes) for entries that have all the copies on nodes within this partition are honored.
							</li><li class="listitem">
								Requests for entries that are partially or totally owned by nodes that have disappeared are rejected with an <code class="literal">AvailabilityException</code>.
							</li></ul></div><p>
						This guarantees that partitions cannot write different values for the same key (cache is consistent), and also that one partition can not read keys that have been updated in the other partitions (no stale data).
					</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							Two partitions could start up isolated, and as long as they do not merge, they can read and write inconsistent data. In the future, we may allow custom availability strategies (e.g. check that a certain node is part of the cluster, or check that an external machine is accessible) that could handle that situation as well.
						</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="configuring_partition_handling"/>Configuring Partition Handling</h3></div></div></div><p>
						Currently the partition handling is disabled by default. Use the following management CLI command to enable partition handling:
					</p><pre class="screen">/subsystem=infinispan/cache-container=web/distributed-cache=dist/component=partition-handling:write-attribute(name=enabled, value=true)</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="jdg_externalize_http_sessions"/>Externalize HTTP Sessions to JBoss Data Grid</h2></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						You need a Red Hat JBoss Data Grid subscription to use this functionality.
					</p></div><p>
					Red Hat JBoss Data Grid can be used as an external cache container for application-specific data in JBoss EAP, such as HTTP sessions. This allows scaling of the data layer independent of the application, and enables different JBoss EAP clusters, which may reside in various domains, to access data from the same JBoss Data Grid cluster. Additionally, other applications can interface with the caches presented by Red Hat JBoss Data Grid.
				</p><p>
					The following example shows how to externalize HTTP sessions. It applies to both standalone instances of JBoss EAP as well as managed domains; however, in a managed domain, each server group requires a unique remote cache configured. While multiple server groups can utilize the same Red Hat JBoss Data Grid cluster, the respective remote caches will be unique to the JBoss EAP server group.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Create a <code class="literal">remote-cache-container</code> in the <code class="literal">infinispan</code> subsystem.
						</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
									Define a <code class="literal">socket-binding</code>, repeating the command as necessary for each remote JBoss Data Grid instance in the cluster.
								</p><pre class="screen">/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=<span class="emphasis"><em>SOCKET_BINDING</em></span>:add(host=<span class="emphasis"><em>HOSTNAME</em></span>,port=<span class="emphasis"><em>PORT</em></span>)</pre></li><li class="listitem"><p class="simpara">
									Define a <code class="literal">remote-cache-container</code> that references the newly created socket bindings.
								</p><pre class="screen">batch
/subsystem=infinispan/remote-cache-container=<span class="emphasis"><em>CACHE_CONTAINER</em></span>:add(default-remote-cluster=data-grid-cluster)
/subsystem=infinispan/remote-cache-container=<span class="emphasis"><em>CACHE_CONTAINER</em></span>/remote-cluster=data-grid-cluster:add(socket-bindings=[<span class="emphasis"><em>SOCKET_BINDING</em></span>,<span class="emphasis"><em>SOCKET_BINDING_2</em></span>,...])
run-batch</pre></li><li class="listitem"><p class="simpara">
									Reload the server for the changes to take effect.
								</p><pre class="screen">reload</pre></li></ol></div></li><li class="listitem"><p class="simpara">
							Configure the HotRod store. The HotRod store uses one dedicated remote cache for each cache created by the JBoss EAP server. Typically, one invalidation cache is used on the JBoss EAP server, as shown in the CLI script below.
						</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								The remote caches need to be configured manually on the JBoss JDG servers. The recommended configuration for these caches is a transactional distribution mode cache with pessimistic locking. Cache names must correspond to the deployment file names, such as <code class="literal">test.war</code>.
							</p></div><p class="simpara">
							Once the remote cache container has been configured, a <code class="literal">hotrod</code> store can be configured to replace any existing store. The following CLI script demonstrates a typical use case for offloading sessions in conjunction with the invalidation cache.
						</p><pre class="screen">batch
/subsystem=infinispan/cache-container=web/invalidation-cache=<span class="emphasis"><em>CACHE_NAME</em></span>:add()
/subsystem=infinispan/cache-container=web/invalidation-cache=<span class="emphasis"><em>CACHE_NAME</em></span>/store=hotrod:add(remote-cache-container=<span class="emphasis"><em>CACHE_CONTAINER</em></span>,fetch-state=false,purge=false,passivation=false,shared=true)
/subsystem=infinispan/cache-container=web/invalidation-cache=<span class="emphasis"><em>CACHE_NAME</em></span>/component=transaction:add(mode=BATCH)
/subsystem=infinispan/cache-container=web/invalidation-cache=<span class="emphasis"><em>CACHE_NAME</em></span>/component=locking:add(isolation=REPEATABLE_READ)
/subsystem=infinispan/cache-container=web:write-attribute(name=default-cache,value=<span class="emphasis"><em>CACHE_NAME</em></span>)
run-batch</pre><p class="simpara">
							The script configures a new invalidation cache. Session data is then maintained in the cache for performance and written to the store for resilience.
						</p><p class="simpara">
							A HotRod client can be injected directly into Java EE applications using the <code class="literal">@Resource</code> annotation. In the example below, the <code class="literal">@Resource</code> annotation looks up the configuration properties in the class path, in the <code class="literal">hotrod-client.properties</code> file.
						</p><pre class="programlisting">@Resource(lookup = "java:jboss/infinispan/remote-container/web-sessions")
private org.infinispan.client.hotrod.RemoteCacheContainer client;</pre><pre class="screen">infinispan.client.hotrod.transport_factory = org.infinispan.client.hotrod.impl.transport.tcp.TcpTransportFactory
infinispan.client.hotrod.server_list = 127.0.0.1:11222
infinispan.client.hotrod.marshaller = org.infinispan.commons.marshall.jboss.GenericJBossMarshaller
infinispan.client.hotrod.async_executor_factory = org.infinispan.client.hotrod.impl.async.DefaultAsyncExecutorFactory
infinispan.client.hotrod.default_executor_factory.pool_size = 1
infinispan.client.hotrod.default_executor_factory.queue_size = 10000
infinispan.client.hotrod.hash_function_impl.1 = org.infinispan.client.hotrod.impl.consistenthash.ConsistentHashV1
infinispan.client.hotrod.tcp_no_delay = true
infinispan.client.hotrod.ping_on_startup = true
infinispan.client.hotrod.request_balancing_strategy = org.infinispan.client.hotrod.impl.transport.tcp.RoundRobinBalancingStrategy
infinispan.client.hotrod.key_size_estimate = 64
infinispan.client.hotrod.value_size_estimate = 512
infinispan.client.hotrod.force_return_values = false

## below is connection pooling config

maxActive=-1
maxTotal = -1
maxIdle = -1
whenExhaustedAction = 1
timeBetweenEvictionRunsMillis=120000
minEvictableIdleTimeMillis=300000
testWhileIdle = true
minIdle = 1</pre></li></ol></div><h4><a id="securing_a_remote_cache_container"/>Securing a Remote Cache Container</h4><p>
					It is possible to secure the communication to the remote JBoss Data Grid instance using SSL. This is accomplished by configuring the <code class="literal">remote-cache-container</code> on the JBoss EAP instance and adjusting the hotrod connector on the JBoss Data Grid instance to use an active security realm.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Create a <code class="literal">client-ssl-context</code> in JBoss EAP. For additional information on creating a <code class="literal">client-ssl-context</code>, including generating the other elytron components, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_server_security/#using_client_ssl_context">Using a client-ssl-context</a> in <span class="emphasis"><em>How to Configure Server Security</em></span> for JBoss EAP.
						</p><pre class="screen">/subsystem=elytron/client-ssl-context=<span class="emphasis"><em>CLIENT_SSL_CONTEXT</em></span>:add(key-manager=<span class="emphasis"><em>KEY_MANAGER</em></span>,trust-manager=<span class="emphasis"><em>TRUST_MANAGER</em></span>)</pre></li><li class="listitem"><p class="simpara">
							Configure the remote cache container to use the client SSL context.
						</p><pre class="screen">/subsystem=infinispan/remote-cache-container=<span class="emphasis"><em>CACHE_CONTAINER</em></span>/component=security:write-attribute(name=ssl-context,value=<span class="emphasis"><em>CLIENT_SSL_CONTEXT</em></span>)</pre></li><li class="listitem"><p class="simpara">
							Secure the remote JBoss Data Grid instance, repeating as necessary for each instance.
						</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
									Copy the keystore used in the <code class="literal">client-ssl-context</code> to the remote JBoss Data Grid instance.
								</li><li class="listitem"><p class="simpara">
									Configure the <code class="literal">ApplicationRealm</code> to use this keystore.
								</p><pre class="screen">/core-service=management/security-realm=ApplicationRealm/server-identity=ssl:add(keystore-path="<span class="emphasis"><em>KEYSTORE_NAME</em></span>",keystore-relative-to="jboss.server.config.dir",keystore-password="<span class="emphasis"><em>KEYSTORE_PASSWORD</em></span>")</pre></li><li class="listitem"><p class="simpara">
									Adjust the hotrod connector to point to this security realm.
								</p><pre class="screen">/subsystem=datagrid-infinispan-endpoint/hotrod-connector=hotrod-connector/encryption=ENCRYPTION:add(require-ssl-client-auth=false,security-realm="ApplicationRealm")</pre></li><li class="listitem"><p class="simpara">
									Reload the remote JBoss Data Grid instance.
								</p><pre class="screen">reload</pre></li></ol></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="externalize-http-sessions-to-jdg-remote-store"/>Externalize HTTP Sessions to JBoss Data Grid Using a Remote Store</h2></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						You need a Red Hat JBoss Data Grid subscription to use this functionality.
					</p></div><p>
					The instructions here represent an older way of externalizing sessions. JBoss EAP 7.2 introduced a custom optimized cache store based on the HotRod protocol that integrates with the <code class="literal">elytron</code> subsystem. It is recommended to use the new <code class="literal">hotrod</code> store, as described in <a class="link" href="configuring_high_availability.html#jdg_externalize_http_sessions" title="Externalize HTTP Sessions to JBoss Data Grid">Externalize HTTP Sessions to JBoss Data Grid</a>.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						For each distributable application, an entirely new cache must be created. It can be created in an existing cache container, for example, <code class="literal">web</code>.
					</p></div><p>
					To externalize HTTP sessions:
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Define the location of the remote Red Hat JBoss Data Grid server by adding the networking information to the <code class="literal">socket-binding-group</code>.
						</p><div class="title"><strong>Example: Adding Remote Socket Bindings</strong></div><p>
								
</p><pre class="screen">/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=remote-jdg-server1:add(host=JDGHostName1, port=11222)

/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=remote-jdg-server2:add(host=JDGHostName2, port=11222)</pre><p>

							</p><div class="title"><strong>Resulting XML</strong></div><p>
								
</p><pre class="programlisting">&lt;socket-binding-group name="standard-sockets" ... &gt;
  ...
  &lt;outbound-socket-binding name="remote-jdg-server1"&gt;
    &lt;remote-destination host="JDGHostName1" port="11222"/&gt;
  &lt;/outbound-socket-binding&gt;
  &lt;outbound-socket-binding name="remote-jdg-server2"&gt;
    &lt;remote-destination host="JDGHostName2" port="11222"/&gt;
  &lt;/outbound-socket-binding&gt;
&lt;/socket-binding-group&gt;</pre><p>

							</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								You will need a remote socket binding configured for each Red Hat JBoss Data Grid server.
							</p></div></li><li class="listitem"><p class="simpara">
							Ensure the remote cache containers are defined in JBoss EAP’s <code class="literal">infinispan</code> subsystem; in the example below the <code class="literal">cache</code> attribute in the <code class="literal">remote-store</code> element defines the cache name on the remote JBoss Data Grid server.
						</p><p class="simpara">
							If you are running in a managed domain, precede these commands with <code class="literal">/profile=<span class="emphasis"><em>PROFILE_NAME</em></span></code>.
						</p><div class="title"><strong>Example: Adding a Remote Cache Container</strong></div><p>
								
</p><pre class="screen">/subsystem=infinispan/cache-container=web/invalidation-cache=jdg:add(mode=SYNC)

/subsystem=infinispan/cache-container=web/invalidation-cache=jdg/component=locking:write-attribute(name=isolation,value=REPEATABLE_READ)

/subsystem=infinispan/cache-container=web/invalidation-cache=jdg/component=transaction:write-attribute(name=mode,value=BATCH)

/subsystem=infinispan/cache-container=web/invalidation-cache=jdg/store=remote:add(remote-servers=["remote-jdg-server1","remote-jdg-server2"], cache=default, socket-timeout=60000, passivation=false, purge=false, shared=true)</pre><p>

							</p><div class="title"><strong>Resulting XML</strong></div><p>
								
</p><pre class="programlisting">&lt;subsystem xmlns="urn:jboss:domain:infinispan:7.0"&gt;
  ...
  &lt;cache-container name="web" default-cache="dist" module="org.wildfly.clustering.web.infinispan" statistics-enabled="true"&gt;
    &lt;transport lock-timeout="60000"/&gt;
    &lt;invalidation-cache name="jdg" mode="SYNC"&gt;
      &lt;locking isolation="REPEATABLE_READ"/&gt;
      &lt;transaction mode="BATCH"/&gt;
      &lt;remote-store cache="default" socket-timeout="60000" remote-servers="remote-jdg-server1 remote-jdg-server2" passivation="false" purge="false" shared="true"/&gt;
    &lt;/invalidation-cache&gt;
    ...
  &lt;/cache-container&gt;
&lt;/subsystem&gt;</pre><p>

							</p></li><li class="listitem"><p class="simpara">
							Add cache information into the application’s <code class="literal">jboss-web.xml</code>. In the following example, <code class="literal">web</code> is the name of the cache container and <code class="literal">jdg</code> is the name of the appropriate cache located in this container.
						</p><div class="title"><strong>Example: <code class="literal">jboss-web.xml</code> File</strong></div><p>
								
</p><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jboss-web xmlns="http://www.jboss.com/xml/ns/javaee"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-web_10_0.xsd"
           version="10.0"&gt;
    &lt;replication-config&gt;
        &lt;replication-granularity&gt;SESSION&lt;/replication-granularity&gt;
        &lt;cache-name&gt;web.jdg&lt;/cache-name&gt;
    &lt;/replication-config&gt;
&lt;/jboss-web&gt;</pre><p>

							</p></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_jboss_eap_load_balancer"/>Configuring JBoss EAP as a Front-end Load Balancer</h1></div></div></div><p>
				You can configure JBoss EAP and the <code class="literal">undertow</code> subsystem to act as a front-end load balancer to proxy requests to back-end JBoss EAP servers. Since Undertow makes use of asynchronous IO, the IO thread that is responsible for the connection is the only thread that is involved in the request. That same thread is also used for the connection made to the back-end server.
			</p><p>
				You can use the following protocols:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						HTTP over plain text (<code class="literal">http</code>), supporting HTTP/1 and HTTP/2 (<code class="literal">h2c</code>)
					</li><li class="listitem">
						HTTP over secured connection (<code class="literal">https</code>), supporting HTTP/1 and HTTP/2 (<code class="literal">h2</code>)
					</li><li class="listitem">
						AJP (<code class="literal">ajp</code>)
					</li></ul></div><p>
				You can either define a <a class="link" href="configuring_high_availability.html#configure_undertow_static_load_balancer" title="Configure Undertow as a Static Load Balancer">static load balancer</a> and specify the back-end hosts in your configuration, or use the <a class="link" href="configuring_high_availability.html#configure_undertow_load_balancer_mod_cluster" title="Configure Undertow as a Load Balancer Using mod_cluster">mod_cluster front end</a> to dynamically update the hosts.
			</p><p>
				See <a class="link" href="configuring_the_web_server_undertow.html#configuring_http_2" title="Configuring HTTP/2">Configuring HTTP/2</a> for instructions to configure Undertow to use HTTP/2.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_undertow_load_balancer_mod_cluster"/>Configure Undertow as a Load Balancer Using mod_cluster</h2></div></div></div><p>
					You can use the built-in mod_cluster front-end load balancer to load balance other JBoss EAP instances.
				</p><p>
					This procedure assumes that you are running in a managed domain and already have the following configured:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
							A JBoss EAP server that will act as the load balancer.
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
									This server uses the <code class="literal">load-balancer</code> profile, which is bound to the <code class="literal">load-balancer-sockets</code> socket binding group.
								</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
										The <code class="literal">load-balancer</code> profile is already preconfigured with the socket binding, mod-cluster Undertow filter, and reference in the default host to the filter in order to use this server as a front-end load balancer.
									</p></div></li></ul></div></li><li class="listitem"><p class="simpara">
							Two JBoss EAP servers, which will act as the back-end servers.
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									These servers are running in a cluster and use the <code class="literal">ha</code> profile, which is bound to the <code class="literal">ha-sockets</code> socket binding group.
								</li></ul></div></li><li class="listitem">
							The distributable application to be load balanced deployed to the back-end servers.
						</li></ul></div><h4><a id="configure_the_mod_cluster_front_end_load_balancer"/>Configure the mod_cluster Front-end Load Balancer</h4><p>
					The below steps load balance servers in a managed domain, but they can be adjusted to apply to a set of standalone servers. Be sure to update the management CLI command values to suit your environment.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Set the mod_cluster advertise security key.
						</p><p class="simpara">
							Adding the advertise security key allows the load balancer and servers to authenticate during discovery.
						</p><p class="simpara">
							Use the following management CLI command to set the mod_cluster advertise security key.
						</p><pre class="screen">/profile=ha/subsystem=modcluster/proxy=default:write-attribute(name=advertise-security-key, value=mypassword)</pre></li><li class="listitem"><p class="simpara">
							Update the mod_cluster load balancer’s security key.
						</p><p class="simpara">
							Use the following management CLI command to set the security key for the mod_cluster filter.
						</p><pre class="screen">/profile=load-balancer/subsystem=undertow/configuration=filter/mod-cluster=load-balancer:write-attribute(name=security-key,value=mypassword)</pre></li></ol></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						It is recommended that the management and advertise socket bindings used by mod_cluster only be exposed to the internal network, not a public IP address.
					</p></div><p>
					The load balancer JBoss EAP server can now load balance the two back-end JBoss EAP servers.
				</p><h4><a id="multiple_mod_cluster_configurations"/>Multiple mod_cluster Configurations</h4><p>
					The <code class="literal">mod_cluster</code> subsystem supports multiple named proxy configurations which allows to register non-default <code class="literal">undertow</code> servers with the reverse proxies. Moreover, this allows single application server node to register with different groups of proxy servers.
				</p><p>
					The following example adds an <code class="literal">ajp-listener</code>, a server, and a host to the <code class="literal">undertow</code> server. It also adds a new <code class="literal">mod_cluster</code> configuration that registers the host using the advertise mechanism.
				</p><pre class="screen">/socket-binding-group=standard-sockets/socket-binding=ajp-other:add(port=8010)
/subsystem=undertow/server=other-server:add
/subsystem=undertow/server=other-server/ajp-listener=ajp-other:add(socket-binding=ajp-other)
/subsystem=undertow/server=other-server/host=other-host:add(default-web-module=root-other.war)
/subsystem=undertow/server=other-server/host=other-host
/location=other:add(handler=welcome-content)
/subsystem=undertow/server=other-server/host=other-host:write-attribute(name=alias,value=[localhost]))

/socket-binding-group=standard-sockets/socket-binding=modcluster-other:add(multicast-address=224.0.1.106,multicast-port=23364)
/subsystem=modcluster/proxy=other:add(advertise-socket=modcluster-other,balancer=other-balancer,connector=ajp-other)

reload</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_undertow_static_load_balancer"/>Configure Undertow as a Static Load Balancer</h2></div></div></div><p>
					To configure a static load balancer with Undertow, you need to configure a proxy handler in the <code class="literal">undertow</code> subsystem. To configure a proxy handler in Undertow, you need to do the following on your JBoss EAP instance that will serve as your static load balancer:
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
							Add a reverse proxy handler
						</li><li class="listitem">
							Define the outbound socket bindings for each remote host
						</li><li class="listitem">
							Add each remote host to the reverse proxy handler
						</li><li class="listitem">
							Add the reverse proxy location
						</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						To use messaging behind a load balancer, you must configure a static Undertow HTTP load balancer. For more information, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/configuring_messaging/#using_messaging_behind_a_load_balancer">Using Messaging Behind a Load Balancer</a> in <span class="emphasis"><em>Configuring Messaging</em></span> for JBoss EAP.
					</p></div><p>
					The following example shows how to configure a JBoss EAP instance to be a static load balancer. The JBoss EAP instance is located at <code class="literal">lb.example.com</code> and will load balance between two additional servers: <code class="literal">server1.example.com</code> and <code class="literal">server2.example.com</code>. The load balancer will reverse-proxy to the location <code class="literal">/app</code> and will use the AJP protocol.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							To add a reverse proxy handler:
						</p><pre class="screen">/subsystem=undertow/configuration=handler/reverse-proxy=my-handler:add</pre></li><li class="listitem"><p class="simpara">
							To define the outbound socket bindings for each remote host:
						</p><pre class="screen">/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=remote-host1/:add(host=server1.example.com, port=8009)

/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=remote-host2/:add(host=server2.example.com, port=8009)</pre></li><li class="listitem"><p class="simpara">
							To add each remote host to the reverse proxy handler:
						</p><pre class="screen">/subsystem=undertow/configuration=handler/reverse-proxy=my-handler/host=host1:add(outbound-socket-binding=remote-host1, scheme=ajp, instance-id=myroute1, path=/test)

/subsystem=undertow/configuration=handler/reverse-proxy=my-handler/host=host2:add(outbound-socket-binding=remote-host2, scheme=ajp, instance-id=myroute2, path=/test)</pre></li><li class="listitem"><p class="simpara">
							To add the reverse proxy location:
						</p><pre class="screen">/subsystem=undertow/server=default-server/host=default-host/location=\/test:add(handler=my-handler)</pre></li></ol></div><p>
					When accessing <code class="literal">lb.example.com:8080/app</code>, you will now see the content proxied from <code class="literal">server1.example.com</code> and <code class="literal">server2.example.com</code>.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="using_external_web_server_proxy"/>Using an External Web Server as a Proxy Server</h1></div></div></div><p>
				JBoss EAP can accept requests from an external web server using the supported HTTP, HTTPS, or AJP protocol, depending on the external web server configuration.
			</p><p>
				See <a class="link" href="configuring_high_availability.html#overview_http_connectors" title="Overview of HTTP Connectors">Overview of HTTP Connectors</a> for details on the supported HTTP connectors for each web server. Once you have decided which web server and HTTP connector to use, see the appropriate section for information on configuring your connector:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						See the <a class="link" href="configuring_high_availability.html#mod_cluster-config" title="The mod_cluster HTTP Connector">mod_cluster</a>, <a class="link" href="configuring_high_availability.html#mod_jk-config" title="Apache mod_jk HTTP Connector">mod_jk</a>, or <a class="link" href="configuring_high_availability.html#mod_proxy-config" title="Apache mod_proxy HTTP Connector">mod_proxy</a> section for <a class="link" href="configuring_high_availability.html#apache_http_server" title="Apache HTTP Server">Apache HTTP Server</a>.
					</li><li class="listitem">
						See the <a class="link" href="configuring_high_availability.html#ISAPI_config" title="Microsoft ISAPI Connector">ISAPI connector</a> section for Microsoft IIS.
					</li><li class="listitem">
						See the <a class="link" href="configuring_high_availability.html#NSAPI_config" title="Oracle NSAPI Connector">NSAPI connector</a> section for Oracle iPlanet Web Server.
					</li></ul></div><p>
				For the most current information about supported configurations for HTTP connectors, see <a class="link" href="https://access.redhat.com/articles/2026253">JBoss EAP supported configurations</a>.
			</p><p>
				You also will need to make sure that JBoss EAP is configured to <a class="link" href="configuring_high_availability.html#configure_accept_requests_external_web_servers" title="Accepting Requests from External Web Servers">accept requests from external web servers</a>.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="overview_http_connectors"/>Overview of HTTP Connectors</h2></div></div></div><p>
					JBoss EAP has the ability to use load-balancing and clustering mechanisms built into external web servers, such as Apache HTTP Server, Microsoft IIS, and Oracle iPlanet as well as through Undertow. JBoss EAP communicates with the web servers using a connector. These connectors are configured within the <code class="literal">undertow</code> subsystem of JBoss EAP.
				</p><p>
					The web servers include software modules which control the way that HTTP requests are routed to JBoss EAP nodes. Each of these modules varies in how it works and how it is configured. The modules are configured to balance work loads across multiple JBoss EAP nodes, to move work loads to alternate servers in case of a failure event, or both.
				</p><p>
					JBoss EAP supports several different connectors. The one you choose depends on the web server in use and the functionality you need. See the tables below for comparisons of the supported configurations and features of the various HTTP connectors that are compatible with JBoss EAP.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						See <a class="link" href="configuring_high_availability.html#configure_undertow_load_balancer_mod_cluster" title="Configure Undertow as a Load Balancer Using mod_cluster">Configure Undertow as a Load Balancer Using mod_cluster</a> for using JBoss EAP 7 as a multi-platform load balancer.
					</p></div><p>
					For the most current information about supported configurations for HTTP connectors, see <a class="link" href="https://access.redhat.com/articles/2026253">JBoss EAP supported configurations</a>.
				</p><div class="table"><a id="idm140150817951808"/><p class="title"><strong>Table 24.1. HTTP Connector Supported Configurations</strong></p><div class="table-contents"><table summary="HTTP Connector Supported Configurations" border="1"><colgroup><col class="col_1"/><col class="col_2"/><col class="col_3"/><col class="col_4"/></colgroup><thead><tr><th style="text-align: left" valign="top">Connector</th><th style="text-align: left" valign="top">Web Server</th><th style="text-align: left" valign="top">Supported Operating Systems</th><th style="text-align: left" valign="top">Supported Protocols</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
									<a class="link" href="configuring_high_availability.html#mod_cluster-config" title="The mod_cluster HTTP Connector">mod_cluster</a>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Red Hat JBoss Core Services Apache HTTP Server, Red Hat JBoss Web Server Apache HTTP Server, JBoss EAP (Undertow)
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Red Hat Enterprise Linux, Microsoft Windows Server, Oracle Solaris
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									HTTP, HTTPS, AJP, WebSocket
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<a class="link" href="configuring_high_availability.html#mod_jk-config" title="Apache mod_jk HTTP Connector">mod_jk</a>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Red Hat JBoss Core Services Apache HTTP Server, Red Hat JBoss Web Server Apache HTTP Server
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Red Hat Enterprise Linux, Microsoft Windows Server, Oracle Solaris
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									AJP
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<a class="link" href="configuring_high_availability.html#mod_proxy-config" title="Apache mod_proxy HTTP Connector">mod_proxy</a>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Red Hat JBoss Core Services Apache HTTP Server, Red Hat JBoss Web Server Apache HTTP Server
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Red Hat Enterprise Linux, Microsoft Windows Server, Oracle Solaris
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									HTTP, HTTPS, AJP
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<a class="link" href="configuring_high_availability.html#ISAPI_config" title="Microsoft ISAPI Connector">ISAPI connector</a>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Microsoft IIS
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Microsoft Windows Server
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									AJP
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<a class="link" href="configuring_high_availability.html#NSAPI_config" title="Oracle NSAPI Connector">NSAPI connector</a>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Oracle iPlanet Web Server
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Oracle Solaris
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									AJP
								</p>
								 </td></tr></tbody></table></div></div><div class="table"><a id="idm140150817901296"/><p class="title"><strong>Table 24.2. HTTP Connector Features</strong></p><div class="table-contents"><table summary="HTTP Connector Features" border="1"><colgroup><col class="col_1"/><col class="col_2"/><col class="col_3"/></colgroup><thead><tr><th style="text-align: left" valign="top">Connector</th><th style="text-align: left" valign="top">Supports Sticky Sessions</th><th style="text-align: left" valign="top">Adapts to Deployment Status</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
									<a class="link" href="configuring_high_availability.html#mod_cluster-config" title="The mod_cluster HTTP Connector">mod_cluster</a>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Yes
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Yes. Detects deployment and undeployment of applications and dynamically decides whether to direct client requests to a server based on whether the application is deployed on that server.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<a class="link" href="configuring_high_availability.html#mod_jk-config" title="Apache mod_jk HTTP Connector">mod_jk</a>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Yes
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									No. Directs client requests to the container as long as the container is available, regardless of application status.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<a class="link" href="configuring_high_availability.html#mod_proxy-config" title="Apache mod_proxy HTTP Connector">mod_proxy</a>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Yes
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									No. Directs client requests to the container as long as the container is available, regardless of application status.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<a class="link" href="configuring_high_availability.html#ISAPI_config" title="Microsoft ISAPI Connector">ISAPI connector</a>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Yes
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									No. Directs client requests to the container as long as the container is available, regardless of application status.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<a class="link" href="configuring_high_availability.html#NSAPI_config" title="Oracle NSAPI Connector">NSAPI connector</a>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Yes
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									No. Directs client requests to the container as long as the container is available, regardless of application status.
								</p>
								 </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="apache_http_server"/>Apache HTTP Server</h2></div></div></div><p>
					A standalone Apache HTTP Server bundle is now available as a separate download with Red Hat JBoss Core Services. This simplifies installation and configuration, and allows for a more consistent update experience.
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="install_apache_http_server"/>Installing Apache HTTP Server</h3></div></div></div><p>
						For information on installing Apache HTTP Server, see the JBoss Core Services <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_core_services_apache_http_server/2.4/html-single/apache_http_server_installation_guide/"><span class="emphasis"><em>Apache HTTP Server Installation Guide</em></span></a>.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_accept_requests_external_web_servers"/>Accepting Requests from External Web Servers</h2></div></div></div><p>
					JBoss EAP does not require any special configuration to begin accepting requests from a proxy server as long as the correct protocol handler, for example AJP, HTTP, or HTTPS, is configured.
				</p><p>
					If the proxy server uses mod_jk, mod_proxy, ISAPI, or NSAPI, it sends requests to JBoss EAP and JBoss EAP simply provides a response. With mod_cluster, you must also configure your network to allow JBoss EAP to send information, such as its current load, application lifecycle events, and health status, to the proxy server to help it determine where to route requests. For more information about configuring a mod_cluster proxy server, see <a class="link" href="configuring_high_availability.html#mod_cluster-config" title="The mod_cluster HTTP Connector">The mod_cluster HTTP Connector</a>.
				</p><h5><a id="update_jboss_eap_configuration"/>Update JBoss EAP Configuration</h5><p>
					In the following procedure, substitute the protocols and ports in the examples with the ones you need to configure.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Configure the <code class="literal">instance-id</code> attribute of Undertow.
						</p><p class="simpara">
							The external web server identifies the JBoss EAP instance in its connector configuration using the <code class="literal">instance-id</code>. Use the following management CLI command to set the <code class="literal">instance-id</code> attribute in Undertow.
						</p><pre class="screen">/subsystem=undertow:write-attribute(name=instance-id,value=node1)</pre><p class="simpara">
							In the above example, the external web server identifies the current JBoss EAP instance as <code class="literal">node1</code>.
						</p></li><li class="listitem"><p class="simpara">
							Add the necessary listeners to Undertow.
						</p><p class="simpara">
							In order for an external web server to be able to connect to JBoss EAP, Undertow needs a listener. Each protocol needs its own listener, which is tied to a socket binding.
						</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								Depending on your desired protocol and port configuration, this step may not be necessary. An HTTP listener is configured in all default JBoss EAP configurations, and an AJP listener is configured if you are using the <span class="emphasis"><em>ha</em></span> or <span class="emphasis"><em>full-ha</em></span> profile.
							</p><p>
								You can check whether the required listeners are already configured by reading the default server configuration:
							</p><pre class="screen">/subsystem=undertow/server=default-server:read-resource</pre></div><p class="simpara">
							To add a listener to Undertow, it must have a socket binding. The socket binding is added to the socket binding group used by your server or server group. The following management CLI command adds an <code class="literal">ajp</code> socket binding, bound to port <code class="literal">8009</code>, to the <code class="literal">standard-sockets</code> socket binding group
						</p><pre class="screen">/socket-binding-group=standard-sockets/socket-binding=ajp:add(port=8009)</pre><p class="simpara">
							The following management CLI command adds an <code class="literal">ajp</code> listener to Undertow, using the <code class="literal">ajp</code> socket binding.
						</p><pre class="screen">/subsystem=undertow/server=default-server/ajp-listener=ajp:add(socket-binding=ajp)</pre></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="mod_cluster-config"/>The mod_cluster HTTP Connector</h1></div></div></div><p>
				The mod_cluster connector is an Apache HTTP Server-based load balancer. It uses a communication channel to forward requests from the Apache HTTP Server to one of a set of application server nodes.
			</p><p>
				The mod_cluster connector has several advantages over other connectors.
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						The mod_cluster Management Protocol (MCMP) is an additional connection between the JBoss EAP servers and the Apache HTTP Server with the mod_cluster module enabled. It is used by the JBoss EAP servers to transmit server-side load-balance factors and lifecycle events back to the Apache HTTP Server via a custom set of HTTP methods.
					</li><li class="listitem">
						Dynamic configuration of Apache HTTP Server with mod_cluster allows JBoss EAP servers to join the load-balancing arrangement without manual configuration.
					</li><li class="listitem">
						JBoss EAP performs the load-balancing factor calculations, rather than relying on the Apache HTTP Server with mod_cluster. This makes load-balancing metrics more accurate than other connectors.
					</li><li class="listitem">
						The mod_cluster connector gives fine-grained application lifecycle control. Each JBoss EAP server forwards web application context lifecycle events to the Apache HTTP Server, informing it to start or stop routing requests for a given context. This prevents end users from seeing HTTP errors due to unavailable resources.
					</li><li class="listitem">
						AJP, HTTP or HTTPS transports can be used.
					</li></ul></div><p>
				For more details on the specific configuration options of the <code class="literal">modcluster</code> subsystem, see the <a class="link" href="reference_material.html#mod_cluster-reference" title="ModCluster Subsystem Attributes">ModCluster Subsystem Attributes</a>.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_mod_cluster_in_apache_http_server"/>Configure mod_cluster in Apache HTTP Server</h2></div></div></div><p>
					The mod_cluster modules are already included when installing JBoss Core Services Apache HTTP Server or using JBoss Web Server and are loaded by default.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Apache HTTP Server is no longer distributed with JBoss Web Server as of version 3.1.0.
					</p></div><p>
					See the steps below to configure the mod_cluster module to suit your environment.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Red Hat customers can also use the <a class="link" href="https://access.redhat.com/labs/lbconfig/">Load Balancer Configuration Tool</a> on the Red Hat Customer Portal to quickly generate optimal configuration templates for mod_cluster and other connectors. Note that you must be logged in to access this tool.
					</p></div><h4><a id="configure_mod_cluster"/>Configure mod_cluster</h4><p>
					Apache HTTP Server already contains a mod_cluster configuration file, <code class="literal">mod_cluster.conf</code>, that loads the mod_cluster modules and provides basic configuration. The IP address, port, and other settings in this file, shown below, can be configured to suit your needs.
				</p><pre class="screen"># mod_proxy_balancer should be disabled when mod_cluster is used
LoadModule proxy_cluster_module modules/mod_proxy_cluster.so
LoadModule cluster_slotmem_module modules/mod_cluster_slotmem.so
LoadModule manager_module modules/mod_manager.so
LoadModule advertise_module modules/mod_advertise.so

MemManagerFile cache/mod_cluster

&lt;IfModule manager_module&gt;
  Listen 6666
  &lt;VirtualHost *:6666&gt;
    &lt;Directory /&gt;
      Require ip 127.0.0.1
    &lt;/Directory&gt;
    ServerAdvertise on
    EnableMCPMReceive
    &lt;Location /mod_cluster_manager&gt;
      SetHandler mod_cluster-manager
      Require ip 127.0.0.1
   &lt;/Location&gt;
  &lt;/VirtualHost&gt;
&lt;/IfModule&gt;</pre><p>
					The Apache HTTP Server server is configured as a load balancer and can work with the <code class="literal">modcluster</code> subsystem running on JBoss EAP. You must <a class="link" href="configuring_high_availability.html#configure_mod_cluster_worker_node" title="Configure a mod_cluster Worker Node">configure a mod_cluster worker node</a> to make JBoss EAP aware of mod_cluster.
				</p><p>
					If you want to disable advertising for mod_cluster and configure a static proxy list instead, see <a class="link" href="configuring_high_availability.html#disable_advertising_mod_cluster" title="Disable Advertising for mod_cluster">Disable Advertisement for mod_cluster</a>. For more information on the available mod_cluster configuration options in Apache HTTP Server, see the <a class="link" href="reference_material.html#apache_http_server_mod_cluster_directives" title="Apache HTTP Server mod_cluster Directives">Apache HTTP Server mod_cluster Directives</a>
				</p><p>
					For more details on configuring mod_cluster, see the <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_JBoss_Web_Server/3/html-single/HTTP_Connectors_and_Load_Balancing_Guide/index.html#sect-Configure_Load_Balancing_Using_Apache_HTTP_Server_and_mod_cluster">Configure Load Balancing Using Apache HTTP Server and mod_cluster</a> section of the JBoss Web Server <span class="emphasis"><em>HTTP Connectors and Load Balancing Guide</em></span>.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="disable_advertising_mod_cluster"/>Disable Advertising for mod_cluster</h2></div></div></div><p>
					By default, the <code class="literal">modcluster</code> subsystem’s balancer uses multicast UDP to advertise its availability to the background workers. You can disable advertising and to use a proxy list instead using the following procedure.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						The management CLI commands in the following procedure assume that you are using the <code class="literal">full-ha</code> profile in a managed domain. If you are using a profile other than <code class="literal">full-ha</code>, use the appropriate profile name in the command. If you are running a standalone server, remove the <code class="literal">/profile=full-ha</code> completely.
					</p></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Modify the Apache HTTP Server configuration.
						</p><p class="simpara">
							Edit the <code class="literal">httpd.conf</code> Apache HTTP Server configuration file. Make the following updates to the virtual host that listens for MCPM requests, using the <code class="literal">EnableMCPMReceive</code> directive.
						</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
									Add the directive to disable server advertisement.
								</p><p class="simpara">
									Set the <code class="literal">ServerAdvertise</code> directive to <code class="literal">Off</code> to disable server advertisement.
								</p><pre class="screen">ServerAdvertise Off</pre></li><li class="listitem"><p class="simpara">
									Disable the advertise frequency.
								</p><p class="simpara">
									If your configuration specifies the <code class="literal">AdvertiseFrequency</code> parameter, comment it out using a <code class="literal">#</code> character.
								</p><pre class="screen"># AdvertiseFrequency 5</pre></li><li class="listitem"><p class="simpara">
									Enable the ability to receive MCPM messages.
								</p><p class="simpara">
									Ensure that the <code class="literal">EnableMCPMReceive</code> directive exists, to allow the web server to receive MCPM messages from the worker nodes.
								</p><pre class="screen">EnableMCPMReceive</pre></li></ol></div></li><li class="listitem"><p class="simpara">
							Disable advertising in the JBoss EAP <code class="literal">modcluster</code> subsystem.
						</p><p class="simpara">
							Use the following management CLI command to disable advertising.
						</p><pre class="screen">/profile=full-ha/subsystem=modcluster/proxy=default:write-attribute(name=advertise,value=false)</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
								Be sure to continue to the next step to provide the list of proxies. Advertising will not be disabled if the list of proxies is empty.
							</p></div></li><li class="listitem"><p class="simpara">
							Provide a list of proxies in the JBoss EAP <code class="literal">modcluster</code> subsystem.
						</p><p class="simpara">
							It is necessary to provide a list of proxies because the <code class="literal">modcluster</code> subsystem will not be able to automatically discover proxies if advertising is disabled.
						</p><p class="simpara">
							First, define the outbound socket bindings in the appropriate socket binding group.
						</p><pre class="screen">/socket-binding-group=full-ha-sockets/remote-destination-outbound-socket-binding=proxy1:add(host=10.33.144.3,port=6666)
/socket-binding-group=full-ha-sockets/remote-destination-outbound-socket-binding=proxy2:add(host=10.33.144.1,port=6666)</pre><p class="simpara">
							Next, add the proxies to the mod_cluster configuration.
						</p><pre class="screen">/profile=full-ha/subsystem=modcluster/proxy=default:list-add(name=proxies,value=proxy1)
/profile=full-ha/subsystem=modcluster/proxy=default:list-add(name=proxies,value=proxy2)</pre></li></ol></div><p>
					The Apache HTTP Server balancer no longer advertises its presence to worker nodes and UDP multicast is no longer used.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_mod_cluster_worker_node"/>Configure a mod_cluster Worker Node</h2></div></div></div><p>
					A mod_cluster worker node consists of a JBoss EAP server. This server can be a standalone server or part of a server group in a managed domain. A separate process runs within JBoss EAP, which manages all of the worker nodes of the cluster. This is called the master.
				</p><p>
					Worker nodes in a managed domain share an identical configuration across a server group. Worker nodes running as standalone servers are configured individually. The configuration steps are otherwise identical.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							A standalone server must be started with the <span class="emphasis"><em>standalone-ha</em></span> or <span class="emphasis"><em>standalone-full-ha</em></span> profile.
						</li><li class="listitem">
							A server group in a managed domain must use the <span class="emphasis"><em>ha</em></span> or <span class="emphasis"><em>full-ha</em></span> profile, and the <span class="emphasis"><em>ha-sockets</em></span> or <span class="emphasis"><em>full-ha-sockets</em></span> socket binding group. JBoss EAP ships with a cluster-enabled server group called other-server-group which meets these requirements.
						</li></ul></div><h5><a id="configure_a_worker_node"/>Configure a Worker Node</h5><p>
					The management CLI commands in this procedure assume that you are using a managed domain with the <code class="literal">full-ha</code> profile. If you are running a standalone server, remove the <code class="literal">/profile=full-ha</code> portion of the commands.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Configure the network interfaces.
						</p><p class="simpara">
							By default, the network interfaces all default to <code class="literal">127.0.0.1</code>. Every physical host that hosts either a standalone server or one or more servers in a server group needs its interfaces to be configured to use its public IP address, which the other servers can see.
						</p><p class="simpara">
							Use the following management CLI commands to modify the external IP addresses for the <code class="literal">management</code>, <code class="literal">public</code>, and <code class="literal">unsecure</code> interfaces as appropriate for your environment. Be sure to replace <code class="literal"><span class="emphasis"><em>EXTERNAL_IP_ADDRESS</em></span></code> in the command with the actual external IP address of the host.
						</p><pre class="screen">/interface=management:write-attribute(name=inet-address,value="${jboss.bind.address.management:<span class="emphasis"><em>EXTERNAL_IP_ADDRESS</em></span>}")
/interface=public:write-attribute(name=inet-address,value="${jboss.bind.address.public:<span class="emphasis"><em>EXTERNAL_IP_ADDRESS</em></span>}")
/interface=unsecure:write-attribute(name=inet-address,value="${jboss.bind.address.unsecure:<span class="emphasis"><em>EXTERNAL_IP_ADDRESS</em></span>}")</pre><p class="simpara">
							Reload the server.
						</p><pre class="screen">reload</pre></li><li class="listitem"><p class="simpara">
							Configure host names.
						</p><p class="simpara">
							Set a unique host name for each host that participates in a managed domain. This name must be unique across slaves and will be used for the slave to identify to the cluster, so make a note of the name you use.
						</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
									Start the JBoss EAP slave host, using the appropriate <code class="literal">host.xml</code> configuration file.
								</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/domain.sh --host-config=host-slave.xml</pre></li><li class="listitem"><p class="simpara">
									Use the following management CLI command to set a unique host name. This example uses <code class="literal">slave1</code> as the new host name.
								</p><pre class="screen">/host=<span class="emphasis"><em>EXISTING_HOST_NAME</em></span>:write-attribute(name=name,value=slave1)</pre><p class="simpara">
									For more information on configuring a host name, see <a class="link" href="domain_management.html#configure_name_of_host" title="Configure the Name of a Host">Configure the Name of a Host</a>.
								</p></li></ol></div></li><li class="listitem"><p class="simpara">
							Configure each host to connect to the domain controller.
						</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								This step does not apply for a standalone server.
							</p></div><p class="simpara">
							For newly configured hosts that need to join a managed domain, you must remove the local element and add the remote element host attribute that points to the domain controller.
						</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
									Start the JBoss EAP slave host, using the appropriate <code class="literal">host.xml</code> configuration file.
								</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/domain.sh --host-config=host-slave.xml</pre></li><li class="listitem"><p class="simpara">
									Use the following management CLI command to configure the domain controller settings.
								</p><pre class="screen">/host=<span class="emphasis"><em>SLAVE_HOST_NAME</em></span>:write-remote-domain-controller(host=<span class="emphasis"><em>DOMAIN_CONTROLLER_IP_ADDRESS</em></span>,port=${jboss.domain.master.port:9999},security-realm="ManagementRealm")</pre><p class="simpara">
									This modifies the XML in the host-slave.xml file as follows:
								</p><pre class="programlisting">&lt;domain-controller&gt;
    &lt;remote host="<span class="emphasis"><em>DOMAIN_CONTROLLER_IP_ADDRESS</em></span>" port="${jboss.domain.master.port:9999}" security-realm="ManagementRealm"/&gt;
&lt;/domain-controller&gt;</pre><p class="simpara">
									For more information, see <a class="link" href="domain_management.html#configure_host_controllers" title="Configure Host Controllers">Connect to the Domain Controller</a>.
								</p></li></ol></div></li><li class="listitem"><p class="simpara">
							Configure authentication for each slave host.
						</p><p class="simpara">
							Each slave server needs a username and password created in the domain controller’s or standalone master’s ManagementRealm. On the domain controller or standalone master, run the <code class="literal"><span class="emphasis"><em>EAP_HOME</em></span>/bin/add-user.sh</code> command for each host. Add a management user for each host with the username that matches the host name of the slave.
						</p><p class="simpara">
							Be sure to answer <code class="literal">yes</code> to the last question, that asks "Is this new user going to be used for one AS process to connect to another AS process?", so that you are provided with a secret value.
						</p><div class="title"><strong>Example: <code class="literal">add-user.sh</code> Script Output <span class="emphasis"><em>(trimmed)</em></span></strong></div><p>
								
</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/add-user.sh

What type of user do you wish to add?
 a) Management User (mgmt-users.properties)
 b) Application User (application-users.properties)
(a): a

Username : slave1
Password : changeme
Re-enter Password : changeme
What groups do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)[  ]:
About to add user 'slave1' for realm 'ManagementRealm'
Is this correct yes/no? yes
Is this new user going to be used for one AS process to connect to another AS process?
e.g. for a slave host controller connecting to the master or for a Remoting connection for server to server EJB calls.
yes/no? yes
To represent the user add the following to the server-identities definition &lt;secret value="<span class="emphasis"><em>SECRET_VALUE</em></span>" /&gt;</pre><p>

							</p><p class="simpara">
							Copy the Base64-encoded secret value provided from this output, <code class="literal"><span class="emphasis"><em>SECRET_VALUE</em></span></code>, which may be used in the next step.
						</p><p class="simpara">
							For more information, see the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_server_security/#add_user_master_domain_controller">Adding a User to the Master Domain Controller</a> section of the JBoss EAP <span class="emphasis"><em>How To Configure Server Security</em></span> guide.
						</p></li><li class="listitem"><p class="simpara">
							Modify the slave host’s security realm to use the new authentication.
						</p><p class="simpara">
							You can specify the password by setting the secret value in the server configuration, getting the password from a credential store or vault, or passing the password as a system property.
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
									Specify the Base64-encoded password value in the server configuration file using the Management CLI.
								</p><p class="simpara">
									Use the following management CLI command to specify the secret value. Be sure to replace the <code class="literal"><span class="emphasis"><em>SECRET_VALUE</em></span></code> with the secret value returned from the add-user output from the previous step.
								</p><pre class="screen">/host=<span class="emphasis"><em>SLAVE_HOST_NAME</em></span>/core-service=management/security-realm=ManagementRealm/server-identity=secret:add(value="<span class="emphasis"><em>SECRET_VALUE</em></span>")</pre><p class="simpara">
									You will need to reload the server. The <code class="literal">--host</code> argument is not applicable for a standalone server.
								</p><pre class="screen">reload --host=<span class="emphasis"><em>HOST_NAME</em></span></pre><p class="simpara">
									For more information, see the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_server_security/#configuring_slave_controllers_use_credential">Configuring the Slave Controllers to Use the Credential</a> section of the JBoss EAP <span class="emphasis"><em>How To Configure Server Security</em></span> guide.
								</p></li><li class="listitem"><p class="simpara">
									Configure the host to get the password from a credential store.
								</p><p class="simpara">
									If you have stored the secret value in a credential store, you can use the following command to set the server secret to be a value from a credential store:
								</p><pre class="screen">/host=<span class="emphasis"><em>SLAVE_HOST_NAME</em></span>/core-service=management/security-realm=ManagementRealm/server-identity=secret:add(credential-reference={store=<span class="emphasis"><em>STORE_NAME</em></span>,alias=<span class="emphasis"><em>ALIAS</em></span>}</pre><p class="simpara">
									You will need to reload the server. The <code class="literal">--host</code> argument is not applicable for a standalone server.
								</p><pre class="screen">reload --host=<span class="emphasis"><em>HOST_NAME</em></span></pre><p class="simpara">
									For more information, see the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_server_security/#credential_store">Credential Store</a> section of the JBoss EAP <span class="emphasis"><em>How To Configure Server Security</em></span> guide.
								</p></li><li class="listitem"><p class="simpara">
									Configure the host to get the password from a vault.
								</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
											Use the <code class="literal"><span class="emphasis"><em>EAP_HOME</em></span>/bin/vault.sh</code> script to generate a masked password. It will generate a string in the format <code class="literal">VAULT::secret::password::<span class="emphasis"><em>VAULT_SECRET_VALUE</em></span></code>, for example:
										</p><pre class="screen">VAULT::secret::password::ODVmYmJjNGMtZDU2ZC00YmNlLWE4ODMtZjQ1NWNmNDU4ZDc1TElORV9CUkVBS3ZhdWx0.</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
												When creating a password in the vault, it must be specified in plain text, not Base64-encoded.
											</p></div></li><li class="listitem"><p class="simpara">
											Use the following management CLI command to specify the secret value. Be sure to replace the <code class="literal"><span class="emphasis"><em>VAULT_SECRET_VALUE</em></span></code> with the masked password generated in the previous step.
										</p><pre class="screen">/host=master/core-service=management/security-realm=ManagementRealm/server-identity=secret:add(value="${VAULT::secret::password::<span class="emphasis"><em>VAULT_SECRET_VALUE</em></span>}")</pre><p class="simpara">
											You will need to reload the server. The <code class="literal">--host</code> argument is not applicable for a standalone server.
										</p><pre class="screen">reload --host=<span class="emphasis"><em>HOST_NAME</em></span></pre><p class="simpara">
											For more information, see the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/how_to_configure_server_security/#password_vault">Password Vault</a> section of the JBoss EAP <span class="emphasis"><em>How To Configure Server Security</em></span> guide.
										</p></li></ol></div></li><li class="listitem"><p class="simpara">
									Specify the password as a system property.
								</p><p class="simpara">
									The following examples use <code class="literal">server.identity.password</code> as the system property name for the password.
								</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
											Specify the system property for the password in the server configuration file.
										</p><p class="simpara">
											Use the following managemente CLI command to configure the secret identity to use the system property.
										</p><pre class="screen">/host=<span class="emphasis"><em>SLAVE_HOST_NAME</em></span>/core-service=management/security-realm=ManagementRealm/server-identity=secret:add(value="${server.identity.password}")</pre><p class="simpara">
											You will need to reload the server. The <code class="literal">--host</code> argument is not applicable for a standalone server.
										</p><pre class="screen">reload --host=master</pre></li><li class="listitem"><p class="simpara">
											Set the password for the system property when starting the server.
										</p><p class="simpara">
											You can set the <code class="literal">server.identity.password</code> system property by passing it as a command line argument or in a properties file.
										</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
													Pass in as a plain text command line argument.
												</p><p class="simpara">
													Start the server and pass in the <code class="literal">server.identity.password</code> property.
												</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/domain.sh --host-config=host-slave.xml -Dserver.identity.password=changeme</pre><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
														The password must be entered in plain text and will be visible to anyone who issues a <code class="literal">ps -ef</code> command.
													</p></div></li><li class="listitem"><p class="simpara">
													Set the property in a properties file.
												</p><p class="simpara">
													Create a properties file and add the key/value pair to a properties file, for example:
												</p><pre class="screen">server.identity.password=changeme</pre><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
														The password is in plain text and will be visible to anyone who has access to this properties file.
													</p></div><p class="simpara">
													Start the server with the command line arguments.
												</p><pre class="screen">$ <span class="emphasis"><em>EAP_HOME</em></span>/bin/domain.sh --host-config=host-slave.xml --properties=<span class="emphasis"><em>PATH_TO_PROPERTIES_FILE</em></span></pre></li></ol></div></li></ol></div></li></ul></div></li><li class="listitem"><p class="simpara">
							Restart the server.
						</p><p class="simpara">
							The slave will now authenticate to the master using its host name as the username and the encrypted string as its password.
						</p></li></ol></div><p>
					Your standalone server, or servers within a server group of a managed domain, are now configured as mod_cluster worker nodes. If you deploy a clustered application, its sessions are replicated to all cluster nodes for failover, and it can accept requests from an external web server or load balancer. Each node of the cluster discovers the other nodes using automatic discovery, by default.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_fail_on_status_parameter"/>Configure the mod_cluster fail_on_status Parameter</h2></div></div></div><p>
					The <code class="literal">fail_on_status</code> parameter lists those HTTP status codes which, when returned by a worker node in a cluster, will mark that node as having failed. The load balancer will then send future requests to another worker node in the cluster. The failed worker node will remain in a <code class="literal">NOTOK</code> state until it sends the load balancer a <code class="literal">STATUS</code> message.
				</p><p>
					The <code class="literal">fail_on_status</code> parameter must be configured in the <code class="literal">httpd</code> configuration file of your load balancer. Multiple HTTP status codes for <code class="literal">fail_on_status</code> can be specified as a comma-separated list. The following example specifies the HTTP status codes <code class="literal">203</code> and <code class="literal">204</code> for <code class="literal">fail_on_status</code>. ⁠
				</p><div class="title"><strong>Example: Configuring fail_on_status</strong></div><p>
						
</p><pre class="screen">ProxyPass / balancer://MyBalancer stickysession=JSESSIONID|jsessionid nofailover=on failonstatus=203,204
ProxyPassReverse / balancer://MyBalancer
ProxyPreserveHost on</pre><p>

					</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrate_traffic_between_clusters"/>Migrate Traffic Between Clusters</h2></div></div></div><p>
					After creating a new cluster using JBoss EAP, you can migrate traffic from the previous cluster to the new one as part of an upgrade process. In this task, you will see the strategy that can be used to migrate this traffic with minimal outage or downtime.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							A new cluster setup. We will call this cluster <span class="emphasis"><em>ClusterNEW</em></span>.
						</li><li class="listitem">
							An old cluster setup that is being made redundant. We will call this cluster <span class="emphasis"><em>ClusterOLD</em></span>.
						</li></ul></div><h5><a id="upgrade_process_for_clusters_load_balancing_groups"/>Upgrade Process for Clusters - Load-Balancing Groups</h5><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
							Set up your new cluster using the steps described in the prerequisites.
						</li><li class="listitem"><p class="simpara">
							In both <span class="emphasis"><em>ClusterNEW</em></span> and <span class="emphasis"><em>ClusterOLD</em></span>, ensure that the configuration option <code class="literal">sticky-session</code> is set to the default setting of <code class="literal">true</code>. Enabling this option means that all new requests made to a cluster node in any of the clusters will continue to go to the respective cluster node.
						</p><pre class="screen">/profile=full-ha/subsystem=modcluster/proxy=default:write-attribute(name=sticky-session,value=true)</pre></li><li class="listitem"><p class="simpara">
							Set the <code class="literal">load-balancing-group</code> to <code class="literal">ClusterOLD</code>, assuming that all the cluster nodes in <span class="emphasis"><em>ClusterOLD</em></span> are members of the <span class="emphasis"><em>ClusterOLD</em></span> load-balancing group.
						</p><pre class="screen">/profile=full-ha/subsystem=modcluster/proxy=default:write-attribute(name=load-balancing-group,value=ClusterOLD)</pre></li><li class="listitem"><p class="simpara">
							Add the nodes in <span class="emphasis"><em>ClusterNEW</em></span> to the mod_cluster configuration individually using the process described in the <a class="link" href="configuring_high_availability.html#configure_mod_cluster_worker_node" title="Configure a mod_cluster Worker Node">Configure a mod_cluster Worker Node</a> section. Additionally, use the aforementioned procedure and set their load-balancing group to <span class="emphasis"><em>ClusterNEW</em></span>.
						</p><p class="simpara">
							At this point, you can see an output similar to the undermentioned shortened example on the <span class="emphasis"><em>mod_cluster-manager</em></span> console:
						</p><pre class="screen">                mod_cluster/&lt;version&gt;

    LBGroup ClusterOLD: [Enable Nodes]   [Disable Nodes]   [Stop Nodes]
        Node node-1-jvmroute (ajp://node1.oldcluster.example:8009):
            [Enable Contexts]   [Disable Contexts]   [Stop Contexts]
            Balancer: qacluster, LBGroup: ClusterOLD, Flushpackets: Off, ..., Load: 100
            Virtual Host 1:
                Contexts:
                    /my-deployed-application-context, Status: ENABLED Request: 0 [Disable]   [Stop]

        Node node-2-jvmroute (ajp://node2.oldcluster.example:8009):
            [Enable Contexts]   [Disable Contexts]   [Stop Contexts]
            Balancer: qacluster, LBGroup: ClusterOLD, Flushpackets: Off, ..., Load: 100
            Virtual Host 1:
                Contexts:
                    /my-deployed-application-context, Status: ENABLED Request: 0 [Disable]   [Stop]


    LBGroup ClusterNEW: [Enable Nodes]   [Disable Nodes]   [Stop Nodes]
        Node node-3-jvmroute (ajp://node3.newcluster.example:8009):
            [Enable Contexts]   [Disable Contexts]   [Stop Contexts]
            Balancer: qacluster, LBGroup: ClusterNEW, Flushpackets: Off, ..., Load: 100
            Virtual Host 1:
                Contexts:
                    /my-deployed-application-context, Status: ENABLED Request: 0 [Disable]   [Stop]

        Node node-4-jvmroute (ajp://node4.newcluster.example:8009):
            [Enable Contexts]   [Disable Contexts]   [Stop Contexts]
            Balancer: qacluster, LBGroup: ClusterNEW, Flushpackets: Off, ..., Load: 100
            Virtual Host 1:
                Contexts:
                    /my-deployed-application-context, Status: ENABLED Request: 0 [Disable]   [Stop]</pre></li><li class="listitem"><p class="simpara">
							Any old active sessions are within the <span class="emphasis"><em>ClusterOLD</em></span> group, and any new sessions are created either within the <span class="emphasis"><em>ClusterOLD</em></span> or <span class="emphasis"><em>CLusterNEW</em></span> group. Next, we want to disable the whole <span class="emphasis"><em>ClusterOLD</em></span> group, so that its cluster nodes may be removed without causing any error to currently active client’s sessions.
						</p><p class="simpara">
							Click on the <span class="strong"><strong>Disable Nodes</strong></span> link for LBGroup <span class="emphasis"><em>ClusterOLD</em></span> on the <span class="emphasis"><em>mod_cluster-manager</em></span> web console.
						</p><p class="simpara">
							From this point on, only requests belonging to already established sessions will be routed to members of the <span class="emphasis"><em>ClusterOLD</em></span> load-balancing group. Any new client’s sessions will be created in the <span class="emphasis"><em>ClusterNEW</em></span> group only. As soon as there are no active sessions within <span class="emphasis"><em>ClusterOLD</em></span> group, we can safely remove its members.
						</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								Using <span class="strong"><strong>Stop Nodes</strong></span> would command the load balancer to stop routing any requests to this domain immediately. This will force a failover to another load-balancing group which will cause session data loss to clients, provided there is no session replication between <span class="emphasis"><em>ClusterNEW</em></span> and <span class="emphasis"><em>ClusterOLD</em></span>.
							</p></div></li></ol></div><h5><a id="default_load_balancing_group"/>Default Load-Balancing Group</h5><p>
					In case the current <span class="emphasis"><em>ClusterOLD</em></span> setup does not contain any load-balancing group settings, found from LBGroup: on the <span class="emphasis"><em>mod_cluster-manager</em></span> console, one can still take advantage of disabling the <span class="emphasis"><em>ClusterOLD</em></span> nodes. In this case, click on <span class="strong"><strong>Disable Contexts</strong></span> for each of the <span class="emphasis"><em>ClusterOLD</em></span> nodes. Contexts of these nodes will be disabled, and once there are no active sessions present they will be ready for removal. New clients' sessions will be created only on nodes with enabled contexts, presumably <span class="emphasis"><em>ClusterNEW</em></span> members in this example.
				</p><h5><a id="using_the_management_cli"/>Using the Management CLI</h5><p>
					In addition to using the <span class="emphasis"><em>mod_cluster-manager</em></span> web console, you can use the JBoss EAP management CLI to stop or disable a particular context.
				</p><div class="title"><strong>Stop a Context</strong></div><p>
						
</p><pre class="screen">/host=master/server=server-one/subsystem=modcluster:stop-context(context=/my-deployed-application-context, virtualhost=default-host, waittime=0)</pre><p>

					</p><p>
					Stopping a context with <code class="literal">waittime</code> set to <code class="literal">0</code>, meaning no timeout, instructs the balancer to stop routing any request to it immediately, which forces failover to another available context.
				</p><p>
					If you set a timeout value using the <code class="literal">waittime</code> argument, no new sessions are created on this context, but existing sessions will continue to be directed to this node until they complete or the specified timeout has elapsed. The <code class="literal">waittime</code> argument defaults to <code class="literal">10</code> seconds.
				</p><div class="title"><strong>Disable a Context</strong></div><p>
						
</p><pre class="screen">/host=master/server=server-one/subsystem=modcluster:disable-context(context=/my-deployed-application-context, virtualhost=default-host)</pre><p>

					</p><p>
					Disabling a context tells the balancer that no new sessions should be created on this context.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="mod_jk-config"/>Apache mod_jk HTTP Connector</h1></div></div></div><p>
				<span class="emphasis"><em>Apache mod_jk</em></span> is an HTTP connector that is provided for customers who need it for compatibility purposes.
			</p><p>
				JBoss EAP can accept workloads from an Apache HTTP proxy server. The proxy server accepts client requests from the web front end, and passes the work to participating JBoss EAP servers. If sticky sessions are enabled, the same client request always goes to the same JBoss EAP server, unless the server is unavailable.
			</p><p>
				mod_jk communicates over the AJP 1.3 protocol. Other protocols can be used with <span class="emphasis"><em>mod_cluster</em></span> or <span class="emphasis"><em>mod_proxy</em></span>. See the <a class="link" href="configuring_high_availability.html#overview_http_connectors" title="Overview of HTTP Connectors">Overview of HTTP Connectors</a> for more information.
			</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					<span class="emphasis"><em>mod_cluster</em></span> is a more advanced load balancer than mod_jk and is the recommended HTTP connector. mod_cluster provides all of the functionality of mod_jk, plus additional features. Unlike the JBoss EAP mod_cluster HTTP connector, an Apache mod_jk HTTP connector does not know the status of deployments on servers or server groups, and cannot adapt where it sends its work accordingly.
				</p></div><p>
				See the <a class="link" href="http://tomcat.apache.org/connectors-doc/">Apache mod_jk documentation</a> for more information.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_mod_jk_in_apache_http_server"/>Configure mod_jk in Apache HTTP Server</h2></div></div></div><p>
					The mod_jk module, <code class="literal">mod_jk.so</code>, is already included when installing JBoss Core Services Apache HTTP Server or using JBoss Web Server; however, it is not loaded by default.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Apache HTTP Server is no longer distributed with JBoss Web Server as of version 3.1.0.
					</p></div><p>
					Use the following steps to load and configure mod_jk in Apache HTTP Server. Note that these steps assume that you have already navigated to the <code class="literal">httpd/</code> directory for Apache HTTP Server, which will vary depending on your platform. For more information, see the installation instructions for your platform in the JBoss Core Services <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_core_services_apache_http_server/2.4/html-single/apache_http_server_installation_guide/"><span class="emphasis"><em>Apache HTTP Server Installation Guide</em></span></a>.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Red Hat customers can also use the <a class="link" href="https://access.redhat.com/labs/lbconfig/">Load Balancer Configuration Tool</a> on the Red Hat Customer Portal to quickly generate optimal configuration templates for mod_jk and other connectors. Note that you must be logged in to access this tool.
					</p></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Configure the mod_jk module.
						</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								A sample mod_jk configuration file is provided at <code class="literal">conf.d/mod_jk.conf.sample</code>. You can use this sample instead of creating your own file by removing the <code class="literal">.sample</code> extension and modifying its contents as needed.
							</p></div><p class="simpara">
							Create a new file called <code class="literal">conf.d/mod_jk.conf</code>. Add the following configuration to the file, making sure to modify the contents to suite your needs.
						</p><pre class="screen"># Load mod_jk module
# Specify the filename of the mod_jk lib
LoadModule jk_module modules/mod_jk.so

# Where to find workers.properties
JkWorkersFile conf.d/workers.properties

# Where to put jk logs
JkLogFile logs/mod_jk.log

# Set the jk log level [debug/error/info]
JkLogLevel info

# Select the log format
JkLogStampFormat  "[%a %b %d %H:%M:%S %Y]"

# JkOptions indicates to send SSK KEY SIZE
JkOptions +ForwardKeySize +ForwardURICompat -ForwardDirectories

# JkRequestLogFormat
JkRequestLogFormat "%w %V %T"

# Mount your applications
JkMount /application/* loadbalancer

# Add shared memory.
# This directive is present with 1.2.10 and
# later versions of mod_jk, and is needed for
# for load balancing to work properly
JkShmFile logs/jk.shm

# Add jkstatus for managing runtime data
&lt;Location /jkstatus/&gt;
    JkMount status
    Require ip 127.0.0.1
&lt;/Location&gt;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								The JkMount directive specifies which URLs Apache HTTP Server must forward to the mod_jk module. Based on the directive’s configuration, mod_jk sends the received URL to the correct workers. To serve static content directly and only use the load balancer for Java applications, the URL path must be <code class="literal">/application/*</code>. To use mod_jk as a load balancer, use the value <code class="literal">/*</code>, to forward all URLs to mod_jk.
							</p></div><p class="simpara">
							Aside from general mod_jk configuration, this file specifies to load the <code class="literal">mod_jk.so</code> module, and defines where to find the <code class="literal">workers.properties</code> file.
						</p></li><li class="listitem"><p class="simpara">
							Configure the mod_jk worker nodes.
						</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								A sample workers configuration file is provided at <code class="literal">conf.d/workers.properties.sample</code>. You can use this sample instead of creating your own file by removing the <code class="literal">.sample</code> extension and modifying its contents as needed.
							</p></div><p class="simpara">
							Create a new file called <code class="literal">conf.d/workers.properties</code>. Add the following configuration to the file, making sure to modify the contents to suite your needs.
						</p><pre class="screen"># Define list of workers that will be used
# for mapping requests
worker.list=loadbalancer,status

# Define Node1
# modify the host as your host IP or DNS name.
worker.node1.port=8009
worker.node1.host=node1.mydomain.com
worker.node1.type=ajp13
worker.node1.ping_mode=A
worker.node1.lbfactor=1

# Define Node2
# modify the host as your host IP or DNS name.
worker.node2.port=8009
worker.node2.host=node2.mydomain.com
worker.node2.type=ajp13
worker.node2.ping_mode=A
worker.node2.lbfactor=1

# Load-balancing behavior
worker.loadbalancer.type=lb
worker.loadbalancer.balance_workers=node1,node2
worker.loadbalancer.sticky_session=1

# Status worker for managing load balancer
worker.status.type=status</pre><p class="simpara">
							For details on the syntax of the mod_jk <code class="literal">workers.properties</code> file and other advanced configuration options, see <a class="link" href="reference_material.html#mod_jk_worker_properties" title="mod_jk Worker Properties">mod_jk Worker Properties</a>.
						</p></li><li class="listitem"><p class="simpara">
							Optionally, specify a JKMountFile directive.
						</p><p class="simpara">
							In addition to the JKMount directive in the <code class="literal">mod-jk.conf</code>, you can specify a file which contains multiple URL patterns to be forwarded to mod_jk.
						</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
									Create a <code class="literal">uriworkermap.properties</code> file.
								</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
										A sample URI worker map configuration file is provided at <code class="literal">conf.d/uriworkermap.properties.sample</code>. You can use this sample instead of creating your own file by removing the <code class="literal">.sample</code> extension and modifying its contents as needed.
									</p></div><p class="simpara">
									Create a new file called <code class="literal">conf.d/uriworkermap.properties</code>. Add a line for each URL pattern to be matched, for example:
								</p><pre class="screen"># Simple worker configuration file
/*=loadbalancer</pre></li><li class="listitem"><p class="simpara">
									Update the configuration to point to <code class="literal">uriworkermap.properties</code> file.
								</p><p class="simpara">
									Append the following to <code class="literal">conf.d/mod_jk.conf</code>.
								</p><pre class="screen"># Use external file for mount points.
# It will be checked for updates each 60 seconds.
# The format of the file is: /url=worker
# /examples/*=loadbalancer
JkMountFile conf.d/uriworkermap.properties</pre></li></ol></div></li></ol></div><p>
					For more details on configuring mod_jk, see the <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_JBoss_Web_Server/3/html-single/HTTP_Connectors_and_Load_Balancing_Guide/index.html#Configure_Load_Balancing_Using_Apache_and_mod_jk">Configuring Apache HTTP Server to Load mod_jk</a> section of the JBoss Web Server <span class="emphasis"><em>HTTP Connectors and Load Balancing Guide</em></span>.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_jboss_eap_with_mod_jk"/>Configure JBoss EAP to Communicate with mod_jk</h2></div></div></div><p>
					The JBoss EAP <code class="literal">undertow</code> subsystem needs to specify a listener in order to accept requests from and send replies back to an external web server. Since mod_jk uses the AJP protocol, an AJP listener must be configured.
				</p><p>
					If you are using one of the default high availability configurations, <span class="emphasis"><em>ha</em></span> or <span class="emphasis"><em>full-ha</em></span>, an AJP listener is already configured.
				</p><p>
					For instructions, see <a class="link" href="configuring_high_availability.html#configure_accept_requests_external_web_servers" title="Accepting Requests from External Web Servers">Accepting Requests From External Web Servers</a>.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="mod_proxy-config"/>Apache mod_proxy HTTP Connector</h1></div></div></div><p>
				<span class="emphasis"><em>Apache mod_proxy</em></span> is an HTTP connector that supports connections over AJP, HTTP, and HTTPS protocols. mod_proxy can be configured in load-balanced or non-load-balanced configurations, and it supports the notion of sticky sessions.
			</p><p>
				The mod_proxy module requires JBoss EAP to have the HTTP, HTTPS or AJP listener configured in the <code class="literal">undertow</code> subsystem, depending on which protocol you plan to use.
			</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					<span class="emphasis"><em>mod_cluster</em></span> is a more advanced load balancer than mod_proxy and is the recommended HTTP connector. mod_cluster provides all of the functionality of mod_proxy, plus additional features. Unlike the JBoss EAP mod_cluster HTTP connector, an Apache mod_proxy HTTP connector does not know the status of deployments on servers or server groups, and cannot adapt where it sends its work accordingly.
				</p></div><p>
				See the <a class="link" href="http://httpd.apache.org/docs/2.4/mod/mod_proxy.html">Apache mod_proxy documentation</a> for more information.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_mod_proxy_apache_http_server"/>Configure mod_proxy in Apache HTTP Server</h2></div></div></div><p>
					The mod_proxy modules are already included when installing JBoss Core Services Apache HTTP Server or using JBoss Web Server and are loaded by default.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Apache HTTP Server is no longer distributed with JBoss Web Server as of version 3.1.0.
					</p></div><p>
					See the appropriate section below to configure a basic <a class="link" href="configuring_high_availability.html#add_load_balancing_proxy" title="Add a Load-balancing Proxy">load-balancing</a> or <a class="link" href="configuring_high_availability.html#add_non_load_balancing_proxy" title="Add a Non-load-balancing Proxy">non-load-balancing</a> proxy. These steps assume that you have already navigated to the <code class="literal">httpd/</code> directory for Apache HTTP Server, which will vary depending on your platform. For more information, see the installation instructions for your platform in the JBoss Core Services <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_core_services_apache_http_server/2.4/html-single/apache_http_server_installation_guide/"><span class="emphasis"><em>Apache HTTP Server Installation Guide</em></span></a>. These steps also assume that the necessary HTTP listener has already been configured in the JBoss EAP <code class="literal">undertow</code> subsystem.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Red Hat customers can also use the <a class="link" href="https://access.redhat.com/labs/lbconfig/">Load Balancer Configuration Tool</a> on the Red Hat Customer Portal to quickly generate optimal configuration templates for mod_proxy and other connectors. Note that you must be logged in to access this tool.
					</p></div><h4><a id="add_non_load_balancing_proxy"/>Add a Non-load-balancing Proxy</h4><p>
					Add the following configuration to your <code class="literal">conf/httpd.conf</code> file, directly beneath any other <code class="literal">&lt;VirtualHost&gt;</code> directives you may have. Replace the values with ones appropriate to your setup.
				</p><pre class="screen">&lt;VirtualHost *:80&gt;
# Your domain name
ServerName <span class="emphasis"><em>YOUR_DOMAIN_NAME</em></span>

ProxyPreserveHost On

# The IP and port of JBoss
# These represent the default values, if your httpd is on the same host
# as your JBoss managed domain or server

ProxyPass / http://localhost:8080/
ProxyPassReverse / http://localhost:8080/

# The location of the HTML files, and access control information
DocumentRoot /var/www
&lt;Directory /var/www&gt;
Options -Indexes
Order allow,deny
Allow from all
&lt;/Directory&gt;
&lt;/VirtualHost&gt;</pre><h4><a id="add_load_balancing_proxy"/>Add a Load-balancing Proxy</h4><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						The default Apache HTTP Server configuration has the <code class="literal">mod_proxy_balancer.so</code> module disabled, as it is incompatible with mod_cluster. In order to complete this task, you will need to load this module and disable the mod_cluster modules.
					</p></div><p>
					To use mod_proxy as a load balancer, and send work to multiple JBoss EAP instances, add the following configuration to your <code class="literal">conf/httpd.conf</code> file. The example IP addresses are fictional. Replace them with the appropriate values for your environment.
				</p><pre class="screen">&lt;Proxy balancer://mycluster&gt;

Order deny,allow
Allow from all

# Add each JBoss Enterprise Application Server by IP address and port.
# If the route values are unique like this, one node will not fail over to the other.
BalancerMember http://192.168.1.1:8080 route=node1
BalancerMember http://192.168.1.2:8180 route=node2
&lt;/Proxy&gt;

&lt;VirtualHost *:80&gt;
 # Your domain name
 ServerName <span class="emphasis"><em>YOUR_DOMAIN_NAME</em></span>

 ProxyPreserveHost On
 ProxyPass / balancer://mycluster/

 # The location of the HTML files, and access control information DocumentRoot /var/www
 &lt;Directory /var/www&gt;
  Options -Indexes
  Order allow,deny
  Allow from all
 &lt;/Directory&gt;

&lt;/VirtualHost&gt;</pre><p>
					The examples above all communicate using the HTTP protocol. You can use AJP or HTTPS protocols instead, if you load the appropriate mod_proxy modules. See the <a class="link" href="http://httpd.apache.org/docs/2.4/mod/mod_proxy.html">Apache mod_proxy documentation</a> for more details.
				</p><h5><a id="enable_sticky_sessions"/>Enable Sticky Sessions</h5><p>
					A <span class="emphasis"><em>sticky session</em></span> means that if a client request originally goes to a specific JBoss EAP worker, all future requests will be sent to the same worker, unless it becomes unavailable. This is almost always the recommended behavior.
				</p><p>
					To enable sticky sessions for mod_proxy, add the <code class="literal">stickysession</code> parameter to the <code class="literal">ProxyPass</code> statement.
				</p><pre class="screen">ProxyPass / balancer://mycluster stickysession=JSESSIONID</pre><p>
					You can specify additional parameters to the <code class="literal">ProxyPass</code> statement, such as <code class="literal">lbmethod</code> and <code class="literal">nofailover</code>. See the <a class="link" href="http://httpd.apache.org/docs/2.4/mod/mod_proxy.html">Apache mod_proxy documentation</a> for more information on the available parameters.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_jboss_eap_mod_proxy"/>Configure JBoss EAP to Communicate with mod_proxy</h2></div></div></div><p>
					The JBoss EAP <code class="literal">undertow</code> subsystem needs to specify a listener in order to accept requests from and send replies back to an external web server. Depending on the protocol that you will be using, you may need to configure a listener.
				</p><p>
					An HTTP listener is configured in the JBoss EAP default configuration. If you are using one of the default high availability configurations, <span class="emphasis"><em>ha</em></span> or <span class="emphasis"><em>full-ha</em></span>, an AJP listener is also preconfigured.
				</p><p>
					For instructions, see <a class="link" href="configuring_high_availability.html#configure_accept_requests_external_web_servers" title="Accepting Requests from External Web Servers">Accepting Requests From External Web Servers</a>.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ISAPI_config"/>Microsoft ISAPI Connector</h1></div></div></div><p>
				The Internet Server API (ISAPI) is a set of APIs used to write OLE Server extensions and filters for web servers such as Microsoft’s Internet Information Services (IIS). <code class="literal">isapi_redirect.dll</code> is an extension of <span class="emphasis"><em>mod_jk</em></span> adjusted to IIS. <code class="literal">isapi_redirect.dll</code> enables you to configure JBoss EAP instances as worker nodes with IIS as a load balancer.
			</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					See <a class="link" href="https://access.redhat.com/articles/2026253">JBoss EAP supported configurations</a> for information on the supported configurations of Windows Server and IIS.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_iis_use_isapi_connector"/>Configure Microsoft IIS to Use the ISAPI Connector</h2></div></div></div><p>
					Download the ISAPI connector from the Red Hat Customer Portal:
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
							Open a browser and log in to the Red Hat Customer Portal <a class="link" href="https://access.redhat.com/jbossnetwork/restricted/listSoftware.html">JBoss Software Downloads page</a>.
						</li><li class="listitem">
							Select <span class="strong"><strong>Web Connectors</strong></span> in the <span class="strong"><strong>Product</strong></span> drop-down menu.
						</li><li class="listitem">
							Select the latest JBoss Core Services version from the <span class="strong"><strong>Version</strong></span> drop-down menu.
						</li><li class="listitem">
							Find the <span class="strong"><strong>Red Hat JBoss Core Services ISAPI Connector</strong></span> in the list, and click the <span class="strong"><strong>Download</strong></span> link.
						</li><li class="listitem">
							Extract the archive and copy the contents of the <code class="literal">sbin</code> directory to a location on your server. The instructions below assume that the contents were copied to <code class="literal">C:\connectors\</code>.
						</li></ol></div><p>
					To configure the IIS Redirector Using the IIS Manager (IIS 7):
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
							Open the IIS manager by clicking <span class="strong"><strong>Start</strong></span> → <span class="strong"><strong>Run</strong></span>, and typing <code class="literal">inetmgr</code>.
						</li><li class="listitem">
							In the tree view pane at the left, expand <span class="strong"><strong>IIS 7</strong></span>.
						</li><li class="listitem">
							Double-click <span class="strong"><strong>ISAPI and CGI Registrations</strong></span> to open it in a new window.
						</li><li class="listitem">
							In the <span class="strong"><strong>Actions</strong></span> pane, click <span class="strong"><strong>Add</strong></span>. The <span class="strong"><strong>Add ISAPI or CGI Restriction</strong></span> window opens.
						</li><li class="listitem"><p class="simpara">
							Specify the following values:
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									<span class="strong"><strong>ISAPI or CGI Path</strong></span>: <code class="literal">C:\connectors\isapi_redirect.dll</code>
								</li><li class="listitem">
									<span class="strong"><strong>Description</strong></span>: <code class="literal">jboss</code>
								</li><li class="listitem">
									<span class="strong"><strong>Allow extension path to execute</strong></span>: select the check box.
								</li></ul></div></li><li class="listitem">
							Click <span class="strong"><strong>OK</strong></span> to close the <span class="strong"><strong>Add ISAPI or CGI Restriction</strong></span> window.
						</li><li class="listitem"><p class="simpara">
							Define a JBoss Native virtual directory
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									Right-click <span class="emphasis"><em>Default Web Site</em></span>, and click <span class="emphasis"><em>Add Virtual Directory</em></span>. The <span class="emphasis"><em>Add Virtual Directory</em></span> window opens.
								</li><li class="listitem"><p class="simpara">
									Specify the following values to add a virtual directory:
								</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
											<span class="strong"><strong>Alias</strong></span>: <code class="literal">jboss</code>
										</li><li class="listitem">
											<span class="strong"><strong>Physical Path</strong></span>: <code class="literal">C:\connectors\</code>
										</li></ul></div></li><li class="listitem">
									Click <span class="strong"><strong>OK</strong></span> to save the values and close the <span class="strong"><strong>Add Virtual Directory</strong></span> window.
								</li></ul></div></li><li class="listitem"><p class="simpara">
							Define a JBoss Native ISAPI Redirect Filter
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									In the tree view pane, expand <span class="strong"><strong>Sites</strong></span> → <span class="strong"><strong>Default Web Site</strong></span>.
								</li><li class="listitem">
									Double-click <span class="strong"><strong>ISAPI Filters</strong></span>. The <span class="strong"><strong>ISAPI Filters Features</strong></span> view appears.
								</li><li class="listitem">
									In the <span class="strong"><strong>Actions</strong></span> pane, click Add. The <span class="strong"><strong>Add ISAPI Filter</strong></span> window appears.
								</li><li class="listitem"><p class="simpara">
									Specify the following values in the <span class="strong"><strong>Add ISAPI Filter</strong></span> window:
								</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
											<span class="strong"><strong>Filter name</strong></span>: <code class="literal">jboss</code>
										</li><li class="listitem">
											<span class="strong"><strong>Executable</strong></span>: <code class="literal">C:\connectors\isapi_redirect.dll</code>
										</li></ul></div></li><li class="listitem">
									Click <span class="strong"><strong>OK</strong></span> to save the values and close the <span class="strong"><strong>Add ISAPI Filters</strong></span> window.
								</li></ul></div></li><li class="listitem"><p class="simpara">
							Enable the ISAPI-dll handler
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									Double-click the <span class="strong"><strong>IIS 7</strong></span> item in the tree view pane. The <span class="strong"><strong>IIS 7 Home Features View</strong></span> opens.
								</li><li class="listitem">
									Double-click <span class="strong"><strong>Handler Mappings</strong></span>. The <span class="strong"><strong>Handler Mappings Features View</strong></span> appears.
								</li><li class="listitem">
									In the <span class="strong"><strong>Group by</strong></span> combo box, select <span class="strong"><strong>State</strong></span>. The <span class="strong"><strong>Handler Mappings</strong></span> are displayed in <span class="strong"><strong>Enabled and Disabled Groups</strong></span>.
								</li><li class="listitem">
									Find <code class="literal">ISAPI-dll</code>. If it is in the <span class="strong"><strong>Disabled</strong></span> group, right-click it and select <span class="strong"><strong>Edit Feature Permissions</strong></span>.
								</li><li class="listitem"><p class="simpara">
									Enable the following permissions:
								</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
											Read
										</li><li class="listitem">
											Script
										</li><li class="listitem">
											Execute
										</li></ul></div></li><li class="listitem">
									Click <span class="strong"><strong>OK</strong></span> to save the values, and close the <span class="strong"><strong>Edit Feature Permissions</strong></span> window.
								</li></ul></div></li></ol></div><p>
					Microsoft IIS is now configured to use the ISAPI connector.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_the_isapi_connector_to_send_client_requests_to_jboss_eap"/>Configure the ISAPI Connector to Send Client Requests to JBoss EAP</h2></div></div></div><p>
					This task configures a group of JBoss EAP servers to accept requests from the ISAPI connector. It does not include configuration for load-balancing or high-availability failover.
				</p><p>
					This configuration is done on the IIS server, and assumes that you already have JBoss EAP configured to <a class="link" href="configuring_high_availability.html#configure_accept_requests_external_web_servers" title="Accepting Requests from External Web Servers">accept requests from an external web server</a>. You also need full administrator access to the IIS server and to have <a class="link" href="configuring_high_availability.html#configure_iis_use_isapi_connector" title="Configure Microsoft IIS to Use the ISAPI Connector">configured IIS to use the ISAPI connector</a>.
				</p><h4><a id="create_property_files_and_set_up_redirection"/>Create Property Files and Set Up Redirection</h4><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Create a directory to store logs, property files, and lock files.
						</p><p class="simpara">
							The rest of this procedure assumes that you are using the directory <code class="literal">C:\connectors\</code> for this purpose. If you use a different directory, modify the instructions accordingly.
						</p></li><li class="listitem"><p class="simpara">
							Create the <code class="literal">isapi_redirect.properties</code> file.
						</p><p class="simpara">
							Create a new file called <code class="literal">C:\connectors\isapi_redirect.properties</code>. Copy the following contents into the file.
						</p><pre class="screen"># Configuration file for the ISAPI Connector
# Extension uri definition
extension_uri=/jboss/isapi_redirect.dll

# Full path to the log file for the ISAPI Connector
log_file=c:\connectors\isapi_redirect.log

# Log level (debug, info, warn, error or trace)
log_level=info

# Full path to the workers.properties file
worker_file=c:\connectors\workers.properties

# Full path to the uriworkermap.properties file
worker_mount_file=c:\connectors\uriworkermap.properties

#Full path to the rewrite.properties file
rewrite_rule_file=c:\connectors\rewrite.properties</pre><p class="simpara">
							If you do not want to use a <code class="literal">rewrite.properties</code> file, comment out the last line by placing a <code class="literal">#</code> character at the beginning of the line.
						</p></li><li class="listitem"><p class="simpara">
							Create the <code class="literal">uriworkermap.properties</code> file
						</p><p class="simpara">
							The <code class="literal">uriworkermap.properties</code> file contains mappings between deployed application URLs and which worker handles requests to them. The following example file shows the syntax of the file. Place your <code class="literal">uriworkermap.properties</code> file into <code class="literal">C:\connectors\</code>.
						</p><pre class="screen"># images and css files for path /status are provided by worker01
/status=worker01
/images/*=worker01
/css/*=worker01

# Path /web-console is provided by worker02
# IIS (customized) error page is used for http errors with number greater or equal to 400
# css files are provided by worker01
/web-console/*=worker02;use_server_errors=400
/web-console/css/*=worker01

# Example of exclusion from mapping, logo.gif won't be displayed
# !/web-console/images/logo.gif=*

# Requests to /app-01 or /app-01/something will be routed to worker01
/app-01|/*=worker01

# Requests to /app-02 or /app-02/something will be routed to worker02
/app-02|/*=worker02</pre></li><li class="listitem"><p class="simpara">
							Create the <code class="literal">workers.properties</code> file.
						</p><p class="simpara">
							The <code class="literal">workers.properties</code> file contains mapping definitions between worker labels and server instances. This file follows the syntax of the same file used for <a class="link" href="reference_material.html#mod_jk_worker_properties" title="mod_jk Worker Properties">Apache mod_jk worker properties</a> configuration.
						</p><p class="simpara">
							The following is an example of a <code class="literal">workers.properties</code> file. The worker names, <code class="literal">worker01</code> and <code class="literal">worker02</code>, must match the <code class="literal">instance-id</code> <a class="link" href="configuring_high_availability.html#configure_accept_requests_external_web_servers" title="Accepting Requests from External Web Servers">configured in the JBoss EAP <code class="literal">undertow</code> subsystem</a>.
						</p><p class="simpara">
							Place this file into the <code class="literal">C:\connectors\</code> directory.
						</p><pre class="screen"># An entry that lists all the workers defined
worker.list=worker01, worker02

# Entries that define the host and port associated with these workers

# First JBoss EAP server definition, port 8009 is standard port for AJP in EAP
worker.worker01.host=127.0.0.1
worker.worker01.port=8009
worker.worker01.type=ajp13

# Second JBoss EAP server definition
worker.worker02.host=127.0.0.100
worker.worker02.port=8009
worker.worker02.type=ajp13</pre></li><li class="listitem"><p class="simpara">
							Create the <code class="literal">rewrite.properties</code> file.
						</p><p class="simpara">
							The <code class="literal">rewrite.properties</code> file contains simple URL rewriting rules for specific applications. The rewritten path is specified using name-value pairs, as shown in the example below. Place this file into the <code class="literal">C:\connectors\</code> directory.
						</p><pre class="screen">#Simple example
# Images are accessible under abc path
/app-01/abc/=/app-01/images/</pre></li><li class="listitem"><p class="simpara">
							Restart your IIS server by using the <code class="literal">net stop</code> and <code class="literal">net start</code> commands.
						</p><pre class="screen">C:\&gt; net stop was /Y
C:\&gt; net start w3svc</pre></li></ol></div><p>
					The IIS server is configured to send client requests to the specific JBoss EAP servers you have configured, on an application-specific basis.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_the_isapi_connector_to_balance_client_requests_across_multiple_jboss_eap_servers"/>Configure the ISAPI Connector to Balance Client Requests Across Multiple JBoss EAP Servers</h2></div></div></div><p>
					This configuration balances client requests across the JBoss EAP servers you specify. This configuration is done on the IIS server, and assumes that you already have JBoss EAP configured to <a class="link" href="configuring_high_availability.html#configure_accept_requests_external_web_servers" title="Accepting Requests from External Web Servers">accept requests from an external web server</a>. You also need full administrator access to the IIS server and to have <a class="link" href="configuring_high_availability.html#configure_iis_use_isapi_connector" title="Configure Microsoft IIS to Use the ISAPI Connector">configured IIS to use the ISAPI connector</a>.
				</p><h4><a id="balance_client_requests_across_multiple_servers"/>Balance Client Requests Across Multiple Servers</h4><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Create a directory to store logs, property files, and lock files.
						</p><p class="simpara">
							The rest of this procedure assumes that you are using the directory <code class="literal">C:\connectors\</code> for this purpose. If you use a different directory, modify the instructions accordingly.
						</p></li><li class="listitem"><p class="simpara">
							Create the <code class="literal">isapi_redirect.properties</code> file.
						</p><p class="simpara">
							Create a new file called <code class="literal">C:\connectors\isapi_redirect.properties</code>. Copy the following contents into the file.
						</p><pre class="screen"># Configuration file for the ISAPI Connector
# Extension uri definition
extension_uri=/jboss/isapi_redirect.dll

# Full path to the log file for the ISAPI Connector
log_file=c:\connectors\isapi_redirect.log

# Log level (debug, info, warn, error or trace)
log_level=info

# Full path to the workers.properties file
worker_file=c:\connectors\workers.properties

# Full path to the uriworkermap.properties file
worker_mount_file=c:\connectors\uriworkermap.properties

#OPTIONAL: Full path to the rewrite.properties file
rewrite_rule_file=c:\connectors\rewrite.properties</pre><p class="simpara">
							If you do not want to use a <code class="literal">rewrite.properties</code> file, comment out the last line by placing a <code class="literal">#</code> character at the beginning of the line.
						</p></li><li class="listitem"><p class="simpara">
							Create the <code class="literal">uriworkermap.properties</code> file.
						</p><p class="simpara">
							The <code class="literal">uriworkermap.properties</code> file contains mappings between deployed application URLs and which worker handles requests to them. The following example file shows the syntax of the file, with a load-balanced configuration. The wildcard (<code class="literal">*</code>) character sends all requests for various URL sub-directories to the load balancer called router. The configuration of the load balancer is covered in the next step.
						</p><p class="simpara">
							Place your <code class="literal">uriworkermap.properties</code> file into <code class="literal">C:\connectors\</code>.
						</p><pre class="screen"># images, css files, path /status and /web-console will be
# provided by nodes defined in the load-balancer called "router"
/css/*=router
/images/*=router
/status=router
/web-console|/*=router

# Example of exclusion from mapping, logo.gif won't be displayed
# !/web-console/images/logo.gif=*

# Requests to /app-01 and /app-02 will be routed to nodes defined
# in the load-balancer called "router"
/app-01|/*=router
/app-02|/*=router

# mapping for management console, nodes in cluster can be enabled or disabled here
/jkmanager|/*=status</pre></li><li class="listitem"><p class="simpara">
							Create the <code class="literal">workers.properties</code> file.
						</p><p class="simpara">
							The <code class="literal">workers.properties</code> file contains mapping definitions between worker labels and server instances. This file follows the syntax of the same file used for <a class="link" href="reference_material.html#mod_jk_worker_properties" title="mod_jk Worker Properties">Apache mod_jk worker properties</a> configuration.
						</p><p class="simpara">
							The following is an example of a <code class="literal">workers.properties</code> file. The load balancer is configured near the end of the file, to comprise workers <code class="literal">worker01</code> and <code class="literal">worker02</code>. These worker names must match the <code class="literal">instance-id</code> <a class="link" href="configuring_high_availability.html#configure_accept_requests_external_web_servers" title="Accepting Requests from External Web Servers">configured in the JBoss EAP <code class="literal">undertow</code> subsystem</a>.
						</p><p class="simpara">
							Place this file into the <code class="literal">C:\connectors\</code> directory.
						</p><pre class="screen"># The advanced router LB worker
worker.list=router,status

# First EAP server definition, port 8009 is standard port for AJP in EAP
#
# lbfactor defines how much the worker will be used.
# The higher the number, the more requests are served
# lbfactor is useful when one machine is more powerful
# ping_mode=A – all possible probes will be used to determine that
# connections are still working

worker.worker01.port=8009
worker.worker01.host=127.0.0.1
worker.worker01.type=ajp13
worker.worker01.ping_mode=A
worker.worker01.socket_timeout=10
worker.worker01.lbfactor=3

# Second EAP server definition
worker.worker02.port=8009
worker.worker02.host=127.0.0.100
worker.worker02.type=ajp13
worker.worker02.ping_mode=A
worker.worker02.socket_timeout=10
worker.worker02.lbfactor=1

# Define the LB worker
worker.router.type=lb
worker.router.balance_workers=worker01,worker02

# Define the status worker for jkmanager
worker.status.type=status</pre><p class="simpara">
							⁠
						</p></li><li class="listitem"><p class="simpara">
							Create the <code class="literal">rewrite.properties</code> file.
						</p><p class="simpara">
							The <code class="literal">rewrite.properties</code> file contains simple URL rewriting rules for specific applications. The rewritten path is specified using name-value pairs, as shown in the example below. Place this file into the <code class="literal">C:\connectors\</code> directory.
						</p><pre class="screen">#Simple example
# Images are accessible under abc path
/app-01/abc/=/app-01/images/
Restart the IIS server.

Restart your IIS server by using the net stop and net start commands.
C:\&gt; net stop was /Y
C:\&gt; net start w3svc</pre></li></ol></div><p>
					The IIS server is configured to send client requests to the JBoss EAP servers referenced in the <code class="literal">workers.properties</code> file, spreading the load across the servers in a <code class="literal">1:3</code> ratio. This ratio is derived from the load-balancing factor, <code class="literal">lbfactor</code>, assigned to each server.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="NSAPI_config"/>Oracle NSAPI Connector</h1></div></div></div><p>
				The Netscape Server API (NSAPI) is an API provided by Oracle iPlanet Web Server, formerly Netscape Web Server, for implementing extensions to the server. These extensions are known as server plugins. The NSAPI connector is used in <code class="literal">nsapi_redirector.so</code>, which is an extension of mod_jk adjusted to Oracle iPlanet Web Server. The NSAPI connector enables you to configure JBoss EAP instances as worker nodes with Oracle iPlanet Web Server as a load balancer.
			</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					See the <a class="link" href="https://access.redhat.com/articles/2026253">JBoss EAP supported configurations</a> for information on the supported configurations of Solaris and Oracle iPlanet Web Server.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_oracle_iplanet_nsapi_connector"/>Configure Oracle iPlanet Web Server to use the NSAPI Connector</h2></div></div></div><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist"><li class="listitem">
							JBoss EAP is installed and configured on each server that will serve as a worker.
						</li></ul></div><p>
					Download the NSAPI connector from the Red Hat Customer Portal:
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
							Open a browser and log in to the Red Hat Customer Portal <a class="link" href="https://access.redhat.com/jbossnetwork/restricted/listSoftware.html">JBoss Software Downloads page</a>.
						</li><li class="listitem">
							Select <span class="strong"><strong>Web Connectors</strong></span> in the <span class="strong"><strong>Product</strong></span> drop-down menu.
						</li><li class="listitem">
							Select the latest JBoss Core Services version from the <span class="strong"><strong>Version</strong></span> drop-down menu.
						</li><li class="listitem">
							Find the <span class="strong"><strong>Red Hat JBoss Core Services NSAPI Connector</strong></span> in the list, ensuring that you select the correct platform and architecture for your system, and click the <span class="strong"><strong>Download</strong></span> link.
						</li><li class="listitem">
							Extract the <code class="literal">nsapi_redirector.so</code> file, which is located in either the <code class="literal">lib/</code> or the <code class="literal">lib64/</code> directory, into either the <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/lib/</code> or the <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/lib64/</code> directory.
						</li></ol></div><p>
					Set up the NSAPI Connector:
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						In these instructions, <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span></code> refers to the Oracle iPlanet configuration directory, which is usually <code class="literal">/opt/oracle/webserver7/config/</code>. If your Oracle iPlanet configuration directory is different, modify the instructions accordingly.
					</p></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Disable servlet mappings.
						</p><p class="simpara">
							Open the <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/default.web.xml</code> file and locate the section with the heading <span class="emphasis"><em>Built In Server Mappings</em></span>. Disable the mappings to the following three servlets, by wrapping them in XML comment characters (<code class="literal">&lt;!--</code> and <code class="literal">--&gt;</code>).
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									default
								</li><li class="listitem">
									invoker
								</li><li class="listitem"><p class="simpara">
									jsp
								</p><p class="simpara">
									The following example configuration shows the disabled mappings.
								</p><pre class="screen">&lt;!-- ============== Built In Servlet Mappings =============== --&gt;
&lt;!-- The servlet mappings for the built in servlets defined above. --&gt;
&lt;!-- The mapping for the default servlet --&gt;
&lt;!--servlet-mapping&gt;
 &lt;servlet-name&gt;default&lt;/servlet-name&gt;
 &lt;url-pattern&gt;/&lt;/url-pattern&gt;
&lt;/servlet-mapping--&gt;
&lt;!-- The mapping for the invoker servlet --&gt;
&lt;!--servlet-mapping&gt;
 &lt;servlet-name&gt;invoker&lt;/servlet-name&gt;
 &lt;url-pattern&gt;/servlet/*&lt;/url-pattern&gt;
&lt;/servlet-mapping--&gt;
&lt;!-- The mapping for the JSP servlet --&gt;
&lt;!--servlet-mapping&gt;
 &lt;servlet-name&gt;jsp&lt;/servlet-name&gt;
 &lt;url-pattern&gt;*.jsp&lt;/url-pattern&gt;
&lt;/servlet-mapping--&gt;</pre><p class="simpara">
									Save and exit the file.
								</p></li></ul></div></li><li class="listitem"><p class="simpara">
							Configure the iPlanet Web Server to load the NSAPI connector module.
						</p><p class="simpara">
							Add the following lines to the end of the <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/magnus.conf</code> file, modifying file paths to suit your configuration. These lines define the location of the <code class="literal">nsapi_redirector.so</code> module, as well as the <code class="literal">workers.properties</code> file, which lists the workers and their properties.
						</p><pre class="screen">Init fn="load-modules" funcs="jk_init,jk_service" shlib="/lib/nsapi_redirector.so" shlib_flags="(global|now)"

Init fn="jk_init" worker_file="<span class="emphasis"><em>IPLANET_CONFIG</em></span>/connectors/workers.properties" log_level="info" log_file="<span class="emphasis"><em>IPLANET_CONFIG</em></span>/connectors/nsapi.log" shm_file="<span class="emphasis"><em>IPLANET_CONFIG</em></span>/connectors/tmp/jk_shm"</pre><p class="simpara">
							The configuration above is for a 32-bit architecture. If you use 64-bit Solaris, change the string <code class="literal">lib/nsapi_redirector.so</code> to <code class="literal">lib64/nsapi_redirector.so</code>.
						</p><p class="simpara">
							Save and exit the file.
						</p></li><li class="listitem"><p class="simpara">
							Configure the NSAPI connector.
						</p><p class="simpara">
							You can configure the NSAPI connector for a basic configuration, with no load balancing, or a load-balancing configuration. Choose one of the following options, after which your configuration will be complete.
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									<a class="link" href="configuring_high_availability.html#configure_nsapi_connector_send_client_requests" title="Configure the NSAPI Connector to Send Client Requests to JBoss EAP">Configure the NSAPI Connector to Send Client Requests to JBoss EAP</a>
								</li><li class="listitem">
									<a class="link" href="configuring_high_availability.html#configure_nsapi_connector_balance_client_requests_multiple_servers" title="Configure the NSAPI Connector to Balance Client Requests Across Multiple JBoss EAP Servers">Configure the NSAPI Connector to Balance Client Requests Across Multiple JBoss EAP Servers</a>
								</li></ul></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_nsapi_connector_send_client_requests"/>Configure the NSAPI Connector to Send Client Requests to JBoss EAP</h2></div></div></div><p>
					This task configures the NSAPI connector to redirect client requests to JBoss EAP servers with no load balancing or failover. The redirection is done on a per-deployment, and therefore per-URL, basis.
				</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						You must have already <a class="link" href="configuring_high_availability.html#configure_oracle_iplanet_nsapi_connector" title="Configure Oracle iPlanet Web Server to use the NSAPI Connector">configured the NSAPI connector</a> before continuing with this task.
					</p></div><h4><a id="set_up_the_basic_http_connector"/>Set Up the Basic HTTP Connector</h4><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Define the URL paths to redirect to the JBoss EAP servers.
						</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								In <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/obj.conf</code>, spaces are not allowed at the beginning of a line, except when the line is a continuation of the previous line.
							</p></div><p class="simpara">
							Edit the <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/obj.conf</code> file. Locate the section which starts with <span class="emphasis"><em>&lt;Object name="default"&gt;</em></span>, and add each URL pattern to match, in the format shown by the example file below. The string <span class="emphasis"><em>jknsapi</em></span> refers to the HTTP connector which will be defined in the next step. The example shows the use of wildcards for pattern matching.
						</p><pre class="screen">&lt;Object name="default"&gt;
[...]
NameTrans fn="assign-name" from="/status" name="jknsapi"
NameTrans fn="assign-name" from="/images(|/*)" name="jknsapi"
NameTrans fn="assign-name" from="/css(|/*)" name="jknsapi"
NameTrans fn="assign-name" from="/nc(|/*)" name="jknsapi"
NameTrans fn="assign-name" from="/jmx-console(|/*)" name="jknsapi"
&lt;/Object&gt;</pre></li><li class="listitem"><p class="simpara">
							Define the worker which serves each path.
						</p><p class="simpara">
							Continue editing the <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/obj.conf</code> file. Add the following directly after the closing tag of the section you have just finished editing: <span class="emphasis"><em>&lt;/Object&gt;</em></span>.
						</p><pre class="screen">&lt;Object name="jknsapi"&gt;
ObjectType fn=force-type type=text/plain
Service fn="jk_service" worker="worker01" path="/status"
Service fn="jk_service" worker="worker02" path="/nc(/*)"
Service fn="jk_service" worker="worker01"
&lt;/Object&gt;</pre><p class="simpara">
							The example above redirects requests to the URL path <span class="emphasis"><em>/status</em></span> to the worker called <span class="emphasis"><em>worker01</em></span>, and all URL paths beneath <code class="literal">/nc/</code> to the worker called <span class="emphasis"><em>worker02</em></span>. The third line indicates that all URLs assigned to the <span class="emphasis"><em>jknsapi</em></span> object which are not matched by the previous lines are served to <span class="emphasis"><em>worker01</em></span>.
						</p><p class="simpara">
							Save and exit the file.
						</p></li><li class="listitem"><p class="simpara">
							Define the workers and their attributes.
						</p><p class="simpara">
							Create a file called <code class="literal">workers.properties</code> in the <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/connectors/</code> directory. Paste the following contents into the file, and modify them to suit your environment.
						</p><pre class="screen"># An entry that lists all the workers defined
worker.list=worker01, worker02

# Entries that define the host and port associated with these workers
worker.worker01.host=127.0.0.1
worker.worker01.port=8009
worker.worker01.type=ajp13

worker.worker02.host=127.0.0.100
worker.worker02.port=8009
worker.worker02.type=ajp13</pre><p class="simpara">
							The <code class="literal">workers.properties</code> file uses the same syntax as Apache mod_jk.
						</p><p class="simpara">
							Save and exit the file.
						</p></li><li class="listitem"><p class="simpara">
							Restart the iPlanet Web Server
						</p><p class="simpara">
							Issue the following command to restart the iPlanet Web Server.
						</p><pre class="screen"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/../bin/stopserv
<span class="emphasis"><em>IPLANET_CONFIG</em></span>/../bin/startserv</pre></li></ol></div><p>
					iPlanet Web Server now sends client requests to the URLs you have configured to deployments on JBoss EAP.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configure_nsapi_connector_balance_client_requests_multiple_servers"/>Configure the NSAPI Connector to Balance Client Requests Across Multiple JBoss EAP Servers</h2></div></div></div><p>
					This task configures the NSAPI connector to send client requests to JBoss EAP servers in a load-balancing configuration.
				</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						You must have already <a class="link" href="configuring_high_availability.html#configure_oracle_iplanet_nsapi_connector" title="Configure Oracle iPlanet Web Server to use the NSAPI Connector">configured the NSAPI connector</a> before continuing with this task.
					</p></div><h4><a id="configure_the_connector_for_load_balancing"/>Configure the Connector for Load Balancing</h4><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Define the URL paths to redirect to the JBoss EAP servers.
						</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								In <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/obj.conf</code>, spaces are not allowed at the beginning of a line, except when the line is a continuation of the previous line.
							</p></div><p class="simpara">
							Edit the <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/obj.conf</code> file. Locate the section which starts with <code class="literal">&lt;Object name="default"&gt;</code>, and add each URL pattern to match, in the format shown by the example file below. The string <code class="literal">jknsapi</code> refers to the HTTP connector that will be defined in the next step. The example shows the use of wildcards for pattern matching.
						</p><pre class="screen">&lt;Object name="default"&gt;
[...]
NameTrans fn="assign-name" from="/status" name="jknsapi"
NameTrans fn="assign-name" from="/images(|/*)" name="jknsapi"
NameTrans fn="assign-name" from="/css(|/*)" name="jknsapi"
NameTrans fn="assign-name" from="/nc(|/*)" name="jknsapi"
NameTrans fn="assign-name" from="/jmx-console(|/*)" name="jknsapi"
NameTrans fn="assign-name" from="/jkmanager/*" name="jknsapi"
&lt;/Object&gt;</pre></li><li class="listitem"><p class="simpara">
							Define the worker that serves each path.
						</p><p class="simpara">
							Continue editing the <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/obj.conf</code> file. Directly after the closing tag for the section you modified in the previous step, <code class="literal">&lt;/Object&gt;</code>, add the following new section and modify it to your needs:
						</p><pre class="screen">&lt;Object name="jknsapi"&gt;
ObjectType fn=force-type type=text/plain
Service fn="jk_service" worker="status" path="/jkmanager(/*)"
Service fn="jk_service" worker="router"
&lt;/Object&gt;</pre><p class="simpara">
							This <code class="literal">jksnapi</code> object defines the worker nodes used to serve each path that was mapped to the <code class="literal">name="jksnapi"</code> mapping in the <code class="literal">default</code> object. Everything except for URLs matching <code class="literal">/jkmanager/*</code> is redirected to the worker called <code class="literal">router</code>.
						</p></li><li class="listitem"><p class="simpara">
							Define the workers and their attributes.
						</p><p class="simpara">
							Create a file called <code class="literal">workers.properties</code> in <code class="literal"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/connector/</code>. Paste the following contents into the file, and modify them to suit your environment.
						</p><pre class="screen"># The advanced router LB worker
# A list of each worker
worker.list=router,status

# First JBoss EAP server
# (worker node) definition.
# Port 8009 is the standard port for AJP
#

worker.worker01.port=8009
worker.worker01.host=127.0.0.1
worker.worker01.type=ajp13
worker.worker01.ping_mode=A
worker.worker01.socket_timeout=10
worker.worker01.lbfactor=3

# Second JBoss EAP server
worker.worker02.port=8009
worker.worker02.host=127.0.0.100
worker.worker02.type=ajp13
worker.worker02.ping_mode=A
worker.worker02.socket_timeout=10
worker.worker02.lbfactor=1

# Define the load-balancer called "router"
worker.router.type=lb
worker.router.balance_workers=worker01,worker02

# Define the status worker
worker.status.type=status</pre><p class="simpara">
							The <code class="literal">workers.properties</code> file uses the same syntax as Apache mod_jk.
						</p><p class="simpara">
							Save and exit the file.
						</p></li><li class="listitem"><p class="simpara">
							Restart the iPlanet Web Server 7.0.
						</p><pre class="screen"><span class="emphasis"><em>IPLANET_CONFIG</em></span>/../bin/stopserv
<span class="emphasis"><em>IPLANET_CONFIG</em></span>/../bin/startserv</pre></li></ol></div><p>
					The iPlanet Web Server redirects the URL patterns you have configured to your JBoss EAP servers in a load-balancing configuration.
				</p></div></div></div></body></html>