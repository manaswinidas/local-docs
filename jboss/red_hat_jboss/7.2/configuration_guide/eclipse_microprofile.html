<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 25. Eclipse MicroProfile</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="eclipse_microprofile"/>Chapter 25. Eclipse MicroProfile</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="using_microprofile_config"/>Using Eclipse MicroProfile Config to Manage Configuration</h1></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
					Eclipse Microprofile Config is provided as Technology Preview only. Technology Preview features are not supported with Red Hat production service level agreements (SLAs), might not be functionally complete, and Red Hat does not recommend to use them for production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.
				</p><p>
					See <a class="link" href="https://access.redhat.com/support/offerings/techpreview">Technology Preview Features Support Scope</a> on the Red Hat Customer Portal for information about the support scope for Technology Preview features.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="microprofile_config_about"/>About the MicroProfile Config SmallRye Subsystem</h2></div></div></div><p>
					Configuration data can change dynamically and applications need to be able to access the latest configuration information without restarting the server. <a class="link" href="https://microprofile.io/project/eclipse/microprofile-config">Eclipse MicroProfile Config</a> provides portable externalization of configuration data. This allows applications and microservices to be configured to run in multiple environments without a need for modification or repackaging. Eclipse MicroProfile Config functionality is implemented in JBoss EAP using the <a class="link" href="http://github.com/smallrye/smallrye-config/">SmallRye Config</a> component and is provided by the <code class="literal">microprofile-config-smallrye</code> subsystem. This subsystem is included in the default JBoss EAP 7.2 configuration.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="microprofile_config_supported_configsources"/>ConfigSources Supported by the MicroProfile Config SmallRye Subsystem</h2></div></div></div><p>
					MicroProfile Config configuration properties, which can be in different formats and can come from different locations, are provided by ConfigSources, which are implementations of the <a class="link" href="https://access.redhat.com/webassets/avalon/d/red_hat_jboss_enterprise_application_platform/7.2/javadocs/org/eclipse/microprofile/config/spi/ConfigSource.html"><code class="literal">org.eclipse.microprofile.config.spi.ConfigSource</code></a> interface.
				</p><p>
					The MicroProfile Config specification provides the following default <code class="literal">ConfigSource</code> implementations for retrieving configuration values.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Using <code class="literal">System.getProperties()</code>.
						</li><li class="listitem">
							Using <code class="literal">System.getenv()</code>.
						</li><li class="listitem">
							From all <code class="literal">META-INF/microprofile-config.properties</code> files on the class path.
						</li></ul></div><p>
					The <code class="literal">microprofile-config-smallrye</code> subsystem supports the following additional types of <code class="literal">ConfigSource</code> resources for retrieving configuration values.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							From <a class="link" href="eclipse_microprofile.html#microprofile_config_configsource_properties" title="Obtaining ConfigSource Configuraton from Properties">properties</a>.
						</li><li class="listitem">
							From a <a class="link" href="eclipse_microprofile.html#microprofile_config_configsource_directory" title="Obtaining ConfigSource Configuraton from a Directory">files in a directory</a>.
						</li><li class="listitem">
							From a <a class="link" href="eclipse_microprofile.html#microprofile_config_configsource_class" title="Obtaining ConfigSource Configuraton from a ConfigSource Class"><code class="literal">ConfigSource</code> class</a>.
						</li><li class="listitem">
							From a <a class="link" href="eclipse_microprofile.html#microprofile_config_configsourceprovider_class" title="Obtaining ConfigSource Configuraton from a ConfigSourceProvider Class"><code class="literal">ConfigSourceProvider</code> class</a>.
						</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Although the sections below use the management CLI to configure the <code class="literal">microprofile-config-smallrye</code> subsystem, you can also use the management console to accomplish these tasks by navigating to <span class="strong"><strong>Configuration</strong></span> → <span class="strong"><strong>Subsystems</strong></span> → <span class="strong"><strong>MicroProfile Config</strong></span> → and clicking <span class="strong"><strong>View</strong></span>.
					</p></div><p>
					See <a class="link" href="reference_material.html#microprofile_config_smallrye_subsystem_attributes" title="MicroProfile Config SmallRye Subsystem Attributes">MicroProfile Config SmallRye Subsystem Attributes</a> for the list of attributes available for configuring the MicroProfile Config SmallRye subsystem.
				</p><h4><a id="microprofile_config_configsource_properties"/>Obtaining ConfigSource Configuraton from Properties</h4><p>
					You can store properties directly for access by a <code class="literal">ConfigSource</code> by adding a <code class="literal">config-source</code> attribute and specifying the <code class="literal">properties</code> as a list.
				</p><p>
					The following management CLI command creates a <code class="literal">ConfigSource</code> containing configuration data for the <code class="literal">property1</code> and <code class="literal">property2</code> properties.
				</p><pre class="screen">/subsystem=microprofile-config-smallrye/config-source=props:add(properties={property1=value1,property2=value2})</pre><p>
					This command results in the following XML configuration for the <code class="literal">microprofile-config-smallrye</code> subsystem.
				</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:microprofile-config-smallrye:1.0"&gt;
    &lt;config-source name="props"&gt;
        &lt;property name="property1" value="value1"/&gt;
        &lt;property name="property2" value="value2"/&gt;
    &lt;/config-source&gt;
&lt;/subsystem&gt;</pre><h4><a id="microprofile_config_configsource_directory"/>Obtaining ConfigSource Configuraton from a Directory</h4><p>
					You can create a <code class="literal">ConfigSource</code> to read properties from files in a directory by adding the <code class="literal">config-source</code> attribute and specifying the directory that contains the files. The name of each file in the <code class="literal">dir</code> directory is the name of a property and the file content is the value of the property,
				</p><p>
					The following management CLI command creates a <code class="literal">ConfigSource</code> that reads configuration properties from files in the <code class="literal">/etc/config/numbers-app/</code> directory.
				</p><pre class="screen">/subsystem=microprofile-config-smallrye/config-source=file-props:add(dir={path=/etc/config/numbers-app})</pre><p>
					This command results in the following XML configuration for the <code class="literal">microprofile-config-smallrye</code> subsystem.
				</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:microprofile-config-smallrye:1.0"&gt;
    &lt;config-source name="file-props"&gt;
        &lt;dir path="/etc/config/numbers-app"/&gt;
    &lt;/config-source&gt;
&lt;/subsystem&gt;</pre><p>
					This structure corresponds to the structure used by OpenShift <code class="literal">ConfigMaps</code>. The <code class="literal">dir</code> value corresponds to the <code class="literal">mountPath</code> in the <code class="literal">ConfigMap</code> definition in OpenShift or Kubernetes.
				</p><p>
					Any application deployed in JBoss EAP can programmatically access the properties that are stored in the directory.
				</p><p>
					Assume that the directory <code class="literal">/etc/config/numbers-app/</code> contains the following two files:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<code class="literal">num.size</code>: This file contains the value <code class="literal">5</code>.
						</li><li class="listitem">
							<code class="literal">num.max</code>: This file contains the value <code class="literal">100</code>.
						</li></ul></div><p>
					In the code example below, <code class="literal">num.size</code> returns <code class="literal">5</code> and <code class="literal">num.max</code> returns <code class="literal">100</code>.
				</p><pre class="programlisting">@Inject
@ConfigProperty(name = "num.size")
int numSize;

@Inject
@ConfigProperty(name = "num.max")
int numMax;</pre><h4><a id="microprofile_config_configsource_class"/>Obtaining ConfigSource Configuraton from a ConfigSource Class</h4><p>
					You can create and configure a custom <a class="link" href="https://access.redhat.com/webassets/avalon/d/red_hat_jboss_enterprise_application_platform/7.2/javadocs/org/eclipse/microprofile/config/spi/ConfigSource.html"><code class="literal">org.eclipse.microprofile.config.spi.ConfigSource</code></a> implementation class to provide a source for the configuration values.
				</p><p>
					The following management CLI command creates a <code class="literal">ConfigSource</code> for the implementation class named <code class="literal">org.example.MyConfigSource</code> that is provided by a JBoss Module named <code class="literal">org.example</code>.
				</p><pre class="screen">/subsystem=microprofile-config-smallrye/config-source=my-config-source:add(class={name=org.example.MyConfigSource, module=org.example})</pre><p>
					This command results in the following XML configuration for the <code class="literal">microprofile-config-smallrye</code> subsystem.
				</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:microprofile-config-smallrye:1.0"&gt;
    &lt;config-source name="my-config-source"&gt;
        &lt;class name="org.example.MyConfigSource" module="org.example"/&gt;
    &lt;/config-source&gt;
&lt;/subsystem&gt;</pre><p>
					Properties provided by this <code class="literal">ConfigSource</code> class are available to any JBoss EAP deployment.
				</p><p>
					For information about how to add a global module to the JBoss EAP server, see <a class="link" href="overview_of_class_loading_and_modules.html#add_a_global_module" title="Define Global Modules">Define Global Modules</a>.
				</p><h4><a id="microprofile_config_configsourceprovider_class"/>Obtaining ConfigSource Configuraton from a ConfigSourceProvider Class</h4><p>
					You can create and configure a custom <a class="link" href="https://access.redhat.com/webassets/avalon/d/red_hat_jboss_enterprise_application_platform/7.2/javadocs/org/eclipse/microprofile/config/spi/ConfigSourceProvider.html"><code class="literal">org.eclipse.microprofile.config.spi.ConfigSourceProvider</code></a> implementation class that registers implementations for multiple <code class="literal">ConfigSource</code> instances.
				</p><p>
					The following management CLI command creates a <code class="literal">config-source-provider</code> for the implementation class named <code class="literal">org.example.MyConfigSourceProvider</code> that is provided by a JBoss Module named <code class="literal">org.example</code>.
				</p><pre class="screen">/subsystem=microprofile-config-smallrye/config-source-provider=my-config-source-provider:add(class={name=org.example.MyConfigSourceProvider, module=org.example})</pre><p>
					This command results in the following XML configuration for the <code class="literal">microprofile-config-smallrye</code> subsystem.
				</p><pre class="programlisting">&lt;subsystem xmlns="urn:wildfly:microprofile-config-smallrye:1.0"&gt;
    &lt;config-source-provider name="my-config-source-provider"&gt;
         &lt;class name="org.example.MyConfigSourceProvider" module="org.example"/&gt;
    &lt;/config-source-provider&gt;
&lt;/subsystem&gt;</pre><p>
					Properties provided by the <code class="literal">ConfigSourceProvider</code> implementation are available to any JBoss EAP deployment.
				</p><p>
					For information about how to add a global module to the JBoss EAP server, see <a class="link" href="overview_of_class_loading_and_modules.html#add_a_global_module" title="Define Global Modules">Define Global Modules</a>.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="deploy_applications_accessing_configsources"/>Deploying Applications that Access ConfigSources</h2></div></div></div><p>
					Applications that access MicroProfile Config in their Java code must enable CDI, either by including a <code class="literal">META-INF/beans.xml</code> or <code class="literal">WEB-INF/beans.xml</code> file in the deployment archive, or by including a CDI bean annotation.
				</p><p>
					For more information about CDI, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/development_guide/#contexts_and_dependency_injection">Contexts and Dependency Injection (CDI)</a> in the JBoss EAP <span class="emphasis"><em>Development Guide</em></span>.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="eclipse_microprofile_opentracing"/>Tracing Requests with the MicroProfile OpenTracing SmallRye Subsystem</h1></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
					Eclipse Microprofile OpenTracing is provided as Technology Preview only. Technology Preview features are not supported with Red Hat production service level agreements (SLAs), might not be functionally complete, and Red Hat does not recommend to use them for production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.
				</p><p>
					See <a class="link" href="https://access.redhat.com/support/offerings/techpreview">Technology Preview Features Support Scope</a> on the Red Hat Customer Portal for information about the support scope for Technology Preview features.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="microprofile_opentracing_about"/>About Eclipse MicroProfile OpenTracing</h2></div></div></div><p>
					The ability to trace requests across service boundaries is important, especially in a microservices environment where a request can flow through multiple services during its life cycle. The <a class="link" href="https://github.com/eclipse/microprofile-opentracing/blob/master/spec/src/main/asciidoc/microprofile-opentracing.asciidoc">Eclipse Microprofile OpenTracing</a> specification defines behaviors and an API for accessing an OpenTracing compliant <a class="link" href="http://static.javadoc.io/io.opentracing/opentracing-api/0.32.0-RC1/io/opentracing/Tracer.html"><code class="literal">Tracer</code></a> object within a JAX-RS application. The behaviors specify how OpenTracing Spans are to be created automatically for incoming and outgoing requests. The API defines how to explicitly disable or enable tracing for given endpoints.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="microprofile_opentracing_smallrye_about"/>About the MicroProfile OpenTracing SmallRye Subsystem</h2></div></div></div><p>
					Eclipse Microprofile OpenTracing functionality is implemented in JBoss EAP using the <a class="link" href="https://github.com/smallrye/smallrye-opentracing">SmallRye OpenTracing</a> component and is provided by the <code class="literal">microprofile-opentracing-smallrye</code> subsystem. This subsystem implements Microprofile 1.1, which includes support for tracing requests to JAX-RS endpoints and CDI beans and is included in the default JBoss EAP 7.2 configuration.
				</p><p>
					The <code class="literal">microprofile-opentracing-smallrye</code> subsystem ships with the <a class="link" href="https://github.com/jaegertracing/jaeger-client-java">Jaeger Java Client</a> as the default tracer, plus a set of instrumentation libraries for components commonly used in Java EE applications, such as JAX-RS and CDI. Each individual WAR deployed to the JBoss EAP server automatically has its own <a class="link" href="http://static.javadoc.io/io.opentracing/opentracing-api/0.32.0-RC1/io/opentracing/Tracer.html"><code class="literal">Tracer</code></a> instance. Each WAR within an EAR is treated as an individual WAR, and each has its own <code class="literal">Tracer</code> instance. By default, the service name used with the Jaeger Client is derived from the deployment’s name, which is usually the WAR file name.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="microprofile_opentracing_smallrye_configuring"/>Configuring the MicroProfile OpenTracing SmallRye Subsystem</h2></div></div></div><p>
					The <code class="literal">microprofile-opentracing-smallrye</code> subsystem is included in the default JBoss EAP 7.2 configuration. Because there can be a memory or performance costs associated with OpenTracing enabled, you might want to disable this subsystem.
				</p><p>
					Use the following management CLI commands to disable the MicroProfile OpenTracing feature globally for the server instance by removing the subsystem from the server configuration.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Remove the subsystem.
						</p><pre class="screen">/subsystem=microprofile-opentracing-smallrye:remove()</pre></li><li class="listitem"><p class="simpara">
							Reload the server for the changes to take effect.
						</p><pre class="screen">reload</pre></li></ol></div><p>
					Use the following management CLI commands to enable the MicroProfile OpenTracing feature globally for the server instance by adding the subsystem to the server configuration.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Add the subsystem.
						</p><pre class="screen">/subsystem=microprofile-opentracing-smallrye:add()</pre></li><li class="listitem"><p class="simpara">
							Reload the server for the changes to take effect.
						</p><pre class="screen">reload</pre></li></ol></div><p>
					There are no other configuration options available for the <code class="literal">microprofile-opentracing-smallrye</code> subsystem. Instead, you configure the Jaeger Client by setting system properties or environment variables. See the <a class="link" href="https://github.com/jaegertracing/jaeger-client-java">Jaeger documentation</a> for information about how to configure the Jaeger Client. See <a class="link" href="https://github.com/jaegertracing/jaeger-client-java/tree/master/jaeger-core#configuration-via-environment">Configuration via Environment</a> in the Jaeger documentation for the list of valid system properties.
				</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						Because this feature is provided as Technology Preview, the current configuration options, particularly those related to configuring the Jaeger Java Client tracer using system properties and environment variables, might change in incompatible ways in future releases.
					</p><p>
						Also be aware that, by default, the Jaeger Client for Java has a probabilistic sampling strategy that is set to <code class="literal">0.001</code>, meaning that only approximately one in one thousand traces will be sampled. To sample every request, set the system properties <code class="literal">JAEGER_SAMPLER_TYPE</code> to <code class="literal">const</code> and <code class="literal">JAEGER_SAMPLER_PARAM</code> to <code class="literal">1</code>.
					</p></div><p>
					For information about how to override the default tracer and how to trace CDI beans, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/development_guide/#using_microprofile_opentracing_smallrye_tracer">Using Eclipse MicroProfile OpenTracing to Trace Requests</a> in the <span class="emphasis"><em>Development Guide</em></span>.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="microprofile_health_check"/>Monitor Server Health Using Eclipse MicroProfile Health</h1></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
					Eclipse MicroProfile Health is provided as Technology Preview only. Technology Preview features are not supported with Red Hat production service level agreements (SLAs), might not be functionally complete, and Red Hat does not recommend to use them for production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.
				</p><p>
					See <a class="link" href="https://access.redhat.com/support/offerings/techpreview">Technology Preview Features Support Scope</a> on the Red Hat Customer Portal for information about the support scope for Technology Preview features.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="about_the_microprofile_health_smallrye_subsystem"/>About the MicroProfile Health SmallRye Subsystem</h2></div></div></div><p>
					JBoss EAP includes the <a class="link" href="https://github.com/smallrye/smallrye-health">SmallRye Health</a> component, which provides <a class="link" href="https://github.com/eclipse/microprofile-health/">Eclipse MicroProfile Health</a> functionality using the <code class="literal">microprofile-health-smallrye</code> subsystem. This subsystem is used to determine if the JBoss EAP instance is responding as expected, and is enabled by default.
				</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						By default, the MicroProfile Health SmallRye subsystem only examines if the server is running. To include custom health checks, see the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html-single/development_guide/#microprofile_health_smallrye_custom_check">Implement a Custom Health Check</a> section in the <span class="emphasis"><em>Development Guide</em></span>.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="examine_healthcheck_using_the_management_cli"/>Examine the Health Check Using the Management CLI</h2></div></div></div><p>
					Health checks can be examined using the management CLI. The following command demonstrates obtaining the current health of the server.
				</p><pre class="screen">/subsystem=microprofile-health-smallrye:check
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "outcome" =&gt; "UP",
        "checks" =&gt; []
    }
}</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="examine_healthcheck_using_the_http_endpoint"/>Examine the Health Check Using the HTTP Endpoint</h2></div></div></div><p>
					Health check is automatically deployed to the <code class="literal">health</code> context on JBoss EAP. That means that in addition to being able to examine it using the management CLI, you can also obtain the current health using the HTTP endpoint. The default address for the <code class="literal">/health</code> endpoint, accessible from the management interfaces, is <code class="literal"><a class="link" href="http://127.0.0.1:9990/health">http://127.0.0.1:9990/health</a></code>.
				</p><p>
					To obtain the current health of the server using the HTTP endpoint, the following URL would be used.
				</p><pre class="screen">http://<span class="emphasis"><em>HOST</em></span>:<span class="emphasis"><em>PORT</em></span>/health</pre><p>
					Accessing this context displays the health check in JSON format, indicating if the server is healthy.
				</p><h3><a id="enable_authentication_for_the_http_endpoint"/>Enable Authentication for the HTTP Endpoint</h3><p>
					The <code class="literal">health</code> context can be configured to require that users be authorized to access the context. The following procedure enables authentication on this endpoint.
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Set the <code class="literal">security-enabled</code> attribute to <code class="literal">true</code> on the <code class="literal">microprofile-health-smallrye</code> subsystem.
						</p><pre class="screen">/subsystem=microprofile-health-smallrye:write-attribute(name=security-enabled,value=true)</pre></li><li class="listitem"><p class="simpara">
							Reload the server for the changes to take effect.
						</p><pre class="screen">reload</pre></li></ol></div><p>
					Any subsequent attempts to access the <code class="literal">health</code> endpoint will now result in an authentication prompt.
				</p></div></div></div></body></html>