<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 14. Login Modules</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="chap-Login_Modules">
      ⁠</a>Chapter 14. Login Modules</h1></div></div></div><div class="para">

	</div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+IDs%3A%0A28308-608934+%5BLatest%5D&amp;comment=Title%3A+Login+Modules%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Using_Modules">
      ⁠</a>14.1. Using Modules</h1></div></div></div><div class="para">
			JBoss EAP 6 includes several bundled login modules suitable for most user management needs. JBoss EAP 6 can read user information from a relational database, an LDAP server, or flat files. In addition to these core login modules, JBoss EAP 6 provides other login modules that provide user information for very customized needs.
		</div><div class="para">
			More login modules and their options can be found in Appendix A.1.
		</div><div class="para RoleCreateBugPara">
			<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+IDs%3A%0A28309-638876+%5BLatest%5D&amp;comment=Title%3A+Using+Modules%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Password_Stacking">
      ⁠</a>14.1.1. Password Stacking</h2></div></div></div><div class="para">
		Multiple login modules can be chained together in a stack, with each login module providing both the credentials verification and role assignment during authentication. This works for many use cases, but sometimes credentials verification and role assignment are split across multiple user management stores.
	</div><div class="para">
		<a class="xref" href="chap-Login_Modules.html#LdapLoginModule1">Section 14.1.4, “Ldap Login Module”</a> describes how to combine LDAP and a relational database, allowing a user to be authenticated by either system. Consider the case where users are managed in a central LDAP server but application-specific roles are stored in the application's relational database. The password-stacking module option captures this relationship.
	</div><div class="para">
		To use password stacking, each login module should set the <span class="markup">&lt;module-option&gt;</span> <code class="literal">password-stacking</code> attribute to <code class="literal">useFirstPass</code>. If a previous module configured for password stacking has authenticated the user, all the other stacking modules will consider the user authenticated and only attempt to provide a set of roles for the authorization step.
	</div><div class="para">
		When <code class="literal">password-stacking</code> option is set to <code class="literal">useFirstPass</code>, this module first looks for a shared user name and password under the property names <span class="property">javax.security.auth.login.name</span> and <span class="property">javax.security.auth.login.password</span> respectively in the login module shared state map.
	</div><div class="para">
		If found, these properties are used as the principal name and password. If not found, the principal name and password are set by this login module and stored under the property names <span class="property">javax.security.auth.login.name</span> and <span class="property">javax.security.auth.login.password</span> respectively.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			When using password stacking, set all modules to be required. This ensures that all modules are considered, and have the chance to contribute roles to the authorization process.
		</div></div></div><div class="example"><a id="exam-Password_Stacking_Example">
      ⁠</a><p class="title"><strong>Example 14.1. Password Stacking Sample</strong></p><div class="example-contents"><div class="para">
			This management CLI example shows how password stacking could be used.
		</div><pre class="programlisting">/subsystem=security/security-domain=pwdStack/authentication=classic/login-module=Ldap:add( \
  code=Ldap, \
  flag=required, \
  module-options=[ \
    ("password-stacking"=&gt;"useFirstPass"), \
    ... Ldap login module configuration
  ])
/subsystem=security/security-domain=pwdStack/authentication=classic/login-module=Database:add( \
  code=Database, \
  flag=required, \
  module-options=[ \
    ("password-stacking"=&gt;"useFirstPass"), \
    ... Database login module configuration
  ])</pre></div></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28312-638661+%5BLatest%5D&amp;comment=Title%3A+Password+Stacking%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28312-638661+06+May+2014+20%3A55+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Password_Hashing">
      ⁠</a>14.1.2. Password Hashing</h2></div></div></div><div class="para">
		Most login modules must compare a client-supplied password to a password stored in a user management system. These modules generally work with plain text passwords, but can be configured to support hashed passwords to prevent plain text passwords from being stored on the server side.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
			Red Hat JBoss Enterprise Application Platform Common Criteria certified release only supports SHA-256 for password hashing.
		</div></div></div><div class="example"><a id="idm139772543534736">
      ⁠</a><p class="title"><strong>Example 14.2. Password Hashing</strong></p><div class="example-contents"><div class="para">
			The following is a login module configuration that assigns unauthenticated users the principal name <code class="literal">nobody</code> and contains based64-encoded, SHA-256 hashes of the passwords in a <code class="filename">usersb64.properties</code> file. The <code class="filename">usersb64.properties</code> file is part of the deployment classpath.
		</div><pre class="programlisting">
/subsystem=security/security-domain=testUsersRoles:add
/subsystem=security/security-domain=testUsersRoles/authentication=classic:add
/subsystem=security/security-domain=testUsersRoles/authentication=classic/login-module=UsersRoles:add( \
  code=UsersRoles, \
  flag=required, \
  module-options=[ \
    ("usersProperties"=&gt;"usersb64.properties"), \
    ("rolesProperties"=&gt;"test-users-roles.properties"), \
    ("unauthenticatedIdentity"=&gt;"nobody"), \
    ("hashAlgorithm"=&gt;"SHA-256"), \
    ("hashEncoding"=&gt;"base64") \
  ])
</pre></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">hashAlgorithm</span></dt><dd><div class="para">
					Name of the <code class="literal">java.security.MessageDigest</code> algorithm to use to hash the password. There is no default so this option must be specified to enable hashing. Typical values are <code class="literal">SHA-256</code>, <code class="literal">SHA-1</code> and <code class="literal">MD5</code>.
				</div></dd><dt><span class="term">hashEncoding</span></dt><dd><div class="para">
					String that specifies one of three encoding types: <code class="literal">base64</code>, <code class="literal">hex</code> or <code class="literal">rfc2617</code>. The default is <code class="literal">base64</code>.
				</div></dd><dt><span class="term">hashCharset</span></dt><dd><div class="para">
					Encoding character set used to convert the clear text password to a byte array. The platform default encoding is the default.
				</div></dd><dt><span class="term">hashUserPassword</span></dt><dd><div class="para">
					Specifies the hashing algorithm must be applied to the password the user submits. The hashed user password is compared against the value in the login module, which is expected to be a hash of the password. The default is <code class="literal">true</code>.
				</div></dd><dt><span class="term">hashStorePassword</span></dt><dd><div class="para">
					Specifies the hashing algorithm must be applied to the password stored on the server side. This is used for digest authentication, where the user submits a hash of the user password along with a request-specific tokens from the server to be compare. The hash algorithm (for digest, this would be <code class="literal">rfc2617</code>) is utilized to compute a server-side hash, which should match the hashed value sent from the client.
				</div></dd></dl></div><div class="para">
		If you must generate passwords in code, the <code class="classname">org.jboss.security.auth.spi.Util</code> class provides a static helper method that will hash a password using the specified encoding. The following example produces a base64-encoded, MD5 hashed password.
	</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>String hashedPassword = Util.<span xmlns="" class="perl_Function">createPasswordHash</span>(<span xmlns="" class="perl_String">"SHA-256"</span>,
<span xmlns="" class="line">​</span> Util.<span xmlns="" class="perl_Function">BASE64_ENCODING</span>, <span xmlns="" class="perl_Keyword">null</span>, <span xmlns="" class="perl_Keyword">null</span>, <span xmlns="" class="perl_String">"password"</span>);
</pre><div class="para">
		OpenSSL provides an alternative way to quickly generate hashed passwords at the command-line. The following example also produces a base64-encoded, SHA-256 hashed password. Here the password in plain text - <code class="literal">password</code> - is piped into the OpenSSL digest function then piped into another OpenSSL function to convert into base64-encoded format.
	</div><pre class="programlisting">echo -n password | openssl dgst -sha256 -binary | openssl base64</pre><div class="para">
		In both cases, the hashed version of the password is the same: <code class="literal"> XohImNooBHFR0OVvjcYpJ3NgPQ1qq73WKhHvch0VQtg=</code>. This value must be stored in the users' properties file specified in the security domain - <code class="filename">usersb64.properties</code> - in the example above.
	</div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28313-638664+%5BLatest%5D&amp;comment=Title%3A+Password+Hashing%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28313-638664+06+May+2014+20%3A59+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Unauthenticated_Identity">
      ⁠</a>14.1.3. Unauthenticated Identity</h2></div></div></div><div class="para">
		Not all requests are received in an authenticated format. <code class="literal">unauthenticatedIdentity</code> is a login module configuration option that assigns a specific identity (guest, for example) to requests that are made with no associated authentication information. This can be used to allow unprotected servlets to invoke methods on EJBs that do not require a specific role. Such a principal has no associated roles and so can only access either unsecured EJBs or EJB methods that are associated with the unchecked permission constraint.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<span class="bold bold"><strong>unauthenticatedIdentity</strong></span>: This defines the principal name that should be assigned to requests that contain no authentication information.
			</div></li></ul></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28314-592747+%5BLatest%5D&amp;comment=Title%3A+Unauthenticated+Identity%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28314-592747+23+Feb+2014+17%3A00+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="LdapLoginModule1">
      ⁠</a>14.1.4. Ldap Login Module</h2></div></div></div><div class="para">
		<code class="literal">Ldap</code> login module is a <code class="literal">LoginModule</code> implementation that authenticates against a Lightweight Directory Access Protocol (LDAP) server. Use the <code class="literal">Ldap</code> login module if your user name and credentials are stored in an LDAP server that is accessible using a Java Naming and Directory Interface (JNDI) LDAP provider.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>AdvancedLDAP Login Module</strong></p></div><div class="admonition"><div class="para">
			If you wish to use LDAP with the SPNEGO authentication or skip some of the authentication phases while using an LDAP server, consider using the <code class="literal">AdvancedLdap</code> login module chained with the SPNEGO login module or only the <code class="literal">AdvancedLdap</code> login module.
		</div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Distinguished Name (DN)</span></dt><dd><div class="para">
					In Lightweight Directory Access Protocol (LDAP), the distinguished name uniquely identifies an object in a directory. Each distinguished name must have a unique name and location from all other objects, which is achieved using a number of attribute-value pairs (AVPs). The AVPs define information such as common names, organization unit, among others. The combination of these values results in a unique string required by the LDAP.
				</div></dd></dl></div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			This login module also supports unauthenticated identity and password stacking.
		</div></div></div><div class="para">
		The LDAP connectivity information is provided as configuration options that are passed through to the environment object used to create JNDI initial context. The standard LDAP JNDI properties used include the following:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="property">java.naming.factory.initial</span></span></dt><dd><div class="para">
					<code class="classname">InitialContextFactory</code> implementation class name. This defaults to the Sun LDAP provider implementation <code class="literal">com.sun.jndi.ldap.LdapCtxFactory</code>.
				</div></dd><dt><span class="term"><span class="property">java.naming.provider.url</span></span></dt><dd><div class="para">
					LDAP URL for the LDAP server.
				</div></dd><dt><span class="term"><span class="property">java.naming.security.authentication</span></span></dt><dd><div class="para">
					Security protocol level to use. The available values include <code class="literal">none</code>, <code class="literal">simple</code>, and <code class="literal">strong</code>. If the property is undefined, the behavior is determined by the service provider.
				</div></dd><dt><span class="term"><span class="property">java.naming.security.protocol</span></span></dt><dd><div class="para">
					Transport protocol to use for secure access. Set this configuration option to the type of service provider (for example, SSL). If the property is undefined, the behavior is determined by the service provider.
				</div></dd><dt><span class="term"><span class="property">java.naming.security.principal</span></span></dt><dd><div class="para">
					Specifies the identity of the Principal for authenticating the caller to the service. This is built from other properties as described below.
				</div></dd><dt><span class="term"><span class="property">java.naming.security.credentials</span></span></dt><dd><div class="para">
					Specifies the credentials of the Principal for authenticating the caller to the service. Credentials can take the form of a hashed password, a clear-text password, a key, or a certificate. If the property is undefined, the behavior is determined by the service provider.
				</div></dd></dl></div><div class="para">
		For details of Ldap login module configuration options see <a class="xref" href="appe-Reference.html#Included_Authentication_Modules1">Section A.1, “Included Authentication Modules”</a>.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			In certain directory schemas (e.g., Microsoft Active Directory), role attributes in the user object are stored as DNs to role objects instead of simple names. For implementations that use this schema type, <span class="property">roleAttributeIsDN</span> must be set to <code class="literal">true</code>.
		</div></div></div><div class="para">
		User authentication is performed by connecting to the LDAP server, based on the login module configuration options. Connecting to the LDAP server is done by creating an <code class="literal">InitialLdapContext</code> with an environment composed of the LDAP JNDI properties described previously in this section.
	</div><div class="para">
		The <span class="property">Context.SECURITY_PRINCIPAL</span> is set to the distinguished name of the user obtained by the callback handler in combination with the <span class="property">principalDNPrefix</span> and <span class="property">principalDNSuffix</span> option values, and the <span class="property">Context.SECURITY_CREDENTIALS</span> property is set to the respective <span class="property">String</span> password.
	</div><div class="para">
		Once authentication has succeeded (<code class="literal">InitialLdapContext</code> instance is created), the user's roles are queried by performing a search on the <code class="literal">rolesCtxDN</code> location with search attributes set to the <span class="property">roleAttributeName</span> and <span class="property">uidAttributeName</span> option values. The roles names are obtaining by invoking the <code class="methodname"> toString </code> method on the role attributes in the search result set.
	</div><div class="example"><a id="idm139772483127568">
      ⁠</a><p class="title"><strong>Example 14.3. LDAP Login Module Security Domain</strong></p><div class="example-contents"><div class="para">
			This management CLI example shows how to use the parameters in a security domain authentication configuration.
		</div><pre class="programlisting">
/subsystem=security/security-domain=testLDAP:add(cache-type=default)
/subsystem=security/security-domain=testLDAP/authentication=classic:add
/subsystem=security/security-domain=testLDAP/authentication=classic/login-module=Ldap:add( \
  code=Ldap, \
  flag=required, \
  module-options=[ \
    ("java.naming.factory.initial"=&gt;"com.sun.jndi.ldap.LdapCtxFactory"), \
    ("java.naming.provider.url"=&gt;"ldap://ldaphost.jboss.org:1389/"), \
    ("java.naming.security.authentication"=&gt;"simple"), \
    ("principalDNPrefix"=&gt;"uid="), \
    ("principalDNSuffix"=&gt;",ou=People,dc=jboss,dc=org"), \
    ("rolesCtxDN"=&gt;"ou=Roles,dc=jboss,dc=org"), \
    ("uidAttributeID"=&gt;"member"), \
    ("matchOnUserDN"=&gt;true), \
    ("roleAttributeID"=&gt;"cn"), \
    ("roleAttributeIsDN"=&gt;false) \
  ])
</pre></div></div><div class="para">
		The <em class="parameter"><code>java.naming.factory.initial</code></em>, <em class="parameter"><code>java.naming.factory.url</code></em> and <em class="parameter"><code>java.naming.security</code></em> options in the <span class="property">testLDAP</span> security domain configuration indicate the following conditions:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				The Sun LDAP JNDI provider implementation will be used
			</div></li><li class="listitem"><div class="para">
				The LDAP server is located on host <code class="literal">ldaphost.jboss.org</code> on port 1389
			</div></li><li class="listitem"><div class="para">
				The LDAP simple authentication method will be use to connect to the LDAP server.
			</div></li></ul></div><div class="para">
		The login module attempts to connect to the LDAP server using a Distinguished Name (DN) representing the user it is trying to authenticate. This DN is constructed from the passed <span class="property">principalDNPrefix</span>, the user name of the user and the <span class="property">principalDNSuffix</span> as described above. In <a class="xref" href="chap-Login_Modules.html#exam-LDIF_File_Example">Example 14.4, “LDIF File Example”</a>, the user name <code class="literal">jsmith</code> would map to <code class="literal">uid=jsmith,ou=People,dc=jboss,dc=org</code>.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			The example assumes the LDAP server authenticates users using the <code class="literal">userPassword</code> attribute of the user's entry (<code class="literal">theduke</code> in this example). Most LDAP servers operate in this manner, however if your LDAP server handles authentication differently you must ensure LDAP is configured according to your production environment requirements.
		</div></div></div><div class="para">
		Once authentication succeeds, the roles on which authorization will be based are retrieved by performing a subtree search of the <code class="literal">rolesCtxDN</code> for entries whose <span class="property">uidAttributeID</span> match the user. If <span class="property">matchOnUserDN</span> is true, the search will be based on the full DN of the user. Otherwise the search will be based on the actual user name entered. In this example, the search is under <code class="literal">ou=Roles,dc=jboss,dc=org</code> for any entries that have a <code class="literal">member</code> attribute equal to <code class="literal">uid=jsmith,ou=People,dc=jboss,dc=org</code>. The search would locate <code class="literal">cn=JBossAdmin</code> under the roles entry.
	</div><div class="para">
		The search returns the attribute specified in the <span class="property">roleAttributeID</span> option. In this example, the attribute is <code class="literal">cn</code>. The value returned would be <code class="literal">JBossAdmin</code>, so the <code class="literal">jsmith</code> user is assigned to the <code class="literal">JBossAdmin</code> role.
	</div><div class="para">
		A local LDAP server often provides identity and authentication services, but is unable to use authorization services. This is because application roles do not always map well onto LDAP groups, and LDAP administrators are often hesitant to allow external application-specific data in central LDAP servers. The LDAP authentication module is often paired with another login module, such as the database login module, that can provide roles more suitable to the application being developed.
	</div><div class="para">
		An LDAP Data Interchange Format (LDIF) file representing the structure of the directory this data operates against is shown in <a class="xref" href="chap-Login_Modules.html#exam-LDIF_File_Example">Example 14.4, “LDIF File Example”</a>.
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">LDAP Data Interchange Format (LDIF)</span></dt><dd><div class="para">
					Plain text data interchange format used to represent LDAP directory content and update requests. Directory content is represented as one record for each object or update request. Content consists of add, modify, delete, and rename requests.
				</div></dd></dl></div><div class="example"><a id="exam-LDIF_File_Example">
      ⁠</a><p class="title"><strong>Example 14.4. LDIF File Example</strong></p><div class="example-contents"><pre class="programlisting">dn: dc=jboss,dc=org
objectclass: top
objectclass: dcObject
objectclass: organization
dc: jboss
o: JBoss

dn: ou=People,dc=jboss,dc=org
objectclass: top
objectclass: organizationalUnit
ou: People

dn: uid=jsmith,ou=People,dc=jboss,dc=org
objectclass: top
objectclass: uidObject
objectclass: person
uid: jsmith
cn: John
sn: Smith
userPassword: theduke

dn: ou=Roles,dc=jboss,dc=org
objectclass: top
objectclass: organizationalUnit
ou: Roles

dn: cn=JBossAdmin,ou=Roles,dc=jboss,dc=org
objectclass: top
objectclass: groupOfNames
cn: JBossAdmin
member: uid=jsmith,ou=People,dc=jboss,dc=org
description: the JBossAdmin group
</pre></div></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28310-666517+%5BLatest%5D&amp;comment=Title%3A+Ldap+Login+Module%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28310-666517+10+Jun+2014+20%3A04+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="LdapExtLoginModule">
      ⁠</a>14.1.5. LdapExtended Login Module</h2></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Distinguished Name (DN)</span></dt><dd><div class="para">
					In Lightweight Directory Access Protocol (LDAP), the distinguished name uniquely identifies an object in a directory. Each distinguished name must have a unique name and location from all other objects, which is achieved using a number of attribute-value pairs (AVPs). The AVPs define information such as common names, organization unit, among others. The combination of these values results in a unique string required by the LDAP.
				</div></dd></dl></div><div class="para">
		The LdapExtended (<code class="classname">org.jboss.security.auth.spi.LdapExtLoginModule)</code> searches for the user to bind, as well as the associated roles, for authentication. The roles query recursively follows DNs to navigate a hierarchical role structure.
	</div><div class="para">
		The LoginModule options include whatever options are supported by the chosen LDAP JNDI provider supports. Examples of standard property names are:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<span class="property">Context.INITIAL_CONTEXT_FACTORY</span> = "java.naming.factory.initial"
			</div></li><li class="listitem"><div class="para">
				<span class="property">Context.SECURITY_PROTOCOL</span> = "java.naming.security.protocol"
			</div></li><li class="listitem"><div class="para">
				<span class="property">Context.PROVIDER_URL</span> = "java.naming.provider.url"
			</div></li><li class="listitem"><div class="para">
				<span class="property">Context.SECURITY_AUTHENTICATION</span> = "java.naming.security.authentication"
			</div></li><li class="listitem"><div class="para">
				<span class="property">Context.REFERRAL</span> = "java.naming.referral"
			</div></li></ul></div><div class="para">
		Login module implementation logic follows the order below:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
				The initial LDAP server bind is authenticated using the <span class="property">bindDN</span> and <span class="property">bindCredential</span> properties. The <span class="property">bindDN</span> is a user with permissions to search both the <span class="property">baseCtxDN</span> and <span class="property">rolesCtxDN</span> trees for the user and roles. The <span class="property">user DN</span> to authenticate against is queried using the filter specified by the <span class="property">baseFilter</span> property.
			</div></li><li class="listitem"><div class="para">
				The resulting <span class="property">userDN</span> is authenticated by binding to the LDAP server using the <span class="property">userDN</span> as the InitialLdapContext environment <span class="property">Context.SECURITY_PRINCIPAL</span>. The <span class="property">Context.SECURITY_CREDENTIALS</span> property is either set to the String password obtained by the callback handler.
			</div></li><li class="listitem"><div class="para">
				If this is successful, the associated user roles are queried using the rolesCtxDN, roleAttributeID, roleAttributeIsDN, roleNameAttributeID, and roleFilter options.
			</div></li></ol></div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			AdvancedLdap Login Module differs from LdapExtended Login Module in the following ways: 
			<div class="itemizedlist"><ul><li class="listitem"><div class="para">
						The top level role is queried only for roleAttributeID and not for roleNameAttributeID.
					</div></li><li class="listitem"><div class="para">
						When the roleAttributeIsDN module property is set to false, the recursive role search is disabled even if the recurseRoles module option is set to true.
					</div></li></ul></div>

		</div></div></div><div class="para">
		For details of LdapExtended login module options see <a class="xref" href="appe-Reference.html#Included_Authentication_Modules1">Section A.1, “Included Authentication Modules”</a>.
	</div><div class="figure"><a id="idm139772556330880">
      ⁠</a><div class="figure-contents"><div class="mediaobject"><img src="images/4764.png" alt="LDAP Structure Example"/></div></div><p class="title"><strong>Figure 14.1. LDAP Structure Example</strong></p></div><div class="example"><a id="idm139772565455136">
      ⁠</a><p class="title"><strong>Example 14.5. Example 2 LDAP Configuration</strong></p><div class="example-contents"><pre class="programlisting">
version: 1
dn: o=example2,dc=jboss,dc=org
objectClass: top
objectClass: organization
o: example2

dn: ou=People,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: organizationalUnit
ou: People

dn: uid=jduke,ou=People,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: uidObject
objectClass: person
objectClass: inetOrgPerson
cn: Java Duke
employeeNumber: judke-123
sn: Duke
uid: jduke
userPassword:: dGhlZHVrZQ==

dn: uid=jduke2,ou=People,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: uidObject
objectClass: person
objectClass: inetOrgPerson
cn: Java Duke2
employeeNumber: judke2-123
sn: Duke2
uid: jduke2
userPassword:: dGhlZHVrZTI=

dn: ou=Roles,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: organizationalUnit
ou: Roles

dn: uid=jduke,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: groupUserEx
memberOf: cn=Echo,ou=Roles,o=example2,dc=jboss,dc=org
memberOf: cn=TheDuke,ou=Roles,o=example2,dc=jboss,dc=org
uid: jduke

dn: uid=jduke2,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: groupUserEx
memberOf: cn=Echo2,ou=Roles,o=example2,dc=jboss,dc=org
memberOf: cn=TheDuke2,ou=Roles,o=example2,dc=jboss,dc=org
uid: jduke2

dn: cn=Echo,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: groupOfNames
cn: Echo
description: the echo role
member: uid=jduke,ou=People,dc=jboss,dc=org

dn: cn=TheDuke,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: TheDuke
description: the duke role
member: uid=jduke,ou=People,o=example2,dc=jboss,dc=org

dn: cn=Echo2,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: groupOfNames
cn: Echo2
description: the Echo2 role
member: uid=jduke2,ou=People,dc=jboss,dc=org

dn: cn=TheDuke2,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: TheDuke2
description: the duke2 role
member: uid=jduke2,ou=People,o=example2,dc=jboss,dc=org

dn: cn=JBossAdmin,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: groupOfNames
cn: JBossAdmin
description: the JBossAdmin group
member: uid=jduke,ou=People,dc=jboss,dc=org</pre><div class="para">
			The module configuration for this LDAP structure example is outlined in the following management CLI command.
		</div><pre class="programlisting">

/subsystem=security/security-domain=testLdapExample2/authentication=classic/login-module=LdapExtended:add( \
  code=LdapExtended, \
  flag=required, \
  module-options=[ \
    ("java.naming.factory.initial"=&gt;"com.sun.jndi.ldap.LdapCtxFactory"), \
    ("java.naming.provider.url"=&gt;"ldap://ldaphost.jboss.org"), \
    ("java.naming.security.authentication"=&gt;"simple"), \
    ("bindDN"=&gt;"cn=Root,dc=jboss,dc=org"), \
    ("bindCredential"=&gt;"secret1"), \
    ("baseCtxDN"=&gt;"ou=People,o=example2,dc=jboss,dc=org"), \
    ("baseFilter"=&gt;"(uid={0})"), \
    ("rolesCtxDN"=&gt;"ou=Roles,o=example2,dc=jboss,dc=org"), \
    ("roleFilter"=&gt;"(uid={0})"), \
    ("roleAttributeIsDN"=&gt;"true"), \
    ("roleAttributeID"=&gt;"memberOf"), \
    ("roleNameAttributeID"=&gt;"cn") \
  ])

</pre></div></div><div class="example"><a id="idm139772496834224">
      ⁠</a><p class="title"><strong>Example 14.6. Example 3 LDAP Configuration</strong></p><div class="example-contents"><pre class="programlisting">

dn: o=example3,dc=jboss,dc=org
objectclass: top
objectclass: organization
o: example3

dn: ou=People,o=example3,dc=jboss,dc=org
objectclass: top
objectclass: organizationalUnit
ou: People

dn: uid=jduke,ou=People,o=example3,dc=jboss,dc=org
objectclass: top
objectclass: uidObject
objectclass: person
objectClass: inetOrgPerson
uid: jduke
employeeNumber: judke-123
cn: Java Duke
sn: Duke
userPassword: theduke

dn: ou=Roles,o=example3,dc=jboss,dc=org
objectClass: top
objectClass: organizationalUnit
ou: Roles

dn: uid=jduke,ou=Roles,o=example3,dc=jboss,dc=org
objectClass: top
objectClass: groupUserEx
memberOf: cn=Echo,ou=Roles,o=example3,dc=jboss,dc=org
memberOf: cn=TheDuke,ou=Roles,o=example3,dc=jboss,dc=org
uid: jduke

dn: cn=Echo,ou=Roles,o=example3,dc=jboss,dc=org
objectClass: top
objectClass: groupOfNames
cn: Echo
description: the JBossAdmin group
member: uid=jduke,ou=People,o=example3,dc=jboss,dc=org

dn: cn=TheDuke,ou=Roles,o=example3,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: TheDuke
member: uid=jduke,ou=People,o=example3,dc=jboss,dc=org


</pre></div></div><div class="para">
		The module configuration for this LDAP structure example is outlined in the following management CLI command.
	</div><pre class="programlisting">

/subsystem=security/security-domain=testLdapExample3/authentication=classic/login-module=LdapExtended:add( \
  code=LdapExtended, \
  flag=required, \
  module-options=[ \
    ("java.naming.factory.initial"=&gt;"com.sun.jndi.ldap.LdapCtxFactory"), \
    ("java.naming.provider.url"=&gt;"ldap://ldaphost.jboss.org"), \
    ("java.naming.security.authentication"=&gt;"simple"), \
    ("bindDN"=&gt;"cn=Root,dc=jboss,dc=org"), \
    ("bindCredential"=&gt;"secret1"), \
    ("baseCtxDN"=&gt;"ou=People,o=example3,dc=jboss,dc=org"), \
    ("baseFilter"=&gt;"(cn={0})"), \
    ("rolesCtxDN"=&gt;"ou=Roles,o=example3,dc=jboss,dc=org"), \
    ("roleFilter"=&gt;"(member={1})"), \
    ("roleAttributeID"=&gt;"cn") \
  ])


</pre><div class="example"><a id="idm139772541901824">
      ⁠</a><p class="title"><strong>Example 14.7. Example 4 LDAP Configuration</strong></p><div class="example-contents"><pre class="programlisting">

dn: o=example4,dc=jboss,dc=org
objectclass: top
objectclass: organization
o: example4

dn: ou=People,o=example4,dc=jboss,dc=org
objectclass: top
objectclass: organizationalUnit
ou: People

dn: uid=jduke,ou=People,o=example4,dc=jboss,dc=org
objectClass: top
objectClass: uidObject
objectClass: person
objectClass: inetOrgPerson
cn: Java Duke
employeeNumber: jduke-123
sn: Duke
uid: jduke
userPassword:: dGhlZHVrZQ==

dn: ou=Roles,o=example4,dc=jboss,dc=org
objectClass: top
objectClass: organizationalUnit
ou: Roles

dn: cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: RG1
member: cn=empty

dn: cn=RG2,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: RG2
member: cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org
member: uid=jduke,ou=People,o=example4,dc=jboss,dc=org

dn: cn=RG3,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: RG3
member: cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org

dn: cn=R1,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: R1
member: cn=RG2,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org

dn: cn=R2,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: R2
member: cn=RG2,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org

dn: cn=R3,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: R3
member: cn=RG2,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org
member: cn=RG3,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org

dn: cn=R4,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: R4
member: cn=RG3,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org

dn: cn=R5,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: R5
member: cn=RG3,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org
member: uid=jduke,ou=People,o=example4,dc=jboss,dc=org

</pre><div class="para">
			The module configuration for this LDAP structure example is outlined in the code sample.
		</div><pre class="programlisting">

/subsystem=security/security-domain=testLdapExample4/authentication=classic/login-module=LdapExtended:add( \
  code=LdapExtended, \
  flag=required, \
  module-options=[ \
    ("java.naming.factory.initial"=&gt;"com.sun.jndi.ldap.LdapCtxFactory"), \
    ("java.naming.provider.url"=&gt;"ldap://ldaphost.jboss.org"), \
    ("java.naming.security.authentication"=&gt;"simple"), \
    ("bindDN"=&gt;"cn=Root,dc=jboss,dc=org"), \
    ("bindCredential"=&gt;"secret1"), \
    ("baseCtxDN"=&gt;"ou=People,o=example4,dc=jboss,dc=org"), \
    ("baseFilter"=&gt;"(cn={0})"), \
    ("rolesCtxDN"=&gt;"ou=Roles,o=example4,dc=jboss,dc=org"), \
    ("roleFilter"=&gt;"(member={1})"), \
    ("roleRecursion"=&gt;"1"), \
    ("roleAttributeID"=&gt;"memberOf") \
  ])


</pre></div></div><div class="example"><a id="exam-Default_ActiveDirectory_Configuration">
      ⁠</a><p class="title"><strong>Example 14.8. Default Active Directory Configuration</strong></p><div class="example-contents"><div class="para">
			The example below represents the configuration for a default Active Directory configuration.
		</div><div class="para">
			Some Active Directory configurations may require searching against the Global Catalog on port 3268 instead of the usual port 389. This is most likely when the Active Directory forest includes multiple domains.
		</div><pre class="programlisting">

/subsystem=security/security-domain=AD_Default/authentication=classic/login-module=LdapExtended:add( \
  code=LdapExtended, \
  flag=required, \
  module-options=[ \
    ("java.naming.provider.url"=&gt;"ldap://ldaphost.jboss.org"), \
    ("bindDN"=&gt;"JBOSS\searchuser"), \
    ("bindCredential"=&gt;"password"), \
    ("baseCtxDN"=&gt;"CN=Users,DC=jboss,DC=org"), \
    ("baseFilter"=&gt;"(sAMAccountName={0})"), \
    ("rolesCtxDN"=&gt;"CN=Users,DC=jboss,DC=org"), \
    ("roleFilter"=&gt;"(sAMAccountName={0})"), \
    ("roleAttributeID"=&gt;"memberOf"), \
    ("roleAttributeIsDN"=&gt;"true"), \
    ("roleNameAttributeID"=&gt;"cn"), \
    ("searchScope"=&gt;"ONELEVEL_SCOPE"), \
    ("allowEmptyPasswords"=&gt;"false") \
  ])


</pre></div></div><div class="example"><a id="idm139772545590416">
      ⁠</a><p class="title"><strong>Example 14.9. Recursive Roles Active Directory Configuration</strong></p><div class="example-contents"><div class="para">
			The example below implements a recursive role search within Active Directory. The key difference between this example and the default Active Directory example is that the role search has been replaced to search the member attribute using the DN of the user. The login module then uses the DN of the role to find groups of which the group is a member.
		</div><pre class="programlisting">

/subsystem=security/security-domain=AD_Recursive/authentication=classic/login-module=LdapExtended:add( \
  code=LdapExtended, \
  flag=required, \
  module-options=[ \
    ("java.naming.provider.url"=&gt;"ldap://ldaphost.jboss.org"), \
    ("java.naming.referral"=&gt;"follow"), \
    ("bindDN"=&gt;"JBOSS\searchuser"), \
    ("bindCredential"=&gt;"password"), \
    ("baseCtxDN"=&gt;"CN=Users,DC=jboss,DC=org"), \
    ("baseFilter"=&gt;"(sAMAccountName={0})"), \
    ("rolesCtxDN"=&gt;"CN=Users,DC=jboss,DC=org"), \
    ("roleFilter"=&gt;"(member={1})"), \
    ("roleAttributeID"=&gt;"cn"), \
    ("roleAttributeIsDN"=&gt;"false"), \
    ("roleRecursion"=&gt;"2"), \
    ("searchScope"=&gt;"ONELEVEL_SCOPE"), \
    ("allowEmptyPasswords"=&gt;"false") \
  ])


</pre></div></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28311-733248+%5BLatest%5D&amp;comment=Title%3A+LdapExtended+Login+Module%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28311-733248+17+Dec+2014+01%3A39+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="UsersRolesLoginModule">
      ⁠</a>14.1.6. UsersRoles Login Module</h2></div></div></div><div class="para">
		<code class="literal">UsersRoles</code> login module is a simple login module that supports multiple users and user roles loaded from Java properties files. The default username-to-password mapping filename is <code class="filename">users.properties</code> and the default username-to-roles mapping filename is <code class="filename">roles.properties</code>.
	</div><div class="para">
		For details of UsersRoles login module options see <a class="xref" href="appe-Reference.html#Included_Authentication_Modules1">Section A.1, “Included Authentication Modules”</a> .
	</div><div class="para">
		This login module supports password stacking, password hashing, and unauthenticated identity.
	</div><div class="para">
		The properties files are loaded during initialization using the initialize method thread context class loader. This means that these files can be placed on the classpath of the Java EE deployment (for example, into the <code class="filename">WEB-INF/classes</code> folder in the <code class="literal">WAR</code> archive), or into any directory on the server classpath. The primary purpose of this login module is to easily test the security settings of multiple users and roles using properties files deployed with the application.
	</div><div class="example"><a id="exam-UsersRoleLoginModule">
      ⁠</a><p class="title"><strong>Example 14.10. UsersRoles Login Module</strong></p><div class="example-contents"><pre class="programlisting">
/subsystem=security/security-domain=ejb3-sampleapp/authentication=classic/login-module=UsersRoles:add( \
  code=UsersRoles, \
  flag=required, \
  module-options=[ \
    ("usersProperties"=&gt;"ejb3-sampleapp-users.properties"), \
    ("rolesProperties"=&gt;"ejb3-sampleapp-roles.properties") \
  ])
</pre></div></div><div class="para">
		In <a class="xref" href="chap-Login_Modules.html#exam-UsersRoleLoginModule">Example 14.10, “UsersRoles Login Module”</a>, the <code class="filename">ejb3-sampleapp-users.properties</code> file uses a <code class="filename">username=password</code> format with each user entry on a separate line:
	</div><pre class="programlisting">
username1=password1
username2=password2
...
</pre><div class="para">
		The <code class="filename">ejb3-sampleapp-roles.properties</code> file referenced in <a class="xref" href="chap-Login_Modules.html#exam-UsersRoleLoginModule">Example 14.10, “UsersRoles Login Module”</a> uses the pattern <code class="literal">username=role1,role2,</code> with an optional group name value. For example:
	</div><pre class="programlisting">
username1=role1,role2,...
username1.RoleGroup1=role3,role4,...
username2=role1,role3,...
</pre><div class="para">
		The <span class="property">user name.XXX</span> property name pattern present in <code class="filename">ejb3-sampleapp-roles.properties</code> is used to assign the user name roles to a particular named group of roles where the <code class="literal">XXX</code> portion of the property name is the group name. The <span class="property">user name=...</span> form is an abbreviation for <span class="property">user name.Roles=...</span>, where the <code class="literal">Roles</code> group name is the standard name the <code class="literal">JBossAuthorizationManager</code> expects to contain the roles which define the permissions of users.
	</div><div class="para">
		The following would be equivalent definitions for the <code class="literal">jduke</code> user name:
	</div><pre class="programlisting">
jduke=TheDuke,AnimatedCharacter
jduke.Roles=TheDuke,AnimatedCharacter
</pre><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28315-742324+%5BLatest%5D&amp;comment=Title%3A+UsersRoles+Login+Module%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28315-742324+09+Feb+2015+22%3A47+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="DatabaseServerLoginModule">
      ⁠</a>14.1.7. Database Login Module</h2></div></div></div><div class="para">
		The <code class="literal">Database</code> login module is a Java Database Connectivity-based (JDBC) login module that supports authentication and role mapping. Use this login module if you have your user name, password and role information stored in a relational database.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			This module supports password stacking, password hashing and unauthenticated identity.
		</div></div></div><div class="para">
		The <code class="literal">Database</code> login module is based on two logical tables:
	</div><pre class="programlisting">
Table Principals(PrincipalID text, Password text)
Table Roles(PrincipalID text, Role text, RoleGroup text)
</pre><div class="para">
		The <code class="literal">Principals</code> table associates the user <code class="literal">PrincipalID</code> with the valid password and the <code class="literal">Roles</code> table associates the user <code class="literal">PrincipalID</code> with its role sets. The roles used for user permissions must be contained in rows with a <code class="literal">RoleGroup</code> column value of <code class="literal">Roles</code>.
	</div><div class="para">
		The tables are logical in that you can specify the SQL query that the login module uses. The only requirement is that the <code class="literal">java.sql.ResultSet</code> has the same logical structure as the <code class="literal">Principals</code> and <code class="literal">Roles</code> tables described previously. The actual names of the tables and columns are not relevant as the results are accessed based on the column index.
	</div><div class="para">
		To clarify this notion, consider a database with two tables, <code class="literal">Principals</code> and <code class="literal">Roles</code>, as already declared. The following statements populate the tables with the following data:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<code class="literal">PrincipalID</code> <code class="literal">java</code> with a <code class="literal">Password</code> of <code class="literal">echoman</code> in the <code class="literal">Principals</code> table
			</div></li><li class="listitem"><div class="para">
				<code class="literal">PrincipalID</code> <code class="literal">java</code> with a role named <code class="literal">Echo</code> in the <code class="literal">Roles</code><code class="literal">RoleGroup</code> in the <code class="literal">Roles</code> table
			</div></li><li class="listitem"><div class="para">
				<code class="literal">PrincipalID</code> <code class="literal">java</code> with a role named <code class="literal">caller_java</code> in the <code class="literal">CallerPrincipal</code><code class="literal">RoleGroup</code> in the <code class="literal">Roles</code> table
			</div></li></ul></div><pre class="programlisting">INSERT INTO Principals VALUES('java', 'echoman')
INSERT INTO Roles VALUES('java', 'Echo', 'Roles')
INSERT INTO Roles VALUES('java', 'caller_java', 'CallerPrincipal')
</pre><div class="para">
		For details of Database login module options see <a class="xref" href="appe-Reference.html#Included_Authentication_Modules1">Section A.1, “Included Authentication Modules”</a>.
	</div><div class="para">
		An example <code class="literal">Database login module</code> configuration could be constructed as follows:
	</div><pre class="programlisting">
CREATE TABLE Users(username VARCHAR(64) PRIMARY KEY, passwd VARCHAR(64))
CREATE TABLE UserRoles(username VARCHAR(64), role VARCHAR(32))
</pre><div class="para">
		A corresponding login module configuration in a security domain:
	</div><pre class="programlisting">
/subsystem=security/security-domain=testDB/authentication=classic/login-module=Database:add( \
  code=Database, \
  flag=required, \
  module-options=[ \
    ("dsJndiName"=&gt;"java:/MyDatabaseDS"), \
    ("principalsQuery"=&gt;"select passwd from Users where username=?"), \
    ("rolesQuery"=&gt;"select role, 'Roles' from UserRoles where username=?") \
  ])
</pre><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28316-638932+%5BLatest%5D&amp;comment=Title%3A+Database+Login+Module%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28316-638932+07+May+2014+17%3A21+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="BaseCertLoginModule">
      ⁠</a>14.1.8. Certificate Login Module</h2></div></div></div><div class="para">
		<code class="literal">Certificate</code> login module authenticates users based on X509 certificates. A typical use case for this login module is <code class="literal">CLIENT-CERT</code> authentication in the web tier.
	</div><div class="para">
		This login module only performs authentication: you must combine it with another login module capable of acquiring authorization roles to completely define access to a secured web or EJB component. Two subclasses of this login module, <code class="literal">CertRolesLoginModule</code> and <code class="literal">DatabaseCertLoginModule</code> extend the behavior to obtain the authorization roles from either a properties file or database.
	</div><div class="para">
		For details of <code class="literal">Certificate</code> login module options see <a class="xref" href="appe-Reference.html#Included_Authentication_Modules1">Section A.1, “Included Authentication Modules”</a>.
	</div><div class="para">
		The <code class="literal">Certificate</code> login module needs a <code class="literal">KeyStore</code> to perform user validation. This is obtained from a JSSE configuration of linked security domain as shown in the following configuration fragment:
	</div><pre class="programlisting">
/subsystem=security/security-domain=trust-domain:add
/subsystem=security/security-domain=trust-domain/jsse=classic:add( \
  truststore={ \
    password=&gt;pass1234, \
    url=&gt;/home/jbosseap/trusted-clients.jks \
  })

/subsystem=security/security-domain=testCert:add
/subsystem=security/security-domain=testCert/authentication=classic:add
/subsystem=security/security-domain=testCert/authentication=classic/login-module=Certificate:add( \
  code=Certificate, \
  flag=required, \
  module-options=[ \
    ("securityDomain"=&gt;"trust-domain"), \
  ])
</pre><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="proc-Secure_Web_Applications_With_Certs_Role_Based_Authorization">
      ⁠</a><p class="title"><strong>Procedure 14.1. Secure Web Applications with Certificates and Role-based Authorization</strong></p><div class="para">
			This procedure describes how to secure a web application, such as the <code class="filename">user-app.war</code>, using client certificates and role-based authorization. In this example the <code class="literal">CertificateRoles</code> login module is used for authentication and authorization. Both the <code class="literal">trusted-clients.keystore</code> and the <code class="literal">app-roles.properties</code> require an entry that maps to the principal associated with the client certificate.
		</div><div class="para">
			By default, the principal is created using the client certificate distinguished name, such as the DN specified in <a class="xref" href="chap-Login_Modules.html#exam-Certificate_Example">Example 14.11, “Certificate Example”</a>.
		</div><ol class="1"><li class="step"><p class="title"><strong>Declare Resources and Roles</strong></p><div class="para">
				Modify <code class="filename">web.xml</code> to declare the resources to be secured along with the allowed roles and security domain to be used for authentication and authorization.
			</div><pre class="programlisting">

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
        version="3.0"&gt;

        &lt;security-constraint&gt;
                &lt;web-resource-collection&gt;
                        &lt;web-resource-name&gt;Protect App&lt;/web-resource-name&gt;
                        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
                &lt;/web-resource-collection&gt;
                &lt;auth-constraint&gt;
                        &lt;role-name&gt;Admin&lt;/role-name&gt;
                &lt;/auth-constraint&gt;
        &lt;/security-constraint&gt;

        &lt;login-config&gt;
                &lt;auth-method&gt;CLIENT-CERT&lt;/auth-method&gt;
                &lt;realm-name&gt;Secured area&lt;/realm-name&gt;
        &lt;/login-config&gt;

        &lt;security-role&gt;
                &lt;role-name&gt;Admin&lt;/role-name&gt;
        &lt;/security-role&gt;
&lt;/web-app&gt;


</pre></li><li class="step"><p class="title"><strong>Specify the Security Domain</strong></p><div class="para">
				In the <code class="literal">jboss-web.xml</code> file, specify the required security domain.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss-web&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;security-domain&gt;</span>app-sec-domain<span xmlns="" class="perl_Keyword">&lt;/security-domain&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss-web&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
</pre></li><li class="step"><p class="title"><strong>Configure Login Module</strong></p><div class="para">
				Define the login module configuration for the <code class="literal">app-sec-domain</code> domain you just specified using the management CLI.
			</div><pre class="programlisting">[
/subsystem=security/security-domain=trust-domain:add
/subsystem=security/security-domain=trust-domain/jsse=classic:add( \
  truststore={ \
    password=&gt;pass1234, \
    url=&gt;/home/jbosseap/trusted-clients.jks \
  })

/subsystem=security/security-domain=app-sec-domain:add
/subsystem=security/security-domain=app-sec-domain/authentication=classic:add
/subsystem=security/security-domain=app-sec-domain/authentication=classic/login-module=CertificateRoles:add( \
  code=CertificateRoles, \
  flag=required, \
  module-options=[ \
    ("securityDomain"=&gt;"trust-domain"), \
    ("rolesProperties"=&gt;"app-roles.properties") \
  ])

</pre></li></ol></div><div class="example"><a id="exam-Certificate_Example">
      ⁠</a><p class="title"><strong>Example 14.11. Certificate Example</strong></p><div class="example-contents"><pre class="screen">
[conf]$ keytool -printcert -file valid-client-cert.crt
Owner: CN=valid-client, OU=Security QE, OU=JBoss, O=Red Hat, C=CZ
Issuer: CN=EAP Certification Authority, OU=Security QE, OU=JBoss, O=Red Hat, C=CZ
Serial number: 2
Valid from: Mon Mar 24 18:21:55 CET 2014 until: Tue Mar 24 18:21:55 CET 2015
Certificate fingerprints:
         MD5:  0C:54:AE:6E:29:ED:E4:EF:46:B5:14:30:F2:E0:2A:CB
         SHA1: D6:FB:19:E7:11:28:6C:DE:01:F2:92:2F:22:EF:BB:5D:BF:73:25:3D
         SHA256: CD:B7:B1:72:A3:02:42:55:A3:1C:30:E1:A6:F0:20:B0:2C:0F:23:4F:7A:8E:2F:2D:FA:AF:55:3E:A7:9B:2B:F4
         Signature algorithm name: SHA1withRSA
         Version: 3
</pre></div></div><div class="para">
		The <code class="literal">trusted-clients.keystore</code> would need the certificate in <a class="xref" href="chap-Login_Modules.html#exam-Certificate_Example">Example 14.11, “Certificate Example”</a> stored with an alias of <code class="literal">CN=valid-client, OU=Security QE, OU=JBoss, O=Red Hat, C=CZ</code>. The <code class="literal">app-roles.properties</code> must have the same entry. Since the DN contains characters that are normally treated as delimiters, you must escape the problem characters using a backslash ('<code class="literal">\</code>') as illustrated below.
	</div><pre class="screen">
# A sample app-roles.properties file
CN\=valid-client,\ OU\=Security\ QE,\ OU\=JBoss,\ O\=Red\ Hat,\ C\=CZ
</pre><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28317-638933+%5BLatest%5D&amp;comment=Title%3A+Certificate+Login+Module%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28317-638933+07+May+2014+17%3A31+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="IdentityLoginModule">
      ⁠</a>14.1.9. Identity Login Module</h2></div></div></div><div class="para">
		<code class="literal">Identity</code> login module is a simple login module that associates a hard-coded user name to any subject authenticated against the module. It creates a <code class="literal">SimplePrincipal</code> instance using the name specified by the <code class="literal">principal</code> option.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			This module supports password stacking.
		</div></div></div><div class="para">
		This login module is useful when you need to provide a fixed identity to a service, and in development environments when you want to test the security associated with a given principal and associated roles.
	</div><div class="para">
		For details of Identity login module options see <a class="xref" href="appe-Reference.html#Included_Authentication_Modules1">Section A.1, “Included Authentication Modules”</a>.
	</div><div class="para">
		A sample security domain configuration is described below. It authenticates all users as the principal named <code class="literal">jduke</code> and assigns role names of <code class="literal">TheDuke</code>, and <code class="literal">AnimatedCharacter</code>:.
	</div><pre class="programlisting">
/subsystem=security/security-domain=testIdentity:add
/subsystem=security/security-domain=testIdentity/authentication=classic:add
/subsystem=security/security-domain=testIdentity/authentication=classic/login-module=Identity:add( \
  code=Identity, \
  flag=required, \
  module-options=[ \
    ("principal"=&gt;"jduke"), \
    ("roles"=&gt;"TheDuke,AnimatedCharacter") \
  ])
  

</pre><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28318-638670+%5BLatest%5D&amp;comment=Title%3A+Identity+Login+Module%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28318-638670+06+May+2014+21%3A38+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-RunAs_Login_Module">
      ⁠</a>14.1.10. RunAs Login Module</h2></div></div></div><div class="para">
				<code class="literal">RunAs</code> login module is a helper module that pushes a <code class="literal">run as</code> role onto the stack for the duration of the login phase of authentication, then pops the <code class="literal">run as</code> role from the stack in either the commit or abort phase.
			</div><div class="para">
				The purpose of this login module is to provide a role for other login modules that must access secured resources in order to perform their authentication (for example, a login module that accesses a secured EJB). <code class="literal">RunAs</code> login module must be configured ahead of the login modules that require a <code class="literal">run as</code> role established.
			</div><div class="para">
				For details of RunAs login module options see <a class="xref" href="appe-Reference.html#Included_Authentication_Modules1">Section A.1, “Included Authentication Modules”</a>.
			</div><div class="para RoleCreateBugPara">
				<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+IDs%3A%0A28319-638671+%5BLatest%5D&amp;comment=Title%3A+RunAs+Login+Module%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="RunAsIdentity_Creation">
      ⁠</a>14.1.10.1. RunAsIdentity Creation</h3></div></div></div><div class="para">
		In order for JBoss EAP 6 to secure access to EJB methods, the identity of the user must be known at the time the method call is made.
	</div><div class="para">
		A user's identity in the server is represented either by a <code class="classname">javax.security.auth.Subject</code> instance or an <code class="classname">org.jboss.security.RunAsIdentity</code> instance. Both these classes store one or more principals that represent the identity and a list of roles that the identity possesses. In the case of the <code class="classname">javax.security.auth.Subject</code> a list of credentials is also stored.
	</div><div class="para">
		In the <span class="markup">&lt;assembly-descriptor&gt;</span> section of the <code class="filename">ejb-jar.xml</code> deployment descriptor, you specify one or more roles that a user must have to access the various EJB methods. A comparison of these lists reveals whether the user has one of the roles necessary to access the EJB method.
	</div><div class="example"><a id="exam-RunAsIdentity_Creation">
      ⁠</a><p class="title"><strong>Example 14.12. org.jboss.security.RunAsIdentity Creation</strong></p><div class="example-contents"><div class="para">
			In the <code class="filename">ejb-jar.xml</code> file, you specify a <span class="markup">&lt;security-identity&gt;</span> element with a <span class="markup">&lt;run-as&gt;</span> role defined as a child of the &lt;session&gt; element.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;session&gt;</span>
<span xmlns="" class="line">​</span>   ...
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;security-identity&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;run-as&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;role-name&gt;</span>Admin<span xmlns="" class="perl_Keyword">&lt;/role-name&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/run-as&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/security-identity&gt;</span>
<span xmlns="" class="line">​</span>   ...
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/session&gt;</span></pre><div class="para">
			This declaration signifies that an <code class="literal">Admin</code> RunAsIdentity role must be created.
		</div><div class="para">
			To name a principal for the <code class="literal">Admin</code> role, you define a <code class="sgmltag-element">&lt;run-as-principal&gt;</code> element in the <code class="filename">jboss-ejb3.xml</code> file.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss:ejb-jar</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">        xmlns=</span><span xmlns="" class="perl_String">"http://java.sun.com/xml/ns/javaee"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">        xmlns:jboss=</span><span xmlns="" class="perl_String">"http://www.jboss.com/xml/ns/javaee"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">        xmlns:s=</span><span xmlns="" class="perl_String">"urn:security:1.1"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">        version=</span><span xmlns="" class="perl_String">"3.1"</span><span xmlns="" class="perl_Others"> impl-version=</span><span xmlns="" class="perl_String">"2.0"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;assembly-descriptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;s:security&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>WhoAmIBean<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;s:run-as-principal&gt;</span>John<span xmlns="" class="perl_Keyword">&lt;/s:run-as-principal&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/s:security&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/assembly-descriptor&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss:ejb-jar&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
</pre><div class="para">
			The <code class="sgmltag-element">&lt;security-identity&gt;</code> element in both the <code class="filename">ejb-jar.xml</code> and <code class="sgmltag-element">&lt;security&gt;</code> element in the <code class="filename">jboss-ejb3.xml</code> files are parsed at deployment time. The <code class="sgmltag-element">&lt;run-as&gt;</code> role name and the <code class="sgmltag-element">&lt;run-as-principal&gt;</code> name are then stored in the <code class="classname">org.jboss.metadata.ejb.spec.SecurityIdentityMetaData</code> class.
		</div></div></div><div class="example"><a id="idm139772547749472">
      ⁠</a><p class="title"><strong>Example 14.13. Assigning multiple roles to a RunAsIdentity</strong></p><div class="example-contents"><div class="para">
			You can assign more roles to RunAsIdentity by mapping roles to principals in the <code class="filename">jboss-ejb3.xml</code> deployment descriptor <code class="sgmltag-element">&lt;assembly-descriptor&gt;</code> element group.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss:ejb-jar</span><span xmlns="" class="perl_Others"> xmlns:sr=</span><span xmlns="" class="perl_String">"urn:security-role"</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Error">...</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;assembly-descriptor&gt;</span>
<span xmlns="" class="line">​</span>            ...
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;sr:security-role&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;sr:role-name&gt;</span>Support<span xmlns="" class="perl_Keyword">&lt;/sr:role-name&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;sr:principal-name&gt;</span>John<span xmlns="" class="perl_Keyword">&lt;/sr:principal-name&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;sr:principal-name&gt;</span>Jill<span xmlns="" class="perl_Keyword">&lt;/sr:principal-name&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;sr:principal-name&gt;</span>Tony<span xmlns="" class="perl_Keyword">&lt;/sr:principal-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/sr:security-role&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/assembly-descriptor&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss:ejb-jar&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
</pre><div class="para">
			In <a class="xref" href="chap-Login_Modules.html#exam-RunAsIdentity_Creation">Example 14.12, “org.jboss.security.RunAsIdentity Creation”</a>, the <code class="sgmltag-element">&lt;run-as-principal&gt;</code> of <code class="literal">John</code> was created. The configuration in this example extends the <code class="literal">Admin</code> role, by adding the <code class="literal">Support</code> role. The new role contains extra principals, including the originally defined principal <code class="literal">John</code>.
		</div><div class="para">
			The <code class="sgmltag-element">&lt;security-role&gt;</code> element in both the <code class="filename">ejb-jar.xml</code> and <code class="filename">jboss-ejb3.xml</code> files are parsed at deployment time. The <code class="sgmltag-element">&lt;role-name&gt;</code> and the <code class="sgmltag-element">&lt;principal-name&gt;</code> data is stored in the <code class="classname">org.jboss.metadata.ejb.spec.SecurityIdentityMetaData</code> class.
		</div></div></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28320-640429+%5BLatest%5D&amp;comment=Title%3A+RunAsIdentity+Creation%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28320-640429+12+May+2014+18%3A32+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ClientLoginModule">
      ⁠</a>14.1.11. Client Login Module</h2></div></div></div><div class="para">
		<code class="literal">Client</code> login module (<code class="classname">org.jboss.security.ClientLoginModule</code>) is an implementation of <code class="literal">LoginModule</code> for use by JBoss clients when establishing caller identity and credentials. This creates a new <code class="literal">SecurityContext</code> assigns it a principal and a credential and sets the <code class="literal">SecurityContext</code> to the <code class="literal">ThreadLocal</code> security context.
	</div><div class="para">
		<code class="literal">Client</code> login module is the only supported mechanism for a client to establish the current thread's caller. Both stand-alone client applications, and server environments (acting as JBoss EJB clients where the security environment has not been configured to use the EAP security subsystem transparently) must use <code class="literal">Client</code> login module.
	</div><div class="para">
		Note that this login module does not perform any authentication. It merely copies the login information provided to it into the server EJB invocation layer for subsequent authentication on the server. If you need to perform client-side authentication of users you would need to configure another login module in addition to the <code class="literal">Client</code> login module.
	</div><div class="para">
		For details of Client login module options see <a class="xref" href="appe-Reference.html#Included_Authentication_Modules1">Section A.1, “Included Authentication Modules”</a>.
	</div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28321-686354+%5BLatest%5D&amp;comment=Title%3A+Client+Login+Module%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28321-686354+21+Jul+2014+02%3A29+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="SPNEGOLoginModule">
      ⁠</a>14.1.12. SPNEGO Login Module</h2></div></div></div><div class="para">
		<code class="literal">SPNEGO</code> login module (<code class="classname">org.jboss.security.negotiation.spnego.SPNEGOLoginModule</code>) is an implementation of <code class="literal">LoginModule</code> that establishes caller identity and credentials with a KDC. The module implements SPNEGO (Simple and Protected GSSAPI Negotiation mechanism) and is a part of the JBoss Negotiation project. This authentication can be used in the chained configuration with the <code class="code">AdvancedLdap</code> login module to allow cooperation with an LDAP server.
	</div><div class="para">
		For details of SPNEGO login module options see <a class="xref" href="appe-Reference.html#Included_Authentication_Modules1">Section A.1, “Included Authentication Modules”</a>.
	</div><div class="para">
		The JBoss Negotiation module is not included as a standard dependency for deployed applications. To use the <code class="code">SPNEGO</code> or <code class="code">AdvancedLdap</code> login modules in your project, you must add the dependency manually by editing the <code class="filename">META-INF/jboss-deployment-structure.xml</code> deployment descriptor file.
	</div><div class="example"><a id="idm139772550224672">
      ⁠</a><p class="title"><strong>Example 14.14. Add JBoss Negotiation Module as a Dependency</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss-deployment-structure&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;deployment&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;dependencies&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;module</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"org.jboss.security.negotiation"</span> <span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/dependencies&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/deployment&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss-deployment-structure&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
</pre></div></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28322-665420+%5BLatest%5D&amp;comment=Title%3A+SPNEGO+Login+Module%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28322-665420+09+Jun+2014+10%3A06+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="RoleMappingLoginModule">
      ⁠</a>14.1.13. RoleMapping Login Module</h2></div></div></div><div class="para">
		<code class="literal">RoleMapping</code> login module supports mapping roles, that are the end result of the authentication process, to one or more declarative roles. For example, if the authentication process has determined that the user "A" has the roles "ldapAdmin" and "testAdmin", and the declarative role defined in the <code class="filename">web.xml</code> or <code class="filename">ejb-jar.xml</code> file for access is <code class="literal">admin</code>, then this login module maps the <code class="literal">admin</code> roles to the user <code class="literal">A</code>.
	</div><div class="para">
		For details of <code class="literal">RoleMapping</code> login module options see <a class="xref" href="appe-Reference.html#Included_Authentication_Modules1">Section A.1, “Included Authentication Modules”</a>.
	</div><div class="para">
		The <code class="literal">RoleMapping</code> login module must be defined as an optional module to a login module configuration as it alters mapping of the previously mapped roles.
	</div><div class="example"><a id="idm139772487916368">
      ⁠</a><p class="title"><strong>Example 14.15. Defining mapped roles</strong></p><div class="example-contents"><pre class="programlisting">
/subsystem=security/security-domain=test-domain-2/:add
/subsystem=security/security-domain=test-domain-2/authentication=classic:add
/subsystem=security/security-domain=test-domain-2/authentication=classic/login-module=test-2-lm/:add(\
flag=required,\
code=UsersRoles,\
module-options=[("usersProperties"=&gt;"users.properties"),("rolesProperties"=&gt;"roles.properties")]\
)
/subsystem=security/security-domain=test-domain-2/authentication=classic/login-module=test2-map/:add(\
flag=optional,\
code=RoleMapping,\
module-options=[("rolesProperties"=&gt;"rolesMapping-roles.properties")]\
)
</pre></div></div><div class="para">
		Another example achieving the same result, but using the mapping module. This is the preferred method of role mapping:
	</div><div class="example"><a id="idm139772529327456">
      ⁠</a><p class="title"><strong>Example 14.16. Preferred method of defining mapped roles</strong></p><div class="example-contents"><pre class="programlisting">
/subsystem=security/security-domain=test-domain-2/:add
/subsystem=security/security-domain=test-domain-2/authentication=classic:add
/subsystem=security/security-domain=test-domain-2/authentication=classic/login-module=test-2-lm/:add(\
flag=required,\
code=UsersRoles,\
module-options=[("usersProperties"=&gt;"users.properties"),("rolesProperties"=&gt;"roles.properties")]\
)
/subsystem=security/security-domain=test-domain-2/mapping=classic/mapping-module=test2-map/:add(\
code=PropertiesRoles,type=role,\
module-options=[("rolesProperties"=&gt;"rolesMapping-roles.properties")]\
)
</pre></div></div><div class="example"><a id="exam-PropertiesFile_RoleMappingLoginModule">
      ⁠</a><p class="title"><strong>Example 14.17. Properties File used by a RoleMappingLoginModule</strong></p><div class="example-contents"><pre class="programlisting">
ldapAdmin=admin, testAdmin
</pre><div class="para">
			If the authenticated subject contains role <code class="literal">ldapAdmin</code>, then the roles <code class="literal">admin</code> and <code class="literal">testAdmin</code> are added to or substitute the authenticated subject depending on the <span class="property">replaceRole</span> property value.
		</div></div></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28323-638683+%5BLatest%5D&amp;comment=Title%3A+RoleMapping+Login+Module%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28323-638683+06+May+2014+22%3A40+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Mechanism_to_Cache_Passwords_from_External_Source">
      ⁠</a>14.1.14. bindCredential Module Option</h2></div></div></div><div class="para">
		The <code class="literal">bindCredential</code> module option is used to store the credentials for the DN and can be used by several login and mapping modules. There are several methods for obtaining the password.
	</div><div class="variablelist"><p class="title"><strong/></p><dl class="variablelist"><dt><span class="term"> Plaintext in a management CLI command. </span></dt><dd><div class="para">
					The password for the <code class="code">bindCredential</code> module may be provided in plaintext, in a management CLI command. For example: <code class="code">("bindCredential"=&gt;"secret1")</code>. For security reasons, the password should be encrypted using the JBoss EAP vault mechanism.
				</div></dd><dt><span class="term"> Use an external command. </span></dt><dd><div class="para">
					To obtain the password from the output of an external command, use the format <code class="code">{EXT}...</code> where the <code class="code">...</code> is the external command. The first line of the command output is used as the password.
				</div><div class="para">
					To improve performance, the <code class="code">{EXTC[:expiration_in_millis]}</code> variant caches the password for a specified number of milliseconds. By default the cached password does not expire. If the value <code class="literal">0</code> (zero) is specified, the cached credentials do not expire.
				</div><div class="para">
					The <code class="code">EXTC</code> variant is only supported by the <code class="code">LdapExtended</code> login module.
				</div></dd></dl></div><div class="example"><a id="idm139772533187904">
      ⁠</a><p class="title"><strong>Example 14.18. Obtain a password from an external command</strong></p><div class="example-contents"><div class="para">
			
<pre class="screen">
{EXT}cat /mysecretpasswordfile
</pre>

		</div></div></div><div class="example"><a id="idm139772488612752">
      ⁠</a><p class="title"><strong>Example 14.19. Obtain a password from an external file and cache it for 500 milliseconds</strong></p><div class="example-contents"><div class="para">
			
<pre class="screen">
{EXTC:500}cat /mysecretpasswordfile
</pre>

		</div></div></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+38715-681306+%5BLatest%5D&amp;comment=Title%3A+bindCredential+Module+Option%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=38715-681306+03+Jul+2014+20%3A08+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Custom_Modules">
      ⁠</a>14.2. Custom Modules</h1></div></div></div><div class="para">
			If the login modules bundled with the EAP security framework do not work with your security environment, you can write your own custom login module implementation. The <code class="literal">AuthenticationManager</code> requires a particular usage pattern of the <code class="literal">Subject</code> principals set. You must understand the JAAS Subject class's information storage features and the expected usage of these features to write a login module that works with the <code class="literal">AuthenticationManager</code>.
		</div><div class="para">
			This section examines this requirement and introduces two abstract base <code class="literal">LoginModule</code> implementations that can help you implement custom login modules.
		</div><div class="para">
			You can obtain security information associated with a <code class="literal">Subject</code> by using the following methods:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span>java.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">Set</span> <span xmlns="" class="perl_Function">getPrincipals</span>()
<span xmlns="" class="line">​</span>java.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">Set</span> <span xmlns="" class="perl_Function">getPrincipals</span>(java.<span xmlns="" class="perl_Function">lang</span>.<span xmlns="" class="perl_Function">Class</span> c)
<span xmlns="" class="line">​</span>java.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">Set</span> <span xmlns="" class="perl_Function">getPrivateCredentials</span>()
<span xmlns="" class="line">​</span>java.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">Set</span> <span xmlns="" class="perl_Function">getPrivateCredentials</span>(java.<span xmlns="" class="perl_Function">lang</span>.<span xmlns="" class="perl_Function">Class</span> c)
<span xmlns="" class="line">​</span>java.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">Set</span> <span xmlns="" class="perl_Function">getPublicCredentials</span>()
<span xmlns="" class="line">​</span>java.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">Set</span> <span xmlns="" class="perl_Function">getPublicCredentials</span>(java.<span xmlns="" class="perl_Function">lang</span>.<span xmlns="" class="perl_Function">Class</span> c)</pre><div class="para">
			For <code class="literal">Subject</code> identities and roles, EAP has selected the most logical choice: the principals sets obtained via <code class="literal">getPrincipals()</code> and <code class="literal">getPrincipals(java.lang.Class)</code>. The usage pattern is as follows:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					User identities (for example; user name, social security number, employee ID) are stored as <code class="literal">java.security.Principal</code> objects in the <code class="literal">Subject</code><code class="literal">Principals</code> set. The <code class="literal">Principal</code> implementation that represents the user identity must base comparisons and equality on the name of the principal. A suitable implementation is available as the <code class="literal">org.jboss.security.SimplePrincipal</code> class. Other <code class="literal">Principal</code> instances may be added to the <code class="literal">Subject</code><code class="literal">Principals</code> set as needed.
				</div></li><li class="listitem"><div class="para">
					Assigned user roles are also stored in the <code class="literal">Principals</code> set, and are grouped in named role sets using <code class="literal">java.security.acl.Group</code> instances. The <code class="literal">Group</code> interface defines a collection of <code class="literal">Principal</code>s and/or <code class="literal">Group</code>s, and is a subinterface of <code class="literal">java.security.Principal</code>.
				</div></li><li class="listitem"><div class="para">
					Any number of role sets can be assigned to a <code class="literal">Subject</code>.
				</div></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					The EAP security framework uses two well-known role sets with the names <code class="literal">Roles</code> and <code class="literal">CallerPrincipal</code>.
				</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
							The <code class="literal">Roles</code> group is the collection of <code class="literal">Principal</code>s for the named roles as known in the application domain under which the <code class="literal">Subject</code> has been authenticated. This role set is used by methods like the <code class="literal">EJBContext.isCallerInRole(String)</code>, which EJBs can use to see if the current caller belongs to the named application domain role. The security interceptor logic that performs method permission checks also uses this role set.
						</div></li><li class="listitem"><div class="para">
							The <code class="literal">CallerPrincipal</code> <code class="literal">Group</code> consists of the single <code class="literal">Principal</code> identity assigned to the user in the application domain. The <code class="literal">EJBContext.getCallerPrincipal() </code>method uses the <code class="literal">CallerPrincipal</code> to allow the application domain to map from the operation environment identity to a user identity suitable for the application. If a <code class="literal">Subject</code> does not have a <code class="literal">CallerPrincipal</code> <code class="literal">Group</code>, the application identity is the same as operational environment identity.
						</div></li></ul></div></li></ul></div><div class="para RoleCreateBugPara">
			<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+IDs%3A%0A28324-686361+%5BLatest%5D&amp;comment=Title%3A+Custom+Modules%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Subject_Usage_Pattern_Support">
      ⁠</a>14.2.1. Subject Usage Pattern Support</h2></div></div></div><div class="para">
		To simplify correct implementation of the <code class="literal">Subject</code> usage patterns described in <a class="xref" href="chap-Login_Modules.html#sect-Custom_Modules">Section 14.2, “Custom Modules”</a>, EAP includes login modules that populate the authenticated <code class="literal">Subject</code> with a template pattern that enforces correct <code class="literal">Subject</code> usage.
	</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">AbstractServerLoginModule</div>
			The most generic of the two is the <code class="literal">org.jboss.security.auth.spi.AbstractServerLoginModule</code> class.
		</div><div class="para">
		It provides an implementation of the <code class="literal">javax.security.auth.spi.LoginModule</code> interface and offers abstract methods for the key tasks specific to an operation environment security infrastructure. The key details of the class are highlighted in <a class="xref" href="chap-Login_Modules.html#exam-AbstractServerLoginModule_Class_Fragment">Example 14.20, “AbstractServerLoginModule Class Fragment”</a>. The JavaDoc comments detail the responsibilities of subclasses.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
			The <code class="literal">loginOk</code> instance variable is pivotal. This must be set to <code class="literal">true</code> if the log in succeeds, or <code class="literal">false</code> by any subclasses that override the log in method. If this variable is incorrectly set, the commit method will not correctly update the subject.
		</div></div></div><div class="para">
		Tracking the log in phase outcomes allows login modules to be chained together with control flags. These control flags do not require the login modules to succeed as part of the authentication process.
	</div><div class="example"><a id="exam-AbstractServerLoginModule_Class_Fragment">
      ⁠</a><p class="title"><strong>Example 14.20. AbstractServerLoginModule Class Fragment</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span>package org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">auth</span>.<span xmlns="" class="perl_Function">spi</span>;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  This class implements the common functionality required for a JAAS</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  server-side LoginModule and implements the PicketBox standard</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  Subject usage pattern of storing identities and roles. Subclass</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  this module to create your own custom LoginModule and override the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  login(), getRoleSets(), and getIdentity() methods.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> AbstractServerLoginModule
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">implements</span> javax.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">auth</span>.<span xmlns="" class="perl_Function">spi</span>.<span xmlns="" class="perl_Function">LoginModule</span>
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> Subject subject;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> CallbackHandler callbackHandler;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> Map sharedState;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> Map options;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> Logger log;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** Flag indicating if the shared credential should be used */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_DataType">boolean</span> useFirstPass;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Flag indicating if the login phase succeeded. Subclasses that</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * override the login method must set this to true on successful</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * completion of login</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_DataType">boolean</span> loginOk;
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">// ...</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Initialize the login module. This stores the subject,</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * callbackHandler and sharedState and options for the login</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * session. Subclasses should override if they need to process</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * their own options. A call to super.initialize(...)  must be</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * made in the case of an override.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">&lt;p&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * The options are checked for the  </span><span xmlns="" class="perl_Keyword">&lt;em&gt;</span><span xmlns="" class="perl_Comment">password-stacking</span><span xmlns="" class="perl_Keyword">&lt;/em&gt;</span><span xmlns="" class="perl_Comment"> parameter.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * If this is set to "useFirstPass", the login identity will be taken from the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">&lt;code&gt;</span><span xmlns="" class="perl_Comment">javax.security.auth.login.name</span><span xmlns="" class="perl_Keyword">&lt;/code&gt;</span><span xmlns="" class="perl_Comment"> value of the sharedState map,</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * and the proof of identity from the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">&lt;code&gt;</span><span xmlns="" class="perl_Comment">javax.security.auth.login.password</span><span xmlns="" class="perl_Keyword">&lt;/code&gt;</span><span xmlns="" class="perl_Comment"> value of the sharedState map.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param subject </span><span xmlns="" class="perl_Comment">the Subject to update after a successful login.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param callbackHandler </span><span xmlns="" class="perl_Comment">the CallbackHandler that will be used to obtain the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * the user identity and credentials.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param sharedState </span><span xmlns="" class="perl_Comment">a Map shared between all configured login module instances</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param options </span><span xmlns="" class="perl_Comment">the parameters passed to the login module.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> initialize(Subject subject,
<span xmlns="" class="line">​</span>                           CallbackHandler callbackHandler,
<span xmlns="" class="line">​</span>                           Map sharedState,
<span xmlns="" class="line">​</span>                           Map options)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// ...</span>
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Looks for javax.security.auth.login.name and</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  javax.security.auth.login.password values in the sharedState</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  map if the useFirstPass option was true and returns true if</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  they exist. If they do not or are null this method returns</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  false.  </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Note that subclasses that override the login method</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  must set the loginOk var to true if the login succeeds in</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  order for the commit phase to populate the Subject. This</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  implementation sets loginOk to true if the login() method</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  returns true, otherwise, it sets loginOk to false.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">login</span>() 
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> LoginException
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// ...</span>
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Overridden by subclasses to return the Principal that</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  corresponds to the user primary identity.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">protected</span> Principal <span xmlns="" class="perl_Function">getIdentity</span>();
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Overridden by subclasses to return the Groups that correspond</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  to the role sets assigned to the user. Subclasses should</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  create at least a Group named "Roles" that contains the roles</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  assigned to the user.  A second common group is</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  "CallerPrincipal," which provides the application identity of</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  the user rather than the security domain identity.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">Group[] containing the sets of roles</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">protected</span> Group[] <span xmlns="" class="perl_Function">getRoleSets</span>() <span xmlns="" class="perl_Keyword">throws</span> LoginException;
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">UsernamePasswordLoginModule</div>
			The second abstract base login module suitable for custom login modules is the <code class="literal">org.jboss.security.auth.spi.UsernamePasswordLoginModule</code>.
		</div><div class="para">
		This login module further simplifies custom login module implementation by enforcing a string-based user name as the user identity and a <code class="literal">char[]</code> password as the authentication credentials. It also supports the mapping of anonymous users (indicated by a null user name and password) to a principal with no roles. The key details of the class are highlighted in the following class fragment. The JavaDoc comments detail the responsibilities of subclasses.
	</div><div class="example"><a id="exam-UsernamePasswordLoginModule_Class_Fragment">
      ⁠</a><p class="title"><strong>Example 14.21. UsernamePasswordLoginModule Class Fragment</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span>package org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">auth</span>.<span xmlns="" class="perl_Function">spi</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  An abstract subclass of AbstractServerLoginModule that imposes a</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  an identity == String username, credentials == String password</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  view on the login process. Subclasses override the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  getUsersPassword() and getUsersRoles() methods to return the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  expected password and roles for the user.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> UsernamePasswordLoginModule
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> AbstractServerLoginModule
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The login identity */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> Principal identity;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The proof of login identity */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">char</span>[] credential;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The principal to use when a null username and password are seen */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> Principal unauthenticatedIdentity;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * The message digest algorithm used to hash passwords. If null then</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * plain passwords will be used. */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String hashAlgorithm = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  The name of the charset/encoding to use when converting the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * password String to a byte array. Default is the platform's</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * default encoding.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">private</span> String hashCharset = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The string encoding format to use. Defaults to base64. */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String hashEncoding = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">// ...</span>
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Override the superclass method to look for an</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  unauthenticatedIdentity property. This method first invokes</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  the super version.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  </span><span xmlns="" class="perl_Keyword">@param options,</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  @option unauthenticatedIdentity: the name of the principal to</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  assign and authenticate when a null username and password are</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  seen.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> initialize(Subject subject,
<span xmlns="" class="line">​</span>                           CallbackHandler callbackHandler,
<span xmlns="" class="line">​</span>                           Map sharedState,
<span xmlns="" class="line">​</span>                           Map options)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">initialize</span>(subject, callbackHandler, sharedState,
<span xmlns="" class="line">​</span>                         options);
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// Check for unauthenticatedIdentity option.</span>
<span xmlns="" class="line">​</span>        Object option = options.<span xmlns="" class="perl_Function">get</span>(<span xmlns="" class="perl_String">"unauthenticatedIdentity"</span>);
<span xmlns="" class="line">​</span>        String name = (String) option;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> (name != <span xmlns="" class="perl_Keyword">null</span>) {
<span xmlns="" class="line">​</span>            unauthenticatedIdentity = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">SimplePrincipal</span>(name);
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">// ...</span>
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  A hook that allows subclasses to change the validation of the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  input password against the expected password. This version</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  checks that neither inputPassword or expectedPassword are null</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  and that inputPassword.equals(expectedPassword) is true;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">true if the inputPassword is valid, false otherwise.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">validatePassword</span>(String inputPassword,
<span xmlns="" class="line">​</span>                                       String expectedPassword)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> (inputPassword == <span xmlns="" class="perl_Keyword">null</span> || expectedPassword == <span xmlns="" class="perl_Keyword">null</span>) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> inputPassword.<span xmlns="" class="perl_Function">equals</span>(expectedPassword);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Get the expected password for the current username available</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * via the getUsername() method. This is called from within the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * login() method after the CallbackHandler has returned the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * username and candidate password.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">the valid password String</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">protected</span> String <span xmlns="" class="perl_Function">getUsersPassword</span>()
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> LoginException;
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Subclassing Login Modules</div>
			The choice of sub-classing the <code class="literal">AbstractServerLoginModule</code> versus <code class="literal">UsernamePasswordLoginModule</code> is based on whether a string-based user name and credentials are usable for the authentication technology you are writing the login module for. If the string-based semantic is valid, then subclass <code class="literal">UsernamePasswordLoginModule</code>, otherwise subclass <code class="literal">AbstractServerLoginModule</code>.
		</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Subclassing Steps</div>
			The steps your custom login module must execute depend on which base login module class you choose. When writing a custom login module that integrates with your security infrastructure, you should start by sub-classing <code class="literal">AbstractServerLoginModule</code> or <code class="literal">UsernamePasswordLoginModule</code> to ensure that your login module provides the authenticated <code class="literal">Principal</code> information in the form expected by the EAP security manager.
		</div><div class="para">
		When sub-classing the <code class="literal">AbstractServerLoginModule</code>, you must override the following:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<code class="literal">void initialize(Subject, CallbackHandler, Map, Map)</code>: if you have custom options to parse.
			</div></li><li class="listitem"><div class="para">
				<code class="literal">boolean login()</code>: to perform the authentication activity. Be sure to set the <code class="literal">loginOk</code> instance variable to true if log in succeeds, false if it fails.
			</div></li><li class="listitem"><div class="para">
				<code class="literal">Principal getIdentity()</code>: to return the <code class="literal">Principal</code> object for the user authenticated by the <code class="literal">log()</code> step.
			</div></li><li class="listitem"><div class="para">
				<code class="literal">Group[] getRoleSets()</code>: to return at least one <code class="literal">Group</code> named <code class="literal">Roles</code> that contains the roles assigned to the <code class="literal">Principal</code> authenticated during <code class="literal">login()</code>. A second common <code class="literal">Group</code> is named <code class="literal">CallerPrincipal</code> and provides the user's application identity rather than the security domain identity.
			</div></li></ul></div><div class="para">
		When sub-classing the <code class="literal">UsernamePasswordLoginModule</code>, you must override the following:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<code class="literal">void initialize(Subject, CallbackHandler, Map, Map)</code>: if you have custom options to parse.
			</div></li><li class="listitem"><div class="para">
				<code class="literal">Group[] getRoleSets()</code>: to return at least one <code class="literal">Group</code> named <code class="literal">Roles</code> that contains the roles assigned to the <code class="literal">Principal</code> authenticated during <code class="literal">login()</code>. A second common <code class="literal">Group</code> is named <code class="literal">CallerPrincipal</code> and provides the user's application identity rather than the security domain identity.
			</div></li><li class="listitem"><div class="para">
				<code class="literal">String getUsersPassword()</code>: to return the expected password for the current user name available via the <code class="literal">getUsername()</code> method. The <code class="literal">getUsersPassword()</code> method is called from within <code class="literal">login()</code> after the <code class="literal">callbackhandler</code> returns the user name and candidate password.
			</div></li></ul></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28325-686362+%5BLatest%5D&amp;comment=Title%3A+Subject+Usage+Pattern+Support%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28325-686362+21+Jul+2014+02%3A38+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Custom_LoginModule_Example">
      ⁠</a>14.2.2. Custom LoginModule Example</h2></div></div></div><div class="para">
		The following information will help you to create a custom Login Module example that extends the <code class="literal">UsernamePasswordLoginModule</code> and obtains a user's password and role names from a JNDI lookup.
	</div><div class="para">
		At the end of this section you will have created a custom JNDI context login module that will return a user's password if you perform a lookup on the context using a name of the form <code class="literal">password/&lt;username&gt;</code> (where <code class="literal">&lt;username&gt;</code> is the current user being authenticated). Similarly, a lookup of the form <code class="literal">roles/&lt;username&gt;</code> returns the requested user's roles. In <a class="xref" href="chap-Login_Modules.html#A_Custom_LoginModule_Example-_A_JndiUserAndPass_custom_login_module">Example 14.22, “JndiUserAndPassLoginModule Custom Login Module”</a> is the source code for the <code class="literal">JndiUserAndPassLoginModule</code> custom login module.
	</div><div class="para">
		Note that because this extends the JBoss <code class="literal">UsernamePasswordLoginModule</code>, the <code class="literal">JndiUserAndPassLoginModule</code> obtains the user's password and roles from the JNDI store. The <code class="literal">JndiUserAndPassLoginModule</code> does not interact with the JAAS LoginModule operations.
	</div><div class="example"><a id="A_Custom_LoginModule_Example-_A_JndiUserAndPass_custom_login_module">
      ⁠</a><p class="title"><strong>Example 14.22. JndiUserAndPassLoginModule Custom Login Module</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span>package org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">book</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">ex2</span>;
<span xmlns="" class="line">​</span>                    
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.security.acl.Group;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.util.Map;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.naming.InitialContext;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.naming.NamingException;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.security.auth.Subject;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.security.auth.callback.CallbackHandler;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.security.auth.login.LoginException;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.logging.Logger;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.security.SimpleGroup;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.security.SimplePrincipal;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.security.auth.spi.UsernamePasswordLoginModule;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * An example custom login module that obtains passwords and roles for a user from a JNDI lookup.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@author </span><span xmlns="" class="perl_Comment">Scott.Stark@jboss.org</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> JndiUserAndPassLoginModule <span xmlns="" class="perl_Keyword">extends</span> UsernamePasswordLoginModule {
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Comment">/** The JNDI name to the context that handles the password/username lookup */</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">private</span> String userPathPrefix;
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Comment">/** The JNDI name to the context that handles the roles/username lookup */</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">private</span> String rolesPathPrefix;
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">static</span> Logger log = Logger.<span xmlns="" class="perl_Function">getLogger</span>(JndiUserAndPassLoginModule.<span xmlns="" class="perl_Function">class</span>);
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">   * Override to obtain the userPathPrefix and rolesPathPrefix options.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">   */</span>
<span xmlns="" class="line">​</span>  @Override
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> initialize(Subject subject, CallbackHandler callbackHandler, Map sharedState, Map options) {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">initialize</span>(subject, callbackHandler, sharedState, options);
<span xmlns="" class="line">​</span>    userPathPrefix = (String) options.<span xmlns="" class="perl_Function">get</span>(<span xmlns="" class="perl_String">"userPathPrefix"</span>);
<span xmlns="" class="line">​</span>    rolesPathPrefix = (String) options.<span xmlns="" class="perl_Function">get</span>(<span xmlns="" class="perl_String">"rolesPathPrefix"</span>);
<span xmlns="" class="line">​</span>  }
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">   * Get the roles the current user belongs to by querying the rolesPathPrefix + '/' + super.getUsername() JNDI location.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">   */</span>
<span xmlns="" class="line">​</span>  @Override
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">protected</span> Group[] <span xmlns="" class="perl_Function">getRoleSets</span>() <span xmlns="" class="perl_Keyword">throws</span> LoginException {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>      InitialContext ctx = <span xmlns="" class="perl_Keyword">new</span> InitialContext();
<span xmlns="" class="line">​</span>      String rolesPath = rolesPathPrefix + <span xmlns="" class="perl_Char">'/'</span> + <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getUsername</span>();
<span xmlns="" class="line">​</span>      String[] roles = (String[]) ctx.<span xmlns="" class="perl_Function">lookup</span>(rolesPath);
<span xmlns="" class="line">​</span>      Group[] groups = { <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">SimpleGroup</span>(<span xmlns="" class="perl_String">"Roles"</span>) };
<span xmlns="" class="line">​</span>      log.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Getting roles for user="</span> + <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getUsername</span>());
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">for</span> (<span xmlns="" class="perl_DataType">int</span> r = <span xmlns="" class="perl_Float">0</span>; r &lt; roles.<span xmlns="" class="perl_Function">length</span>; r++) {
<span xmlns="" class="line">​</span>        SimplePrincipal role = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">SimplePrincipal</span>(roles[r]);
<span xmlns="" class="line">​</span>        log.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Found role="</span> + roles[r]);
<span xmlns="" class="line">​</span>        groups[<span xmlns="" class="perl_Float">0</span>].<span xmlns="" class="perl_Function">addMember</span>(role);
<span xmlns="" class="line">​</span>      }
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">return</span> groups;
<span xmlns="" class="line">​</span>    } <span xmlns="" class="perl_Keyword">catch</span> (NamingException e) {
<span xmlns="" class="line">​</span>      log.<span xmlns="" class="perl_Function">error</span>(<span xmlns="" class="perl_String">"Failed to obtain groups for user="</span> + <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getUsername</span>(), e);
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> LoginException(e.<span xmlns="" class="perl_Function">toString</span>(<span xmlns="" class="perl_Keyword">true</span>));
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>  }
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">   * Get the password of the current user by querying the userPathPrefix + '/' + super.getUsername() JNDI location.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">   */</span>
<span xmlns="" class="line">​</span>  @Override
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">protected</span> String <span xmlns="" class="perl_Function">getUsersPassword</span>() <span xmlns="" class="perl_Keyword">throws</span> LoginException {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>      InitialContext ctx = <span xmlns="" class="perl_Keyword">new</span> InitialContext();
<span xmlns="" class="line">​</span>      String userPath = userPathPrefix + <span xmlns="" class="perl_Char">'/'</span> + <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getUsername</span>();
<span xmlns="" class="line">​</span>      log.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Getting password for user="</span> + <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getUsername</span>());
<span xmlns="" class="line">​</span>      String passwd = (String) ctx.<span xmlns="" class="perl_Function">lookup</span>(userPath);
<span xmlns="" class="line">​</span>      log.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Found password="</span> + passwd);
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">return</span> passwd;
<span xmlns="" class="line">​</span>    } <span xmlns="" class="perl_Keyword">catch</span> (NamingException e) {
<span xmlns="" class="line">​</span>      log.<span xmlns="" class="perl_Function">error</span>(<span xmlns="" class="perl_String">"Failed to obtain password for user="</span> + <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getUsername</span>(), e);
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> LoginException(e.<span xmlns="" class="perl_Function">toString</span>(<span xmlns="" class="perl_Keyword">true</span>));
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>  }
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="example"><a id="idm139772547740608">
      ⁠</a><p class="title"><strong>Example 14.23. Definition of security-ex2 security domain with the newly-created custom login module</strong></p><div class="example-contents"><pre class="programlisting">
/subsystem=security/security-domain=security-ex2/:add
/subsystem=security/security-domain=security-ex2/authentication=classic:add
/subsystem=security/security-domain=security-ex2/authentication=classic/login-module=ex2/:add(\
flag=required,\
code=org.jboss.book.security.ex2.JndiUserAndPassLoginModule,\
module-options=[("userPathPrefix"=&gt;"/security/store/password"),\
("rolesPathPrefix"=&gt;"/security/store/roles")]\
)


</pre></div></div><div class="para">
		The choice of using the <code class="literal">JndiUserAndPassLoginModule</code> custom login module for the server side authentication of the user is determined by the login configuration for the example security domain. The EJB JAR <code class="filename">META-INF/jboss-ejb3.xml</code> descriptor sets the security domain. For a web application it is part of the <code class="filename">WEB-INF/jboss-web.xml</code> file.
	</div><div class="example"><a id="idm139772539609424">
      ⁠</a><p class="title"><strong>Example 14.24. <code class="filename">jboss-ejb3.xml</code> Example</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss:ejb-jar</span><span xmlns="" class="perl_Others"> xmlns:jboss=</span><span xmlns="" class="perl_String">"http://www.jboss.com/xml/ns/javaee"</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"http://java.sun.com/xml/ns/javaee"</span><span xmlns="" class="perl_Others"> xmlns:s=</span><span xmlns="" class="perl_String">"urn:security"</span><span xmlns="" class="perl_Others"> version=</span><span xmlns="" class="perl_String">"3.1"</span><span xmlns="" class="perl_Others"> impl-version=</span><span xmlns="" class="perl_String">"2.0"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;assembly-descriptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;s:security&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>*<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;s:security-domain&gt;</span>security-ex2<span xmlns="" class="perl_Keyword">&lt;/s:security-domain&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/s:security&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/assembly-descriptor&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss:ejb-jar&gt;</span>
<span xmlns="" class="line">​</span>
</pre></div></div><div class="example"><a id="idm139772555971024">
      ⁠</a><p class="title"><strong>Example 14.25. <code class="filename">jboss-web.xml example</code></strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss-web&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;security-domain&gt;</span>security-ex2<span xmlns="" class="perl_Keyword">&lt;/security-domain&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss-web&gt;</span>
<span xmlns="" class="line">​</span>
</pre></div></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+28326-638684+%5BLatest%5D&amp;comment=Title%3A+Custom+LoginModule+Example%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=28326-638684+06+May+2014+22%3A50+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div></div></div></body></html>