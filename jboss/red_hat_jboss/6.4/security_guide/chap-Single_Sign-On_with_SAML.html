<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 13. Single Sign-On with SAML</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="chap-Single_Sign-On_with_SAML">
      ⁠</a>Chapter 13. Single Sign-On with SAML</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="Security_Token_Server_STS">
      ⁠</a>13.1. About Security Token Service (STS)</h1></div></div></div><div class="para">
		The Security Token Service generates and manages the security tokens. It does not issue tokens of a specific type. Instead, it defines generic interfaces that allows multiple token providers to be plugged in. As a result, it can be configured to deal with various types of token, as long as a token provider exists for each token type. It also specifies the format of the security token request and response messages.
	</div><div class="para">
		A security token request message specifies the following:
	</div><div class="para">
		<div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					Type of the request, such as Issue, Renew, and so on.
				</div></li></ul></div>
		 <div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					Type of the token.
				</div></li></ul></div>
		 <div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					Lifetime of the issued token.
				</div></li></ul></div>
		 <div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					Information about the service provider that requested the token.
				</div></li></ul></div>
		 <div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					Information used to encrypt the generated token.
				</div></li></ul></div>

	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			Support for PKCS#11 tokens has been added to JBoss EAP from version 6.3.0.
		</div><div class="para">
			EAP security realms can accept PKCS#11 keys and trust store definitions by using the <em class="parameter"><code>provider</code></em> attribute. The value specified in this parameter is passed to the relevant <code class="literal">KeyStore.getInstance("PKCS11")</code> calls and the key and trust store are initialized.
		</div><div class="para">
			Configuration for this new support is beyond the scope of EAP documentation. Users who wish to utilize this feature should familiarize themselves with the correct installation of PKCS#11 hardware and software as well as the correct entries required in the <code class="literal">java.security</code> policy file. Oracle's <em class="citetitle">Java PKCs#11 Reference Guide</em> document may be a useful resource for this information.
		</div></div></div><div class="para">
		The token request message is sent in the body of the SOAP message. All information related to the token request is enclosed in the <code class="code">RequestSecurityToken</code> element. The sample request contains two other WS-Trust elements: <code class="code">RequestType</code>, which specifies that this request is an Issue request, and <code class="code">TokenType</code>, which specifies the type of the token to be issued.
	</div><div class="para">
		The following is an example of the WS-Trust request message.
	</div><div class="example"><a id="idm139772525372944">
      ⁠</a><p class="title"><strong>Example 13.1. WS-Trust security token request message</strong></p><div class="example-contents"><pre class="programlisting">&lt;S11:Envelope xmlns:S11=".." xmlns:wsu=".." xmlns:wst=".."&gt;  
   &lt;S11:Header&gt;  
      ...  
   &lt;/S11:Header&gt;  
   &lt;S11:Body wsu:Id="body"&gt;  
      &lt;wst:RequestSecurityToken Context="context"&gt;  
         &lt;wst:TokenType&gt;http://www.tokens.org/SpecialToken&lt;/wst:TokenType&gt;  
         &lt;wst:RequestType&gt;  
            http://docs.oasis-open.org/ws-sx/ws-trust/200512/Issue  
         &lt;/wst:RequestType&gt;  
      &lt;/wst:RequestSecurityToken&gt;  
   &lt;/S11:Body&gt;  
&lt;/S11:Envelope&gt;

</pre></div></div><div class="para">
		The following is an example of a security token response.
	</div><div class="example"><a id="idm139772526317904">
      ⁠</a><p class="title"><strong>Example 13.2. Security token response message</strong></p><div class="example-contents"><pre class="programlisting">    &lt;wst:RequestSecurityTokenResponse Context="context" xmlns:wst=".." xmlns:wsu=".."&gt;  
       &lt;wst:TokenType&gt;http://www.tokens.org/SpecialToken&lt;/wst:TokenType&gt;  
       &lt;wst:RequestedSecurityToken&gt;  
          &lt;token:SpecialToken xmlns:token="..."&gt;  
             ARhjefhE2FEjneovi&amp;@FHfeoveq3  
          &lt;/token:SpecialToken&gt;  
       &lt;/wst:RequestedSecurityToken&gt;  
       &lt;wst:Lifetime&gt;  
          &lt;wsu:Created&gt;...&lt;/wsu:Created&gt;  
          &lt;wsu:Expires&gt;...&lt;/wsu:Expires&gt;  
       &lt;/wst:Lifetime&gt;  
    &lt;/wst:RequestSecurityTokenResponse&gt; 

</pre></div></div><div class="para">
		In the example for the security token response, the <code class="code">TokenType</code> element specifies the type of the issued token, while the <code class="code">RequestedSecurityToken</code> element contains the token itself. The format of the token depends on the type of the token. The <code class="code">Lifetime</code> element specifies when the token was created and when it expires.
	</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Security Token Request Processing</div>
			The following are the steps in which the security token requests are processed:
		</div><div class="para">
		<div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					A client sends a security token request to <code class="code">PicketLinkSTS</code>.
				</div></li></ul></div>
		 <div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					<code class="code">PicketLinkSTS</code> parses the request message, generating a JAXB object model.
				</div></li></ul></div>
		 <div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					<code class="code">PicketLinkSTS</code> reads the configuration file and creates the <code class="code">STSConfiguration</code> object, if needed. Then it obtains a reference to the <code class="code">WSTrustRequestHandler</code> from the configuration and delegates the request processing to the handler instance.
				</div></li></ul></div>
		 <div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					The request handler uses the <code class="code">STSConfiguration</code> to set default values when needed (for example, when the request doesn't specify a token lifetime value).
				</div></li></ul></div>
		 <div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					The <code class="code">WSTrustRequestHandler</code> creates the <code class="code">WSTrustRequestContext</code>, setting the <code class="code">JAXB</code> request object and the caller principal it received from <code class="code">PicketLinkSTS</code>.
				</div></li></ul></div>
		 <div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					The <code class="code">WSTrustRequestHandler</code> uses the <code class="code">STSConfiguration</code> to get the <code class="code">SecurityTokenProvider</code> that must be used to process the request based on the type of the token that is being requested. Then it invokes the provider, passing the constructed <code class="code">WSTrustRequestContext</code> as a parameter.
				</div></li></ul></div>
		 <div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					The <code class="code">SecurityTokenProvider</code> instance process the token request and stores the issued token in the request context.
				</div></li></ul></div>
		 <div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					The <code class="code">WSTrustRequestHandler</code> obtains the token from the context, encrypts it if needed, and constructs the WS-Trust response object containing the security token.
				</div></li></ul></div>
		 <div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					<code class="code">PicketLinkSTS</code> dictates the response generated by the request handler and returns it to the client.
				</div></li></ul></div>

	</div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+24107-639123+%5BLatest%5D&amp;comment=Title%3A+About+Security+Token+Service+%28STS%29%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=24107-639123+08+May+2014+01%3A04+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="Configure_STS_Login_Modules">
      ⁠</a>13.2. Configure Security Token Service (STS)</h1></div></div></div><div class="para">
		The EAP Security Token Service (STS) defines several interfaces that provide extension points. Implementations can be plugged in via configuration, and the default values can be specified for some properties via configuration. All STS configurations are specified in the <code class="filename">picketlink.xml</code> file, which belongs in the <code class="filename">WEB-INF</code> directory of the deployed application. The following are the elements that can be configured in the <code class="filename">picketlink.xml</code> file.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			In the following text, a <em class="firstterm">service provider</em> refers to the Web service that requires a security token to be presented by its clients.
		</div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<code class="code">PicketLinkSTS</code>: This is the root element. It defines some properties that allows the STS administrator to set a the following default values:
			</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
						<code class="code">STSName</code>: A string representing the name of the security token service. If not specified, the default <code class="code">PicketLinkSTS</code> value is used.
					</div></li><li class="listitem"><div class="para">
						<code class="code">TokenTimeout</code>: The token lifetime value in seconds. If not specified, the default value of 3600 (one hour) is used.
					</div></li><li class="listitem"><div class="para">
						<code class="code">EncryptToken</code>: A boolean specifying whether issued tokens are to be encrypted or not. The default value is false.
					</div></li></ul></div></li><li class="listitem"><div class="para">
				<code class="code">KeyProvider</code>: This element and all its sub elements are used to configure the keystore that are used by PicketLink STS to sign and encrypt tokens. Properties like the keystore location, its password, and the signing (private key) alias and password are all configured in this section.
			</div></li><li class="listitem"><div class="para">
				<code class="code">RequestHandler</code>: This element specifies the fully qualified name of the <code class="code">WSTrustRequestHandler</code> implementation to be used. If not specified, the default <code class="code">org.picketlink.identity.federation.core.wstrust.StandardRequestHandler</code> is used.
			</div></li><li class="listitem"><div class="para">
				<code class="code">TokenProvider</code>: This section specifies the <code class="code">TokenProvider</code> implementations that must be used to handle each type of security token. In the example we have two providers - one that handles tokens of type <code class="code">SpecialToken</code> and one that handles tokens of type <code class="code">SAMLV2.0</code>. The <code class="code">WSTrustRequestHandler</code> calls the <code class="code">getProviderForTokenType</code>(String type) method of <code class="code">STSConfiguration</code> to obtain a reference to the appropriate <code class="code">TokenProvider</code>.
			</div></li><li class="listitem"><div class="para">
				<code class="code">TokenTimeout</code>: This is used by the <code class="code">WSTrustRequestHandler</code> when no Lifetime has been specified in the WS-Trust request. It creates a Lifetime instance that has the current time as the creation time and expires after the specified number of seconds.
			</div></li><li class="listitem"><div class="para">
				<code class="code">ServiceProviders</code>: This section specifies the token types that must be used for each service provider (the Web service that requires a security token). When a WS-Trust request does not contain the token type, the <code class="code">WSTrustRequestHandler</code> must use the service provider endpoint to find out the type of the token that must be issued.
			</div></li><li class="listitem"><div class="para">
				<code class="code">EncryptToken</code>: This is used by the <code class="code">WSTrustRequestHandler</code> to decide if the issued token must be encrypted or not. If true, the public key certificate (PKC) of the service provider is used to encrypt the token.
			</div></li></ul></div><div class="para">
		The following is an example of STS configuration.
	</div><div class="example"><a id="idm139772538696144">
      ⁠</a><p class="title"><strong>Example 13.3. STS Configuration</strong></p><div class="example-contents"><pre class="programlisting">&lt;PicketLinkSTS xmlns="urn:picketlink:identity-federation:config:1.0"  
         STSName="Test STS" TokenTimeout="7200" EncryptToken="true"&gt;  
  &lt;KeyProvider ClassName="org.picketlink.identity.federation.bindings.tomcat.KeyStoreKeyManager"&gt;  
    &lt;Auth Key="KeyStoreURL" Value="keystore/sts_keystore.jks"/&gt;   
    &lt;Auth Key="KeyStorePass" Value="testpass"/&gt;  
    &lt;Auth Key="SigningKeyAlias" Value="sts"/&gt;  
    &lt;Auth Key="SigningKeyPass" Value="keypass"/&gt;  
    &lt;ValidatingAlias Key="http://services.testcorp.org/provider1" Value="service1"/&gt;  
    &lt;ValidatingAlias Key="http://services.testcorp.org/provider2" Value="service2"/&gt;  
 &lt;/KeyProvider&gt;  
 &lt;RequestHandler&gt;org.picketlink.identity.federation.core.wstrust.StandardRequestHandler&lt;/RequestHandler&gt;  
 &lt;TokenProviders&gt;  
    &lt;TokenProvider ProviderClass="org.picketlink.test.identity.federation.bindings.wstrust.SpecialTokenProvider"  
         TokenType="http://www.tokens.org/SpecialToken"/&gt;  
    &lt;TokenProvider ProviderClass="org.picketlink.identity.federation.api.wstrust.plugins.saml.SAML20TokenProvider"  
         TokenType="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0"/&gt;  
	&lt;/TokenProviders&gt;  
	&lt;ServiceProviders&gt;  
		&lt;ServiceProvider Endpoint="http://services.testcorp.org/provider1" TokenType="http://www.tokens.org/SpecialToken"  
         TruststoreAlias="service1"/&gt;  
		&lt;ServiceProvider Endpoint="http://services.testcorp.org/provider2" TokenType="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0"  
         TruststoreAlias="service2"/&gt;  
	&lt;/ServiceProviders&gt;  
&lt;/PicketLinkSTS&gt;  

</pre></div></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+24108-688464+%5BLatest%5D&amp;comment=Title%3A+Configure+Security+Token+Service+%28STS%29%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=24108-688464+28+Jul+2014+00%3A07+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="About_PicketLink_STS_Login_Modules">
      ⁠</a>13.3. About PicketLink STS Login Modules</h1></div></div></div><div class="para">
		A PicketLink Login Module is typically configured as part of the security setup of a JEE container to use a Security Token Service for authenticating users. The STS may be collocated on the same container as the Login Module or be accessed remotely through Web Service calls or another technology. PicketLink Login Modules support non-PicketLink STS implementations through standard WS-Trust calls.
	</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Types of STS Login Modules</div>
			The following are the different types of STS Login Modules.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><p class="title"><strong>STSIssuingLoginModule</strong></p><ul><li class="listitem"><div class="para">
				Calls the configured STS and requests for a security token. Upon successfully receiving the <code class="code">RequestedSecurityToken</code>, it marks the authentication as successful.
			</div></li><li class="listitem"><div class="para">
				A call to STS typically requires authentication. This Login Module uses credentials from one of the following sources:
			</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
						Its properties file, if the <code class="code">useOptionsCredentials</code> module option is set to <code class="code">true</code>.
					</div></li><li class="listitem"><div class="para">
						Previous login module credentials if the <code class="code">password-stacking</code>module option is set to <code class="code">useFirstPass</code>.
					</div></li><li class="listitem"><div class="para">
						From the configured <code class="code">CallbackHandler</code> by supplying a Name and Password Callback.
					</div></li></ul></div></li><li class="listitem"><div class="para">
				Upon successful authentication, the <code class="code">SamlCredential</code> is inserted in the Subject's public credentials if one with the same Assertion is not found to be already present there.
			</div></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><p class="title"><strong>STSValidatingLoginModule</strong></p><ul><li class="listitem"><div class="para">
				Calls the configured STS and validates an available security token.
			</div></li><li class="listitem"><div class="para">
				A call to STS typically requires authentication. This Login Module uses credentials from one of the following sources:
			</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
						Its properties file, if the <code class="code">useOptionsCredentials</code> module option is set to <code class="code">true</code>.
					</div></li><li class="listitem"><div class="para">
						Previous login module credentials if the <code class="code">password-stacking</code> module option is set to <code class="code">useFirstPass</code>.
					</div></li><li class="listitem"><div class="para">
						From the configured <code class="code">CallbackHandler</code> by supplying a Name and Password Callback.
					</div></li></ul></div></li><li class="listitem"><div class="para">
				Upon successful authentication, the SamlCredential is inserted in the Subject's public credentials if one with the same Assertion is not found to be already present there.
			</div></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><p class="title"><strong>SAML2STSLoginModule</strong></p><ul><li class="listitem"><div class="para">
				This Login Module supplies a <code class="code">ObjectCallback</code> to the configured <code class="code">CallbackHandler</code> and expects a <code class="code">SamlCredential</code> object back. The Assertion is validated against the configured STS.
			</div></li><li class="listitem"><div class="para">
				If a user ID and SAML token are shared, this Login Module bypasses validation When stacked on top of another Login Module that is successfully authenticated.
			</div></li><li class="listitem"><div class="para">
				Upon successful authentication, the <code class="code">SamlCredential</code> is inspected for a <code class="code">NameID</code> and a multi-valued role attribute that is respectively set as the ID and roles of the user.
			</div></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><p class="title"><strong>SAML2LoginModule</strong></p><ul><li class="listitem"><div class="para">
				This login module is used in conjunction with other components for SAML authentication and performs no authentication itself.
			</div></li><li class="listitem"><div class="para">
				The <code class="code">SPRedirectFormAuthenticator</code> uses this login module in PicketLink's implementation of the SAML v2 HTTP Redirect Profile.
			</div></li><li class="listitem"><div class="para">
				The Tomcat authenticator valve performs authentication through redirecting to the identity provider and getting a SAML assertion.
			</div></li><li class="listitem"><div class="para">
				This login module is used to pass the user ID and roles to the JBoss security framework to be populated in the JAAS subject.
			</div></li></ul></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+24255-592552+%5BLatest%5D&amp;comment=Title%3A+About+PicketLink+STS+Login+Modules%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=24255-592552+23+Feb+2014+16%3A59+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="Configure_STSIssuingLoginModule">
      ⁠</a>13.4. Configure STSIssuingLoginModule</h1></div></div></div><div class="para">
		The <code class="code">STSIssuingLoginModule</code> uses a user name and password to authenticate the user against an STS by retrieving a token.
	</div><div class="example"><a id="idm139772564614880">
      ⁠</a><p class="title"><strong>Example 13.4. Configure STSIssuingLoginModule</strong></p><div class="example-contents"><pre class="programlisting">&lt;security-domain name="saml-issue-token"&gt;
    &lt;authentication&gt;
        &lt;login-module
            code="org.picketlink.identity.federation.core.wstrust.auth.STSIssuingLoginModule" flag="required"&gt;          &lt;module-option name="configFile"&gt;./picketlink-sts-client.properties&lt;/module-option&gt;
          &lt;module-option name="endpointURI"&gt;http://security_saml/endpoint&lt;/module-option&gt;
        &lt;/login-module&gt;
    &lt;/authentication&gt;
    &lt;mapping&gt;
        &lt;mapping-module
            code="org.picketlink.identity.federation.bindings.jboss.auth.mapping.STSPrincipalMappingProvider"
            type="principal" /&gt;
        &lt;mapping-module
            code="org.picketlink.identity.federation.bindings.jboss.auth.mapping.STSGroupMappingProvider"
            type="role" /&gt;
    &lt;/mapping&gt;
&lt;/security-domain&gt;

</pre></div></div><div class="para">
		Most configurations can switch to the configuration sited in the above example by:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				changing their declared security-domain
			</div></li><li class="listitem"><div class="para">
				specifying a Principal mapping provider
			</div></li><li class="listitem"><div class="para">
				specifying a RoleGroup mapping provider
			</div></li></ul></div><div class="para">
		The specified Principal mapping provider and the RoleGroup mapping provider results in an authenticated Subject being populated that enables coarse-grained and role-based authorization. After authentication, the Security Token is available and may be used to invoke other services by Single Sign-On.
	</div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+24270-685995+%5BLatest%5D&amp;comment=Title%3A+Configure+STSIssuingLoginModule%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=24270-685995+18+Jul+2014+07%3A28+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="Configure_STSValidatingLoginModule">
      ⁠</a>13.5. Configure STSValidatingLoginModule</h1></div></div></div><div class="para">
		The STSValidatingLoginModule uses a TokenCallback to ask the configured CallbackHandler an STS by retrieving a token.
	</div><div class="example"><a id="idm139772567772944">
      ⁠</a><p class="title"><strong>Example 13.5. Configure STSValidatingLoginModule</strong></p><div class="example-contents"><pre class="programlisting">&lt;security-domain name="saml-validate-token"&gt;
    &lt;authentication&gt;
        &lt;login-module
            code="org.picketlink.identity.federation.core.wstrust.auth.STSValidatingLoginModule" flag="required"&gt;
            &lt;module-option name="configFile"&gt;./picketlink-sts-client.properties&lt;/module-option&gt;
            &lt;module-option name="endpointURI"&gt;http://security_saml/endpoint&lt;/module-option&gt;
        &lt;/login-module&gt;
    &lt;/authentication&gt;
    &lt;mapping&gt;
        &lt;mapping-module
            code="org.picketlink.identity.federation.bindings.jboss.auth.mapping.STSPrincipalMappingProvider"
            type="principal" /&gt;
        &lt;mapping-module
            code="org.picketlink.identity.federation.bindings.jboss.auth.mapping.STSGroupMappingProvider"
            type="role" /&gt;
    &lt;/mapping&gt;
&lt;/security-domain&gt;

</pre></div></div><div class="para">
		The configuration cited in the example enables Single Sign-On for your applications and services. A token once issued, either by directly contacting the STS or through a token-issuing login module, can be used to authenticate against multiple applications and services by employing the setup provided in the example. Providing a Principal mapping provider and a RoleGroup mapping provider result in an authenticated Subject being populated that enables coarse-grained and role-based authorization. After authentication, the Security Token is available and can be used to invoke other services by Single Sign-On.
	</div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+24271-685996+%5BLatest%5D&amp;comment=Title%3A+Configure+STSValidatingLoginModule%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=24271-685996+18+Jul+2014+07%3A29+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="STS_Client_Pooling">
      ⁠</a>13.6. STS Client Pooling</h1></div></div></div><div class="para">
		The PicketLink provides a pool of STS clients on the server. This removes STS Client creation as a bottleneck.
	</div><div class="para">
		Client pooling can be utilized from login modules that need an STS client to obtain SAML tickets.
	</div><div class="para">
		Login Modules that can utilize STS client pooling:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				org.picketlink.identity.federation.core.wstrust.auth.STSIssuingLoginModule
			</div></li><li class="listitem"><div class="para">
				org.picketlink.identity.federation.core.wstrust.auth.STSValidatingLoginModule
			</div></li><li class="listitem"><div class="para">
				org.picketlink.trust.jbossws.jaas.JBWSTokenIssuingLoginModule
			</div></li></ul></div><div class="para">
		The default number of clients in the pool for each login module is configured via the <code class="literal">initialNumberOfClients</code> login module option.
	</div><div class="para">
		The STSClientPoolFactory class <code class="classname">org.picketlink.identity.federation.bindings.stspool.STSClientPoolFactory</code> provides client pool functionality to applications.
	</div><h3><a id="idm139772525370064">
      ⁠</a> Using STSClientPoolFactory </h3><div class="para">
		STS clients are inserted into sub pools using their <a href="http://docs.jboss.org/jbossas/javadoc/7.1.2.Final/org/picketlink/identity/federation/core/wstrust/class-use/STSClientConfig.html">configuration</a> as a key. Obtain STSClientPool instance and then initialize a sub pool based on configuration, optionally with initial number of STS clients or rely on default number.
	</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_DataType">final</span> STSClientPool pool = STSClientPoolFactory.<span xmlns="" class="perl_Function">getPoolInstance</span>();
<span xmlns="" class="line">​</span>pool.<span xmlns="" class="perl_Function">createPool</span>(<span xmlns="" class="perl_Float">20</span>, stsClientConfig);
<span xmlns="" class="line">​</span><span xmlns="" class="perl_DataType">final</span> STSClient client = pool.<span xmlns="" class="perl_Function">getClient</span>(stsClientConfig);
</pre><div class="para">
		When you are done with a client, you can return it to the pool like so:
	</div><pre class="programlisting">pool.returnClient();</pre><div class="para">
		To check if a subpool already exists for a given configuration:
	</div><pre class="programlisting">
if (! pool.configExists(stsClientConfig) {  
    pool.createPool(stsClientConfig);  
}
</pre><div class="para">
		When the PicketLink Federation subsystem is enabled, all client pools created for a deployment are destroyed automatically during the undeploy process. To manually destroy a pool:
	</div><pre class="programlisting">pool.destroyPool(stsClientConfig);</pre><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+41096-689166+%5BLatest%5D&amp;comment=Title%3A+STS+Client+Pooling%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=41096-689166+30+Jul+2014+01%3A47+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-SAML_Web_Browser_Based_SSO">
      ⁠</a>13.7. SAML Web Browser Based SSO</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="SAML_Web_Browser_Based_SSO">
      ⁠</a>13.7.1. About SAML Web Browser Based SSO</h2></div></div></div><div class="para">
		PicketLink in JBoss EAP provides a platform to implement federated identity based services. This includes centralized identity services and Single Sign-On (SSO) for applications.
	</div><div class="para">
		The SAML profile has support for both the HTTP/POST and the HTTP/Redirect bindings with centralized identity services to enable web SSO for your applications. The architecture for the SAML v2 based Web SSO follows the hub and spoke architecture of identity management. In this architecture an identity provider (IDP) acts as the central source (hub) for identity and role information to all the applications (Service Providers). The spokes are the service providers (SP).
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
			If there are two or more SPs both pointing to the same IDP, the IDP does not distinguish between the different SPs. If you make requests to different SPs that point to the same IDP, the IDP handles the most recent request from an SP and sends back SAML assertion about the authenticated user. To get back to the an older SP request, you will need to reenter the SP URL in the browser.
		</div></div></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+24105-628427+%5BLatest%5D&amp;comment=Title%3A+About+SAML+Web+Browser+Based+SSO%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=24105-628427+09+Apr+2014+01%3A48+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Setup_SAML_v2_based_Web_SSO_using_HTTPRedirect_Binding">
      ⁠</a>13.7.2. Setup SAML v2 based Web SSO</h2></div></div></div><div class="para">
		To setup SAML v2 based SSO you have to configure the following:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				Identity Provider: The Identity Provider is the authoritative entity responsible for authenticating an end user and asserting the identity for that user in a trusted fashion to trusted partners.
			</div></li><li class="listitem"><div class="para">
				Service Provider: The Service Provider relies on the Identity Provider to assert information about a user via an electronic user credential, leaving the service provider to manage access control and dissemination based on a trusted set of user credential assertions.
			</div></li></ul></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+24273-685976+%5BLatest%5D&amp;comment=Title%3A+Setup+SAML+v2+based+Web+SSO%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=24273-685976+18+Jul+2014+05%3A32+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Configure_Identity_Provider">
      ⁠</a>13.7.3. Configure Identity Provider</h2></div></div></div><div class="para">
		The Identity Provider (IDP) is a JBoss EAP server instance.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="idm139772497346592">
      ⁠</a><p class="title"><strong>Procedure 13.1. Configure Identity Provider (IDP)</strong></p><ol class="1"><li class="step"><p class="title"><strong>Configure the web application security for the IDP</strong></p><div class="para">
				Configure a web application as the Identity provider.
			</div><div class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					The use of FORM based web application security is recommended as it gives you the ability to customize the login page.
				</div></div></div><div class="para">
				The following is an example of the <code class="filename">web.xml</code> configuration
			</div><div class="example"><a id="idm139772567774656">
      ⁠</a><p class="title"><strong>Example 13.6. <code class="filename">web.xml</code> Configuration for IDP</strong></p><div class="example-contents"><pre class="programlisting">&lt;display-name&gt;IDP&lt;/display-name&gt;
&lt;description&gt;IDP&lt;/description&gt;
&lt;!-- Define a security constraint that gives unlimited access to images --&gt;
&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
  &lt;web-resource-name&gt;Images&lt;/web-resource-name&gt;
  &lt;url-pattern&gt;/images/*&lt;/url-pattern&gt;
&lt;/web-resource-collection&gt;
&lt;/security-constraint&gt;
&lt;!-- Define a Security Constraint on this Application --&gt;
&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
  &lt;web-resource-name&gt;IDP&lt;/web-resource-name&gt;
  &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/web-resource-collection&gt;
  &lt;auth-constraint&gt;
  &lt;role-name&gt;manager&lt;/role-name&gt;
&lt;/auth-constraint&gt;
&lt;/security-constraint&gt;
&lt;!-- Define the Login Configuration for this Application --&gt;
&lt;login-config&gt;
  &lt;auth-method&gt;FORM&lt;/auth-method&gt;
  &lt;realm-name&gt;IDP Application&lt;/realm-name&gt;
  &lt;form-login-config&gt;
    &lt;form-login-page&gt;/jsp/login.jsp&lt;/form-login-page&gt;
    &lt;form-error-page&gt;/jsp/loginerror.jsp&lt;/form-error-page&gt;
  &lt;/form-login-config&gt;
&lt;/login-config&gt;
&lt;!-- Security roles referenced by this web application --&gt;
&lt;security-role&gt;
 &lt;description&gt;
  The role that is required to log in to the IDP Application
 &lt;/description&gt;
 &lt;role-name&gt;manager&lt;/role-name&gt;
&lt;/security-role&gt;
&lt;/web-app&gt;
</pre></div></div></li><li class="step"><p class="title"><strong>Create Security Domain for IDP</strong></p><div class="para">
				Create a Security Domain with authentication and authorization mechanisms defined for the IDP. Refer to <a class="xref" href="chap-Authentication_and_Authorization.html#Use_a_Security_Domain_in_Your_Application">Section 11.9, “Use a Security Domain in Your Application”</a> for further details.
			</div></li><li class="step"><p class="title"><strong>Configure the IDP Valves</strong></p><div class="para">
				Create a <code class="filename">jboss-web.xml</code> file in the <code class="filename">WEB-INF</code> directory of your IDP web application to configure the valves for the IDP. The following is an example of <code class="filename">jboss-web.xml</code> file.
			</div><div class="example"><a id="idm139772538668624">
      ⁠</a><p class="title"><strong>Example 13.7. <code class="filename">jboss-web.xml</code> File Configuration for IDP Valves</strong></p><div class="example-contents"><pre class="programlisting">&lt;jboss-web&gt;
  &lt;security-domain&gt;idp&lt;/security-domain&gt;
  &lt;context-root&gt;idp&lt;/context-root&gt;
  &lt;valve&gt;
    &lt;class-name&gt;org.picketlink.identity.federation.bindings.tomcat.idp.IDPWebBrowserSSOValve&lt;/class-name&gt;
  &lt;/valve&gt;
&lt;/jboss-web&gt;
</pre></div></div></li><li class="step"><p class="title"><strong>Configure the PicketLink Configuration File (<code class="filename">picketlink.xml</code>)</strong></p><div class="para">
				The following is an example of <code class="filename">picketlink.xml</code> configuration. In this configuration file you provide the URL that gets added as the issuer in the outgoing SAML2 assertions to the service providers and the IDP.
			</div><div class="example"><a id="idm139772562523248">
      ⁠</a><p class="title"><strong>Example 13.8. <code class="filename">picketlink.xml</code> Configuration</strong></p><div class="example-contents"><pre class="programlisting">&lt;PicketLink xmlns="urn:picketlink:identity-federation:config:2.1"&gt;
  &lt;PicketLinkIDP xmlns="urn:picketlink:identity-federation:config:2.1"&gt;
    &lt;IdentityURL&gt;http://localhost:8080/idp/&lt;/IdentityURL&gt;
  &lt;/PicketLinkIDP&gt;
  &lt;Handlers xmlns="urn:picketlink:identity-federation:handler:config:2.1"&gt;
    &lt;Handler class="org.picketlink.identity.federation.web.handlers.saml2.SAML2IssuerTrustHandler" /&gt;
    &lt;Handler class="org.picketlink.identity.federation.web.handlers.saml2.SAML2LogOutHandler" /&gt;
    &lt;Handler class="org.picketlink.identity.federation.web.handlers.saml2.SAML2AuthenticationHandler" /&gt;
    &lt;Handler class="org.picketlink.identity.federation.web.handlers.saml2.RolesGenerationHandler" /&gt;
  &lt;/Handlers&gt;
&lt;/PicketLink&gt;
</pre></div></div><div class="para">
				By default, <code class="filename">picketlink.xml</code> is located in the <code class="filename">WEB-INF</code> directory of your IDP web application. However, you can configure a custom path to a <code class="filename">picketlink.xml</code> that is external to the application:
			</div><ol class="substeps a"><li class="step"><p class="title"><strong>Optional: Configuring a custom path to <code class="filename">picketlink.xml</code></strong></p><div class="para">
						Add two paramaters to the valve element in your application's <code class="filename">WEB-INF/jboss-web.xml</code>: <code class="varname">configFile</code> specifying for the path to <code class="filename">picketlink.xml</code>, and <code class="varname">timerInterval</code> which specifies the interval in milliseconds to reload the configuration. For example:
					</div><pre class="programlisting">&lt;valve&gt;
  &lt;class-name&gt;...&lt;/class-name&gt;
    &lt;param&gt;
      &lt;param-name&gt;timerInterval&lt;/param-name&gt;
      &lt;param-value&gt;5000&lt;/param-value&gt;
    &lt;/param&gt;
    &lt;param&gt;
      &lt;param-name&gt;configFile&lt;/param-name&gt;
      &lt;param-value&gt;path-to/picketlink.xml&lt;/param-value&gt;
    &lt;/param&gt;
&lt;/valve&gt;
</pre></li></ol></li><li class="step"><p class="title"><strong>Declare dependencies on PicketLink module (<code class="filename">META-INF/MANIFEST.MF</code>, or <code class="filename">jboss-deployment-structure.xml</code>)</strong></p><div class="para">
				The web application also requires a dependency defining in <code class="filename">META-INF/MANIFEST.MF</code> or <code class="filename">jboss-deployment-structure.xml</code>, so that the PicketLink classes can be located.
			</div><div class="example"><a id="idm139772556593152">
      ⁠</a><p class="title"><strong>Example 13.9. Define Dependency in <code class="filename">META-INF/MANIFEST.MF</code></strong></p><div class="example-contents"><pre class="programlisting">Manifest-Version: 1.0
    Build-Jdk: 1.6.0_24
    Dependencies: org.picketlink</pre></div></div><div class="example"><a id="idm139772533636768">
      ⁠</a><p class="title"><strong>Example 13.10. Define Dependency in <code class="filename">META-INF/jboss-deployment-structure.xml</code></strong></p><div class="example-contents"><pre class="programlisting">&lt;jboss-deployment-structure&gt;  
  &lt;deployment&gt;    
    &lt;dependencies&gt;
      &lt;module name="org.picketlink" /&gt;
    &lt;/dependencies&gt;
  &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;
</pre></div></div></li></ol></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+24284-685980+%5BLatest%5D&amp;comment=Title%3A+Configure+Identity+Provider%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=24284-685980+18+Jul+2014+05%3A40+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Configure_Service_Provider">
      ⁠</a>13.7.4. Configure Service Provider using HTTP/REDIRECT Binding</h2></div></div></div><div class="para">
		The Service Provider (SP) can be a JBoss EAP server instance.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="idm139772497020720">
      ⁠</a><p class="title"><strong>Procedure 13.2. Configure Service Provider (SP)</strong></p><ol class="1"><li class="step"><p class="title"><strong>Configure the Web Application Security For the SP</strong></p><div class="para">
				The web application to be configured as a SP should have FORM based security enabled in its <code class="filename">web.xml</code> file.
			</div><div class="example"><a id="idm139772548783952">
      ⁠</a><p class="title"><strong>Example 13.11. <code class="filename">web.xml</code> Configuration for SP</strong></p><div class="example-contents"><pre class="programlisting">&lt;display-name&gt;SP&lt;/display-name&gt;
&lt;description&gt;SP&lt;/description&gt;
&lt;!-- Define a security constraint that gives unlimited access to images --&gt;
&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
    &lt;web-resource-name&gt;Images&lt;/web-resource-name&gt;
    &lt;url-pattern&gt;/images/*&lt;/url-pattern&gt;
  &lt;/web-resource-collection&gt;
&lt;/security-constraint&gt;
&lt;!-- Define a Security Constraint on this Application --&gt;
&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
    &lt;web-resource-name&gt;SP&lt;/web-resource-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
  &lt;/web-resource-collection&gt;
  &lt;auth-constraint&gt;
    &lt;role-name&gt;manager&lt;/role-name&gt;
  &lt;/auth-constraint&gt;
&lt;/security-constraint&gt;
&lt;!-- Define the Login Configuration for this Application --&gt;
&lt;login-config&gt;
  &lt;auth-method&gt;FORM&lt;/auth-method&gt;
  &lt;realm-name&gt;SP Application&lt;/realm-name&gt;
  &lt;form-login-config&gt;
    &lt;form-login-page&gt;/jsp/login.jsp&lt;/form-login-page&gt;
    &lt;form-error-page&gt;/jsp/loginerror.jsp&lt;/form-error-page&gt;
  &lt;/form-login-config&gt;
&lt;/login-config&gt;
&lt;!-- Security roles referenced by this web application --&gt;
&lt;security-role&gt;
    &lt;description&gt;
   The role that is required to log in to the SP Application
  &lt;/description&gt;
  &lt;role-name&gt;manager&lt;/role-name&gt;
&lt;/security-role&gt;
&lt;/web-app&gt;
</pre></div></div></li><li class="step"><p class="title"><strong>Create Security Domain for SP</strong></p><div class="para">
				Create a Security Domain that uses <code class="filename">SAML2LoginModule</code>. Here is an example configuration:
			</div><pre class="screen">&lt;security-domain name="sp" cache-type="default"&gt;
  &lt;authentication&gt;
    &lt;login-module code="org.picketlink.identity.federation.bindings.jboss.auth.SAML2LoginModule" flag="required"/&gt;
   &lt;/authentication&gt;
&lt;/security-domain&gt;
</pre></li><li class="step"><p class="title"><strong>Configure the SP Valve</strong></p><div class="para">
				To configure the valve for the SP, create a <code class="filename">jboss-web.xml</code> in the <code class="filename">WEB-INF</code> directory of your SP web application.
			</div><div class="example"><a id="idm139772558454608">
      ⁠</a><p class="title"><strong>Example 13.12. <code class="filename">jboss-web.xml</code> File Configuration for SP Valves</strong></p><div class="example-contents"><pre class="programlisting">&lt;jboss-web&gt;
  &lt;security-domain&gt;sp&lt;/security-domain&gt;
  &lt;context-root&gt;sales-post&lt;/context-root&gt;
  &lt;valve&gt;
    &lt;class-name&gt;org.picketlink.identity.federation.bindings.tomcat.sp.ServiceProviderAuthenticator&lt;/class-name&gt;
  &lt;/valve&gt;
&lt;/jboss-web&gt;
</pre></div></div></li><li class="step"><p class="title"><strong>Configure the PicketLink Configuration File (<code class="filename">picketlink.xml</code>)</strong></p><div class="para">
				The following is an example of <code class="filename">picketlink.xml</code> configuration for the SP. In this configuration file you provide the URL for the SP and for the IDP, with corresponding handlers for the SP.
			</div><div class="example"><a id="idm139772539032560">
      ⁠</a><p class="title"><strong>Example 13.13. <code class="filename">picketlink.xml</code> Configuration</strong></p><div class="example-contents"><pre class="programlisting">&lt;PicketLink xmlns="urn:picketlink:identity-federation:config:2.1"&gt;
  &lt;PicketLinkSP xmlns="urn:picketlink:identity-federation:config:2.1" ServerEnvironment="tomcat" BindingType="REDIRECT"&gt;
    &lt;IdentityURL&gt;${idp.url::http://localhost:8080/idp/}&lt;/IdentityURL&gt;
    &lt;ServiceURL&gt;${sales-post.url::http://localhost:8080/sales-post/}&lt;/ServiceURL&gt;
  &lt;/PicketLinkSP&gt;
  &lt;Handlers xmlns="urn:picketlink:identity-federation:handler:config:2.1"&gt;
    &lt;Handler class="org.picketlink.identity.federation.web.handlers.saml2.SAML2LogOutHandler" /&gt;
    &lt;Handler class="org.picketlink.identity.federation.web.handlers.saml2.SAML2AuthenticationHandler" /&gt;
    &lt;Handler class="org.picketlink.identity.federation.web.handlers.saml2.RolesGenerationHandler" /&gt;
  &lt;/Handlers&gt;
&lt;/PicketLink&gt;
</pre></div></div><div class="para">
				By default, <code class="filename">picketlink.xml</code> is located in the <code class="filename">WEB-INF</code> directory of your application. However, you can configure a custom path to a <code class="filename">picketlink.xml</code> that is external to the application:
			</div><ol class="substeps a"><li class="step"><p class="title"><strong>Optional: Configuring a custom path to <code class="filename">picketlink.xml</code></strong></p><div class="para">
						Add two paramaters to the valve element in your application's <code class="filename">WEB-INF/jboss-web.xml</code>: <code class="varname">configFile</code> specifying for the path to <code class="filename">picketlink.xml</code>, and <code class="varname">timerInterval</code> which specifies the interval in milliseconds to reload the configuration. For example:
					</div><pre class="programlisting">&lt;valve&gt;
  &lt;class-name&gt;...&lt;/class-name&gt;
    &lt;param&gt;
      &lt;param-name&gt;timerInterval&lt;/param-name&gt;
      &lt;param-value&gt;5000&lt;/param-value&gt;
    &lt;/param&gt;
    &lt;param&gt;
      &lt;param-name&gt;configFile&lt;/param-name&gt;
      &lt;param-value&gt;path-to/picketlink.xml&lt;/param-value&gt;
    &lt;/param&gt;
&lt;/valve&gt;
</pre></li></ol></li><li class="step"><p class="title"><strong>Declare dependencies on PicketLink module (<code class="filename">META-INF/MANIFEST.MF</code>, or <code class="filename">jboss-deployment-structure.xml</code>)</strong></p><div class="para">
				The web application also requires a dependency defining in <code class="filename">META-INF/MANIFEST.MF</code> or <code class="filename">jboss-deployment-structure.xml</code>, so that the PicketLink classes can be located.
			</div><div class="example"><a id="idm139772561223664">
      ⁠</a><p class="title"><strong>Example 13.14. Define Dependency in <code class="filename">META-INF/MANIFEST.MF</code></strong></p><div class="example-contents"><pre class="programlisting">Manifest-Version: 1.0
    Build-Jdk: 1.6.0_24
    Dependencies: org.picketlink</pre></div></div><div class="example"><a id="idm139772550571152">
      ⁠</a><p class="title"><strong>Example 13.15. Define Dependency in <code class="filename">META-INF/jboss-deployment-structure.xml</code></strong></p><div class="example-contents"><pre class="programlisting">&lt;jboss-deployment-structure&gt;  
  &lt;deployment&gt;    
    &lt;dependencies&gt;
      &lt;module name="org.picketlink" /&gt;
    &lt;/dependencies&gt;
  &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;
</pre></div></div></li></ol></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+24286-702263+%5BLatest%5D&amp;comment=Title%3A+Configure+Service+Provider+using+HTTP%2FREDIRECT+Binding%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=24286-702263+22+Aug+2014+00%3A07+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Setup_SAML_v2_based_Web_SSO_using_HTTPPOST_Binding">
      ⁠</a>13.7.5. Setup SAML v2 based Web SSO using HTTP/POST Binding</h2></div></div></div><div class="para">
		HTTP/POST binding is the recommended binding for obtaining the web browser based SSO.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="idm139772563119616">
      ⁠</a><p class="title"><strong>Procedure 13.3. Setup SAML v2 based Web SSO using HTTP/POST Binding</strong></p><ol class="1"><li class="step"><p class="title"><strong>Configure the Identity Provider (IDP).</strong></p><div class="para">
				The steps to configure IDP for HTTP/POST Binding are same as that of the HTTP/Redirect Binding. For more information on configuring the IDP, see <a class="xref" href="chap-Single_Sign-On_with_SAML.html#Setup_SAML_v2_based_Web_SSO_using_HTTPRedirect_Binding">Section 13.7.2, “Setup SAML v2 based Web SSO”</a>
			</div></li><li class="step"><p class="title"><strong>Configure the Service Provider (SP)</strong></p><div class="para">
				The steps to configure SP for HTTP/POST Binding are the same as that of the HTTP/Redirect Binding, except for a single variation in the <code class="filename">picketlink.xml</code> file of the SP. Change <code class="literal">BindingType="REDIRECT"</code> to <code class="literal">BindingType="POST"</code>.
			</div><div class="para">
				For more information on configuring the SP, see <a class="xref" href="chap-Single_Sign-On_with_SAML.html#Configure_Service_Provider">Section 13.7.4, “Configure Service Provider using HTTP/REDIRECT Binding”</a>
			</div></li></ol></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+24287-685991+%5BLatest%5D&amp;comment=Title%3A+Setup+SAML+v2+based+Web+SSO+using+HTTP%2FPOST+Binding%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=24287-685991+18+Jul+2014+06%3A45+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Configure_Dynamic_Account_Chooser_at_a_Service_Provider">
      ⁠</a>13.7.6. Configure Dynamic Account Chooser at a Service Provider</h2></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist prereqs-list"><p class="title"><strong>Prerequisites:</strong></p><ul class="prereqs-list prereqs-list"><li class="listitem"><div class="para">
				<a class="xref" href="chap-Single_Sign-On_with_SAML.html#Configure_Identity_Provider">Section 13.7.3, “Configure Identity Provider”</a>
			</div></li><li class="listitem"><div class="para">
				<a class="xref" href="chap-Single_Sign-On_with_SAML.html#Configure_Service_Provider">Section 13.7.4, “Configure Service Provider using HTTP/REDIRECT Binding”</a>
			</div></li></ul></div><div class="para">
		If a Service Provider (SP) is configured with multiple Identity Providers (IDPs), PicketLink can be configured to prompt the user to choose which IDP to use to authenticate their credentials.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="idm139772558282464">
      ⁠</a><p class="title"><strong>Procedure 13.4. Configure Dynamic Account Chooser at a Service Provider</strong></p><ol class="1"><li class="step"><div class="para">
				Configure the account chooser valve in <code class="filename">jboss-web.xml</code> in the <code class="filename">WEB-INF</code> directory of your SP web application.
			</div><div class="example"><a id="idm139772534527088">
      ⁠</a><p class="title"><strong>Example 13.16. <code class="filename">jboss-web.xml</code> File Configuration for SP Account Chooser</strong></p><div class="example-contents"><pre class="programlisting">&lt;jboss-web&gt;
  &lt;security-domain&gt;sp&lt;/security-domain&gt;
  &lt;context-root&gt;accountchooser&lt;/context-root&gt;
  &lt;valve&gt;
    &lt;class-name&gt;org.picketlink.identity.federation.bindings.tomcat.sp.AccountChooserValve&lt;/class-name&gt;
  &lt;/valve&gt;
  &lt;valve&gt;
    &lt;class-name&gt;org.picketlink.identity.federation.bindings.tomcat.sp.ServiceProviderAuthenticator&lt;/class-name&gt;
  &lt;/valve&gt;
&lt;/jboss-web&gt;
</pre></div></div><div class="para">
				<code class="code">AccountChooserValve</code> has the following configurable options:
			</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"> DomainName </span></dt><dd><div class="para">
							The domain name to be used for the cookie that is sent to the user's browser.
						</div></dd><dt><span class="term"> CookieExpiry </span></dt><dd><div class="para">
							The cookie expiry in seconds. Default is <code class="literal">-1</code>, which means the cookie expires when the browser is closed.
						</div></dd><dt><span class="term"> AccountIDPMapProvider </span></dt><dd><div class="para">
							The fully-qualified name of the implementation for IDP Mapping. Default is a properties file <code class="filename">idpmap.properties</code> in the <code class="filename">WEB-INF</code> directory of your SP web application. This implementation must implement <code class="code">org.picketlink.identity.federation.bindings.tomcat.sp.AbstractAccountChooserValve.AccountIDPMapProvider</code>.
						</div></dd><dt><span class="term"> AccountChooserPage </span></dt><dd><div class="para">
							The name of the HTML/JSP page for listing the different IDP accounts. Default is <code class="filename">/accountChooser.html</code>.
						</div></dd></dl></div></li><li class="step"><div class="para">
				Define the mapping for the IDPs. By default, this is a properties file <code class="filename">idpmap.properties</code> in the <code class="filename">WEB-INF</code> directory of your SP web application.
			</div><div class="example"><a id="idm139772564874496">
      ⁠</a><p class="title"><strong>Example 13.17. <code class="filename">idpmap.properties</code> Configuration</strong></p><div class="example-contents"><pre class="programlisting">DomainA=http://localhost:8080/idp1/
DomainB=http://localhost:8080/idp2/
</pre></div></div></li><li class="step"><div class="para">
				Create a HTML page in your SP web application for the user to choose the IDP. By default, this file is <code class="filename">accountChooser.html</code>. The URL to each of IDP must have the parameter <code class="literal">idp</code> that specifies the name of the IDP listed in <code class="filename">idpmap.properties</code>.
			</div><div class="example"><a id="idm139772488180672">
      ⁠</a><p class="title"><strong>Example 13.18. <code class="filename">accountChooser.html</code> Configuration</strong></p><div class="example-contents"><pre class="programlisting">&lt;html&gt;
  ...
  &lt;a href="?idp=DomainA"&gt;DomainA&lt;/a&gt;
  &lt;hr/&gt;
  &lt;a href="?idp=DomainB"&gt;DomainB&lt;/a&gt;
  ...
&lt;/html&gt;
</pre></div></div></li></ol></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+30888-686108+%5BLatest%5D&amp;comment=Title%3A+Configure+Dynamic+Account+Chooser+at+a+Service+Provider%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=30888-686108+20+Jul+2014+17%3A55+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Configuration_of_IDP-initiated_SSO">
      ⁠</a>13.7.7. Configuration of IDP-initiated SSO</h2></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist prereqs-list"><p class="title"><strong>Prerequisites:</strong></p><ul class="prereqs-list prereqs-list"><li class="listitem"><div class="para">
				<a class="xref" href="chap-Single_Sign-On_with_SAML.html#Configure_Identity_Provider">Section 13.7.3, “Configure Identity Provider”</a>
			</div></li><li class="listitem"><div class="para">
				<a class="xref" href="chap-Single_Sign-On_with_SAML.html#Configure_Service_Provider">Section 13.7.4, “Configure Service Provider using HTTP/REDIRECT Binding”</a>
			</div></li></ul></div><div class="para">
		Usually in PicketLink, the SP starts the flow by sending an authentication request to the IDP, which in turns sends an SAML response to SP with a valid assertion. This flow is called SP-initiated SSO. But the SAML 2.0 specs also defines another flow, called IDP-initiated or Unsolicited Response SSO. In this scenario, the SP does not initiate the authentication flow and receives an SAML response from the IDP. The flow starts on the IDP-side and once authenticated, the user can choose a specific SP from a list and then get redirected to its URL.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><p class="title"><strong>Walkthrough</strong></p><ol><li class="listitem"><div class="para">
				User accesses the IDP.
			</div></li><li class="listitem"><div class="para">
				The IDP seeing that there is neither SAML request nor response, assumes an IDP first scenario using SAML.
			</div></li><li class="listitem"><div class="para">
				The IDP challenges the user to authenticate.
			</div></li><li class="listitem"><div class="para">
				Upon authentication, the IDP shows the hosted section where the user gets a page that links to all the SP applications.
			</div></li><li class="listitem"><div class="para">
				The user chooses an SP application.
			</div></li><li class="listitem"><div class="para">
				The IDP redirects the user to the service provider with an SAML assertion in the query parameter, SAML response.
			</div></li><li class="listitem"><div class="para">
				The SP checks the SAML assertion and provides access.
			</div></li></ol></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Configuration</div>
			No special configuration is necessary to get Unsolicited Responses supported, you can configure your IDP and SPs as usual. For more information about how to configure IDP and SP, refer to:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<a class="xref" href="chap-Single_Sign-On_with_SAML.html#Configure_Identity_Provider">Section 13.7.3, “Configure Identity Provider”</a>
			</div></li><li class="listitem"><div class="para">
				<a class="xref" href="chap-Single_Sign-On_with_SAML.html#Configure_Service_Provider">Section 13.7.4, “Configure Service Provider using HTTP/REDIRECT Binding”</a>
			</div></li></ul></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">How to Use</div>
			Once the user is authenticated, the IDP shows a page with links to all service provider applications. A link will usually look like this:
		</div><div class="para">
		
<pre class="programlisting">&lt;a href="http://localhost:8080/idp?SAML_VERSION=2.0&amp;TARGET=http://localhost:8080/sales-post/"&gt;Sales&lt;/a&gt;
</pre>
		 Note that the link above redirects the user to the IDP passing the TARGET query parameter, whose value is the URL to the target SP application. Once the user clicks the link above, the IDP extracts the TARGET parameter from the request, builds an SAML v2.0 response, and redirects the user to the target URL. When the user hits the SP, it is automatically authenticated.
	</div><div class="para">
		You can use the SAML_VERSION query parameter to specify the SAML version that must be used by the IDP to create the SAML response. SAML_VERSION parameter can have the possible options as 2.0 and 1.1.
	</div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+30882-644068+%5BLatest%5D&amp;comment=Title%3A+Configuration+of+IDP-initiated+SSO%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=30882-644068+26+May+2014+07%3A35+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="SAML_Global_Logout_Profile">
      ⁠</a>13.8. Configure SAML Global Logout Profile</h1></div></div></div><div class="para">
		A Global Logout initiated at one service provider logs out the user from the Identity Provider (IDP) and all the service providers.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			For a Global Logout to function appropriately ensure that you have only up to five Service Providers per Identity Provider.
		</div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="idm139772568374448">
      ⁠</a><p class="title"><strong>Procedure 13.5. Configure Global Logout</strong></p><ol class="1"><li class="step"><p class="title"><strong>Configure picketlink-handlers.xml</strong></p><div class="para">
				Add the <code class="code">SAML2LogOutHandler</code> in the picketlink-handlers.xml.
			</div></li><li class="step"><p class="title"><strong>Configure Service Provider web page</strong></p><div class="para">
				Append <code class="code">GLO=true</code> to the link at the end of your web page of the service provider.
			</div><div class="example"><a id="idm139772505740688">
      ⁠</a><p class="title"><strong>Example 13.19. Link to Global Logout</strong></p><div class="example-contents"><div class="para">
					
<pre class="programlisting">&lt;a href="?GLO=true"&gt;Click to Globally LogOut&lt;/a&gt;
</pre>

				</div></div></div></li><li class="step"><p class="title"><strong>Create a <code class="filename">logout.jsp</code> page</strong></p><div class="para">
				As part of the logout process, PicketLink will redirect the user to a <code class="filename">logout.jsp</code> page located in the root directory of your Service Provider application. Ensure that this page is created.
			</div></li></ol></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+22930%2C+Security+Guide-6.4-1%0ABuild+Date%3A+15-04-2015+13%3A57%3A35%0ATopic+ID%3A+24106-665603+%5BLatest%5D&amp;comment=Title%3A+Configure+SAML+Global+Logout+Profile%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=24106-665603+10+Jun+2014+01%3A26+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div></div></body></html>