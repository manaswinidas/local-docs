<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 5. Configuring a Security Domain to use a Database</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_a_security_domain_to_use_a_database"/>Chapter 5. Configuring a Security Domain to use a Database</h1></div></div></div><p>
			Similar to LDAP, security domains can be configured to use a database for authentication and authorization by using a login module.
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="database_login_module"/>Database Login Module</h1></div></div></div><p>
				The Database login module is a Java Database Connectivity-based (JDBC) login module that supports authentication and role mapping. This login module is used if username, password and role information are stored in a relational database.
			</p><p>
				This works by providing a reference to logical tables containing Principals and Roles in the expected format. For example:
			</p><pre class="programlisting">Table Principals(PrincipalID text, Password text)
Table Roles(PrincipalID text, Role text, RoleGroup text)</pre><p>
				The Principals table associates the user PrincipalID with the valid password and the Roles table associates the user PrincipalID with its role sets. The roles used for user permissions must be contained in rows with a RoleGroup column value of Roles.
			</p><p>
				The tables are logical in that users can specify the SQL query that the login module uses. The only requirement is that the <code class="literal">java.sql.ResultSet</code> has the same logical structure as the Principals and Roles tables described previously. The actual names of the tables and columns are not relevant as the results are accessed based on the column index.
			</p><p>
				To clarify this notion, consider a database with two tables, Principals and Roles, as already declared. The following statements populate the tables with the following data:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						PrincipalID <span class="emphasis"><em>java</em></span> with a Password of <span class="emphasis"><em>echoman</em></span> in the Principals table
					</li><li class="listitem">
						PrincipalID <span class="emphasis"><em>java</em></span> with a role named <span class="emphasis"><em>Echo</em></span> in the <span class="emphasis"><em>RolesRoleGroup</em></span> in the Roles table
					</li><li class="listitem">
						PrincipalID <span class="emphasis"><em>java</em></span> with a role named <span class="emphasis"><em>caller-java</em></span> in the <span class="emphasis"><em>CallerPrincipalRoleGroup</em></span> in the Roles table
					</li></ul></div><div class="table"><a id="idm140421023415344"/><p class="title"><strong>Table 5.1. Complete Database Login Module Options</strong></p><div class="table-contents"><table summary="Complete Database Login Module Options" border="1"><colgroup><col class="col_1"/><col class="col_2"/><col class="col_3"/><col class="col_4"/></colgroup><thead><tr><th style="text-align: left" valign="top">Option</th><th style="text-align: left" valign="top">Type</th><th style="text-align: left" valign="top">Default</th><th style="text-align: left" valign="top">Description</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
								digestCallback
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								A fully-qualified classname
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								none
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								The class name of the DigestCallback implementation that includes pre/post digest content like salts for hashing the input password. Only used if hashAlgorithm has been specified.
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								dsJndiName
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								A JNDI resource
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								java:/DefaultDS
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								The name of the JNDI resource storing the authentication information. This option is required.
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								hashAlgorithm
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								String
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								Use plain passwords
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								The message digest algorithm used to hash passwords. Supported algorithms depend on the Java Security Provider, but the following are supported: MD5, SHA-1, and SHA-256.
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								hashCharset
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								String
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								The platform’s default encoding
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								The name of the charset/encoding to use when converting the password String to a byte array. This includes all supported Java charset names.
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								hashEncoding
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								String
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								Base64
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								The string encoding format to use.
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								ignorePasswordCase
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								boolean
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								false
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								A flag indicating if the password comparison should ignore case.
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								inputValidator
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								A fully-qualified classname
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								none
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								The instance of the InputValidator implementation used to validate the username and password supplied by the client.
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								principalsQuery
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								prepared SQL statement
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								select Password from Principals where PrincipalID=?
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								The prepared SQL query to obtain the information about the principal.
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								rolesQuery
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								prepared SQL statement
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								none
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								The prepared SQL query to obtain the information about the roles. It should be equivalent to select Role, RoleGroup from Roles where PrincipalID=?, where Role is the role name and the RoleGroup column value should always be either Roles with a capital R or CallerPrincipal.
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								storeDigestCallback
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								A fully-qualified classname
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								none
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								The class name of the DigestCallback implementation that includes pre/post digest content like salts for hashing the store/expected password. Only used if hashStorePassword or hashUserPassword is true and hashAlgorithm has been specified.
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								suspendResume
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								boolean
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								true
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								Whether any existing JTA transaction should be suspended during database operations.
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								throwValidatorError
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								boolean
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								false
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								A flag that indicates whether validation errors should be exposed to clients or not
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								transactionManagerJndiName
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								JNDI Resource
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								java:/TransactionManager
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								The JNDI name of the transaction manager used by the login module.
							</p>
							 </td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring_a_security_domain_to_use_the_database_login_module"/>Configuring a Security Domain to use the Database Login Module</h2></div></div></div><p>
					Before configuring a security domain to use the Database login module, a datasource must be properly configured. For more information on creating and configure datasources in JBoss EAP 6 please see the Datasource Management section of the <a class="link" href="https://access.redhat.com/documentation/en-US/JBoss_Enterprise_Application_Platform/6.4/html-single/Administration_and_Configuration_Guide/index.html#chap-Datasource_Management">Red Hat JBoss Enterprise Application Platform 6 Administration and Configuration Guide</a>.
				</p><p>
					Once a datasource has been properly configured, a security domain may be configured to use the Database login module. The below example assumes a datasource named <span class="emphasis"><em>MyDatabaseDS</em></span> has been created and properly configured with a database that is constructed with the following:
				</p><pre class="programlisting">CREATE TABLE Users(username VARCHAR(64) PRIMARY KEY, passwd VARCHAR(64))
CREATE TABLE UserRoles(username VARCHAR(64), role VARCHAR(32))</pre><div class="title"><strong>CLI Commands for Adding the Database Login Module</strong></div><p>
						
</p><pre class="programlisting">/subsystem=security/security-domain=testDB:add</pre><p>

					</p><pre class="programlisting">/subsystem=security/security-domain=testDB/authentication=classic:add</pre><pre class="programlisting">/subsystem=security/security-domain=testDB/authentication=classic/login-module=Database:add( \
  code=Database, \
  flag=required, \
  module-options=[ \
    ("dsJndiName"=&gt;"java:/MyDatabaseDS"), \
    ("principalsQuery"=&gt;"select passwd from Users where username=?"), \
    ("rolesQuery"=&gt;"select role, 'Roles' from UserRoles where username=?") \
  ])</pre><pre class="programlisting">reload</pre><div class="title"><strong>Resulting XML</strong></div><p>
						
</p><pre class="programlisting">&lt;security-domain name="testDB"&gt;
  &lt;authentication&gt;
    &lt;login-module code="Database" flag="required"&gt;
      &lt;module-option name="dsJndiName" value="java:/MyDatabaseDS"/&gt;
      &lt;module-option name="principalsQuery" value="select passwd from Users where username=?"/&gt;
      &lt;module-option name="rolesQuery" value="select role, 'Roles' from UserRoles where username=?"/&gt;
    &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</pre><p>

					</p></div></div></div></body></html>