<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 10. Clustering in Web Applications</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="chap-Clustering_in_Web_Applications">
      ⁠</a>Chapter 10. Clustering in Web Applications</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Session_Replication">
      ⁠</a>10.1. Session Replication</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="About_HTTP_Session_Replication">
      ⁠</a>10.1.1. About HTTP Session Replication</h2></div></div></div><div class="para">
		Session replication ensures that client sessions of distributable applications are not disrupted by failovers of nodes in a cluster. Each node in the cluster shares information about ongoing sessions, and can take them over if the originally-involved node disappears.
	</div><div class="para">
		Session replication is the mechanism by which mod_cluster, mod_jk, mod_proxy, ISAPI, and NSAPI clusters provide high availability.
	</div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+23088%2C+Red+Hat+Development+Guide-6.4%0ABuild+Date%3A+16-11-2017+09%3A13%3A01%0ATopic+ID%3A+4686-734586+%5BLatest%5D&amp;comment=Title%3A+About+HTTP+Session+Replication%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=4686-734586+06+Jan+2015+06%3A13+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="About_the_Web_Session_Cache">
      ⁠</a>10.1.2. About the Web Session Cache</h2></div></div></div><div class="para">
		The web session cache can be configured when you use any of the HA profiles, including the <code class="literal">standalone-ha.xml</code> profile, or the managed domain profiles <code class="literal">ha</code> or <code class="literal">full-ha</code>. The most commonly configured elements are the cache mode and the number of cache owners for a distributed cache. The <code class="literal">owners</code> parameter works only in the <code class="code">DIST</code> mode.
	</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Cache Mode</div>
			The cache mode can either be <code class="code">REPL</code> (the default) or <code class="code">DIST</code>.
		</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">REPL</span></dt><dd><div class="para">
					The <code class="code">REPL</code> mode replicates the entire cache to every other node in the cluster. This is the safest option, but introduces more overhead.
				</div></dd><dt><span class="term">DIST</span></dt><dd><div class="para">
					The <code class="code">DIST</code> mode is similar to the <em class="firstterm">buddy mode</em> provided in previous implementations. It reduces overhead by distributing the cache to the number of nodes specified in the <code class="literal">owners</code> parameter. This number of owners defaults to <code class="literal">2</code>.
				</div></dd></dl></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Owners</div>
			The <code class="literal">owners</code> parameter controls how many cluster nodes hold replicated copies of the session. The default is <code class="literal">2</code>.
		</div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+23088%2C+Red+Hat+Development+Guide-6.4%0ABuild+Date%3A+16-11-2017+09%3A13%3A01%0ATopic+ID%3A+12554-762956+%5BLatest%5D&amp;comment=Title%3A+About+the+Web+Session+Cache%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=12554-762956+25+Jun+2015+04%3A02+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Configure_the_Web_Session_Cache">
      ⁠</a>10.1.3. Configure the Web Session Cache</h2></div></div></div><div class="para">
		The web session cache defaults to <code class="code">REPL</code>. If you wish to use <code class="code">DIST</code> mode, run the following two commands in the Management CLI. If you use a different profile, change the profile name in the commands. If you use a standalone server, remove the <code class="literal">/profile=ha</code> portion of the commands.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="idm140550721019216">
      ⁠</a><p class="title"><strong>Procedure 10.1. Configure the Web Session Cache</strong></p><ol class="1"><li class="step"><p class="title"><strong>Change the default cache mode to <code class="code">DIST</code>.</strong></p><pre class="screen">
/profile=ha/subsystem=infinispan/cache-container=web/:write-attribute(name=default-cache,value=dist)
</pre></li><li class="step"><p class="title"><strong>Set the number of owners for a distributed cache.</strong></p><div class="para">
				The following command sets <code class="literal">5</code> owners. The default is <code class="literal">2</code>.
			</div><pre class="screen">
/profile=ha/subsystem=infinispan/cache-container=web/distributed-cache=dist/:write-attribute(name=owners,value=5)
</pre></li><li class="step"><p class="title"><strong>Change the default cache mode back to <code class="code">REPL</code>.</strong></p><pre class="screen">
/profile=ha/subsystem=infinispan/cache-container=web/:write-attribute(name=default-cache,value=repl)
</pre></li><li class="step"><p class="title"><strong>Restart the Server</strong></p><div class="para">
				After changing the web cache mode, you must restart the server.
			</div></li></ol></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Result</div>
			Your server is configured for session replication. To use session replication in your own applications, refer to the following topic: <a class="xref" href="chap-Clustering_in_Web_Applications.html#Enable_Session_Replication_in_Your_Application">Section 10.1.4, “Enable Session Replication in Your Application”</a>.
		</div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+23088%2C+Red+Hat+Development+Guide-6.4%0ABuild+Date%3A+16-11-2017+09%3A13%3A01%0ATopic+ID%3A+12555-592028+%5BLatest%5D&amp;comment=Title%3A+Configure+the+Web+Session+Cache%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=12555-592028+23+Feb+2014+16%3A56+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Enable_Session_Replication_in_Your_Application">
      ⁠</a>10.1.4. Enable Session Replication in Your Application</h2></div></div></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Summary</div>
			To take advantage of JBoss EAP 6 High Availability (HA) features, you must configure your application to be distributable. This procedure shows how to do that, and then explains some of the advanced configuration options you can use.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="idm140550770171984">
      ⁠</a><p class="title"><strong>Procedure 10.2. Make your Application Distributable</strong></p><ol class="1"><li class="step"><p class="title"><strong>Required: Indicate that your application is distributable.</strong></p><div class="para">
				If your application is not marked as distributable, its sessions will never be distributed. Add the <code class="sgmltag-element">&lt;distributable/&gt;</code> element inside the <code class="sgmltag-element">&lt;web-app&gt;</code> tag of your application's <code class="filename">web.xml</code> descriptor file. Here is an example.
			</div><div class="example"><a id="idm140550774603552">
      ⁠</a><p class="title"><strong>Example 10.1. Minimum Configuration for a Distributable Application</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;web-app</span><span xmlns="" class="perl_Others">  xmlns=</span><span xmlns="" class="perl_String">"http://java.sun.com/xml/ns/j2ee"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">          xmlns:xsi=</span><span xmlns="" class="perl_String">"http://www.w3.org/2001/XMLSchema-instance"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">          xsi:schemaLocation=</span><span xmlns="" class="perl_String">"http://java.sun.com/xml/ns/j2ee </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_String">                              http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">          version=</span><span xmlns="" class="perl_String">"2.4"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>          
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;distributable/&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/web-app&gt;</span>
<span xmlns="" class="line">​</span>
</pre></div></div></li><li class="step"><p class="title"><strong>Modify the default replication behavior if desired.</strong></p><div class="para">
				If you want to change any of the values affecting session replication, you can override them inside a <code class="sgmltag-element">&lt;replication-config&gt;</code> element which is a child element of the <code class="sgmltag-element">&lt;jboss-web&gt;</code> element of your application's <code class="filename">jboss-web.xml</code> file. For a given element, only include it if you want to override the defaults. The following example lists all of the default settings, and is followed by a table which explains the most commonly changed options.
			</div><div class="example"><a id="idm140550813818400">
      ⁠</a><p class="title"><strong>Example 10.2. Example <code class="sgmltag-element">&lt;replication-config&gt;</code>Values</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_DataType">&lt;!DOCTYPE </span>jboss-web PUBLIC
<span xmlns="" class="line">​</span>    "-//JBoss//DTD Web Application 5.0//EN"
<span xmlns="" class="line">​</span>    "http://www.jboss.org/j2ee/dtd/jboss-web_5_0.dtd"<span xmlns="" class="perl_DataType">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss-web&gt;</span>
<span xmlns="" class="line">​</span>   
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;replication-config&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;replication-trigger&gt;</span>SET_AND_NON_PRIMITIVE_GET<span xmlns="" class="perl_Keyword">&lt;/replication-trigger&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;replication-granularity&gt;</span>SESSION<span xmlns="" class="perl_Keyword">&lt;/replication-granularity&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;use-jk&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/use-jk&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;max-unreplicated-interval&gt;</span>30<span xmlns="" class="perl_Keyword">&lt;/max-unreplicated-interval&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;snapshot-mode&gt;</span>INSTANT<span xmlns="" class="perl_Keyword">&lt;/snapshot-mode&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;snapshot-interval&gt;</span>1000<span xmlns="" class="perl_Keyword">&lt;/snapshot-interval&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;session-notification-policy&gt;</span>com.example.CustomSessionNotificationPolicy<span xmlns="" class="perl_Keyword">&lt;/session-notification-policy&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/replication-config&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss-web&gt;</span>
<span xmlns="" class="line">​</span>
</pre></div></div></li></ol></div><div class="table"><a id="idm140550813162368">
      ⁠</a><p class="title"><strong>Table 10.1. Common Options for Session Replication</strong></p><div class="table-contents"><table xmlns:d="http://docbook.org/ns/docbook" class="lt-4-cols lt-7-rows" summary="Common Options for Session Replication"><colgroup><col width="33%"/><col width="67%"/></colgroup><thead><tr><th> <div class="para">
						Option
					</div>
					 </th><th> <div class="para">
						Description
					</div>
					 </th></tr></thead><tbody><tr><td> <div class="para">
						<code class="sgmltag-element">&lt;replication-trigger&gt;</code>
					</div>
					 </td><td> <div class="para">
						Controls which conditions should trigger session data replication across the cluster. This option is necessary because after a mutable object (stored as a session attribute) is accessed from the session, the container has no clear way to know if the object has been modified and needs to be replicated, unless method <code class="code">setAttribute()</code> is called directly.
					</div>
					 <div class="variablelist"><p class="title"><strong>Valid Values for <code class="sgmltag-element">&lt;replication-trigger&gt;</code></strong></p><dl class="variablelist"><dt><span class="term">SET_AND_GET</span></dt><dd><div class="para">
									This is the safest but worst-performing option. Session data is always replicated, even if its content has only been accessed, and not modified. This setting is preserved for legacy purposes only. To get the same behavior with better performance, you may, instead of using this setting, set <code class="sgmltag-element">&lt;max-unreplicated-interval&gt;</code> to 0.
								</div></dd><dt><span class="term">SET_AND_NON_PRIMITIVE_GET</span></dt><dd><div class="para">
									The default value. Session data is only replicated if an object of a non-primitive type is accessed. This means that the object is not of a well-known Java type such as <code class="literal">Integer</code>, <code class="literal">Long</code>, or <code class="literal">String</code>.
								</div></dd><dt><span class="term">SET</span></dt><dd><div class="para">
									This option assumes that the application will explicitly call <code class="methodname"> setAttribute</code> on the session when the data needs to be replicated. It prevents unnecessary replication and can benefit overall performance, but is inherently unsafe.
								</div></dd></dl></div>
					 <div class="para">
						Regardless of the setting, you can always trigger session replication by calling <code class="code">setAttribute()</code>.
					</div>
					 </td></tr><tr><td> <div class="para">
						<code class="sgmltag-element">&lt;replication-granularity&gt;</code>
					</div>
					 </td><td> <div class="para">
						Determines the granularity of data that is replicated. It defaults to <code class="literal">SESSION</code>, but can be set to <code class="literal">ATTRIBUTE</code> instead, to increase performance on sessions where most attributes remain unchanged.
					</div>
					 <div class="variablelist"><p class="title"><strong>Valid values for <code class="sgmltag-element">&lt;replication-granularity&gt;</code></strong></p><dl class="variablelist"><dt><span class="term">ATTRIBUTE</span></dt><dd><div class="para">
									This is only for dirty attributes in the session and for some session data like the last-accessed timestamp.
								</div></dd><dt><span class="term">SESSION</span></dt><dd><div class="para">
									The default value. The entire session object is replicated if any attribute is dirty. The shared object references are maintained on remote nodes since the entire session is serialized in one unit.
								</div></dd></dl></div>
					 <div class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
							<code class="literal">FIELD</code> is not supported in JBoss EAP 6.
						</div></div></div>
					 </td></tr></tbody></table></div></div><div class="para">
		The following options rarely need to be changed.
	</div><div class="table"><a id="idm140550726307744">
      ⁠</a><p class="title"><strong>Table 10.2. Less Commonly Changed Options for Session Replication</strong></p><div class="table-contents"><table xmlns:d="http://docbook.org/ns/docbook" class="lt-4-cols lt-7-rows" summary="Less Commonly Changed Options for Session Replication"><colgroup><col width="33%"/><col width="67%"/></colgroup><thead><tr><th> <div class="para">
						Option
					</div>
					 </th><th> <div class="para">
						Description
					</div>
					 </th></tr></thead><tbody><tr><td> <div class="para">
						<code class="sgmltag-element">&lt;use-jk&gt;</code>
					</div>
					 </td><td> <div class="para">
						Whether to assume that a load balancer such as <code class="code">mod_cluster</code>, <code class="code">mod_jk</code>, or <code class="code">mod_proxy</code> is in use. The default is <code class="literal">false</code>. If set to <code class="literal">true</code>, the container examines the session ID associated with each request and replaces the <code class="code">jvmRoute</code> portion of the session ID if there is a failover.
					</div>
					 </td></tr><tr><td> <div class="para">
						<code class="sgmltag-element">&lt;max-unreplicated-interval&gt;</code>
					</div>
					 </td><td> <div class="para">
						The maximum interval (in seconds) to wait after a session was accessed before triggering a replication of a session's timestamp, even if it is considered to be unchanged. This ensures that cluster nodes are aware of each session's timestamp and that an unreplicated session will not expire incorrectly during a failover. It also ensures that you can rely on a correct value for calls to method <code class="methodname">HttpSession.getLastAccessedTime()</code>during a failover.
					</div>
					 <div class="para">
						By default, no value is specified. A value of <code class="literal">0</code> causes the timestamp to be replicated whenever the session is accessed. A value of <code class="literal">-1</code> causes the timestamp to be replicated only if other activity during the request triggers a replication. A positive value greater than <code class="code">HttpSession.getMaxInactiveInterval()</code> is treated as a misconfiguration and converted to <code class="literal">0</code>.
					</div>
					 </td></tr><tr><td> <div class="para">
						<code class="sgmltag-element">&lt;snapshot-mode&gt;</code>
					</div>
					 </td><td> <div class="para">
						Specifies when sessions are replicated to other nodes. The default is <code class="literal">INSTANT</code> and the other possible value is <code class="literal">INTERVAL</code>.
					</div>
					 <div class="para">
						In <code class="literal">INSTANT</code> mode, changes are replicated at the end of a request, by means of the request processing thread. The <code class="sgmltag-element">&lt;snapshot-interval&gt;</code> option is ignored.
					</div>
					 <div class="para">
						In <code class="literal">INTERVAL</code> mode, a background task runs at the interval specified by <code class="sgmltag-element">&lt;snapshot-interval&gt;</code>, and replicates modified sessions.
					</div>
					 </td></tr><tr><td> <div class="para">
						<code class="sgmltag-element">&lt;snapshot-interval&gt;</code>
					</div>
					 </td><td> <div class="para">
						The interval, in milliseconds, at which modified sessions should be replicated when using <code class="literal">INTERVAL</code> for the value of <code class="sgmltag-element">&lt;snapshot-mode&gt;</code>.
					</div>
					 </td></tr><tr><td> <div class="para">
						<code class="sgmltag-element">&lt;session-notification-policy&gt;</code>
					</div>
					 </td><td> <div class="para">
						The fully-qualified class name of the implementation of interface <code class="code">ClusteredSessionNotificationPolicy</code> which governs whether servlet specification notifications are emitted to any registered <code class="code">HttpSessionListener</code>, <code class="code">HttpSessionAttributeListener</code>, or <code class="code">HttpSessionBindingListener</code>.
					</div>
					 </td></tr></tbody></table></div></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+23088%2C+Red+Hat+Development+Guide-6.4%0ABuild+Date%3A+16-11-2017+09%3A13%3A01%0ATopic+ID%3A+4687-765781+%5BLatest%5D&amp;comment=Title%3A+Enable+Session+Replication+in+Your+Application%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=4687-765781+23+Jul+2015+02%3A10+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-HttpSession_Passivation_and_Activation">
      ⁠</a>10.2. HttpSession Passivation and Activation</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="About_HTTP_Session_Passivation_and_Activation">
      ⁠</a>10.2.1. About HTTP Session Passivation and Activation</h2></div></div></div><div class="para">
		<em class="firstterm">Passivation</em> is the process of controlling memory usage by removing relatively unused sessions from memory while storing them in persistent storage.
	</div><div class="para">
		<em class="firstterm">Activation</em> is when passivated data is retrieved from persisted storage and put back into memory.
	</div><div class="para">
		Passivation occurs at three different times in a HTTP session's lifetime:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				When the container requests the creation of a new session, if the number of currently active session exceeds a configurable limit, the server attempts to passivate some sessions to make room for the new one.
			</div></li><li class="listitem"><div class="para">
				Periodically, at a configured interval, a background task checks to see if sessions should be passivated.
			</div></li><li class="listitem"><div class="para">
				When a web application is deployed and a backup copy of sessions active on other servers is acquired by the newly deploying web application's session manager, sessions may be passivated.
			</div></li></ul></div><div class="para">
		A session is passivated if it meets the following conditions:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				The session has not been in use for longer than a configurable maximum idle time.
			</div></li><li class="listitem"><div class="para">
				The number of active sessions exceeds a configurable maximum and the session has not been in use for longer than a configurable minimum idle time.
			</div></li></ul></div><div class="para">
		Sessions are always passivated using a Least Recently Used (LRU) algorithm.
	</div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+23088%2C+Red+Hat+Development+Guide-6.4%0ABuild+Date%3A+16-11-2017+09%3A13%3A01%0ATopic+ID%3A+4689-591671+%5BLatest%5D&amp;comment=Title%3A+About+HTTP+Session+Passivation+and+Activation%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=4689-591671+23+Feb+2014+16%3A54+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Configure_HttpSession_Passivation_in_Your_Application">
      ⁠</a>10.2.2. Configure HttpSession Passivation in Your Application</h2></div></div></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Overview</div>
			HttpSession passivation is configured in your application's <code class="filename">WEB_INF/jboss-web.xml</code> or <code class="filename">META_INF/jboss-web.xml</code> file.
		</div><div class="example"><a id="idm140550783174256">
      ⁠</a><p class="title"><strong>Example 10.3. <code class="filename">jboss-web.xml</code> File</strong></p><div class="example-contents"><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_DataType">&lt;!DOCTYPE </span>jboss-web PUBLIC
<span xmlns="" class="line">​</span>    "-//JBoss//DTD Web Application 5.0//EN"
<span xmlns="" class="line">​</span>    "http://www.jboss.org/j2ee/dtd/jboss-web_5_0.dtd"<span xmlns="" class="perl_DataType">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss-web</span><span xmlns="" class="perl_Others"> version=</span><span xmlns="" class="perl_String">"6.0"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">           xmlns=</span><span xmlns="" class="perl_String">"http://www.jboss.com/xml/ns/javaee"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">           xmlns:xsi=</span><span xmlns="" class="perl_String">"http://www.w3.org/2001/XMLSchema-instance"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">           xsi:schemaLocation=</span><span xmlns="" class="perl_String">"http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-web_6_0.xsd"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;max-active-sessions&gt;</span>20<span xmlns="" class="perl_Keyword">&lt;/max-active-sessions&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;passivation-config&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;use-session-passivation&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/use-session-passivation&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;passivation-min-idle-time&gt;</span>60<span xmlns="" class="perl_Keyword">&lt;/passivation-min-idle-time&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;passivation-max-idle-time&gt;</span>600<span xmlns="" class="perl_Keyword">&lt;/passivation-max-idle-time&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/passivation-config&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss-web&gt;</span>
</pre></div></div><div class="variablelist"><p class="title"><strong>Passivation Configuration Elements</strong></p><dl class="variablelist"><dt><span class="term"><code class="sgmltag-element">&lt;max-active-sessions&gt;</code></span></dt><dd><div class="para">
					The maximum number of active sessions allowed. If the number of sessions managed by the session manager exceeds this value and passivation is enabled, the excess will be passivated based on the configured <code class="sgmltag-element">&lt;passivation-min-idle-time&gt;</code>. Then, if the number of active sessions still exceeds this limit, attempts to create new sessions will fail. The default value of <code class="literal">-1</code> sets no limit on the maximum number of active sessions.
				</div></dd><dt><span class="term"><code class="sgmltag-element">&lt;passivation-config&gt;</code></span></dt><dd><div class="para">
					This element holds the rest of the passivation configuration parameters, as child elements.
				</div></dd></dl></div><div class="variablelist"><p class="title"><strong><code class="sgmltag-element">&lt;passivation-config&gt;</code> Child Elements</strong></p><dl class="variablelist"><dt><span class="term"><code class="sgmltag-element">&lt;use-session-passivation&gt;</code></span></dt><dd><div class="para">
					Whether or not to use session passivation. The default value is <code class="literal">false</code>.
				</div></dd><dt><span class="term"><code class="sgmltag-element">&lt;passivation-min-idle-time&gt;</code></span></dt><dd><div class="para">
					The minimum time, in seconds, that a session must be inactive before the container will consider passivating it in order to reduce the active session count to conform to value defined by max-active-sessions. The default value of <code class="literal">-1</code> disables passivating sessions before <code class="sgmltag-element">&lt;passivation-max-idle-time&gt;</code> has elapsed. Neither a value of -1 nor a high value are recommended if <code class="sgmltag-element">&lt;max-active-sessions&gt;</code> is set.
				</div></dd><dt><span class="term"><code class="sgmltag-element">&lt;passivation-max-idle-time&gt;</code></span></dt><dd><div class="para">
					The maximum time, in seconds, that a session can be inactive before the container attempts to passivate it to save memory. Passivation of such sessions takes place regardless of whether the active session count exceeds <code class="sgmltag-element">&lt;max-active-sessions&gt;</code>. This value should be less than the <code class="sgmltag-element">&lt;session-timeout&gt;</code> setting in the <code class="filename">web.xml</code>. The default value of <code class="literal">-1</code> disables passivation based on maximum inactivity.
				</div></dd></dl></div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong><code class="code">REPL</code> and <code class="code">DIST</code> Replication Modes</strong></p></div><div class="admonition"><div class="para">
			The total number of sessions in memory includes sessions replicated from other cluster nodes that are not being accessed on this node. Take this into account when setting <code class="sgmltag-element">&lt;max-active-sessions&gt;</code>. The number of sessions replicated from other nodes also depends on whether <code class="code">REPL</code> or <code class="code">DIST</code> cache mode is enabled. In <code class="code">REPL</code> cache mode, each session is replicated to each node. In <code class="code">DIST</code> cache mode, each session is replicated only to the number of nodes specified by the <code class="code">owners</code> parameter. See <a class="xref" href="chap-Clustering_in_Web_Applications.html#About_the_Web_Session_Cache">Section 10.1.2, “About the Web Session Cache”</a> and <a class="xref" href="chap-Clustering_in_Web_Applications.html#Configure_the_Web_Session_Cache">Section 10.1.3, “Configure the Web Session Cache”</a> for information on configuring session cache modes.
		</div><div class="para">
			For example, consider an eight node cluster, where each node handles requests from 100 users. With <code class="code">REPL</code> cache mode, each node would store 800 sessions in memory. With <code class="code">DIST</code> cache mode enabled, and the default <code class="code">owners</code> setting of <code class="literal">2</code>, each node stores 200 sessions in memory.
		</div></div></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+23088%2C+Red+Hat+Development+Guide-6.4%0ABuild+Date%3A+16-11-2017+09%3A13%3A01%0ATopic+ID%3A+4690-759594+%5BLatest%5D&amp;comment=Title%3A+Configure+HttpSession+Passivation+in+Your+Application%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=4690-759594+28+May+2015+02%3A45+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="Implement_an_HA_Singleton">
      ⁠</a>10.3. Implement an HA Singleton</h1></div></div></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Summary</div>
			The following procedure demonstrates how to deploy a service that is wrapped with the SingletonService decorator and used as a cluster-wide singleton service. The service activates a scheduled timer, which is started only once in the cluster.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="idm140550779216224">
      ⁠</a><p class="title"><strong>Procedure 10.3. Implement an HA Singleton Service</strong></p><ol class="1"><li class="step"><div class="para">
				Write the HA singleton service application.
			</div><div class="para">
				The following is a simple example of a <code class="classname">Service</code> that is wrapped with the <code class="classname">SingletonService</code> decorator to be deployed as a singleton service. A complete example can be found in the <code class="literal">cluster-ha-singleton</code> quickstart that ships with Red Hat JBoss Enterprise Application Platform 6. This quickstart contains all the instructions to build and deploy the application.
			</div><ol class="substeps a"><li class="step"><div class="para">
						Create a service.
					</div><div class="para">
						The following listing is an example of a service: 
<pre class="programlisting JAVA"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>package org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">as</span>.<span xmlns="" class="perl_Function">quickstarts</span>.<span xmlns="" class="perl_Function">cluster</span>.<span xmlns="" class="perl_Function">hasingleton</span>.<span xmlns="" class="perl_Function">service</span>.<span xmlns="" class="perl_Function">ejb</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.util.Date;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.util.concurrent.atomic.AtomicBoolean;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.naming.InitialContext;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.naming.NamingException;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.logging.Logger;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.msc.service.Service;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.msc.service.ServiceName;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.msc.service.StartContext;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.msc.service.StartException;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.msc.service.StopContext;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@author &lt;a</span><span xmlns="" class="perl_Others"> href=</span><span xmlns="" class="perl_String">"mailto:wfink@redhat.com"</span><span xmlns="" class="perl_Keyword">&gt;</span><span xmlns="" class="perl_Comment">Wolf-Dieter Fink</span><span xmlns="" class="perl_Keyword">&lt;/a&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> HATimerService <span xmlns="" class="perl_Keyword">implements</span> Service&lt;String&gt; {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> Logger LOGGER = Logger.<span xmlns="" class="perl_Function">getLogger</span>(HATimerService.<span xmlns="" class="perl_Function">class</span>);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> ServiceName SINGLETON_SERVICE_NAME = ServiceName.<span xmlns="" class="perl_Function">JBOSS</span>.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"quickstart"</span>, <span xmlns="" class="perl_String">"ha"</span>, <span xmlns="" class="perl_String">"singleton"</span>, <span xmlns="" class="perl_String">"timer"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * A flag whether the service is started.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">final</span> AtomicBoolean started = <span xmlns="" class="perl_Keyword">new</span> AtomicBoolean(<span xmlns="" class="perl_Keyword">false</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">the name of the server node</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">getValue</span>() <span xmlns="" class="perl_Keyword">throws</span> IllegalStateException, IllegalArgumentException {
<span xmlns="" class="line">​</span>        LOGGER.<span xmlns="" class="perl_Function">infof</span>(<span xmlns="" class="perl_String">"%s is %s at %s"</span>, HATimerService.<span xmlns="" class="perl_Function">class</span>.<span xmlns="" class="perl_Function">getSimpleName</span>(), (started.<span xmlns="" class="perl_Function">get</span>() ? <span xmlns="" class="perl_String">"started"</span> : <span xmlns="" class="perl_String">"not started"</span>), System.<span xmlns="" class="perl_Function">getProperty</span>(<span xmlns="" class="perl_String">"jboss.node.name"</span>));
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_String">""</span>;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">start</span>(StartContext arg0) <span xmlns="" class="perl_Keyword">throws</span> StartException {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> (!started.<span xmlns="" class="perl_Function">compareAndSet</span>(<span xmlns="" class="perl_Keyword">false</span>, <span xmlns="" class="perl_Keyword">true</span>)) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">StartException</span>(<span xmlns="" class="perl_String">"The service is still started!"</span>);
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        LOGGER.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Start HASingleton timer service '"</span> + <span xmlns="" class="perl_Keyword">this</span>.<span xmlns="" class="perl_Function">getClass</span>().<span xmlns="" class="perl_Function">getName</span>() + <span xmlns="" class="perl_String">"'"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_DataType">final</span> String node = System.<span xmlns="" class="perl_Function">getProperty</span>(<span xmlns="" class="perl_String">"jboss.node.name"</span>);
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>            InitialContext ic = <span xmlns="" class="perl_Keyword">new</span> InitialContext();
<span xmlns="" class="line">​</span>            ((Scheduler) ic.<span xmlns="" class="perl_Function">lookup</span>(<span xmlns="" class="perl_String">"global/jboss-cluster-ha-singleton-service/SchedulerBean!org.jboss.as.quickstarts.cluster.hasingleton.service.ejb.Scheduler"</span>)).<span xmlns="" class="perl_Function">initialize</span>(<span xmlns="" class="perl_String">"HASingleton timer @"</span> + node + <span xmlns="" class="perl_String">" "</span> + <span xmlns="" class="perl_Keyword">new</span> Date());
<span xmlns="" class="line">​</span>        } <span xmlns="" class="perl_Keyword">catch</span> (NamingException e) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">StartException</span>(<span xmlns="" class="perl_String">"Could not initialize timer"</span>, e);
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">stop</span>(StopContext arg0) {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> (!started.<span xmlns="" class="perl_Function">compareAndSet</span>(<span xmlns="" class="perl_Keyword">true</span>, <span xmlns="" class="perl_Keyword">false</span>)) {
<span xmlns="" class="line">​</span>            LOGGER.<span xmlns="" class="perl_Function">warn</span>(<span xmlns="" class="perl_String">"The service '"</span> + <span xmlns="" class="perl_Keyword">this</span>.<span xmlns="" class="perl_Function">getClass</span>().<span xmlns="" class="perl_Function">getName</span>() + <span xmlns="" class="perl_String">"' is not active!"</span>);
<span xmlns="" class="line">​</span>        } <span xmlns="" class="perl_Keyword">else</span> {
<span xmlns="" class="line">​</span>            LOGGER.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Stop HASingleton timer service '"</span> + <span xmlns="" class="perl_Keyword">this</span>.<span xmlns="" class="perl_Function">getClass</span>().<span xmlns="" class="perl_Function">getName</span>() + <span xmlns="" class="perl_String">"'"</span>);
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>                InitialContext ic = <span xmlns="" class="perl_Keyword">new</span> InitialContext();
<span xmlns="" class="line">​</span>                ((Scheduler) ic.<span xmlns="" class="perl_Function">lookup</span>(<span xmlns="" class="perl_String">"global/jboss-cluster-ha-singleton-service/SchedulerBean!org.jboss.as.quickstarts.cluster.hasingleton.service.ejb.Scheduler"</span>)).<span xmlns="" class="perl_Function">stop</span>();
<span xmlns="" class="line">​</span>            } <span xmlns="" class="perl_Keyword">catch</span> (NamingException e) {
<span xmlns="" class="line">​</span>                LOGGER.<span xmlns="" class="perl_Function">error</span>(<span xmlns="" class="perl_String">"Could not stop timer"</span>, e);
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
</pre>

					</div></li><li class="step"><div class="para">
						Create an activator that installs the <code class="classname">Service</code> as a clustered singleton.
					</div><div class="para">
						The following listing is an example of a Service activator that installs the <code class="classname">HATimerService</code> as a clustered singleton service: 
<pre class="programlisting JAVA"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>package org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">as</span>.<span xmlns="" class="perl_Function">quickstarts</span>.<span xmlns="" class="perl_Function">cluster</span>.<span xmlns="" class="perl_Function">hasingleton</span>.<span xmlns="" class="perl_Function">service</span>.<span xmlns="" class="perl_Function">ejb</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.as.clustering.singleton.SingletonService;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.logging.Logger;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.msc.service.DelegatingServiceContainer;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.msc.service.ServiceActivator;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.msc.service.ServiceActivatorContext;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.msc.service.ServiceController;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * Service activator that installs the HATimerService as a clustered singleton service</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * during deployment.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@author </span><span xmlns="" class="perl_Comment">Paul Ferraro</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> HATimerServiceActivator <span xmlns="" class="perl_Keyword">implements</span> ServiceActivator {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">final</span> Logger log = Logger.<span xmlns="" class="perl_Function">getLogger</span>(<span xmlns="" class="perl_Keyword">this</span>.<span xmlns="" class="perl_Function">getClass</span>());
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    @Override
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">activate</span>(ServiceActivatorContext context) {
<span xmlns="" class="line">​</span>        log.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"HATimerService will be installed!"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        HATimerService service = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">HATimerService</span>();
<span xmlns="" class="line">​</span>        SingletonService&lt;String&gt; singleton = <span xmlns="" class="perl_Keyword">new</span> SingletonService&lt;String&gt;(service, HATimerService.<span xmlns="" class="perl_Function">SINGLETON_SERVICE_NAME</span>);
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">/*</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         * To pass a chain of election policies to the singleton, for example, </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         * to tell JGroups to prefer running the singleton on a node with a</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         * particular name, uncomment the following line:</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         */</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// singleton.setElectionPolicy(new PreferredSingletonElectionPolicy(new SimpleSingletonElectionPolicy(), new NamePreference("node1/singleton")));</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        singleton.<span xmlns="" class="perl_Function">build</span>(<span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">DelegatingServiceContainer</span>(context.<span xmlns="" class="perl_Function">getServiceTarget</span>(), context.<span xmlns="" class="perl_Function">getServiceRegistry</span>()))
<span xmlns="" class="line">​</span>                .<span xmlns="" class="perl_Function">setInitialMode</span>(ServiceController.<span xmlns="" class="perl_Function">Mode</span>.<span xmlns="" class="perl_Function">ACTIVE</span>)
<span xmlns="" class="line">​</span>                .<span xmlns="" class="perl_Function">install</span>()
<span xmlns="" class="line">​</span>        ;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
</pre>
						 <div class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
								The above code example uses a class, <code class="code">org.jboss.as.clustering.singleton.SingletonService</code>, that is part of the JBoss EAP private API. A public API will become available in the JBoss EAP 7 release and the private class will be deprecated, but these classes will be maintained and available for the duration of the JBoss EAP 6.x release cycle.
							</div></div></div>

					</div></li><li class="step"><div class="para">
						Create a ServiceActivator File
					</div><div class="para">
						Create a file named <code class="filename">org.jboss.msc.service.ServiceActivator</code> in the application's <code class="filename">resources/META-INF/services/</code> directory. Add a line containing the fully qualified name of the ServiceActivator class created in the previous step. 
<pre class="screen"><code class="code">org.jboss.as.quickstarts.cluster.hasingleton.service.ejb.HATimerServiceActivator </code></pre>

					</div></li><li class="step"><div class="para">
						Create a Singleton bean that implements a timer to be used as a cluster-wide singleton timer.
					</div><div class="para">
						This Singleton bean must not have a remote interface and you must not reference its local interface from another EJB in any application. This prevents a lookup by a client or other component and ensures the SingletonService has total control of the Singleton.
					</div><ol class="substeps i"><li class="step"><div class="para">
								Create the Scheduler interface
							</div><div class="para">
								
<pre class="programlisting JAVA"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>package org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">as</span>.<span xmlns="" class="perl_Function">quickstarts</span>.<span xmlns="" class="perl_Function">cluster</span>.<span xmlns="" class="perl_Function">hasingleton</span>.<span xmlns="" class="perl_Function">service</span>.<span xmlns="" class="perl_Function">ejb</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@author &lt;a</span><span xmlns="" class="perl_Others"> href=</span><span xmlns="" class="perl_String">"mailto:wfink@redhat.com"</span><span xmlns="" class="perl_Keyword">&gt;</span><span xmlns="" class="perl_Comment">Wolf-Dieter Fink</span><span xmlns="" class="perl_Keyword">&lt;/a&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> Scheduler {
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> initialize(String info);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">stop</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>}
</pre>

							</div></li><li class="step"><div class="para">
								Create the Singleton bean that implements the cluster-wide singleton timer.
							</div><div class="para">
								
<pre class="programlisting JAVA"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>package org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">as</span>.<span xmlns="" class="perl_Function">quickstarts</span>.<span xmlns="" class="perl_Function">cluster</span>.<span xmlns="" class="perl_Function">hasingleton</span>.<span xmlns="" class="perl_Function">service</span>.<span xmlns="" class="perl_Function">ejb</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.annotation.Resource;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.ejb.ScheduleExpression;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.ejb.Singleton;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.ejb.Timeout;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.ejb.Timer;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.ejb.TimerConfig;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.ejb.TimerService;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.logging.Logger;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * A simple example to demonstrate a implementation of a cluster-wide singleton timer.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@author &lt;a</span><span xmlns="" class="perl_Others"> href=</span><span xmlns="" class="perl_String">"mailto:wfink@redhat.com"</span><span xmlns="" class="perl_Keyword">&gt;</span><span xmlns="" class="perl_Comment">Wolf-Dieter Fink</span><span xmlns="" class="perl_Keyword">&lt;/a&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span>@Singleton
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> SchedulerBean <span xmlns="" class="perl_Keyword">implements</span> Scheduler {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">static</span> Logger LOGGER = Logger.<span xmlns="" class="perl_Function">getLogger</span>(SchedulerBean.<span xmlns="" class="perl_Function">class</span>);
<span xmlns="" class="line">​</span>    @Resource
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> TimerService timerService;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    @Timeout
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">scheduler</span>(Timer timer) {
<span xmlns="" class="line">​</span>        LOGGER.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"HASingletonTimer: Info="</span> + timer.<span xmlns="" class="perl_Function">getInfo</span>());
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    @Override
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> initialize(String info) {
<span xmlns="" class="line">​</span>        ScheduleExpression sexpr = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">ScheduleExpression</span>();
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// set schedule to every 10 seconds for demonstration</span>
<span xmlns="" class="line">​</span>        sexpr.<span xmlns="" class="perl_Function">hour</span>(<span xmlns="" class="perl_String">"*"</span>).<span xmlns="" class="perl_Function">minute</span>(<span xmlns="" class="perl_String">"*"</span>).<span xmlns="" class="perl_Function">second</span>(<span xmlns="" class="perl_String">"0/10"</span>);
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// persistent must be false because the timer is started by the HASingleton service</span>
<span xmlns="" class="line">​</span>        timerService.<span xmlns="" class="perl_Function">createCalendarTimer</span>(sexpr, <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">TimerConfig</span>(info, <span xmlns="" class="perl_Keyword">false</span>));
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    @Override
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">stop</span>() {
<span xmlns="" class="line">​</span>        LOGGER.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Stop all existing HASingleton timers"</span>);
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">for</span> (Timer timer : timerService.<span xmlns="" class="perl_Function">getTimers</span>()) {
<span xmlns="" class="line">​</span>            LOGGER.<span xmlns="" class="perl_Function">trace</span>(<span xmlns="" class="perl_String">"Stop HASingleton timer: "</span> + timer.<span xmlns="" class="perl_Function">getInfo</span>());
<span xmlns="" class="line">​</span>            timer.<span xmlns="" class="perl_Function">cancel</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
</pre>

							</div></li></ol></li></ol></li><li class="step"><div class="para">
				Start each JBoss EAP 6 instance with clustering enabled.
			</div><div class="para">

			</div><div class="para">
				To enable clustering for standalone servers, you must start each server with the <code class="literal">HA</code> profile, using a unique node name and port offset for each instance.
			</div><ul class="stepalternatives">
				<li class="step"><div class="para">
						For Linux, use the following command syntax to start the servers:
					</div><div class="para">
						<pre class="synopsis"><em class="replaceable">EAP_HOME</em>/bin/standalone.sh --server-config=standalone-ha.xml -Djboss.node.name=<em class="replaceable">UNIQUE_NODE_NAME</em> -Djboss.socket.binding.port-offset=<em class="replaceable">PORT_OFFSET</em></pre> <div class="example"><a id="idm140550805496144">
      ⁠</a><p class="title"><strong>Example 10.4. Start multiple standalone servers on Linux</strong></p><div class="example-contents"><pre class="screen"><code class="command">$ <em class="replaceable">EAP_HOME</em>/bin/standalone.sh --server-config=standalone-ha.xml -Djboss.node.name=node1</code>
<code class="command">$ <em class="replaceable">EAP_HOME</em>/bin/standalone.sh --server-config=standalone-ha.xml -Djboss.node.name=node2 -Djboss.socket.binding.port-offset=100</code></pre></div></div>

					</div></li>
				 <li class="step"><div class="para">
						For Microsoft Windows, use the following command syntax to start the servers:
					</div><pre class="synopsis"><em class="replaceable">EAP_HOME</em>\bin\standalone.bat --server-config=standalone-ha.xml -Djboss.node.name=<em class="replaceable">UNIQUE_NODE_NAME</em> -Djboss.socket.binding.port-offset=<em class="replaceable">PORT_OFFSET</em></pre><div class="example"><a id="idm140550778725184">
      ⁠</a><p class="title"><strong>Example 10.5. Start multiple standalone servers on Microsoft Windows</strong></p><div class="example-contents"><pre class="screen"><code class="command">C:&gt; <em class="replaceable">EAP_HOME</em>\bin\standalone.bat --server-config=standalone-ha.xml -Djboss.node.name=node1</code>
<code class="command">C:&gt; <em class="replaceable">EAP_HOME</em>\bin\standalone.bat --server-config=standalone-ha.xml -Djboss.node.name=node2 -Djboss.socket.binding.port-offset=100</code></pre></div></div></li>

			</ul><div class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					If you prefer not to use command line arguments, you can configure the <code class="filename">standalone-ha.xml</code> file for each server instance to bind on a separate interface.
				</div></div></div></li><li class="step"><div class="para">
				Deploy the application to the servers
			</div><div class="para">
				The following Maven command deploys the application to a standalone server running on the default ports.
			</div><div class="para">
				
<pre class="screen"><code class="command">mvn clean install jboss-as:deploy</code></pre>

			</div><div class="para">
				To deploy to additional servers, pass the server name. if it is on a different host, pass the host name and port number on the command line:
			</div><div class="para">
				
<pre class="screen"><code class="command">mvn clean package jboss-as:deploy -Djboss-as.hostname=localhost -Djboss-as.port=10099</code></pre>

			</div><div class="para">
				See the <code class="literal">cluster-ha-singleton</code> quickstart that ships with JBoss EAP 6 for Maven configuration and deployment details.
			</div></li></ol></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+23088%2C+Red+Hat+Development+Guide-6.4%0ABuild+Date%3A+16-11-2017+09%3A13%3A01%0ATopic+ID%3A+9154-766862+%5BLatest%5D&amp;comment=Title%3A+Implement+an+HA+Singleton%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=9154-766862+05+Aug+2015+11%3A21+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Apache_mod_cluster-manager_Application">
      ⁠</a>10.4. Apache mod_cluster-manager Application</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="About_mod_cluster-manager_Application">
      ⁠</a>10.4.1. About mod_cluster-manager Application</h2></div></div></div><div class="para">
		The mod_cluster-manager application is an administration web page which is available on Apache HTTP Server. It is used for monitoring the connected worker nodes and performing various administration tasks like enabling/disabling contexts and configuring the load-balancing properties of worker nodes in a cluster.
	</div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+23088%2C+Red+Hat+Development+Guide-6.4%0ABuild+Date%3A+16-11-2017+09%3A13%3A01%0ATopic+ID%3A+31323-644221+%5BLatest%5D&amp;comment=Title%3A+About+mod_cluster-manager+Application%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=31323-644221+26+May+2014+19%3A18+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Exploring_mod_cluster-manager_Application">
      ⁠</a>10.4.2. Exploring mod_cluster-manager Application</h2></div></div></div><div class="para">
		The mod_cluster-manager application can be used for performing various administration tasks on worker nodes.
	</div><div class="para">
		The figure shown below represents the mod_cluster-manager application web page with annotations to highlight important components and administration options on the page.
	</div><div class="figure"><a id="idm140550743184768">
      ⁠</a><div class="figure-contents"><div class="mediaobject"><img src="images/5242.png" alt="Description"/></div></div><p class="title"><strong>Figure 10.1. mod_cluster Administration Web Page</strong></p></div><div class="para">
		The annotations are explained below:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<span class="guilabel"><strong>[1] mod_cluster/1.2.8.Final</strong></span>: This denotes the version of the mod_cluster native library
			</div></li><li class="listitem"><div class="para">
				<span class="guilabel"><strong>[2] ajp://192.168.122.204:8099</strong></span>: This denotes the protocol used (either one of AJP, HTTP, HTTPS), hostname or IP address of the worker node and the port
			</div></li><li class="listitem"><div class="para">
				<span class="guilabel"><strong>[3] jboss-eap-6.3-2</strong></span>: This denotes the worker node's JVMRoute.
			</div></li><li class="listitem"><div class="para">
				<span class="guilabel"><strong>[4] Virtual Host 1</strong></span>: This denotes the virtual host(s) configured on the worker node
			</div></li><li class="listitem"><div class="para">
				<span class="guibutton"><strong>[5] Disable </strong></span>: This is an administration option which can be used to disable the creation of new sessions on the particular context. However the ongoing sessions do not get disabled and remain intact
			</div></li><li class="listitem"><div class="para">
				<span class="guibutton"><strong>[6] Stop </strong></span>: This is an administration option which can be used to stop the routing of session requests to the context. The remaining sessions will failover to another node unless the property <code class="literal">sticky-session-force</code> is set to "true"
			</div></li><li class="listitem"><div class="para">
				<span class="guibutton"><strong>[7] Enable Contexts Disable Contexts Stop Contexts</strong></span>: These denote operations which can be performed on the whole node. Selecting one of these options affects all the contexts of a node in all its virtual hosts.
			</div></li><li class="listitem"><div class="para">
				<span class="guilabel"><strong>[8] Load balancing group (LBGroup)</strong></span>: The <code class="literal">load-balancing-group</code> property is set in the mod_cluster subsystem in EAP configuration to group all worker nodes into custom load balancing groups. Load balancing group (LBGroup) is an informational field which gives information about all set load balancing groups. If this field is not set, then all worker nodes are grouped into a single default load balancing group 
				<div class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
						This is only an informational field and thus cannot be used to set <code class="literal">load-balancing-group</code> property. The property has to be set in mod_cluster subsystem in EAP configuration.
					</div></div></div>

			</div></li><li class="listitem"><div class="para">
				<span class="guilabel"><strong>[9] Load (value)</strong></span>: This indicates the load factor on the worker node. The load factor(s) are evaluated as below: 
<pre class="programlisting">
<code class="literal">-load &gt; 0 </code> : A load factor with value 1 indicates that the worker node is overloaded. A load factor of 100 denotes a free and not-loaded node.
<code class="literal">-load = 0 </code> :A load factor of value 0 indicates that the worker node is in a standby mode. This means that no session requests will be routed to this node until and unless the other worker nodes are unavailable
<code class="literal">-load = -1</code> : A load factor of value -1 indicates that the worker node is in an error state.
<code class="literal">-load = -2</code> : A load factor of value -2 indicates that the worker node is undergoing CPing/CPong and is in a transition state
</pre>

			</div></li></ul></div><div class="para RoleCreateBugPara">
		<a href="https://bugzilla.redhat.com/enter_bug.cgi?cf_environment=Build+Name%3A+23088%2C+Red+Hat+Development+Guide-6.4%0ABuild+Date%3A+16-11-2017+09%3A13%3A01%0ATopic+ID%3A+31324-661207+%5BLatest%5D&amp;comment=Title%3A+Exploring+mod_cluster-manager+Application%0A%0ADescribe+the+issue%3A%0A%0A%0ASuggestions+for+improvement%3A%0A%0A%0AAdditional+information%3A&amp;cf_build_id=31324-661207+06+Jun+2014+00%3A07+en-US+%5BLatest%5D&amp;product=JBoss+Enterprise+Application+Platform+6&amp;component=Documentation&amp;version=6.4.0">Report a bug</a>
	</div></div></div></div></body></html>