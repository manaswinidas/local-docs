<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 7. Establish monitoring with JBoss Operations Network (JON)</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="sid-19398913">
      ⁠</a>Chapter 7. Establish monitoring with JBoss Operations Network (JON)</h1></div></div></div><div class="para">
		With your business application deployed to a correctly-configured AMI instance, the next step is to establish monitoring of the platform with JBoss Operations Network (JON).
	</div><div class="para">
		The JON server is commonly located inside a corporate network, so it's necessary to establish a secure connection between the server and each of its agents. Establishing a VPN between the two points is the most common solution but this complicates the required networking configuration.
	</div><div class="para">
		This chapter provides network configuration guidelines for enabling communication between the JON agent and JON server. For more extensive information on JBoss Operations Network's configuration, management and usage refer to the Red Hat documentation.
	</div><div class="para">
		<div class="figure"><a id="figure-jon_connectivity_via-vpn">
      ⁠</a><div class="figure-contents"><div class="mediaobject"><img src="images/img-jon_connectivity_via_vpn.png" alt="Network connectivity between JON Server and its agents"/></div></div><p class="title"><strong>Figure 7.1. Network connectivity between JON Server and its agents</strong></p></div>

	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sid-19398913_EstablishmonitoringwithJBossOperationsNetworkJON-ConnectivityRequirements">
      ⁠</a>7.1. Connectivity Requirements</h1></div></div></div><div class="para">
			Registering a JON agent with its servers requires <span class="bold bold"><strong>two-way</strong></span> communication between agent and servers. The JON Agent needs access to port <code class="literal">7080</code> (or <code class="literal">7443</code> in case SSL is used) on <span class="bold bold"><strong>all</strong></span> JON servers, and each JON server must be able to access each of the connected agents on a <span class="bold bold"><strong>unique</strong></span> IP:TCP port pair (agent port is usually <code class="literal">16163</code>).
		</div><div class="para">
			If there are multiple, clustered JON servers, make sure each agent can communicate with <span class="bold bold"><strong>all</strong></span> servers in the JON cluster via the IP/hostname pairs as configured through the JON server administration console. The JON server used by the agent to register may not be the server it tries to use after initialization.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sid-19398913_EstablishmonitoringwithJBossOperationsNetworkJON-NetworkAddressTranslationNAT">
      ⁠</a>7.2. Network Address Translation (NAT)</h1></div></div></div><div class="para">
			A corporate VPN gateway acting in routed mode greatly simplifies network configuration. However, if the corporate VPN gateway is acting in NAT mode, the JON server does not have direct visibility of agents. Port forwarding needs to be configured so that, for <span class="bold bold"><strong>each</strong></span> agent, one port on the gateway is forwarded to the JON agent's address or port on the managed machine. The JON agent also needs to be configured to tell the server the forwarded port number and IP address (see <span class="emphasis"><em>rhq.communications.connector.*</em></span> description in agent-configuration.xml for more information).
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sid-19398913_EstablishmonitoringwithJBossOperationsNetworkJON-DNS">
      ⁠</a>7.3. DNS</h1></div></div></div><div class="para">
			JON servers and JON agents need to be able to resolve each others' hostnames but DNS resolution is complicated in a VPN configuration. Connected servers can use the Amazon EC2 DNS servers, the corporate network's DNS servers or use a split DNS configuration where the corporate DNS servers are used for resolving names in particular domains and the Amazon EC2 DNS servers are used for resolving all other names.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sid-19398913_EstablishmonitoringwithJBossOperationsNetworkJON-RoutinginEC2">
      ⁠</a>7.4. Routing in EC2</h1></div></div></div><div class="para">
			All EC2 servers have, by default, a "source/destination checking" routing feature activated. This feature drops any packets to the server which have a destination different from the machine's IP address. If the VPN solution selected for connecting agents to the JON Server includes a router, this feature needs to be turned off for the server(s) acting as routers/VPN gateways. This configuration setting can be accessed via the Amazon AWS console by right-clicking on the instance. Disabled source/destination checking is also required in a Virtual Private Cloud (VPC).
		</div><div class="para">
			Some VPN configurations, by default, route traffic intended for the Internet through the corporate VPN. Avoid this for EC2 instances because it's generally much slower and less efficient.
		</div><div class="para">
			While the use of a proper addressing schema is not a concern specific to JON, poor schemas can affect it. Amazon EC2 assigns IP addresses from the <code class="uri">10.0.0.0/8</code> network. Instances usually have a public IP address also but only network traffic on the internal IP address within the same availability zone is free. To avoid using the <code class="uri">10.0.0.0/8</code> network in private addressing, there are a few things to consider:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					When creating a VPC, avoid allocating addresses already in use in the private network to avoid connectivity problems;
				</div></li><li class="listitem"><div class="para">
					If an instance needs access to availability zone local resources, make sure EC2 private addresses are used and traffic is <span class="bold bold"><strong>not</strong></span> routed through the VPN;
				</div></li><li class="listitem"><div class="para">
					If an EC2 instance will access a small subset of corporate private network addresses (for example only JON servers), only these addresses should be routed through the VPN for increased security and a lower chance of EC2/private network address space collisions.
				</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sid-19398913_EstablishmonitoringwithJBossOperationsNetworkJON-Terminatingandrestartinginstances">
      ⁠</a>7.5. Terminating and restarting instances</h1></div></div></div><div class="para">
			In a cloud environment it is very easy to terminate a machine instance and, if required, launch a new instance identical to the initial one.
		</div><div class="para">
			There is, however, a potential problem if a new instance tries to register with JON servers using the same agent name as a previously running agent. If this happens the JON server will not allow an agent to reconnect with a missing or non-matching identification token.
		</div><div class="para">
			TO avoid this, ensure that terminated agents are removed from the JON inventory before trying to connect an agent with the same name or specify the correct identification token when starting new agent.
		</div><div class="para">
			Another problem is when an agent machine is assigned a new VPN IP address (i.e. machine is restarted or VPN connection is terminated). Refer to the <em class="citetitle">Configuring JON Servers and Agents Guide</em> document (available at <a href="http://docs.redhat.com/docs/en-US/JBoss_Operations_Network/index.html">http://docs.redhat.com/docs/en-US/JBoss_Operations_Network/index.html</a>) for instructions on how to change the agent's IP address.
		</div><div class="para">
			If this does happen it is best to bind the JON agent's life cycle to the VPN connection's life cycle. When the connection drops, stop the agent. When the connection is up again, update <em class="parameter"><code>JON_AGENT_ADDR</code></em> in <code class="filename">/etc/sysconfig/jon-agent-ec2</code> to reflect the new IP address and restart the agent.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
				If there is a high number of instances launched and/or terminated it can become impractical to add and remove them manually from the JON inventory. JON's scripting capabilities can be used for automate these steps. Refer to the JON documentation for further information.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sid-19398913_EstablishmonitoringwithJBossOperationsNetworkJON-ConfigureEAPandEWSinstancestoregisterwithJON">
      ⁠</a>7.6. Configure EAP and EWS instances to register with JON</h1></div></div></div><div class="para">
			For JBoss Enterprise Application Platform, add this to the User Data field:
		</div><div class="informalexample"><pre class="programlisting">JON_SERVER_ADDR=jon2.it.example.com
## if instance not already configured to resolve its hostname
JON_AGENT_ADDR=`ip addr show dev eth0 primary to 0/0 | sed -n 's#.*inet \([0-9.]\+\)/.*#\1#p'` 
PORTS_ALLOWED=16163
# insert other JON options when necessary, see Appendix I</pre></div><div class="para">
			For JBoss Enterprise Web Server add this to the User Data field:
		</div><div class="informalexample"><pre class="programlisting">cat &gt; /etc/sysconfig/jon-agent-ec2 &lt;&lt; "EOF"
   iptables -D INPUT -p tcp --dport 16163 -j ACCEPT
   iptables -I INPUT -p tcp --dport 16163 -j ACCEPT
   JON_SERVER_ADDR=jon2.it.example.com
   ## if instance not already configured to resolve its hostname
   JON_AGENT_ADDR=`ip addr show dev eth0 primary to 0/0 | sed -n 's#.*inet \([0-9.]\+\)/.*#\1#p'`
   # insert other JON options when necessary, see Appendix I
EOF

## start the agent
service jon-agent-ec2 start</pre></div></div></div></body></html>