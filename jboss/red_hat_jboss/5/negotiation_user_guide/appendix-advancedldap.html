<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Appendix A. Advanced LDAP Login Module: Full LDAP Authentication</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="appendix"><div class="titlepage"><div><div><h1 class="title"><a id="appendix-advancedldap">
      ⁠</a>Appendix A. Advanced LDAP Login Module: Full LDAP Authentication</h1></div></div></div><div class="para">
		The JBoss Negotiation project includes the AdvancedLdapLoginModule to handle the LDAP role searching requirements.
	</div><div class="para">
		The AdvancedLdapLoginModule is based on the LdapExtLoginModule; however, AdvancedLdapLoginModule differs in the following aspects: 
		<div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					The accumulated subject roles do no include the role name of the first matching context.
				</div></li><li class="listitem"><div class="para">
					When the <span class="property">roleAttributeIsDN</span> module property is set to <code class="literal">false</code>, the recursive role search is disabled even if the <span class="property">recurseRoles</span> module option is set to <code class="literal">true</code>.
				</div></li></ul></div>

	</div><div class="para">
		You can use the AdvancedLdapLoginModule module in a chained configuration with the SPNEGOLoginModule to allow a GSSAPI authentication to allow authentication through LDAP (refer to <a class="xref" href="Configuration.html#sect-Role_Mapping">Section 2.4, “Role Mapping”</a> or use the module for a full authentication through LDAP. You can also configure it to skip the user search, the authentication, or the role search if required.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm140585702968544">
      ⁠</a>A.1. Configuration</h1></div></div></div><div class="para">
			The fully qualified classname of the new login module is <code class="code">org.jboss.security.negotiation.AdvancedLdapLoginModule</code>.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="warning"><div class="admonition_header"><p><strong>Class name change</strong></p></div><div class="admonition"><div class="para">
				In Beta releases the class name was <code class="code">org.jboss.security.negotiation.spnego.AdvancedLdapLoginModule</code>. The login module is still available under this name; however, it has been deprecated and will be removed in a future release.
			</div></div></div><div class="para">
			The AdvancedLdapLoginModule supports password-stacking: if you want to use the module in conjunction with other login modules, make sure the <span class="property">password-stacking</span> property is set to <code class="literal">useFirstPass</code>.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140585711472976">
      ⁠</a>A.1.1. Defining Initial LDAP Context</h2></div></div></div><div class="para">
				First, you need to define the user credentials, which are used to obtain the <a href="http://java.sun.com/j2se/1.5.0/docs/api/javax/naming/ldap/InitialLdapContext.html">InitialLdapContext</a> and then used to search for the user and the user roles.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					The login module supports obtaining this InitialLdapContext using a username and credential or using GSSAPI for a previously authenticated user. Here we use the user credentials. For configuration with GSSAPI, refer to <a class="xref" href="Configuration.html#sect-Role_Mapping">Section 2.4, “Role Mapping”</a>.
				</div></div></div><div class="para">
				To authenticate with a username and password the following define the following settings:
			</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"> bindDN</span></dt><dd><div class="para">
							defines the DN used to bind to the LDAP server. This is a DN with read/search permissions to the defined baseCtxDN and rolesCtxDN.
						</div></dd><dt><span class="term">bindCredential</span></dt><dd><div class="para">
							defines the bindDN password. The password can be encrypted if the jaasSecurityDomain is specified.
						</div></dd><dt><span class="term">jaasSecurityDomain</span></dt><dd><div class="para">
							defines the JMX ObjectName of the jaasSecurityDomain. This is the jaasSecurityDomain used to decrypt the java.naming.security.principal. The JaasSecurityDomain#encrypt64(byte[]) method of the domain returns the encrypted form of the password. You can use also org.jboss.security.plugins.PBEUtils to generate the encrypted form.
						</div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140585702680320">
      ⁠</a>A.1.2. Defining DN Search</h2></div></div></div><div class="para">
				After the module has created the LDAP initial context, it takes the provided username and searches for the user DN. To define the properties of the search, provide the following properties:
			</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">baseCtxDN</span></dt><dd><div class="para">
							defines the fixed DN of the context to search for user roles. Consider that this is not the Distinguished Name of where the actual roles are located but the DN of where the objects containing the user roles are located (that is, for active directory, this is the DN with the user account).
						</div></dd><dt><span class="term">baseFilter</span></dt><dd><div class="para">
							defines the search filter used to locate the context of the user to authenticate. The input username/userDN as obtained from the login module callback substitutes the <code class="literal">{0}</code> expression. This substitution behavior comes from the standard DirContext?.search(Name, String, Object[], SearchControls? cons) method. An common example search filter is <code class="code">"(uid={0})</code>
						</div></dd><dt><span class="term">searchTimeLimit</span></dt><dd><div class="para">
							defines the timeout for the user and role searches in milliseconds (defaults to 10000, that is 10 seconds).
						</div></dd></dl></div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					To disable the user DN search omit the <code class="literal">baseCtxDN</code> property: the provided username will be used as the DN in this login module.
				</div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140585704507168">
      ⁠</a>A.1.3. User Authentication</h2></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					If the LDAP login module is not the first login module and a previous login module has already authenticated the user, the user authentication is skipped.
				</div></div></div><div class="para">
				If no previous login module has authenticated the user this step takes the User DN from the User DN search and their provided credential and attempts to create a new InitialLdapContext and verify that the User DN and credential combination is valid.
			</div><div class="para">
				For user authentication, you can define the following property:
			</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">allowEmptyPassword</span></dt><dd><div class="para">
							If empty (length==0) passwords are passed to the LDAP server. An empty password is treated as an anonymous log in by an LDAP servers. Set the property to <code class="literal">false</code> to reject empty passwords or to <code class="literal">true</code> to allow the LDAP server to validate an empty password (the default is <code class="literal">false</code>).
						</div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="LDAP-Defining_Role_Search">
      ⁠</a>A.1.4. Defining Role Search</h2></div></div></div><div class="para">
				The LDAP login module passes the properties to define the search for a particular user and its roles to the LDAP server.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
					The following role search settings are similar to the LdapExtLoginModule settings; however, the recursion now finds the roles listed within a DN.
				</div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">rolesCtxDN</span></dt><dd><div class="para">
							The fixed DN of the context to search for user roles. Consider that this is not the Distinguished Name of where the actual roles are; rather, this is the DN of where the objects containing the user roles are (e.g. for active directory, this is the DN where the user account is)
						</div></dd><dt><span class="term">roleFilter</span></dt><dd><div class="para">
							defines a search filter used to locate the roles associated with the authenticated user. The input username/userDN as obtained from the login module callback substitutes the <code class="code">{0}</code> expression in the filter definition. The authenticated userDN substitutes the <code class="code">{1}</code> in the filter definition. An example search filter that matches the input username is <code class="code">(member={0})</code>. An alternative that matches the authenticated userDN is <code class="code">(member={1})</code>. 
							<div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
									If you omit the roleFilter attribute, the role search will use the UserDN as the DN to obtain the roleAttributeID value.
								</div></div></div>

						</div></dd><dt><span class="term">roleAttributeID</span></dt><dd><div class="para">
							defines the role attribute of the context that corresponds to the name of the role. If the roleAttributeIsDN property is set to <code class="literal">true</code>, this property is the DN of the context to query for the roleNameAttributeID attribute. If the roleAttributeIsDN property is set to <code class="literal">false</code>, this property is the attribute name of the role name.
						</div></dd><dt><span class="term">roleAttributeIsDN</span></dt><dd><div class="para">
							defines if the role attribute contains the fully distinguished name of a role object or the role name. If <code class="literal">false</code>, the role name is taken from the value of the user's role attribute. If <code class="literal">true</code>, the role attribute represents the distinguished name of a role object. The role name is taken from the value of the roleNameAttributeId attribute of the corresponding object. In certain directory schemas (for example, Microsoft Active Directory), role (group)attributes in the user object are stored as DNs to role objects and not as simple names. In such case, set this property to <code class="literal">true</code>. The default value of this property is <code class="literal">false</code>.
						</div></dd><dt><span class="term">roleNameAttributeID</span></dt><dd><div class="para">
							defines the role attribute of the context which corresponds to the name of the role. If the roleAttributeIsDN property is set to <code class="literal">true</code>, this property is used to find the name attribute of the role object. If the roleAttributeIsDN property is set to <code class="literal">false</code>, this property is ignored.
						</div></dd><dt><span class="term">recurseRoles</span></dt><dd><div class="para">
							Enables a recursive role search. The login module tracks already added roles to handle cyclic references.
						</div></dd><dt><span class="term">searchScope</span></dt><dd><div class="para">
							sets the search scope to one of the following (the default value is <code class="literal">SUBTREE_SCOPE</code>): 
							<div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
										OBJECT_SCOPE - searches the named roles context only.
									</div></li><li class="listitem"><div class="para">
										ONELEVEL_SCOPE - searches directly in the named roles context.
									</div></li><li class="listitem"><div class="para">
										SUBTREE_SCOPE - searches only the object if the role context is not a DirContext?. If the roles context is a DirContext?, the subtree rooted at the named object and the named object itself are searched.
									</div></li></ul></div>

						</div></dd><dt><span class="term">searchTimeLimit</span></dt><dd><div class="para">
							defines the timeout for the user and role searches in milliseconds (defaults to 10000, that is 10 seconds). 
							<div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
									Both searches use the same searchTimeLimit setting.
								</div></div></div>

						</div></dd></dl></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm140585685131280">
      ⁠</a>A.2. Examples of Full LDAP Authentication</h1></div></div></div><div class="para">
			The following example configurations show the full LDAP authentication with AdvancedLdapLoginModule for Active Directory and FreeIPA.The configuration differ in the <span class="property">baseFilter</span> attribute as this is the name identified by the SPNEGOLoginModule.
		</div><div class="para">
			The options <span class="property">bindAuthentication</span>, <span class="property">jaasSecurityDomain</span>, and <span class="property">java.naming.provider.url</span> configure how the login module connects to LDAP and how the authentication occurs.
		</div><div class="para">
			The <span class="property">baseCtxDN</span> option is the DN to start the search for the user and the <span class="property">baseFilter</span> attribute in these examples searches for the user using the <code class="literal">sAMAccountName</code> attribute on Active Directory and <code class="literal">uid</code> attribute on FreeIPA.
		</div><div class="para">
			The <span class="property">memberOf</span> attribute is read directly from the user, therefore there is no need to specify the <span class="property">rolesCtxDN</span> or <span class="property">roleFilter</span> property: the attribute defined for the <span class="property">roleAttributeID</span> option is read directly from the user.
		</div><div class="para">
			The <span class="property">roleAttributeIsDN</span> option specifies that this value is a DN so the group object is retrieved and the <span class="property">roleNameAttributeID</span> option specifies that the attribute <code class="literal">cn</code> is read from the group. The login module returns this role.
		</div><div class="para">
			The <span class="property">recurseRoles</span> is set to <code class="literal">true</code> so the DN from the located group is used to repeat the process so if a group is configured with the <code class="literal">memberOf</code> attribute then this is recursively used to locate all the roles.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="AdvLDAP_on_AD">
      ⁠</a>A.2.1. Full LDAP Authentication for Active Directory</h2></div></div></div><div class="para">
				The following is an extract of the dumped ldiff from the example Active Directory domain:
			</div><pre class="programlisting">
dn: CN=Darran Lofthouse,CN=Users,DC=vm104,DC=gsslab,DC=rdu,DC=redhat,DC=com
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: Darran Lofthouse
distinguishedName: 
 CN=Darran Lofthouse,CN=Users,DC=vm104,DC=gsslab,DC=rdu,DC=redhat,DC=com
memberOf: CN=Banker,CN=Users,DC=vm104,DC=gsslab,DC=rdu,DC=redhat,DC=com
name: Darran Lofthouse
sAMAccountName: darranl
userPrincipalName: darranl@vm104.gsslab.rdu.redhat.com

dn: CN=Banker,CN=Users,DC=vm104,DC=gsslab,DC=rdu,DC=redhat,DC=com
objectClass: top
objectClass: group
cn: Banker
member: 
 CN=Darran Lofthouse,CN=Users,DC=vm104,DC=gsslab,DC=rdu,DC=redhat,DC=com
distinguishedName: 
 CN=Banker,CN=Users,DC=vm104,DC=gsslab,DC=rdu,DC=redhat,DC=com
memberOf: CN=Trader,CN=Users,DC=vm104,DC=gsslab,DC=rdu,DC=redhat,DC=com
name: Banker
sAMAccountName: Banker

dn: CN=Trader,CN=Users,DC=vm104,DC=gsslab,DC=rdu,DC=redhat,DC=com
objectClass: top
objectClass: group
cn: Trader
member: CN=Banker,CN=Users,DC=vm104,DC=gsslab,DC=rdu,DC=redhat,DC=com
distinguishedName: 
 CN=Trader,CN=Users,DC=vm104,DC=gsslab,DC=rdu,DC=redhat,DC=com
name: Trader
sAMAccountName: Trader</pre><div class="para">
				The following configuration requires a username and password to be provided for the authentication process:
			</div><pre class="programlisting">
&lt;application-policy name="SPNEGO"&gt;
  &lt;authentication&gt;
    &lt;login-module
      code="org.jboss.security.negotiation.spnego.AdvancedLdapLoginModule"
      flag="required"&gt;
      
      &lt;module-option name="bindAuthentication"&gt;GSSAPI&lt;/module-option&gt;
      &lt;module-option name="jaasSecurityDomain"&gt;host&lt;/module-option&gt;
      &lt;module-option name="java.naming.provider.url"&gt;ldap://VM104:3268&lt;/module-option&gt;
        
      &lt;module-option name="baseCtxDN"&gt;CN=Users,DC=vm104,DC=gsslab,DC=rdu,DC=redhat,DC=com&lt;/module-option&gt;
      &lt;module-option name="baseFilter"&gt;(sAMAccountName={0})&lt;/module-option&gt;        
       
      &lt;module-option name="roleAttributeID"&gt;memberOf&lt;/module-option&gt;
      &lt;module-option name="roleAttributeIsDN"&gt;true&lt;/module-option&gt;
      &lt;module-option name="roleNameAttributeID"&gt;cn&lt;/module-option&gt;
        
      &lt;module-option name="recurseRoles"&gt;true&lt;/module-option&gt;
    &lt;/login-module&gt;        
  &lt;/authentication&gt;
&lt;/application-policy&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="AdvLDAP_on_FreeIPA">
      ⁠</a>A.2.2. Full LDAP Authentication for Free IPA</h2></div></div></div><div class="para">
				The following is an extract of the dumped ldiff from the example FreeIPA domain:
			</div><pre class="programlisting">
dn: uid=darranl,cn=users,cn=accounts,dc=jboss,dc=org
displayName: Darran Lofthouse
uid: darranl
title: Mr
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: inetUser
objectClass: posixAccount
objectClass: krbPrincipalAux
objectClass: radiusprofile
sn: Lofthouse
mail: darran.lofthouse@jboss.com
krbPrincipalName: darranl@JBOSS.ORG
givenName: Darran
cn: Darran Lofthouse
initials: DL
memberOf: cn=banker,cn=groups,cn=accounts,dc=jboss,dc=org
memberOf: cn=Trader,cn=groups,cn=accounts,dc=jboss,dc=org

dn: cn=Banker,cn=groups,cn=accounts,dc=jboss,dc=org
objectClass: top
objectClass: groupofnames
objectClass: posixGroup
objectClass: inetUser
cn: Banker
memberOf: cn=trader,cn=groups,cn=accounts,dc=jboss,dc=org
member: uid=darranl,cn=users,cn=accounts,dc=jboss,dc=org

dn: cn=Trader,cn=groups,cn=accounts,dc=jboss,dc=org
objectClass: top
objectClass: groupofnames
objectClass: posixGroup
objectClass: inetUser
cn: Trader
member: cn=Banker,cn=groups,cn=accounts,dc=jboss,dc=org
</pre><div class="para">
				The following configuration requires a username and password to be provided for the authentication process:
			</div><pre class="programlisting">
&lt;application-policy name="SPNEGO"&gt;
  &lt;authentication&gt;
    &lt;login-module
      code="org.jboss.security.negotiation.spnego.AdvancedLdapLoginModule"
      flag="required"&gt;        
      &lt;module-option name="bindAuthentication"&gt;GSSAPI&lt;/module-option&gt;
      &lt;module-option name="jaasSecurityDomain"&gt;host&lt;/module-option&gt;       
      &lt;module-option name="java.naming.provider.url"&gt;ldap://kerberos.jboss.org:389&lt;/module-option&gt;
        
      &lt;module-option name="baseCtxDN"&gt;cn=users,cn=accounts,dc=jboss,dc=org&lt;/module-option&gt;
      &lt;module-option name="baseFilter"&gt;(uid={0})&lt;/module-option&gt;        
        
      &lt;module-option name="roleAttributeID"&gt;memberOf&lt;/module-option&gt;
      &lt;module-option name="roleAttributeIsDN"&gt;true&lt;/module-option&gt;
      &lt;module-option name="roleNameAttributeID"&gt;cn&lt;/module-option&gt;
        
      &lt;module-option name="recurseRoles"&gt;true&lt;/module-option&gt;
    &lt;/login-module&gt;        
  &lt;/authentication&gt;
&lt;/application-policy&gt;</pre></div></div></div></body></html>