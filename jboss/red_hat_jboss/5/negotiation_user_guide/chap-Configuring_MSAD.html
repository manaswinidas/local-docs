<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 5. Configuring Microsoft Active Directory</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="chap-Configuring_MSAD">
      ⁠</a>Chapter 5. Configuring Microsoft Active Directory</h1></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
			The domain details in this chapter differ from the domain details used in the rest of this guide.
		</div></div></div><div class="para">
		To configure Active Directory to authenticate user through JBoss Negotiation you need to do the following:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				Create a server user account and configure it as a Service Principal Name (SPN) account: the user of the Service Principal Name account (SPN account) acts as a connection between the Kerberos server, the Active Directory and the JBoss web server.
			</div></li><li class="listitem"><div class="para">
				Generate a keytab file for the server user and export it to the application server. The application server uses the keytab to authenticate to KDC in AD.
			</div></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
			Make sure you are using an Active Directory domain controller. It is not possible to use a Windows machine with accounts managed locally.
		</div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="warning"><div class="admonition_header"><p><strong>Warning</strong></p></div><div class="admonition"><div class="para">
			Instructions in this guide apply to Windows 2003 and may differ from the instructions relevant for your Windows operating system.
		</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm140585656528480">
      ⁠</a>5.1. User Account for the Application Server</h1></div></div></div><div class="para">
			To configure an SPN account for the application server on the AD domain controller, you need <span class="application"><strong>Setspn</strong></span> and <span class="application"><strong>Ktpass</strong></span>. The command line utilities are part of Windows Server 2003 Support Tools and serve for mapping the server user name to the application server and its HTTP service.
		</div><div class="para">
			The utilities are available on <a href="http://go.microsoft.com/fwlink/?LinkId=100114">Microsoft web pages</a>.
		</div><div class="para">
			You need to create a regular user account for the server in the AD domain (make sure it is a user account, not a computer account) and map the account to the service account.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140585711439184">
      ⁠</a>5.1.1. Creating Server User</h2></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><div class="para">
					To create a new user for the server, do the following:
				</div><ol class="1"><li class="step"><div class="para">
						Go to <span class="guilabel"><strong>Start</strong></span> → <span class="guimenuitem"><strong>Administrative Tools</strong></span> → <span class="guimenuitem"><strong>Active Directory Users and Computers</strong></span>
					</div></li><li class="step"><div class="para">
						In the <span class="guilabel"><strong>Active Directory Users and Computers</strong></span> window, go to <span class="guimenu"><strong>Action</strong></span> → <span class="guimenuitem"><strong>New</strong></span> → <span class="guisubmenu"><strong>User</strong></span>
					</div><div class="figure"><a id="ad-new-user">
      ⁠</a><div class="figure-contents"><div class="mediaobject"><img src="images/ad-new-user.png" alt="New User"/></div></div><p class="title"><strong>Figure 5.1. New User</strong></p></div></li><li class="step"><div class="para">
						In the <span class="guilabel"><strong>New User</strong></span> window, enter the user details and click <span class="guilabel"><strong>Next</strong></span>. <a class="xref" href="chap-Configuring_MSAD.html#ad-new-user">Figure 5.1, “New User”</a> uses the server <code class="systemitem">@vm104.gsslab.rdu.redhat.com</code> and defines a user called <code class="literal">testserver</code>.
					</div></li><li class="step"><div class="para">
						Enter the password for the user and select the <span class="guilabel"><strong>User cannot change password</strong></span> and <span class="guilabel"><strong>Password never expires</strong></span>.
					</div><div class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
							Make sure you have entered a valid password as changing the password later can invalidate the keytab file and break your JBoss installations.
						</div></div></div><div class="figure"><a id="ad-new-user-password">
      ⁠</a><div class="figure-contents"><div class="mediaobject"><img src="images/ad-new-user-password.png" alt="New User Password"/></div></div><p class="title"><strong>Figure 5.2. New User Password</strong></p></div></li><li class="step"><div class="para">
						Click <span class="guibutton"><strong>Next</strong></span> and <span class="guibutton"><strong>Finish</strong></span>.
					</div><div class="figure"><a id="ad-new-user-finish">
      ⁠</a><div class="figure-contents"><div class="mediaobject"><img src="images/ad-new-user-finish.png" alt="New User Finish"/></div></div><p class="title"><strong>Figure 5.3. New User Finish</strong></p></div></li><li class="step"><div class="para">
						In the <span class="guilabel"><strong>Active Directory Users and Computers</strong></span> window, right-click the user and click <span class="guimenuitem"><strong>Properties</strong></span>.
					</div></li><li class="step"><div class="para">
						In the user properties window, click the <span class="guilabel"><strong>Account</strong></span> tab and make sure the <span class="guilabel"><strong>Do not require Kerberos preauthentication</strong></span> and <span class="guilabel"><strong>Use DES encryption types for this account</strong></span> are selected under <span class="guilabel"><strong>Account Options</strong></span>.
					</div><div class="figure"><a id="ad-user-properties">
      ⁠</a><div class="figure-contents"><div class="mediaobject"><img src="images/ad-user-properties.png" alt="User Properties"/></div></div><p class="title"><strong>Figure 5.4. User Properties</strong></p></div></li></ol></div><div class="para">
				Now you need to create and export the keytab file for the created user.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Exporting_Keytab">
      ⁠</a>5.2. Exporting Keytab</h1></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><div class="para">
				Once you have created the user account for the application server, use the <span class="application"><strong>Ktpass</strong></span> utility to map the SPN account as a trusted host and export the keytab for the server:
			</div><ol class="1"><li class="step"><div class="para">
					Issue the ktpass command to map the created user as a trusted host and generate the keytab file. The <code class="option">-princ</code> option defines the service principal that is being mapped to and the <code class="option">-mapuser</code> option defines the user account being mapped to.
				</div><pre class="synopsis"> <code class="command">ktpass</code> <code class="option">-princ</code> <em class="replaceable">&lt;service principal mapping&gt;</em> <code class="option">-out</code> <em class="replaceable">&lt;target keytab file&gt;</em> <code class="option">-pass</code> <code class="literal">*</code> <code class="option">-mapuser</code> <em class="replaceable">&lt;user mapping&gt;</em> </pre><div class="example"><a id="ex-ktpass">
      ⁠</a><p class="title"><strong>Example 5.1. ktpass command</strong></p><div class="example-contents"><pre class="synopsis"> <code class="command">ktpass</code> <code class="option">-princ</code> <em class="replaceable">host/testserver@kerberos.jboss.org</em> <code class="option">-out</code> <em class="replaceable">C:\testeserver.host.keytab</em> <code class="option">-pass</code> <code class="literal">*</code> <code class="option">-mapuser</code> <em class="replaceable">KERBEROS\testserver</em> </pre></div></div></li><li class="step"><div class="para">
					When prompted, enter the user password.
				</div></li><li class="step"><div class="para">
					Issue the following command to display the available mappings and check if the new mapping is enlisted:
				</div><pre class="synopsis"> <code class="command">setspn.exe</code> <code class="option">-l</code> <em class="replaceable">&lt;user mapping&gt;</em> </pre><div class="example"><a id="ex-setspn">
      ⁠</a><p class="title"><strong>Example 5.2. setspn command</strong></p><div class="example-contents"><pre class="synopsis"> <code class="command">setspn.exe</code> <code class="option">-l</code> <em class="replaceable">testserver</em> </pre></div></div></li></ol></div></div></div></body></html>