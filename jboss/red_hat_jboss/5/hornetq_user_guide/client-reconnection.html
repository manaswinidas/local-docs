<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 32. Client Reconnection and Session Reattachment</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="client-reconnection">
      ⁠</a>Chapter 32. Client Reconnection and Session Reattachment</h1></div></div></div><div class="para">
		HornetQ clients can be configured to automatically reconnect or re-attach to the server if a failure is detected in the server-client connection.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905806723760">
      ⁠</a>32.1. 100% Transparent session re-attachment</h1></div></div></div><div class="para">
			If failure is transient (that is, due to a temporary network failure) and the target server was not restarted, sessions will still exist on the server as long as the <em class="parameter"><code>connection-ttl</code></em> has not expired (see <a class="xref" href="connection-ttl.html">Chapter 15, <em>Detecting Dead Connections</em></a> for details about <em class="parameter"><code>connection-ttl</code></em>).
		</div><div class="para">
			In this case, HornetQ automatically re-attaches the client sessions to the server sessions when the connection reconnects. This is done 100% transparently and the client can continue as before.
		</div><div class="para">
			As HornetQ clients send commands to their servers, they store each sent command in an in-memory buffer. When connection failure occurs and the client re-attaches to its server, the server passes the ID of the last command it successfully received back to the client as part of the re-attachment protocol. If the client had attempted to send any other commands, it can resend those commands from its buffer so that client and server can reconcile their differences.
		</div><div class="para">
			The <code class="varname">ConfirmationWindowSize</code> parameter (typically set in the <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/jms-ra.rar/META-INF/ra.xml</code> file) defines the size of the buffer in bytes. When the server has received <code class="varname">ConfirmationWindowSize</code> bytes of commands and processed them it will send back a command confirmation to the client. The client can then remove confirmed commands from the buffer.
		</div><div class="para">
			Setting <code class="varname">ConfirmationWindowSize</code> to <code class="literal">-1</code> (default) disables buffering and prevents re-attachment from occurring, forcing reconnect instead.
		</div><div class="para">
			If you are using JMS, and the JMS service on the server is being used to load your JMS connection factory instances into JNDI, then uncomment the <code class="varname">ConfirmationWindowSize</code> parameter in the <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/jms-ra.rar/META-INF/ra.xml</code> file. If you are using JMS, but not JNDI, set these values directly on the <code class="classname">HornetQConnectionFactory</code> instance with the appropriate setter method. If you are using Core, you can set these values directly on the <code class="classname">ClientSessionFactory</code> instance with the appropriate setter method.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905846384432">
      ⁠</a>32.2. Session reconnection</h1></div></div></div><div class="para">
			If the server is restarted after crashing or being stopped, sessions will no longer exist on the server and it will not be possible to re-attach completely transparently.
		</div><div class="para">
			In this case, HornetQ automatically reconnects the connection and recreates any sessions and consumers on the server based on the sessions and consumers of the client. (This process is identical to fail-over onto a backup server.) Client reconnection is also used internally by components such as core bridges to let them reconnect to their target servers. See <a class="xref" href="High_Availability_and_Fail_Over.html#ha.automatic.failover">Section 37.2.1, “Automatic Client fail-over”</a> for a full explanation of how transacted and non-transacted sessions are reconnected during fail-over, and the requirements of once-and-only-once delivery guarantees.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905871090048">
      ⁠</a>32.3. Configuring reconnection/reattachment attributes</h1></div></div></div><div class="para">
			If you are using JMS and the JMS Service on the server is being used to load your JMS connection factory instances into JNDI, you can specify these parameters in <code class="filename"><em class="replaceable">JBOSS_DIST</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-jms.xml</code> like so:
		</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;connection-factory</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"NettyConnectionFactory"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;xa&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/xa&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;connectors&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;connector-ref</span><span xmlns="" class="perl_Others"> connector-name=</span><span xmlns="" class="perl_String">"netty"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/connectors&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;entries&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;entry</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"/ConnectionFactory"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;entry</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"/XAConnectionFactory"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/entries&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/connection-factory&gt;</span>
<span xmlns="" class="line">​</span>
</pre><div class="para">
			If you are using JMS, but instantiating your JMS connection factory directly, you can specify the parameters using the appropriate setter methods on the <code class="classname">HornetQConnectionFactory</code> immediately after its creation.
		</div><div class="para">
			If you are using the core API and instantiating the <code class="classname">ClientSessionFactory</code> instance directly, you can also specify the parameters using the appropriate setter methods on the <code class="classname">ClientSessionFactory</code> immediately after its creation.
		</div><div class="para">
			If your client does manage to reconnect but the session is no longer available on the server, for instance if the server has been restarted or it has timed out, then the client will be unable to re-attach, and any <code class="classname">ExceptionListener</code> or <code class="classname">SessionFailureListener</code> instances registered on the connection or session will be called.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>ExceptionListener and SessionFailureListener </strong></p></div><div class="admonition"><div class="para">
				Registered JMS <code class="classname">ExceptionListener</code> or Core <code class="classname">SessionFailureListener</code> instances are called when a client reconnects or re-attaches.
			</div></div></div></div></div></body></html>