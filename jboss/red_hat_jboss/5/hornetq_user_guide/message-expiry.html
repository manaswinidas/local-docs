<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 20. Message Expiry</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="message-expiry">
      ⁠</a>Chapter 20. Message Expiry</h1></div></div></div><div class="para">
		Messages can be set with an optional <span class="emphasis"><em>time to live</em></span> (<em class="parameter"><code>TimeToLive</code></em>) when sending them.
	</div><div class="para">
		HornetQ will not deliver a message to a consumer after its time to live has been exceeded. If the message has not been delivered before the time to live is reached, the server can discard it.
	</div><div class="para">
		HornetQ addresses can be assigned an expiry address so when messages are expired, the addresses are removed from the queue and sent to the expiry address. Many different queues can be bound to an expiry address. These <span class="emphasis"><em>expired</em></span> messages can later be consumed for further inspection.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905850235120">
      ⁠</a>20.1. Message Expiry</h1></div></div></div><div class="para">
			Using HornetQ Core API, you can set an expiration time directly on the message:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// message will expire in 5000ms from now</span>
<span xmlns="" class="line">​</span>message.<span xmlns="" class="perl_Function">setExpiration</span>(System.<span xmlns="" class="perl_Function">currentTimeMillis</span>() + <span xmlns="" class="perl_Float">5000</span>);</pre><div class="para">
			JMS MessageProducer allows you to set a <em class="parameter"><code>TimeToLive</code></em> for the messages it sent:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// messages sent by this producer will be retained for 5s (5000ms) before expiration           </span>
<span xmlns="" class="line">​</span>producer.<span xmlns="" class="perl_Function">setTimeToLive</span>(<span xmlns="" class="perl_Float">5000</span>);</pre><div class="para">
			Expired messages which are consumed from an expiry address have the following properties:
		</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"> <code class="literal">HQ_ORIG_ADDRESS</code> </span></dt><dd><div class="para">
						a String property containing the <span class="emphasis"><em>original address</em></span> of the expired message
					</div></dd><dt><span class="term"> <code class="literal">HQ_ACTUAL_EXPIRY</code> </span></dt><dd><div class="para">
						a Long property containing the <span class="emphasis"><em>actual expiration time</em></span> of the expired message
					</div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="message-expiry.configuring">
      ⁠</a>20.2. Configuring Expiry Addresses</h1></div></div></div><div class="para">
			Expiry addresses are defined in the address-setting configuration:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">&lt;!-- expired messages in exampleQueue will be sent to the expiry address expiryQueue --&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;address-setting</span><span xmlns="" class="perl_Others"> match=</span><span xmlns="" class="perl_String">"jms.queue.exampleQueue"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;expiry-address&gt;</span>jms.queue.expiryQueue<span xmlns="" class="perl_Keyword">&lt;/expiry-address&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/address-setting&gt;</span></pre><div class="para">
			If messages are expired and no expiry address is specified, they are removed from the queue and dropped. Address wildcards can be used to configure expiry address for a set of addresses (see <a class="xref" href="wildcard-syntax.html">Chapter 11, <em>Understanding the HornetQ Wildcard Syntax</em></a>).
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring.expiry.reaper">
      ⁠</a>20.3. Configuring The Expiry Reaper Thread</h1></div></div></div><div class="para">
			A reaper thread will periodically inspect the queues to check if messages have expired.
		</div><div class="para">
			The reaper thread can be configured with the following properties in <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-configuration.xml</code>.
		</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"> <code class="literal">message-expiry-scan-period</code> </span></dt><dd><div class="para">
						How often the queues will be scanned to detect expired messages (in milliseconds, default is 30000ms, set to <code class="literal">-1</code> to disable the reaper thread)
					</div></dd><dt><span class="term"> <code class="literal">message-expiry-thread-priority</code> </span></dt><dd><div class="para">
						The reaper thread priority (it must be between zero and nine; nine being the highest priority. The default is three).
					</div></dd></dl></div></div></div></body></html>