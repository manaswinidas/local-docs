<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 22. Paging</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="paging">
      ⁠</a>Chapter 22. Paging</h1></div></div></div><div class="para">
		HornetQ transparently supports huge queues containing millions of messages while the server is running with limited memory.
	</div><div class="para">
		In such a situation it is not possible to store all of the queues in memory at one time, so HornetQ transparently <span class="emphasis"><em>pages</em></span> messages in and out of memory as they are needed. This allows massive queues with a low memory footprint.
	</div><div class="para">
		HornetQ will start paging messages to disk when the size of all messages in memory for an address exceeds a configured maximum size.
	</div><div class="para">
		By default, HornetQ does not page messages; this must be explicitly configured to activate it.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Page_Files">
      ⁠</a>22.1. Page Files</h1></div></div></div><div class="para">
			Messages are stored per address on the file system. Each address has an individual folder where messages are stored in multiple files (page files). Each file will contain messages up to a max configured size (<em class="parameter"><code>page-size-bytes</code></em>). When reading page-files all messages on the page-file are read, routed, and the file is deleted as soon as the messages are recovered.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="paging.main.config">
      ⁠</a>22.2. Configuration</h1></div></div></div><div class="para">
			You can configure the location of the paging folder
		</div><div class="para">
			Global paging parameters are specified in <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-configuration.xml</code>.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;configuration</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:hornetq"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            xmlns:xsi=</span><span xmlns="" class="perl_String">"http://www.w3.org/2001/XMLSchema-instance"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            xsi:schemaLocation=</span><span xmlns="" class="perl_String">"urn:hornetq /schema/hornetq-configuration.xsd"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            
<span xmlns="" class="line">​</span>            ...
<span xmlns="" class="line">​</span>            
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;paging-directory&gt;</span>${jboss.server.data.dir}/hornetq/paging<span xmlns="" class="perl_Keyword">&lt;/paging-directory&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;page-max-concurrent-io&gt;</span>5<span xmlns="" class="perl_Keyword">&lt;/page-max-concurrent-io&gt;</span>
<span xmlns="" class="line">​</span>            
<span xmlns="" class="line">​</span>            ...</pre><div class="variablelist"><dl class="variablelist"><dt><span class="term"> <code class="literal">paging-directory</code> </span></dt><dd><div class="para">
						This is where page files are stored. HornetQ will create one folder for each address under this configured location. The default for this is data/paging.
					</div></dd><dt><span class="term"> <code class="literal">page-max-concurrent-io</code> </span></dt><dd><div class="para">
						The maximum number of concurrent reads the system can make on the paging files. This may be increased depending on the expected number of paged destinations and the limits on the storage infrastructure.
					</div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="paging.mode">
      ⁠</a>22.3. Paging Mode</h1></div></div></div><div class="para">
			As soon as messages delivered to an address exceed the configured size, that address alone goes into page mode.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				Paging is done individually per address. Configuring a max-size-bytes for an address means each matching address will have a maximum size specified. Please note it <span class="emphasis"><em>does not</em></span> mean that the total overall size of all matching addresses is limited to max-size-bytes.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139905862821696">
      ⁠</a>22.3.1. Configuration</h2></div></div></div><div class="para">
				Configuration is done in the address settings, in <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-configuration.xml</code>.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;address-settings&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;address-setting</span><span xmlns="" class="perl_Others"> match=</span><span xmlns="" class="perl_String">"jms.someaddress"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;max-size-bytes&gt;</span>104857600<span xmlns="" class="perl_Keyword">&lt;/max-size-bytes&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;page-size-bytes&gt;</span>10485760<span xmlns="" class="perl_Keyword">&lt;/page-size-bytes&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;address-full-policy&gt;</span>PAGE<span xmlns="" class="perl_Keyword">&lt;/address-full-policy&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/address-setting&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/address-settings&gt;</span></pre><div class="para">
				This is the list of available parameters on the address settings.
			</div><div class="para">

			</div><div class="table"><a id="idm139905861633824">
      ⁠</a><p class="title"><strong>Table 22.1. Paging Address Settings</strong></p><div class="table-contents"><table xmlns:d="http://docbook.org/ns/docbook" class="lt-4-cols lt-7-rows" summary="Paging Address Settings"><colgroup><col class="c1"/><col class="c2"/><col class="c3"/></colgroup><thead><tr><th> Property Name </th><th> Description </th><th> Default </th></tr></thead><tbody><tr><td> <code class="literal">max-size-bytes</code> </td><td> The max memory the address could have before entering on page mode. </td><td> -1 (disabled) </td></tr><tr><td> <code class="literal">page-size-bytes</code> </td><td> The size of each page file used on the paging system </td><td> 10MiB (10 * 1024 * 1024 bytes) </td></tr><tr><td> <code class="literal">address-full-policy</code> </td><td> This must be set to PAGE for paging to enable. 
							<div class="itemizedlist"><ul><li class="listitem"><div class="para">
										If the value is PAGE then further messages will be paged to disk.
									</div></li><li class="listitem"><div class="para">
										If the value is DROP then further messages will be silently dropped.
									</div></li><li class="listitem"><div class="para">
										If the value is BLOCK then client message producers will block when they try and send further messages.
									</div></li></ul></div>
							 </td><td> PAGE </td></tr><tr><td> page-max-cache-size </td><td> Specifies the number of page files kept in memory to optimize input/output cycles during paging navigation. </td><td> 5 </td></tr></tbody></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905810930352">
      ⁠</a>22.4. Dropping messages</h1></div></div></div><div class="para">
			Instead of paging messages when the max size is reached, an address can also be configured to just drop messages when the address is full.
		</div><div class="para">
			To do this just set the <code class="literal">address-full-policy</code> to <code class="literal">DROP</code> in the address settings
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905810927408">
      ⁠</a>22.5. Blocking producers</h1></div></div></div><div class="para">
			Instead of paging messages when the max size is reached, an address can also be configured to block producers from sending further messages when the address is full. This prevents the memory being exhausted on the server.
		</div><div class="para">
			Producers will automatically unblock and be able to continue sending when memory is freed up on the server.
		</div><div class="para">
			To do this set the <code class="literal">address-full-policy</code> to <code class="literal">BLOCK</code> in the address settings.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
				Blocking is not recommended when using bridges because it is ignored and the message always transferred. In case of a bridge, either configure the destination to use paging instead of blocking, or make sure there is always a consumer at the target destination.
			</div></div></div><div class="para">
			In the default configuration, all addresses are configured to block producers after 10 MB of data are in the address.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905864521440">
      ⁠</a>22.6. Caution with Addresses with Multiple Queues</h1></div></div></div><div class="para">
			When a message is routed to an address that has multiple queues bound to it; for example a JMS subscription, there is only one copy of the message in memory. Each queue only deals with a reference to this. This means that the memory is only freed up once all queues referencing the message have delivered it.
		</div><div class="para">
			For example:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					An address has ten queues
				</div></li><li class="listitem"><div class="para">
					One of the queues does not deliver its messages (maybe because of a slow consumer).
				</div></li><li class="listitem"><div class="para">
					Messages continually arrive at the address and paging is started.
				</div></li><li class="listitem"><div class="para">
					The other nine queues are empty even though messages have been sent.
				</div></li></ul></div><div class="para">
			In this example the process has to wait until the last queue has delivered some of its messages before the process can depage and the other queues finally receive some more messages.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
				Message selectors will only operate on messages in memory. If you have a large amount of messages paged to disk and a selector that only matches some of the paged messages, those messages will not be consumed until the messages in memory have been consumed.
			</div><div class="para">
				HornetQ does not scan through page files on disk to locate matching messages. This is not the primary role of a messaging system. A relational database is recommended for implementations using selectors to select small subsets of messages in very large queues, because this functionality is similar to executing queries over tables in a relational database.
			</div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
				Do not set <em class="parameter"><code>page-size-bytes</code></em> (on the server) to a value lower than <em class="parameter"><code>ack-batch-size</code></em> (in the client) or your system may appear to hang.
			</div><div class="para">
				Messages remain in server memory until they are acknowledged the server, therefore contributing to message sizes on a particular address.
			</div><div class="para">
				If messages are paged to disk for an address, and are being consumed, they will be depaged from disk when enough memory has been freed up in that address after messages have been consumed and acknowledged. However if messages are not acknowledged then more messages will not be depaged since there is no free space in memory. In this case message consumption can appear to hang.
			</div><div class="para">
				If a message is not acknowledged explicitly, it will be acknowledged according to the "ack-batch-size" setting in the client.
			</div></div></div></div></div></body></html>