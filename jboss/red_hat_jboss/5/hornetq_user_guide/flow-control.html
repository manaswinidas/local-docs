<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 17. Flow Control</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="flow-control">
      ⁠</a>Chapter 17. Flow Control</h1></div></div></div><div class="para">
		Flow control is used to limit the flow of data between a client and server, or a server and another server. It does this in order to prevent the client or server being overwhelmed with data.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905855250432">
      ⁠</a>17.1. Consumer Flow Control</h1></div></div></div><div class="para">
			This controls the flow of data between the server and the client as the client consumes messages. For performance reasons clients normally buffer messages before delivering to the consumer via the <code class="literal">receive()</code> method or asynchronously via a message listener. Messages can build up if the consumer cannot process messages as fast as they are being delivered and installed on the internal buffer. This can potentially lead to a lack of memory on the client if they cannot be processed in time.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="flow-control.consumer.window">
      ⁠</a>17.1.1. Window-Based Flow Control</h2></div></div></div><div class="para">
				HornetQ consumers improve performance by buffering a certain number of messages in a client-side buffer before passing them to the client to consume.
			</div><div class="para">
				To prevent a network round trip for every message, HornetQ pre-fetches messages into a buffer on each consumer. The total maximum size of messages (in bytes) that will be buffered on each consumer is determined by the <code class="literal">consumer-window-size</code> parameter.
			</div><div class="para">
				By default, the <code class="literal">consumer-window-size</code> is set to 1 MiB (1024 * 1024 bytes).
			</div><div class="para">
				The value can be:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<code class="literal">-1</code> for an <span class="emphasis"><em>unbound</em></span> buffer
					</div></li><li class="listitem"><div class="para">
						<code class="literal">0</code> to not buffer any messages.
					</div></li><li class="listitem"><div class="para">
						<code class="literal">&gt;0</code> for a buffer with the given maximum size in bytes.
					</div></li></ul></div><div class="para">
				Setting the consumer window size can considerably improve performance depending on the messaging use case. As an example, consider the two extremes:
			</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Fast consumers</span></dt><dd><div class="para">
							Fast consumers can process messages as fast as they consume them.
						</div><div class="para">
							To allow fast consumers, set the <code class="literal">consumer-window-size</code> to -1. This will allow <span class="emphasis"><em>unbound</em></span> message buffering on the client side.
						</div><div class="para">
							Use this setting with caution: it can overflow the client memory if the consumer is not able to process messages as fast as it receives them.
						</div></dd><dt><span class="term">Slow consumers</span></dt><dd><div class="para">
							Slow consumers take significant time to process each message and it is desirable to prevent buffering messages on the client side so that they can be delivered to another consumer instead.
						</div><div class="para">
							Consider a situation where a queue has two consumers; one of which is very slow. Messages are delivered in a circular fashion to both consumers; the fast consumer processes all of its messages very quickly until its buffer is empty. At this point there are still messages waiting to be processed in the buffer of the slow consumer which prevents them being processed by the fast consumer. The fast consumer is therefore sitting idle when it could be processing the other messages.
						</div><div class="para">
							To allow slow consumers, set the <code class="literal">consumer-window-size</code> to 0 (for no buffer at all). This will prevent the slow consumer from buffering any messages on the client side. Messages will remain on the server side ready to be consumed by other consumers.
						</div><div class="para">
							Setting this to 0 can give deterministic distribution between multiple consumers on a queue.
						</div></dd></dl></div><div class="para">
				Most of the consumers cannot be clearly identified as fast or slow consumers but are in-between. In that case, setting the value of <code class="literal">consumer-window-size</code> to optimize performance depends on the messaging use case and requires benchmarks to find the optimal value, but a value of 1MiB is fine in most cases.
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="flow-control.core.api">
      ⁠</a>17.1.1.1. Using Core API</h3></div></div></div><div class="para">
					If HornetQ Core API is used, the consumer window size is specified by <code class="literal">ClientSessionFactory.setConsumerWindowSize()</code> method and some of the <code class="literal">ClientSession.createConsumer()</code> methods.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm139905860513632">
      ⁠</a>17.1.1.2. Using JMS</h3></div></div></div><div class="para">
					If JNDI is used to look up the connection factory, the consumer window size is configured in <code class="filename"><em class="replaceable">JBOSS_DIST</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-jms.xml</code>:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;connection-factory</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"ConnectionFactory"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;connectors&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;connector-ref</span><span xmlns="" class="perl_Others"> connector-name=</span><span xmlns="" class="perl_String">"netty-connector"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/connectors&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;entries&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;entry</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"/ConnectionFactory"</span><span xmlns="" class="perl_Keyword">/&gt;</span>       
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/entries&gt;</span>
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Comment">&lt;!-- Set the consumer window size to 0 to have *no* buffer on the client side --&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;consumer-window-size&gt;</span>0<span xmlns="" class="perl_Keyword">&lt;/consumer-window-size&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/connection-factory&gt;</span></pre><div class="para">
					If the connection factory is directly instantiated, the consumer window size is specified by <code class="literal">HornetQConnectionFactory.setConsumerWindowSize()</code> method.
				</div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139905847779296">
      ⁠</a>17.1.2. Rate limited flow control</h2></div></div></div><div class="para">
				It is also possible to control the <span class="emphasis"><em>rate</em></span> at which a consumer can consume messages. This can be used to make sure that a consumer never consumes messages at a rate faster than the rate specified.
			</div><div class="para">
				The rate must be a positive integer to enable this functionality and is the maximum desired message consumption rate specified in units of messages per second. Setting this to <code class="literal">-1</code> disables rate limited flow control. The default value is <code class="literal">-1</code>.
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="flow-control.rate.core.api">
      ⁠</a>17.1.2.1. Using Core API</h3></div></div></div><div class="para">
					If the HornetQ core API is being used, the rate can be set via the <code class="literal">ClientSessionFactory.setConsumerMaxRate(int consumerMaxRate)</code> method or alternatively via some of the <code class="literal">ClientSession.createConsumer()</code> methods.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm139905860617648">
      ⁠</a>17.1.2.2. Using JMS</h3></div></div></div><div class="para">
					If JNDI is used to look up the connection factory, the max rate can be configured in <code class="filename"><em class="replaceable">JBOSS_DIST</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-jms.xml</code>:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;connection-factory</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"NettyConnectionFactory"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;connectors&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;connector-ref</span><span xmlns="" class="perl_Others"> connector-name=</span><span xmlns="" class="perl_String">"netty-connector"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/connectors&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;entries&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;entry</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"/ConnectionFactory"</span><span xmlns="" class="perl_Keyword">/&gt;</span>       
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/entries&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">&lt;!-- We limit consumers created on this connection factory to consume messages at a maximum rate of 10 messages per sec --&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;consumer-max-rate&gt;</span>10<span xmlns="" class="perl_Keyword">&lt;/consumer-max-rate&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/connection-factory&gt;</span></pre><div class="para">
					If the connection factory is directly instantiated, the max rate size can be set via the <code class="literal">HornetQConnectionFactory.setConsumerMaxRate(int consumerMaxRate)</code> method.
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
						Rate limited flow control can be used in conjunction with window based flow control. Rate limited flow control only effects how many messages a client can consume in a second and not how many messages are in its buffer. If you had a slow rate limit and a high window based limit the internal buffer in the client would soon fill up with messages.
					</div></div></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905842323696">
      ⁠</a>17.2. Producer flow control</h1></div></div></div><div class="para">
			HornetQ also can limit the amount of data sent from a client to a server to prevent the server being overwhelmed.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139905842322304">
      ⁠</a>17.2.1. Window based flow control</h2></div></div></div><div class="para">
				In a similar way to consumer window based flow control, HornetQ producers, by default, can only send messages to an address as long as they have sufficient credits to do so. The amount of credits required to send a message is given by the size of the message.
			</div><div class="para">
				As producers run low on credits they request more from the server. When the server sends them more credits they can send more messages.
			</div><div class="para">
				The amount of credits a producer requests in one go is known as the <span class="italic italic">window size</span>.
			</div><div class="para">
				The window size therefore determines the amount of bytes that can be in-flight at any one time before more need to be requested; this prevents the remoting connection from getting overloaded.
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm139905853431504">
      ⁠</a>17.2.1.1. Using Core API</h3></div></div></div><div class="para">
					If the HornetQ core API is being used, window size can be set via the <code class="literal">ClientSessionFactory.setProducerWindowSize(int producerWindowSize)</code> method.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm139905867148960">
      ⁠</a>17.2.1.2. Using JMS</h3></div></div></div><div class="para">
					If JNDI is used to look up the connection factory, the producer window size can be configured in <code class="filename"><em class="replaceable">JBOSS_DIST</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-jms.xml</code>:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;connection-factory</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"NettyConnectionFactory"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;connectors&gt;</span>
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">&lt;connector-ref</span><span xmlns="" class="perl_Others"> connector-name=</span><span xmlns="" class="perl_String">"netty-connector"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/connectors&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;entries&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;entry</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"/ConnectionFactory"</span><span xmlns="" class="perl_Keyword">/&gt;</span>       
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/entries&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;producer-window-size&gt;</span>10<span xmlns="" class="perl_Keyword">&lt;/producer-window-size&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/connection-factory&gt;</span></pre><div class="para">
					If the connection factory is directly instantiated, the producer window size can be set via the <code class="literal">HornetQConnectionFactory.setProducerWindowSize(int producerWindowSize)</code> method.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm139905867144464">
      ⁠</a>17.2.1.3. Blocking producer window based flow control</h3></div></div></div><div class="para">
					Normally the server will always give the same number of credits as has been requested. However, it is also possible to set a maximum size on any address. This then blocks how many credits can be sent to the address so that its memory cannot be exceeded.
				</div><div class="para">
					For example, if there is a JMS queue called "myqueue", the maximum memory size could be set to 10 MB, and the server will control the number of credits sent to any producers which are sending any messages to myqueue. This means that the total messages in the queue never exceeds 10 MB.
				</div><div class="para">
					When the address gets full, producers will block on the client side until more space frees up on the address; that is, until messages are consumed from the queue thus freeing up space for more messages to be sent. This is called blocking producer flow control.
				</div><div class="para">
					To configure an address with a maximum size and tell the server that you want to block producers for this address if it becomes full, you need to define an AddressSettings (<a class="xref" href="queue-attributes.html#Configuring_Queues_Through_Address_Settings">Section 23.3, “Configuring Queues Through Address Settings”</a>) block for the address and specify <code class="literal">max-size-bytes</code> and <code class="literal">address-full-policy</code>
				</div><div class="para">
					The address block applies to all queues registered to that address. That is, the total memory for all queues bound to that address will not exceed <em class="parameter"><code>max-size-bytes</code></em>. In the case of JMS topics this means the <span class="italic italic">total</span> memory of all subscriptions in the topic will not exceed <em class="parameter"><code>max-size-bytes</code></em>.
				</div><div class="para">
					Here is an example:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;address-settings&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;address-setting</span><span xmlns="" class="perl_Others"> match=</span><span xmlns="" class="perl_String">"jms.queue.exampleQueue"</span><span xmlns="" class="perl_Keyword">&gt;</span>            
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;max-size-bytes&gt;</span>100000<span xmlns="" class="perl_Keyword">&lt;/max-size-bytes&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;address-full-policy&gt;</span>PAGE<span xmlns="" class="perl_Keyword">&lt;/address-full-policy&gt;</span>   
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/address-setting&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/address-settings&gt;</span></pre><div class="para">
					The above example would set the max size of the JMS queue "exampleQueue" to be 100,000 bytes and would block any producers sending to that address to prevent that max size being exceeded.
				</div><div class="para">
					Note the policy must be set to <code class="literal">BLOCK</code> to enable blocking producer flow control.
				</div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139905842291536">
      ⁠</a>17.2.2. Rate limited flow control</h2></div></div></div><div class="para">
				The rate a producer can emit messages can be limited, in units of messages per second. This means that the producer will never produce messages at a rate higher than what has been set.
			</div><div class="para">
				The rate must be a positive integer to enable this functionality and is the maximum desired message consumption rate specified in units of messages per second. Setting this to <code class="literal">-1</code> disables rate limited flow control. The default value is <code class="literal">-1</code>.
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="flow-control.producer.rate.core.api">
      ⁠</a>17.2.2.1. Using Core API</h3></div></div></div><div class="para">
					If the HornetQ core API is being used, the rate can be set via the <code class="literal">ClientSessionFactory.setProducerMaxRate(int consumerMaxRate)</code> method or alternatively via some of the <code class="literal">ClientSession.createProducer()</code> methods.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm139905843668032">
      ⁠</a>17.2.2.2. Using JMS</h3></div></div></div><div class="para">
					If JNDI is used to look up the ConnectionFactory, the max rate can be configured in <code class="filename"><em class="replaceable">JBOSS_DIST</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-jms.xml</code>:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;connection-factory</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"NettyConnectionFactory"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;connectors&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;connector-ref</span><span xmlns="" class="perl_Others"> connector-name=</span><span xmlns="" class="perl_String">"netty-connector"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/connectors&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;entries&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;entry</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"ConnectionFactory"</span><span xmlns="" class="perl_Keyword">/&gt;</span>       
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/entries&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">&lt;!-- We limit producers created on this connection factory to produce messages at a maximum rate of 10 messages per sec --&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;producer-max-rate&gt;</span>10<span xmlns="" class="perl_Keyword">&lt;/producer-max-rate&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/connection-factory&gt;</span></pre><div class="para">
					If the connection factory is directly instantiated, the max rate size can be set via the <code class="literal">HornetQConnectionFactory.setProducerMaxRate(int consumerMaxRate)</code> method.
				</div></div></div></div></div></body></html>