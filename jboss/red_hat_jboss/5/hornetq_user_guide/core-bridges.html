<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 34. Core Bridges</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="core-bridges">
      ⁠</a>Chapter 34. Core Bridges</h1></div></div></div><div class="para">
		The function of a bridge is to consume messages from a source queue, and forward them to a target address, typically on a different HornetQ server.
	</div><div class="para">
		The source and target servers do not have to be in the same cluster which makes bridging suitable for reliably sending messages from one cluster to another, for instance across a WAN, or Internet and where the connection may be unreliable.
	</div><div class="para">
		The bridge has built in resilience to failure so if the target server connection is lost due to network failure, the bridge will retry connecting to the target until it comes back on line. When it comes back on line it will resume operation as normal.
	</div><div class="para">
		In summary, bridges are a way to reliably connect two separate HornetQ servers together. With a core bridge both source and target servers must be HornetQ servers.
	</div><div class="para">
		Bridges can be configured to provide <span class="emphasis"><em>once and only once</em></span> delivery guarantees even in the event of the failure of the source or the target server. They do this by using duplicate detection (described in <a class="xref" href="duplicate-detection.html">Chapter 35, <em>Duplicate Message Detection</em></a>).
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			Although they have similar function, do not confuse core bridges with JMS bridges!
		</div><div class="para">
			Core bridges are for linking a HornetQ node with another HornetQ node and do not use the JMS API. A JMS Bridge is used for linking any two JMS 1.1 compliant JMS providers. So, a JMS Bridge could be used for bridging to or from different JMS compliant messaging system. it is always preferable to use a core bridge where possible. Core bridges use duplicate detection to provide <span class="emphasis"><em>once and only once</em></span> guarantees. To provide the same guarantee using a JMS bridge, an XA which has a higher overhead and is more complex to configure would need to be used.
		</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905867038832">
      ⁠</a>34.1. Configuring Bridges</h1></div></div></div><div class="para">
			Bridges are configured in <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-configuration.xml</code>. An example follows (this is actually from the bridge example):
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;bridge</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"my-bridge"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;queue-name&gt;</span>jms.queue.sausage-factory<span xmlns="" class="perl_Keyword">&lt;/queue-name&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;forwarding-address&gt;</span>jms.queue.mincing-machine<span xmlns="" class="perl_Keyword">&lt;/forwarding-address&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;filter</span><span xmlns="" class="perl_Others"> string=</span><span xmlns="" class="perl_String">"name='aardvark'"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;transformer-class-name&gt;</span>
<span xmlns="" class="line">​</span>        org.hornetq.jms.example.HatColourChangeTransformer
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/transformer-class-name&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;retry-interval&gt;</span>1000<span xmlns="" class="perl_Keyword">&lt;/retry-interval&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;retry-interval-multiplier&gt;</span>1.0<span xmlns="" class="perl_Keyword">&lt;/retry-interval-multiplier&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;reconnect-attempts&gt;</span>-1<span xmlns="" class="perl_Keyword">&lt;/reconnect-attempts&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;failover-on-server-shutdown&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/failover-on-server-shutdown&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;use-duplicate-detection&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/use-duplicate-detection&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;confirmation-window-size&gt;</span>10000000<span xmlns="" class="perl_Keyword">&lt;/confirmation-window-size&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;connector-ref</span><span xmlns="" class="perl_Others"> connector-name=</span><span xmlns="" class="perl_String">"remote-connector"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">        backup-connector-name=</span><span xmlns="" class="perl_String">"backup-remote-connector"</span><span xmlns="" class="perl_Keyword">/&gt;</span>     
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;user&gt;</span>foouser<span xmlns="" class="perl_Keyword">&lt;/user&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;password&gt;</span>foopassword<span xmlns="" class="perl_Keyword">&lt;/password&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/bridge&gt;</span>
</pre><div class="para">
			In the above example we have shown all the parameters its possible to configure for a bridge. In practice, many of the defaults may be used, therefore it will not be necessary to specify them all explicitly.
		</div><div class="para">
			The parameters are described in the following list.
		</div><div class="variablelist"><p class="title"><strong>Core Bridge Parameters</strong></p><dl class="variablelist"><dt><span class="term"> <code class="varname">name</code> </span></dt><dd><div class="para">
						All bridges must have a unique name in the server.
					</div></dd><dt><span class="term"> <code class="varname">queue-name</code> </span></dt><dd><div class="para">
						This is the unique name of the local queue that the bridge consumes from, it is a mandatory parameter.
					</div><div class="para">
						The queue must already exist by the time the bridge is instantiated at start-up.
					</div></dd></dl></div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				If using JMS then normally the JMS configuration (<code class="filename"><em class="replaceable">JBOSS_DIST</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-jms.xml</code>) is loaded after the core configuration file <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-configuration.xml</code> is loaded. If the bridge is consuming from a JMS queue then ensure that the JMS queue is also deployed as a core queue in the core configuration. Refer to the bridge example for an example of this.
			</div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"> <code class="varname">forwarding-address</code> </span></dt><dd><div class="para">
						This is the address on the target server that the message will be forwarded to. If a forwarding address is not specified, then the original address of the message will be retained.
					</div></dd><dt><span class="term"> <code class="varname">filter-string</code> </span></dt><dd><div class="para">
						An optional filter string can be supplied. If specified, only messages which match the filter expression specified in the filter string will be forwarded. The filter string follows the HornetQ filter expression syntax described in <a class="xref" href="filter-expressions.html">Chapter 12, <em>Filter Expressions</em></a>.
					</div></dd><dt><span class="term"> <code class="varname">transformer-class-name</code> </span></dt><dd><div class="para">
						An optional transformer-class-name can be specified. This is the name of a user-defined class which implements the <code class="varname">org.hornetq.core.server.cluster.Transformer</code> interface.
					</div><div class="para">
						If this is specified then the transformer's <code class="varname">transform()</code> method will be invoked with the message before it is forwarded. This allows the opportunity to transform the message header or body before forwarding
					</div></dd><dt><span class="term"> <code class="varname">retry-interval</code> </span></dt><dd><div class="para">
						This optional parameter determines the period in milliseconds between subsequent reconnection attempts, if the connection to the target server has failed. The default value is <code class="literal">2000</code> milliseconds.
					</div></dd><dt><span class="term"> <code class="varname">retry-interval-multiplier</code> </span></dt><dd><div class="para">
						This optional parameter determines a multiplier to apply to the time since the last retry in order to compute the time to the next retry.
					</div><div class="para">
						This allows an <span class="emphasis"><em>exponential backoff</em></span> between retry attempts to be implemented.
					</div><div class="para">
						For example:
					</div><div class="para">
						If <code class="varname">retry-interval</code> is set to <code class="literal">1000</code> ms and <code class="varname">retry-interval-multiplier</code> is set to <code class="literal">2.0</code>, then, if the first reconnect attempt fails, there will be a wait of <code class="literal">1000</code> ms, then <code class="literal">2000</code> ms and then <code class="literal">4000</code> ms between subsequent reconnection attempts.
					</div><div class="para">
						The default value is <code class="literal">1.0</code> meaning each reconnect attempt is spaced at equal intervals.
					</div></dd><dt><span class="term"> <code class="varname">reconnect-attempts</code> </span></dt><dd><div class="para">
						This optional parameter determines the total number of reconnect attempts the bridge will make before giving up and shutting down. A value of <code class="literal">-1</code> signifies an unlimited number of attempts. The default value is <code class="literal">-1</code>.
					</div></dd><dt><span class="term"> <code class="varname">failover-on-server-shutdown</code> </span></dt><dd><div class="para">
						This optional parameter determines whether the bridge will attempt to fail-over onto a backup server (if specified) when the target server is cleanly shutdown rather than crashed.
					</div><div class="para">
						The bridge connector can specify both a live and a backup server. If it specifies a backup server and this parameter is set to <code class="literal">true</code>, then if the target server is <span class="emphasis"><em>cleanly</em></span> shutdown the bridge connection will attempt to fail-over onto its backup. If the bridge connector has no backup server configured, this parameter has no effect.
					</div><div class="para">
						This parameter is useful when occasionally a bridge configured with a live and a backup target server is required, but fail-over to the backup is not required if the live server is taken down temporarily for maintenance.
					</div><div class="para">
						The default value for this parameter is <code class="literal">false</code>.
					</div></dd><dt><span class="term"> <code class="varname">use-duplicate-detection</code> </span></dt><dd><div class="para">
						This optional parameter determines whether the bridge will automatically insert a duplicate id property into each message that it forwards.
					</div><div class="para">
						Doing so, allows the target server to perform duplicate detection on messages it receives from the source server. If the connection fails or the server crashes, when the bridge resumes it will resend unacknowledged messages. This might result in duplicate messages being sent to the target server. Enabling duplicate detection allows these duplicates to be screened out and ignored.
					</div><div class="para">
						This allows the bridge to provide a <span class="emphasis"><em>once and only once</em></span> delivery guarantee without using heavyweight methods such as XA (Refer to <a class="xref" href="duplicate-detection.html">Chapter 35, <em>Duplicate Message Detection</em></a> for more information).
					</div><div class="para">
						The default value for this parameter is <code class="literal">true</code>.
					</div></dd><dt><span class="term"> <code class="varname">confirmation-window-size</code> </span></dt><dd><div class="para">
						This optional parameter determines the <code class="varname">confirmation-window-size</code> to use for the connection used to forward messages to the target node. This attribute is described in section <a class="xref" href="client-reconnection.html">Chapter 32, <em>Client Reconnection and Session Reattachment</em></a>.
					</div></dd></dl></div><div xmlns:d="http://docbook.org/ns/docbook" class="warning"><div class="admonition_header"><p><strong>Warning</strong></p></div><div class="admonition"><div class="para">
				When using the bridge to forward messages from a queue which has a max-size-bytes set it is important that confirmation-window-size is less than or equal to <code class="varname">max-size-bytes</code> to prevent the flow of messages from ceasing.
			</div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"> <code class="varname">connector-ref</code> </span></dt><dd><div class="para">
						This mandatory parameter determines which <span class="emphasis"><em>connector</em></span> pair the bridge will use to actually make the connection to the target server.
					</div><div class="para">
						A <span class="emphasis"><em>connector</em></span> encapsulates knowledge of what transport to use (TCP, SSL, HTTP etc) as well as the server connection parameters (host, port etc). For more information on connectors and their configuration, refer to <a class="xref" href="configuring-transports.html">Chapter 14, <em>Configuring the Transport</em></a>.
					</div><div class="para">
						The <code class="varname">connector-ref</code> element can be configured with two attributes:
					</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
								<code class="varname">connector-name</code>. This references the name of a connector defined in <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-configuration.xml</code>. The bridge will use this connector to make its connection to the target server. This attribute is mandatory.
							</div></li><li class="listitem"><div class="para">
								<code class="varname">backup-connector-name</code>. This optional parameter also references the name of a connector defined in <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-configuration.xml</code>. It represents the connector that the bridge will fail-over to if it detects that the live server connection has failed. If this is specified and <code class="varname">failover-on-server-shutdown</code> is set to <code class="literal">true</code> then it will also attempt fail-over onto this connector if the live target server is cleanly shut-down.
							</div></li></ul></div></dd><dt><span class="term"> <code class="varname">user</code> </span></dt><dd><div class="para">
						This optional parameter determines the user name to use when creating the bridge connection to the remote server. If it is not specified the default cluster user specified by <code class="varname">cluster-user</code> in <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-configuration.xml</code> is used.
					</div></dd><dt><span class="term"> <code class="varname">password</code> </span></dt><dd><div class="para">
						This optional parameter determines the password to use when creating the bridge connection to the remote server. If it is not specified, the default cluster password specified by <code class="varname">cluster-password</code> in <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-configuration.xml</code> is used.
					</div></dd></dl></div></div></div></body></html>