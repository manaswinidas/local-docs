<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 19. Message Redelivery and Undelivered Messages</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="undelivered-messages">
      ⁠</a>Chapter 19. Message Redelivery and Undelivered Messages</h1></div></div></div><div class="para">
		Message delivery can be unsuccessful, for example, if the session used to consume a message is rolled back. An undelivered message returns to the queue ready to be redelivered. However, this means multiple unsuccessful deliveries are possible, so messages can remain in the queue, clogging the system.
	</div><div class="para">
		There are two options for these undelivered messages:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Delayed Redelivery</span></dt><dd><div class="para">
					Message delivery can be delayed to allow the client time to recover from transient failures and not overload its network or CPU resources.
				</div></dd><dt><span class="term">Dead Letter Address</span></dt><dd><div class="para">
					Configure a dead letter address, to which messages are sent after being determined undeliverable.
				</div></dd></dl></div><div class="para">
		These options can be combined for maximum flexibility.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905846384000">
      ⁠</a>19.1. Delayed Redelivery</h1></div></div></div><div class="para">
			Delaying redelivery can be useful for clients that regularly fail or roll back. Without delayed redelivery, the system can get into a "thrashing" state, where delivery fails and the client rolls back to attempt redelivery ad infinitum, consuming CPU and network resources.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="undelivered-messages.delay">
      ⁠</a>19.1.1. Configuring Delayed Redelivery</h2></div></div></div><div class="para">
				Delayed redelivery is defined in the <code class="varname">address-setting</code> configuration:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">&lt;!-- delay redelivery of messages for 5s --&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;address-setting</span><span xmlns="" class="perl_Others"> match=</span><span xmlns="" class="perl_String">"jms.queue.exampleQueue"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;redelivery-delay&gt;</span>5000<span xmlns="" class="perl_Keyword">&lt;/redelivery-delay&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/address-setting&gt;</span></pre><div class="para">
				If a <code class="varname">redelivery-delay</code> is specified, HornetQ will wait that many milliseconds before redelivering the messages. Redelivery delay is enabled by default and set to 60000 (1 minute).
			</div><div class="para">
				Address wildcards can be used to configure redelivery delay for a set of addresses (see <a class="xref" href="wildcard-syntax.html">Chapter 11, <em>Understanding the HornetQ Wildcard Syntax</em></a>), so redelivery delay does not have to be specified for each address individually.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905813064464">
      ⁠</a>19.2. Dead Letter Addresses</h1></div></div></div><div class="para">
			To prevent a client infinitely receiving the same undelivered message (regardless of what is causing the unsuccessful deliveries), messaging systems define <span class="italic italic">dead letter addresses</span>: after a specified unsuccessful delivery attempts, the message is removed from the queue and send instead to a dead letter address.
		</div><div class="para">
			Any such messages can then be diverted to one or more queues where they can later be perused by the system administrator for action to be taken.
		</div><div class="para">
			HornetQ addresses can be assigned a dead letter address. Once the messages have been unsuccessfully delivered for a given number of attempts, they are removed from the queue and sent to the dead letter address. These <span class="emphasis"><em>dead letter</em></span> messages can later be consumed for further inspection.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="undelivered-messages.configuring">
      ⁠</a>19.2.1. Configuring Dead Letter Addresses</h2></div></div></div><div class="para">
				The dead letter address is defined in the <code class="varname">address-setting</code> configuration:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">&lt;!-- undelivered messages in exampleQueue will be sent to the dead </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">letter address deadLetterQueue after 3 unsuccessful delivery attempts--&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;address-setting</span><span xmlns="" class="perl_Others"> match=</span><span xmlns="" class="perl_String">"jms.queue.exampleQueue"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;dead-letter-address&gt;</span>jms.queue.deadLetterQueue<span xmlns="" class="perl_Keyword">&lt;/dead-letter-address&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;max-delivery-attempts&gt;</span>3<span xmlns="" class="perl_Keyword">&lt;/max-delivery-attempts&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/address-setting&gt;</span></pre><div class="para">
				If a <code class="varname">dead-letter-address</code> is not specified, messages will be removed after <code class="varname">max-delivery-attempts</code> unsuccessful attempts.
			</div><div class="para">
				By default, messages are redelivered a maximum of 10 times. Set <code class="varname">max-delivery-attempts</code> to <code class="literal">-1</code> for infinite redeliveries.
			</div><div class="para">
				A dead letter address can be set globally for a set of matching addresses, with <code class="varname">max-delivery-attempts</code> set to <code class="literal">-1</code> for a specific address setting to allow infinite redeliveries only for this address.
			</div><div class="para">
				Address wildcards can be used to configure dead letter settings for a set of addresses (see <a class="xref" href="wildcard-syntax.html">Chapter 11, <em>Understanding the HornetQ Wildcard Syntax</em></a>).
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139905871650560">
      ⁠</a>19.2.2. Dead Letter Properties</h2></div></div></div><div class="para">
				Dead letter messages which are consumed from a dead letter address have the following property:
			</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"> <code class="varname">HQ_ORIG_ADDRESS</code> </span></dt><dd><div class="para">
							A String property containing the <span class="emphasis"><em>original address</em></span> of the dead letter message.
						</div></dd></dl></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring.delivery.count.persistence">
      ⁠</a>19.3. Delivery Count Persistence</h1></div></div></div><div class="para">
			In normal use, HornetQ does not persist an updated delivery count until a message is rolled back (that is, the delivery count is not updated <span class="emphasis"><em>before</em></span> the message is delivered to the consumer). In most messaging use cases, the messages are consumed, acknowledged and forgotten as soon as they are consumed. In these cases, updating the delivery count persistently before delivering the message would add an extra persistent step <span class="emphasis"><em>for each message delivered</em></span>, imposing a significant performance penalty.
		</div><div class="para">
			However, if the delivery count is not updated persistently before message delivery, in the event of a server crash, the delivery of some messages may not be reflected in the delivery count. Therefore, during the recovery phase, the server may deliver the message with <code class="varname">redelivered</code> set to <code class="literal">false</code> when it should be <code class="literal">true</code>.
		</div><div class="para">
			Since this behavior breaks strict JMS semantics, delivery count can be persisted before message delivery in HornetQ. However, this is disabled by default for performance reasons. To enable this behavior, set <code class="varname">persist-delivery-count-before-delivery</code> to <code class="literal">true</code> in <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-configuration.xml</code>:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;persist-delivery-count-before-delivery&gt;</span>
<span xmlns="" class="line">​</span>  true
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/persist-delivery-count-before-delivery&gt;</span></pre></div></div></body></html>