<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 33. Diverting and Splitting Message Flows</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="diverts">
      ⁠</a>Chapter 33. Diverting and Splitting Message Flows</h1></div></div></div><div class="para">
		Diverts are objects that transparently divert messages routed to one address to some other address, without making any changes to any client application logic.
	</div><div class="para">
		Diverts can be <span class="emphasis"><em>exclusive</em></span> (messages are diverted to the new address and do not go to the previous address at all), or <span class="emphasis"><em>non-exclusive</em></span> (a copy of the message is sent to the new address, and the original message goes to the old address). Non-exclusive diverts can therefore be used for <span class="emphasis"><em>splitting</em></span> message flows, for example, when every order sent to an order queue must be monitored.
	</div><div class="para">
		Diverts can also be configured with a filter, so that only messages that match the filter are diverted.
	</div><div class="para">
		Diverts can also be configured to apply a <code class="classname">Transformer</code>. If specified, all diverted messages can be transformed by this <code class="classname">Transformer</code>.
	</div><div class="para">
		Diverts only move messages to addresses on the same server, but when used in combination with bridges more complex routings can be set up. One common use case to "divert" to a different server is to divert messages to a local store-and-forward queue and then set up a bridge to consume from that queue and forward consumed messages to an address on another server. The diverts on a server can be thought of as a routing table for messages. Combining diverts with bridges allow you to create a distributed network of reliable routing connections between multiple geographically distributed servers.
	</div><div class="para">
		Diverts are defined in the <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-configuration.xml</code> file. There can be zero or more diverts in the file.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905847276416">
      ⁠</a>33.1. Exclusive Diverts</h1></div></div></div><div class="para">
			An exclusive divert diverts all matching messages that are routed to the old address to the new address. Matching messages do not get routed to the old address.
		</div><div class="para">
			Diverts are defined in <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/jboss-as/server/<em class="replaceable">&lt;PROFILE&gt;</em>/deploy/hornetq/hornetq-configuration.xml</code> using the following directives:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;divert</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"prices-divert"</span><span xmlns="" class="perl_Keyword">&gt;</span>                  
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;address&gt;</span>jms.topic.priceUpdates<span xmlns="" class="perl_Keyword">&lt;/address&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;forwarding-address&gt;</span>jms.queue.priceForwarding<span xmlns="" class="perl_Keyword">&lt;/forwarding-address&gt;</span>    
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;filter</span><span xmlns="" class="perl_Others"> string=</span><span xmlns="" class="perl_String">"office='New York'"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;transformer-class-name&gt;</span>
<span xmlns="" class="line">​</span>    org.hornetq.jms.example.AddForwardingTimeTransformer
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/transformer-class-name&gt;</span>     
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;exclusive&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/exclusive&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/divert&gt;</span></pre><div class="para">
			The <code class="literal">prices-divert</code> divert specified above diverts any messages sent to the address <code class="literal">jms.topic.priceUpdates</code> (a local JMS Topic called <code class="literal">priceUpdates</code>) to another local address <code class="literal">jms.queue.priceForwarding</code> (a local JMS Queue called <code class="literal">priceForwarding</code>).
		</div><div class="para">
			A <code class="varname">filter string</code> is also specified so that only messages with the message property <code class="code">office='New York'</code> are diverted. All other messages continue to be routed to their usual address. The filter string is optional; if it is not specified, all messages are diverted.
		</div><div class="para">
			The transformer class is also optional. When specified, transformation is executed for each matching message. This allows you to change the message body or properties before the message is diverted. The example above uses a transformation to add a header recording the time the divert occurred.
		</div><div class="para">
			As a whole, the above example diverts messages to a local store-and-forward queue, which is configured with a bridge, which forwards the message to an address on another HornetQ server.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139905871132768">
      ⁠</a>33.2. Non-exclusive Diverts</h1></div></div></div><div class="para">
			Non-exclusive diverts forward a copy of a message to a new address, allowing the original message to continue to the previous address. They can be thought of as splitting the message flow.
		</div><div class="para">
			Non-exclusive diverts are configured similarly to exclusive diverts, with an optional filter and transformer, like so:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;divert</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"order-divert"</span><span xmlns="" class="perl_Keyword">&gt;</span>                 
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;address&gt;</span>jms.queue.orders<span xmlns="" class="perl_Keyword">&lt;/address&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;forwarding-address&gt;</span>jms.topic.spyTopic<span xmlns="" class="perl_Keyword">&lt;/forwarding-address&gt;</span>         
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;exclusive&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/exclusive&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/divert&gt;</span></pre><div class="para">
			The <code class="literal">order-divert</code> example copies every message sent to the <code class="literal">jms.queue.orders</code> address (a JMS Queue called <code class="literal">orders</code>) and forwards the copy to a local address <code class="literal">jms.topic.SpyTopic</code> (a JMS Topic called <code class="literal">SpyTopic</code>).
		</div></div></div></body></html>