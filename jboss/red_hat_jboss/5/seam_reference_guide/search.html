<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 27. Hibernate Search</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="search">
      ⁠</a>Chapter 27. Hibernate Search</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139690502873888">
      ⁠</a>27.1. Introduction</h1></div></div></div><div class="para">
			Full text search engines like <span class="trademark">Apache</span>™ <span class="trademark">Lucene</span>™ bring full text and efficient queries to applications. Hibernate Search, which makes use of Apache Lucene, can index your domain model with a few added annotations, handle database or index synchronization, and return regular managed objects that are matched by full text queries. There are some limitations to dealing with an object domain model over a text index — such as maintaining index accuracy, consistency between index structure and the domain model, and avoiding query mismatches — but these limitations are far outweighed by the advantages of speed and efficiency.
		</div><div class="para">
			Hibernate Search has been designed to integrate as naturally as possible with the Java Persistence API (JPA) and Hibernate. As a natural extension, JBoss Seam provides Hibernate Search integration.
		</div><div class="para">
			Refer to the <a href="http://www.hibernate.org/hib_docs/search/reference/en/html_single/"> Hibernate Search documentation</a> for information specific to the Hibernate Search project.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139690450379872">
      ⁠</a>27.2. Configuration</h1></div></div></div><div class="para">
			Hibernate Search is configured either in the <code class="filename">META-INF/persistence.xml</code> or <code class="filename">hibernate.cfg.xml</code> file.
		</div><div class="para">
			Hibernate Search configuration has sensible defaults for most configuration parameters. The following is an example of a minimal persistence unit configuration:
		</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;persistence-unit</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"sample"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;jta-data-source&gt;</span>java:/DefaultDS<span xmlns="" class="perl_Keyword">&lt;/jta-data-source&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;properties&gt;</span>
<span xmlns="" class="line">​</span>    [...]
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- use a file system based index --&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;property</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"hibernate.search.default.directory_provider"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">              value=</span><span xmlns="" class="perl_String">"org.hibernate.search.store.FSDirectoryProvider"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- directory where the indexes will be stored --&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;property</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"hibernate.search.default.indexBase"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">              value=</span><span xmlns="" class="perl_String">"/Users/prod/apps/dvdstore/dvdindexes"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/properties&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/persistence-unit&gt;</span>
</pre><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				When using Hibernate Search 3.1.x, more event listeners are required, but these are registered automatically by Hibernate Annotations. Refer to the <em class="citetitle">Hibernate Search Reference Guide</em> to learn to configure event listeners without using Hibernate EntityManager and Hibernate Annotations.
			</div></div></div><div class="para">
			The following <code class="filename">JAR</code>s must be deployed alongside the configuration file:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					<code class="filename">hibernate-search.jar</code>
				</div></li><li class="listitem"><div class="para">
					<code class="filename">hibernate-commons-annotations.jar</code>
				</div></li><li class="listitem"><div class="para">
					<code class="filename">lucene-core.jar</code>
				</div></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				If you deploy these in an <code class="filename">EAR</code>, remember to update <code class="filename">application.xml</code>.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139690509505856">
      ⁠</a>27.3. Usage</h1></div></div></div><div class="para">
			Hibernate Search uses annotations to map entities to a Lucene index. Check the <a href="http://www.hibernate.org/hib_docs/search/reference/en/html_single/"> reference documentation</a> for more information.
		</div><div class="para">
			Hibernate Search is completely integrated with the API, and semantic of JPA and Hibernate. Switching from a HQL- or Criteria-based query requires little code. The application interacts primarily with the <code class="classname">FullTextSession</code> API, which is a subclass of Hibernate's <code class="classname">Session</code>.
		</div><div class="para">
			When Hibernate Search is present, JBoss Seam injects a <code class="classname">FullTextSession</code>:
		</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>@Stateful
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">Name</span>(<span xmlns="" class="perl_String">"search"</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> FullTextSearchAction <span xmlns="" class="perl_Keyword">implements</span> FullTextSearch, Serializable {
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>  @In FullTextSession session;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">search</span>(String searchString) {
<span xmlns="" class="line">​</span>    org.<span xmlns="" class="perl_Function">apache</span>.<span xmlns="" class="perl_Function">lucene</span>.<span xmlns="" class="perl_Function">search</span>.<span xmlns="" class="perl_Function">Query</span> luceneQuery = <span xmlns="" class="perl_Function">getLuceneQuery</span>();
<span xmlns="" class="line">​</span>    org.<span xmlns="" class="perl_Function">hibernate</span>.<span xmlns="" class="perl_Function">Query</span> query session.<span xmlns="" class="perl_Function">createFullTextQuery</span>(luceneQuery, 
<span xmlns="" class="line">​</span>                                                          Product.<span xmlns="" class="perl_Function">class</span>);
<span xmlns="" class="line">​</span>    searchResults = query
<span xmlns="" class="line">​</span>                    .<span xmlns="" class="perl_Function">setMaxResults</span>(pageSize + <span xmlns="" class="perl_Float">1</span>)
<span xmlns="" class="line">​</span>                    .<span xmlns="" class="perl_Function">setFirstResult</span>(pageSize * currentPage)
<span xmlns="" class="line">​</span>                    .<span xmlns="" class="perl_Function">list</span>();
<span xmlns="" class="line">​</span>  }
<span xmlns="" class="line">​</span>  [...]
<span xmlns="" class="line">​</span>}
</pre><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				Here, <code class="classname">FullTextSession</code> extends <code class="classname">org.hibernate.Session</code> so that it can be used as a regular Hibernate Session.
			</div></div></div><div class="para">
			A smoother integration is proposed if the JPA is used:
		</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>@Stateful 
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">Name</span>(<span xmlns="" class="perl_String">"search"</span>) 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> FullTextSearchAction <span xmlns="" class="perl_Keyword">implements</span> FullTextSearch, Serializable { 
<span xmlns="" class="line">​</span>  @In FullTextEntityManager em; 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">search</span>(String searchString) { 
<span xmlns="" class="line">​</span>    org.<span xmlns="" class="perl_Function">apache</span>.<span xmlns="" class="perl_Function">lucene</span>.<span xmlns="" class="perl_Function">search</span>.<span xmlns="" class="perl_Function">Query</span> luceneQuery = <span xmlns="" class="perl_Function">getLuceneQuery</span>(); 
<span xmlns="" class="line">​</span>    javax.<span xmlns="" class="perl_Function">persistence</span>.<span xmlns="" class="perl_Function">Query</span> query = em.<span xmlns="" class="perl_Function">createFullTextQuery</span>(luceneQuery, 
<span xmlns="" class="line">​</span>                                                           Product.<span xmlns="" class="perl_Function">class</span>); 
<span xmlns="" class="line">​</span>    searchResults = query 
<span xmlns="" class="line">​</span>                    .<span xmlns="" class="perl_Function">setMaxResults</span>(pageSize + <span xmlns="" class="perl_Float">1</span>) 
<span xmlns="" class="line">​</span>                    .<span xmlns="" class="perl_Function">setFirstResult</span>(pageSize * currentPage) 
<span xmlns="" class="line">​</span>                    .<span xmlns="" class="perl_Function">getResultList</span>(); 
<span xmlns="" class="line">​</span>  } 
<span xmlns="" class="line">​</span>  [...]
<span xmlns="" class="line">​</span>}
</pre><div class="para">
			Here, a <code class="classname">FulltextEntityManager</code> is injected where Hibernate Search is present. <code class="classname">FullTextEntityManager</code> extends <code class="classname">EntityManager</code> with search specific methods, the same way <code class="classname">FullTextSession</code> extends <code class="classname">Session</code>.
		</div><div class="para">
			When an EJB 3.0 Session or Message Driven Bean injection is used (that is, where injection uses the <code class="literal">@PersistenceContext</code> annotation), the <code class="classname">EntityManager</code> interface cannot be replaced by using the <code class="classname">FullTextEntityManager</code> interface in the declaration statement. However, the implementation injected will be a <code class="classname">FullTextEntityManager</code> implementation, which allows downcasting.
		</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>@Stateful
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">Name</span>(<span xmlns="" class="perl_String">"search"</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> FullTextSearchAction <span xmlns="" class="perl_Keyword">implements</span> FullTextSearch, Serializable {
<span xmlns="" class="line">​</span>  
<span xmlns="" class="line">​</span>  @PersistenceContext EntityManager em;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">search</span>(String searchString) {
<span xmlns="" class="line">​</span>    org.<span xmlns="" class="perl_Function">apache</span>.<span xmlns="" class="perl_Function">lucene</span>.<span xmlns="" class="perl_Function">search</span>.<span xmlns="" class="perl_Function">Query</span> luceneQuery = <span xmlns="" class="perl_Function">getLuceneQuery</span>();
<span xmlns="" class="line">​</span>    FullTextEntityManager ftEm = (FullTextEntityManager) em;
<span xmlns="" class="line">​</span>    javax.<span xmlns="" class="perl_Function">persistence</span>.<span xmlns="" class="perl_Function">Query</span> query = 
<span xmlns="" class="line">​</span>      ftEm.<span xmlns="" class="perl_Function">createFullTextQuery</span>(luceneQuery, Product.<span xmlns="" class="perl_Function">class</span>);
<span xmlns="" class="line">​</span>    searchResults = query
<span xmlns="" class="line">​</span>                    .<span xmlns="" class="perl_Function">setMaxResults</span>(pageSize + <span xmlns="" class="perl_Float">1</span>)
<span xmlns="" class="line">​</span>                    .<span xmlns="" class="perl_Function">setFirstResult</span>(pageSize * currentPage)
<span xmlns="" class="line">​</span>                    .<span xmlns="" class="perl_Function">getResultList</span>();
<span xmlns="" class="line">​</span>  }
<span xmlns="" class="line">​</span>  [...]
<span xmlns="" class="line">​</span>}
</pre><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				If you are accustomed to using Hibernate Search outside Seam, remember that you do not need to use <code class="methodname">Search.createFullTextSession</code> when Hibernate Search is integrated with Seam.
			</div></div></div><div class="para">
			For a working example of Hibernate Search, check the DVDStore or Blog examples in the JBoss Seam distribution.
		</div></div></div></body></html>