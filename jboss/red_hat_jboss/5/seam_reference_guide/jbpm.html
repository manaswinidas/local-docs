<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 9. Pageflows and business processes</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="jbpm">
      ⁠</a>Chapter 9. Pageflows and business processes</h1></div></div></div><div class="para">
		JBoss jBPM is a business process management engine for any Java SE or EE environment. jBPM represents a business process or user interaction as a graph of nodes representing wait states, decisions, tasks, web pages, etc. The graph is defined with a simple, very readable XML dialect called jPDL, and can be edited and represented graphically using an Eclipse plug-in. jPDL is an extensible language, suitable for a range of problems, from defining web application pageflow, to managing traditional workflow, all the way up to orchestrating services in a SOA environment.
	</div><div class="para">
		Seam applications use jBPM for two different problems: defining pageflow in complex user interactions, and defining the overarching business process.
	</div><div class="para">
		For the former, a jPDL process definition defines the pageflow for a single conversation, whereas a Seam conversation is considered to be a relatively short-running interaction with a single user.
	</div><div class="para">
		For the latter, the business process may span multiple conversations with multiple users. Its state is persistent in the jBPM database, so it is considered long-running. Coordinating the activities of multiple users is more complex than scripting interaction with a single user, so jBPM offers sophisticated facilities for managing tasks and multiple concurrent execution paths.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			Do not confuse pageflow with the overarching business process. They operate at different levels of granularity. Pageflows, conversations, and tasks are all single interactions with a single user. A business process spans many tasks. Furthermore, the two applications of jBPM are not dependent upon each other — you can use them together, independently, or not at all.
		</div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			It is not necessary to know jPDL to use Seam. If you prefer to define pageflow with JSF or Seam navigation rules, and your application is more data-driven than process-driven, jBPM is probably unnecessary. However, we find that thinking of user interaction in terms of a well-defined graphical representation helps us create more robust applications.
		</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139690521349888">
      ⁠</a>9.1. Pageflow in Seam</h1></div></div></div><div class="para">
			There are two ways to define pageflow in Seam:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					Using JavaServer Faces (JSF) or Seam navigation rules — the <span class="emphasis"><em>stateless navigation model</em></span>
				</div></li><li class="listitem"><div class="para">
					Using jPDL — the <span class="emphasis"><em>stateful navigation model</em></span>
				</div></li></ul></div><div class="para">
			Simple applications will only require the stateless navigation model. Complex applications will use a combination of the two. Each model has its strengths and weaknesses, and should be implemented accordingly.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690539102032">
      ⁠</a>9.1.1. The two navigation models</h2></div></div></div><div class="para">
				The stateless model defines a mapping from a set of named, logical event outcomes directly to the resulting view page. The navigation rules ignore any state held by the application, other than the page from which the event originates. Therefore, action listener methods must sometimes make decisions about the pageflow, since only they have access to the current state of the application.
			</div><div class="para">
				Here is an example pageflow definition using JSF navigation rules:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;navigation-rule&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;from-view-id&gt;</span>/numberGuess.jsp<span xmlns="" class="perl_Keyword">&lt;/from-view-id&gt;</span>
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;navigation-case&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;from-outcome&gt;</span>guess<span xmlns="" class="perl_Keyword">&lt;/from-outcome&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;to-view-id&gt;</span>/numberGuess.jsp<span xmlns="" class="perl_Keyword">&lt;/to-view-id&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;redirect/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/navigation-case&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;navigation-case&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;from-outcome&gt;</span>win<span xmlns="" class="perl_Keyword">&lt;/from-outcome&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;to-view-id&gt;</span>/win.jsp<span xmlns="" class="perl_Keyword">&lt;/to-view-id&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;redirect/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/navigation-case&gt;</span>
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;navigation-case&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;from-outcome&gt;</span>lose<span xmlns="" class="perl_Keyword">&lt;/from-outcome&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;to-view-id&gt;</span>/lose.jsp<span xmlns="" class="perl_Keyword">&lt;/to-view-id&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;redirect/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/navigation-case&gt;</span>
<span xmlns="" class="line">​</span>  
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/navigation-rule&gt;</span>
</pre><div class="para">
				Here is the same example pageflow definition using Seam navigation rules:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/numberGuess.jsp"</span><span xmlns="" class="perl_Keyword">&gt;</span>    
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;navigation&gt;</span>
<span xmlns="" class="line">​</span>  
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;rule</span><span xmlns="" class="perl_Others"> if-outcome=</span><span xmlns="" class="perl_String">"guess"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;redirect</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/numberGuess.jsp"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/rule&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;rule</span><span xmlns="" class="perl_Others"> if-outcome=</span><span xmlns="" class="perl_String">"win"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;redirect</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/win.jsp"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/rule&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;rule</span><span xmlns="" class="perl_Others"> if-outcome=</span><span xmlns="" class="perl_String">"lose"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;redirect</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/lose.jsp"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/rule&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/navigation&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
</pre><div class="para">
				If you find navigation rules too verbose, you can return view IDs directly from your action listener methods:
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">guess</span>() { 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">if</span> (guess==randomNumber) <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_String">"/win.jsp"</span>; 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">if</span> (++guessCount==maxGuesses) <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_String">"/lose.jsp"</span>; 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">null</span>; 
<span xmlns="" class="line">​</span>}
</pre><div class="para">
				Note that this results in a redirect. You can also specify parameters to be used in the redirect:
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">search</span>() { 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_String">"/searchResults.jsp?searchPattern=#{searchAction.searchPattern}"</span>; 
<span xmlns="" class="line">​</span>}
</pre><div class="para">
				The stateful model defines a set of transitions between a set of named, logical application states. With this model, you can express the flow of any user interaction entirely in the jPDL pageflow definition, and write action listener methods that are completely unaware of the flow of the interaction.
			</div><div class="para">
				Here is an example page flow definition using jPDL:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;pageflow-definition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"numberGuess"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;start-page</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"displayGuess"</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/numberGuess.jsp"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;redirect/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"guess"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"evaluateGuess"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;action</span><span xmlns="" class="perl_Others"> expression=</span><span xmlns="" class="perl_String">"#{numberGuess.guess}"</span> <span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/transition&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/start-page&gt;</span>
<span xmlns="" class="line">​</span>   
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;decision</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"evaluateGuess"</span><span xmlns="" class="perl_Others"> expression=</span><span xmlns="" class="perl_String">"#{numberGuess.correctGuess}"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"win"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"false"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"evaluateRemainingGuesses"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/decision&gt;</span>
<span xmlns="" class="line">​</span>   
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;decision</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"evaluateRemainingGuesses"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            expression=</span><span xmlns="" class="perl_String">"#{numberGuess.lastGuess}"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"lose"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"false"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"displayGuess"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/decision&gt;</span>
<span xmlns="" class="line">​</span>   
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"win"</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/win.jsp"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;redirect/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;end-conversation</span> <span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
<span xmlns="" class="line">​</span>   
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"lose"</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/lose.jsp"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;redirect/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;end-conversation</span> <span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
<span xmlns="" class="line">​</span>   
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/pageflow-definition&gt;</span>
</pre><div class="mediaobject" style="text-align: center"><img src="images/plugin-jbpm-numguess.png" align="middle" alt="The two navigation models" style="text-align: middle"/></div><div class="para">
				Here, we notice two things immediately:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						The JSF and Seam navigation rules are much simpler. (However, this obscures the fact that the underlying Java code is more complex.)
					</div></li><li class="listitem"><div class="para">
						The jPDL makes the user interaction immediately comprehensible, and removes the need to look at JSP or Java code.
					</div></li></ul></div><div class="para">
				In addition, the stateful model is more constrained. For each logical state (each step in the pageflow), there are a constrained set of possible transitions to other states. The stateless model is an <span class="emphasis"><em>ad hoc</em></span> model, suitable to relatively unconstrained, freeform navigation where the user decides where he/she wants to go next, not the application.
			</div><div class="para">
				The distinction between stateful and stateless navigation is similar to that between modal and modeless interaction. Seam applications are not usually modal in the simple sense of the word — we use conversations to avoid modal behavior. However, Seam applications can be, and often are, modal at the level of a particular conversation. Because user movements are not perfectly predictable, modal behavior is best avoided, but it has its place in the stateful model.
			</div><div class="para">
				The biggest contrast between the two models is the back-button behavior.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690462037952">
      ⁠</a>9.1.2. Seam and the back button</h2></div></div></div><div class="para">
				With JSF or Seam navigation rules, the user can navigate freely with the back, forward and refresh buttons. The application is responsible for ensuring that conversational state remains internally consistent. Experience with web application frameworks and stateless component models has taught developers how difficult this is. It becomes far more straightforward in Seam, where it sits in a well-defined conversational model backed by stateful session beans. Usually, you need only combine a <code class="literal">no-conversation-view-id</code> with null checks at the beginning of action listener methods. Freeform navigation support is almost always desirable.
			</div><div class="para">
				In this case, the <code class="literal">no-conversation-view-id</code> declaration goes in <code class="filename">pages.xml</code>. This tells Seam to redirect to a different page if a request originates from a page that was rendered during a conversation that no longer exists:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/checkout.xhtml"</span><span xmlns="" class="perl_Others"> no-conversation-view-id=</span><span xmlns="" class="perl_String">"/main.xhtml"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
</pre><div class="para">
				On the other hand, in the stateful model, the back button is interpreted as an undefined transition back to a previous state. Since the stateful model enforces a defined set of transitions from the current state, the back button is, by default, not permitted in the stateful model. Seam transparently detects the use of the back button, and blocks any attempt to perform an action from a previous, "stale" page, redirecting the user to the "current" page (and displaying a Faces message). Although developers view this as a feature, it can be frustrating from the user's perspective. You can enable back button navigation from a particular page node by setting <code class="literal">back="enabled"</code>.
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"checkout"</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/checkout.xhtml"</span><span xmlns="" class="perl_Others"> back=</span><span xmlns="" class="perl_String">"enabled"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;redirect/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"checkout"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"complete"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"complete"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
</pre><div class="para">
				This allows navigation via the back button from the <code class="literal">checkout</code> state to any previous state.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					If a page is set to redirect after a transition, the back button cannot return a user to that page even when back is enabled on a page later in the flow. This is because Seam stores information about the pageflow in the page scope and the back button must result in a POST for that information to be restored (for example, through a Faces request). A redirect severs this link.
				</div></div></div><div class="para">
				We must still define what happens if a request originates from a page rendered during a pageflow, and the conversation with the pageflow no longer exists. In this case, the <code class="literal">no-conversation-view-id</code> declaration goes into the pageflow definition:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"checkout"</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/checkout.xhtml"</span><span xmlns="" class="perl_Others"> back=</span><span xmlns="" class="perl_String">"enabled"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">      no-conversation-view-id=</span><span xmlns="" class="perl_String">"/main.xhtml"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;redirect/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"checkout"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"complete"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"complete"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
</pre><div class="para">
				In practice, both navigation models have their place, and you will quickly learn to recognize where one model is better-suited to a task.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139690525924688">
      ⁠</a>9.2. Using jPDL pageflows</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690525923888">
      ⁠</a>9.2.1. Installing pageflows</h2></div></div></div><div class="para">
				We need to install the Seam jBPM-related components, and place the pageflow definitions (using the standard <code class="filename">.jpdl.xml</code> extension) inside a Seam archive (an archive containing a <code class="filename">seam.properties</code> file):
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;bpm:jbpm</span> <span xmlns="" class="perl_Keyword">/&gt;</span>
</pre><div class="para">
				We can also explicitly tell Seam where to find our pageflow definition. We specify this in <code class="filename">components.xml</code>:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;bpm:jbpm&gt;</span> 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;bpm:pageflow-definitions&gt;</span> 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;value&gt;</span>pageflow.jpdl.xml<span xmlns="" class="perl_Keyword">&lt;/value&gt;</span> 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/bpm:pageflow-definitions&gt;</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/bpm:jbpm&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690509482080">
      ⁠</a>9.2.2. Starting pageflows</h2></div></div></div><div class="para">
				We "start" a jPDL-based pageflow by specifying the name of the process definition with a <code class="literal">@Begin</code>, <code class="literal">@BeginTask</code> or <code class="literal">@StartTask</code> annotation:
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">Begin</span>(pageflow=<span xmlns="" class="perl_String">"numberguess"</span>) <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">begin</span>() { <span xmlns="" class="perl_Keyword">... </span>}
</pre><div class="para">
				Alternatively, we can start a pageflow using <code class="filename">pages.xml</code>:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page&gt;</span> 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;begin-conversation</span><span xmlns="" class="perl_Others"> pageflow=</span><span xmlns="" class="perl_String">"numberguess"</span><span xmlns="" class="perl_Keyword">/&gt;</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
</pre><div class="para">
				If we are beginning the pageflow during the <code class="literal">RENDER_RESPONSE</code> phase — during a <code class="literal">@Factory</code> or <code class="literal">@Create</code> method, for example — we consider ourselves already at the rendered page, and use a <code class="literal">&lt;start-page&gt;</code> node as the first node in the pageflow, as in the example above.
			</div><div class="para">
				But if the pageflow is begun as the result of an action listener invocation, the outcome of the action listener determines the first page to be rendered. In this case, we use a <code class="literal">&lt;start-state&gt;</code> as the first node in the pageflow, and declare a transition for each possible outcome:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;pageflow-definition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"viewEditDocument"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;start-state</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"start"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"documentFound"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"displayDocument"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"documentNotFound"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"notFound"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/start-state&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"displayDocument"</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/document.jsp"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"edit"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"editDocument"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"done"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"main"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>  ...
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"notFound"</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/404.jsp"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;end-conversation/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/pageflow-definition&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690514791600">
      ⁠</a>9.2.3. Page nodes and transitions</h2></div></div></div><div class="para">
				Each <code class="literal">&lt;page&gt;</code> node represents a state where the system is waiting for user input:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"displayGuess"</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/numberGuess.jsp"</span><span xmlns="" class="perl_Keyword">&gt;</span> 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;redirect/&gt;</span> 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"guess"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"evaluateGuess"</span><span xmlns="" class="perl_Keyword">&gt;</span> 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;action</span><span xmlns="" class="perl_Others"> expression=</span><span xmlns="" class="perl_String">"#{numberGuess.guess}"</span> <span xmlns="" class="perl_Keyword">/&gt;</span> 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/transition&gt;</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
</pre><div class="para">
				The <code class="literal">view-id</code> is the JSF view ID. The <code class="literal">&lt;redirect/&gt;</code> element has the same effect as <code class="literal">&lt;redirect/&gt;</code> in a JSF navigation rule — that is, a post-then-redirect behavior, to overcome problems with the browser's refresh button. (Note that Seam propagates conversation contexts across these browser redirects, so Seam does not require a Ruby on Rails-style <span class="emphasis"><em>flash</em></span> construct.)
			</div><div class="para">
				The transition name is the name of a JSF outcome triggered by clicking a command button or command link in <code class="filename">numberGuess.jsp</code>.
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;h:commandButton</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"submit"</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"Guess"</span><span xmlns="" class="perl_Others"> action=</span><span xmlns="" class="perl_String">"guess"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>
</pre><div class="para">
				When clicking this button triggers the transition, jBPM activates the transition action by calling the <code class="literal">guess()</code> method of the <code class="literal">numberGuess</code> component. The syntax used for specifying actions in the jPDL is a familiar JSF EL expression, and the transition handler is a method of a Seam component in the current Seam contexts. Thus, we have the same event model for jBPM events as we have for JSF events. This is one of the guiding principles of Seam.
			</div><div class="para">
				In the case of a null outcome (for example, a command button with no <code class="literal">action</code> defined), Seam signals the transition with no name (if one exists), or simply redisplay the page if all transitions are named. Therefore we could simplify this button and our pageflow like so:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;h:commandButton</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"submit"</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"Guess"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
</pre><div class="para">
				This would fire the following un-named transition:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"displayGuess"</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/numberGuess.jsp"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;redirect/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"evaluateGuess"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;action</span><span xmlns="" class="perl_Others"> expression=</span><span xmlns="" class="perl_String">"#{numberGuess.guess}"</span> <span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/transition&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
</pre><div class="para">
				The button could also call an action method, in which case the action outcome determines the transition to be made:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;h:commandButton</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"submit"</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"Guess"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">   action=</span><span xmlns="" class="perl_String">"#{numberGuess.guess}"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
</pre><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"displayGuess"</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/numberGuess.jsp"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"correctGuess"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"win"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"incorrectGuess"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"evaluateGuess"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
</pre><div class="para">
				However, this style is considered inferior, since it shifts responsibility for flow control out of the pageflow definition and back into other components. It is much better to centralize this concern in the pageflow itself.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690527330800">
      ⁠</a>9.2.4. Controlling the flow</h2></div></div></div><div class="para">
				Usually, the more powerful features of jPDL are not required when defining pageflows. However, we do require the <code class="literal">&lt;decision&gt;</code> node:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;decision</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"evaluateGuess"</span><span xmlns="" class="perl_Others"> expression=</span><span xmlns="" class="perl_String">"#{numberGuess.correctGuess}"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"win"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"false"</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"evaluateRemainingGuesses"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/decision&gt;</span>
</pre><div class="para">
				A decision is made by evaluating a JSF EL expression within the Seam context.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690512901040">
      ⁠</a>9.2.5. Ending the flow</h2></div></div></div><div class="para">
				We end the conversation with <code class="literal">&lt;end-conversation&gt;</code> or <code class="literal">@End</code>. For the sake of readability, we encourage you to use both.
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"win"</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/win.jsp"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;redirect/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;end-conversation/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
</pre><div class="para">
				Optionally, we can end a task, or specify a jBPM <code class="literal">transition</code> name. In this case, Seam signals the end of the current task in the overarching business process.
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"win"</span><span xmlns="" class="perl_Others"> view-id=</span><span xmlns="" class="perl_String">"/win.jsp"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;redirect/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;end-task</span><span xmlns="" class="perl_Others"> transition=</span><span xmlns="" class="perl_String">"success"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690527265952">
      ⁠</a>9.2.6. Pageflow composition</h2></div></div></div><div class="para">
				It is possible to compose pageflows so that one pageflow pauses while another pageflow executes. The <code class="literal">&lt;process-state&gt;</code> node pauses the outer pageflow, and begins execution of a named pageflow:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;process-state</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"cheat"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;sub-process</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"cheat"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"displayGuess"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/process-state&gt;</span>
</pre><div class="para">
				The inner flow begins executing at a <code class="literal">&lt;start-state&gt;</code> node. When it reaches an <code class="literal">&lt;end-state&gt;</code> node, execution of the inner flow ends, and execution of the outer flow resumes with the transition defined by the <code class="literal">&lt;process-state&gt;</code> element.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139690456081456">
      ⁠</a>9.3. Business process management in Seam</h1></div></div></div><div class="para">
			A business process is a set of tasks that must be performed by users or software systems according to well-defined rules regarding who can perform a certain task, and when that task should be performed. Seam's jBPM integration makes it easy to let users view and manage their task lists. Seam also lets the application store state associated with the business process in the <code class="literal">BUSINESS_PROCESS</code> context, and makes that state persistent through jBPM variables.
		</div><div class="para">
			A simple business process definition resembles a pageflow definition, except that instead of <code class="literal">&lt;page&gt;</code> nodes, we use <code class="literal">&lt;task-node&gt;</code> nodes. In a long-running business process, the wait state occurs where the system is waiting for some user to log in and perform a task.
		</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;process-definition</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"todo"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;start-state</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"start"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"todo"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/start-state&gt;</span>
<span xmlns="" class="line">​</span>   
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;task-node</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"todo"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;task</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"todo"</span><span xmlns="" class="perl_Others"> description=</span><span xmlns="" class="perl_String">"#{todoList.description}"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;assignment</span><span xmlns="" class="perl_Others"> actor-id=</span><span xmlns="" class="perl_String">"#{actor.id}"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/task&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;transition</span><span xmlns="" class="perl_Others"> to=</span><span xmlns="" class="perl_String">"done"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/task-node&gt;</span>
<span xmlns="" class="line">​</span>   
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;end-state</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"done"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>   
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/process-definition&gt;</span>
</pre><div class="mediaobject" style="text-align: center"><img src="images/plugin-jbpm-todo.png" align="middle" alt="Business process management in Seam" style="text-align: middle"/></div><div class="para">
			jPDL business process definitions and jPDL pageflow definitions can be used in the same project. When this occurs, a single <code class="literal">&lt;task&gt;</code> in a business process corresponds to a whole pageflow <code class="literal">&lt;pageflow-definition&gt;</code>.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139690518935264">
      ⁠</a>9.4. Using jPDL business process definitions</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690473490688">
      ⁠</a>9.4.1. Installing process definitions</h2></div></div></div><div class="para">
				First, we must install jBPM and tell it where to find the business process definitions:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;bpm:jbpm&gt;</span> 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;bpm:process-definitions&gt;</span> 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;value&gt;</span>todo.jpdl.xml<span xmlns="" class="perl_Keyword">&lt;/value&gt;</span> 
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/bpm:process-definitions&gt;</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/bpm:jbpm&gt;</span>
</pre><div class="para">
				Since jBPM processes persist across application restarts, when using Seam in a production environment, it is unnecessary to install the process definition each time the application starts. Therefore, the process must be deployed to jBPM outside Seam. It is only necessary to install process definitions from <code class="filename">components.xml</code> during application development.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690535007296">
      ⁠</a>9.4.2. Initializing actor IDs</h2></div></div></div><div class="para">
				We always need to know which user is currently logged in. jBPM recognizes users with their <span class="emphasis"><em>actor ID</em></span> and <span class="emphasis"><em>group actor ID</em></span>. We specify the current actor IDs with the built-in Seam component, <code class="literal">actor</code>:
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>@In Actor actor;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">login</span>() {
<span xmlns="" class="line">​</span>  ...
<span xmlns="" class="line">​</span>  actor.<span xmlns="" class="perl_Function">setId</span>( user.<span xmlns="" class="perl_Function">getUserName</span>() );
<span xmlns="" class="line">​</span>  actor.<span xmlns="" class="perl_Function">getGroupActorIds</span>().<span xmlns="" class="perl_Function">addAll</span>( user.<span xmlns="" class="perl_Function">getGroupNames</span>() );
<span xmlns="" class="line">​</span>  ...
<span xmlns="" class="line">​</span>}
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690526542592">
      ⁠</a>9.4.3. Initiating a business process</h2></div></div></div><div class="para">
				To initiate a business process instance, we use the <code class="literal">@CreateProcess</code> annotation:
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">CreateProcess</span>(definition=<span xmlns="" class="perl_String">"todo"</span>) 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">createTodo</span>() { <span xmlns="" class="perl_Keyword">... </span>}
</pre><div class="para">
				Alternatively we can initiate a business process using <code class="filename">pages.xml</code>:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;create-process</span><span xmlns="" class="perl_Others"> definition=</span><span xmlns="" class="perl_String">"todo"</span> <span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690513563952">
      ⁠</a>9.4.4. Task assignment</h2></div></div></div><div class="para">
				When a process reaches a task node, task instances are created. These must be assigned to users or user groups. We can either hard code our actor IDs, or delegate to a Seam component:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;task</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"todo"</span><span xmlns="" class="perl_Others"> description=</span><span xmlns="" class="perl_String">"#{todoList.description}"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;assignment</span><span xmlns="" class="perl_Others"> actor-id=</span><span xmlns="" class="perl_String">"#{actor.id}"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/task&gt;</span>
</pre><div class="para">
				In this case, we have simply assigned the task to the current user. We can also assign tasks to a pool:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;task</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"todo"</span><span xmlns="" class="perl_Others"> description=</span><span xmlns="" class="perl_String">"#{todoList.description}"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;assignment</span><span xmlns="" class="perl_Others"> pooled-actors=</span><span xmlns="" class="perl_String">"employees"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/task&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690517534000">
      ⁠</a>9.4.5. Task lists</h2></div></div></div><div class="para">
				Several built-in Seam components make it easy to display task lists. The <code class="literal">pooledTaskInstanceList</code> is a list of pooled tasks that users may assign to themselves:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;h:dataTable</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"#{pooledTaskInstanceList}"</span><span xmlns="" class="perl_Others"> var=</span><span xmlns="" class="perl_String">"task"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;h:column&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;f:facet</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"header"</span><span xmlns="" class="perl_Keyword">&gt;</span>Description<span xmlns="" class="perl_Keyword">&lt;/f:facet&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;h:outputText</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"#{task.description}"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/h:column&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;h:column&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;s:link</span><span xmlns="" class="perl_Others"> action=</span><span xmlns="" class="perl_String">"#{pooledTask.assignToCurrentActor}"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            value=</span><span xmlns="" class="perl_String">"Assign"</span><span xmlns="" class="perl_Others"> taskInstance=</span><span xmlns="" class="perl_String">"#{task}"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/h:column&gt;</span>             
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/h:dataTable&gt;</span>
</pre><div class="para">
				Note that instead of <code class="literal">&lt;s:link&gt;</code>, we can use a plain JSF <code class="literal">&lt;h:commandLink&gt;</code>:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;h:commandLink</span><span xmlns="" class="perl_Others"> action=</span><span xmlns="" class="perl_String">"#{pooledTask.assignToCurrentActor}"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;f:param</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"taskId"</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"#{task.id}"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/h:commandLink&gt;</span>
</pre><div class="para">
				The <code class="literal">pooledTask</code> component is a built-in component that simply assigns the task to the current user.
			</div><div class="para">
				The <code class="literal">taskInstanceListForType</code> component includes tasks of a particular type that are assigned to the current user:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;h:dataTable</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"#{taskInstanceListForType['todo']}"</span><span xmlns="" class="perl_Others"> var=</span><span xmlns="" class="perl_String">"task"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;h:column&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;f:facet</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"header"</span><span xmlns="" class="perl_Keyword">&gt;</span>Description<span xmlns="" class="perl_Keyword">&lt;/f:facet&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;h:outputText</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"#{task.description}"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/h:column&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;h:column&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;s:link</span><span xmlns="" class="perl_Others"> action=</span><span xmlns="" class="perl_String">"#{todoList.start}"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            value=</span><span xmlns="" class="perl_String">"Start Work"</span><span xmlns="" class="perl_Others"> taskInstance=</span><span xmlns="" class="perl_String">"#{task}"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/h:column&gt;</span>             
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/h:dataTable&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139690510489312">
      ⁠</a>9.4.6. Performing a task</h2></div></div></div><div class="para">
				To begin work on a task, we use either <code class="literal">@StartTask</code> or <code class="literal">@BeginTask</code> on the listener method:
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>@StartTask <span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">start</span>() { <span xmlns="" class="perl_Keyword">... </span>}
</pre><div class="para">
				Alternatively, we can begin work on a task with <code class="filename">pages.xml</code>:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;start-task</span> <span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
</pre><div class="para">
				These annotations begin a special kind of conversation that is significant in terms of the overarching business process. Work done by this conversation has access to state held in the business process context.
			</div><div class="para">
				If we end the conversation with <code class="literal">@EndTask</code>, Seam signals the completion of the task:
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">EndTask</span>(transition=<span xmlns="" class="perl_String">"completed"</span>) 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">completed</span>() { <span xmlns="" class="perl_Keyword">... </span>}
</pre><div class="para">
				Alternatively, we can use <code class="filename">pages.xml</code>:
			</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;page&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;end-task</span><span xmlns="" class="perl_Others"> transition=</span><span xmlns="" class="perl_String">"completed"</span> <span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/page&gt;</span>
</pre><div class="para">
				You can also use EL to specify the transition in <code class="filename">pages.xml</code>.
			</div><div class="para">
				At this point, jBPM will continue to execute the business process definition. (In more complex processes, several tasks may need to be completed before process execution can resume.)
			</div><div class="para">
				Please refer to the jBPM documentation for a more thorough overview of the sophisticated features that jBPM provides for managing complex business processes.
			</div></div></div></div></body></html>