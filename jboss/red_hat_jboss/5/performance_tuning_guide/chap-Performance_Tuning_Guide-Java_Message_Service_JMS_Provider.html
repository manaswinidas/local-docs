<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 6. Java Message Service (JMS) Provider</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="chap-Performance_Tuning_Guide-Java_Message_Service_JMS_Provider">
      ⁠</a>Chapter 6. Java Message Service (JMS) Provider</h1></div></div></div><div class="para">
		As discussed in the JCA chapter, JBoss Enterprise Application Platform offers two JMS providers: the default JBoss Messaging and the new HornetQ. From a performance perspective, HornetQ is far superior to JBoss Messaging.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Performance_Tuning_Guide-Java_Message_Service_JMS_Provider-Switching_the_Default_Messaging_Provider_to_HornetQ">
      ⁠</a>6.1. Switching the Default Messaging Provider to HornetQ</h1></div></div></div><div class="para">
			To change the default JMS provider from JBoss Messaging to HornetQ, a script is provided in the EAP distribution which moves JBoss Messaging out of the deployment folders and deploys HornetQ. The script is called <code class="filename">switch.sh</code> (<code class="filename">switch.bat</code> on Microsoft Windows Server) and can be found in the directory <code class="filename">JBOSS_EAP_DIST/jboss-as/extras/hornetq</code>. This script requires the open source build tool Ant be in the path in order to work.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="warning"><div class="admonition_header"><p><strong>Warning</strong></p></div><div class="admonition"><div class="para">
				There is no "undo" option except to reinstall the binaries, so be sure you want to do this before proceeding.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Performance_Tuning_Guide-Java_Message_Service_JMS_Provider-Exploiting_HornetQs_Support_of_Linuxs_Native_Asynchronous_IO">
      ⁠</a>6.2. Exploiting HornetQ's Support of Linux's Native Asynchronous I/O</h1></div></div></div><div class="para">
			If JBoss Enterprise Application Platform is running on Red Hat Enterprise Linux (RHEL), you can take advantage of HornetQ's ability to leverage Linux's native asynchronous I/O for its journal. HornetQ has moved from the database approach of JBoss Messaging for persistent messages to a new high performance journal that exists on the file system. Since this journal lives on the file system, HornetQ uses Java's New Input/Output (NIO) routines as the mechanism for reading and writing the journal. There is also a native library, that if detected, will enable HornetQ to leverage Linux's native asynchronous I/O capabilities. This has to be done in “native” code, as Java does not directly support OS asynchronous I/O. Using the operating system's own asynchronous I/O provides the best possible performance and scalability. To enable this option two steps are required.
		</div><div class="para">
			The first step is to ensure that the libaio package is installed on your instance of RHEL. This package provides the API for HornetQ's native code that allows it to use asynchronous I/O. With the libaio package installed, the next step is to ensure the native code for HornetQ is available. That has to be placed at the same directory level as your EAP instance. For example, if you have EAP installed in <code class="filename">/opt/redhat/jboss-eap-5.1</code>, then the native code must be put in the same directory. This is because, being native code, it must be the right version for your RHEL version, and the right libraries for the JVM. Both the 32-bit and 64-bit JVMs are supported so there are 32-bit and 64-bit versions of the libraries. The run.sh script will automatically detect the directory relative to the EAP installation directory and resulting JBOSS_HOME that is set within that script (run.bat for Windows won’t have this, as this is a Linux only feature). If you have everything installed correctly, you should see this message in the log after start up.
		</div><pre class="screen">
10:50:05,113 INFO  [JournalStorageManager] Using AIO Journal
</pre><div class="para">
			If you do not have everything installed correctly, you will see a message like the following:
		</div><pre class="screen">
2011-02-18 10:05:11,485 WARNING [org.hornetq.core.deployers.impl.FileConfigurationParser] (main) AIO wasn't located on this platform, it will fall back to using pure Java NIO. If your platform is Linux, install LibAIO to enable the AIO journal
</pre><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				These installation instructions are only for zip based installations. If you are using the EAP RPM installation method then everything should be placed in the correct locations by the RPM.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Performance_Tuning_Guide-Java_Message_Service_JMS_Provider-HornetQs_Journal">
      ⁠</a>6.3. HornetQ's Journal</h1></div></div></div><div class="para">
			Aside from enabling native asynchronous I/O (if installed on RHEL), the next configuration parameter to optimize is the journal's location, relative to the file system configuration. The default configuration places the journal in <code class="filename">${jboss.server.data.dir}/${hornetq.data.dir}:hornetq/journal</code>, which expands to: <code class="filename">JBOSS_EAP_DIST/jboss-as/server/<em class="replaceable">PROFILE</em>/data/hornetq/journal</code>. Note that the <code class="literal">minimal</code> configuration does <span class="emphasis"><em>not</em></span> contain the JMS provider.
		</div><div class="para">
			Depending on the underlying storage configuration, this may not be the optimal location. A common configuration is to locate rarely-accessed file (e.g. executables/binaries) on relatively slow, cheaper storage and often-accessed files (e.g. log files, journaling files) on high-performance, more expensive storage. If you have very high messaging loads, the journal should be placed on a high-performance file system, with a high-performance disk configuration. In general, HornetQ's performance is bound by the speed of the file system and network so the configuration of these are most likely be governing factors of performance. To change the location of the journal, the HornetQ configuration file needs to be modified. The configuration file is called <code class="filename">hornetq-configuration.xml</code>, in the directory <code class="filename">JBOSS_EAP_DIST/jboss-as/server/<em class="replaceable">PROFILE</em>/deploy/hornetq/</code>.
		</div><div class="para">
			Below is an extract from the configuration file:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;configuration</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:hornetq"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">   xmlns:xsi=</span><span xmlns="" class="perl_String">"http://www.w3.org/2001/XMLSchema-instance"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">   xsi:schemaLocation=</span><span xmlns="" class="perl_String">"urn:hornetq /schema/hornetq-configuration.xsd"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">&lt;!--  Do not change this name.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">   This is used by the dependency framework on the deployers,</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">   to make sure this deployment is done before any other deployment --&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;name&gt;</span>HornetQ.main.config<span xmlns="" class="perl_Keyword">&lt;/name&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;clustered&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/clustered&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;log-delegate-factory-class-name&gt;</span>org.hornetq.integration.logging.Log4jLogDelegateFactory<span xmlns="" class="perl_Keyword">&lt;/log-delegate-factory-class-name&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;bindings-directory&gt;</span>${jboss.server.data.dir}/${hornetq.data.dir:hornetq}/bindings<span xmlns="" class="perl_Keyword">&lt;/bindings-directory&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;journal-directory&gt;</span>${jboss.server.data.dir}/${hornetq.data.dir:hornetq}/journal<span xmlns="" class="perl_Keyword">&lt;/journal-directory&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;journal-min-files&gt;</span>10<span xmlns="" class="perl_Keyword">&lt;/journal-min-files&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;large-messages-directory&gt;</span>${jboss.server.data.dir}/${hornetq.data.dir:hornetq}/largemessages<span xmlns="" class="perl_Keyword">&lt;/large-messages-directory&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;paging-directory&gt;</span>${jboss.server.data.dir}/${hornetq.data.dir:hornetq}/paging<span xmlns="" class="perl_Keyword">&lt;/paging-directory&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/configuration&gt;</span>
</pre><div class="para">
			From the above extract, the following directories are of interest:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					journal-directory
				</div></li><li class="listitem"><div class="para">
					large-messages-directory
				</div></li><li class="listitem"><div class="para">
					paging-directory
				</div></li></ul></div><div class="para">
			The location specified for <code class="literal">journal-directory</code> is the most critical with respect to performance but the others can also have a significant impact.
		</div><div class="para">
			The <code class="literal">journal-directory</code> is where persistent messages are stored.
		</div><div class="para">
			The <code class="literal">large-message</code> directory is used to store messages that are larger than can fit into memory. If the application processes large messages, this is also a performance critical directory.
		</div><div class="para">
			The <code class="literal">paging-directory</code> is similar to the large message directory, except that is an accumulation of many messages, that no longer fit into memory or are swapped/paged to disk, which is analogous to operating system paging to swap. Just like the journal and large message directory, this is also a performance critical directory, if swapping/paging occurs.
		</div><div class="para">
			There are two ways to change the locations to be used by these directories. First, you can change the <code class="literal">${jboss.server.data.dir}</code> variable, by passing <code class="literal">-Djboss.server.data.dir</code>=<em class="replaceable">&lt;path&gt;</em> where path is the new directory location (higher performance file system and disk configuration). This will have the effect of moving everything that uses that directory to the new location, not just the HornetQ directories. This approach has an added bonus because there is another performance critical directory under that path, which contains the transaction journal. Transactions are logged for crash recovery purposes within this same path and this can also benefit from being located on higher-performing storage. The other option is to change the configuration directly, remove the ${jboss.server.data.dir} and replace it with the new location. In either case, moving this to faster storage will improve performance. Using the command-line option method is easiest because it uses the variable, so there's no need to change the configuration file.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Performance_Tuning_Guide-Java_Message_Service_JMS_Provider-HornetQ_and_Transactions">
      ⁠</a>6.4. HornetQ and Transactions</h1></div></div></div><div class="para">
			With the older JBoss Messaging technology, persistent messages were stored in a database, with several choices. The JBoss Messaging tables could be combined with all other tables into one unified data source, or separated into its own schema, catalog or database instance (whichever terminology is relevant to your particular database). If messaging schema is combined with other tables, all transactions that span both the messaging system and the application's tables would participate in the same transaction, and commit and rollback as a group. This would be true, even if you defined the data source to be an XA data source, because the XA protocol specification allows a single phase commit optimization for just this circumstance. If you kept them separate, then you would have to define your application data source and the messaging data source to both be XA data sources, so you would get the proper transaction semantics between your messages and your application. Now that HornetQ uses its own file system journal there is no way to unify the other persistent parts of the application with the journal from a transaction perspective, as was possible with JBoss Messaging. If there's a need for messaging and application persistence to participate in the same transaction, the data source must be setup as an XA data source.
		</div></div></div></body></html>