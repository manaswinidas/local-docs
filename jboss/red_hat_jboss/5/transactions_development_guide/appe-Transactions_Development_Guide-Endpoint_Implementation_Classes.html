<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Appendix C. Endpoint Implementation Classes</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="appendix"><div class="titlepage"><div><div><h1 class="title"><a id="appe-Transactions_Development_Guide-Endpoint_Implementation_Classes">
      ⁠</a>Appendix C. Endpoint Implementation Classes</h1></div></div></div><div class="para">
		The example below is the demonstration application configuration mentioned in <a class="xref" href="chap-Transactions_Development_Guide-Getting_Started.html#sect-Transactions_Development_Guide-Getting_Started-JAX-WS_Service_Context-Handlers">Section 19.3.2.1, “JAX-WS Service Context Handlers”</a>.
	</div><div class="example"><a id="idm140019167391520">
      ⁠</a><p class="title"><strong>Example C.1. Application Configuration (<code class="filename">context-handlers.xml</code>)</strong></p><div class="example-contents"><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0" encoding="UTF-8"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">&lt;!--</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">--&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;handler-chains</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"http://java.sun.com/xml/ns/javaee"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">xmlns:xsi=</span><span xmlns="" class="perl_String">"http://www.w3.org/2001/XMLSchema-instance"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">xsi:schemaLocation=</span><span xmlns="" class="perl_String">"http://java.sun.com/xml/ns/javaee"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;handler-chain&gt;</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">&lt;handler&gt;</span>
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">&lt;handler-name&gt;</span>ContextHandler<span xmlns="" class="perl_Keyword">&lt;/handler-name&gt;</span>
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">&lt;handler-class&gt;</span>com.arjuna.mw.wst11.service.JaxWSHeaderContextProcessor<span xmlns="" class="perl_Keyword">&lt;/handler-class&gt;</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">&lt;/handler&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/handler-chain&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/handler-chains&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
</pre></div></div><div class="para">
		The following four code samples are demonstration implementations of the <code class="systemitem">javax.jws.WebService</code> and <code class="systemitem">javax.jws.HandlerChain</code> annotations which are discussed in <a class="xref" href="chap-Transactions_Development_Guide-Getting_Started.html#sect-Transactions_Development_Guide-Getting_Started-JAX-WS_Service_Context-Handlers">Section 19.3.2.1, “JAX-WS Service Context Handlers”</a>.
	</div><div class="example"><a id="idm140019179638096">
      ⁠</a><p class="title"><strong>Example C.2. <code class="filename">RestaurantServiceAT.java</code></strong></p><div class="example-contents"><pre class="programlisting Java"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>package com.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">jbosstm</span>.<span xmlns="" class="perl_Function">xts</span>.<span xmlns="" class="perl_Function">demo</span>.<span xmlns="" class="perl_Function">services</span>.<span xmlns="" class="perl_Function">restaurant</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.ats.arjuna.common.Uid;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.mw.wst11.TransactionManagerFactory;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.mw.wst11.UserTransactionFactory;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.jboss.jbosstm.xts.demo.restaurant.IRestaurantServiceAT;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.jboss.jbosstm.xts.demo.services.recovery.DemoATRecoveryModule;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.HandlerChain;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.WebParam;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.WebService;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.WebMethod;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.soap.SOAPBinding;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.annotation.PostConstruct;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.annotation.PreDestroy;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.jbossts.xts.recovery.participant.at.XTSATRecoveryManager;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * An adapter class that exposes the RestaurantManager business API as a</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * transactional Web Service. Also logs events to a RestaurantView object.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@author </span><span xmlns="" class="perl_Comment">Jonathan Halliday (jonathan.halliday@arjuna.com)</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@version </span><span xmlns="" class="perl_Comment">$Revision: 1.3 $</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">WebService</span>(serviceName=<span xmlns="" class="perl_String">"RestaurantServiceATService"</span>, portName=<span xmlns="" class="perl_String">"RestaurantServiceAT"</span>,
<span xmlns="" class="line">​</span>        name = <span xmlns="" class="perl_String">"IRestaurantServiceAT"</span>, targetNamespace = <span xmlns="" class="perl_String">"http://www.jboss.com/jbosstm/xts/demo/Restaurant"</span>,
<span xmlns="" class="line">​</span>        wsdlLocation = <span xmlns="" class="perl_String">"/WEB-INF/wsdl/RestaurantServiceAT.wsdl"</span>)
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">HandlerChain</span>(file = <span xmlns="" class="perl_String">"../context-handlers.xml"</span>, name = <span xmlns="" class="perl_String">"Context Handlers"</span>)                  
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">SOAPBinding</span>(style=SOAPBinding.<span xmlns="" class="perl_Function">Style</span>.<span xmlns="" class="perl_Function">RPC</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> RestaurantServiceAT <span xmlns="" class="perl_Keyword">implements</span> IRestaurantServiceAT
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * ensure that the recovery module for the dmeo is installed</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    @PostConstruct
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">postConstruct</span>()
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// ensure that the xts-demo AT recovery helper module is registered</span>
<span xmlns="" class="line">​</span>        DemoATRecoveryModule.<span xmlns="" class="perl_Function">register</span>();
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * ensure that the recovery module for the dmeo is deinstalled</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    @PreDestroy
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">preDestroy</span>()
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// ensure that the xts-demo AT recovery helper module is registered</span>
<span xmlns="" class="line">​</span>        DemoATRecoveryModule.<span xmlns="" class="perl_Function">unregister</span>();
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Book a number of seats in the restaurant</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Enrols a Participant if necessary, then passes</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * the call through to the business logic.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param how_many </span><span xmlns="" class="perl_Comment">The number of seats to book</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    @WebMethod
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">bookSeats</span>(
<span xmlns="" class="line">​</span>            @<span xmlns="" class="perl_Function">WebParam</span>(name = <span xmlns="" class="perl_String">"how_many"</span>, partName = <span xmlns="" class="perl_String">"how_many"</span>)
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_DataType">int</span> how_many)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        RestaurantView restaurantView = RestaurantView.<span xmlns="" class="perl_Function">getSingletonInstance</span>();
<span xmlns="" class="line">​</span>        RestaurantManager restaurantManager = RestaurantManager.<span xmlns="" class="perl_Function">getSingletonInstance</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        String transactionId = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>        {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">// get the transaction context of this thread:</span>
<span xmlns="" class="line">​</span>            transactionId = UserTransactionFactory.<span xmlns="" class="perl_Function">userTransaction</span>().<span xmlns="" class="perl_Function">toString</span>();
<span xmlns="" class="line">​</span>            System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"RestaurantServiceAT transaction id ="</span> + transactionId);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (!restaurantManager.<span xmlns="" class="perl_Function">knowsAbout</span>(transactionId))
<span xmlns="" class="line">​</span>            {
<span xmlns="" class="line">​</span>                System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"RestaurantServiceAT - enrolling..."</span>);
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Comment">// enlist the Participant for this service:</span>
<span xmlns="" class="line">​</span>                RestaurantParticipantAT restaurantParticipant = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">RestaurantParticipantAT</span>(transactionId);
<span xmlns="" class="line">​</span>                TransactionManagerFactory.<span xmlns="" class="perl_Function">transactionManager</span>().<span xmlns="" class="perl_Function">enlistForDurableTwoPhase</span>(restaurantParticipant, <span xmlns="" class="perl_String">"org.jboss.jbossts.xts-demo:restaurantAT:"</span> + <span xmlns="" class="perl_Keyword">new</span> Uid().<span xmlns="" class="perl_Function">toString</span>());
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (Exception e)
<span xmlns="" class="line">​</span>        {
<span xmlns="" class="line">​</span>            System.<span xmlns="" class="perl_Function">err</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"bookSeats: Participant enrolment failed"</span>);
<span xmlns="" class="line">​</span>            e.<span xmlns="" class="perl_Function">printStackTrace</span>(System.<span xmlns="" class="perl_Function">err</span>);
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">return</span>;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        restaurantView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"******************************"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        restaurantView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"id:"</span> + transactionId + <span xmlns="" class="perl_String">". Received a booking request for one table of "</span> + how_many + <span xmlns="" class="perl_String">" people"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        restaurantManager.<span xmlns="" class="perl_Function">bookSeats</span>(transactionId, how_many);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        restaurantView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"Request complete</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">"</span>);
<span xmlns="" class="line">​</span>        restaurantView.<span xmlns="" class="perl_Function">updateFields</span>();
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
</pre></div></div><div class="example"><a id="idm140019176607456">
      ⁠</a><p class="title"><strong>Example C.3. TaxiServiceBA.java</strong></p><div class="example-contents"><pre class="programlisting Java"><span xmlns="" class="line">​</span>package com.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">jbosstm</span>.<span xmlns="" class="perl_Function">xts</span>.<span xmlns="" class="perl_Function">demo</span>.<span xmlns="" class="perl_Function">services</span>.<span xmlns="" class="perl_Function">taxi</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.ats.arjuna.common.Uid;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.mw.wst11.BusinessActivityManagerFactory;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.mw.wst11.BusinessActivityManager;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.wst11.BAParticipantManager;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.wst.SystemException;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.jboss.jbosstm.xts.demo.taxi.ITaxiServiceBA;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.HandlerChain;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.WebMethod;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.WebResult;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.WebService;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.soap.SOAPBinding;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * An adapter class that exposes the TaxiManager business API as a</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * transactional Web Service. Also logs events to a TaxiView object.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@author </span><span xmlns="" class="perl_Comment">Jonathan Halliday (jonathan.halliday@arjuna.com)</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@version </span><span xmlns="" class="perl_Comment">$Revision: 1.5 $</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">WebService</span>(serviceName=<span xmlns="" class="perl_String">"TaxiServiceBAService"</span>, portName=<span xmlns="" class="perl_String">"TaxiServiceBA"</span>,
<span xmlns="" class="line">​</span>        name = <span xmlns="" class="perl_String">"ITaxiServiceBA"</span>, targetNamespace = <span xmlns="" class="perl_String">"http://www.jboss.com/jbosstm/xts/demo/Taxi"</span>,
<span xmlns="" class="line">​</span>        wsdlLocation = <span xmlns="" class="perl_String">"/WEB-INF/wsdl/TaxiServiceBA.wsdl"</span>)
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">HandlerChain</span>(file = <span xmlns="" class="perl_String">"../context-handlers.xml"</span>, name = <span xmlns="" class="perl_String">"Context Handlers"</span>)
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">SOAPBinding</span>(style=SOAPBinding.<span xmlns="" class="perl_Function">Style</span>.<span xmlns="" class="perl_Function">RPC</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> TaxiServiceBA <span xmlns="" class="perl_Keyword">implements</span> ITaxiServiceBA
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Book a taxi</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Enrols a Participant if necessary and passes</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * the call through to the business logic.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">true on success, false otherwise.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    @WebMethod
<span xmlns="" class="line">​</span>    @<span xmlns="" class="perl_Function">WebResult</span>(name = <span xmlns="" class="perl_String">"bookTaxiBAResponse"</span>, partName = <span xmlns="" class="perl_String">"bookTaxiBAResponse"</span>)
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">bookTaxi</span>()
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        TaxiView taxiView = TaxiView.<span xmlns="" class="perl_Function">getSingletonInstance</span>();
<span xmlns="" class="line">​</span>        TaxiManager taxiManager = TaxiManager.<span xmlns="" class="perl_Function">getSingletonInstance</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        BusinessActivityManager activityManager = BusinessActivityManagerFactory.<span xmlns="" class="perl_Function">businessActivityManager</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// get the transaction context of this thread:</span>
<span xmlns="" class="line">​</span>        String transactionId = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>        {
<span xmlns="" class="line">​</span>            transactionId = activityManager.<span xmlns="" class="perl_Function">currentTransaction</span>().<span xmlns="" class="perl_Function">toString</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (SystemException e)
<span xmlns="" class="line">​</span>        {
<span xmlns="" class="line">​</span>            System.<span xmlns="" class="perl_Function">err</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"bookTaxi: unable to obtain a transaction context!"</span>);
<span xmlns="" class="line">​</span>            e.<span xmlns="" class="perl_Function">printStackTrace</span>(System.<span xmlns="" class="perl_Function">err</span>);
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// log the event:</span>
<span xmlns="" class="line">​</span>        System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"TaxiServiceBA transaction id ="</span> + transactionId);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        taxiView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"******************************"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        taxiView.<span xmlns="" class="perl_Function">addPrepareMessage</span>(<span xmlns="" class="perl_String">"id:"</span> + transactionId.<span xmlns="" class="perl_Function">toString</span>() + <span xmlns="" class="perl_String">". Received a taxi booking request"</span>);
<span xmlns="" class="line">​</span>        taxiView.<span xmlns="" class="perl_Function">updateFields</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// invoke the backend business logic:</span>
<span xmlns="" class="line">​</span>        taxiManager.<span xmlns="" class="perl_Function">bookTaxi</span>(transactionId);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// attempt to finalise the booking</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> (taxiManager.<span xmlns="" class="perl_Function">prepareTaxi</span>(transactionId))
<span xmlns="" class="line">​</span>        {
<span xmlns="" class="line">​</span>            taxiView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"id:"</span> + transactionId + <span xmlns="" class="perl_String">". Seats prepared, trying to commit and enlist compensation Participant"</span>);
<span xmlns="" class="line">​</span>            taxiView.<span xmlns="" class="perl_Function">updateFields</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">// it worked, so now we need a participant enlisted in case of compensation:</span>
<span xmlns="" class="line">​</span>            TaxiParticipantBA taxiParticipant = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">TaxiParticipantBA</span>(transactionId);
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">// enlist the Participant for this service:</span>
<span xmlns="" class="line">​</span>            BAParticipantManager participantManager = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>            {
<span xmlns="" class="line">​</span>                participantManager = activityManager.<span xmlns="" class="perl_Function">enlistForBusinessAgreementWithParticipantCompletion</span>(taxiParticipant, <span xmlns="" class="perl_String">"org.jboss.jbossts.xts-demo:restaurantBA:"</span> + <span xmlns="" class="perl_Keyword">new</span> Uid().<span xmlns="" class="perl_Function">toString</span>());
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">catch</span> (Exception e)
<span xmlns="" class="line">​</span>            {
<span xmlns="" class="line">​</span>                taxiView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"id:"</span> + transactionId + <span xmlns="" class="perl_String">". Participant enrolement failed"</span>);
<span xmlns="" class="line">​</span>                taxiManager.<span xmlns="" class="perl_Function">cancelTaxi</span>(transactionId);
<span xmlns="" class="line">​</span>                System.<span xmlns="" class="perl_Function">err</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"bookTaxi: Participant enrolment failed"</span>);
<span xmlns="" class="line">​</span>                e.<span xmlns="" class="perl_Function">printStackTrace</span>(System.<span xmlns="" class="perl_Function">err</span>);
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">// finish the booking in the backend ensuring it is compensatable:</span>
<span xmlns="" class="line">​</span>            taxiManager.<span xmlns="" class="perl_Function">commitTaxi</span>(transactionId, <span xmlns="" class="perl_Keyword">true</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>            {
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Comment">// tell the manager we have finished our work:</span>
<span xmlns="" class="line">​</span>                participantManager.<span xmlns="" class="perl_Function">completed</span>();
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">catch</span> (Exception e)
<span xmlns="" class="line">​</span>            {
<span xmlns="" class="line">​</span>                System.<span xmlns="" class="perl_Function">err</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"bookTaxi: 'completed' callback failed"</span>);
<span xmlns="" class="line">​</span>                taxiManager.<span xmlns="" class="perl_Function">cancelTaxi</span>(transactionId);
<span xmlns="" class="line">​</span>                e.<span xmlns="" class="perl_Function">printStackTrace</span>(System.<span xmlns="" class="perl_Function">err</span>);
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">else</span>
<span xmlns="" class="line">​</span>        {
<span xmlns="" class="line">​</span>            taxiView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"id:"</span> + transactionId + <span xmlns="" class="perl_String">". Failed to reserve taxi. Cancelling."</span>);
<span xmlns="" class="line">​</span>            taxiManager.<span xmlns="" class="perl_Function">cancelTaxi</span>(transactionId);
<span xmlns="" class="line">​</span>            taxiView.<span xmlns="" class="perl_Function">updateFields</span>();
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        taxiView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"Request complete</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">"</span>);
<span xmlns="" class="line">​</span>        taxiView.<span xmlns="" class="perl_Function">updateFields</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>
</pre></div></div><div class="example"><a id="idm140019157483856">
      ⁠</a><p class="title"><strong>Example C.4. TaxiServiceAT.java</strong></p><div class="example-contents"><pre class="programlisting Java"><span xmlns="" class="line">​</span>package com.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">jbosstm</span>.<span xmlns="" class="perl_Function">xts</span>.<span xmlns="" class="perl_Function">demo</span>.<span xmlns="" class="perl_Function">services</span>.<span xmlns="" class="perl_Function">taxi</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.ats.arjuna.common.Uid;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.mw.wst11.TransactionManagerFactory;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.mw.wst11.UserTransactionFactory;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.jboss.jbosstm.xts.demo.taxi.ITaxiServiceAT;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.jboss.jbosstm.xts.demo.services.recovery.DemoATRecoveryModule;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.WebService;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.HandlerChain;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.WebMethod;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.soap.SOAPBinding;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.annotation.PostConstruct;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.annotation.PreDestroy;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * An adapter class that exposes the TaxiManager business API as a</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * transactional Web Service. Also logs events to a TaxiView object.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@author </span><span xmlns="" class="perl_Comment">Jonathan Halliday (jonathan.halliday@arjuna.com)</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@version </span><span xmlns="" class="perl_Comment">$Revision: 1.3 $</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">WebService</span>(serviceName=<span xmlns="" class="perl_String">"TaxiServiceATService"</span>, portName=<span xmlns="" class="perl_String">"TaxiServiceAT"</span>,
<span xmlns="" class="line">​</span>        name = <span xmlns="" class="perl_String">"ITaxiServiceAT"</span>, targetNamespace = <span xmlns="" class="perl_String">"http://www.jboss.com/jbosstm/xts/demo/Taxi"</span>,
<span xmlns="" class="line">​</span>        wsdlLocation = <span xmlns="" class="perl_String">"/WEB-INF/wsdl/TaxiServiceAT.wsdl"</span>)
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">HandlerChain</span>(file = <span xmlns="" class="perl_String">"../context-handlers.xml"</span>, name = <span xmlns="" class="perl_String">"Context Handlers"</span>)
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">SOAPBinding</span>(style=SOAPBinding.<span xmlns="" class="perl_Function">Style</span>.<span xmlns="" class="perl_Function">RPC</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> TaxiServiceAT <span xmlns="" class="perl_Keyword">implements</span> ITaxiServiceAT
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * ensure that the recovery module for the dmeo is installed</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    @PostConstruct
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">postConstruct</span>()
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// ensure that the xts-demo AT recovery helper module is registered</span>
<span xmlns="" class="line">​</span>        DemoATRecoveryModule.<span xmlns="" class="perl_Function">register</span>();
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * ensure that the recovery module for the dmeo is deinstalled</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    @PreDestroy
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">preDestroy</span>()
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// ensure that the xts-demo AT recovery helper module is registered</span>
<span xmlns="" class="line">​</span>        DemoATRecoveryModule.<span xmlns="" class="perl_Function">unregister</span>();
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Book a taxi</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Enrols a Participant if necessary, then passes</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * the call through to the business logic.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    @WebMethod
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">bookTaxi</span>()
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        TaxiView taxiView = TaxiView.<span xmlns="" class="perl_Function">getSingletonInstance</span>();
<span xmlns="" class="line">​</span>        TaxiManager taxiManager = TaxiManager.<span xmlns="" class="perl_Function">getSingletonInstance</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        String transactionId = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>        {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">// get the transaction context of this thread:</span>
<span xmlns="" class="line">​</span>            transactionId = UserTransactionFactory.<span xmlns="" class="perl_Function">userTransaction</span>().<span xmlns="" class="perl_Function">toString</span>();
<span xmlns="" class="line">​</span>            System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"TaxiServiceAT transaction id ="</span> + transactionId);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (!taxiManager.<span xmlns="" class="perl_Function">knowsAbout</span>(transactionId))
<span xmlns="" class="line">​</span>            {
<span xmlns="" class="line">​</span>                System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"TaxiServiceAT - enrolling..."</span>);
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Comment">// enlist the Participant for this service:</span>
<span xmlns="" class="line">​</span>                TaxiParticipantAT taxiParticipant = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">TaxiParticipantAT</span>(transactionId);
<span xmlns="" class="line">​</span>                TransactionManagerFactory.<span xmlns="" class="perl_Function">transactionManager</span>().<span xmlns="" class="perl_Function">enlistForDurableTwoPhase</span>(taxiParticipant, <span xmlns="" class="perl_String">"org.jboss.jbossts.xts-demo:taxiAT:"</span> + <span xmlns="" class="perl_Keyword">new</span> Uid().<span xmlns="" class="perl_Function">toString</span>());
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (Exception e)
<span xmlns="" class="line">​</span>        {
<span xmlns="" class="line">​</span>            System.<span xmlns="" class="perl_Function">err</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"bookTaxi: Participant enrolment failed"</span>);
<span xmlns="" class="line">​</span>            e.<span xmlns="" class="perl_Function">printStackTrace</span>(System.<span xmlns="" class="perl_Function">err</span>);
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">return</span>;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        taxiView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"******************************"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        taxiView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"id:"</span> + transactionId.<span xmlns="" class="perl_Function">toString</span>() + <span xmlns="" class="perl_String">". Received a taxi booking request"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        TaxiManager.<span xmlns="" class="perl_Function">getSingletonInstance</span>().<span xmlns="" class="perl_Function">bookTaxi</span>(transactionId);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        taxiView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"Request complete</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">"</span>);
<span xmlns="" class="line">​</span>        taxiView.<span xmlns="" class="perl_Function">updateFields</span>();
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>
</pre></div></div><div class="example"><a id="idm140019161087264">
      ⁠</a><p class="title"><strong>Example C.5. TheatreServiceAT.java</strong></p><div class="example-contents"><pre class="programlisting Java"><span xmlns="" class="line">​</span>package com.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">jbosstm</span>.<span xmlns="" class="perl_Function">xts</span>.<span xmlns="" class="perl_Function">demo</span>.<span xmlns="" class="perl_Function">services</span>.<span xmlns="" class="perl_Function">theatre</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.ats.arjuna.common.Uid;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.mw.wst11.TransactionManagerFactory;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.arjuna.mw.wst11.UserTransactionFactory;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.jboss.jbosstm.xts.demo.theatre.ITheatreServiceAT;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import com.jboss.jbosstm.xts.demo.services.recovery.DemoATRecoveryModule;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.WebService;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.WebParam;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.HandlerChain;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.WebMethod;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.jws.soap.SOAPBinding;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.annotation.PostConstruct;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.annotation.PreDestroy;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * An adapter class that exposes the TheatreManager business API as a</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * transactional Web Service. Also logs events to a TheatreView object.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@author </span><span xmlns="" class="perl_Comment">Jonathan Halliday (jonathan.halliday@arjuna.com)</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span><span xmlns="" class="perl_Keyword">@version </span><span xmlns="" class="perl_Comment">$Revision: 1.3 $</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">WebService</span>(serviceName=<span xmlns="" class="perl_String">"TheatreServiceATService"</span>, portName=<span xmlns="" class="perl_String">"TheatreServiceAT"</span>,
<span xmlns="" class="line">​</span>        name = <span xmlns="" class="perl_String">"ITheatreServiceAT"</span>, targetNamespace = <span xmlns="" class="perl_String">"http://www.jboss.com/jbosstm/xts/demo/Theatre"</span>,
<span xmlns="" class="line">​</span>        wsdlLocation = <span xmlns="" class="perl_String">"/WEB-INF/wsdl/TheatreServiceAT.wsdl"</span>)
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">HandlerChain</span>(file = <span xmlns="" class="perl_String">"../context-handlers.xml"</span>, name = <span xmlns="" class="perl_String">"Context Handlers"</span>)
<span xmlns="" class="line">​</span>@<span xmlns="" class="perl_Function">SOAPBinding</span>(style=SOAPBinding.<span xmlns="" class="perl_Function">Style</span>.<span xmlns="" class="perl_Function">RPC</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> TheatreServiceAT <span xmlns="" class="perl_Keyword">implements</span> ITheatreServiceAT
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * ensure that the recovery module for the dmeo is installed</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    @PostConstruct
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">postConstruct</span>()
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// ensure that the xts-demo AT recovery helper module is registered</span>
<span xmlns="" class="line">​</span>        DemoATRecoveryModule.<span xmlns="" class="perl_Function">register</span>();
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * ensure that the recovery module for the dmeo is deinstalled</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    @PreDestroy
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">preDestroy</span>()
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// ensure that the xts-demo AT recovery helper module is registered</span>
<span xmlns="" class="line">​</span>        DemoATRecoveryModule.<span xmlns="" class="perl_Function">unregister</span>();
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Book a number of seats in the Theatre</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Enrols a Participant if necessary, then passes</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * the call through to the business logic.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param how_many </span><span xmlns="" class="perl_Comment">  The number of seats to book</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param which_area </span><span xmlns="" class="perl_Comment">The area of the theatre to book seats in</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    @WebMethod
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">bookSeats</span>(
<span xmlns="" class="line">​</span>        @<span xmlns="" class="perl_Function">WebParam</span>(name = <span xmlns="" class="perl_String">"how_many"</span>, partName = <span xmlns="" class="perl_String">"how_many"</span>)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_DataType">int</span> how_many,
<span xmlns="" class="line">​</span>        @<span xmlns="" class="perl_Function">WebParam</span>(name = <span xmlns="" class="perl_String">"which_area"</span>, partName = <span xmlns="" class="perl_String">"which_area"</span>)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_DataType">int</span> which_area)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        TheatreView theatreView = TheatreView.<span xmlns="" class="perl_Function">getSingletonInstance</span>();
<span xmlns="" class="line">​</span>        TheatreManager theatreManager = TheatreManager.<span xmlns="" class="perl_Function">getSingletonInstance</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        String transactionId = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>        {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">// get the transaction context of this thread:</span>
<span xmlns="" class="line">​</span>            transactionId = UserTransactionFactory.<span xmlns="" class="perl_Function">userTransaction</span>().<span xmlns="" class="perl_Function">toString</span>();
<span xmlns="" class="line">​</span>            System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"TheatreServiceAT transaction id ="</span> + transactionId);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (!theatreManager.<span xmlns="" class="perl_Function">knowsAbout</span>(transactionId))
<span xmlns="" class="line">​</span>            {
<span xmlns="" class="line">​</span>                System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"theatreService - enrolling..."</span>);
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Comment">// enlist the Participant for this service:</span>
<span xmlns="" class="line">​</span>                TheatreParticipantAT theatreParticipant = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">TheatreParticipantAT</span>(transactionId);
<span xmlns="" class="line">​</span>                TransactionManagerFactory.<span xmlns="" class="perl_Function">transactionManager</span>().<span xmlns="" class="perl_Function">enlistForDurableTwoPhase</span>(theatreParticipant, <span xmlns="" class="perl_String">"org.jboss.jbossts.xts-demo:theatreAT:"</span> + <span xmlns="" class="perl_Keyword">new</span> Uid().<span xmlns="" class="perl_Function">toString</span>());
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (Exception e)
<span xmlns="" class="line">​</span>        {
<span xmlns="" class="line">​</span>            System.<span xmlns="" class="perl_Function">err</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"bookSeats: Participant enrolment failed"</span>);
<span xmlns="" class="line">​</span>            e.<span xmlns="" class="perl_Function">printStackTrace</span>(System.<span xmlns="" class="perl_Function">err</span>);
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">return</span>;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        theatreView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"******************************"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        theatreView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"id:"</span> + transactionId.<span xmlns="" class="perl_Function">toString</span>() + <span xmlns="" class="perl_String">". Received a theatre booking request for "</span> + how_many + <span xmlns="" class="perl_String">" seats in area "</span> + which_area);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        TheatreManager.<span xmlns="" class="perl_Function">getSingletonInstance</span>().<span xmlns="" class="perl_Function">bookSeats</span>(transactionId, how_many, which_area);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        theatreView.<span xmlns="" class="perl_Function">addMessage</span>(<span xmlns="" class="perl_String">"Request complete</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">"</span>);
<span xmlns="" class="line">​</span>        theatreView.<span xmlns="" class="perl_Function">updateFields</span>();
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>
</pre></div></div></div></body></html>