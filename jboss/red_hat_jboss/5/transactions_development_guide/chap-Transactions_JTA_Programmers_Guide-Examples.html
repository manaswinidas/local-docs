<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 6. Examples</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="chap-Transactions_JTA_Programmers_Guide-Examples">
      ⁠</a>Chapter 6. Examples</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Transactions_JTA_Programmers_Guide-Examples-JDBC_example">
      ⁠</a>6.1. JDBC example</h1></div></div></div><div class="para">
			The example in <a class="xref" href="chap-Transactions_JTA_Programmers_Guide-Examples.html#example-JDBCTest">Example 6.1, “JDBCTest Example”</a> illustrates many of the points described in the JDBC chapter. Refer back to it for more information.
		</div><div class="example"><a id="example-JDBCTest">
      ⁠</a><p class="title"><strong>Example 6.1. JDBCTest Example</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> JDBCTest
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">main</span> (String[] args)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Comment">/*</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">	 */</span>
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	Connection conn = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>	Connection conn2 = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>	Statement stmt = <span xmlns="" class="perl_Keyword">null</span>;        <span xmlns="" class="perl_Comment">// non-tx statement</span>
<span xmlns="" class="line">​</span>	Statement stmtx = <span xmlns="" class="perl_Keyword">null</span>;	<span xmlns="" class="perl_Comment">// will be a tx-statement</span>
<span xmlns="" class="line">​</span>	Properties dbProperties = <span xmlns="" class="perl_Keyword">new</span> Properties();
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>	    {
<span xmlns="" class="line">​</span>		System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">Creating connection to database: "</span>+url);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Comment">/*</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">		 * Create conn and conn2 so that they are bound to the JBossTS</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">		 * transactional JDBC driver. The details of how to do this will</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">		 * depend on your environment, the database you wish to use and</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">		 * whether or not you want to use the Direct or JNDI approach. See</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">		 * the appropriate chapter in the JTA Programmers Guide.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">		 */</span>
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>		stmt = conn.<span xmlns="" class="perl_Function">createStatement</span>();  <span xmlns="" class="perl_Comment">// non-tx statement</span>
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>		    {
<span xmlns="" class="line">​</span>			stmt.<span xmlns="" class="perl_Function">executeUpdate</span>(<span xmlns="" class="perl_String">"DROP TABLE test_table"</span>);
<span xmlns="" class="line">​</span>			stmt.<span xmlns="" class="perl_Function">executeUpdate</span>(<span xmlns="" class="perl_String">"DROP TABLE test_table2"</span>);
<span xmlns="" class="line">​</span>		    }
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">catch</span> (Exception e)
<span xmlns="" class="line">​</span>		    {
<span xmlns="" class="line">​</span>			<span xmlns="" class="perl_Comment">// assume not in database.</span>
<span xmlns="" class="line">​</span>		    }
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>		    {
<span xmlns="" class="line">​</span>			stmt.<span xmlns="" class="perl_Function">executeUpdate</span>(<span xmlns="" class="perl_String">"CREATE TABLE test_table (a INTEGER,b INTEGER)"</span>);
<span xmlns="" class="line">​</span>			stmt.<span xmlns="" class="perl_Function">executeUpdate</span>(<span xmlns="" class="perl_String">"CREATE TABLE test_table2 (a INTEGER,b INTEGER)"</span>);
<span xmlns="" class="line">​</span>		    }
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">catch</span> (Exception e)
<span xmlns="" class="line">​</span>		    {
<span xmlns="" class="line">​</span>		    }
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>		    {
<span xmlns="" class="line">​</span>			System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"Starting top-level transaction."</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			com.<span xmlns="" class="perl_Function">arjuna</span>.<span xmlns="" class="perl_Function">ats</span>.<span xmlns="" class="perl_Function">jta</span>.<span xmlns="" class="perl_Function">UserTransaction</span>.<span xmlns="" class="perl_Function">userTransaction</span>().<span xmlns="" class="perl_Function">begin</span>();
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			stmtx = conn.<span xmlns="" class="perl_Function">createStatement</span>(); <span xmlns="" class="perl_Comment">// will be a tx-statement</span>
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">Adding entries to table 1."</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			stmtx.<span xmlns="" class="perl_Function">executeUpdate</span>(<span xmlns="" class="perl_String">"INSERT INTO test_table (a, b) VALUES (1,2)"</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			ResultSet res1 = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">Inspecting table 1."</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			res1 = stmtx.<span xmlns="" class="perl_Function">executeQuery</span>(<span xmlns="" class="perl_String">"SELECT * FROM test_table"</span>);
<span xmlns="" class="line">​</span>			<span xmlns="" class="perl_Keyword">while</span> (res1.<span xmlns="" class="perl_Function">next</span>())
<span xmlns="" class="line">​</span>			    {
<span xmlns="" class="line">​</span>				System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"Column 1: "</span>+res1.<span xmlns="" class="perl_Function">getInt</span>(<span xmlns="" class="perl_Float">1</span>));
<span xmlns="" class="line">​</span>				System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"Column 2: "</span>+res1.<span xmlns="" class="perl_Function">getInt</span>(<span xmlns="" class="perl_Float">2</span>));
<span xmlns="" class="line">​</span>			    }
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">Adding entries to table 2."</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			stmtx.<span xmlns="" class="perl_Function">executeUpdate</span>(<span xmlns="" class="perl_String">"INSERT INTO test_table2 (a, b) VALUES (3,4)"</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			res1 = stmtx.<span xmlns="" class="perl_Function">executeQuery</span>(<span xmlns="" class="perl_String">"SELECT * FROM test_table2"</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">Inspecting table 2."</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			<span xmlns="" class="perl_Keyword">while</span> (res1.<span xmlns="" class="perl_Function">next</span>())
<span xmlns="" class="line">​</span>			    {
<span xmlns="" class="line">​</span>				System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"Column 1: "</span>+res1.<span xmlns="" class="perl_Function">getInt</span>(<span xmlns="" class="perl_Float">1</span>));
<span xmlns="" class="line">​</span>				System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"Column 2: "</span>+res1.<span xmlns="" class="perl_Function">getInt</span>(<span xmlns="" class="perl_Float">2</span>));
<span xmlns="" class="line">​</span>			    }
<span xmlns="" class="line">​</span>			System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">print</span>(<span xmlns="" class="perl_String">"</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">Now attempting to rollback changes."</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			com.<span xmlns="" class="perl_Function">arjuna</span>.<span xmlns="" class="perl_Function">ats</span>.<span xmlns="" class="perl_Function">jta</span>.<span xmlns="" class="perl_Function">UserTransaction</span>.<span xmlns="" class="perl_Function">userTransaction</span>().<span xmlns="" class="perl_Function">rollback</span>();
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			com.<span xmlns="" class="perl_Function">arjuna</span>.<span xmlns="" class="perl_Function">ats</span>.<span xmlns="" class="perl_Function">jta</span>.<span xmlns="" class="perl_Function">UserTransaction</span>.<span xmlns="" class="perl_Function">userTransaction</span>().<span xmlns="" class="perl_Function">begin</span>();
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			stmtx = conn.<span xmlns="" class="perl_Function">createStatement</span>();
<span xmlns="" class="line">​</span>			ResultSet res2 = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">Now checking state of table 1."</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			res2 = stmtx.<span xmlns="" class="perl_Function">executeQuery</span>(<span xmlns="" class="perl_String">"SELECT * FROM test_table"</span>);
<span xmlns="" class="line">​</span>			<span xmlns="" class="perl_Keyword">while</span> (res2.<span xmlns="" class="perl_Function">next</span>())
<span xmlns="" class="line">​</span>			    {
<span xmlns="" class="line">​</span>				System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"Column 1: "</span>+res2.<span xmlns="" class="perl_Function">getInt</span>(<span xmlns="" class="perl_Float">1</span>));
<span xmlns="" class="line">​</span>				System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"Column 2: "</span>+res2.<span xmlns="" class="perl_Function">getInt</span>(<span xmlns="" class="perl_Float">2</span>));
<span xmlns="" class="line">​</span>			    }
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">Now checking state of table 2."</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			stmtx = conn.<span xmlns="" class="perl_Function">createStatement</span>();
<span xmlns="" class="line">​</span>			res2 = stmtx.<span xmlns="" class="perl_Function">executeQuery</span>(<span xmlns="" class="perl_String">"SELECT * FROM test_table2"</span>);
<span xmlns="" class="line">​</span>			<span xmlns="" class="perl_Keyword">while</span> (res2.<span xmlns="" class="perl_Function">next</span>())
<span xmlns="" class="line">​</span>			    {
<span xmlns="" class="line">​</span>				System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"Column 1: "</span>+res2.<span xmlns="" class="perl_Function">getInt</span>(<span xmlns="" class="perl_Float">1</span>));
<span xmlns="" class="line">​</span>				System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"Column 2: "</span>+res2.<span xmlns="" class="perl_Function">getInt</span>(<span xmlns="" class="perl_Float">2</span>));
<span xmlns="" class="line">​</span>			    }
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>			com.<span xmlns="" class="perl_Function">arjuna</span>.<span xmlns="" class="perl_Function">ats</span>.<span xmlns="" class="perl_Function">jta</span>.<span xmlns="" class="perl_Function">UserTransaction</span>.<span xmlns="" class="perl_Function">userTransaction</span>().<span xmlns="" class="perl_Function">commit</span>(<span xmlns="" class="perl_Keyword">true</span>);
<span xmlns="" class="line">​</span>		    }
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">catch</span> (Exception ex)
<span xmlns="" class="line">​</span>		    {
<span xmlns="" class="line">​</span>			ex.<span xmlns="" class="perl_Function">printStackTrace</span>();
<span xmlns="" class="line">​</span>			System.<span xmlns="" class="perl_Function">exit</span>(<span xmlns="" class="perl_Float">0</span>);
<span xmlns="" class="line">​</span>		    }
<span xmlns="" class="line">​</span>	    }
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">catch</span> (Exception sysEx)
<span xmlns="" class="line">​</span>	    {
<span xmlns="" class="line">​</span>		sysEx.<span xmlns="" class="perl_Function">printStackTrace</span>();
<span xmlns="" class="line">​</span>		System.<span xmlns="" class="perl_Function">exit</span>(<span xmlns="" class="perl_Float">0</span>);
<span xmlns="" class="line">​</span>	    }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Transactions_JTA_Programmers_Guide-Examples-Failure_recovery_example_with_BasicXARecovery">
      ⁠</a>6.2. BasicXARecovery Example for Failure Recovery</h1></div></div></div><div class="para">
			This class implements the <code class="interfacename">XAResourceRecovery</code> interface for <code class="interfacename">XAResources</code>. The parameter supplied in setParameters can contain arbitrary information necessary to initialize the class once created. Here, it contains the name of the property file containing database connection information, as well as the number of connections that this file knows about. Values are separated by semi-colons.
		</div><div class="para">
			It is important to understand that this is only an example, and does not contain everything which the <code class="interfacename">XAResourceRecovery</code> is capable of. In real life, it is not recommended to store database connection information such as user names and passwords in a raw text file, as this example does.
		</div><div class="para">
			The db parameters specified in the property file are assumed to be in the format:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					DB_x_DatabaseURL=
				</div></li><li class="listitem"><div class="para">
					DB_x_DatabaseUser=
				</div></li><li class="listitem"><div class="para">
					DB_x_DatabasePassword=
				</div></li><li class="listitem"><div class="para">
					DB_x_DatabaseDynamicClass=
				</div></li></ul></div><div class="para">
			Where x is the number of the connection information.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				Some error handling code has been removed from this text to make it more concise.
			</div></div></div><div class="example"><a id="example-XAResourceRecovery">
      ⁠</a><p class="title"><strong>Example 6.2. XAResourceRecovery Example</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/*</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * Some XAResourceRecovery implementations will do their startup work here,</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * and then do little or nothing in setDetails. Since this one needs to know</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * dynamic class name, the constructor does nothing.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Function">BasicXARecovery</span> () <span xmlns="" class="perl_Keyword">throws</span> SQLException
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    numberOfConnections = <span xmlns="" class="perl_Float">1</span>;
<span xmlns="" class="line">​</span>    connectionIndex = <span xmlns="" class="perl_Float">0</span>;
<span xmlns="" class="line">​</span>    props = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/*</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * The recovery module will have chopped off this class name already. The</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * parameter should specify a property file from which the url, user name,</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * password, etc. can be read.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * @message com.arjuna.ats.internal.jdbc.recovery.initexp An exception</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *          occurred during initialisation.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">initialise</span> (String parameter) <span xmlns="" class="perl_Keyword">throws</span> SQLException
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">if</span> (parameter == <span xmlns="" class="perl_Keyword">null</span>) 
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">int</span> breakPosition = parameter.<span xmlns="" class="perl_Function">indexOf</span>(BREAKCHARACTER);
<span xmlns="" class="line">​</span>    String fileName = parameter;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">if</span> (breakPosition != <span xmlns="" class="perl_DecVal">-1</span>)
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    fileName = parameter.<span xmlns="" class="perl_Function">substring</span>(<span xmlns="" class="perl_Float">0</span>, breakPosition - <span xmlns="" class="perl_Float">1</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>		{
<span xmlns="" class="line">​</span>		    numberOfConnections = Integer.<span xmlns="" class="perl_Function">parseInt</span>(parameter.<span xmlns="" class="perl_Function">substring</span>(breakPosition + <span xmlns="" class="perl_Float">1</span>));
<span xmlns="" class="line">​</span>		}
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">catch</span> (NumberFormatException e)
<span xmlns="" class="line">​</span>		{
<span xmlns="" class="line">​</span>		    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>		}
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    String uri = com.<span xmlns="" class="perl_Function">arjuna</span>.<span xmlns="" class="perl_Function">common</span>.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">FileLocator</span>.<span xmlns="" class="perl_Function">locateFile</span>(fileName);
<span xmlns="" class="line">​</span>	    jdbcPropertyManager.<span xmlns="" class="perl_Function">propertyManager</span>.<span xmlns="" class="perl_Function">load</span>(XMLFilePlugin.<span xmlns="" class="perl_Function">class</span>.<span xmlns="" class="perl_Function">getName</span>(), uri);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    props = jdbcPropertyManager.<span xmlns="" class="perl_Function">propertyManager</span>.<span xmlns="" class="perl_Function">getProperties</span>();
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">catch</span> (Exception e)
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/*</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * @message com.arjuna.ats.internal.jdbc.recovery.xarec {0} could not find</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *          information for connection!</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> XAResource <span xmlns="" class="perl_Function">getXAResource</span> () <span xmlns="" class="perl_Keyword">throws</span> SQLException
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    JDBC2RecoveryConnection conn = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">if</span> (<span xmlns="" class="perl_Function">hasMoreResources</span>())
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    connectionIndex++;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    conn = <span xmlns="" class="perl_Function">getStandardConnection</span>();
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">if</span> (conn == <span xmlns="" class="perl_Keyword">null</span>) conn = <span xmlns="" class="perl_Function">getJNDIConnection</span>();
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">return</span> conn.<span xmlns="" class="perl_Function">recoveryConnection</span>().<span xmlns="" class="perl_Function">getConnection</span>().<span xmlns="" class="perl_Function">getXAResource</span>();
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">hasMoreResources</span> ()
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">if</span> (connectionIndex == numberOfConnections) 
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">else</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">final</span> JDBC2RecoveryConnection <span xmlns="" class="perl_Function">getStandardConnection</span> ()
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">throws</span> SQLException
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    String number = <span xmlns="" class="perl_Keyword">new</span> String(<span xmlns="" class="perl_String">""</span> + connectionIndex);
<span xmlns="" class="line">​</span>    String url = <span xmlns="" class="perl_Keyword">new</span> String(dbTag + number + urlTag);
<span xmlns="" class="line">​</span>    String password = <span xmlns="" class="perl_Keyword">new</span> String(dbTag + number + passwordTag);
<span xmlns="" class="line">​</span>    String user = <span xmlns="" class="perl_Keyword">new</span> String(dbTag + number + userTag);
<span xmlns="" class="line">​</span>    String dynamicClass = <span xmlns="" class="perl_Keyword">new</span> String(dbTag + number + dynamicClassTag);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    Properties dbProperties = <span xmlns="" class="perl_Keyword">new</span> Properties();
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    String theUser = props.<span xmlns="" class="perl_Function">getProperty</span>(user);
<span xmlns="" class="line">​</span>    String thePassword = props.<span xmlns="" class="perl_Function">getProperty</span>(password);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">if</span> (theUser != <span xmlns="" class="perl_Keyword">null</span>)
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    dbProperties.<span xmlns="" class="perl_Function">put</span>(TransactionalDriver.<span xmlns="" class="perl_Function">userName</span>, theUser);
<span xmlns="" class="line">​</span>	    dbProperties.<span xmlns="" class="perl_Function">put</span>(TransactionalDriver.<span xmlns="" class="perl_Function">password</span>, thePassword);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    String dc = props.<span xmlns="" class="perl_Function">getProperty</span>(dynamicClass);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">if</span> (dc != <span xmlns="" class="perl_Keyword">null</span>)
<span xmlns="" class="line">​</span>		dbProperties.<span xmlns="" class="perl_Function">put</span>(TransactionalDriver.<span xmlns="" class="perl_Function">dynamicClass</span>, dc);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">JDBC2RecoveryConnection</span>(url, dbProperties);
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">else</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">final</span> JDBC2RecoveryConnection <span xmlns="" class="perl_Function">getJNDIConnection</span> ()
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">throws</span> SQLException
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    String number = <span xmlns="" class="perl_Keyword">new</span> String(<span xmlns="" class="perl_String">""</span> + connectionIndex);
<span xmlns="" class="line">​</span>    String url = <span xmlns="" class="perl_Keyword">new</span> String(dbTag + jndiTag + number + urlTag);
<span xmlns="" class="line">​</span>    String password = <span xmlns="" class="perl_Keyword">new</span> String(dbTag + jndiTag + number + passwordTag);
<span xmlns="" class="line">​</span>    String user = <span xmlns="" class="perl_Keyword">new</span> String(dbTag + jndiTag + number + userTag);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    Properties dbProperties = <span xmlns="" class="perl_Keyword">new</span> Properties();
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    String theUser = props.<span xmlns="" class="perl_Function">getProperty</span>(user);
<span xmlns="" class="line">​</span>    String thePassword = props.<span xmlns="" class="perl_Function">getProperty</span>(password);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">if</span> (theUser != <span xmlns="" class="perl_Keyword">null</span>)
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    dbProperties.<span xmlns="" class="perl_Function">put</span>(TransactionalDriver.<span xmlns="" class="perl_Function">userName</span>, theUser);
<span xmlns="" class="line">​</span>	    dbProperties.<span xmlns="" class="perl_Function">put</span>(TransactionalDriver.<span xmlns="" class="perl_Function">password</span>, thePassword);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">JDBC2RecoveryConnection</span>(url, dbProperties);
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">else</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">int</span> numberOfConnections;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">int</span> connectionIndex;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">private</span> Properties props;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> String dbTag = <span xmlns="" class="perl_String">"DB_"</span>;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> String urlTag = <span xmlns="" class="perl_String">"_DatabaseURL"</span>;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> String passwordTag = <span xmlns="" class="perl_String">"_DatabasePassword"</span>;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> String userTag = <span xmlns="" class="perl_String">"_DatabaseUser"</span>;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> String dynamicClassTag = <span xmlns="" class="perl_String">"_DatabaseDynamicClass"</span>;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> String jndiTag = <span xmlns="" class="perl_String">"JNDI_"</span>;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/*</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * Example:</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * DB2_DatabaseURL=jdbc\:arjuna\:sequelink\://qa02\:20001</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * DB2_DatabaseUser=tester2 DB2_DatabasePassword=tester</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * DB2_DatabaseDynamicClass=com.arjuna.ats.internal.jdbc.drivers.sequelink_5_1</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * DB_JNDI_DatabaseURL=jdbc\:arjuna\:jndi DB_JNDI_DatabaseUser=tester1</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * DB_JNDI_DatabasePassword=tester DB_JNDI_DatabaseName=empay</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> * DB_JNDI_Host=qa02 DB_JNDI_Port=20000</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">char</span> BREAKCHARACTER = &amp;#39;;&amp;#39;; <span xmlns="" class="perl_Comment">// delimiter for parameters</span>
<span xmlns="" class="line">​</span>
</pre></div></div><div class="para">
			The <code class="classname">com.arjuna.ats.internal.jdbc.recovery.JDBC2RecoveryConnection</code> class can create a new connection to the database using the same parameters used to create the initial connection.
		</div></div></div></body></html>