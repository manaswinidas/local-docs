<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 4. Transaction Recovery</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="chap-Transactions_JTA_Programmers_Guide-Transaction_Recovery">
      ⁠</a>Chapter 4. Transaction Recovery</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Transactions_JTA_Programmers_Guide-Transaction_Recovery-Failure_recovery">
      ⁠</a>4.1. Failure recovery</h1></div></div></div><div class="para">
			During recovery, the Transaction Manager needs the ability to communicate to all resource managers that are in use by the applications in the system. For each resource manager, the Transaction Manager uses the <code class="methodname">XAResource.recover</code> method to retrieve the list of transactions currently in a <code class="literal">prepared</code> or <code class="literal">heuristically completed</code> state. Typically, the system administrator configures all transactional resource factories that are used by the applications deployed on the system. The JDBC <code class="interfacename">XADataSource</code> object, for example, is a factory for the JDBC <code class="interfacename">XAConnection</code> objects.
		</div><div class="para">
			Because <code class="interfacename">XAResource</code> objects are not persistent across system failures, the Transaction Manager needs the ability to acquire the <code class="interfacename">XAResource</code> objects that represent the resource managers which might have participated in the transactions prior to a system failure. For example, a Transaction Manager might use the JNDI look-up mechanism to acquire a connection from each of the transactional resource factories, and then obtain the corresponding <code class="code">XAResource</code> object for each connection. The Transaction Manager then invokes the <code class="methodname">XAResource.recover</code> method to ask each resource manager to return the transactions that are currently in a <code class="literal">prepared</code> or <code class="literal">heuristically completed</code> state.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				When running XA recovery, you must tell JBoss Transaction Service which types of Xid it can recover. Each Xid that JBoss Transaction Service creates has a unique node identifier encoded within it, and JBoss Transaction Service only recovers transactions and states that match the requested node identifier. The node identifier to use should be provided to JBoss Transaction Service in a property that starts with the name <span class="property">com.arjuna.ats.jta.xaRecoveryNode</span>. Multiple values are allowed. A value of <code class="literal">*</code> forces recovery, and possibly rollback, of all transactions, regardless of their node identifier. Use it with caution.
			</div></div></div><div class="para">
			If the JBossJTA JDBC 2.0 driver is in use, JBossJTA manages all <code class="interfacename">XAResource</code> crash recovery automatically. Otherwise one, of the following recovery mechanisms is used:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					If the <code class="code">XAResource</code> is able to be serialized, then the serialized form will be saved during transaction commitment, and used during recovery. The recreated <code class="code">XAResource</code> is assumed to be valid and able to drive recovery on the associated database.
				</div></li><li class="listitem"><div class="para">
					The <code class="interfacename">com.arjuna.ats.jta.recovery.XAResourceRecovery</code>, <code class="interfacename">com.arjuna.ats.jta.recovery.XARecoveryResourceManager</code> and <code class="interfacename">com.arjuna.ats.jta.recovery.XARecoveryResource</code> interfaces are used. Refer to the JDBC chapters on failure recovery for more information.
				</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Transactions_JTA_Programmers_Guide-Transaction_Recovery-Recovering_XAConnections">
      ⁠</a>4.2. Recovering XAConnections</h1></div></div></div><div class="para">
			When recovering from failures, JBossJTA requires the ability to reconnect to databases that were in use prior to the failures, in order to resolve outstanding transactions. Most connection information is saved by the transaction service during its normal execution, and can be used during recovery to recreate the connection. However, it is possible that some of the information is lost during the failure, if the failure occurs while it is being written. In order to recreate those connections, you must provide one implementations of the JBossJTA interface <code class="interfacename">com.arjuna.ats.jta.recovery.XAResourceRecovery</code> for each database that may be used by an application.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				If you are using the transactional JDBC 2.0 driver provided with JBossJTA, no additional work is necessary in order to ensure that recovery occurs.
			</div></div></div><div class="para">
			To inform the recovery system about each of the <code class="code">XAResourceRecovery</code> instances, specify their class names through properties. Any property found in the <code class="filename">properties</code> file, or registered at run-time, starting with the name <span class="property">com.arjuna.ats.jta.recovery.XAResourceRecovery</span> is recognized as representing one of these instances. Its value is the class name, such as: <code class="code">com.arjuna.ats.jta.recovery.XAResourceRecoveryOracle=com.foo.barRecovery</code>
		</div><div class="para">
			Additional information to be passed to the instance at creation can be specified after a semicolon: <code class="code">com.arjuna.ats.jta.recovery.XAResourceRecoveryOracle=com.foo.barRecovery;myData=hello</code>
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				These properties should be in the JTA section of the <code class="filename">property</code> file.
			</div></div></div><div class="para">
			Any errors will be reported during recovery.
		</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> XAResourceRecovery
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> XAResource <span xmlns="" class="perl_Function">getXAResource</span> () <span xmlns="" class="perl_Keyword">throws</span> SQLException;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">initialise</span> (String p);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">hasMoreResources</span> ();
<span xmlns="" class="line">​</span>};
</pre><div class="para">
			Each method should return the following information:
		</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="methodname">initialize</code></span></dt><dd><div class="para">
						After the instance is created, any additional information found after the first semicolon in the property value definition is passed to the object. The object can use this information in an implementation-specific manner.
					</div></dd><dt><span class="term"><code class="methodname">hasMoreResources</code></span></dt><dd><div class="para">
						Each <code class="interfacename">XAResourceRecovery</code> implementation can provide multiple <code class="interfacename">XAResource</code> instances. Before calling to <code class="methodname">getXAResource</code>, <code class="methodname">hasMoreResources</code> is called to determine whether any further connections need to be obtained. If the return value is <code class="literal">false</code>, <code class="methodname">getXAResource</code> is not called called again during this recovery sweep and the instance is ignored until the next recovery scan.
					</div></dd><dt><span class="term"><code class="methodname">getXAResource</code></span></dt><dd><div class="para">
						Returns an instance of the <code class="interfacename">XAResource</code> object. How this is created (and how the parameters to its constructors are obtained) is up to the <code class="interfacename">XAResourceRecovery</code> implementation. The parameters to the constructors of this class should be similar to those used when creating the initial driver or data source, and should be sufficient to create new <code class="interfacename">XAResources</code> instances that can be used to drive recovery.
					</div></dd></dl></div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				If you want your <code class="code">XAResourceRecovery</code> instance to be called during each sweep of the recovery manager, ensure that once <code class="methodname">hasMoreResources</code> returns <code class="literal">false</code> to indicate the end of work for the current scan, it then returns <code class="literal">true</code> for the next recovery scan.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Transactions_JTA_Programmers_Guide-Transaction_Recovery-Alternative_to__XAResourceRecovery">
      ⁠</a>4.3. Alternative to XAResourceRecovery</h1></div></div></div><div class="para">
			The iterator-based approach that <code class="interfacename">XAResourceRecovery</code> uses needs to be implemented with the ability to manage states. This leads to unnecessary complexity. In JBoss Transaction Service, you can provide an implementation of the public interface, as below:
		</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>com.<span xmlns="" class="perl_Function">arjuna</span>.<span xmlns="" class="perl_Function">ats</span>.<span xmlns="" class="perl_Function">jta</span>.<span xmlns="" class="perl_Function">recovery</span>.<span xmlns="" class="perl_Function">XAResourceRecoveryHelper</span>
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">initialise</span>(String p) <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> XAResource[] <span xmlns="" class="perl_Function">getXAResources</span>() <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>}
</pre><div class="para">
			During each recovery sweep, the <code class="methodname">getXAResources</code> method is called, and attempts recovery on each element of the array. For the majority of resource managers, you only need one <code class="interfacename">XAResource</code> in the array, since the <code class="methodname">recover</code> method can return multiple Xids.
		</div><div class="para">
			Unlike instances of <code class="interfacename">XAResourceRecovery</code> instances, which are configured via the XML properties file and instantiated by JBoss Transaction Service, instances of <code class="interfacename">XAResourceRecoveryHelper</code> are constructed by the application code and registered with JBoss Transaction Service by calling <code class="methodname">XARecoveryModule.addXAResourceRecoveryHelper</code>.
		</div><div class="para">
			The <code class="methodname">initialize</code> method is not currently called by JBoss Transaction Service, but is provided to allow for the addition of further configuration options in later releases.
		</div><div class="para">
			You can deregister <code class="interfacename">XAResourceRecoveryHelper</code> instances, after which they will no longer be called by the recovery manager. Deregistration may block for a while, if a recovery scan is in progress.
		</div><div class="para">
			The ability to dynamically add and remove instances of <code class="interfacename">XAResourceRecoveryHelper</code> while the system is running is beneficial for environments where datasources may be deployed or undeployed, such as application servers. Be careful when classloading behavior in these cases.
		</div></div></div></body></html>