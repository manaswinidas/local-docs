<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 5. JDBC and Transactions</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="chap-Transactions_JTA_Programmers_Guide-JDBC_and_Transactions">
      ⁠</a>Chapter 5. JDBC and Transactions</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Transactions_JTA_Programmers_Guide-JDBC_and_Transactions-Using_the_transactional_JDBC_driver">
      ⁠</a>5.1. Using the transactional JDBC driver</h1></div></div></div><div class="para">
			JBossJTA supports the construction of local and distributed transactional applications which access databases using the JDBC 2.0 APIs. JDBC 2.0 supports two-phase commit of transactions, and is similar to the XA X/Open standard. The JDBC 2.0 support is found in the <span class="package">com.arjuna.ats.jdbc</span> package.
		</div><div class="para">
			The JDBC 2.0 support has been certified with current versions of most enterprise database vendors. See <a href="http://www.jboss.com/products/platforms/application/supportedconfigurations/">http://www.jboss.com/products/platforms/application/supportedconfigurations/</a> for supported configurations.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Using_the_transactional_JDBC_driver-Managing_transactions">
      ⁠</a>5.1.1. Managing Transactions</h2></div></div></div><div class="para">
				JBossJTA needs to associate work performed on a JDBC connection with a specific transaction. Therefore, applications must use implicit transaction propagation and indirect transaction management. For each JDBC connection, JBossJTA must be able to determine the invoking thread’s current transaction context.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Using_the_transactional_JDBC_driver-Restrictions">
      ⁠</a>5.1.2. Restrictions</h2></div></div></div><div class="para">
				Nested transactions are not supported by JDBC 2.0. If you try to use a JDBC connection within a subtransaction, JBossJTA throws an exception and no work is performed using that connection. 
			</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Transactions_JTA_Programmers_Guide-JDBC_and_Transactions-Transactional_drivers">
      ⁠</a>5.2. Transactional drivers</h1></div></div></div><div class="para">
			The JBossJTA provides JDBC drivers to incorporate JDBC connections within transactions. These drivers intercept all invocations and connect them to the appropriate transactions. A given JDBC driver can only be driven by a single type of transactional driver. If the database is not transactional, ACID (atomicity, consistency, isolation, durability) properties cannot be guaranteed. Invoke the driver using the <code class="interfacename">com.arjuna.ats.jdbc.TransactionalDriver</code> interface, which implements the <code class="interfacename">java.sql.Driver</code> interface.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Transactional_drivers-Loading_drivers">
      ⁠</a>5.2.1. Loading drivers</h2></div></div></div><div class="para">
				You can instantiate and use the driver from within an application. For example:
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>TransactionalDriver arjunaJDBC2Driver = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">TransactionalDriver</span>();</pre><div class="para">
				The JDBC driver manager (<code class="interfacename">java.sql.DriverManager</code>) to manage driver instances by adding them to the Java system properties. The <span class="property">jdbc.drivers</span> property contains a list of driver class names, separated by colons, which the JDBC driver manager loads when it is initialized.
			</div><div class="para">
				Alternatively, you can use the <code class="methodname">Class.forName()</code> method to load the driver or drivers.
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">Class</span>.<span xmlns="" class="perl_Function">forName</span>(<span xmlns="" class="perl_String">"sun.jdbc.odbc.JdbcOdbcDriver"</span>);</pre><div class="para">
				Calling the <code class="methodname">Class.forName()</code> method automatically registers the driver with the JDBC driver manager. You can also explicitly create an instance of the JDBC driver.
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>sun.<span xmlns="" class="perl_Function">jdbc</span>.<span xmlns="" class="perl_Function">odbc</span>.<span xmlns="" class="perl_Function">JdbcOdbcDriver</span> drv = <span xmlns="" class="perl_Keyword">new</span> sun.<span xmlns="" class="perl_Function">jdbc</span>.<span xmlns="" class="perl_Function">odbc</span>.<span xmlns="" class="perl_Function">JdbcOdbcDriver</span>();
<span xmlns="" class="line">​</span>DriverManager.<span xmlns="" class="perl_Function">registerDriver</span>(drv);
</pre><div class="para">
				After you load the driver, it is available for making a connection with a DBMS.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Transactions_JTA_Programmers_Guide-JDBC_and_Transactions-Connections">
      ⁠</a>5.3. Connections</h1></div></div></div><div class="para">
			The JBossJTA provides management for transactional JDBC connections. There are some implications to using them within an application, which the developer should be aware of.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Connections-Making_the_connection">
      ⁠</a>5.3.1. Making the connection</h2></div></div></div><div class="para">
				Because JBossJTA provides a new JDBC driver, application code is only lightly impacted by adding transaction support. The only thing you need to do in your code is start and end transactions.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Connections-JDBC_2.0">
      ⁠</a>5.3.2. JBossJTA JDBC Driver Properties</h2></div></div></div><div class="para">
				The following properties can be set and passed to the JBossJTA driver. Set them in the <code class="classname">com.arjuna.ats.jdbc.TransactionalDriver</code> class.
			</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="property">userName</span></span></dt><dd><div class="para">
							the user name to use when attempting to connect to the database.
						</div></dd><dt><span class="term"><span class="property">password</span></span></dt><dd><div class="para">
							the password to use when attempting to connect to the database.
						</div></dd><dt><span class="term"><span class="property">createDb</span></span></dt><dd><div class="para">
							set this to <code class="literal">true</code> to cause the driver to try to create the database when it connects. This may not be supported by all JDBC 2.0 implementations.
						</div></dd><dt><span class="term"><span class="property">dynamicClass</span></span></dt><dd><div class="para">
							<span class="property">dynamicClass</span>: this specifies a class to instantiate to connect to the database, rather than using JNDI.
						</div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Connections-XADataSources">
      ⁠</a>5.3.3. <code class="interfacename">XADataSources</code></h2></div></div></div><div class="para">
				JDBC 2.0 connections are created from appropriate DataSources. Those connections, which participate within distributed transactions, are obtained from <code class="interfacename">XADataSources</code>. JBossJTA uses the appropriate DataSource when a connection to the database is made. It then obtains <code class="interfacename">XAResources</code> and registers them with the transaction using the JTA interfaces. The transaction service uses these <code class="interfacename">XAResources</code> when the transaction terminates, triggering the database to either commit or rollback the changes made via the JDBC connection.
			</div><div class="para">
				The JBossJTA JDBC 2.0 driver can obtain <code class="interfacename">XADataSources</code> in one of two ways. For simplicity, it is assumed that the JDBC 2.0 driver is instantiated directly by the application.
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Connections-Java_Naming_and_Directory_Interface_JNDI">
      ⁠</a>5.3.3.1. Java Naming and Directory Interface (JNDI)</h3></div></div></div><div class="para">
					JNDI is used so that JDBC drivers can use arbitrary DataSources without knowing implementations-specific details. You can create a specific (XA)DataSource and register it with an appropriate JNDI implementation, which allows either the application or the JDBC driver to bind to and use it. Since JNDI only allows the application to see the (XA)DataSource as an instance of the interface, rather than as an instance of the implementation class, the application is not limited to only using a specific (XA)DataSource implementation.
				</div><div class="para">
					To make the <code class="classname">TransactionalDriver</code> class use a JNDI registered <code class="interfacename">XADataSource</code> you need to create the <code class="interfacename">XADataSource</code> instance and store it in an appropriate JNDI implementation.
				</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>XADataSource ds = <span xmlns="" class="perl_Function">MyXADataSource</span>();
<span xmlns="" class="line">​</span>Hashtable env = <span xmlns="" class="perl_Keyword">new</span> Hashtable();
<span xmlns="" class="line">​</span>String initialCtx = PropertyManager.<span xmlns="" class="perl_Function">getProperty</span>(<span xmlns="" class="perl_String">"Context.INITIAL_CONTEXT_FACTORY"</span>);
<span xmlns="" class="line">​</span>	  
<span xmlns="" class="line">​</span>env.<span xmlns="" class="perl_Function">put</span>(Context.<span xmlns="" class="perl_Function">INITIAL_CONTEXT_FACTORY</span>, initialCtx);
<span xmlns="" class="line">​</span>	  
<span xmlns="" class="line">​</span>initialContext ctx = <span xmlns="" class="perl_Keyword">new</span> InitialContext(env);
<span xmlns="" class="line">​</span>	  
<span xmlns="" class="line">​</span>ctx.<span xmlns="" class="perl_Function">bind</span>(<span xmlns="" class="perl_String">"jdbc/foo"</span>, ds);
</pre><div class="para">
					The <span class="property">Context.INITIAL_CONTEXT_FACTORY</span> property is how JNDI specifies the type of JNDI implementation to use.
				</div><div class="para">
					The next step is for the application must pass an appropriate connection URL to the JDBC 2.0 driver.
				</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>Properties dbProps = <span xmlns="" class="perl_Keyword">new</span> Properties();
<span xmlns="" class="line">​</span>	  
<span xmlns="" class="line">​</span>dbProps.<span xmlns="" class="perl_Function">setProperty</span>(TransactionalDriver.<span xmlns="" class="perl_Function">userName</span>, <span xmlns="" class="perl_String">"user"</span>);
<span xmlns="" class="line">​</span>dbProps.<span xmlns="" class="perl_Function">setProperty</span>(TransactionalDriver.<span xmlns="" class="perl_Function">password</span>, <span xmlns="" class="perl_String">"password"</span>);
<span xmlns="" class="line">​</span>	  
<span xmlns="" class="line">​</span>TransactionalDriver arjunaJDBC2Driver = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">TransactionalDriver</span>();
<span xmlns="" class="line">​</span>Connection connection = arjunaJDBC2Driver.<span xmlns="" class="perl_Function">connect</span>(<span xmlns="" class="perl_String">"jdbc:arjuna:jdbc/foo"</span>, dbProps);
</pre><div class="para">
					The JNDI URL must begin with <code class="literal">jdbc:arjuna:</code> in order for the <code class="interfacename">ArjunaJDBC2Driver</code> interface to recognize that the DataSource needs to participate within transactions and be driven accordingly.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Connections-Dynamic_class_instantiation">
      ⁠</a>5.3.3.2. Dynamic class instantiation</h3></div></div></div><div class="para">
					Dynamic class instantiation is not supported or recommended. Instead, use JNDI. Refer to <a class="xref" href="chap-Transactions_JTA_Programmers_Guide-JDBC_and_Transactions.html#form-Transactions_JTA_Programmers_Guide-Connections-Java_Naming_and_Directory_Interface_JNDI">Section 5.3.3.1, “Java Naming and Directory Interface (JNDI)”</a> for details.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Connections-Using_the_connection">
      ⁠</a>5.3.3.3. Using the connection</h3></div></div></div><div class="para">
					Once the connection has been established using the appropriate method, JBossJTA monitors all operations on the connection. If a transaction is not present when the connection is used, then operations are performed directly on the database.
				</div><div class="para">
					You can use transaction timeouts to automatically terminate transactions if the connection has outlived its usefulness.
				</div><div class="para">
					You can use JBossJTA connections within multiple transactions simultaneously. JBossJTA does connection pooling for each transaction within the JDBC connection. So, although multiple threads may use the same instance of the JDBC connection, internally each transaction may be using a different connection instances. With the exception of the <code class="methodname">close</code> method, all operations performed on the connection at the application level use this transaction-specific connection exclusively.
				</div><div class="para">
					JBossJTA automatically registers the JDBC driver connection with the transaction using an appropriate resource. When the transaction terminates, this resource either commits or rolls back any changes made to the underlying database using appropriate calls on the JDBC driver.
				</div><div class="para">
					After the driver and connection are created, they can be used in the same way as any other JDBC driver or connection.
				</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>Statement stmt = conn.<span xmlns="" class="perl_Function">createStatement</span>();
<span xmlns="" class="line">​</span>	  
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	stmt.<span xmlns="" class="perl_Function">executeUpdate</span>(<span xmlns="" class="perl_String">"CREATE TABLE test_table (a INTEGER,b INTEGER)"</span>);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">catch</span> (SQLException e)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Comment">// table already exists</span>
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>	  
<span xmlns="" class="line">​</span>stmt.<span xmlns="" class="perl_Function">executeUpdate</span>(<span xmlns="" class="perl_String">"INSERT INTO test_table (a, b) VALUES (1,2)"</span>);
<span xmlns="" class="line">​</span>	  
<span xmlns="" class="line">​</span>ResultSet res1 = stmt.<span xmlns="" class="perl_Function">executeQuery</span>(<span xmlns="" class="perl_String">"SELECT * FROM test_table"</span>);
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Connections-Connection_pooling">
      ⁠</a>5.3.3.4. Connection Pooling</h3></div></div></div><div class="para">
					For each user name and password, JBossJTA maintains a single instance of each connection for as long as that connection is in use. Subsequent requests for the same connection get a reference to the original connection, instead of a new instance. You can explicitly close the connection, but your request will be ignored until all users, including transactions, have either finished with the connection, or issued <code class="methodname">close</code> method requests.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Connections-Reusing_connections">
      ⁠</a>5.3.3.5. Reusing Connections</h3></div></div></div><div class="para">
					A very few JDBC drivers allow you to reuse a connection for multiple transactions. Most drivers require a new connection for each new transaction. By default, the JBossJTA transactional driver always obtains a new connection for each new transaction. However, if an existing connection is available and is currently unused, you can use the set the <span class="property">reuseconnection</span> property to <code class="literal">true</code> on the JDBC URL.
				</div><pre class="screen">
	  jdbc:arjuna:sequelink://host:port;databaseName=foo;reuseconnection=true
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Connections-Terminating_the_transaction">
      ⁠</a>5.3.3.6. Terminating the Transaction</h3></div></div></div><div class="para">
					Whenever a transaction terminates and has a JDBC connection registered with it, the JBossJTA JDBC driver instructs the database to either commit or roll back pending changes. This happens in the background, out of the purview of the application.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Connections-AutoCommit">
      ⁠</a>5.3.3.7. AutoCommit</h3></div></div></div><div class="para">
					If the <span class="property">AutoCommit</span> property of the <span class="property">java.sql.Connection</span> property is set to <code class="literal">true</code> for JDBC 1.0, the execution of every SQL statement is a separate top-level transaction, and it is not possible to group multiple statements to be managed within a single OTS transaction. Therefore, JBossJTA disables <span class="property">AutoCommit</span> on JDBC 1.0 connections before using them. If <span class="property">AutoCommit</span> is subsequently set to <code class="literal">true</code> by the application, JBossJTA raises the <code class="literal">java.sql.SQLException</code> exception.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="form-Transactions_JTA_Programmers_Guide-Connections-Setting_isolation_levels">
      ⁠</a>5.3.3.8. Setting Isolation Levels</h3></div></div></div><div class="para">
					When you use the JBossJTA JDBC driver, you may need to set the underlying transaction isolation level on the XA connection. Its default value is <span class="property">TRANSACTION_SERIALIZABLE</span>, but you can set this to something more appropriate for your application by setting the <span class="property">com.arjuna.ats.jdbc.isolationLevel</span> property to the appropriate isolation level in string form. Possible values include <span class="property">TRANSACTION_READ_COMMITTED</span> and <span class="property">TRANSACTION_REPEATABLE_READ</span>.
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
						At present this property applies to all XA connections created in the JVM.
					</div></div></div></div></div></div></div></body></html>