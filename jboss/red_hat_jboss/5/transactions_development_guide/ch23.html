<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 23. Participant Crash Recovery</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="idm140019182090208">
      ⁠</a>Chapter 23. Participant Crash Recovery</h1></div></div></div><a id="idm140019117022192" class="indexterm"/><a id="idm140019169983104" class="indexterm"/><a id="idm140019169892560" class="indexterm"/><div class="para">
		A key requirement of a transaction service is to be resilient to a system crash by a host running a participant, as well as the host running the transaction coordination services. Crashes which happen before a transaction terminates or before a business activity completes are relatively easy to accommodate. The transaction service and participants can adopt a <em class="firstterm">presumed abort</em> policy.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="idm140019117250464">
      ⁠</a><p class="title"><strong>Procedure 23.1. Presumed Abort Policy</strong></p><ol class="1"><li class="step"><div class="para">
				If the coordinator crashes, it can assume that any transaction it does not know about is invalid, and reject a participant request which refers to such a transaction.
			</div></li><li class="step"><div class="para">
				If the participant crashes, it can forget any provisional changes it has made, and reject any request from the coordinator service to prepare a transaction or complete a business activity.
			</div></li></ol></div><div class="para">
		Crash recovery is more complex if the crash happens during a transaction commit operation, or between completing and closing a business activity. The transaction service must ensure as far as possible that participants arrive at a consistent outcome for the transaction.
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">WS-AT Transaction</span></dt><dd><div class="para">
					The transaction needs to commit all provisional changes or roll them all back to the state before the transaction started.
				</div></dd><dt><span class="term">WS-Business Activity Transaction</span></dt><dd><div class="para">
					All participants need to close the activity or cancel the activity, and run any required compensating actions.
				</div></dd></dl></div><div class="para">
		On the rare occasions where such a consensus cannot be reached, the transaction service must log and report transaction failures.
	</div><div class="para">
		XTS includes support for automatic recovery of WS-AT and WS-BA transactions, if either or both of the coordinator and participant hosts crashes. The XTS recovery manager begins execution on coordinator and participant hosts when the XTS service restarts. On a coordinator host, the recovery manager detects any WS-AT transactions which have prepared but not committed, as well as any WS-BA transactions which have completed but not yet closed. It ensures that all their participants are rolled forward in the first case, or closed in the second.
	</div><div class="para">
		On a participant host, the recovery manager detects any prepared WS-AT participants which have not responded to a transaction rollback, and any completed WS-BA participants which have not yet responded to an activity cancel request, and ensures that the former are rolled back and the latter are compensated. The recovery service also allows for recovery of subordinate WS-AT transactions and their participants if a crash occurs on a host where an interposed WS-AT coordinator has been employed.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm140019154276240">
      ⁠</a>23.1. WS-AT Recovery</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019155896704">
      ⁠</a>23.1.1. WS-AT Coordinator Crash Recovery</h2></div></div></div><div class="para">
				The WS-AT coordination service tracks the status of each participant in a transaction as the transaction progresses through its two-phase commit. When all participants have been sent a <code class="systemitem">prepare</code> message and have responded with a <code class="systemitem">prepared</code> message, the coordinator writes a log record storing each participant's details, indicating that the transaction is ready to complete. If the coordinator service crashes after this point has been reached, completion of the two-phase commit protocol is still guaranteed, by reading the log file after reboot and sending a <code class="systemitem">commit</code> message to each participant. Once all participants have responded to the <code class="systemitem">commit</code> with a <code class="systemitem">committed</code> message, the coordinator can safely delete the log entry.
			</div><div class="para">
				Since the <code class="systemitem">prepared</code> messages returned by the participants imply that they are ready to commit their provisional changes and make them permanent, this type of recovery is safe. Additionally, the coordinator does not need to account for any commit messages which may have been sent before the crash, or resend messages if it crashes several times. The XTS participant implementation is resilient to redelivery of the <code class="systemitem">commit</code> messages. If the participant has implemented the recovery functions described in <a class="xref" href="ch23.html#ws-at-recovery-api">Section 23.1.2.1, “WS-AT Participant Crash Recovery APIs”</a>, the coordinator can guarantee delivery of <code class="systemitem">commit</code> messages if both it crashes, and one or more of the participant service hosts also crash, at the same time.
			</div><div class="para">
				If the coordination service crashes before the <code class="systemitem">prepare</code> phase completes, the presumed abort protocol ensures that participants are rolled back. After system restart, the coordination service has the information about all the transactions which could have entered the <code class="systemitem">commit</code> phase before the reboot, since they have entries in the log. It also knows about any active transactions started after the reboot. If a participant is waiting for a response, after sending its <code class="systemitem">prepared</code> message, it automatically re sends the <code class="systemitem">prepared</code> message at regular intervals. When the coordinator detects a transaction which is not active and has no entry in the log file after the reboot, it instructs the participant to abort, ensuring that the web service gets a chance to roll back any provisional state changes it made on behalf of the transaction.
			</div><div class="para">
				A web service may decide to unilaterally commit or roll back provisional changes associated with a given participant, if configured to time out after a specified length of time without a response. In this situation, the web service should record this action and log a message to persistent storage. When the participant receives a request to commit or roll back, it should throw an exception if its unilateral decision action does not match the requested action. The coordinator detects the exception and logs a message marking the outcome as heuristic. It also saves the state of the transaction permanently in the transaction log, to be inspected and reconciled by an administrator.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019148786864">
      ⁠</a>23.1.2. WS-AT Participant Crash Recovery</h2></div></div></div><div class="para">
				WS-AT participants associated with a transactional web service do not need to be involved in crash recovery if the Web service's host machine crashes before the participant is told to prepare. The coordinator will assume that the transaction has aborted, and the Web service can discard any information associated with unprepared transactions when it reboots.
			</div><div class="para">
				When a participant is told to <code class="systemitem">prepare</code>, the Web service is expected to save to persistent storage the transactional state it needs to commit or roll back the transaction. The specific information it needs to save is dependent on the implementation and business logic of the Web Service. However, the participant must save this state before returning a <code class="systemitem">Prepared</code> vote from the <code class="methodname">prepare</code> call. If the participant cannot save the required state, or there is some other problem servicing the request made by the client, it must return an <code class="systemitem">Aborted</code> vote.
			</div><div class="para">
				The XTS participant services running on a Web Service's host machine cooperate with the Web service implementation to facilitate participant crash recovery. These participant services are responsible for calling the participant's <code class="methodname">prepare</code>, <code class="methodname">commit</code>, and <code class="systemitem">rollback</code> methods. The XTS implementation tracks the local state of every enlisted participant. If the <code class="systemitem">prepare</code> call returns a <code class="systemitem">Prepared</code> vote, the XTS implementation ensures that the participant state is logged to the local transaction log before forwarding a <code class="systemitem">prepared</code> message to the coordinator.
			</div><div class="para">
				A participant log record contains information identifying the participant, its transaction, and its coordinator. This is enough information to allow the rebooted XTS implementation to reinstate the participant as active and to continue communication with the coordinator, as though the participant had been enlisted and driven to the prepared state. However, a participant instance is still necessary for the commit or rollback process to continue.
			</div><div class="para">
				Full recovery requires the log record to contain information needed by the Web service which enlisted the participant. This information must allow it to recreate an equivalent participant instance, which can continue the <code class="systemitem">commit</code> process to completion, or roll it back if some other Web Service fails to <code class="systemitem">prepare</code>. This information might be as simple as a String key which the participant can use to locate the data it made persistent before returning its Prepared vote. It may be as complex as a serialized object tree containing the original participant instance and other objects created by the Web service.
			</div><div class="para">
				If a participant instance implements the relevant interface, the XTS implementation will append this participant recovery state to its log record before writing it to persistent storage. In the event of a crash, the participant recovery state is retrieved from the log and passed to the Web Service which created it. The Web Service uses this state to create a new participant, which the XTS implementation uses to drive the transaction to completion. Log records are only deleted after the participant's <code class="methodname">commit</code> or <code class="methodname">rollback</code> method is called.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="warning"><div class="admonition_header"><p><strong>Warning</strong></p></div><div class="admonition"><div class="para">
					If a crash happens just before or just after a <code class="methodname">commit</code> method is called, a <code class="methodname">commit</code> or <code class="methodname">rollback</code> method may be called twice.
				</div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ws-at-recovery-api">
      ⁠</a>23.1.2.1. WS-AT Participant Crash Recovery APIs</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm140019176431984">
      ⁠</a>23.1.2.1.1. Saving Participant Recovery State</h4></div></div></div><div class="para">
						To signal that it is capable of performing recovery processing, a participant can implement the <code class="interfacename">java.lang.Serializable</code> interface. Alternatively it may implement <a class="xref" href="ch23.html#example-PersistableATParticipant">Example 23.1, “The <code class="interfacename">PersistableATParticipant</code> Interface”</a>.
					</div><div class="example"><a id="example-PersistableATParticipant">
      ⁠</a><p class="title"><strong>Example 23.1. The <code class="interfacename">PersistableATParticipant</code> Interface</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	      <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> PersistableATParticipant
<span xmlns="" class="line">​</span>	      {
<span xmlns="" class="line">​</span>	        <span xmlns="" class="perl_DataType">byte</span>[] <span xmlns="" class="perl_Function">getRecoveryState</span>() <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>	      }
</pre></div></div><div class="para">
						If a participant implements the <code class="interfacename">Serializable</code> interface, the XTS participant services implementation uses the serialization API to create a version of the participant which can be appended to the participant log entry. If it implements the <code class="interfacename">PersistableATParticipant</code> interface, the XTS participant services implementation call the <code class="methodname">getRecoveryState</code> method to obtain the state to be appended to the participant log entry.
					</div><div class="para">
						If neither of these APIs is implemented, the XTS implementation logs a warning message and proceeds without saving any recovery state. In the event of a crash on the host machine for the Web service during commit, the transaction cannot be recovered and a heuristic outcome may occur. This outcome is logged on the host running the coordinator services.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm140019172114624">
      ⁠</a>23.1.2.1.2. Recovering Participants at Reboot</h4></div></div></div><div class="para">
						A Web service must register with the XTS implementation when it is deployed, and unregister when it is undeployed, in order to participate in recovery processing. Registration is performed using class <code class="classname">XTSATRecoveryManager</code> defined in package <span class="package">org.jboss.jbossts.xts.recovery.participant.at</span>.
					</div><div class="example"><a id="idm140019111387520">
      ⁠</a><p class="title"><strong>Example 23.2. Registering for Recovery</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> XTSATRecoveryManager {
<span xmlns="" class="line">​</span>	. . .
<span xmlns="" class="line">​</span> 	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> XTSATRecoveryManager <span xmlns="" class="perl_Function">getRecoveryManager</span>() ;
<span xmlns="" class="line">​</span> 	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">registerRecoveryModule</span>(XTSATRecoveryModule module);
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">unregisterRecoveryModule</span>(XTSATRecoveryModule module)
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">throws</span> NoSuchElementException;
<span xmlns="" class="line">​</span>	. . .
<span xmlns="" class="line">​</span>}</pre></div></div><div class="para">
						The Web service must provide an implementation of the <code class="interfacename">XTSATRecoveryModule</code>, located in the <span class="package">org.jboss.jbossts.xts.recovery.participant.at</span>, as argument to both the <code class="methodname">register</code> and <code class="methodname">unregister</code> calls. This instance is responsible for identifying saved participant recovery records and recreating new, recovered participant instances.
					</div><div class="example"><a id="idm140019162057776">
      ⁠</a><p class="title"><strong>Example 23.3. <code class="interfacename">XTSATRecoveryModule</code> Implementation</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> XTSATRecoveryModule
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Durable2PCParticipant
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Function">deserialize</span>(String id, ObjectInputStream stream) 
<span xmlns="" class="line">​</span>	  <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Durable2PCParticipant
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Function">recreate</span>(String id, <span xmlns="" class="perl_DataType">byte</span>[] recoveryState) 
<span xmlns="" class="line">​</span>	  <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>}</pre></div></div><div class="para">
						If a participant's recovery state was saved using serialization, the recovery module's <code class="methodname">deserialize</code> method is called to recreate the participant. Normally, the recovery module is required to read, cast, and return an object from the supplied input stream. If a participant's recovery state was saved using the <code class="interfacename">PersistableATParticipant</code> interface, the recovery module's <code class="methodname">recreate</code> method is called to recreate the participant from the byte array it provided when the state was saved.
					</div><div class="para">
						The XTS implementation cannot identify which participants belong to which recovery modules. A module only needs to return a participant instance if the recovery state belongs to the module's Web service. If the participant was created by another Web service, the module should return <code class="literal">null</code>. The participant identifier, which is supplied as argument to the <code class="methodname">deserialize</code> or <code class="methodname">recreate</code> method, is the identifier used by the Web service when the original participant was enlisted in the transaction. Web Services participating in recovery processing should ensure that participant identifiers are unique per service. If a module recognizes that a participant identifier belongs to its Web service, but cannot recreate the participant, it should throw an exception. This situation might arise if the service cannot associate the participant with any transactional information which is specific to the business logic.
					</div><div class="para">
						Even if a module relies on serialization to create the participant recovery state saved by the XTS implementation, it still must be registered by the application. The <code class="methodname">deserialization</code> operation must employ a class loader capable of loading classes specific to the Web service. XTS fulfills this requirement by devolving responsibility for the <code class="methodname">deserialize</code> operation to the recovery module.
					</div></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm140019164185008">
      ⁠</a>23.2. WS-BA Recovery</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019164184208">
      ⁠</a>23.2.1. WS-BA Coordinator Crash Recovery</h2></div></div></div><div class="para">
				The WS-BA coordination service implementation tracks the status of each participant in an activity as the activity progresses through completion and closure. A transition point occurs during closure, once all <code class="systemitem">CoordinatorCompletion</code> participants receive a <code class="systemitem">complete</code> message and respond with a <code class="systemitem">completed</code> message. At this point, all <code class="systemitem">ParticipantCompletion</code> participants should have sent a <code class="systemitem">completed</code> message. The coordinator writes a log record storing the details of each participant, and indicating that the transaction is ready to close. If the coordinator service crashes after the log record is written, the <code class="methodname">close</code> operation is still guaranteed to be successful. The coordinator checks the log after the system reboots and re sends a <code class="systemitem">close</code> message to all participants. After all participants respond to the <code class="systemitem">close</code> with a <code class="systemitem">closed</code> message, the coordinator can safely delete the log entry.
			</div><div class="para">
				The coordinator does not need to account for any <code class="systemitem">close</code> messages sent before the crash, nor resend messages if it crashes several times. The XTS participant implementation is resilient to redelivery of <code class="systemitem">close</code> messages. Assuming that the participant has implemented the recovery functions described below, the coordinator can even guarantee delivery of <code class="systemitem">close</code> messages if both it, and one or more of the participant service hosts, crash simultaneously.
			</div><div class="para">
				If the coordination service crashes before it has written the log record, it does not need to explicitly compensate any completed participants. The <span class="phrase">presumed abort protocol</span> ensures that all completed participants are eventually sent a <code class="systemitem">compensate</code> message. Recovery must be initiated from the participant side.
			</div><div class="para">
				A log record does not need to be written when an activity is being canceled. If a participant does not respond to a <code class="systemitem">cancel</code> or <code class="systemitem">compensate</code> request, the coordinator logs a warning and continues. The combination of the <span class="phrase">presumed abort protocol</span> and participant-led recovery ensures that all participants eventually get canceled or compensated, as appropriate, even if the participant host crashes.
			</div><div class="para">
				If a completed participant does not detect a response from its coordinator after resending its <code class="systemitem">completed</code> response a suitable number of times, it switches to sending <code class="systemitem">getstatus</code> messages, to determine whether the coordinator still knows about it. If a crash occurs before writing the log record, the coordinator has no record of the participant when the coordinator restarts, and the <code class="systemitem">getstatus</code> request returns a fault. The participant recovery manager automatically compensates the participant in this situation, just as if the activity had been canceled by the client.
			</div><div class="para">
				After a participant crash, the participant recovery manager detects the log entries for each completed participant. It sends <code class="systemitem">getstatus</code> messages to each participant's coordinator host, to determine whether the activity still exists. If the coordinator has not crashed and the activity is still running, the participant switches back to resending <code class="systemitem">completed</code> messages, and waits for a <code class="systemitem">close</code> or <code class="systemitem">compensate</code> response. If the coordinator has also crashed or the activity has been canceled, the participant is automatically canceled.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019167579376">
      ⁠</a>23.2.2. WS-BA Participant Crash Recovery APIs</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm140019167578608">
      ⁠</a>23.2.2.1. Saving Participant Recovery State</h3></div></div></div><div class="para">
					A participant may signal that it is capable of performing recovery processing, by implementing the <code class="interfacename">java.lang.Serializable</code> interface. An alternative is to implement the <a class="xref" href="ch23.html#example-PersistableBAParticipant">Example 23.4, “<code class="interfacename">PersistableBAParticipant</code> Interface”</a>.
				</div><div class="example"><a id="example-PersistableBAParticipant">
      ⁠</a><p class="title"><strong>Example 23.4. <code class="interfacename">PersistableBAParticipant</code> Interface</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> PersistableBAParticipant
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">byte</span>[] <span xmlns="" class="perl_Function">getRecoveryState</span>() <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para">
					If a participant implements the <code class="interfacename">Serializable</code> interface, the XTS participant services implementation uses the serialization API to create a version of the participant which can be appended to the participant log entry. If the participant implements the <code class="interfacename">PersistableBAParticipant</code>, the XTS participant services implementation call the <code class="methodname">getRecoveryState</code> method to obtain the state, which is appended to the participant log entry.
				</div><div class="para">
					If neither of these APIs is implemented, the XTS implementation logs a warning message and proceeds without saving any recovery state. If the Web service's host machine crashes while the activity is being closed, the activity cannot be recovered and a heuristic outcome will probably be logged on the coordinator's host machine. If the activity is canceled, the participant is not compensated and the coordinator host machine may log a heuristic outcome for the activity.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm140019175199264">
      ⁠</a>23.2.2.2. Recovering Participants at Reboot</h3></div></div></div><div class="para">
					A Web service must register with the XTS implementation when it is deployed, and unregister when it is undeployed, so it can take part in recovery processing.
				</div><div class="para">
					Registration is performed using the <code class="classname">XTSBARecoveryManager</code>, defined in the <span class="package">org.jboss.jbossts.xts.recovery.participant.ba</span> package.
				</div><div class="example"><a id="idm140019180211392">
      ⁠</a><p class="title"><strong>Example 23.5. <code class="classname">XTSBARecoveryManager</code> Class</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> XTSBARecoveryManager {
<span xmlns="" class="line">​</span>    . . .
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> XTSBARecoveryManager <span xmlns="" class="perl_Function">getRecoveryManager</span>() ;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">registerRecoveryModule</span>(XTSBARecoveryModule module);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">unregisterRecoveryModule</span>(XTSBARecoveryModule module)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> NoSuchElementException;
<span xmlns="" class="line">​</span>    . . .
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para">
					The Web service must provide an implementation of the <code class="classname">XTSBARecoveryModule</code> in the <span class="package"> org.jboss.jbossts.xts.recovery.participant.ba</span>, as an argument to the <code class="methodname">register</code> and <code class="methodname">unregister</code> calls. This instance identifies saved participant recovery records and recreates new, recovered participant instances:
				</div><div class="example"><a id="idm140019180206192">
      ⁠</a><p class="title"><strong>Example 23.6. <code class="interfacename">XTSBARecoveryModule</code> Interface</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> XTSATRecoveryModule
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> BusinessAgreementWithParticipantCompletionParticipant
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Function">deserializeParticipantCompletionParticipant</span>(String id,
<span xmlns="" class="line">​</span>						    ObjectInputStream stream)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> BusinessAgreementWithParticipantCompletionParticipant
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Function">recreateParticipantCompletionParticipant</span>(String id,
<span xmlns="" class="line">​</span>						 <span xmlns="" class="perl_DataType">byte</span>[] recoveryState)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> BusinessAgreementWithCoordinatorCompletionParticipant
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Function">deserializeCoordinatorCompletionParticipant</span>(String id,
<span xmlns="" class="line">​</span>						    ObjectInputStream stream)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> BusinessAgreementWithCoordinatorCompletionParticipant
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Function">recreateCoordinatorCompletionParticipant</span>(String id,
<span xmlns="" class="line">​</span>						 <span xmlns="" class="perl_DataType">byte</span>[] recoveryState)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para">
					If a participant's recovery state was saved using serialization, one of the recovery module's <code class="methodname">deserialize</code> methods is called, so that it can recreate the participant. Which method to use depends on whether the saved participant implemented the <code class="classname">ParticipantCompletion</code> protocol or the <code class="classname">CoordinatorCompletion</code> protocol. Normally, the recovery module reads, casts and returns an object from the supplied input stream. If a participant's recovery state was saved using the <code class="interfacename">PersistableBAParticipant</code> interface, one of the recovery module's <code class="methodname">recreate</code> methods is called, so that it can recreate the participant from the byte array provided when the state was saved. The method to use depends on which protocol the saved participant implemented.
				</div><div class="para">
					The XTS implementation does not track which participants belong to which recovery modules. A module is only expected to return a participant instance if it can identify that the recovery state belongs to its Web service. If the participant was created by some other Web service, the module should return <code class="literal">null</code>. The participant identifier supplied as an argument to the <code class="methodname">deserialize</code> or <code class="methodname">recreate</code> calls is the identifier used by the Web service when the original participant was enlisted in the transaction. Web Services which participate in recovery processing should ensure that the participant identifiers they employ are unique per service. If a module recognizes a participant identifier as belonging to its Web service, but cannot recreate the participant, it throws an exception. This situation might arise if the service cannot associate the participant with any transactional information specific to business logic.
				</div><div class="para">
					A module must be registered by the application, even when it relies upon serialization to create the participant recovery state saved by the XTS implementation. The <code class="methodname">deserialization</code> operation must employ a class loader capable of loading Web service-specific classes. The XTS implementation achieves this by delegating responsibility for the <code class="methodname">deserialize</code> operation to the recovery module.
				</div></div></div></div></div></body></html>