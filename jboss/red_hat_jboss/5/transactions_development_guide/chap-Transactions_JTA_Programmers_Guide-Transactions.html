<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 2. The JBoss JTA Implementation</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="chap-Transactions_JTA_Programmers_Guide-Transactions">
      ⁠</a>Chapter 2. The JBoss JTA Implementation</h1></div></div></div><div class="para">
		The Java Transaction API (JTA) consists of three elements:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				A high-level application transaction demarcation interface
			</div></li><li class="listitem"><div class="para">
				A high-level transaction manager interface intended for application server
			</div></li><li class="listitem"><div class="para">
				A standard Java mapping of the X/Open XA protocol intended for transactional resource manager
			</div></li></ul></div><div class="para">
		All of the JTA classes and interfaces are declared within the <span class="package">javax.transaction</span> package, and the corresponding JBossJTA implementations are defined within the <span class="package">com.arjuna.ats.jta</span> package.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
			Each Xid that JBoss Transaction Service creates needs a unique node identifier encoded within it. JBoss Transaction Service will only recover transactions and states that match a specified node identifier. The node identifier should be provided to JBoss transaction Service via the <span class="property">com.arjuna.ats.arjuna.xa.nodeIdentifier</span> property. You must ensure this value is unique across your JBoss Transaction Service instances. If you do not provide a value, JBoss Transaction Service will generate one and report the value via the logging infrastructure. The node identifier should be alphanumeric.
		</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="form-Transactions_JTA_Programmers_Guide-The_API-UserTransaction">
      ⁠</a>2.1. UserTransaction</h1></div></div></div><div class="para">
			The <code class="interfacename">UserTransaction</code> interface allows applications to control transaction boundaries. It provides methods for beginning, committing, and rolling back top-level transactions. Nested transactions are not supported, and the <code class="methodname">begin</code> method throws the <code class="code">NotSupportedException</code> when the calling thread is already associated with a transaction. <code class="interfacename">UserTransaction</code> automatically associates newly created transactions with the invoking thread.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				You can obtain a <code class="interfacename">UserTransaction</code> from JNDI.
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	InitialContext ic = <span xmlns="" class="perl_Keyword">new</span> InitialContext();
<span xmlns="" class="line">​</span>	UserTransaction utx = ic.<span xmlns="" class="perl_Function">lookup</span>(<span xmlns="" class="perl_String">"java:comp/UserTransaction"</span>)
</pre></div></div><div class="para">
			In order to select the local JTA implementation:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
					Set the <span class="property">com.arjuna.ats.jta.jtaTMImplementation</span> property to <code class="literal">com.arjuna.ats.internal.jta.transaction.arjunacore.TransactionManagerImple</code>.
				</div></li><li class="listitem"><div class="para">
					Set the <span class="property">com.arjuna.ats.jta.jtaUTImplementation</span> property to <code class="literal">com.arjuna.ats.internal.jta.transaction.arjunacore.UserTransactionImple</code>.
				</div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="form-Transactions_JTA_Programmers_Guide-The_API-TransactionManager">
      ⁠</a>2.2. TransactionManager</h1></div></div></div><div class="para">
			The <code class="interfacename">TransactionManager</code> interface allows the application server to control transaction boundaries on behalf of the application being managed.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				You can obtain a <code class="interfacename">TransactionManager</code> from JNDI.
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	InitialContext ic = <span xmlns="" class="perl_Keyword">new</span> InitialContext();
<span xmlns="" class="line">​</span>	TransactionManager utm = ic.<span xmlns="" class="perl_Function">lookup</span>(<span xmlns="" class="perl_String">"java:/TransactionManager"</span>)
</pre></div></div><div class="para">
			The Transaction Manager maintains the transaction context association with threads as part of its internal data structure. A thread’s transaction context is either <code class="literal">null</code> or it refers to a specific global transaction. Multiple threads can be associated with the same global transaction. Nested transactions are not supported.
		</div><div class="para">
			Each transaction context is encapsulated within a Transaction object, which can be used to perform operations which are specific to the target transaction, regardless of the calling thread’s transaction context.
		</div><div class="para">
			The <code class="methodname">begin</code> method of <code class="interfacename">TransactionManager</code> begins a new top-level transaction, and associates the transaction context with the calling thread. If the calling thread is already associated with a transaction then the <code class="methodname">begin</code> method throws the <code class="literal">NotSupportedException</code>.
		</div><div class="para">
			The <code class="methodname">getTransaction</code> method returns the Transaction object that represents the transaction context currently associated with the calling thread. This object can be used to perform various operations on the target transaction. These operations are described elsewhere.

		</div><div class="para">
			The <code class="methodname">commit</code> method completes the transaction currently associated with the calling thread. After it returns, the calling thread is not associated with any transaction. If <code class="methodname">commit</code> is called when the thread is not associated with any transaction context, an exception is thrown. In some implementations, only the transaction originator can use the <code class="methodname">commit</code> operation. If the calling thread is not permitted to commit the transaction, an exception is thrown. JBossJTA does not impose any restrictions on the ability of threads to terminate transactions.
		</div><div class="para">
			The <code class="methodname">rollback</code> method is used to roll back the transaction associated with the current thread. After the <code class="methodname">rollback</code> method completes, the thread is not associated with any transaction.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				In a multi-threaded environment, multiple threads may be active within the same transaction. If <em class="firstterm">checked transaction semantics</em> have been disabled, or the transaction times out, then a transaction can be terminated by a thread other than its creator. If this happens, the creator must be notified. JBoss Transaction Service does this notification during commit or rollback by throwing the <code class="literal">IllegalStateException</code> exception.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="form-Transactions_JTA_Programmers_Guide-The_API-Suspending_and_resuming_a_transaction">
      ⁠</a>2.3. Suspending and Resuming a Transaction</h1></div></div></div><div class="para">
			The JTA supports the concept of a thread temporarily suspending and resuming transactions to enable it to perform non-transactional work. The <code class="methodname">suspend</code> method is called to temporarily suspend the current transaction associated with the calling thread. If the thread is not associated with any transaction, a <code class="literal">null</code> object reference is returned; otherwise, a valid <code class="literal">Transaction</code> object is returned. The <code class="literal">Transaction</code> object can later be passed to the <code class="methodname">resume</code> method to reinstate the transaction context.
		</div><div class="para">
			The <code class="methodname">resume</code> method associates the specified transaction context with the calling thread. If the transaction specified is valid, the transaction context is associated with the calling thread. Otherwise, the thread is not associated with any transaction.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				If the <code class="methodname">resume</code> method is invoked when the calling thread is already associated with another transaction, the Transaction Manager throws the <code class="literal">IllegalStateException</code> exception.
			</div></div></div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>Transaction tobj = TransactionManager.<span xmlns="" class="perl_Function">suspend</span>();
<span xmlns="" class="line">​</span>..
<span xmlns="" class="line">​</span>TransactionManager.<span xmlns="" class="perl_Function">resume</span>(tobj);
</pre><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				JBossJTA supports allowing a suspended transaction to be resumed by a different thread, even though this feature is not required by the JTA standards.
			</div></div></div><div class="para">
			When a transaction is suspended, the application server de-registers and frees up the resources that are related to the suspended transaction. When a resource is de-listed, the Transaction Manager informs the resource manager and the resource manager disassociates the transaction from the specified resource object. When the application’s transaction context is resumed, the application server must give the transaction back its resources. Enlisting a resource as a result of resuming a transaction triggers the Transaction Manager to inform the resource manager to re-associate the resource object with the resumed transaction.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="form-Transactions_JTA_Programmers_Guide-The_API-The_Transaction_interface">
      ⁠</a>2.4. The Transaction Interface</h1></div></div></div><div class="para">
			The <code class="interfacename">Transaction</code> interface allows operations to be performed on the transaction associated with the target object. Every top-level transaction is associated with one <code class="literal">Transaction</code> object when the transaction is created. The <code class="literal">Transaction</code> object can be used to:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					Enlist the transactional resources in use by the application.
				</div></li><li class="listitem"><div class="para">
					Register for transaction synchronization call backs.
				</div></li><li class="listitem"><div class="para">
					Commit or rollback the transaction.
				</div></li><li class="listitem"><div class="para">
					Obtain the status of the transaction.
				</div></li></ul></div><div class="para">
			The <code class="methodname">commit</code> and <code class="methodname">rollback</code> methods allow the target object to be committed or rolled back. The calling thread is not required to have the same transaction associated with the thread. If the calling thread is not allowed to commit the transaction, the transaction manager throws an exception. JBossJTA does not impose restrictions on threads terminating transactions.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="form-Transactions_JTA_Programmers_Guide-The_API-Resource_enlistment">
      ⁠</a>2.5. Resource Enlistment</h1></div></div></div><div class="para">
			Transactional resources, such as database connections, are typically managed by the application server in conjunction with some resource adapter, and optionally, with connection pooling optimization. In order for an external transaction manager to coordinate transactional work performed by the resource managers, the application server must enlist and de-list the resources used in the transaction. These resources (participants) are enlisted with the transaction so that they can be informed when the transaction terminates.
		</div><div class="para">
			As stated previously, the JTA is much more closely integrated with the XA concept of resources than the arbitrary objects. For each resource in use by the application, the application server invokes the <code class="methodname">enlistResource</code> method with an <code class="literal">XAResource</code> object which identifies the resource in use. See 
			 for details on how the implementation of the <code class="code">XAResource</code> can affect recovery in the event of a failure.
		</div><div class="para">
			The enlistment request causes the transaction manager to inform the resource manager to start associating the transaction with the work performed through the corresponding resource. The transaction manager is responsible for passing the appropriate flag in its <code class="methodname">XAResource.start</code> method call to the resource manager.
		</div><div class="para">
			The <code class="methodname">delistResource</code> method is used to dissociate the specified resource from the transaction context in the target object. The application server invokes the method with two parameters:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					An <code class="literal">XAResources</code> object, which represents the resource.
				</div></li><li class="listitem"><div class="para">
					A flag to indicate whether the operation is due to the transaction being suspended (<code class="literal">TMSUSPEND</code>), a portion of the work has failed (<code class="literal">TMFAIL</code>), or a normal resource release by the application (<code class="literal">TMSUCCESS</code>).
				</div></li></ul></div><div class="para">
			The de-list request causes the transaction manager to inform the resource manager to end the association of the transaction with the target <code class="code">XAResource</code>. The flag value allows the application server to indicate whether it intends to come back to the same resource, in which case the resource states must be kept intact. The transaction manager passes the appropriate flag value in its <code class="methodname">XAResource.end</code> method call to the underlying resource manager.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="form-Transactions_JTA_Programmers_Guide-The_API-Transaction_synchronization">
      ⁠</a>2.6. Transaction Synchronization</h1></div></div></div><div class="para">
			Transaction synchronization allows the application server to be notified before and after the transaction completes. For each transaction started, the application server may optionally register a <code class="literal">Synchronization</code> callback object to be invoked by the transaction manager either before or after completion:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					The <code class="methodname">beforeCompletion</code> method is called prior to the start of the two-phase transaction complete process. This call is executed in the same transaction context of the caller who initiates the <code class="methodname">TransactionManager.commit</code>, or with no transaction context if <code class="methodname">Transaction.commit</code> is used.
				</div></li><li class="listitem"><div class="para">
					The <code class="methodname">afterCompletion</code> method is called after the transaction has completed. The status of the transaction is supplied in the parameter. This method is executed without a transaction context.
				</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="form-Transactions_JTA_Programmers_Guide-The_API-Transaction_equality">
      ⁠</a>2.7. Transaction Equality</h1></div></div></div><div class="para">
			The transaction manager implements the <code class="literal">Transaction</code> object’s <code class="methodname">equals</code> method to allow comparison between the target object and another Transaction object. The <code class="methodname">equals</code> method returns <code class="literal">true</code> if the target object and the parameter object both refer to the same global transaction.
		</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>Transaction txObj = TransactionManager.<span xmlns="" class="perl_Function">getTransaction</span>();
<span xmlns="" class="line">​</span>Transaction someOtherTxObj = ..
<span xmlns="" class="line">​</span>    ..
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span><span xmlns="" class="perl_DataType">boolean</span> isSame = txObj.<span xmlns="" class="perl_Function">equals</span>(someOtherTxObj);</pre></div></div></body></html>