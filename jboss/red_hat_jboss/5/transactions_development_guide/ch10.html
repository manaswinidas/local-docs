<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 10. Using JBoss Transaction Service</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="idm140019184291984">
      ⁠</a>Chapter 10. Using JBoss Transaction Service</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm140019158877152">
      ⁠</a>10.1. Introduction</h1></div></div></div><div class="para">
			This section covers JBoss Transaction Service and Transactional Objects for Java in detail, as well as how you can use it to construct transactional applications.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm140019159030256">
      ⁠</a>10.2. State management</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019172332880">
      ⁠</a>10.2.1. Object States</h2></div></div></div><div class="para">
				JBoss Transaction Service remembers the state of an object for the purposes of recovery and persistence. In the case of recovery, the state represents some past state of the object. When persistence is involved, the state represents the final state of an object at application termination. Since recovery and persistence include common functionality, they are both implemented using the <code class="classname">Input/OutputObjectState</code> and <code class="classname">Input/OutputBuffer</code> classes.
			</div><div class="para">
				The <code class="classname">InputBuffer</code> class in <a class="xref" href="ch10.html#example-InputBuffer">Example 10.2, “InputBuffer”</a> and the <code class="classname">OutputBuffer</code> classes in <a class="xref" href="ch10.html#example-OutputBuffer">Example 10.1, “OutputBuffer Example”</a> maintain an internal array into which instances of the standard Java types can be contiguously packed (unpacked) using the pack (unpack) operations. This buffer is automatically resized as required. The instances are all stored in the buffer in a standard form called <em class="firstterm">network byte order</em>, making them machine-independent.
			</div><div class="example"><a id="example-OutputBuffer">
      ⁠</a><p class="title"><strong>Example 10.1. OutputBuffer Example</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> OutputBuffer
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Function">OutputBuffer</span> ();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">valid</span> ();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">byte</span>[] buffer();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">length</span> ();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/* pack operations for standard Java types */</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">packByte</span> (<span xmlns="" class="perl_DataType">byte</span> b) <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">packBytes</span> (<span xmlns="" class="perl_DataType">byte</span>[] b) <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">packBoolean</span> (<span xmlns="" class="perl_DataType">boolean</span> b) <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">packChar</span> (<span xmlns="" class="perl_DataType">char</span> c) <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">packShort</span> (<span xmlns="" class="perl_DataType">short</span> s) <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">packInt</span> (<span xmlns="" class="perl_DataType">int</span> i) <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">packLong</span> (<span xmlns="" class="perl_DataType">long</span> l) <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">packFloat</span> (<span xmlns="" class="perl_DataType">float</span> f) <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">packDouble</span> (<span xmlns="" class="perl_DataType">double</span> d) <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">packString</span> (String s) <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>};</pre></div></div><div class="example"><a id="example-InputBuffer">
      ⁠</a><p class="title"><strong>Example 10.2. InputBuffer</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> InputBuffer
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Function">InputBuffer</span> ();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">valid</span> ();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">byte</span>[] buffer();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">length</span> ();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/* unpack operations for standard Java types */</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">byte</span> <span xmlns="" class="perl_Function">unpackByte</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">byte</span>[] <span xmlns="" class="perl_Function">unpackBytes</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">unpackBoolean</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">char</span> <span xmlns="" class="perl_Function">unpackChar</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">short</span> <span xmlns="" class="perl_Function">unpackShort</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">unpackInt</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">long</span> <span xmlns="" class="perl_Function">unpackLong</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">float</span> <span xmlns="" class="perl_Function">unpackFloat</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">double</span> <span xmlns="" class="perl_Function">unpackDouble</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> String <span xmlns="" class="perl_Function">unpackString</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>};</pre></div></div><div class="example"><a id="example-OutputObjectState">
      ⁠</a><p class="title"><strong>Example 10.3. OutputObjectState</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">class</span> OutputObjectState <span xmlns="" class="perl_Keyword">extends</span> OutputBuffer
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Function">OutputObjectState</span> (Uid newUid, String typeName);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> notempty ();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">size</span> ();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Uidpublic <span xmlns="" class="perl_Keyword">class</span> InputBuffer
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Function">InputBuffer</span> ();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">valid</span> ();
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">byte</span>[] buffer();
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">length</span> ();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Comment">/* unpack operations for standard Java types */</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">byte</span> <span xmlns="" class="perl_Function">unpackByte</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">byte</span>[] <span xmlns="" class="perl_Function">unpackBytes</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">unpackBoolean</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">char</span> <span xmlns="" class="perl_Function">unpackChar</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">short</span> <span xmlns="" class="perl_Function">unpackShort</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">unpackInt</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">long</span> <span xmlns="" class="perl_Function">unpackLong</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">float</span> <span xmlns="" class="perl_Function">unpackFloat</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">double</span> <span xmlns="" class="perl_Function">unpackDouble</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> String <span xmlns="" class="perl_Function">unpackString</span> () <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>    };</pre></div></div><div class="example"><a id="example-InputObjectState">
      ⁠</a><p class="title"><strong>Example 10.4. InputObjectState</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">class</span> InputObjectState <span xmlns="" class="perl_Keyword">extends</span> InputBuffer
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Function">InputObjectState</span> (Uid newUid, String typeName, <span xmlns="" class="perl_DataType">byte</span>[] b);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> notempty ();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">size</span> ();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Uid <span xmlns="" class="perl_Function">stateUid</span> ();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> String type ();
<span xmlns="" class="line">​</span>};</pre></div></div><div class="para">
				The <a class="xref" href="ch10.html#example-InputObjectState">Example 10.4, “InputObjectState”</a> and <a class="xref" href="ch10.html#example-OutputObjectState">Example 10.3, “OutputObjectState”</a> classes provides all the functionality of the <code class="classname">InputBuffer</code> and <code class="classname">OutputBuffer</code> classes, through inheritance. They also add two additional instance variables that signify the Uid and type of the object for which the <code class="classname">InputObjectState</code> or <code class="classname">OutputObjectState</code> instance is a compressed image. These are used when accessing the object store during storage and retrieval of the object state.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019172814624">
      ⁠</a>10.2.2. The Object Store</h2></div></div></div><div class="para">
				The Object Store provided with JBoss Transaction Service has a fairly restricted interface so that it can be implemented in a variety of ways. For example, object stores may reside in shared memory, in a local file system, or in a remote database. More complete information about the Object Stores available in JBoss Transaction Service can be found in the Appendix.

			</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					As with all JBoss Transaction Service classes, the default Object Stores are pure Java implementations. You need to use native methods to access the shared memory and other more complex object store implementations.
				</div></div></div><div class="para">
				All of the object stores hold and retrieve instances of the <code class="classname">InputObjectState</code> and <code class="classname">OutputObjectState</code> classes, which are named by the Uid and Type of the object that they represent. States are read using the <code class="methodname">read_committed</code> method and written by the system using the <code class="methodname">write_uncommitted</code> method. Normally, new object states do not overwrite old object states, but are written to the store as shadow copies. These shadows replace the original only when the <code class="methodname">commit_state</code> method is invoked. All interaction with the object store is performed by JBoss Transaction Service system components as appropriate, hiding the existence of any shadow versions of objects from the programmer.
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> ObjectStore
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> OS_COMMITTED;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> OS_UNCOMMITTED;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> OS_COMMITTED_HIDDEN;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> OS_UNCOMMITTED_HIDDEN;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> OS_UNKNOWN;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/* The abstract interface */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">commit_state</span> (Uid u, String name)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> ObjectStoreException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> InputObjectState <span xmlns="" class="perl_Function">read_committed</span> (Uid u, String name)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> ObjectStoreException;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">write_uncommitted</span> (Uid u, String name,
<span xmlns="" class="line">​</span>					       OutputObjectState os) <span xmlns="" class="perl_Keyword">throws</span> ObjectStoreException;
<span xmlns="" class="line">​</span>    . . .
<span xmlns="" class="line">​</span>};</pre><div class="para">
				When a transactional object is committing, it needs to make certain state changes persistent, so that it can recover in the event of a failure and either continue to commit, or rollback. When using Transactional Objects for Java, JBoss Transaction Service manages this persistence automatically. To guarantee ACID properties, these state changes are flushed to the persistence store implementation before the transaction commits. Otherwise, the application assumes that the transaction has committed, even though the state changes may still exist within an operating system cache, vulnerable to a system failure. By default, JBoss Transaction Service flushes such state changes. As a trade-off, this behavior can impose a significant performance penalty on the application. To prevent transactional object state flushes, set the <code class="literal">com.arjuna.ats.arjuna.objectstore.objectStoreSync</code> variable to OFF.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019151319104">
      ⁠</a>10.2.3. StateManager</h2></div></div></div><div class="para">
				The JBoss Transaction Service class <code class="classname">StateManager</code> manages the state of an object and provides all of the basic state-management support mechanisms. <code class="classname">StateManager</code> creates and registers appropriate resources for persistence and recovery of the transactional object. If a transaction is nested, then <code class="classname">StateManager</code> propagates these resources between child transactions and their parents during the <code class="methodname">commit</code> phase.
			</div><div class="para">
				Objects in JBoss Transaction Service might be recoverable, persistent, both, or neither. If recoverable, <code class="classname">StateManager</code> tries to generate and maintain appropriate recovery information for the object, storing the information in instances of the <code class="classname">Input/OutputObjectState</code> class. The lifetimes of these objects are assumed to be shorter than the application which created them. Recoverable and persistent objects are assumed to live longer than the applications that created them, so <code class="classname">StateManager</code> loads or unloads persistent states for the object by calling the <code class="methodname">activate</code> or <code class="methodname">deactivate</code> method. Objects which are neither recoverable nor persistent do not have any state data stored.
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> ObjectStatus
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> PASSIVE;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> PASSIVE_NEW;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> ACTIVE;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> ACTIVE_NEW;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> UNKNOWN_STATUS;
<span xmlns="" class="line">​</span>};
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> ObjectType
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> RECOVERABLE;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> ANDPERSISTENT;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> NEITHER;
<span xmlns="" class="line">​</span>};
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> StateManager
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">activate</span> ();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">activate</span> (String storeRoot);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">deactivate</span> ();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">deactivate</span> (String storeRoot, <span xmlns="" class="perl_DataType">boolean</span> commit);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">destroy</span> ();
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">final</span> Uid <span xmlns="" class="perl_Function">get_uid</span> ();
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">restore_state</span> (InputObjectState, <span xmlns="" class="perl_DataType">int</span> ObjectType);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">save_state</span> (OutputObjectState, <span xmlns="" class="perl_DataType">int</span> ObjectType);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> String type ();
<span xmlns="" class="line">​</span>    . . .
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_Function">StateManager</span> ();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_Function">StateManager</span> (<span xmlns="" class="perl_DataType">int</span> ObjectType, ObjectName attr);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_Function">StateManager</span> (Uid uid);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_Function">StateManager</span> (Uid uid, ObjectName attr);
<span xmlns="" class="line">​</span>    . . .
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">modified</span> ();
<span xmlns="" class="line">​</span>    . . .
<span xmlns="" class="line">​</span>};
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> ObjectModel
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> SINGLE;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> MULTIPLE;
<span xmlns="" class="line">​</span>};</pre><div class="para">
				If an object is recoverable or persistent, <code class="classname">StateManager</code> invokes the <code class="methodname">save_state</code> method during the <code class="methodname">deactivation</code> method. The <code class="methodname">restore_state</code> is called during the <code class="methodname">activate</code>. The <code class="methodname">type</code> is called at various points during the execution of the application. The programmer must implement these methods, since <code class="classname">StateManager</code> does not have access to a runtime description of the layout of an arbitrary Java object in memory. However, the capabilities provided by <code class="classname">InputObjectState</code> and <code class="classname">OutputObjectState</code> classes simplify the writing of these routines. For example, the <code class="methodname">save_state</code> implementation for a class <code class="classname">Example</code> that had member variables called A, B and C might adhere to <a class="xref" href="ch10.html#example-save_state">Example 10.5, “<code class="methodname">save_state</code> Example”</a>
			</div><div class="example"><a id="example-save_state">
      ⁠</a><p class="title"><strong>Example 10.5. <code class="methodname">save_state</code> Example</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">save_state</span> ( OutputObjectState os, <span xmlns="" class="perl_DataType">int</span> ObjectType )
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">if</span> (!<span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">save_state</span>(os, ObjectType))
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    os.<span xmlns="" class="perl_Function">packInt</span>(A);
<span xmlns="" class="line">​</span>	    os.<span xmlns="" class="perl_Function">packString</span>(B);
<span xmlns="" class="line">​</span>	    os.<span xmlns="" class="perl_Function">packFloat</span>(C);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">catch</span> (IOException e)
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>}</pre></div></div><div class="para">
				To support crash recovery for persistent objects, all <code class="methodname">save_state</code> and <code class="methodname">restore_state</code> methods of user objects must call <code class="methodname">super.save_state</code> and <code class="methodname">super.restore_state</code>.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					The <code class="methodname">type</code> method determines the location in the object store where the state of instances of that class will be saved and ultimately restored. This can be any valid string. However, avoid using the hash character <span class="keycap"><strong>#</strong></span>, which is reserved for special directories required by JBoss Transaction Service.
				</div></div></div><div class="para">
				The <code class="methodname">get_uid</code> method of <code class="classname">StateManager</code> provides read-only access to an object’s internal system name. The value of the internal system name can only be set when an object is created,by providing it as an explicit parameter or by generating a new identifier when the object is created.
			</div><div class="para">
				The <code class="methodname">destroy</code> method removes the object’s state from the object store. This is an atomic operation, which only removes the state if its invoking transaction commits. The programmer must guarantee exclusive access to the object before invoking this operation.
			</div><div class="para">
				Since object recovery and persistence have complimentary requirements, the <code class="classname">StateManager</code> class combines the management of both into a single mechanism. That is, it uses instances of the class Input/OutputObjectState both for recovery and persistence purposes. An additional argument passed to the <code class="command">save_state</code> and <code class="command">restore_state</code> operations allows the programmer to determine the purpose for which any given invocation is being made thus allowing different information to be saved for recovery and persistence purposes.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019110802096">
      ⁠</a>10.2.4. Object Models</h2></div></div></div><div class="para">
				JBoss Transaction Service supports two models for objects. Implementation of the state and concurrency controls depend on which model is used.
			</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Single</span></dt><dd><div class="para">
							The application only contains a single copy of the object The object resides within a single JVM, and all clients must address their invocations to this server. The single model provides better performance, but creates a single point of failure. In a multi-threaded environment, the object may not be protected from corruption if a single thread fails.
						</div><div class="mediaobject" style="text-align: center"><a id="figure-single_object_model">
      ⁠</a><img src="images/Single_Object.png" align="middle" alt="Object Models" style="text-align: middle"/><div class="caption">Single Object Model</div></div></dd><dt><span class="term">Multiple</span></dt><dd><div class="para">
							Logically, a single instance of the object exists. Copies of the object are distributed across multiple JVMs. Performance suffers compared to the single model, better failure isolation is achieved.
						</div><div class="mediaobject" style="text-align: center"><a id="figure-multiple_object_model">
      ⁠</a><img src="images/Multiple_Object.png" align="middle" alt="Object Models" style="text-align: middle"/><div class="caption">Multiple Object Model</div></div></dd></dl></div><div class="para">
				The <em class="wordasword">single</em> model is the default. You can override this on a per-object basis by providing an appropriate instance of the <code class="classname">com.arjuna.ats.arjuna.gandiva.ObjectName</code> class when you create your object.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					You can change the model before any instantiation of the object There is no need for it to remain the same during the object's lifetime.
				</div></div></div><div class="para">
				Use the following method to provide a suitable <code class="classname">ObjectName</code> class. Refer to <a class="xref" href="ch10.html#example-object-models">Example 10.6, “Object Models”</a> for an example.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
						Create a new instance of <code class="classname">ObjectName</code>.
					</div></li><li class="listitem"><div class="para">
						Set the object model attribute using the <code class="literal">com.arjuna.ats.arjuna.ArjunaNames.StateManager_objectModel()</code> name.
					</div></li></ol></div><div class="example"><a id="example-object-models">
      ⁠</a><p class="title"><strong>Example 10.6. Object Models</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    ObjectName attr = <span xmlns="" class="perl_Keyword">new</span> ObjectName(“SNS:myObjectName”);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    attr.<span xmlns="" class="perl_Function">setLongAttribute</span>(ArjunaNames.<span xmlns="" class="perl_Function">StateManager_objectModel</span>(),
<span xmlns="" class="line">​</span>			  ObjectModel.<span xmlns="" class="perl_Function">SINGLE</span>);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    AtomicObject obj = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">AtomicObject</span>(ObjectType.<span xmlns="" class="perl_Function">ANDPERSISTENT</span>, attr);
<span xmlns="" class="line">​</span>}</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019169383920">
      ⁠</a>10.2.5. JBoss Transaction Service Method Reference</h2></div></div></div><div class="para">
				The JBoss Transaction Service class <code class="classname">StateManager</code> manages the state of objects and provides all of the basic support mechanisms required for recovery, persistence, or both. Some operations must be defined by you. These operations are: <code class="methodname">save_state</code>, <code class="methodname">restore_state</code>, and <code class="methodname">type</code>.
			</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="type">boolean</span> <code class="methodname">save_state</code>(<span class="type">OutputObjectState</span> <em class="parameter"><code>state</code></em>, <span class="type">int</span> <em class="parameter"><code>ObjectType</code></em>)</span></dt><dd><div class="para">
							Invoked to save the state of an object for future use, for recovery or persistence. The <code class="varname">ObjectType</code> parameter indicates the reason for invocation. This allows you to save different pieces of information into the <code class="classname">OutputObjectState</code> supplied as the first parameter, depending on whether recovery or persistence is desired. For example, pointers to other JBoss Transaction Service objects may be saved as pointers for recovery, but as UIDs for persistence. The <code class="classname">OutputObjectState</code> class provides convenient operations, so that you can save instances of all of the basic types in Java. To support crash recovery for persistent objects all <code class="methodname">save_state</code> methods need to call <code class="methodname">super.save_state</code>.
						</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
								The <code class="methodname">save_state</code> method assumes that an object is internally consistent and that all variables saved have valid values. Write and test your code to be sure this is true.
							</div></div></div></dd><dt><span class="term"><span class="type">boolean</span> <code class="methodname">restore_state</code>(<span class="type">InputObjectState</span> <em class="parameter"><code>state</code></em>, <span class="type">int</span> <em class="parameter"><code>ObjectType</code></em>)</span></dt><dd><div class="para">
							Restores an object to the specified state. The second parameter allows different interpretations of the supplied state. To support crash recovery for persistent objects all <code class="methodname">restore_state</code> methods need to call <code class="methodname">super.restore_state</code>.
						</div></dd><dt><span class="term"><span class="type">String</span> <code class="methodname">type ()</code></span></dt><dd><div class="para">
							The JBoss Transaction Service persistence mechanism needs a way to determine the type of an object as a string, so that it can save and restore the state of the object. By convention, the position of the class in the hierarchy is used. For example, <code class="classname">StateManager</code>/<code class="classname">LockManager</code>/<code class="classname">Object</code>.
						</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
								The <code class="methodname">type</code> method determines the location of the state of instances of a specified class are saved into the object store. This can actually be any valid string. However, avoid using the hash character <span class="keycap"><strong>#</strong></span>, which is reserved for special directories required by JBoss Transaction Service.
							</div></div></div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019166173536">
      ⁠</a>10.2.6. Example</h2></div></div></div><div class="para">
				<a class="xref" href="ch10.html#example-array-class">Example 10.7, “Saving and Restoring an Object's State”</a> shows a basic <code class="classname">Array</code> class derived from the <code class="classname">StateManager</code> class. To illustrate saving and restoring of an object’s state, the <code class="varname">highestIndex</code> variable keeps track of the highest element of the array that has a non-zero value.
			</div><div class="example"><a id="example-array-class">
      ⁠</a><p class="title"><strong>Example 10.7. Saving and Restoring an Object's State</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> Array <span xmlns="" class="perl_Keyword">extends</span> StateManager
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Array ();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Array (Uid objUid);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">finalize</span> ( <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">terminate</span>(); };
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/* Class specific operations. */</span>
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> set (<span xmlns="" class="perl_DataType">int</span> index, <span xmlns="" class="perl_DataType">int</span> value);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">get</span> (<span xmlns="" class="perl_DataType">int</span> index);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/* State management specific operations. */</span>
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">save_state</span> (OutputObjectState os, <span xmlns="" class="perl_DataType">int</span> ObjectType);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">restore_state</span> (InputObjectState os, <span xmlns="" class="perl_DataType">int</span> ObjectType);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> String type ();
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> ARRAY_SIZE = <span xmlns="" class="perl_Float">10</span>;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">int</span>[] elements = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_DataType">int</span>[ARRAY_SIZE];
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">int</span> highestIndex;
<span xmlns="" class="line">​</span>};</pre><div class="para">
					The <code class="methodname">save_state</code>, <code class="methodname">restore_state</code> and <code class="methodname">type</code> operations can be defined as follows:
				</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/* Ignore ObjectType parameter for simplicity */</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">save_state</span> (OutputObjectState os, <span xmlns="" class="perl_DataType">int</span> ObjectType)
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">if</span> (!<span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">save_state</span>(os, ObjectType))
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>	{    
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Function">packInt</span>(highestIndex);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Comment">/*</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">	     * Traverse array state that we wish to save. Only save active elements</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">	     */</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">for</span> (<span xmlns="" class="perl_DataType">int</span> i = <span xmlns="" class="perl_Float">0</span>; i &lt;= highestIndex; i++)
<span xmlns="" class="line">​</span>		os.<span xmlns="" class="perl_Function">packInt</span>(elements[i]);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">catch</span> (IOException e)
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">restore_state</span> (InputObjectState os, <span xmlns="" class="perl_DataType">int</span> ObjectType)
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">if</span> (!<span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">restore_state</span>(os, ObjectType))
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_DataType">int</span> i = <span xmlns="" class="perl_Float">0</span>;
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    highestIndex = os.<span xmlns="" class="perl_Function">unpackInt</span>();
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">while</span> (i &lt; ARRAY_SIZE)
<span xmlns="" class="line">​</span>		{
<span xmlns="" class="line">​</span>		    <span xmlns="" class="perl_Keyword">if</span> (i &lt;= highestIndex)
<span xmlns="" class="line">​</span>			elements[i] =  os.<span xmlns="" class="perl_Function">unpackInt</span>();
<span xmlns="" class="line">​</span>		    <span xmlns="" class="perl_Keyword">else</span>
<span xmlns="" class="line">​</span>			elements[i] = <span xmlns="" class="perl_Float">0</span>;
<span xmlns="" class="line">​</span>		    i++;
<span xmlns="" class="line">​</span>		}
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">catch</span> (IOException e)
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> String type ()
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">return</span> '/StateManager/Array';
<span xmlns="" class="line">​</span>}</pre></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm140019170727296">
      ⁠</a>10.3. Lock Management and Concurrency Control</h1></div></div></div><div class="para">
			Concurrency control information within JBoss Transaction Service is maintained by locks. Some of these locks need to be used by multiple objects in different processes. They can be held in a lock store, similar to the object store used for state information. The lock store used with JBoss Transaction Service has a restricted interface which allows flexibility with regard to implementation. Lock stores can be implemented in shared memory, on the Unix file system in several different formats, or as a remotely accessible store.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				As with all JBoss Transaction Service classes, the default lock stores are pure Java implementations. If you want to use more complex lock implementations, you must use native methods.
			</div></div></div><div class="example"><a id="example-lockStore">
      ⁠</a><p class="title"><strong>Example 10.8. Example LockStore Class</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> LockStore
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> InputObjectState <span xmlns="" class="perl_Function">read_state</span> (Uid u, String tName)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> LockStoreException;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">remove_state</span> (Uid u, String tname);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">write_committed</span> (Uid u, String tName,
<span xmlns="" class="line">​</span>					     OutputObjectState state);
<span xmlns="" class="line">​</span>};</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019108934800">
      ⁠</a>10.3.1. Selecting a Lock Store Implementation</h2></div></div></div><div class="para">
				JBoss Transaction Service supports several different object store implementations. If the object model being used is <em class="wordasword">Single</em>, no lock store is required for maintaining locks, because the information about the object is not exported from it. However, if you use the <em class="wordasword">Multiple</em> model, different run-time environments may need to share concurrency control information. You can specify the implementation type of the lock store to use for all objects within a given execution environment using the <code class="varname">com.arjuna.ats.txoj.lockstore.lockStoreType</code> property. This variable can be either:
			</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">BasicLockStore</span></dt><dd><div class="para">
							This is an in-memory implementation which does not include support for sharing of stored information between execution environments. You can extend it to include this functionality, if needed.
						</div></dd><dt><span class="term">BasicPersistentLockStore</span></dt><dd><div class="para">
							This is the default implementation. It stores locking information within the local file system. Execution environments that share the same file store can share concurrency control information. The root of the file system into which locking information is written is the <code class="filename">LockStore/</code> directory within the JBoss Transaction Service installation directory. To override this location, set the <code class="varname">com.arjuna.ats.txoj.lockstore.lockStoreDir</code> property accordingly, or include the location in the <code class="varname">CLASSPATH</code>:
						</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><p class="title"><strong>How to Override the lockStoreDir Property</strong></p><ul><li class="listitem"><div class="para">
									<code class="command">java -D com.arjuna.ats.txoj.lockstore.lockStoreDir=/var/tmp/LockStore myprogram</code>
								</div></li><li class="listitem"><div class="para">
									<code class="command">java –classpath $CLASSPATH;/var/tmp/LockStore myprogram</code>
								</div></li></ul></div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019181846448">
      ⁠</a>10.3.2. LockManager</h2></div></div></div><div class="para">
				The concurrency controller is implemented by the class <code class="classname">LockManager</code>, which provides sensible default behavior that you can override if necessary. The <code class="methodname">setlock</code> method is the primary interface to the concurrency controller. By default, the JBoss Transaction Service runtime system enforces strict two-phase locking, following a <em class="firstterm">multiple reader, single writer</em> policy on a per-object basis. You, as the programmer, control lock acquisition, since the <code class="classname">LockManager</code> class cannot predict whether an operation needs a read or write lock. Lock release, however, is normally under control of the system, requiring no action by the programmer.
			</div><div class="para">
				The <code class="classname">LockManager</code> class manages requests to set a lock on an object or to release a lock. However, since it is derived from <code class="classname">StateManager</code>, it can also control invocation of some of the inherited facilities. For example, if a request to set a write lock is granted, then <code class="classname">LockManager</code> invokes the <code class="methodname">modified</code> method directly, since setting a write lock implies that the invoking method is about to modify the object. This may cause recovery information to be saved, if the object is recoverable. Successful lock acquisition also triggers invocation of the <code class="methodname">activate</code>.
			</div><div class="para">
				Therefore, <code class="classname">LockManager</code> activates and deactivates persistent objects, and also registers <code class="classname">Resources</code> used for managing concurrency control. By driving the <code class="classname">StateManager</code> class, it also registers <code class="classname">Resources</code> for persistent and recoverable state manipulation and object recovery. You only set the appropriate locks, start and end transactions, and extend the <code class="methodname">save_state</code> and <code class="methodname">restore_state</code> methods of the <code class="classname">StateManager</code> class.
			</div><div class="example"><a id="example-LockResult">
      ⁠</a><p class="title"><strong>Example 10.9. LockResult Example</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> LockResult
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> GRANTED;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> REFUSED;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> RELEASED;
<span xmlns="" class="line">​</span>};
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> ConflictType
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> CONFLICT;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> COMPATIBLE;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> PRESENT;
<span xmlns="" class="line">​</span>};
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> LockManager <span xmlns="" class="perl_Keyword">extends</span> StateManager
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> defaultTimeout;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> defaultRetry;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> waitTotalTimeout;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">setlock</span> (Lock l);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">setlock</span> (Lock l, <span xmlns="" class="perl_DataType">int</span> retry);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">setlock</span> (Lock l, <span xmlns="" class="perl_DataType">int</span> retry, <span xmlns="" class="perl_DataType">int</span> sleepTime);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">synchronized</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">releaselock</span> (Uid uid);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/* abstract methods inherited from StateManager */</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">restore_state</span> (InputObjectState os, <span xmlns="" class="perl_DataType">int</span> ObjectType);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">save_state</span> (OutputObjectState os, <span xmlns="" class="perl_DataType">int</span> ObjectType);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> String type ();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_Function">LockManager</span> ();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_Function">LockManager</span> (<span xmlns="" class="perl_DataType">int</span> ObjectType, ObjectName attr);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_Function">LockManager</span> (Uid storeUid);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_Function">LockManager</span> (Uid storeUid, <span xmlns="" class="perl_DataType">int</span> ObjectType, ObjectName attr);
<span xmlns="" class="line">​</span>    . . .
<span xmlns="" class="line">​</span>};</pre></div></div><div class="para">
				You need to pass the type of lock required and the number of retries to acquire the lock,as parameters to the <code class="methodname">setlock</code> method. The type is either <code class="literal">READ</code> or <code class="literal">WRITE</code>. If a lock conflict occurs, one of the following scenarios will take place:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						If the retry value is equal to <code class="varname">LockManager.waitTotalTimeout</code>, the thread which called the <code class="methodname">setlock</code> method is blocked until the lock is released, or the total timeout specified has elapsed. In the case of a time-out, a value of <code class="literal">REFUSED</code> is returned.
					</div></li><li class="listitem"><div class="para">
						If the lock cannot be obtained initially,<code class="classname">LockManager</code> retries the specified number of times, waiting for the specified timeout value between each failed attempt. The default is 100 attempts, each attempt being separated by a 0.25 seconds delay.
					</div></li></ul></div><div class="para">
				If a lock conflict occurs, the lock request is timed out, to prevent deadlocks. A full deadlock detection scheme is not provided. If the requested lock is obtained, the <code class="methodname">setlock</code> method returns a value of <code class="literal">GRANTED</code>. Otherwise, a value of <code class="literal">REFUSED</code> is returned. You need to ensure that the remainder of the code for an operation is only executed if a lock request is granted. Refer to <a class="xref" href="ch10.html#example-setlock">Example 10.10, “<code class="methodname">setlock</code> Example”</a> for a working example.
			</div><div class="example"><a id="example-setlock">
      ⁠</a><p class="title"><strong>Example 10.10. <code class="methodname">setlock</code> Example</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>res = <span xmlns="" class="perl_Function">setlock</span>(<span xmlns="" class="perl_Keyword">new</span> Lock(WRITE), <span xmlns="" class="perl_Float">10</span>); 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// Attempts to set a write</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// lock 11 times (10 retries)</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// before giving up.</span>
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>res = <span xmlns="" class="perl_Function">setlock</span>(<span xmlns="" class="perl_Keyword">new</span> Lock(READ), <span xmlns="" class="perl_Float">0</span>); 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// Attempts to set a read lock</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// 1 time (no retries) before</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// giving up.</span>
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>res = <span xmlns="" class="perl_Function">setlock</span>(<span xmlns="" class="perl_Keyword">new</span> Lock(WRITE); 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// Attempts to set a write lock</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// 101 times (default of 100</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// retries) before giving up.</span>
</pre></div></div><div class="para">
				The concurrency control mechanism is integrated into the atomic action mechanism to ensure that as locks are granted on an object, appropriate information is registered with the currently running atomic action. This guarantees that the locks are released at the correct time, and removes the need to explicitly free locks which were acquired within atomic actions. However, if locks are acquired on an object outside of the scope of an atomic action, you must use the <code class="methodname">releaselock</code> method to release the locks.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019109085920">
      ⁠</a>10.3.3. Locking policy</h2></div></div></div><div class="para">
				Locks in JBoss Transaction Service are not special system types. They are, instead, instances of other JBoss Transaction Service objects. The <code class="classname">Lock</code> class is derived from <code class="classname">StateManager</code> so that locks can be made persistent and can be named in a simple way. Furthermore, the <code class="classname">LockManager</code> class does not know about the semantics of the actual policy for granting lock requests. Instances of the <code class="classname">Lock</code> class maintain this information, and provide the <code class="methodname">conflictsWith</code> method, which <code class="classname">LockManager</code> uses to determine whether two locks conflict. This separation allows you to derive new lock types from the basic <code class="classname">Lock</code> class and provides appropriate definitions of the conflict operations, allowing enhanced levels of concurrency.
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> LockMode
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> READ;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> WRITE;
<span xmlns="" class="line">​</span>};
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> LockStatus
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> LOCKFREE;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> LOCKHELD;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">int</span> LOCKRETAINED;
<span xmlns="" class="line">​</span>};
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> Lock <span xmlns="" class="perl_Keyword">extends</span> StateManager
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Lock (<span xmlns="" class="perl_DataType">int</span> lockMode);
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">conflictsWith</span>  (Lock otherLock);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">modifiesObject</span> ();
<span xmlns="" class="line">​</span>      
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">restore_state</span> (InputObjectState os, <span xmlns="" class="perl_DataType">int</span> ObjectType);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">save_state</span> (OutputObjectState os, <span xmlns="" class="perl_DataType">int</span> ObjectType);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> String type ();
<span xmlns="" class="line">​</span>    . . .
<span xmlns="" class="line">​</span>};</pre><div class="para">
				The <code class="classname">Lock</code> class provides a <code class="methodname">modifiesObject</code> method, which <code class="classname">LockManager</code> uses to determine a call or method is needed to grant a locking request. This allows locking modes other than simple read and write to be supported. The supplied <code class="classname">Lock</code> class supports the traditional multiple reader/single writer policy.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm140019151780656">
      ⁠</a>10.3.4. Object construction and destruction</h2></div></div></div><div class="para">
				JBoss Transaction Service objects can be either recoverable, persistent, both, or neither. Also, each object has a unique internal name. These attributes can only be set when that object is constructed. Therefore, <code class="classname">LockManager</code> provides two protected constructors for use by derived classes, each of which fulfills a distinct purpose:
			</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="methodname">LockManager ()</code></span></dt><dd><div class="para">
							Allows the creation of new objects, which have no prior state.
						</div></dd><dt><span class="term"><code class="methodname">LockManager</code>(<span class="type">int</span> <em class="parameter"><code>ObjectType</code></em>, <span class="type">ObjectName</span> <em class="parameter"><code>attr</code></em>)</span></dt><dd><div class="para">
							Allows the creation of new objects, which have no prior state. The <em class="parameter"><code>ObjectType</code></em> parameter denotes whether an object is <code class="literal">recoverable</code>, recoverable and persistent (indicated by <code class="literal">ANDPERSISTENT</code>) or neither (<code class="literal">NEITHER</code>). If an object is marked as being persistent, its state is stored in one of the object stores. The <em class="parameter"><code>shared</code></em> parameter only has meaning if the object is <code class="literal">RECOVERABLE</code>.; If <code class="literal">attr</code> is not null and the object model is <code class="literal">SINGLE</code> (the default behavior), then the recoverable state of the object is maintained within the object itself. Otherwise, the state of the object is stored in an in-memory object store between atomic actions.
						</div><div class="para">
							Constructors for new persistent objects should make use of atomic actions within themselves. This will ensure that the state of the object is automatically written to the object store either when the action in the constructor commits, or, if an enclosing action exists, when the appropriate top-level action commits.
						</div></dd><dt><span class="term"><code class="methodname">LockManager</code>(<span class="type">Uid</span> <em class="parameter"><code>objUid</code></em>)</span></dt><dd><div class="para">
							Allows access to the existing persistent object named in the <em class="parameter"><code>objUid</code></em> parameter. The object's prior state, which is identified by the value of the <em class="parameter"><code>objUid</code></em> parameter), is loaded from an object store automatically.
						</div></dd><dt><span class="term"><code class="methodname">LockManager</code>(<span class="type">Uid</span> <em class="parameter"><code>objUid</code></em>, <span class="type">ObjectName</span> <em class="parameter"><code>attr</code></em>)</span></dt><dd><div class="para">
							Allows access to the existing persistent object named in the <em class="parameter"><code>objUid</code></em> parameter. The object's prior state, which is identified by the value of the <em class="parameter"><code>objUid</code></em>, is loaded from an object store automatically. If the <em class="parameter"><code>attr</code></em> parameter is not null, and the object model is <code class="literal">SINGLE</code> (the default behavior), then the object is not reactivated at the start of each top-level transaction.
						</div></dd></dl></div><div class="para">
				The destructor of a programmer-defined class needs to invoke the inherited operation <code class="methodname">terminate</code>, to inform the state management mechanism that the object is about to be destroyed. Otherwise, unpredictable results may occur.
			</div><div class="para">
				Because the <code class="classname">LockManager</code> class inherits from <code class="classname">StateManager</code>, it passes any supplied <code class="classname">ObjectName</code> instances to the <code class="classname">StateManager</code> class. As such, you can set the <code class="classname">StateManager</code> object model as described earlier.
			</div></div></div></div></body></html>