<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 17. Filtering data</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="filters">
      ⁠</a>Chapter 17. Filtering data</h1></div></div></div><div class="para">
		Hibernate3 provides an innovative new approach to handling data with "visibility" rules. A <span class="emphasis"><em>Hibernate filter</em></span> is a global, named, parameterized filter that can be enabled or disabled for a particular Hibernate session.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="objectstate-filters">
      ⁠</a>17.1. Hibernate filters</h1></div></div></div><div class="para">
			Hibernate3 has the ability to pre-define filter criteria and attach those filters at both a class level and a collection level. A filter criteria allows you to define a restriction clause similar to the existing "where" attribute available on the class and various collection elements. These filter conditions, however, can be parameterized. The application can then decide at runtime whether certain filters should be enabled and what their parameter values should be. Filters can be used like database views, but they are parameterized inside the application.
		</div><div class="para">
			In order to use filters, they must first be defined and then attached to the appropriate mapping elements. To define a filter, use the <code class="literal">&lt;filter-def/&gt;</code> element within a <code class="literal">&lt;hibernate-mapping/&gt;</code> element:
		</div><pre class="programlisting">&lt;filter-def name="myFilter"&gt;
    &lt;filter-param name="myFilterParam" type="string"/&gt;
&lt;/filter-def&gt;</pre><div class="para">
			This filter can then be attached to a class:
		</div><pre class="programlisting">&lt;class name="myClass" ...&gt;
    ...
    &lt;filter name="myFilter" condition=":myFilterParam = MY_FILTERED_COLUMN"/&gt;
&lt;/class&gt;</pre><div class="para">
			Or, to a collection:
		</div><pre class="programlisting">&lt;set ...&gt;
    &lt;filter name="myFilter" condition=":myFilterParam = MY_FILTERED_COLUMN"/&gt;
&lt;/set&gt;</pre><div class="para">
			Or, to both or multiples of each at the same time.
		</div><div class="para">
			The methods on <code class="literal">Session</code> are: <code class="literal">enableFilter(String filterName)</code>, <code class="literal">getEnabledFilter(String filterName)</code>, and <code class="literal">disableFilter(String filterName)</code>. By default, filters are <span class="emphasis"><em>not</em></span> enabled for a given session. Filters must be enabled through use of the <code class="literal">Session.enableFilter()</code> method, which returns an instance of the <code class="literal">Filter</code> interface. If you used the simple filter defined above, it would look like this:
		</div><pre class="programlisting">session.enableFilter("myFilter").setParameter("myFilterParam", "some-value");</pre><div class="para">
			Methods on the org.hibernate.Filter interface do allow the method-chaining common to much of Hibernate.
		</div><div class="para">
			The following is a full example, using temporal data with an effective record date pattern:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;filter-def</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"effectiveDate"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;filter-param</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"asOfDate"</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"date"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/filter-def&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;class</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"Employee"</span> <span xmlns="" class="perl_Error">...</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>...
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;many-to-one</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"department"</span><span xmlns="" class="perl_Others"> column=</span><span xmlns="" class="perl_String">"dept_id"</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"Department"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;property</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"effectiveStartDate"</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"date"</span><span xmlns="" class="perl_Others"> column=</span><span xmlns="" class="perl_String">"eff_start_dt"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;property</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"effectiveEndDate"</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"date"</span><span xmlns="" class="perl_Others"> column=</span><span xmlns="" class="perl_String">"eff_end_dt"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>...
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!--</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">        </span><span xmlns="" class="perl_Alert">Note</span><span xmlns="" class="perl_Comment"> that this assumes non-terminal records have an eff_end_dt set to</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">        a max db date for simplicity-sake</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">    --&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;filter</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"effectiveDate"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            condition=</span><span xmlns="" class="perl_String">":asOfDate BETWEEN eff_start_dt and eff_end_dt"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/class&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;class</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"Department"</span> <span xmlns="" class="perl_Error">...</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>...
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;set</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"employees"</span><span xmlns="" class="perl_Others"> lazy=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;key</span><span xmlns="" class="perl_Others"> column=</span><span xmlns="" class="perl_String">"dept_id"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;one-to-many</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"Employee"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;filter</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"effectiveDate"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">                condition=</span><span xmlns="" class="perl_String">":asOfDate BETWEEN eff_start_dt and eff_end_dt"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/set&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/class&gt;</span></pre><div class="para">
			In order to ensure that you are provided with currently effective records, enable the filter on the session prior to retrieving employee data:
		</div><pre class="programlisting">Session session = ...;
session.enableFilter("effectiveDate").setParameter("asOfDate", new Date());
List results = session.createQuery("from Employee as e where e.salary &gt; :targetSalary")
         .setLong("targetSalary", new Long(1000000))
         .list();
</pre><div class="para">
			Even though a salary constraint was mentioned explicitly on the results in the above HQL, because of the enabled filter, the query will return only currently active employees who have a salary greater than one million dollars.
		</div><div class="para">
			If you want to use filters with outer joining, either through HQL or load fetching, be careful of the direction of the condition expression. It is safest to set this up for left outer joining. Place the parameter first followed by the column name(s) after the operator.
		</div><div class="para">
			After being defined, a filter might be attached to multiple entities and/or collections each with its own condition. This can be problematic when the conditions are the same each time. Using <code class="literal">&lt;filter-def/&gt;</code> allows you to define a default condition, either as an attribute or CDATA:
		</div><pre class="programlisting">&lt;filter-def name="myFilter" condition="abc &gt; xyz"&gt;...&lt;/filter-def&gt;
&lt;filter-def name="myOtherFilter"&gt;abc=xyz&lt;/filter-def&gt;</pre><div class="para">
			This default condition will be used whenever the filter is attached to something without specifying a condition. This means you can give a specific condition as part of the attachment of the filter that overrides the default condition in that particular case.
		</div></div></div></body></html>