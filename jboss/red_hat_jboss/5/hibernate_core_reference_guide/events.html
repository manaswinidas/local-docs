<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 12. Interceptors and events</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="events">
      ⁠</a>Chapter 12. Interceptors and events</h1></div></div></div><div class="para">
		It is useful for the application to react to certain events that occur inside Hibernate. This allows for the implementation of generic functionality and the extension of Hibernate functionality.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="objectstate-interceptors">
      ⁠</a>12.1. Interceptors</h1></div></div></div><div class="para">
			The <code class="literal">Interceptor</code> interface provides callbacks from the session to the application, allowing the application to inspect and/or manipulate properties of a persistent object before it is saved, updated, deleted or loaded. One possible use for this is to track auditing information. For example, the following <code class="literal">Interceptor</code> automatically sets the <code class="literal">createTimestamp</code> when an <code class="literal">Auditable</code> is created and updates the <code class="literal">lastUpdateTimestamp</code> property when an <code class="literal">Auditable</code> is updated.
		</div><div class="para">
			You can either implement <code class="literal">Interceptor</code> directly or extend <code class="literal">EmptyInterceptor</code>.
		</div><pre class="programlisting Java"><span xmlns="" class="line">​</span>package org.<span xmlns="" class="perl_Function">hibernate</span>.<span xmlns="" class="perl_Function">test</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.io.Serializable;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.util.Date;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.util.Iterator;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.hibernate.EmptyInterceptor;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.hibernate.Transaction;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.hibernate.type.Type;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> AuditInterceptor <span xmlns="" class="perl_Keyword">extends</span> EmptyInterceptor {
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">int</span> updates;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">int</span> creates;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">int</span> loads;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">onDelete</span>(Object entity,
<span xmlns="" class="line">​</span>                         Serializable id,
<span xmlns="" class="line">​</span>                         Object[] state,
<span xmlns="" class="line">​</span>                         String[] propertyNames,
<span xmlns="" class="line">​</span>                         Type[] types) {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// do nothing</span>
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">onFlushDirty</span>(Object entity,
<span xmlns="" class="line">​</span>                                Serializable id,
<span xmlns="" class="line">​</span>                                Object[] currentState,
<span xmlns="" class="line">​</span>                                Object[] previousState,
<span xmlns="" class="line">​</span>                                String[] propertyNames,
<span xmlns="" class="line">​</span>                                Type[] types) {
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> ( entity <span xmlns="" class="perl_Keyword">instanceof</span> Auditable ) {
<span xmlns="" class="line">​</span>            updates++;
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">for</span> ( <span xmlns="" class="perl_DataType">int</span> i=<span xmlns="" class="perl_Float">0</span>; i &lt; propertyNames.<span xmlns="" class="perl_Function">length</span>; i++ ) {
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">if</span> ( <span xmlns="" class="perl_String">"lastUpdateTimestamp"</span>.<span xmlns="" class="perl_Function">equals</span>( propertyNames[i] ) ) {
<span xmlns="" class="line">​</span>                    currentState[i] = <span xmlns="" class="perl_Keyword">new</span> Date();
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>                }
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">onLoad</span>(Object entity,
<span xmlns="" class="line">​</span>                          Serializable id,
<span xmlns="" class="line">​</span>                          Object[] state,
<span xmlns="" class="line">​</span>                          String[] propertyNames,
<span xmlns="" class="line">​</span>                          Type[] types) {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> ( entity <span xmlns="" class="perl_Keyword">instanceof</span> Auditable ) {
<span xmlns="" class="line">​</span>            loads++;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">onSave</span>(Object entity,
<span xmlns="" class="line">​</span>                          Serializable id,
<span xmlns="" class="line">​</span>                          Object[] state,
<span xmlns="" class="line">​</span>                          String[] propertyNames,
<span xmlns="" class="line">​</span>                          Type[] types) {
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> ( entity <span xmlns="" class="perl_Keyword">instanceof</span> Auditable ) {
<span xmlns="" class="line">​</span>            creates++;
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">for</span> ( <span xmlns="" class="perl_DataType">int</span> i=<span xmlns="" class="perl_Float">0</span>; i&lt;propertyNames.<span xmlns="" class="perl_Function">length</span>; i++ ) {
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">if</span> ( <span xmlns="" class="perl_String">"createTimestamp"</span>.<span xmlns="" class="perl_Function">equals</span>( propertyNames[i] ) ) {
<span xmlns="" class="line">​</span>                    state[i] = <span xmlns="" class="perl_Keyword">new</span> Date();
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>                }
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">afterTransactionCompletion</span>(Transaction tx) {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> ( tx.<span xmlns="" class="perl_Function">wasCommitted</span>() ) {
<span xmlns="" class="line">​</span>            System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"Creations: "</span> + creates + <span xmlns="" class="perl_String">", Updates: "</span> + updates + <span xmlns="" class="perl_String">"Loads: "</span> + loads);
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        updates=<span xmlns="" class="perl_Float">0</span>;
<span xmlns="" class="line">​</span>        creates=<span xmlns="" class="perl_Float">0</span>;
<span xmlns="" class="line">​</span>        loads=<span xmlns="" class="perl_Float">0</span>;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>}</pre><div class="para">
			There are two kinds of interceptors: <code class="literal">Session</code>-scoped and <code class="literal">SessionFactory</code>-scoped.
		</div><div class="para">
			A <code class="literal">Session</code>-scoped interceptor is specified when a session is opened using one of the overloaded SessionFactory.openSession() methods accepting an <code class="literal">Interceptor</code>.
		</div><pre class="programlisting">Session session = sf.openSession( new AuditInterceptor() );</pre><div class="para">
			A <code class="literal">SessionFactory</code>-scoped interceptor is registered with the <code class="literal">Configuration</code> object prior to building the <code class="literal">SessionFactory</code>. Unless a session is opened explicitly specifying the interceptor to use, the supplied interceptor will be applied to all sessions opened from that <code class="literal">SessionFactory</code>. <code class="literal">SessionFactory</code>-scoped interceptors must be thread safe. Ensure that you do not store session-specific states, since multiple sessions will use this interceptor potentially concurrently.
		</div><pre class="programlisting">new Configuration().setInterceptor( new AuditInterceptor() );</pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="objectstate-events">
      ⁠</a>12.2. Event system</h1></div></div></div><div class="para">
			If you have to react to particular events in your persistence layer, you can also use the Hibernate3 <span class="emphasis"><em>event</em></span> architecture. The event system can be used in addition, or as a replacement, for interceptors.
		</div><div class="para">
			All the methods of the <code class="literal">Session</code> interface correlate to an event. You have a <code class="literal">LoadEvent</code>, a <code class="literal">FlushEvent</code>, etc. Consult the XML configuration-file DTD or the <code class="literal">org.hibernate.event</code> package for the full list of defined event types. When a request is made of one of these methods, the Hibernate <code class="literal">Session</code> generates an appropriate event and passes it to the configured event listeners for that type. Out-of-the-box, these listeners implement the same processing in which those methods always resulted. However, you are free to implement a customization of one of the listener interfaces (i.e., the <code class="literal">LoadEvent</code> is processed by the registered implementation of the <code class="literal">LoadEventListener</code> interface), in which case their implementation would be responsible for processing any <code class="literal">load()</code> requests made of the <code class="literal">Session</code>.
		</div><div class="para">
			The listeners should be considered singletons. This means they are shared between requests, and should not save any state as instance variables.
		</div><div class="para">
			A custom listener implements the appropriate interface for the event it wants to process and/or extend one of the convenience base classes (or even the default event listeners used by Hibernate out-of-the-box as these are declared non-final for this purpose). Custom listeners can either be registered programmatically through the <code class="literal">Configuration</code> object, or specified in the Hibernate configuration XML. Declarative configuration through the properties file is not supported. Here is an example of a custom load event listener:
		</div><pre class="programlisting Java"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> MyLoadListener <span xmlns="" class="perl_Keyword">implements</span> LoadEventListener {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">// this is the single method defined by the LoadEventListener interface</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">onLoad</span>(LoadEvent event, LoadEventListener.<span xmlns="" class="perl_Function">LoadType</span> loadType)
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throws</span> HibernateException {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> ( !MySecurity.<span xmlns="" class="perl_Function">isAuthorized</span>( event.<span xmlns="" class="perl_Function">getEntityClassName</span>(), event.<span xmlns="" class="perl_Function">getEntityId</span>() ) ) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">MySecurityException</span>(<span xmlns="" class="perl_String">"Unauthorized access"</span>);
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}</pre><div class="para">
			You also need a configuration entry telling Hibernate to use the listener in addition to the default listener:
		</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;hibernate-configuration&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;session-factory&gt;</span>
<span xmlns="" class="line">​</span>        ...
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;event</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"load"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;listener</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"com.eg.MyLoadListener"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;listener</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"org.hibernate.event.def.DefaultLoadEventListener"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/event&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/session-factory&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/hibernate-configuration&gt;</span></pre><div class="para">
			Instead, you can register it programmatically:
		</div><pre class="programlisting">Configuration cfg = new Configuration();
LoadEventListener[] stack = { new MyLoadListener(), new DefaultLoadEventListener() };
cfg.getEventListeners().setLoadEventListeners(stack);</pre><div class="para">
			Listeners registered declaratively cannot share instances. If the same class name is used in multiple <code class="literal">&lt;listener/&gt;</code> elements, each reference will result in a separate instance of that class. If you need to share listener instances between listener types you must use the programmatic registration approach.
		</div><div class="para">
			Why implement an interface and define the specific type during configuration? A listener implementation could implement multiple event listener interfaces. Having the type additionally defined during registration makes it easier to turn custom listeners on or off during configuration.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="objectstate-decl-security">
      ⁠</a>12.3. Hibernate declarative security</h1></div></div></div><div class="para">
			Usually, declarative security in Hibernate applications is managed in a session facade layer. Hibernate3 allows certain actions to be permissioned via JACC, and authorized via JAAS. This is an optional functionality that is built on top of the event architecture.
		</div><div class="para">
			First, you must configure the appropriate event listeners, to enable the use of JAAS authorization.
		</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;listener</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"pre-delete"</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"org.hibernate.secure.JACCPreDeleteEventListener"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;listener</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"pre-update"</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"org.hibernate.secure.JACCPreUpdateEventListener"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;listener</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"pre-insert"</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"org.hibernate.secure.JACCPreInsertEventListener"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;listener</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"pre-load"</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"org.hibernate.secure.JACCPreLoadEventListener"</span><span xmlns="" class="perl_Keyword">/&gt;</span></pre><div class="para">
			Note that <code class="literal">&lt;listener type="..." class="..."/&gt;</code> is shorthand for <code class="literal">&lt;event type="..."&gt;&lt;listener class="..."/&gt;&lt;/event&gt;</code> when there is exactly one listener for a particular event type.
		</div><div class="para">
			Next, while still in <code class="literal">hibernate.cfg.xml</code>, bind the permissions to roles:
		</div><pre class="programlisting">&lt;grant role="admin" entity-name="User" actions="insert,update,read"/&gt;
&lt;grant role="su" entity-name="User" actions="*"/&gt;</pre><div class="para">
			The role names are the roles understood by your JACC provider.
		</div></div></div></body></html>