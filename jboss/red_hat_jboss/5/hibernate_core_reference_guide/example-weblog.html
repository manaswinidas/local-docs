<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 22. Example: Weblog Application</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="example-weblog">
      ⁠</a>Chapter 22. Example: Weblog Application</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="example-weblog-classes">
      ⁠</a>22.1. Persistent Classes</h1></div></div></div><div class="para">
			The persistent classes here represent a weblog and an item posted in a weblog. They are to be modelled as a standard parent/child relationship, but we will use an ordered bag, instead of a set:
		</div><pre class="programlisting Java"><span xmlns="" class="line">​</span>package eg;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.util.List;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> Blog {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">Long</span> _id;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String _name;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> List _items;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">Long</span> <span xmlns="" class="perl_Function">getId</span>() {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> _id;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> List <span xmlns="" class="perl_Function">getItems</span>() {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> _items;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">getName</span>() {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> _name;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setId</span>(<span xmlns="" class="perl_DataType">Long</span> long1) {
<span xmlns="" class="line">​</span>        _id = long1;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setItems</span>(List list) {
<span xmlns="" class="line">​</span>        _items = list;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setName</span>(String string) {
<span xmlns="" class="line">​</span>        _name = string;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}</pre><pre class="programlisting Java"><span xmlns="" class="line">​</span>package eg;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.text.DateFormat;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.util.Calendar;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> BlogItem {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">Long</span> _id;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> Calendar _datetime;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String _text;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String _title;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> Blog _blog;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Blog <span xmlns="" class="perl_Function">getBlog</span>() {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> _blog;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Calendar <span xmlns="" class="perl_Function">getDatetime</span>() {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> _datetime;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">Long</span> <span xmlns="" class="perl_Function">getId</span>() {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> _id;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">getText</span>() {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> _text;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">getTitle</span>() {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> _title;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setBlog</span>(Blog blog) {
<span xmlns="" class="line">​</span>        _blog = blog;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setDatetime</span>(Calendar calendar) {
<span xmlns="" class="line">​</span>        _datetime = calendar;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setId</span>(<span xmlns="" class="perl_DataType">Long</span> long1) {
<span xmlns="" class="line">​</span>        _id = long1;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setText</span>(String string) {
<span xmlns="" class="line">​</span>        _text = string;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setTitle</span>(String string) {
<span xmlns="" class="line">​</span>        _title = string;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}</pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="example-weblog-mappings">
      ⁠</a>22.2. Hibernate Mappings</h1></div></div></div><div class="para">
			The XML mappings are now straightforward. For example:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_DataType">&lt;!DOCTYPE </span>hibernate-mapping PUBLIC
<span xmlns="" class="line">​</span>    "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
<span xmlns="" class="line">​</span>    "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd"<span xmlns="" class="perl_DataType">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;hibernate-mapping</span><span xmlns="" class="perl_Others"> package=</span><span xmlns="" class="perl_String">"eg"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;class</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">        name=</span><span xmlns="" class="perl_String">"Blog"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">        table=</span><span xmlns="" class="perl_String">"BLOGS"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;id</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            name=</span><span xmlns="" class="perl_String">"id"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            column=</span><span xmlns="" class="perl_String">"BLOG_ID"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;generator</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"native"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/id&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;property</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            name=</span><span xmlns="" class="perl_String">"name"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            column=</span><span xmlns="" class="perl_String">"NAME"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            not-null=</span><span xmlns="" class="perl_String">"true"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            unique=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;bag</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            name=</span><span xmlns="" class="perl_String">"items"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            inverse=</span><span xmlns="" class="perl_String">"true"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            order-by=</span><span xmlns="" class="perl_String">"DATE_TIME"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            cascade=</span><span xmlns="" class="perl_String">"all"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;key</span><span xmlns="" class="perl_Others"> column=</span><span xmlns="" class="perl_String">"BLOG_ID"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;one-to-many</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"BlogItem"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/bag&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/class&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/hibernate-mapping&gt;</span></pre><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_DataType">&lt;!DOCTYPE </span>hibernate-mapping PUBLIC
<span xmlns="" class="line">​</span>    "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
<span xmlns="" class="line">​</span>    "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd"<span xmlns="" class="perl_DataType">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;hibernate-mapping</span><span xmlns="" class="perl_Others"> package=</span><span xmlns="" class="perl_String">"eg"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;class</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">        name=</span><span xmlns="" class="perl_String">"BlogItem"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">        table=</span><span xmlns="" class="perl_String">"BLOG_ITEMS"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">        dynamic-update=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;id</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            name=</span><span xmlns="" class="perl_String">"id"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            column=</span><span xmlns="" class="perl_String">"BLOG_ITEM_ID"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;generator</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"native"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/id&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;property</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            name=</span><span xmlns="" class="perl_String">"title"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            column=</span><span xmlns="" class="perl_String">"TITLE"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            not-null=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;property</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            name=</span><span xmlns="" class="perl_String">"text"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            column=</span><span xmlns="" class="perl_String">"TEXT"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            not-null=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;property</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            name=</span><span xmlns="" class="perl_String">"datetime"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            column=</span><span xmlns="" class="perl_String">"DATE_TIME"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            not-null=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;many-to-one</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            name=</span><span xmlns="" class="perl_String">"blog"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            column=</span><span xmlns="" class="perl_String">"BLOG_ID"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">            not-null=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/class&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/hibernate-mapping&gt;</span></pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="example-weblog-code">
      ⁠</a>22.3. Hibernate Code</h1></div></div></div><div class="para">
			The following class demonstrates some of the kinds of things we can do with these classes using Hibernate:
		</div><pre class="programlisting Java"><span xmlns="" class="line">​</span>package eg;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.util.ArrayList;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.util.Calendar;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.util.Iterator;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.util.List;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.hibernate.HibernateException;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.hibernate.Query;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.hibernate.Session;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.hibernate.SessionFactory;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.hibernate.Transaction;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.hibernate.cfg.Configuration;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.hibernate.tool.hbm2ddl.SchemaExport;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> BlogMain {
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> SessionFactory _sessions;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">configure</span>() <span xmlns="" class="perl_Keyword">throws</span> HibernateException {
<span xmlns="" class="line">​</span>        _sessions = <span xmlns="" class="perl_Keyword">new</span> Configuration()
<span xmlns="" class="line">​</span>            .<span xmlns="" class="perl_Function">addClass</span>(Blog.<span xmlns="" class="perl_Function">class</span>)
<span xmlns="" class="line">​</span>            .<span xmlns="" class="perl_Function">addClass</span>(BlogItem.<span xmlns="" class="perl_Function">class</span>)
<span xmlns="" class="line">​</span>            .<span xmlns="" class="perl_Function">buildSessionFactory</span>();
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">exportTables</span>() <span xmlns="" class="perl_Keyword">throws</span> HibernateException {
<span xmlns="" class="line">​</span>        Configuration cfg = <span xmlns="" class="perl_Keyword">new</span> Configuration()
<span xmlns="" class="line">​</span>            .<span xmlns="" class="perl_Function">addClass</span>(Blog.<span xmlns="" class="perl_Function">class</span>)
<span xmlns="" class="line">​</span>            .<span xmlns="" class="perl_Function">addClass</span>(BlogItem.<span xmlns="" class="perl_Function">class</span>);
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">SchemaExport</span>(cfg).<span xmlns="" class="perl_Function">create</span>(<span xmlns="" class="perl_Keyword">true</span>, <span xmlns="" class="perl_Keyword">true</span>);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Blog <span xmlns="" class="perl_Function">createBlog</span>(String name) <span xmlns="" class="perl_Keyword">throws</span> HibernateException {
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>        Blog blog = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">Blog</span>();
<span xmlns="" class="line">​</span>        blog.<span xmlns="" class="perl_Function">setName</span>(name);
<span xmlns="" class="line">​</span>        blog.<span xmlns="" class="perl_Function">setItems</span>( <span xmlns="" class="perl_Keyword">new</span> ArrayList() );
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>        Session session = _sessions.<span xmlns="" class="perl_Function">openSession</span>();
<span xmlns="" class="line">​</span>        Transaction tx = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>            tx = session.<span xmlns="" class="perl_Function">beginTransaction</span>();
<span xmlns="" class="line">​</span>            session.<span xmlns="" class="perl_Function">persist</span>(blog);
<span xmlns="" class="line">​</span>            tx.<span xmlns="" class="perl_Function">commit</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (HibernateException he) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (tx!=<span xmlns="" class="perl_Keyword">null</span>) tx.<span xmlns="" class="perl_Function">rollback</span>();
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> he;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">finally</span> {
<span xmlns="" class="line">​</span>            session.<span xmlns="" class="perl_Function">close</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> blog;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> BlogItem <span xmlns="" class="perl_Function">createBlogItem</span>(Blog blog, String title, String text)
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">throws</span> HibernateException {
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>        BlogItem item = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">BlogItem</span>();
<span xmlns="" class="line">​</span>        item.<span xmlns="" class="perl_Function">setTitle</span>(title);
<span xmlns="" class="line">​</span>        item.<span xmlns="" class="perl_Function">setText</span>(text);
<span xmlns="" class="line">​</span>        item.<span xmlns="" class="perl_Function">setBlog</span>(blog);
<span xmlns="" class="line">​</span>        item.<span xmlns="" class="perl_Function">setDatetime</span>( Calendar.<span xmlns="" class="perl_Function">getInstance</span>() );
<span xmlns="" class="line">​</span>        blog.<span xmlns="" class="perl_Function">getItems</span>().<span xmlns="" class="perl_Function">add</span>(item);
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>        Session session = _sessions.<span xmlns="" class="perl_Function">openSession</span>();
<span xmlns="" class="line">​</span>        Transaction tx = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>            tx = session.<span xmlns="" class="perl_Function">beginTransaction</span>();
<span xmlns="" class="line">​</span>            session.<span xmlns="" class="perl_Function">update</span>(blog);
<span xmlns="" class="line">​</span>            tx.<span xmlns="" class="perl_Function">commit</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (HibernateException he) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (tx!=<span xmlns="" class="perl_Keyword">null</span>) tx.<span xmlns="" class="perl_Function">rollback</span>();
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> he;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">finally</span> {
<span xmlns="" class="line">​</span>            session.<span xmlns="" class="perl_Function">close</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> item;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> BlogItem <span xmlns="" class="perl_Function">createBlogItem</span>(<span xmlns="" class="perl_DataType">Long</span> blogid, String title, String text)
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">throws</span> HibernateException {
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>        BlogItem item = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">BlogItem</span>();
<span xmlns="" class="line">​</span>        item.<span xmlns="" class="perl_Function">setTitle</span>(title);
<span xmlns="" class="line">​</span>        item.<span xmlns="" class="perl_Function">setText</span>(text);
<span xmlns="" class="line">​</span>        item.<span xmlns="" class="perl_Function">setDatetime</span>( Calendar.<span xmlns="" class="perl_Function">getInstance</span>() );
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>        Session session = _sessions.<span xmlns="" class="perl_Function">openSession</span>();
<span xmlns="" class="line">​</span>        Transaction tx = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>            tx = session.<span xmlns="" class="perl_Function">beginTransaction</span>();
<span xmlns="" class="line">​</span>            Blog blog = (Blog) session.<span xmlns="" class="perl_Function">load</span>(Blog.<span xmlns="" class="perl_Function">class</span>, blogid);
<span xmlns="" class="line">​</span>            item.<span xmlns="" class="perl_Function">setBlog</span>(blog);
<span xmlns="" class="line">​</span>            blog.<span xmlns="" class="perl_Function">getItems</span>().<span xmlns="" class="perl_Function">add</span>(item);
<span xmlns="" class="line">​</span>            tx.<span xmlns="" class="perl_Function">commit</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (HibernateException he) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (tx!=<span xmlns="" class="perl_Keyword">null</span>) tx.<span xmlns="" class="perl_Function">rollback</span>();
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> he;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">finally</span> {
<span xmlns="" class="line">​</span>            session.<span xmlns="" class="perl_Function">close</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> item;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">updateBlogItem</span>(BlogItem item, String text)
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">throws</span> HibernateException {
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>        item.<span xmlns="" class="perl_Function">setText</span>(text);
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>        Session session = _sessions.<span xmlns="" class="perl_Function">openSession</span>();
<span xmlns="" class="line">​</span>        Transaction tx = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>            tx = session.<span xmlns="" class="perl_Function">beginTransaction</span>();
<span xmlns="" class="line">​</span>            session.<span xmlns="" class="perl_Function">update</span>(item);
<span xmlns="" class="line">​</span>            tx.<span xmlns="" class="perl_Function">commit</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (HibernateException he) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (tx!=<span xmlns="" class="perl_Keyword">null</span>) tx.<span xmlns="" class="perl_Function">rollback</span>();
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> he;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">finally</span> {
<span xmlns="" class="line">​</span>            session.<span xmlns="" class="perl_Function">close</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">updateBlogItem</span>(<span xmlns="" class="perl_DataType">Long</span> itemid, String text)
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">throws</span> HibernateException {
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>        Session session = _sessions.<span xmlns="" class="perl_Function">openSession</span>();
<span xmlns="" class="line">​</span>        Transaction tx = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>            tx = session.<span xmlns="" class="perl_Function">beginTransaction</span>();
<span xmlns="" class="line">​</span>            BlogItem item = (BlogItem) session.<span xmlns="" class="perl_Function">load</span>(BlogItem.<span xmlns="" class="perl_Function">class</span>, itemid);
<span xmlns="" class="line">​</span>            item.<span xmlns="" class="perl_Function">setText</span>(text);
<span xmlns="" class="line">​</span>            tx.<span xmlns="" class="perl_Function">commit</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (HibernateException he) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (tx!=<span xmlns="" class="perl_Keyword">null</span>) tx.<span xmlns="" class="perl_Function">rollback</span>();
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> he;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">finally</span> {
<span xmlns="" class="line">​</span>            session.<span xmlns="" class="perl_Function">close</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> List <span xmlns="" class="perl_Function">listAllBlogNamesAndItemCounts</span>(<span xmlns="" class="perl_DataType">int</span> max)
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">throws</span> HibernateException {
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>        Session session = _sessions.<span xmlns="" class="perl_Function">openSession</span>();
<span xmlns="" class="line">​</span>        Transaction tx = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        List result = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>            tx = session.<span xmlns="" class="perl_Function">beginTransaction</span>();
<span xmlns="" class="line">​</span>            Query q = session.<span xmlns="" class="perl_Function">createQuery</span>(
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_String">"select blog.id, blog.name, count(blogItem) "</span> +
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_String">"from Blog as blog "</span> +
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_String">"left outer join blog.items as blogItem "</span> +
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_String">"group by blog.name, blog.id "</span> +
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_String">"order by max(blogItem.datetime)"</span>
<span xmlns="" class="line">​</span>            );
<span xmlns="" class="line">​</span>            q.<span xmlns="" class="perl_Function">setMaxResults</span>(max);
<span xmlns="" class="line">​</span>            result = q.<span xmlns="" class="perl_Function">list</span>();
<span xmlns="" class="line">​</span>            tx.<span xmlns="" class="perl_Function">commit</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (HibernateException he) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (tx!=<span xmlns="" class="perl_Keyword">null</span>) tx.<span xmlns="" class="perl_Function">rollback</span>();
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> he;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">finally</span> {
<span xmlns="" class="line">​</span>            session.<span xmlns="" class="perl_Function">close</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> result;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Blog <span xmlns="" class="perl_Function">getBlogAndAllItems</span>(<span xmlns="" class="perl_DataType">Long</span> blogid)
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">throws</span> HibernateException {
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>        Session session = _sessions.<span xmlns="" class="perl_Function">openSession</span>();
<span xmlns="" class="line">​</span>        Transaction tx = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        Blog blog = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>            tx = session.<span xmlns="" class="perl_Function">beginTransaction</span>();
<span xmlns="" class="line">​</span>            Query q = session.<span xmlns="" class="perl_Function">createQuery</span>(
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_String">"from Blog as blog "</span> +
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_String">"left outer join fetch blog.items "</span> +
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_String">"where blog.id = :blogid"</span>
<span xmlns="" class="line">​</span>            );
<span xmlns="" class="line">​</span>            q.<span xmlns="" class="perl_Function">setParameter</span>(<span xmlns="" class="perl_String">"blogid"</span>, blogid);
<span xmlns="" class="line">​</span>            blog  = (Blog) q.<span xmlns="" class="perl_Function">uniqueResult</span>();
<span xmlns="" class="line">​</span>            tx.<span xmlns="" class="perl_Function">commit</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (HibernateException he) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (tx!=<span xmlns="" class="perl_Keyword">null</span>) tx.<span xmlns="" class="perl_Function">rollback</span>();
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> he;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">finally</span> {
<span xmlns="" class="line">​</span>            session.<span xmlns="" class="perl_Function">close</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> blog;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> List <span xmlns="" class="perl_Function">listBlogsAndRecentItems</span>() <span xmlns="" class="perl_Keyword">throws</span> HibernateException {
<span xmlns="" class="line">​</span>        
<span xmlns="" class="line">​</span>        Session session = _sessions.<span xmlns="" class="perl_Function">openSession</span>();
<span xmlns="" class="line">​</span>        Transaction tx = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        List result = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>            tx = session.<span xmlns="" class="perl_Function">beginTransaction</span>();
<span xmlns="" class="line">​</span>            Query q = session.<span xmlns="" class="perl_Function">createQuery</span>(
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_String">"from Blog as blog "</span> +
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_String">"inner join blog.items as blogItem "</span> +
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_String">"where blogItem.datetime &gt; :minDate"</span>
<span xmlns="" class="line">​</span>            );
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            Calendar cal = Calendar.<span xmlns="" class="perl_Function">getInstance</span>();
<span xmlns="" class="line">​</span>            cal.<span xmlns="" class="perl_Function">roll</span>(Calendar.<span xmlns="" class="perl_Function">MONTH</span>, <span xmlns="" class="perl_Keyword">false</span>);
<span xmlns="" class="line">​</span>            q.<span xmlns="" class="perl_Function">setCalendar</span>(<span xmlns="" class="perl_String">"minDate"</span>, cal);
<span xmlns="" class="line">​</span>            
<span xmlns="" class="line">​</span>            result = q.<span xmlns="" class="perl_Function">list</span>();
<span xmlns="" class="line">​</span>            tx.<span xmlns="" class="perl_Function">commit</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (HibernateException he) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (tx!=<span xmlns="" class="perl_Keyword">null</span>) tx.<span xmlns="" class="perl_Function">rollback</span>();
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> he;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">finally</span> {
<span xmlns="" class="line">​</span>            session.<span xmlns="" class="perl_Function">close</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> result;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}</pre></div></div></body></html>