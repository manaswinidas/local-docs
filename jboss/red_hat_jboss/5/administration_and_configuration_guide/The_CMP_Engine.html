<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 31. The CMP Engine</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine">
      ⁠</a>Chapter 31. The CMP Engine</h1></div></div></div><div class="para">
		This chapter will explore the use of container managed persistence (CMP) in JBoss. We will assume a basic familiarity the EJB CMP model and focus on the operation of the JBoss CMP engine. Specifically, we will look at how to configure and optimize CMP applications on JBoss. For more introductory coverage of basic CMP concepts, we recommend <span class="emphasis"><em>Enterprise Java Beans, Fourth Edition</em></span> (O'Reilly 2004).
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-Example_Code">
      ⁠</a>31.1. Example Code</h1></div></div></div><div class="para">
			This chapter is example-driven. We will work with the crime portal application which stores information about imaginary criminal organizations. The data model we will be working with is shown in <a class="xref" href="The_CMP_Engine.html#Example_Code-The_crime_portal_example_classes">Figure 31.1, “The crime portal example classes”</a>.
		</div><div class="figure"><a id="Example_Code-The_crime_portal_example_classes">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/Chap11-4.png" align="middle" alt="The crime portal example classes" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.1. The crime portal example classes</strong></p></div><div class="para">
			The source code for the crime portal is available in the <code class="literal">src/main/org/jboss/cmp2</code> directory of the example code. To build the example code, run Ant as shown below
		</div><pre class="programlisting">[examples]$ ant -Dchap=cmp2 config</pre><div class="para">
			This command builds and deploys the application to the server. When you start your server, or if it is already running, you should see the following deployment messages:
		</div><pre class="screen">15:46:36,704 INFO  [OrganizationBean$Proxy] Creating organization Yakuza, Japanese Gangsters
15:46:36,790 INFO  [OrganizationBean$Proxy] Creating organization Mafia, Italian Bad Guys
15:46:36,797 INFO  [OrganizationBean$Proxy] Creating organization Triads, Kung Fu Movie Extras
15:46:36,877 INFO  [GangsterBean$Proxy] Creating Gangster 0 'Bodyguard' Yojimbo
15:46:37,003 INFO  [GangsterBean$Proxy] Creating Gangster 1 'Master' Takeshi
15:46:37,021 INFO  [GangsterBean$Proxy] Creating Gangster 2 'Four finger' Yuriko
15:46:37,040 INFO  [GangsterBean$Proxy] Creating Gangster 3 'Killer' Chow
15:46:37,106 INFO  [GangsterBean$Proxy] Creating Gangster 4 'Lightning' Shogi
15:46:37,118 INFO  [GangsterBean$Proxy] Creating Gangster 5 'Pizza-Face' Valentino
15:46:37,133 INFO  [GangsterBean$Proxy] Creating Gangster 6 'Toohless' Toni
15:46:37,208 INFO  [GangsterBean$Proxy] Creating Gangster 7 'Godfather' Corleone
15:46:37,238 INFO  [JobBean$Proxy] Creating Job 10th Street Jeweler Heist
15:46:37,247 INFO  [JobBean$Proxy] Creating Job The Greate Train Robbery
15:46:37,257 INFO  [JobBean$Proxy] Creating Job Cheap Liquor Snatch and Grab
</pre><div class="para">
			Since the beans in the examples are configured to have their tables removed on undeployment, anytime you restart the server you need to rerun the config target to reload the example data and re-deploy the application.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Example_Code-Enabling_CMP_Debug_Logging">
      ⁠</a>31.1.1. Enabling CMP Debug Logging</h2></div></div></div><div class="para">
				In order to get meaningful feedback from the chapter tests, increase the log level of the CMP subsystem before running the test. To enable debug logging add the following category to your <code class="literal">log4j.xml</code> file:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;category</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"org.jboss.ejb.plugins.cmp"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;priority</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"DEBUG"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/category&gt;</span>
</pre><div class="para">
				In addition to this, it is necessary to decrease the threshold on the <code class="literal">CONSOLE</code> appender to allow debug level messages to be logged to the console. The following changes also need to be applied to the <code class="literal">log4j.xml</code> file.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;appender</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"CONSOLE"</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"org.apache.log4j.ConsoleAppender"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;errorHandler</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"org.jboss.logging.util.OnlyOnceErrorHandler"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;param</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"Target"</span><span xmlns="" class="perl_Others">    value=</span><span xmlns="" class="perl_String">"System.out"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;param</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"Threshold"</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"DEBUG"</span> <span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;layout</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"org.apache.log4j.PatternLayout"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">&lt;!-- The default pattern: Date Priority [Category] Message\n --&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;param</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"ConversionPattern"</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"%d{ABSOLUTE} %-5p [%c{1}] %m%n"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/layout&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/appender&gt;</span>
</pre><div class="para">
				To see the full workings of the CMP engine you would need to enable the custom <code class="literal">TRACE</code> level priority on the <code class="literal">org.jboss.ejb.plugins.cmp</code> category as shown here:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;category</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"org.jboss.ejb.plugins.cmp"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;priority</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"TRACE"</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"org.jboss.logging.XLevel"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/category&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Example_Code-Running_the_examples">
      ⁠</a>31.1.2. Running the examples</h2></div></div></div><div class="para">
				The first test target illustrates a number of the customization features that will be discussed throughout this chapter. To run these tests execute the following ant target:
			</div><pre class="programlisting">[examples]$ ant -Dchap=cmp2 -Dex=test run-example</pre><pre class="screen">22:30:09,862 DEBUG [OrganizationEJB#findByPrimaryKey] Executing SQL: SELECT t0_OrganizationEJ
B.name FROM ORGANIZATION t0_OrganizationEJB WHERE t0_OrganizationEJB.name=?
22:30:09,927 DEBUG [OrganizationEJB] Executing SQL: SELECT desc, the_boss FROM ORGANIZATION W
HERE (name=?)
22:30:09,931 DEBUG [OrganizationEJB] load relation SQL: SELECT id FROM GANGSTER WHERE (organi
zation=?)
22:30:09,947 DEBUG [StatelessSessionContainer] Useless invocation of remove() for stateless s
ession bean
22:30:10,086 DEBUG [GangsterEJB#findBadDudes_ejbql] Executing SQL: SELECT t0_g.id FROM GANGST
ER t0_g WHERE (t0_g.badness &gt; ?)
22:30:10,097 DEBUG [GangsterEJB#findByPrimaryKey] Executing SQL: SELECT t0_GangsterEJB.id FRO
M GANGSTER t0_GangsterEJB WHERE t0_GangsterEJB.id=?
22:30:10,102 DEBUG [GangsterEJB#findByPrimaryKey] Executing SQL: SELECT t0_GangsterEJB.id FRO
M GANGSTER t0_GangsterEJB WHERE t0_GangsterEJB.id=?
</pre><div class="para">
				These tests exercise various finders, selectors and object to table mapping issues. We will refer to the tests throughout the chapter.
			</div><div class="para">
				The other main target runs a set of tests to demonstrate the optimized loading configurations presented in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Optimized_Loading">Section 31.7, “Optimized Loading”</a>. Now that the logging is setup correctly, the read-ahead tests will display useful information about the queries performed. Note that you do not have to restart the server for it to recognize the changes to the log4j.xml file, but it may take a minute or so. The following shows the actual execution of the readahead client:
			</div><pre class="programlisting">[examples]$ ant -Dchap=cmp2 -Dex=readahead run-example</pre><div class="para">
				When the readahead client is executed, all of the SQL queries executed during the test are displayed in the server console. The important items of note when analyzing the output are the number of queries executed, the columns selected, and the number of rows loaded. The following shows the read-ahead none portion of the server console output from readahead:
			</div><pre class="screen">22:44:31,570 INFO  [ReadAheadTest] 
########################################################
### read-ahead none
###
22:44:31,582 DEBUG [GangsterEJB#findAll_none] Executing SQL: SELECT t0_g.id FROM GANGSTER t0_
g ORDER BY t0_g.id ASC
22:44:31,604 DEBUG [GangsterEJB] Executing SQL: SELECT name, nick_name, badness, organization
, hangout FROM GANGSTER WHERE (id=?)
22:44:31,615 DEBUG [GangsterEJB] Executing SQL: SELECT name, nick_name, badness, organization
, hangout FROM GANGSTER WHERE (id=?)
22:44:31,622 DEBUG [GangsterEJB] Executing SQL: SELECT name, nick_name, badness, organization
, hangout FROM GANGSTER WHERE (id=?)
22:44:31,628 DEBUG [GangsterEJB] Executing SQL: SELECT name, nick_name, badness, organization
, hangout FROM GANGSTER WHERE (id=?)
22:44:31,635 DEBUG [GangsterEJB] Executing SQL: SELECT name, nick_name, badness, organization
, hangout FROM GANGSTER WHERE (id=?)
22:44:31,644 DEBUG [GangsterEJB] Executing SQL: SELECT name, nick_name, badness, organization
, hangout FROM GANGSTER WHERE (id=?)
22:44:31,649 DEBUG [GangsterEJB] Executing SQL: SELECT name, nick_name, badness, organization
, hangout FROM GANGSTER WHERE (id=?)
22:44:31,658 DEBUG [GangsterEJB] Executing SQL: SELECT name, nick_name, badness, organization
, hangout FROM GANGSTER WHERE (id=?)
22:44:31,670 INFO  [ReadAheadTest] 
###
########################################################
...
</pre><div class="para">
				We will revisit this example and explore the output when we discuss the settings for optimized loading.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-The_jbosscmp_jdbc_Structure">
      ⁠</a>31.2. The jbosscmp-jdbc Structure</h1></div></div></div><div class="para">
			The <code class="literal">jbosscmp-jdbc.xml</code> descriptor is used to control the behavior of the JBoss engine. This can be done globally through the <code class="literal">conf/standardjbosscmp-jdbc.xml</code> descriptor found in the server configuration file set, or per EJB JAR deployment via a <code class="literal">META-INF/jbosscmp-jdbc.xml</code> descriptor.
		</div><div class="para">
			The DTD for the <code class="filename">jbosscmp-jdbc.xml</code> descriptor can be found in <code class="filename"><em class="replaceable">&lt;JBOSS_HOME&gt;</em>/docs/dtd/jbosscmp-jdbc_4_0.dtd</code>. The public doctype for this DTD is:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span> <span xmlns="" class="perl_DataType">&lt;!DOCTYPE </span>jbosscmp-jdbc PUBLIC
<span xmlns="" class="line">​</span>      "-//JBoss//DTD JBOSSCMP-JDBC 4.0//EN"
<span xmlns="" class="line">​</span>      "http://www.jboss.org/j2ee/dtd/jbosscmp-jdbc_4_0.dtd"<span xmlns="" class="perl_DataType">&gt;</span>
</pre><div class="para">
			The top level elements are shown in <a class="xref" href="The_CMP_Engine.html#The_jbosscmp_jdbc_Structure-The_jbosscmp_jdbc_content_model.">Figure 31.2, “The jbosscmp-jdbc content model.”</a>.
		</div><div class="figure"><a id="The_jbosscmp_jdbc_Structure-The_jbosscmp_jdbc_content_model.">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc.png" align="middle" alt="The jbosscmp-jdbc content model." style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.2. The jbosscmp-jdbc content model.</strong></p></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					<span class="bold bold"><strong>defaults</strong></span>: The defaults section allows for the specification of default behavior/settings for behavior that controls entity beans. Use of this section simplifies the amount of information needed for the common behaviors found in the entity beans section. See <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Defaults">Section 31.12, “Defaults”</a> for the details of the defaults content.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>enterprise-beans</strong></span>: The <code class="literal">enterprise-beans</code> element allows for customization of entity beans defined in the <code class="literal">ejb-jar.xml</code><code class="literal">enterprise-beans</code> descriptor. This is described in detail in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Entity_Beans">Section 31.3, “Entity Beans”</a>.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>relationships</strong></span>: The <code class="literal">relationships</code> element allows for the customization of tables and the loading behavior of entity relationships. This is described in detail in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Container_Managed_Relationships">Section 31.5, “Container Managed Relationships”</a>.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>dependent-value-classes</strong></span>: The <code class="literal">dependent-value-classes</code> element allows for the customization of the mapping of dependent value classes to tables. Dependent value classes are described in detail in <a class="xref" href="The_CMP_Engine.html#CMP_Fields-Dependent_Value_Classes_DVCs">Section 31.4.5, “Dependent Value Classes (DVCs)”</a> (DVCs).
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>type-mappings</strong></span>: The <code class="literal">type-mappings</code> element defines the Java to SQL type mappings for a database, along with SQL templates, and function mappings. This is described in detail in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Datasource_Customization">Section 31.13, “Datasource Customization”</a>.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>entity-commands</strong></span>: The <code class="literal">entity-commands</code> element allows for the definition of the entity creation command instances that know how to create an entity instance in a persistent store. This is described in detail in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Entity_Commands_and_Primary_Key_Generation">Section 31.11, “Entity Commands and Primary Key Generation”</a>.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>user-type-mappings</strong></span>: The <code class="literal">user-type-mappings</code> elements defines a mapping of a user types to a column using a mapper class. A mapper is like a mediator. When storing, it takes an instance of the user type and translates it to a column value. When loading, it takes a column value and translates it to an instance of the user type. Details of the user type mappings are described in <a class="xref" href="The_CMP_Engine.html#Datasource_Customization-User_Type_Mappings">Section 31.13.4, “User Type Mappings”</a>.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>reserved-words</strong></span>: The <code class="literal">reserved-words</code> element defines one or more reserved words that should be escaped when generating tables. Each reserved word is specified as the content of a <code class="literal">word</code> element.
				</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-Entity_Beans">
      ⁠</a>31.3. Entity Beans</h1></div></div></div><div class="para">
			We will start our look at entity beans in JBoss by examining one of the CMP entity beans in the crime portal. We will look at the gangster bean, which is implemented as local CMP entity bean. Although JBoss can provide remote entity beans with pass-by-reference semantics for calls in the same VM to get the performance benefit as from local entity beans, the use of local entity beans is strongly encouraged.
		</div><div class="para">
			We will start with the required home interface. Since we are only concerned with the CMP fields at this point, we will show only the methods dealing with the CMP fields.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// Gangster Local Home Interface</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> GangsterHome 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> EJBLocalHome 
<span xmlns="" class="line">​</span>{   
<span xmlns="" class="line">​</span>    Gangster <span xmlns="" class="perl_Function">create</span>(Integer id, String name, String nickName)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> CreateException;
<span xmlns="" class="line">​</span>    Gangster <span xmlns="" class="perl_Function">findByPrimaryKey</span>(Integer id) 
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> FinderException; 
<span xmlns="" class="line">​</span>}
</pre><div class="para">
			The local interface is what clients will use to talk. Again, it contains only the CMP field accessors.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// Gangster Local Interface </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> Gangster
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> EJBLocalObject
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    Integer <span xmlns="" class="perl_Function">getGangsterId</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    String <span xmlns="" class="perl_Function">getName</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    String <span xmlns="" class="perl_Function">getNickName</span>();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setNickName</span>(String nickName);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">getBadness</span>();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setBadness</span>(<span xmlns="" class="perl_DataType">int</span> badness);
<span xmlns="" class="line">​</span>}
</pre><div class="para">
			Finally, we have the actual gangster bean. Despite it's size, very little code is actually required. The bulk of the class is the create method.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">// Gangster Implementation Class</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> GangsterBean 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">implements</span> EntityBean 
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">private</span> EntityContext ctx; 
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">private</span> Category log = Category.<span xmlns="" class="perl_Function">getInstance</span>(<span xmlns="" class="perl_Function">getClass</span>());
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> Integer <span xmlns="" class="perl_Function">ejbCreate</span>(Integer id, String name, String nickName)
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">throws</span> CreateException 
<span xmlns="" class="line">​</span>     {
<span xmlns="" class="line">​</span>         log.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Creating Gangster "</span> + id + <span xmlns="" class="perl_String">" '"</span> + nickName + <span xmlns="" class="perl_String">"' "</span>+ name);
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Function">setGangsterId</span>(id);
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Function">setName</span>(name);
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Function">setNickName</span>(nickName);
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>     }
<span xmlns="" class="line">​</span>     
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">ejbPostCreate</span>(Integer id, String name, String nickName) {
<span xmlns="" class="line">​</span>     }
<span xmlns="" class="line">​</span>     
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Comment">// CMP field accessors ---------------------------------------------</span>
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> Integer <span xmlns="" class="perl_Function">getGangsterId</span>();
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setGangsterId</span>(Integer gangsterId); 
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> String <span xmlns="" class="perl_Function">getName</span>();
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setName</span>(String name);
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> String <span xmlns="" class="perl_Function">getNickName</span>();
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setNickName</span>(String nickName);
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">getBadness</span>();
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setBadness</span>(<span xmlns="" class="perl_DataType">int</span> badness);
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> ContactInfo <span xmlns="" class="perl_Function">getContactInfo</span>();
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setContactInfo</span>(ContactInfo contactInfo);  
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Comment">//... </span>
<span xmlns="" class="line">​</span>     
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Comment">// EJB callbacks ---------------------------------------------------</span>
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setEntityContext</span>(EntityContext context) { ctx = context; }
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">unsetEntityContext</span>() { ctx = <span xmlns="" class="perl_Keyword">null</span>; }
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">ejbActivate</span>() { }    
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">ejbPassivate</span>() { }   
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">ejbRemove</span>() { log.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Removing "</span> + <span xmlns="" class="perl_Function">getName</span>()); }
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">ejbStore</span>() { }
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">ejbLoad</span>() { }
<span xmlns="" class="line">​</span>}
</pre><div class="para">
			The only thing missing now is the <code class="literal">ejb-jar.xml</code> deployment descriptor. Although the actual bean class is named <code class="literal">GangsterBean</code>, we've called the entity <code class="literal">GangsterEJB</code>.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0" encoding="UTF-8"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;ejb-jar</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"http://java.sun.com/xml/ns/"</span><span xmlns="" class="perl_Error">Whats_new_in_JBoss_4-J2EE_Certification_and_Standards_Compliance"</span><span xmlns="" class="perl_Others"> version=</span><span xmlns="" class="perl_String">"2.1"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">    xmlns:xsi=</span><span xmlns="" class="perl_String">"http://www.w3.org/2001/XMLSchema-instance"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">    xsi:schemaLocation=</span><span xmlns="" class="perl_String">"http://java.sun.com/xml/ns/j2ee </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_String">                        http://java.sun.com/xml/ns/j2ee/ejb-jar_\2_1.xsd"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;display-name&gt;</span>Crime Portal<span xmlns="" class="perl_Keyword">&lt;/display-name&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;display-name&gt;</span>Gangster Entity Bean<span xmlns="" class="perl_Keyword">&lt;/display-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;local-home&gt;</span>org.jboss.cmp2.crimeportal.GangsterHome<span xmlns="" class="perl_Keyword">&lt;/local-home&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;local&gt;</span>org.jboss.cmp2.crimeportal.Gangster<span xmlns="" class="perl_Keyword">&lt;/local&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-class&gt;</span>org.jboss.cmp2.crimeportal.GangsterBean<span xmlns="" class="perl_Keyword">&lt;/ejb-class&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;persistence-type&gt;</span>Container<span xmlns="" class="perl_Keyword">&lt;/persistence-type&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;prim-key-class&gt;</span>java.lang.Integer<span xmlns="" class="perl_Keyword">&lt;/prim-key-class&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;reentrant&gt;</span>False<span xmlns="" class="perl_Keyword">&lt;/reentrant&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-version&gt;</span>2.x<span xmlns="" class="perl_Keyword">&lt;/cmp-version&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;abstract-schema-name&gt;</span>gangster<span xmlns="" class="perl_Keyword">&lt;/abstract-schema-name&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>gangsterId<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>name<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>nickName<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>badness<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>contactInfo<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;primkey-field&gt;</span>gangsterId<span xmlns="" class="perl_Keyword">&lt;/primkey-field&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- ... --&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/ejb-jar&gt;</span>
</pre><div class="para">
			Note that we've specified a CMP version of <code class="literal">2.x</code> to indicate that this is EJB 2.x CMP entity bean. The abstract schema name was set to <code class="literal">gangster</code>. That will be important when we look at EJB-QL queries in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Queries">Section 31.6, “Queries”</a>.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Entity_Beans-Entity_Mapping">
      ⁠</a>31.3.1. Entity Mapping</h2></div></div></div><div class="para">
				The JBoss configuration for the entity is declared with an <code class="literal">entity</code> element in the <code class="literal">jbosscmp-jdbc.xml</code> file. This file is located in the <code class="literal">META-INF</code> directory of the EJB JAR and contains all of the optional configuration information for configuring the CMP mapping. The <code class="literal">entity</code> elements for each entity bean are grouped together in the <code class="literal">enterprise-beans</code> element under the top level <code class="literal">jbosscmp-jdbc</code> element. A stubbed out entity configuration is shown below.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0" encoding="UTF-8"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_DataType">&lt;!DOCTYPE </span>jbosscmp-jdbc PUBLIC
<span xmlns="" class="line">​</span>     "-//JBoss//DTD JBOSSCMP-JDBC 3.2//EN"
<span xmlns="" class="line">​</span>     "http://www.jboss.org/j2ee/dtd/jbosscmp-jdbc_3_2.dtd"<span xmlns="" class="perl_DataType">&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;defaults&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">&lt;!-- application-wide CMP defaults --&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/defaults&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- overrides to defaults section --&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;table-name&gt;</span>gangster<span xmlns="" class="perl_Keyword">&lt;/table-name&gt;</span>            
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- CMP Fields (see CMP-Fields) --&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- Load Groups (see Load Groups)--&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- Queries (see Queries) --&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
				The <code class="literal">ejb-name</code> element is required to match the entity specification here with the one in the <code class="literal">ejb-jar.xml</code> file. The remainder of the elements specify either overrides the global or application-wide CMP defaults and CMP mapping details specific to the bean. The application defaults come from the <code class="literal">defaults</code> section of the <code class="literal">jbosscmp-jdbc.xml</code> file and the global defaults come from the <code class="literal">defaults</code> section of the <code class="literal">standardjbosscmp-jdbc.xml</code> file in the <code class="literal">conf</code> directory for the current server configuration file set. The <code class="literal">defaults</code> section is discussed in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Defaults">Section 31.12, “Defaults”</a>. <a class="xref" href="The_CMP_Engine.html#Entity_Mapping-The_entity_element_content_model">Figure 31.3, “The entity element content model”</a> shows the full <code class="literal">entity</code> content model.
			</div><div class="figure"><a id="Entity_Mapping-The_entity_element_content_model">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_entity.png" align="middle" alt="The entity element content model" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.3. The entity element content model</strong></p></div><div class="para">
				A detailed description of each entity element follows:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>ejb-name</strong></span>: This required element is the name of the EJB to which this configuration applies. This element must match an <code class="literal">ejb-name</code> of an entity in the <code class="literal">ejb-jar.xml</code> file.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>datasource</strong></span>: This optional element is the <code class="literal">jndi-name</code> used to look up the datasource. All database connections used by an entity or relation-table are obtained from the datasource. Having different datasources for entities is not recommended, as it vastly constrains the domain over which finders and ejbSelects can query. The default is <code class="literal">java:/DefaultDS</code> unless overridden in the defaults section.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>datasource-mapping</strong></span>: This optional element specifies the name of the <code class="literal">type-mapping</code>, which determines how Java types are mapped to SQL types, and how EJB-QL functions are mapped to database specific functions. Type mappings are discussed in <a class="xref" href="The_CMP_Engine.html#Datasource_Customization-Mapping">Section 31.13.3, “Mapping”</a>. The default is <code class="literal">Hypersonic SQL</code> unless overridden in the defaults section.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>create-table</strong></span>: This optional element when true, specifies that JBoss should attempt to create a table for the entity. When the application is deployed, JBoss checks if a table already exists before creating the table. If a table is found, it is logged, and the table is not created. This option is very useful during the early stages of development when the table structure changes often. The default is false unless overridden in the defaults section.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>alter-table</strong></span>: If <code class="literal">create-table</code> is used to automatically create the schema, <code class="literal">alter-table</code> can be used to keep the schema current with changes to the entity bean. Alter table will perform the following specific tasks:
					</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
								new fields will be created
							</div></li><li class="listitem"><div class="para">
								fields which are no longer used will be removed
							</div></li><li class="listitem"><div class="para">
								string fields which are shorter than the declared length will have their length increased to the declared length. (not supported by all databases)
							</div></li></ul></div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>remove-table</strong></span>: This optional element when true, JBoss will attempt to drop the table for each entity and each relation table mapped relationship. When the application is undeployed, JBoss will attempt to drop the table. This option is very useful during the early stages of development when the table structure changes often. The default is false unless overridden in the defaults section.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>post-table-create</strong></span>: This optional element specifies an arbitrary SQL statement that should be executed immediately after the database table is created. This command is only executed if <code class="literal">create-table</code> is true and the table did not previously exist.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>read-only</strong></span>: This optional element when true specifies that the bean provider will not be allowed to change the value of any fields. A field that is read-only will not be stored in, or inserted into, the database. If a primary key field is read-only, the create method will throw a <code class="literal">CreateException</code>. If a set accessor is called on a read-only field, it throws an <code class="literal">EJBException</code>. Read-only fields are useful for fields that are filled in by database triggers, such as last update. The <code class="literal">read-only</code> option can be overridden on a per <code class="literal">cmp-field</code> basis, and is discussed in <a class="xref" href="The_CMP_Engine.html#CMP_Fields-Read_only_Fields">Section 31.4.3, “Read-only Fields”</a>. The default is false unless overridden in the <code class="literal">defaults</code> section.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>read-time-out</strong></span>: This optional element is the amount of time in milliseconds that a read on a read-only field is valid. A value of 0 means that the value is always reloaded at the start of a transaction, and a value of -1 means that the value never times out. This option can also be overridden on a per <code class="literal">cmp-field</code> basis. If <code class="literal">read-only</code> is false, this value is ignored. The default is -1 unless overridden in the <code class="literal">defaults</code> section.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>row-locking</strong></span>: This optional element if true specifies that JBoss will lock all rows loaded in a transaction. Most databases implement this by using the <code class="literal">SELECT FOR UPDATE</code> syntax when loading the entity, but the actual syntax is determined by the <code class="literal">row-locking-template</code> in the datasource-mapping used by this entity. The default is false unless overridden in the <code class="literal">defaults</code> section.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>pk-constraint</strong></span>: This optional element if true specifies that JBoss will add a primary key constraint when creating tables. The default is true unless overridden in the defaults section.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>read-ahead</strong></span>: This optional element controls caching of query results and <code class="literal">cmr-fields</code> for the entity. This option is discussed in <a class="xref" href="The_CMP_Engine.html#Optimized_Loading-Read_ahead">Section 31.7.3, “Read-ahead”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>fetch-size</strong></span>: This optional element specifies the number of entities to read in one round-trip to the underlying datastore. The default is 0 unless overridden in the defaults section.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>list-cache-max</strong></span>: This optional element specifies the number of read-lists that can be tracked by this entity. This option is discussed in <code class="literal">on-load</code>. The default is 1000 unless overridden in the defaults section.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>clean-read-ahead-on-load</strong></span>: When an entity is loaded from the read ahead cache, JBoss can remove the data used from the read ahead cache. The default is <code class="literal">false</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>table-name</strong></span>: This optional element is the name of the table that will hold data for this entity. Each entity instance will be stored in one row of this table. The default is the <code class="literal">ejb-name</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>cmp-field</strong></span>: The optional element allows one to define how the <code class="literal">ejb-jar.xml</code><code class="literal">cmp-field</code> is mapped onto the persistence store. This is discussed in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-CMP_Fields">Section 31.4, “CMP Fields”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>load-groups</strong></span>: This optional element specifies one or more groupings of CMP fields to declare load groupings of fields. This is discussed in <a class="xref" href="The_CMP_Engine.html#Optimized_Loading-Load_Groups">Section 31.7.2, “Load Groups”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>eager-load-groups</strong></span>: This optional element defines one or more load grouping as eager load groups. This is discussed in <a class="xref" href="The_CMP_Engine.html#Loading_Process-Eager_loading_Process">Section 31.8.2, “Eager-loading Process”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>lazy-load-groups</strong></span>: This optional element defines one or more load grouping as lazy load groups. This is discussed in <a class="xref" href="The_CMP_Engine.html#Loading_Process-Lazy_loading_Process">Section 31.8.3, “Lazy loading Process”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>query</strong></span>: This optional element specifies the definition of finders and selectors. This is discussed in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Queries">Section 31.6, “Queries”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>unknown-pk</strong></span>: This optional element allows one to define how an unknown primary key type of <code class="literal">java.lang.Object</code> maps to the persistent store.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>entity-command</strong></span>: This optional element allows one to define the entity creation command instance. Typically this is used to define a custom command instance to allow for primary key generation. This is described in detail in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Entity_Commands_and_Primary_Key_Generation">Section 31.11, “Entity Commands and Primary Key Generation”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>optimistic-locking</strong></span>: This optional element defines the strategy to use for optimistic locking. This is described in detail in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Optimistic_Locking">Section 31.10, “Optimistic Locking”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>audit</strong></span>: This optional element defines the CMP fields that will be audited. This is described in detail in <a class="xref" href="The_CMP_Engine.html#CMP_Fields-Auditing_Entity_Access">Section 31.4.4, “Auditing Entity Access”</a>.
					</div></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-CMP_Fields">
      ⁠</a>31.4. CMP Fields</h1></div></div></div><div class="para">
			CMP fields are declared on the bean class as abstract getter and setter methods that follow the JavaBean property accessor conventions. Our gangster bean, for example, has a <code class="literal">getName()</code> and a <code class="literal">setName()</code> method for accessing the <code class="literal">name</code> CMP field. In this section we will look at how the configure these declared CMP fields and control the persistence and behavior.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="CMP_Fields-CMP_Field_Declaration">
      ⁠</a>31.4.1. CMP Field Declaration</h2></div></div></div><div class="para">
				The declaration of a CMP field starts in the <code class="literal">ejb-jar.xml</code> file. On the gangster bean, for example, the <code class="literal">gangsterId</code>, <code class="literal">name</code>, <code class="literal">nickName</code> and <code class="literal">badness</code> would be declared in the <code class="literal">ejb-jar.xml</code> file as follows:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;ejb-jar&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;&lt;field-name&gt;</span>gangsterId<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;&lt;field-name&gt;</span>name<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;&lt;field-name&gt;</span>nickName<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;&lt;field-name&gt;</span>badness<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/ejb-jar&gt;</span>
</pre><div class="para">
				Note that the J2EE deployment descriptor does not declare any object-relational mapping details or other configuration. It is nothing more than a simple declaration of the CMP fields.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="CMP_Fields-CMP_Field_Column_Mapping">
      ⁠</a>31.4.2. CMP Field Column Mapping</h2></div></div></div><div class="para">
				The relational mapping configuration of a CMP field is done in the <code class="literal">jbosscmp-jdbc.xml</code> file. The structure is similar to the <code class="literal">ejb-jar.xml</code> with an entity <code class="literal">element</code> that has <code class="literal">cmp-field</code> elements under it with the additional configuration details.
			</div><div class="para">
				The following is shows the basic column name and data type mappings for the gangster bean.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;table-name&gt;</span>gangster<span xmlns="" class="perl_Keyword">&lt;/table-name&gt;</span>
<span xmlns="" class="line">​</span>                 
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>gangsterId<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>id<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>name<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>name<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;not-null/&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>nickName<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>nick_name<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;jdbc-type&gt;</span>VARCHAR<span xmlns="" class="perl_Keyword">&lt;/jdbc-type&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;sql-type&gt;</span>VARCHAR(64)<span xmlns="" class="perl_Keyword">&lt;/sql-type&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>badness<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>badness<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
				The full content model of the <code class="literal">cmp-field</code> element of the <code class="literal">jbosscmp-jdbc.xml</code> is shown below.
			</div><div class="para">
				<div class="figure"><a id="CMP_Field_Column_Mapping-The_JBoss_entity_element_content_model">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_cmp-field.png" align="middle" alt="The JBoss entity element content model" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.4. The JBoss entity element content model</strong></p></div>

			</div><div class="para">
				A detailed description of each element follows:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>field-name</strong></span>: This required element is the name of the <code class="literal">cmp-field</code> that is being configured. It must match the <code class="literal">field-name</code> element of a <code class="literal">cmp-field</code> declared for this entity in the <code class="literal">ejb-jar.xml</code> file.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>read-only</strong></span>: This declares that field in question is read-only. This field will not be written to the database by JBoss. Read-only fields are discussed in <a class="xref" href="The_CMP_Engine.html#CMP_Fields-Read_only_Fields">Section 31.4.3, “Read-only Fields”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>read-only-timeout</strong></span>: This is the time in milliseconds that a read-only field value will be considered valid.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>column-name</strong></span>: This optional element is the name of the column to which the <code class="literal">cmp-field</code> is mapped. The default is to use the <code class="literal">field-name</code> value.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>not-null</strong></span>: This optional element indicates that JBoss should add a NOT NULL to the end of the column declaration when automatically creating the table for this entity. The default for primary key fields and primitives is not null.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>jdbc-type</strong></span>: This is the JDBC type that is used when setting parameters in a JDBC prepared statement or loading data from a JDBC result set. The valid types are defined in <code class="literal">java.sql.Types</code>. This is only required if <code class="literal">sql-type</code> is specified. The default JDBC type will be based on the database type in the <code class="literal">datasourcemapping</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>sql-type</strong></span>: This is the SQL type that is used in create table statements for this field. Valid SQL types are only limited by your database vendor. This is only required if <code class="literal">jdbc-type</code> is specified. The default SQL type will be base on the database type in the <code class="literal">datasourcemapping</code>
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>property</strong></span>: This optional element allows one to define how the properties of a dependent value class CMP field should be mapped to the persistent store. This is discussed further in <a class="xref" href="The_CMP_Engine.html#CMP_Fields-Dependent_Value_Classes_DVCs">Section 31.4.5, “Dependent Value Classes (DVCs)”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>auto-increment</strong></span>: The presence of this optional field indicates that it is automatically incremented by the database layer. This is used to map a field to a generated column as well as to an externally manipulated column.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>dbindex</strong></span>: The presence of this optional field indicates that the server should create an index on the corresponding column in the database. The index name will be fieldname_index.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>check-dirty-after-get</strong></span>: This value defaults to false for primitive types and the basic java.lang immutable wrappers (<code class="literal">Integer</code>, <code class="literal">String</code>, etc...). For potentially mutable objects, JBoss will mark they field as potentially dirty after a get operation. If the dirty check on an object is too expensive, you can optimize it away by setting <code class="literal">check-dirty-after-get</code> to false.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>state-factory</strong></span>: This specifies class name of a state factory object which can perform dirty checking for this field. State factory classes must implement the <code class="literal">CMPFieldStateFactory</code> interface.
					</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="CMP_Fields-Read_only_Fields">
      ⁠</a>31.4.3. Read-only Fields</h2></div></div></div><div class="para">
				JBoss allows for read-only CMP fields by setting the <code class="literal">read-only</code> and <code class="literal">read-time-out</code> elements in the <code class="literal">cmp-field</code> declaration. These elements work the same way as they do at the entity level. If a field is read-only, it will never be used in an <code class="literal">INSERT</code> or <code class="literal">UPDATE</code> statement. If a primary key field is <code class="literal">read-only</code>, the create method will throw a <code class="literal">CreateException</code>. If a set accessor is called for a read-only field, it throws an <code class="literal">EJBException</code>. Read-only fields are useful for fields that are filled in by database triggers, such as last update. A read-only CMP field declaration example follows:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>lastUpdated<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;read-only&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/read-only&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;read-time-out&gt;</span>1000<span xmlns="" class="perl_Keyword">&lt;/read-time-out&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="CMP_Fields-Auditing_Entity_Access">
      ⁠</a>31.4.4. Auditing Entity Access</h2></div></div></div><div class="para">
				The <code class="literal">audit</code> element of the entity section allows one to specify how access to and entity bean is audited. This is only allowed when an entity bean is accessed under a security domain so that this is a caller identity established. The content model of the audit element is given <a class="xref" href="The_CMP_Engine.html#Auditing_Entity_Access-The_jbosscmp_jdbc.xml_audit_element_content_model">Figure 31.5, “The jbosscmp-jdbc.xml audit element content model”</a>.
			</div><div class="figure"><a id="Auditing_Entity_Access-The_jbosscmp_jdbc.xml_audit_element_content_model">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_audit.png" align="middle" alt="The jbosscmp-jdbc.xml audit element content model" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.5. The jbosscmp-jdbc.xml audit element content model</strong></p></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>created-by</strong></span>: This optional element indicates that the caller who created the entity should be saved to either the indicated <code class="literal">column-name</code> or cmp <code class="literal">field-name</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>created-time</strong></span>: This optional element indicates that the time of entity creation should be saved to either the indicated <code class="literal">column-name</code> or cmp <code class="literal">field-name</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>updated-by</strong></span>: This optional element indicates that the caller who last modified the entity should be saved to either the indicated <code class="literal">column-name</code> or CMP <code class="literal">field-name</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>updated-time</strong></span>: This optional element indicates that the last time of entity modification should be saved to either the indicated <code class="literal">column-name</code> or CMP <code class="literal">field-name</code>.
					</div></li></ul></div><div class="para">
				For each element, if a <code class="literal">field-name</code> is given, the corresponding audit information should be stored in the specified CMP field of the entity bean being accessed. Note that there does not have to be an corresponding CMP field declared on the entity. In case there are matching field names, you will be able to access audit fields in the application using the corresponding CMP field abstract getters and setters. Otherwise, the audit fields will be created and added to the entity internally. You will be able to access audit information in EJB-QL queries using the audit field names, but not directly through the entity accessors.
			</div><div class="para">
				If, on the other hand, a <code class="literal">column-name</code> is specified, the corresponding audit information should be stored in the indicated column of the entity table. If JBoss is creating the table the <code class="literal">jdbc-type</code> and <code class="literal">sql-type</code> element can then be used to define the storage type.
			</div><div class="para">
				The declaration of audit information with given column names is shown below.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>AuditChangedNamesEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;table-name&gt;</span>cmp2_audit_changednames<span xmlns="" class="perl_Keyword">&lt;/table-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;audit&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;created-by&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>createdby<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/created-by&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;created-time&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>createdtime<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/created-time&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;updated-by&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>updatedby<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;&lt;/updated-by&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;updated-time&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>updatedtime<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/updated-time&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/audit&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="CMP_Fields-Dependent_Value_Classes_DVCs">
      ⁠</a>31.4.5. Dependent Value Classes (DVCs)</h2></div></div></div><div class="para">
				A dependent value class (DVC) is a fancy term used to identity any Java class that is the type of a <code class="literal">cmp-field</code> other than the automatically recognized types core types such as strings and number values. By default, a DVC is serialized, and the serialized form is stored in a single database column. Although not discussed here, there are several known issues with the long-term storage of classes in serialized form.
			</div><div class="para">
				JBoss also supports the storage of the internal data of a DVC into one or more columns. This is useful for supporting legacy JavaBeans and database structures. It is not uncommon to find a database with a highly flattened structure (e.g., a <code class="literal">PURCHASE_ORDER</code> table with the fields <code class="literal">SHIP_LINE1</code>, <code class="literal">SHIP_LINE2</code>, <code class="literal">SHIP_CITY</code>, etc. and an additional set of fields for the billing address). Other common database structures include telephone numbers with separate fields for area code, exchange, and extension, or a person's name spread across several fields. With a DVC, multiple columns can be mapped to one logical field.
			</div><div class="para">
				JBoss requires that a DVC to be mapped must follow the JavaBeans naming specification for simple properties, and that each property to be stored in the database must have both a getter and a setter method. Furthermore, the bean must be serializable and must have a no argument constructor. A property can be any simple type, an un-mapped DVC or a mapped DVC, but cannot be an EJB. A DVC mapping is specified in a <code class="literal">dependent-value-class</code> element within the <code class="literal">dependent-value-classes</code> element.
			</div><div class="figure"><a id="Dependent_Value_Classes_DVCs-The_jbosscmp_jdbc_dependent_value_class_element_model.">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_dependent-value-class.png" align="middle" alt="The jbosscmp-jdbc dependent-value-class element model." style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.6. The jbosscmp-jdbc dependent-value-class element model.</strong></p></div><div class="para">
				Here is an example of a simple <code class="literal">ContactInfo</code> DVC class.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> ContactInfo 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">implements</span> Serializable 
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The cell phone number. */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> PhoneNumber cell;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The pager number. */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> PhoneNumber pager;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The email address */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String email;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Creates empty contact info.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Function">ContactInfo</span>() {
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> PhoneNumber <span xmlns="" class="perl_Function">getCell</span>() {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> cell;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setCell</span>(PhoneNumber cell) {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">this</span>.<span xmlns="" class="perl_Function">cell</span> = cell;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> PhoneNumber <span xmlns="" class="perl_Function">getPager</span>() {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> pager;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setPager</span>(PhoneNumber pager) {
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">this</span>.<span xmlns="" class="perl_Function">pager</span> = pager;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">getEmail</span>() {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> email;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setEmail</span>(String email) {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">this</span>.<span xmlns="" class="perl_Function">email</span> = email.<span xmlns="" class="perl_Function">toLowerCase</span>();
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">// ... equals, hashCode, toString </span>
<span xmlns="" class="line">​</span>}
</pre><div class="para">
				The contact info includes a phone number, which is represented by another DVC class.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> PhoneNumber
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">implements</span> Serializable 
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The first three digits of the phone number. */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">short</span> areaCode;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The middle three digits of the phone number. */</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">short</span> exchange;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The last four digits of the phone number. */</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">short</span> extension;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">// ... getters and setters </span>
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">// ... equals, hashCode, toString</span>
<span xmlns="" class="line">​</span>}
</pre><div class="para">
				The DVC mappings for these two classes are relatively straight forward.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;dependent-value-classes&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;dependent-value-class&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;description&gt;</span>A phone number<span xmlns="" class="perl_Keyword">&lt;/description&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;class&gt;</span>org.jboss.cmp2.crimeportal.PhoneNumber<span xmlns="" class="perl_Keyword">&lt;/class&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>areaCode<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>area_code<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>exchange<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>exchange<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>extension<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>extension<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/dependent-value-class&gt;</span>
<span xmlns="" class="line">​</span>                 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;dependent-value-class&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;description&gt;</span>General contact info<span xmlns="" class="perl_Keyword">&lt;/description&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;class&gt;</span>org.jboss.cmp2.crimeportal.ContactInfo<span xmlns="" class="perl_Keyword">&lt;/class&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>cell<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>cell<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>pager<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>pager<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>email<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>email<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;jdbc-type&gt;</span>VARCHAR<span xmlns="" class="perl_Keyword">&lt;/jdbc-type&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;sql-type&gt;</span>VARCHAR(128)<span xmlns="" class="perl_Keyword">&lt;/sql-type&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/dependent-value-class&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/dependent-value-classes&gt;</span>
</pre><div class="para">
				Each DVC is declared with a <code class="literal">dependent-value-class</code> element. A DVC is identified by the Java class type declared in the class element. Each property to be persisted is declared with a property element. This specification is based on the <code class="literal">cmp-field</code> element, so it should be self-explanatory. This restriction will also be removed in a future release. The current proposal involves storing the primary key fields in the case of a local entity and the entity handle in the case of a remote entity.
			</div><div class="para">
				The <code class="literal">dependent-value-classes</code> section defines the internal structure and default mapping of the classes. When JBoss encounters a field that has an unknown type, it searches the list of registered DVCs, and if a DVC is found, it persists this field into a set of columns, otherwise the field is stored in serialized form in a single column. JBoss does not support inheritance of DVCs; therefore, this search is only based on the declared type of the field. A DVC can be constructed from other DVCs, so when JBoss runs into a DVC, it flattens the DVC tree structure into a set of columns. If JBoss finds a DVC circuit during start up, it will throw an <code class="literal">EJBException</code>. The default column name of a property is the column name of the base <code class="literal">cmp-field</code> followed by an underscore and then the column name of the property. If the property is a DVC, the process is repeated. For example, a <code class="literal">cmp-field</code> named <code class="literal">info</code> that uses the <code class="literal">ContactInfo</code> DVC would have the following columns:
			</div><pre class="programlisting">info_cell_area_code
info_cell_exchange
info_cell_extension
info_pager_area_code
info_pager_exchange
info_pager_extension
info_email
</pre><div class="para">
				The automatically generated column names can quickly become excessively long and awkward. The default mappings of columns can be overridden in the entity element as follows:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>contactInfo<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>cell.areaCode<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>cell_area<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>cell.exchange<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>cell_exch<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>cell.extension<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>cell_ext<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>pager.areaCode<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>page_area<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>pager.exchange<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>page_exch<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>pager.extension<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>page_ext<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>                 
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;property&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;property-name&gt;</span>email<span xmlns="" class="perl_Keyword">&lt;/property-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>email<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;jdbc-type&gt;</span>VARCHAR<span xmlns="" class="perl_Keyword">&lt;/jdbc-type&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;sql-type&gt;</span>VARCHAR(128)<span xmlns="" class="perl_Keyword">&lt;/sql-type&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
				When overriding property info for the entity, you need to refer to the property from a flat perspective as in <code class="literal">cell.areaCode</code>.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-Container_Managed_Relationships">
      ⁠</a>31.5. Container Managed Relationships</h1></div></div></div><div class="para">
			Container Managed Relationships (CMRs) are a powerful new feature of CMP 2.0. Programmers have been creating relationships between entity objects since EJB 1.0 was introduced (not to mention since the introduction of databases), but before CMP 2.0 the programmer had to write a lot of code for each relationship in order to extract the primary key of the related entity and store it in a pseudo foreign key field. The simplest relationships were tedious to code, and complex relationships with referential integrity required many hours to code. With CMP 2.0 there is no need to code relationships by hand. The container can manage one-to-one, one-to-many and many-to-many relationships, with referential integrity. One restriction with CMRs is that they are only defined between local interfaces. This means that a relationship cannot be created between two entities in separate applications, even in the same application server.
		</div><div class="para">
			There are two basic steps to create a container managed relationship: create the <code class="literal">cmr-field</code> abstract accessors and declare the relationship in the <code class="literal">ejb-jar.xml</code> file. The following two sections describe these steps.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Container_Managed_Relationships-CMR_Field_Abstract_Accessors">
      ⁠</a>31.5.1. CMR-Field Abstract Accessors</h2></div></div></div><div class="para">
				CMR-Field abstract accessors have the same signatures as <code class="literal">cmp-fields</code>, except that single-valued relationships must return the local interface of the related entity, and multi-valued relationships can only return a <code class="literal">java.util.Collection</code> (or <code class="literal">java.util.Set</code>) object. For example, to declare a one-to-many relationship between organization and gangster, we declare the relationship from organization to gangster in the <code class="literal">OrganizationBean</code> class:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> OrganizationBean
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">implements</span> EntityBean 
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> Set <span xmlns="" class="perl_Function">getMemberGangsters</span>();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setMemberGangsters</span>(Set gangsters);
<span xmlns="" class="line">​</span>}
</pre><div class="para">
				We also can declare the relationship from gangster to organization in the <code class="literal">GangsterBean</code> class:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> GangsterBean
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">implements</span> EntityBean 
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> Organization <span xmlns="" class="perl_Function">getOrganization</span>();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setOrganization</span>(Organization org);
<span xmlns="" class="line">​</span>}
</pre><div class="para">
				Although each bean declared a CMR field, only one of the two beans in a relationship must have a set of accessors. As with CMP fields, a CMR field is required to have both a getter and a setter method.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Container_Managed_Relationships-Relationship_Declaration">
      ⁠</a>31.5.2. Relationship Declaration</h2></div></div></div><div class="para">
				The declaration of relationships in the <code class="literal">ejb-jar.xml</code> file is complicated and error prone. Although we recommend using a tool like XDoclet to manage the deployment descriptors for CMR fields, it's still important to understand how the descriptor works. The following illustrates the declaration of the organization/gangster relationship:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;ejb-jar&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;relationships&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;ejb-relation&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relation-name&gt;</span>Organization-Gangster<span xmlns="" class="perl_Keyword">&lt;/ejb-relation-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role-name&gt;</span>org-has-gangsters <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;multiplicity&gt;</span>One<span xmlns="" class="perl_Keyword">&lt;/multiplicity&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;relationship-role-source&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>OrganizationEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/relationship-role-source&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;cmr-field&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;cmr-field-name&gt;</span>memberGangsters<span xmlns="" class="perl_Keyword">&lt;/cmr-field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;cmr-field-type&gt;</span>java.util.Set<span xmlns="" class="perl_Keyword">&lt;/cmr-field-type&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/cmr-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                    gangster-belongs-to-org
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;multiplicity&gt;</span>Many<span xmlns="" class="perl_Keyword">&lt;/multiplicity&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;cascade-delete/&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;relationship-role-source&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/relationship-role-source&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;cmr-field&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;cmr-field-name&gt;</span>organization<span xmlns="" class="perl_Keyword">&lt;/cmr-field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/cmr-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/ejb-relation&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/relationships&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/ejb-jar&gt;</span>
</pre><div class="para">
				As you can see, each relationship is declared with an <code class="literal">ejb-relation</code> element within the top level <code class="literal">relationships</code> element. The relation is given a name in the <code class="literal">ejb-relation-name</code> element. This is important because we will need to refer to the role by name in the <code class="literal">jbosscmp-jdbc.xml</code> file. Each <code class="literal">ejb-relation</code> contains two <code class="literal">ejb-relationship-role</code> elements (one for each side of the relationship). The <code class="literal">ejb-relationship-role</code> tags are as follows:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>ejb-relationshiprole-name</strong></span>: This optional element is used to identify the role and match the database mapping the <code class="literal">jbosscmp-jdbc.xml</code> file. The relationship role names for each side of a relationship must be different.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>multiplicity</strong></span>: This indicates the multiplicity of this side of the relationship. The valid values are <code class="literal">One</code> or <code class="literal">Many</code>. In this example, the multiplicity of the organization is <code class="literal">One</code> and the multiplicity of the gangster is <code class="literal">Many</code> because the relationship is from one organization to many gangsters. Note, as with all XML elements, this element is case sensitive.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>cascade-delete</strong></span>: When this optional element is present, JBoss will delete the child entity when the parent entity is deleted. Cascade deletion is only allowed for a role where the other side of the relationship has a multiplicity of one. The default is to not cascade delete.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>relationship-role-source</strong></span>
					</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
								<span class="bold bold"><strong>ejb-name</strong></span>: This required element gives the name of the entity that has the role.
							</div></li></ul></div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>cmr-field</strong></span>
					</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
								<span class="bold bold"><strong>cmr-field-name</strong></span>: This is the name of the CMR field of the entity has one, if it has one.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>cmr-field-type</strong></span>: This is the type of the CMR field, if the field is a collection type. It must be <code class="literal">java.util.Collection</code> or <code class="literal">java.util.Set</code>.
							</div></li></ul></div></li></ul></div><div class="para">
				After adding the CMR field abstract accessors and declaring the relationship, the relationship should be functional. The next section discusses the database mapping of the relationship.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Container_Managed_Relationships-Relationship_Mapping">
      ⁠</a>31.5.3. Relationship Mapping</h2></div></div></div><div class="para">
				Relationships can be mapped using either a foreign key or a separate relation table. One-to-one and one-to-many relationships use the foreign key mapping style by default, and many-to-many relationships use only the relation table mapping style. The mapping of a relationship is declared in the <code class="literal">relationships</code> section of the <code class="literal">jbosscmp-jdbc.xml</code> descriptor via <code class="literal">ejb-relation</code> elements. Relationships are identified by the <code class="literal">ejb-relation-name</code> from the <code class="literal">ejb-jar.xml</code> file. The <code class="literal">jbosscmp-jdbc.xml</code><code class="literal">ejb-relation</code> element content model is shown in <a class="xref" href="The_CMP_Engine.html#Relationship_Mapping-The_jbosscmp_jdbc.xml_ejb_relation_element_content_model">Figure 31.7, “The jbosscmp-jdbc.xml ejb-relation element content model”</a>.
			</div><div class="figure"><a id="Relationship_Mapping-The_jbosscmp_jdbc.xml_ejb_relation_element_content_model">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_ejb-relation.png" align="middle" alt="The jbosscmp-jdbc.xml ejb-relation element content model" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.7. The jbosscmp-jdbc.xml ejb-relation element content model</strong></p></div><div class="para">
				The basic template of the relationship mapping declaration for <code class="literal">Organization-Gangster</code> relationship follows:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;relationships&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;ejb-relation&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relation-name&gt;</span>Organization-Gangster<span xmlns="" class="perl_Keyword">&lt;/ejb-relation-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;foreign-key-mapping/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role-name&gt;</span>org-has-gangsters<span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;key-fields&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;key-field&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>name<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>organization<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/key-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/key-fields&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role-name&gt;</span>gangster-belongs-to-org<span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;key-fields/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/ejb-relation&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/relationships&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
				After the <code class="literal">ejb-relation-name</code> of the relationship being mapped is declared, the relationship can be declared as read only using the <code class="literal">read-only</code> and <code class="literal">read-time-out</code> elements. They have the same semantics as their counterparts in the entity element.
			</div><div class="para">
				The <code class="literal">ejb-relation</code> element must contain either a <code class="literal">foreign-key-mapping</code> element or a <code class="literal">relation-table-mapping</code> element, which are described in <a class="xref" href="The_CMP_Engine.html#Relationship_Mapping-Foreign_Key_Mapping">Section 31.5.3.2, “Foreign Key Mapping”</a> and <a class="xref" href="The_CMP_Engine.html#Relationship_Mapping-Relation_table_Mapping">Section 31.5.3.3, “Relation table Mapping”</a>. This element may also contain a pair of <code class="literal">ejb-relationship-role</code> elements as described in the following section.
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Relationship_Mapping-Relationship_Role_Mapping">
      ⁠</a>31.5.3.1. Relationship Role Mapping</h3></div></div></div><div class="para">
					Each of the two <code class="literal">ejb-relationship-role</code> elements contains mapping information specific to an entity in the relationship. The content model of the <code class="literal">ejb-relationship-role</code> element is shown in <a class="xref" href="The_CMP_Engine.html#Relationship_Role_Mapping-The_jbosscmp_jdbc_ejb_relationship_role_element_content_model">Figure 31.8, “The jbosscmp-jdbc ejb-relationship-role element content model”</a>.
				</div><div class="figure"><a id="Relationship_Role_Mapping-The_jbosscmp_jdbc_ejb_relationship_role_element_content_model">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_ejb-relationship-role.png" align="middle" alt="The jbosscmp-jdbc ejb-relationship-role element content model" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.8. The jbosscmp-jdbc ejb-relationship-role element content model</strong></p></div><div class="para">
					A detailed description of the main elements follows:
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							<span class="bold bold"><strong>ejb-relationship-role-name</strong></span>: This required element gives the name of the role to which this configuration applies. It must match the name of one of the roles declared for this relationship in the <code class="literal">ejb-jar.xml</code> file.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>fk-constraint</strong></span>: This optional element is a true/false value that indicates whether JBoss should add a foreign key constraint to the tables for this side of the relationship. JBoss will only add generate the constraint if both the primary table and the related table were created by JBoss during deployment.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>key-fields</strong></span>: This optional element specifies the mapping of the primary key fields of the current entity, whether it is mapped in the relation table or in the related object. The <code class="literal">key-fields</code> element must contain a <code class="literal">key-field</code> element for each primary key field of the current entity. The <code class="literal">key-fields</code> element can be empty if no foreign key mapping is needed for this side of the relation. An example of this would be the many side of a one-to-many relationship. The details of this element are described below.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>read-ahead</strong></span>: This optional element controls the caching of this relationship. This option is discussed in <a class="xref" href="The_CMP_Engine.html#Lazy_loading_Process-Relationships">Section 31.8.3.1, “Relationships”</a>.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>batch-cascade-delete</strong></span>: This indicates that a cascade delete on this relationship should be performed with a single SQL statement. This requires that the relationship be marked as <code class="literal">batch-delete</code> in the <code class="literal">ejb-jar.xml</code>.
						</div></li></ul></div><div class="para">
					As noted above, the <code class="literal">key-fields</code> element contains a <code class="literal">key-field</code> for each primary key field of the current entity. The <code class="literal">key-field</code> element uses the same syntax as the <code class="literal">cmp-field</code> element of the entity, except that <code class="literal">key-field</code> does not support the <code class="literal">not-null</code> option. Key fields of a <code class="literal">relation-table</code> are automatically not null, because they are the primary key of the table. On the other hand, foreign key fields must be nullable by default. This is because the CMP specification requires an insert into the database after the <code class="literal">ejbCreate</code> method and an update to it after to pick up CMR changes made in <code class="literal">ejbPostCreate</code>. Since the EJB specification does not allow a relationship to be modified until <code class="literal">ejbPostCreate</code>, a foreign key will be initially set to null. There is a similar problem with removal. You can change this insert behavior using the <code class="literal">jboss.xml</code><code class="literal">insert-after-ejb-post-create</code> container configuration flag. The following example illustrates the creation of a new bean configuration that uses <code class="literal">insert-after-ejb-post-create</code> by default.
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- ... --&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;container-configurations&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;container-configuration</span><span xmlns="" class="perl_Others"> extends=</span><span xmlns="" class="perl_String">"Standard CMP 2.x EntityBean"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;container-name&gt;</span>INSERT after ejbPostCreate Container<span xmlns="" class="perl_Keyword">&lt;/container-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;insert-after-ejb-post-create&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/insert-after-ejb-post-create&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/container-configuration&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/container-configurations&gt;</span>                     
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss&gt;</span>
</pre><div class="para">
					An alternate means of working around the non-null foreign key issue is to map the foreign key elements onto non-null CMP fields. In this case you simply populate the foreign key fields in <code class="literal">ejbCreate</code> using the associated CMP field setters.
				</div><div class="para">
					The content model of the key-fields element is <a class="xref" href="The_CMP_Engine.html#Relationship_Role_Mapping-The_jbosscmp_jdbc_key_fields_element_content_model">Figure 31.9, “The jbosscmp-jdbc key-fields element content model”</a>.
				</div><div class="figure"><a id="Relationship_Role_Mapping-The_jbosscmp_jdbc_key_fields_element_content_model">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_key-field.png" align="middle" alt="The jbosscmp-jdbc key-fields element content model" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.9. The jbosscmp-jdbc key-fields element content model</strong></p></div><div class="para">
					A detailed description of the elements contained in the <code class="literal">key-field</code> element follows:
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							<span class="bold bold"><strong>field-name</strong></span>: This required element identifies the field to which this mapping applies. This name must match a primary key field of the current entity.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>column-name</strong></span>: Use this element to specify the column name in which this primary key field will be stored. If this is relationship uses <code class="literal">foreign-key-mapping</code>, this column will be added to the table for the related entity. If this relationship uses <code class="literal">relation-table-mapping</code>, this column is added to the <code class="literal">relation-table</code>. This element is not allowed for mapped dependent value class; instead use the property element.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>jdbc-type</strong></span>: This is the JDBC type that is used when setting parameters in a JDBC <code class="literal">PreparedStatement</code> or loading data from a JDBC ResultSet. The valid types are defined in <code class="literal">java.sql.Types</code>.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>sql-type</strong></span>: This is the SQL type that is used in create table statements for this field. Valid types are only limited by your database vendor.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>property</strong></span>: Use this element for to specify the mapping of a primary key field which is a dependent value class.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>dbindex</strong></span>: The presence of this optional field indicates that the server should create an index on the corresponding column in the database, and the index name will be <code class="literal">fieldname_index</code>.
						</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Relationship_Mapping-Foreign_Key_Mapping">
      ⁠</a>31.5.3.2. Foreign Key Mapping</h3></div></div></div><div class="para">
					Foreign key mapping is the most common mapping style for one-to-one and one-to-many relationships, but is not allowed for many-to many relationships. The foreign key mapping element is simply declared by adding an empty foreign <code class="literal">key-mapping</code> element to the <code class="literal">ejb-relation</code> element.
				</div><div class="para">
					As noted in the previous section, with a foreign key mapping the <code class="literal">key-fields</code> declared in the <code class="literal">ejb-relationship-role</code> are added to the table of the related entity. If the <code class="literal">key-fields</code> element is empty, a foreign key will not be created for the entity. In a one-to-many relationship, the many side (<code class="literal">Gangster</code> in the example) must have an empty <code class="literal">key-fields</code> element, and the one side (<code class="literal">Organization</code> in the example) must have a <code class="literal">key-fields</code> mapping. In one-to-one relationships, one or both roles can have foreign keys.
				</div><div class="para">
					The foreign key mapping is not dependent on the direction of the relationship. This means that in a one-to-one unidirectional relationship (only one side has an accessor) one or both roles can still have foreign keys. The complete foreign key mapping for the <code class="literal">Organization-Gangster</code> relationship is shown below with the foreign key elements:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;relationships&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;ejb-relation&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relation-name&gt;</span>Organization-Gangster<span xmlns="" class="perl_Keyword">&lt;/ejb-relation-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;foreign-key-mapping/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role-name&gt;</span>org-has-gangsters<span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;key-fields&gt;</span> <span xmlns="" class="perl_Keyword">&lt;key-field&gt;</span> <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>name<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span> <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>organization<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span> <span xmlns="" class="perl_Keyword">&lt;/key-field&gt;</span> <span xmlns="" class="perl_Keyword">&lt;/key-fields&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role-name&gt;</span>gangster-belongs-to-org<span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;key-fields/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/ejb-relation&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/relationships&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Relationship_Mapping-Relation_table_Mapping">
      ⁠</a>31.5.3.3. Relation table Mapping</h3></div></div></div><div class="para">
					Relation table mapping is less common for one-to-one and one-to-many relationships, but is the only mapping style allowed for many-to-many relationships. Relation table mapping is defined using the <code class="literal">relation-table-mapping</code> element, the content model of which is shown below.
				</div><div class="figure"><a id="Relation_table_Mapping-The_jbosscmp_jdbc_relation_table_mapping_element_content_model">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_relation-table-mapping.png" align="middle" alt="The jbosscmp-jdbc relation-table-mapping element content model" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.10. The jbosscmp-jdbc relation-table-mapping element content model</strong></p></div><div class="para">
					The relation-table-mapping for the <code class="literal">Gangster-Job</code> relationship is shown in with table mapping elements:
				</div><div class="example"><a id="Relation_table_Mapping-The_jbosscmp_jdbc.xml_Relation_table_Mapping">
      ⁠</a><p class="title"><strong>Example 31.1. The jbosscmp-jdbc.xml Relation-table Mapping</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;relationships&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;ejb-relation&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relation-name&gt;</span>Gangster-Jobs<span xmlns="" class="perl_Keyword">&lt;/ejb-relation-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;relation-table-mapping&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;table-name&gt;</span>gangster_job<span xmlns="" class="perl_Keyword">&lt;/table-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/relation-table-mapping&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role-name&gt;</span>gangster-has-jobs<span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;key-fields&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;key-field&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>gangsterId<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>gangster<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/key-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/key-fields&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role&gt;</span>   
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role-name&gt;</span>job-has-gangsters<span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;key-fields&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;key-field&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>name<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>job<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/key-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/key-fields&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/ejb-relation&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/relationships&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre></div></div><div class="para">
					The <code class="literal">relation-table-mapping</code> element contains a subset of the options available in the <code class="literal">entity</code> element. A detailed description of these elements is reproduced here for convenience:
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							<span class="bold bold"><strong>table-name</strong></span>: This optional element gives the name of the table that will hold data for this relationship. The default table name is based on the entity and <code class="literal">cmr-field</code> names.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>datasource</strong></span>: This optional element gives the <code class="literal">jndi-name</code> used to look up the datasource. All database connections are obtained from the datasource. Having different datasources for entities is not recommended, as it vastly constrains the domain over which finders and <code class="literal">ejbSelect</code>s can query.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>datasourcemapping</strong></span>: This optional element allows one to specify the name of the <code class="literal">type-mapping</code> to use.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>create-table</strong></span>: This optional element if true indicates JBoss should attempt to create a table for the relationship. When the application is deployed, JBoss checks if a table already exists before creating the table. If a table is found, it is logged, and the table is not created. This option is very useful during the early stages of development when the table structure changes often.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>post-table-create</strong></span>: This optional element specifies an arbitrary SQL statement that should be executed immediately after the database table is created. This command is only executed if <code class="literal">create-table</code> is true and the table did not previously exist.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>remove-table</strong></span>: This optional element if true indicates JBoss should attempt to drop the <code class="literal">relation-table</code> when the application is undeployed. This option is very useful during the early stages of development when the table structure changes often.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>row-locking</strong></span>: This optional element if true indicates JBoss should lock all rows loaded in a transaction. Most databases implement this by using the <code class="literal">SELECT FOR UPDATE</code> syntax when loading the entity, but the actual syntax is determined by the <code class="literal">row-locking-template</code> in the <code class="literal">datasource-mapping</code> used by this entity.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>pk-constraint</strong></span>: This optional element if true indicates JBoss should add a primary key constraint when creating tables.
						</div></li></ul></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-Queries">
      ⁠</a>31.6. Queries</h1></div></div></div><div class="para">
			Entity beans allow for two types of queries: finders and selects. A finder provides queries on an entity bean to clients of the bean. The select method is designed to provide private query statements to an entity implementation. Unlike finders, which are restricted to only return entities of the same type as the home interface on which they are defined, select methods can return any entity type or just one field of the entity. EJB-QL is the query language used to specify finders and select methods in a platform independent way.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Queries-Finder_and_select_Declaration">
      ⁠</a>31.6.1. Finder and select Declaration</h2></div></div></div><div class="para">
				The declaration of finders has not changed in CMP 2.0. Finders are still declared in the home interface (local or remote) of the entity. Finders defined on the local home interface do not throw a RemoteException. The following code declares the <code class="literal">findBadDudes_ejbql</code> finder on the <code class="literal">GangsterHome</code> interface. The <code class="literal">ejbql</code> suffix here is not required. It is simply a naming convention used here to differentiate the different types of query specifications we will be looking at.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> GangsterHome 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> EJBLocalHome 
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    Collection <span xmlns="" class="perl_Function">findBadDudes_ejbql</span>(<span xmlns="" class="perl_DataType">int</span> badness) <span xmlns="" class="perl_Keyword">throws</span> FinderException;
<span xmlns="" class="line">​</span>}
</pre><div class="para">
				Select methods are declared in the entity implementation class, and must be public and abstract just like CMP and CMR field abstract accessors and must throw a <code class="literal">FinderException</code>. The following code declares an select method:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> GangsterBean 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">implements</span> EntityBean 
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> Set <span xmlns="" class="perl_Function">ejbSelectBoss_ejbql</span>(String name)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> FinderException;
<span xmlns="" class="line">​</span>}
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Queries-EJB_QL_Declaration">
      ⁠</a>31.6.2. EJB-QL Declaration</h2></div></div></div><div class="para">
				Every select or finder method (except <code class="literal">findByPrimaryKey</code>) must have an EJB-QL query defined in the <code class="literal">ejb-jar.xml</code> file. The EJB-QL query is declared in a query element, which is contained in the entity element. The following are the declarations for <code class="literal">findBadDudes_ejbql</code> and <code class="literal">ejbSelectBoss_ejbql</code> queries:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;ejb-jar&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span> 
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- ... --&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findBadDudes_ejbql<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-params&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;method-param&gt;</span>int<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/method-params&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;ejb-ql&gt;</span>
<span xmlns="" class="line">​</span>                 SELECT OBJECT(g) FROM gangster g WHERE g.badness &gt; ?1
<span xmlns="" class="line">​</span>                 <span xmlns="" class="perl_Keyword">&lt;/ejb-ql&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>ejbSelectBoss_ejbql<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-params&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;method-param&gt;</span>java.lang.String<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/method-params&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;ejb-ql&gt;</span>
<span xmlns="" class="line">​</span>                 SELECT DISTINCT underling.organization.theBoss FROM gangster underling WHERE underling.name = ?1 OR underling.nickName = ?1
<span xmlns="" class="line">​</span>                 <span xmlns="" class="perl_Keyword">&lt;/ejb-ql&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/ejb-jar&gt;</span>
</pre><div class="para">
				EJB-QL is similar to SQL but has some surprising differences. The following are some important things to note about EJB-QL:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						EJB-QL is a typed language, meaning that it only allows comparison of like types (i.e., strings can only be compared with strings).
					</div></li><li class="listitem"><div class="para">
						In an equals comparison a variable (single valued path) must be on the left hand side. Some examples follow:
					</div></li></ul></div><pre class="programlisting"><span xmlns="" class="line">​</span>g.hangout.state = <span xmlns="" class="perl_String">'CA'</span> Legal
<span xmlns="" class="line">​</span><span xmlns="" class="perl_String">'CA'</span> = g.shippingAddress.state <span xmlns="" class="perl_Keyword">NOT</span> Legal
<span xmlns="" class="line">​</span><span xmlns="" class="perl_String">'CA'</span> = <span xmlns="" class="perl_String">'CA'</span> <span xmlns="" class="perl_Keyword">NOT</span> Legal
<span xmlns="" class="line">​</span>(r.amountPaid * <span xmlns="" class="perl_Float">.01</span>) &gt; <span xmlns="" class="perl_Float">300</span> <span xmlns="" class="perl_Keyword">NOT</span> Legal
<span xmlns="" class="line">​</span>r.amountPaid &gt; (<span xmlns="" class="perl_Float">300</span> / <span xmlns="" class="perl_Float">.01</span>) Legal</pre><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						Parameters use a base 1 index like java.sql.PreparedStatement.
					</div></li><li class="listitem"><div class="para">
						Parameters are only allowed on the right hand side of a comparison. For example:
					</div></li></ul></div><pre class="programlisting"><span xmlns="" class="line">​</span>gangster.hangout.state = ?<span xmlns="" class="perl_Float">1</span> Legal
<span xmlns="" class="line">​</span>?<span xmlns="" class="perl_Float">1</span> = gangster.hangout.state <span xmlns="" class="perl_Keyword">NOT</span> Legal</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Queries-Overriding_the_EJB_QL_to_SQL_Mapping">
      ⁠</a>31.6.3. Overriding the EJB-QL to SQL Mapping</h2></div></div></div><div class="para">
				The EJB-QL query can be overridden in the <code class="literal">jbosscmp-jdbc.xml</code> file. The finder or select is still required to have an EJB-QL declaration, but the <code class="literal">ejb-ql</code> element can be left empty. Currently the SQL can be overridden with JBossQL, DynamicQL, DeclaredSQL or a BMP style custom <code class="literal">ejbFind</code> method. All EJB-QL overrides are non-standard extensions to the EJB specification, so use of these extensions will limit portability of your application. All of the EJB-QL overrides, except for BMP custom finders, are declared using a <code class="literal">query</code> element in the jbosscmp-jdbc.xml file. The content model is shown in <a class="xref" href="The_CMP_Engine.html#Overriding_the_EJB_QL_to_SQL_Mapping-The_jbosscmp_jdbc_query_element_content_model">Figure 31.11, “The jbosscmp-jdbc query element content model”</a>.
			</div><div class="figure"><a id="Overriding_the_EJB_QL_to_SQL_Mapping-The_jbosscmp_jdbc_query_element_content_model">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_query.png" align="middle" alt="The jbosscmp-jdbc query element content model" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.11. The jbosscmp-jdbc query element content model</strong></p></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>description</strong></span>: An optional description for the query.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>query-method</strong></span>: This required element specifies the query method that being configured. This must match a <code class="literal">query-method</code> declared for this entity in the <code class="literal">ejb-jar.xml</code> file.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>jboss-ql</strong></span>: This is a JBossQL query to use in place of the EJB-QL query. JBossQL is discussed in <a class="xref" href="The_CMP_Engine.html#Queries-JBossQL">Section 31.6.4, “JBossQL”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>dynamic-ql</strong></span>: This indicated that the method is a dynamic query method and not an EJB-QL query. Dynamic queries are discussed in <a class="xref" href="The_CMP_Engine.html#Queries-DynamicQL">Section 31.6.5, “DynamicQL”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>declared-sql</strong></span>: This query uses declared SQL in place of the EJB-QL query. Declared SQL is discussed in <a class="xref" href="The_CMP_Engine.html#Queries-DeclaredSQL">Section 31.6.6, “DeclaredSQL”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>read-ahead</strong></span>: This optional element allows one to optimize the loading of additional fields for use with the entities referenced by the query. This is discussed in detail in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Optimized_Loading">Section 31.7, “Optimized Loading”</a>.
					</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Queries-JBossQL">
      ⁠</a>31.6.4. JBossQL</h2></div></div></div><div class="para">
				JBossQL is a superset of EJB-QL that is designed to address some of the inadequacies of EJB-QL. In addition to a more flexible syntax, new functions, key words, and clauses have been added to JBossQL. At the time of this writing, JBossQL includes support for an <code class="literal">ORDER BY</code>, <code class="literal">OFFSET</code> and <code class="literal">LIMIT</code> clauses, parameters in the <code class="literal">IN</code> and <code class="literal">LIKE</code> operators, the <code class="literal">COUNT</code>, <code class="literal">MAX</code>, <code class="literal">MIN</code>, <code class="literal">AVG</code>, <code class="literal">SUM</code>, <code class="literal">UCASE</code> and <code class="literal">LCASE</code> functions. Queries can also include functions in the <code class="literal">SELECT</code> clause for select methods.
			</div><div class="para">
				JBossQL is declared in the <code class="literal">jbosscmp-jdbc.xml</code> file with a <code class="literal">jboss-ql</code> element containing the JBossQL query. The following example provides an example JBossQL declaration.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findBadDudes_jbossql<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-params&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;method-param&gt;</span>int<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/method-params&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;jboss-ql&gt;</span>SELECT OBJECT(g) FROM gangster g WHERE g.badness &gt; ?1 ORDER BY g.badness DESC<span xmlns="" class="perl_Keyword">&lt;/jboss-ql&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
				The corresponding generated SQL is straightforward.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> t0_g.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">FROM</span> gangster t0_g
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">WHERE</span> t0_g.badness &gt; ?
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">ORDER</span> <span xmlns="" class="perl_Keyword">BY</span> t0_g.badness <span xmlns="" class="perl_Keyword">DESC</span>
</pre><div class="para">
				Another capability of JBossQL is the ability to retrieve finder results in blocks using the <code class="literal">LIMIT</code> and <code class="literal">OFFSET</code> functions. For example, to iterate through the large number of jobs performed, the following <code class="literal">findManyJobs_jbossql</code> finder may be defined.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findManyJobs_jbossql<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-params&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;method-param&gt;</span>int<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/method-params&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-params&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;method-param&gt;</span>int<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/method-params&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;jboss-ql&gt;</span>SELECT OBJECT(j) FROM jobs j OFFSET ?1 LIMIT ?2<span xmlns="" class="perl_Keyword">&lt;/jboss-ql&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Queries-DynamicQL">
      ⁠</a>31.6.5. DynamicQL</h2></div></div></div><div class="para">
				DynamicQL allows the runtime generation and execution of JBossQL queries. A DynamicQL query method is an abstract method that takes a JBossQL query and the query arguments as parameters. JBoss compiles the JBossQL and executes the generated SQL. The following generates a JBossQL query that selects all the gangsters that have a hangout in any state in the states set:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> GangsterBean 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">implements</span> EntityBean 
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Set <span xmlns="" class="perl_Function">ejbHomeSelectInStates</span>(Set states)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> FinderException
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// generate JBossQL query</span>
<span xmlns="" class="line">​</span>        StringBuffer jbossQl = <span xmlns="" class="perl_Keyword">new</span> StringBuffer();
<span xmlns="" class="line">​</span>        jbossQl.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"SELECT OBJECT(g) "</span>);
<span xmlns="" class="line">​</span>        jbossQl.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"FROM gangster g "</span>);
<span xmlns="" class="line">​</span>        jbossQl.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"WHERE g.hangout.state IN ("</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">for</span> (<span xmlns="" class="perl_DataType">int</span> i = <span xmlns="" class="perl_Float">0</span>; i &lt; states.<span xmlns="" class="perl_Function">size</span>(); i++) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (i &gt; <span xmlns="" class="perl_Float">0</span>) {
<span xmlns="" class="line">​</span>                jbossQl.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">", "</span>);
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            jbossQl.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"?"</span>).<span xmlns="" class="perl_Function">append</span>(i+<span xmlns="" class="perl_Float">1</span>);
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	    jbossQl.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">") ORDER BY g.name"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// pack arguments into an Object[]</span>
<span xmlns="" class="line">​</span>        Object[] args = states.<span xmlns="" class="perl_Function">toArray</span>(<span xmlns="" class="perl_Keyword">new</span> Object[states.<span xmlns="" class="perl_Function">size</span>()]);
<span xmlns="" class="line">​</span> 
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// call dynamic-ql query</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Function">ejbSelectGeneric</span>(jbossQl.<span xmlns="" class="perl_Function">toString</span>(), args);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
</pre><div class="para">
				The DynamicQL select method may have any valid select method name, but the method must always take a string and an object array as parameters. DynamicQL is declared in the <code class="literal">jbosscmp-jdbc.xml</code> file with an empty <code class="literal">dynamic-ql</code> element. The following is the declaration for <code class="literal">ejbSelectGeneric</code>.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>ejbSelectGeneric<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-params&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;method-param&gt;</span>java.lang.String<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;method-param&gt;</span>java.lang.Object[]<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/method-params&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;dynamic-ql/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Queries-DeclaredSQL">
      ⁠</a>31.6.6. DeclaredSQL</h2></div></div></div><div class="para">
				DeclaredSQL is based on the legacy JAWS CMP 1.1 engine finder declaration, but has been updated for CMP 2.0. Commonly this declaration is used to limit a query with a <code class="literal">WHERE</code> clause that cannot be represented in q EJB-QL or JBossQL. The content model for the declared-sql element is given in <a class="xref" href="The_CMP_Engine.html#DeclaredSQL-The_jbosscmp_jdbc_declared_sql_element_content_model.">Figure 31.12, “The jbosscmp-jdbc declared-sql element content model.&gt;”</a>.
			</div><div class="figure"><a id="DeclaredSQL-The_jbosscmp_jdbc_declared_sql_element_content_model.">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_declared-sql.png" align="middle" alt="The jbosscmp-jdbc declared-sql element content model.&gt;" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.12. The jbosscmp-jdbc declared-sql element content model.&gt;</strong></p></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>select</strong></span>: The <code class="literal">select</code> element specifies what is to be selected and consists of the following elements:
					</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
								<span class="bold bold"><strong>distinct</strong></span>: If this empty element is present, JBoss will add the <code class="literal">DISTINCT</code> keyword to the generated <code class="literal">SELECT</code> clause. The default is to use <code class="literal">DISTINCT</code> if method returns a <code class="literal">java.util.Set</code>
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>ejb-name</strong></span>: This is the <code class="literal">ejb-name</code> of the entity that will be selected. This is only required if the query is for a select method.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>field-name</strong></span>: This is the name of the CMP field that will be selected from the specified entity. The default is to select entire entity.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>alias</strong></span>: This specifies the alias that will be used for the main select table. The default is to use the <code class="literal">ejb-name</code>.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>additional-columns</strong></span>: Declares other columns to be selected to satisfy ordering by arbitrary columns with finders or to facilitate aggregate functions in selects.
							</div></li></ul></div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>from</strong></span>: The <code class="literal">from</code> element declares additional SQL to append to the generated <code class="literal">FROM</code> clause.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>where</strong></span>: The <code class="literal">where</code> element declares the <code class="literal">WHERE</code> clause for the query.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>order</strong></span>: The <code class="literal">order</code> element declares the <code class="literal">ORDER</code> clause for the query.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>other</strong></span>: The <code class="literal">other</code> element declares additional SQL that is appended to the end of the query.
					</div></li></ul></div><div class="para">
				The following is an example DeclaredSQL declaration.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findBadDudes_declaredsql<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-params&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;method-param&gt;</span>int<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/method-params&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;declared-sql&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;where&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span> badness &gt; {0} <span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/where&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;order&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span> badness DESC <span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/order&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/declared-sql&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
				The generated SQL would be:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> <span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">FROM</span> gangster
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">WHERE</span> badness &gt; ?
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">ORDER</span> <span xmlns="" class="perl_Keyword">BY</span> badness <span xmlns="" class="perl_Keyword">DESC</span>
</pre><div class="para">
				As you can see, JBoss generates the <code class="literal">SELECT</code> and <code class="literal">FROM</code> clauses necessary to select the primary key for this entity. If desired an additional <code class="literal">FROM</code> clause can be specified that is appended to the end of the automatically generated <code class="literal">FROM</code> clause. The following is example DeclaredSQL declaration with an additional <code class="literal">FROM</code> clause.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>ejbSelectBoss_declaredsql<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-params&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;method-param&gt;</span>java.lang.String<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/method-params&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;declared-sql&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;select&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;distinct/&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;alias&gt;</span>boss<span xmlns="" class="perl_Keyword">&lt;/alias&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/select&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;from&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span>, gangster g, organization o<span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/from&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;where&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span>
<span xmlns="" class="line">​</span>                     (LCASE(g.name) = {0} OR LCASE(g.nick_name) = {0}) AND
<span xmlns="" class="line">​</span>                     g.organization = o.name AND o.the_boss = boss.id
<span xmlns="" class="line">​</span>                     <span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/where&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/declared-sql&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
				The generated SQL would be:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> <span xmlns="" class="perl_Keyword">DISTINCT</span> boss.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">FROM</span> gangster boss, gangster g, <span xmlns="" class="perl_Keyword">organization</span> o
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">WHERE</span> (LCASE(g.name) = ? <span xmlns="" class="perl_Keyword">OR</span> LCASE(g.nick_name) = ?) <span xmlns="" class="perl_Keyword">AND</span>
<span xmlns="" class="line">​</span>          g.<span xmlns="" class="perl_Keyword">organization</span> = o.name <span xmlns="" class="perl_Keyword">AND</span> o.the_boss = boss.<span xmlns="" class="perl_Keyword">id</span>
</pre><div class="para">
				Notice that the <code class="literal">FROM</code> clause starts with a comma. This is because the container appends the declared <code class="literal">FROM</code> clause to the end of the generated <code class="literal">FROM</code> clause. It is also possible for the <code class="literal">FROM</code> clause to start with a SQL <code class="literal">JOIN</code> statement. Since this is a select method, it must have a <code class="literal">select</code> element to declare the entity that will be selected. Note that an alias is also declared for the query. If an alias is not declared, the <code class="literal">table-name</code> is used as the alias, resulting in a <code class="literal">SELECT</code> clause with the <code class="literal">table_name.field_name</code> style column declarations. Not all database vendors support the that syntax, so the declaration of an alias is preferred. The optional empty <code class="literal">distinct</code> element causes the <code class="literal">SELECT</code> clause to use the <code class="literal">SELECT DISTINCT</code> declaration. The DeclaredSQL declaration can also be used in select methods to select a CMP field.
			</div><div class="para">
				Now we well see an example which overrides a select to return all of the zip codes an <code class="literal">Organization</code> operates in.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>OrganizationEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>ejbSelectOperatingZipCodes_declaredsql<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-params&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;method-param&gt;</span>java.lang.String<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/method-params&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;declared-sql&gt;</span> <span xmlns="" class="perl_Keyword">&lt;select&gt;</span> <span xmlns="" class="perl_Keyword">&lt;distinct/&gt;</span> <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>LocationEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span> <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>zipCode<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span> <span xmlns="" class="perl_Keyword">&lt;alias&gt;</span>hangout<span xmlns="" class="perl_Keyword">&lt;/alias&gt;</span> <span xmlns="" class="perl_Keyword">&lt;/select&gt;</span> <span xmlns="" class="perl_Keyword">&lt;from&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span> , organization o, gangster g <span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/from&gt;</span> <span xmlns="" class="perl_Keyword">&lt;where&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span> LCASE(o.name) = {0} AND o.name = g.organization AND g.hangout = hangout.id <span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/where&gt;</span> <span xmlns="" class="perl_Keyword">&lt;order&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span> hangout.zip <span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/order&gt;</span> <span xmlns="" class="perl_Keyword">&lt;/declared-sql&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
				The corresponding SQL would be:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> <span xmlns="" class="perl_Keyword">DISTINCT</span> hangout.zip
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">FROM</span> location hangout, <span xmlns="" class="perl_Keyword">organization</span> o, gangster g
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">WHERE</span> LCASE(o.name) = ? <span xmlns="" class="perl_Keyword">AND</span> o.name = g.<span xmlns="" class="perl_Keyword">organization</span> <span xmlns="" class="perl_Keyword">AND</span> g.hangout = hangout.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">ORDER</span> <span xmlns="" class="perl_Keyword">BY</span> hangout.zip
</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="DeclaredSQL-Parameters">
      ⁠</a>31.6.6.1. Parameters</h3></div></div></div><div class="para">
					DeclaredSQL uses a completely new parameter handling system, which supports entity and DVC parameters. Parameters are enclosed in curly brackets and use a zero-based index, which is different from the one-based EJB-QL parameters. There are three categories of parameters: simple, DVC, and entity.
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							<span class="bold bold"><strong>simple</strong></span>: A simple parameter can be of any type except for a known (mapped) DVC or an entity. A simple parameter only contains the argument number, such as <code class="literal">{0}</code>. When a simple parameter is set, the JDBC type used to set the parameter is determined by the <code class="literal">datasourcemapping</code> for the entity. An unknown DVC is serialized and then set as a parameter. Note that most databases do not support the use of a BLOB value in a WHERE clause.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>DVC</strong></span>: A DVC parameter can be any known (mapped) DVC. A DVC parameter must be dereferenced down to a simple property (one that is not another DVC). For example, if we had a CVS property of type <code class="literal">ContactInfo</code>, valid parameter declarations would be <code class="literal">{0.email}</code> and <code class="literal">{0.cell.areaCode}</code> but not <code class="literal">{0.cell}</code>. The JDBC type used to set a parameter is based on the class type of the property and the <code class="literal">datasourcemapping</code> of the entity. The JDBC type used to set the parameter is the JDBC type that is declared for that property in the <code class="literal">dependent-value-class</code> element.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>entity</strong></span>: An entity parameter can be any entity in the application. An entity parameter must be dereferenced down to a simple primary key field or simple property of a DVC primary key field. For example, if we had a parameter of type <code class="literal">Gangster</code>, a valid parameter declaration would be <code class="literal">{0.gangsterId}</code>. If we had some entity with a primary key field named info of type <code class="literal">ContactInfo</code>, a <code class="literal">valid parameter</code> declaration would be <code class="literal">{0.info.cell.areaCode}</code>. Only fields that are members of the primary key of the entity can be dereferenced (this restriction may be removed in later versions). The JDBC type used to set the parameter is the JDBC type that is declared for that field in the entity declaration.
						</div></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Queries-EJBQL_2.1_and_SQL92_queries">
      ⁠</a>31.6.7. EJBQL 2.1 and SQL92 queries</h2></div></div></div><div class="para">
				The default query compiler does not fully support EJB-QL 2.1 or the SQL92 standard. If you need either of these functions, you can replace the query compiler. The default compiler is specified in <code class="literal">standardjbosscmp-jdbc.xml</code>.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;defaults&gt;</span>
<span xmlns="" class="line">​</span>    ...
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;ql-compiler&gt;</span>org.jboss.ejb.plugins.cmp.jdbc.JDBCEJBQLCompiler<span xmlns="" class="perl_Keyword">&lt;/ql-compiler&gt;</span>
<span xmlns="" class="line">​</span>    ...
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/defaults&gt;</span>
</pre><div class="para">
				To use the SQL92 compiler, simply specify the SQL92 compiler in <code class="literal">ql-compiler</code> element.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;defaults&gt;</span>
<span xmlns="" class="line">​</span>    ...
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;ql-compiler&gt;</span>org.jboss.ejb.plugins.cmp.jdbc.EJBQLToSQL92Compiler<span xmlns="" class="perl_Keyword">&lt;/ql-compiler&gt;</span>
<span xmlns="" class="line">​</span>    ...
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/defaults&gt;</span>
</pre><div class="para">
				This changes the query compiler for all beans in the entire system. You can also specify the ql-compiler for each element in <code class="literal">jbosscmp-jdbc.xml</code>. Here is an example using one of our earlier queries.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findBadDudes_ejbql<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;method-params&gt;</span>
<span xmlns="" class="line">​</span>            lt;method-param&gt;int<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/method-params&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;ejb-ql&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span>
<span xmlns="" class="line">​</span>        SELECT OBJECT(g)
<span xmlns="" class="line">​</span>        FROM gangster g
<span xmlns="" class="line">​</span>        WHERE g.badness &gt; ?1<span xmlns="" class="perl_BaseN">]]&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/ejb-ql&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;ql-compiler&gt;</span>org.jboss.ejb.plugins.cmp.jdbc.EJBQLToSQL92Compiler<span xmlns="" class="perl_Keyword">&lt;/ql-compiler&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Error">&lt;</span>/query&gt;
</pre><div class="para">
				One important limitation of SQL92 query compiler is that it always selects all the fields of an entity regardless the <code class="literal">read-ahead</code> strategy in use. For example, if a query is configured with the <code class="literal">on-load</code><code class="literal">read-ahead</code> strategy, the first query will include all the fields, not just primary key fields but only the primary key fields will be read from the <code class="literal">ResultSet</code>. Then, on load, other fields will be actually loaded into the read-ahead cache. The <code class="literal">on-find</code><code class="literal">read-ahead</code> with the default load group <code class="literal">*</code> works as expected.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Queries-BMP_Custom_Finders">
      ⁠</a>31.6.8. BMP Custom Finders</h2></div></div></div><div class="para">
				JBoss also supports bean managed persistence custom finders. If a custom finder method matches a finder declared in the home or local home interface, JBoss will always call the custom finder over any other implementation declared in the <code class="literal">ejb-jar.xml</code> or <code class="literal">jbosscmp-jdbc.xml</code> files. The following simple example finds the entities by a collection of primary keys:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> GangsterBean
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">implements</span> EntityBean 
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Collection <span xmlns="" class="perl_Function">ejbFindByPrimaryKeys</span>(Collection keys)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> keys;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
</pre><div class="para">
				This is a very useful finder because it quickly coverts primary keys into real Entity objects without contacting the database. One drawback is that it can create an Entity object with a primary key that does not exist in the database. If any method is invoked on the bad Entity, a NoSuchEntityException will be thrown. Another drawback is that the resulting entity bean violates the EJB specification in that it implements a finder, and the JBoss EJB verifier will fail the deployment of such an entity unless the StrictVerifier attribute is set to false.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-Optimized_Loading">
      ⁠</a>31.7. Optimized Loading</h1></div></div></div><div class="para">
			The goal of optimized loading is to load the smallest amount of data required to complete a transaction in the fewest number of queries. The tuning of JBoss depends on a detailed knowledge of the loading process. This section describes the internals of the JBoss loading process and its configuration. Tuning of the loading process really requires a holistic understanding of the loading system, so this chapter may have to be read more than once.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Optimized_Loading-Loading_Scenario">
      ⁠</a>31.7.1. Loading Scenario</h2></div></div></div><div class="para">
				The easiest way to investigate the loading process is to look at a usage scenario. The most common scenario is to locate a collection of entities and iterate over the results performing some operation. The following example generates an html table containing all of the gangsters:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">createGangsterHtmlTable_none</span>() 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">throws</span> FinderException 
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    StringBuffer table = <span xmlns="" class="perl_Keyword">new</span> StringBuffer();
<span xmlns="" class="line">​</span>    table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;table&gt;"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    Collection gangsters = gangsterHome.<span xmlns="" class="perl_Function">findAll_none</span>();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">for</span> (Iterator iter = gangsters.<span xmlns="" class="perl_Function">iterator</span>(); iter.<span xmlns="" class="perl_Function">hasNext</span>();) {
<span xmlns="" class="line">​</span>        Gangster gangster = (Gangster) iter.<span xmlns="" class="perl_Function">next</span>();
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;tr&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;td&gt;"</span>).<span xmlns="" class="perl_Function">append</span>(gangster.<span xmlns="" class="perl_Function">getName</span>());
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/td&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;td&gt;"</span>).<span xmlns="" class="perl_Function">append</span>(gangster.<span xmlns="" class="perl_Function">getNickName</span>());
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/td&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;td&gt;"</span>).<span xmlns="" class="perl_Function">append</span>(gangster.<span xmlns="" class="perl_Function">getBadness</span>());
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/td&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/tr&gt;"</span>);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">return</span> table.<span xmlns="" class="perl_Function">toString</span>();
<span xmlns="" class="line">​</span>}
</pre><div class="para">
				Assume this code is called within a single transaction and all optimized loading has been disabled. At the <code class="literal">findAll_none</code> call, JBoss will execute the following query:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> t0_g.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">FROM</span> gangster t0_g
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">ORDER</span> <span xmlns="" class="perl_Keyword">BY</span> t0_g.<span xmlns="" class="perl_Keyword">id</span> <span xmlns="" class="perl_Keyword">ASC</span>
</pre><div class="para">
				Then as each of the eight gangster in the sample database is accessed, JBoss will execute the following eight queries:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> name, nick_name, badness, hangout, <span xmlns="" class="perl_Keyword">organization</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">0</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> name, nick_name, badness, hangout, <span xmlns="" class="perl_Keyword">organization</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">1</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> name, nick_name, badness, hangout, <span xmlns="" class="perl_Keyword">organization</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">2</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> name, nick_name, badness, hangout, <span xmlns="" class="perl_Keyword">organization</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">3</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> name, nick_name, badness, hangout, <span xmlns="" class="perl_Keyword">organization</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">4</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> name, nick_name, badness, hangout, <span xmlns="" class="perl_Keyword">organization</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">5</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> name, nick_name, badness, hangout, <span xmlns="" class="perl_Keyword">organization</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">6</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> name, nick_name, badness, hangout, <span xmlns="" class="perl_Keyword">organization</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">7</span>)
</pre><div class="para">
				There are two problems with this scenario. First, an excessive number of queries are executed because JBoss executes one query for the <code class="literal">findAll</code> and one query to access each element found. The reason for this behavior has to do with the handling of query results inside the JBoss container. Although it appears that the actual entity beans selected are returned when a query is executed, JBoss really only returns the primary keys of the matching entities, and does not load the entity until a method is invoked on it. This is known as the <span class="emphasis"><em>n+1</em></span> problem and is addressed with the read-ahead strategies described in the following sections.
			</div><div class="para">
				Second, the values of unused fields are loaded needlessly. JBoss loads the <code class="literal">hangout</code> and <code class="literal">organization</code> fields, which are never accessed. (we have disabled the complex <code class="literal">contactInfo</code> field for the sake of clarity)
			</div><div class="para">
				The following table shows the execution of the queries:
			</div><div class="table"><a id="Loading_Scenario-Unoptimized_Query_Execution">
      ⁠</a><p class="title"><strong>Table 31.1. Un-optimized Query Execution</strong></p><div class="table-contents"><table xmlns:d="http://docbook.org/ns/docbook" class="gt-4-cols gt-7-rows" summary="Un-optimized Query Execution"><colgroup><col/><col/><col/><col/><col/><col/></colgroup><thead><tr><th> id </th><th> name </th><th> nick_name </th><th> badness </th><th> hangout </th><th> organization </th></tr></thead><tbody><tr><td> 0 </td><td> Yojimbo </td><td> Bodyguard </td><td> 7 </td><td> 0 </td><td> Yakuza </td></tr><tr><td> 1 </td><td> Takeshi </td><td> Master </td><td> 10 </td><td> 1 </td><td> Yakuza </td></tr><tr><td> 2 </td><td> Yuriko </td><td> Four finger </td><td> 4 </td><td> 2 </td><td> Yakuza </td></tr><tr><td> 3 </td><td> Chow </td><td> Killer </td><td> 9 </td><td> 3 </td><td> Triads </td></tr><tr><td> 4 </td><td> Shogi </td><td> Lightning </td><td> 8 </td><td> 4 </td><td> Triads </td></tr><tr><td> 5 </td><td> Valentino </td><td> Pizza-Face </td><td> 4 </td><td> 5 </td><td> Mafia </td></tr><tr><td> 6 </td><td> Toni </td><td> Toothless </td><td> 2 </td><td> 6 </td><td> Mafia </td></tr><tr><td> 7 </td><td> Corleone </td><td> Godfather </td><td> 6 </td><td> 7 </td><td> Mafia </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Optimized_Loading-Load_Groups">
      ⁠</a>31.7.2. Load Groups</h2></div></div></div><div class="para">
				The configuration and optimization of the loading system begins with the declaration of named load groups in the entity. A load group contains the names of CMP fields and CMR Fields that have a foreign key (e.g., <code class="literal">Gangster</code> in the Organization-Gangster example) that will be loaded in a single operation. An example configuration is shown below:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span> 
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- ... --&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;load-groups&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;load-group&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;load-group-name&gt;</span>basic<span xmlns="" class="perl_Keyword">&lt;/load-group-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>name<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>nickName<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>badness<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/load-group&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;load-group&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;load-group-name&gt;</span>contact info<span xmlns="" class="perl_Keyword">&lt;/load-group-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>nickName<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>contactInfo<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>hangout<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/load-group&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/load-groups&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
				In this example, two load groups are declared: <code class="literal">basic</code> and <code class="literal">contact info</code>. Note that the load groups do not need to be mutually exclusive. For example, both of the load groups contain the <code class="literal">nickName</code> field. In addition to the declared load groups, JBoss automatically adds a group named <code class="literal">*</code> (the star group) that contains every CMP field and CMR field with a foreign key in the entity.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Optimized_Loading-Read_ahead">
      ⁠</a>31.7.3. Read-ahead</h2></div></div></div><div class="para">
				Optimized loading in JBoss is called read-ahead. This refers to the technique of reading the row for an entity being loaded, as well as the next several rows; hence the term read-ahead. JBoss implements two main strategies (<code class="literal">on-find</code> and <code class="literal">on-load</code>) to optimize the loading problem identified in the previous section. The extra data loaded during read-ahead is not immediately associated with an entity object in memory, as entities are not materialized in JBoss until actually accessed. Instead, it is stored in the preload cache where it remains until it is loaded into an entity or the end of the transaction occurs. The following sections describe the read-ahead strategies.
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Read_ahead-on_find">
      ⁠</a>31.7.3.1. on-find</h3></div></div></div><div class="para">
					The <code class="literal">on-find</code> strategy reads additional columns when the query is invoked. If the query is <code class="literal">on-find</code> optimized, JBoss will execute the following query when the query is executed.
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> t0_g.<span xmlns="" class="perl_Keyword">id</span>, t0_g.name, t0_g.nick_name, t0_g.badness 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">FROM</span> gangster t0_g
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">ORDER</span> <span xmlns="" class="perl_Keyword">BY</span> t0_g.<span xmlns="" class="perl_Keyword">id</span> <span xmlns="" class="perl_Keyword">ASC</span>
</pre><div class="para">
					All of the required data would be in the preload cache, so no additional queries would need to be executed while iterating through the query results. This strategy is effective for queries that return a small amount of data, but it becomes very inefficient when trying to load a large result set into memory. The following table shows the execution of this query:
				</div><div class="table"><a id="on_find-on_find_Optimized_Query_Execution">
      ⁠</a><p class="title"><strong>Table 31.2. on-find Optimized Query Execution</strong></p><div class="table-contents"><table xmlns:d="http://docbook.org/ns/docbook" class="gt-4-cols gt-7-rows" summary="on-find Optimized Query Execution"><colgroup><col/><col/><col/><col/><col/><col/></colgroup><thead><tr><th> id </th><th> name </th><th> nick_name </th><th> badness </th><th> hangout </th><th> organization </th></tr></thead><tbody><tr><td> 0 </td><td> Yojimbo </td><td> Bodyguard </td><td> 7 </td><td> 0 </td><td> Yakuza </td></tr><tr><td> 1 </td><td> Takeshi </td><td> Master </td><td> 10 </td><td> 1 </td><td> Yakuza </td></tr><tr><td> 2 </td><td> Yuriko </td><td> Four finger </td><td> 4 </td><td> 2 </td><td> Yakuza </td></tr><tr><td> 3 </td><td> Chow </td><td> Killer </td><td> 9 </td><td> 3 </td><td> Triads </td></tr><tr><td> 4 </td><td> Shogi </td><td> Lightning </td><td> 8 </td><td> 4 </td><td> Triads </td></tr><tr><td> 5 </td><td> Valentino </td><td> Pizza-Face </td><td> 4 </td><td> 5 </td><td> Mafia </td></tr><tr><td> 6 </td><td> Toni </td><td> Toothless </td><td> 2 </td><td> 6 </td><td> Mafia </td></tr><tr><td> 7 </td><td> Corleone </td><td> Godfather </td><td> 6 </td><td> 7 </td><td> Mafia </td></tr></tbody></table></div></div><div class="para">
					The <code class="literal">read-ahead</code> strategy and <code class="literal">load-group</code> for a query is defined in the <code class="literal">query</code> element. If a <code class="literal">read-ahead</code> strategy is not declared in the <code class="literal">query</code> element, the strategy declared in the <code class="literal">entity</code> element or <code class="literal">defaults</code> element is used. The <code class="literal">on-find</code> configuration follows:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!--...--&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findAll_onfind<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-params/&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;jboss-ql&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span>
<span xmlns="" class="line">​</span>                 SELECT OBJECT(g)
<span xmlns="" class="line">​</span>                 FROM gangster g
<span xmlns="" class="line">​</span>                 ORDER BY g.gangsterId
<span xmlns="" class="line">​</span>                 <span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/jboss-ql&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;read-ahead&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;strategy&gt;</span>on-find<span xmlns="" class="perl_Keyword">&lt;/strategy&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;page-size&gt;</span>4<span xmlns="" class="perl_Keyword">&lt;/page-size&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;eager-load-group&gt;</span>basic<span xmlns="" class="perl_Keyword">&lt;/eager-load-group&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/read-ahead&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
					One problem with the <code class="literal">on-find</code> strategy is that it must load additional data for every entity selected. Commonly in web applications only a fixed number of results are rendered on a page. Since the preloaded data is only valid for the length of the transaction, and a transaction is limited to a single web HTTP hit, most of the preloaded data is not used. The <code class="literal">on-load</code> strategy discussed in the next section does not suffer from this problem.
				</div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="on_find-Left_join_read_ahead">
      ⁠</a>31.7.3.1.1. Left join read ahead</h4></div></div></div><div class="para">
						Left join read ahead is an enhanced <code class="literal">on-find</code><code class="literal">read-ahead</code> strategy. It allows you to preload in one SQL query not only fields from the base instance but also related instances which can be reached from the base instance by CMR navigation. There are no limitation for the depth of CMR navigations. There are also no limitations for cardinality of CMR fields used in navigation and relationship type mapping, i.e. both foreign key and relation-table mapping styles are supported. Let us look at some examples. Entity and relationship declarations can be found below.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="on_find-DfindByPrimaryKey">
      ⁠</a>31.7.3.1.2. D#findByPrimaryKey</h4></div></div></div><div class="para">
						Suppose we have an entity <code class="literal">D</code>. A typical SQL query generated for the <code class="literal">findByPrimaryKey</code> would look like this:
					</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> t0_D.<span xmlns="" class="perl_Keyword">id</span>, t0_D.name <span xmlns="" class="perl_Keyword">FROM</span> D t0_D <span xmlns="" class="perl_Keyword">WHERE</span> t0_D.<span xmlns="" class="perl_Keyword">id</span>=?</pre><div class="para">
						Suppose that while executing <code class="literal">findByPrimaryKey</code> we also want to preload two collection-valued CMR fields <code class="literal">bs</code> and <code class="literal">cs</code>.
					</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findByPrimaryKey<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;method-params&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;method-param&gt;</span>java.lang.Long<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/method-params&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;jboss-ql&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span>SELECT OBJECT(o) FROM D AS o WHERE o.id = ?1<span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/jboss-ql&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;read-ahead&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;strategy&gt;</span>on-find<span xmlns="" class="perl_Keyword">&lt;/strategy&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;page-size&gt;</span>4<span xmlns="" class="perl_Keyword">&lt;/page-size&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;eager-load-group&gt;</span>basic<span xmlns="" class="perl_Keyword">&lt;/eager-load-group&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;left-join</span><span xmlns="" class="perl_Others"> cmr-field=</span><span xmlns="" class="perl_String">"bs"</span><span xmlns="" class="perl_Others"> eager-load-group=</span><span xmlns="" class="perl_String">"basic"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;left-join</span><span xmlns="" class="perl_Others"> cmr-field=</span><span xmlns="" class="perl_String">"cs"</span><span xmlns="" class="perl_Others"> eager-load-group=</span><span xmlns="" class="perl_String">"basic"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/read-ahead&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
</pre><div class="para">
						The <code class="literal">left-join</code> declares the relations to be eager loaded. The generated SQL would look like this:
					</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> t0_D.<span xmlns="" class="perl_Keyword">id</span>, t0_D.name,
<span xmlns="" class="line">​</span>       t1_D_bs.<span xmlns="" class="perl_Keyword">id</span>, t1_D_bs.name,
<span xmlns="" class="line">​</span>       t2_D_cs.<span xmlns="" class="perl_Keyword">id</span>, t2_D_cs.name
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> D t0_D
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">LEFT</span> <span xmlns="" class="perl_Keyword">OUTER</span> <span xmlns="" class="perl_Keyword">JOIN</span> B t1_D_bs <span xmlns="" class="perl_Keyword">ON</span> t0_D.<span xmlns="" class="perl_Keyword">id</span>=t1_D_bs.D_FK
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">LEFT</span> <span xmlns="" class="perl_Keyword">OUTER</span> <span xmlns="" class="perl_Keyword">JOIN</span> C t2_D_cs <span xmlns="" class="perl_Keyword">ON</span> t0_D.<span xmlns="" class="perl_Keyword">id</span>=t2_D_cs.D_FK
<span xmlns="" class="line">​</span> <span xmlns="" class="perl_Keyword">WHERE</span> t0_D.<span xmlns="" class="perl_Keyword">id</span>=?
</pre><div class="para">
						For the <code class="literal">D</code> with the specific id we preload all its related <code class="literal">B</code>'s and <code class="literal">C</code>'s and can access those instance loading them from the read ahead cache, not from the database.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="on_find-DfindAll">
      ⁠</a>31.7.3.1.3. D#findAll</h4></div></div></div><div class="para">
						In the same way, we could optimize the <code class="literal">findAll</code> method on <code class="literal">D</code> selects all the <code class="literal">D</code>'s. A normal findAll query would look like this:
					</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> <span xmlns="" class="perl_Keyword">DISTINCT</span> t0_o.<span xmlns="" class="perl_Keyword">id</span>, t0_o.name <span xmlns="" class="perl_Keyword">FROM</span> D t0_o <span xmlns="" class="perl_Keyword">ORDER</span> <span xmlns="" class="perl_Keyword">BY</span> t0_o.<span xmlns="" class="perl_Keyword">id</span> <span xmlns="" class="perl_Keyword">DESC</span></pre><div class="para">
						To preload the relations, we simply need to add the <code class="literal">left-join</code> elements to the query.
					</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findAll<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;jboss-ql&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span>SELECT DISTINCT OBJECT(o) FROM D AS o ORDER BY o.id DESC<span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/jboss-ql&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;read-ahead&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;strategy&gt;</span>on-find<span xmlns="" class="perl_Keyword">&lt;/strategy&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;page-size&gt;</span>4<span xmlns="" class="perl_Keyword">&lt;/page-size&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;eager-load-group&gt;</span>basic<span xmlns="" class="perl_Keyword">&lt;/eager-load-group&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;left-join</span><span xmlns="" class="perl_Others"> cmr-field=</span><span xmlns="" class="perl_String">"bs"</span><span xmlns="" class="perl_Others"> eager-load-group=</span><span xmlns="" class="perl_String">"basic"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;left-join</span><span xmlns="" class="perl_Others"> cmr-field=</span><span xmlns="" class="perl_String">"cs"</span><span xmlns="" class="perl_Others"> eager-load-group=</span><span xmlns="" class="perl_String">"basic"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/read-ahead&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
</pre><div class="para">
						And here is the generated SQL:
					</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> <span xmlns="" class="perl_Keyword">DISTINCT</span> t0_o.<span xmlns="" class="perl_Keyword">id</span>, t0_o.name,
<span xmlns="" class="line">​</span>                t1_o_bs.<span xmlns="" class="perl_Keyword">id</span>, t1_o_bs.name,
<span xmlns="" class="line">​</span>                t2_o_cs.<span xmlns="" class="perl_Keyword">id</span>, t2_o_cs.name
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> D t0_o
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">LEFT</span> <span xmlns="" class="perl_Keyword">OUTER</span> <span xmlns="" class="perl_Keyword">JOIN</span> B t1_o_bs <span xmlns="" class="perl_Keyword">ON</span> t0_o.<span xmlns="" class="perl_Keyword">id</span>=t1_o_bs.D_FK
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">LEFT</span> <span xmlns="" class="perl_Keyword">OUTER</span> <span xmlns="" class="perl_Keyword">JOIN</span> C t2_o_cs <span xmlns="" class="perl_Keyword">ON</span> t0_o.<span xmlns="" class="perl_Keyword">id</span>=t2_o_cs.D_FK
<span xmlns="" class="line">​</span> <span xmlns="" class="perl_Keyword">ORDER</span> <span xmlns="" class="perl_Keyword">BY</span> t0_o.<span xmlns="" class="perl_Keyword">id</span> <span xmlns="" class="perl_Keyword">DESC</span>
</pre><div class="para">
						Now the simple <code class="literal">findAll</code> query now preloads the related <code class="literal">B</code> and <code class="literal">C</code> objects for each <code class="literal">D</code> object.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="on_find-AfindAll">
      ⁠</a>31.7.3.1.4. A#findAll</h4></div></div></div><div class="para">
						Now let us look at a more complex configuration. Here we want to preload instance <code class="literal">A</code> along with several relations.
					</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
								its parent (self-relation) reached from <code class="literal">A</code> with CMR field <code class="literal">parent</code>
							</div></li><li class="listitem"><div class="para">
								the <code class="literal">B</code> reached from <code class="literal">A</code> with CMR field <code class="literal">b</code>, and the related <code class="literal">C</code> reached from <code class="literal">B</code> with CMR field <code class="literal">c</code>
							</div></li><li class="listitem"><div class="para">
								<code class="literal">B</code> reached from <code class="literal">A</code> but this time with CMR field <code class="literal">b2</code> and related to it <code class="literal">C</code> reached from B with CMR field c.
							</div></li></ul></div><div class="para">
						For reference, the standard query would be:
					</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> t0_o.<span xmlns="" class="perl_Keyword">id</span>, t0_o.name <span xmlns="" class="perl_Keyword">FROM</span> A t0_o <span xmlns="" class="perl_Keyword">ORDER</span> <span xmlns="" class="perl_Keyword">BY</span> t0_o.<span xmlns="" class="perl_Keyword">id</span> <span xmlns="" class="perl_Keyword">DESC</span> <span xmlns="" class="perl_Keyword">FOR</span> <span xmlns="" class="perl_Keyword">UPDATE</span></pre><div class="para">
						The following metadata describes our preloading plan.
					</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findAll<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;jboss-ql&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span>SELECT OBJECT(o) FROM A AS o ORDER BY o.id DESC<span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/jboss-ql&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;read-ahead&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;strategy&gt;</span>on-find<span xmlns="" class="perl_Keyword">&lt;/strategy&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;page-size&gt;</span>4<span xmlns="" class="perl_Keyword">&lt;/page-size&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;eager-load-group&gt;</span>basic<span xmlns="" class="perl_Keyword">&lt;/eager-load-group&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;left-join</span><span xmlns="" class="perl_Others"> cmr-field=</span><span xmlns="" class="perl_String">"parent"</span><span xmlns="" class="perl_Others"> eager-load-group=</span><span xmlns="" class="perl_String">"basic"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;left-join</span><span xmlns="" class="perl_Others"> cmr-field=</span><span xmlns="" class="perl_String">"b"</span><span xmlns="" class="perl_Others"> eager-load-group=</span><span xmlns="" class="perl_String">"basic"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;left-join</span><span xmlns="" class="perl_Others"> cmr-field=</span><span xmlns="" class="perl_String">"c"</span><span xmlns="" class="perl_Others"> eager-load-group=</span><span xmlns="" class="perl_String">"basic"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/left-join&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;left-join</span><span xmlns="" class="perl_Others"> cmr-field=</span><span xmlns="" class="perl_String">"b2"</span><span xmlns="" class="perl_Others"> eager-load-group=</span><span xmlns="" class="perl_String">"basic"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;left-join</span><span xmlns="" class="perl_Others"> cmr-field=</span><span xmlns="" class="perl_String">"c"</span><span xmlns="" class="perl_Others"> eager-load-group=</span><span xmlns="" class="perl_String">"basic"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/left-join&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/read-ahead&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
</pre><div class="para">
						The SQL query generated would be:
					</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> t0_o.<span xmlns="" class="perl_Keyword">id</span>, t0_o.name,
<span xmlns="" class="line">​</span>       t1_o_parent.<span xmlns="" class="perl_Keyword">id</span>, t1_o_parent.name,
<span xmlns="" class="line">​</span>       t2_o_b.<span xmlns="" class="perl_Keyword">id</span>, t2_o_b.name,
<span xmlns="" class="line">​</span>       t3_o_b_c.<span xmlns="" class="perl_Keyword">id</span>, t3_o_b_c.name,
<span xmlns="" class="line">​</span>       t4_o_b2.<span xmlns="" class="perl_Keyword">id</span>, t4_o_b2.name,
<span xmlns="" class="line">​</span>       t5_o_b2_c.<span xmlns="" class="perl_Keyword">id</span>, t5_o_b2_c.name
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> A t0_o
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">LEFT</span> <span xmlns="" class="perl_Keyword">OUTER</span> <span xmlns="" class="perl_Keyword">JOIN</span> A t1_o_parent <span xmlns="" class="perl_Keyword">ON</span> t0_o.<span xmlns="" class="perl_Keyword">PARENT</span>=t1_o_parent.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">LEFT</span> <span xmlns="" class="perl_Keyword">OUTER</span> <span xmlns="" class="perl_Keyword">JOIN</span> B t2_o_b <span xmlns="" class="perl_Keyword">ON</span> t0_o.B_FK=t2_o_b.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">LEFT</span> <span xmlns="" class="perl_Keyword">OUTER</span> <span xmlns="" class="perl_Keyword">JOIN</span> C t3_o_b_c <span xmlns="" class="perl_Keyword">ON</span> t2_o_b.C_FK=t3_o_b_c.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">LEFT</span> <span xmlns="" class="perl_Keyword">OUTER</span> <span xmlns="" class="perl_Keyword">JOIN</span> B t4_o_b2 <span xmlns="" class="perl_Keyword">ON</span> t0_o.B2_FK=t4_o_b2.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">LEFT</span> <span xmlns="" class="perl_Keyword">OUTER</span> <span xmlns="" class="perl_Keyword">JOIN</span> C t5_o_b2_c <span xmlns="" class="perl_Keyword">ON</span> t4_o_b2.C_FK=t5_o_b2_c.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span> <span xmlns="" class="perl_Keyword">ORDER</span> <span xmlns="" class="perl_Keyword">BY</span> t0_o.<span xmlns="" class="perl_Keyword">id</span> <span xmlns="" class="perl_Keyword">DESC</span> <span xmlns="" class="perl_Keyword">FOR</span> <span xmlns="" class="perl_Keyword">UPDATE</span>
</pre><div class="para">
						With this configuration, you can navigate CMRs from any found instance of <code class="literal">A</code> without an additional database load.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="on_find-AfindMeParentGrandParent">
      ⁠</a>31.7.3.1.5. A#findMeParentGrandParent</h4></div></div></div><div class="para">
						Here is another example of self-relation. Suppose, we want to write a method that would preload an instance, its parent, grand-parent and its grand-grand-parent in one query. To do this, we would used nested <code class="literal">left-join</code> declaration.
					</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findMeParentGrandParent<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;method-params&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;method-param&gt;</span>java.lang.Long<span xmlns="" class="perl_Keyword">&lt;/method-param&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/method-params&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;jboss-ql&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span>SELECT OBJECT(o) FROM A AS o WHERE o.id = ?1<span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/jboss-ql&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;read-ahead&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;strategy&gt;</span>on-find<span xmlns="" class="perl_Keyword">&lt;/strategy&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;page-size&gt;</span>4<span xmlns="" class="perl_Keyword">&lt;/page-size&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;eager-load-group&gt;</span>*<span xmlns="" class="perl_Keyword">&lt;/eager-load-group&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;left-join</span><span xmlns="" class="perl_Others"> cmr-field=</span><span xmlns="" class="perl_String">"parent"</span><span xmlns="" class="perl_Others"> eager-load-group=</span><span xmlns="" class="perl_String">"basic"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;left-join</span><span xmlns="" class="perl_Others"> cmr-field=</span><span xmlns="" class="perl_String">"parent"</span><span xmlns="" class="perl_Others"> eager-load-group=</span><span xmlns="" class="perl_String">"basic"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;left-join</span><span xmlns="" class="perl_Others"> cmr-field=</span><span xmlns="" class="perl_String">"parent"</span><span xmlns="" class="perl_Others"> eager-load-group=</span><span xmlns="" class="perl_String">"basic"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/left-join&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/left-join&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/read-ahead&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
</pre><div class="para">
						The generated SQL would be:
					</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> t0_o.<span xmlns="" class="perl_Keyword">id</span>, t0_o.name, t0_o.secondName, t0_o.B_FK, t0_o.B2_FK, t0_o.<span xmlns="" class="perl_Keyword">PARENT</span>,
<span xmlns="" class="line">​</span>       t1_o_parent.<span xmlns="" class="perl_Keyword">id</span>, t1_o_parent.name,
<span xmlns="" class="line">​</span>       t2_o_parent_parent.<span xmlns="" class="perl_Keyword">id</span>, t2_o_parent_parent.name,
<span xmlns="" class="line">​</span>       t3_o_parent_parent_parent.<span xmlns="" class="perl_Keyword">id</span>, t3_o_parent_parent_parent.name
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> A t0_o
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">LEFT</span> <span xmlns="" class="perl_Keyword">OUTER</span> <span xmlns="" class="perl_Keyword">JOIN</span> A t1_o_parent <span xmlns="" class="perl_Keyword">ON</span> t0_o.<span xmlns="" class="perl_Keyword">PARENT</span>=t1_o_parent.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">LEFT</span> <span xmlns="" class="perl_Keyword">OUTER</span> <span xmlns="" class="perl_Keyword">JOIN</span> A t2_o_parent_parent <span xmlns="" class="perl_Keyword">ON</span> t1_o_parent.<span xmlns="" class="perl_Keyword">PARENT</span>=t2_o_parent_parent.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">LEFT</span> <span xmlns="" class="perl_Keyword">OUTER</span> <span xmlns="" class="perl_Keyword">JOIN</span> A t3_o_parent_parent_parent 
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">ON</span> t2_o_parent_parent.<span xmlns="" class="perl_Keyword">PARENT</span>=t3_o_parent_parent_parent.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span> <span xmlns="" class="perl_Keyword">WHERE</span> (t0_o.<span xmlns="" class="perl_Keyword">id</span> = ?) <span xmlns="" class="perl_Keyword">FOR</span> <span xmlns="" class="perl_Keyword">UPDATE</span>
</pre><div class="para">
						Note, if we remove <code class="literal">left-join</code> metadata we will have only
					</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> t0_o.<span xmlns="" class="perl_Keyword">id</span>, t0_o.name, t0_o.secondName, t0_o.B2_FK, t0_o.<span xmlns="" class="perl_Keyword">PARENT</span> <span xmlns="" class="perl_Keyword">FOR</span> <span xmlns="" class="perl_Keyword">UPDATE</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Read_ahead-on_load">
      ⁠</a>31.7.3.2. on-load</h3></div></div></div><div class="para">
					The <code class="literal">on-load</code> strategy block-loads additional data for several entities when an entity is loaded, starting with the requested entity and the next several entities in the order they were selected. This strategy is based on theory that the results of a find or select will be accessed in forward order. When a query is executed, JBoss stores the order of the entities found in the list cache. Later, when one of the entities is loaded, JBoss uses this list to determine the block of entities to load. The number of lists stored in the cache is specified with the <code class="literal">list-cachemax</code> element of the entity. This strategy is also used when faulting in data not loaded in the <code class="literal">on-find</code> strategy.
				</div><div class="para">
					As with the <code class="literal">on-find</code> strategy, <code class="literal">on-load</code> is declared in the <code class="literal">read-ahead</code> element. The <code class="literal">on-load</code> configuration for this example is shown below.
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Comment">&lt;!-- ... --&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>          <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findAll_onload<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>          <span xmlns="" class="perl_Keyword">&lt;method-params/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;jboss-ql&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span>
<span xmlns="" class="line">​</span>             SELECT OBJECT(g)
<span xmlns="" class="line">​</span>             FROM gangster g
<span xmlns="" class="line">​</span>             ORDER BY g.gangsterId
<span xmlns="" class="line">​</span>             <span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/jboss-ql&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;read-ahead&gt;</span>
<span xmlns="" class="line">​</span>          <span xmlns="" class="perl_Keyword">&lt;strategy&gt;</span>on-load<span xmlns="" class="perl_Keyword">&lt;/strategy&gt;</span>
<span xmlns="" class="line">​</span>          <span xmlns="" class="perl_Keyword">&lt;page-size&gt;</span>4<span xmlns="" class="perl_Keyword">&lt;/page-size&gt;</span>
<span xmlns="" class="line">​</span>          <span xmlns="" class="perl_Keyword">&lt;eager-load-group&gt;</span>basic<span xmlns="" class="perl_Keyword">&lt;/eager-load-group&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/read-ahead&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
					With this strategy, the query for the finder method in remains unchanged.
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> t0_g.<span xmlns="" class="perl_Keyword">id</span>
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">FROM</span> gangster t0_g
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">ORDER</span> <span xmlns="" class="perl_Keyword">BY</span> t0_g.<span xmlns="" class="perl_Keyword">id</span> <span xmlns="" class="perl_Keyword">ASC</span>
</pre><div class="para">
					However, the data will be loaded differently as we iterate through the result set. For a page size of four, JBoss will only need to execute the following two queries to load the <code class="literal">name</code>, <code class="literal">nickName</code> and <code class="literal">badness</code> fields for the entities:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> <span xmlns="" class="perl_Keyword">id</span>, name, nick_name, badness
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">FROM</span> gangster
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">0</span>) <span xmlns="" class="perl_Keyword">OR</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">1</span>) <span xmlns="" class="perl_Keyword">OR</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">2</span>) <span xmlns="" class="perl_Keyword">OR</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">3</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> <span xmlns="" class="perl_Keyword">id</span>, name, nick_name, badness
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">FROM</span> gangster
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">4</span>) <span xmlns="" class="perl_Keyword">OR</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">5</span>) <span xmlns="" class="perl_Keyword">OR</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">6</span>) <span xmlns="" class="perl_Keyword">OR</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">7</span>)
</pre><div class="para">
					The following table shows the execution of these queries:
				</div><div class="table"><a id="on_load-on_load_Optimized_Query_Execution">
      ⁠</a><p class="title"><strong>Table 31.3. on-load Optimized Query Execution</strong></p><div class="table-contents"><table xmlns:d="http://docbook.org/ns/docbook" class="gt-4-cols gt-7-rows" summary="on-load Optimized Query Execution"><colgroup><col/><col/><col/><col/><col/><col/></colgroup><thead><tr><th> id </th><th> name </th><th> nick_name </th><th> badness </th><th> hangout </th><th> organization </th></tr></thead><tbody><tr><td> 0 </td><td> Yojimbo </td><td> Bodyguard </td><td> 7 </td><td> 0 </td><td> Yakuza </td></tr><tr><td> 1 </td><td> Takeshi </td><td> Master </td><td> 10 </td><td> 1 </td><td> Yakuza </td></tr><tr><td> 2 </td><td> Yuriko </td><td> Four finger </td><td> 4 </td><td> 2 </td><td> Yakuza </td></tr><tr><td> 3 </td><td> Chow </td><td> Killer </td><td> 9 </td><td> 3 </td><td> Triads </td></tr><tr><td> 4 </td><td> Shogi </td><td> Lightning </td><td> 8 </td><td> 4 </td><td> Triads </td></tr><tr><td> 5 </td><td> Valentino </td><td> Pizza-Face </td><td> 4 </td><td> 5 </td><td> Mafia </td></tr><tr><td> 6 </td><td> Toni </td><td> Toothless </td><td> 2 </td><td> 6 </td><td> Mafia </td></tr><tr><td> 7 </td><td> Corleone </td><td> Godfather </td><td> 6 </td><td> 7 </td><td> Mafia </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Read_ahead-none">
      ⁠</a>31.7.3.3. none</h3></div></div></div><div class="para">
					The <code class="literal">none</code> strategy is really an anti-strategy. This strategy causes the system to fall back to the default lazy-load code, and specifically does not read-ahead any data or remember the order of the found entities. This results in the queries and performance shown at the beginning of this chapter. The none strategy is declared with a read-ahead element. If the <code class="literal">read-ahead</code> element contains a <code class="literal">page-size</code> element or <code class="literal">eager-load-group</code>, it is ignored. The none strategy is declared the following example.
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- ... --&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findAll_none<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-params/&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;jboss-ql&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span>
<span xmlns="" class="line">​</span>                 SELECT OBJECT(g)
<span xmlns="" class="line">​</span>                 FROM gangster g
<span xmlns="" class="line">​</span>                 ORDER BY g.gangsterId
<span xmlns="" class="line">​</span>                 <span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/jboss-ql&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;read-ahead&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;strategy&gt;</span>none<span xmlns="" class="perl_Keyword">&lt;/strategy&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/read-ahead&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-Loading_Process">
      ⁠</a>31.8. Loading Process</h1></div></div></div><div class="para">
			In the previous section several steps use the phrase "when the entity is loaded." This was intentionally left vague because the commit option specified for the entity and the current state of the transaction determine when an entity is loaded. The following section describes the commit options and the loading processes.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Loading_Process-Commit_Options">
      ⁠</a>31.8.1. Commit Options</h2></div></div></div><div class="para">
				Central to the loading process are the commit options, which control when the data for an entity expires. JBoss supports four commit options <code class="literal">A</code>, <code class="literal">B</code>, <code class="literal">C</code> and <code class="literal">D</code>. The first three are described in the Enterprise JavaBeans Specification, but the last one is specific to JBoss. A detailed description of each commit option follows:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>A</strong></span>: JBoss assumes it is the sole user of the database; therefore, JBoss can cache the current value of an entity between transactions, which can result is substantial performance gains. As a result of this assumption, no data managed by JBoss can be changed outside of JBoss. For example, changing data in another program or with the use of direct JDBC (even within JBoss) will result in an inconsistent database state.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>B</strong></span>: JBoss assumes that there is more than one user of the database but keeps the context information about entities between transactions. This context information is used for optimizing loading of the entity. This is the default commit option.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>C</strong></span>: JBoss discards all entity context information at the end of the transaction.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>D</strong></span>: This is a JBoss specific commit option. This option is similar to commit option <code class="literal">A</code>, except that the data only remains valid for a specified amount of time.
					</div></li></ul></div><div class="para">
				The commit option is declared in the <code class="literal">jboss.xml</code> file. For a detailed description of this file see <a class="xref" href="EJBs_on_JBoss.html">Chapter 30, <em>EJBs on JBoss</em></a>. The following example changes the commit option to <code class="literal">A</code> for all entity beans in the application:
			</div><div class="example"><a id="Commit_Options-The_jboss.xml_Commit_Option_Declaration">
      ⁠</a><p class="title"><strong>Example 31.2. The jboss.xml Commit Option Declaration</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;container-configurations&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;container-configuration&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;container-name&gt;</span>Standard CMP 2.x EntityBean<span xmlns="" class="perl_Keyword">&lt;/container-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;commit-option&gt;</span>A<span xmlns="" class="perl_Keyword">&lt;/commit-option&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/container-configuration&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/container-configurations&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss&gt;</span>
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Loading_Process-Eager_loading_Process">
      ⁠</a>31.8.2. Eager-loading Process</h2></div></div></div><div class="para">
				When an entity is loaded, JBoss must determine the fields that need to be loaded. By default, JBoss will use the <code class="literal">eager-load-group</code> of the last query that selected this entity. If the entity has not been selected in a query, or the last query used the <code class="literal">none</code> read-ahead strategy, JBoss will use the default <code class="literal">eager-load-group</code> declared for the entity. In the following example configuration, the <code class="literal">basic</code> load group is set as the default <code class="literal">eager-load-group</code> for the gangster entity bean:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- ... --&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;load-groups&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;load-group&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;load-group-name&gt;</span>most<span xmlns="" class="perl_Keyword">&lt;/load-group-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>name<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>nickName<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>badness<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>hangout<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>organization<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/load-group&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/load-groups&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;eager-load-group&gt;</span>most<span xmlns="" class="perl_Keyword">&lt;/eager-load-group&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
				The eager loading process is initiated the first time a method is called on an entity in a transaction. A detailed description of the load process follows:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
						If the entity context is still valid, no loading is necessary, and therefore the loading process is done. The entity context will be valid when using commit option <code class="literal">A</code>, or when using commit option <code class="literal">D</code>, and the data has not timed out.
					</div></li><li class="listitem"><div class="para">
						Any residual data in the entity context is flushed. This assures that old data does not bleed into the new load.
					</div></li><li class="listitem"><div class="para">
						The primary key value is injected back into the primary key fields. The primary key object is actually independent of the fields and needs to be reloaded after the flush in step 2.
					</div></li><li class="listitem"><div class="para">
						All data in the preload cache for this entity is loaded into the fields.
					</div></li><li class="listitem"><div class="para">
						JBoss determines the additional fields that still need to be loaded. Normally the fields to load are determined by the eager-load group of the entity, but can be overridden if the entity was located using a query or CMR field with an <code class="literal">on-find</code> or <code class="literal">on-load</code> read ahead strategy. If all of the fields have already been loaded, the load process skips to step 7.
					</div></li><li class="listitem"><div class="para">
						A query is executed to select the necessary column. If this entity is using the <code class="literal">on-load</code> strategy, a page of data is loaded as described in <a class="xref" href="The_CMP_Engine.html#Read_ahead-on_load">Section 31.7.3.2, “on-load”</a>. The data for the current entity is stored in the context and the data for the other entities is stored in the preload cache.
					</div></li><li class="listitem"><div class="para">
						The <code class="literal">ejbLoad</code> method of the entity is called.
					</div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Loading_Process-Lazy_loading_Process">
      ⁠</a>31.8.3. Lazy loading Process</h2></div></div></div><div class="para">
				Lazy loading is the other half of eager loading. If a field is not eager loaded, it must be lazy loaded. When an access to an unloaded field of a bean is made, JBoss loads the field and all the fields of any <code class="literal">lazy-load-group</code> the field belong to. JBoss performs a set join and then removes any field that is already loaded. An example configuration is shown below.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>GangsterEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- ... --&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;load-groups&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;load-group&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;load-group-name&gt;</span>basic<span xmlns="" class="perl_Keyword">&lt;/load-group-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>name<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>nickName<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>badness<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/load-group&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;load-group&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;load-group-name&gt;</span>contact info<span xmlns="" class="perl_Keyword">&lt;/load-group-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>nickName<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>contactInfo<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>hangout<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/load-group&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/load-groups&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- ... --&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;lazy-load-groups&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;load-group-name&gt;</span>basic<span xmlns="" class="perl_Keyword">&lt;/load-group-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;load-group-name&gt;</span>contact info<span xmlns="" class="perl_Keyword">&lt;/load-group-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/lazy-load-groups&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
				When the bean provider calls <code class="literal">getName()</code> with this configuration, JBoss loads <code class="literal">name</code>, <code class="literal">nickName</code> and <code class="literal">badness</code>, assuming they are not already loaded. When the bean provider calls <code class="literal">getNickName()</code>, the <code class="literal">name</code>, <code class="literal">nickName</code>, <code class="literal">badness</code>, <code class="literal">contactInfo</code>, and <code class="literal">hangout</code> are loaded. A detailed description of the lazy loading process follows:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
						All data in the preload cache for this entity is loaded into the fields.
					</div></li><li class="listitem"><div class="para">
						If the field value was loaded by the preload cache the lazy load process is finished.
					</div></li><li class="listitem"><div class="para">
						JBoss finds all of the lazy load groups that contain this field, performs a set join on the groups, and removes any field that has already been loaded.
					</div></li><li class="listitem"><div class="para">
						A query is executed to select the necessary columns. As in the basic load process, JBoss may load a block of entities. The data for the current entity is stored in the context and the data for the other entities is stored in the preload cache.
					</div></li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Lazy_loading_Process-Relationships">
      ⁠</a>31.8.3.1. Relationships</h3></div></div></div><div class="para">
					Relationships are a special case in lazy loading because a CMR field is both a field and query. As a field it can be <code class="literal">on-load</code> block loaded, meaning the value of the currently sought entity and the values of the CMR field for the next several entities are loaded. As a query, the field values of the related entity can be preloaded using <code class="literal">on-find</code>.
				</div><div class="para">
					Again, the easiest way to investigate the loading is to look at a usage scenario. In this example, an HTML table is generated containing each gangster and their hangout. The example code follows:
				</div><div class="example"><a id="Relationships-Relationship_Lazy_Loading_Example_Code">
      ⁠</a><p class="title"><strong>Example 31.3. Relationship Lazy Loading Example Code</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">createGangsterHangoutHtmlTable</span>() 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">throws</span> FinderException
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    StringBuffer table = <span xmlns="" class="perl_Keyword">new</span> StringBuffer();
<span xmlns="" class="line">​</span>    table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;table&gt;"</span>);
<span xmlns="" class="line">​</span>    Collection gangsters = gangsterHome.<span xmlns="" class="perl_Function">findAll_onfind</span>();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">for</span> (Iterator iter = gangsters.<span xmlns="" class="perl_Function">iterator</span>(); iter.<span xmlns="" class="perl_Function">hasNext</span>(); ) {
<span xmlns="" class="line">​</span>        Gangster gangster = (Gangster)iter.<span xmlns="" class="perl_Function">next</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        Location hangout = gangster.<span xmlns="" class="perl_Function">getHangout</span>();
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;tr&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;td&gt;"</span>).<span xmlns="" class="perl_Function">append</span>(gangster.<span xmlns="" class="perl_Function">getName</span>());
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/td&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;td&gt;"</span>).<span xmlns="" class="perl_Function">append</span>(gangster.<span xmlns="" class="perl_Function">getNickName</span>());
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/td&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;td&gt;"</span>).<span xmlns="" class="perl_Function">append</span>(gangster.<span xmlns="" class="perl_Function">getBadness</span>());
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/td&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;td&gt;"</span>).<span xmlns="" class="perl_Function">append</span>(hangout.<span xmlns="" class="perl_Function">getCity</span>());
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/td&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;td&gt;"</span>).<span xmlns="" class="perl_Function">append</span>(hangout.<span xmlns="" class="perl_Function">getState</span>());
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/td&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;td&gt;"</span>).<span xmlns="" class="perl_Function">append</span>(hangout.<span xmlns="" class="perl_Function">getZipCode</span>());
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/td&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/tr&gt;"</span>);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/table&gt;"</span>);<span xmlns="" class="perl_Keyword">return</span> table.<span xmlns="" class="perl_Function">toString</span>();
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para">
					For this example, the configuration of the gangster's <code class="literal">findAll_onfind</code> query is unchanged from the <code class="literal">on-find</code> section. The configuration of the <code class="literal">Location</code> entity and <code class="literal">Gangster-Hangout</code> relationship follows:
				</div><div class="example"><a id="Relationships-The_jbosscmp_jdbc.xml_Relationship_Lazy_Loading_Configuration">
      ⁠</a><p class="title"><strong>Example 31.4. The jbosscmp-jdbc.xml Relationship Lazy Loading Configuration</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>LocationEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;load-groups&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;load-group&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;load-group-name&gt;</span>quick info<span xmlns="" class="perl_Keyword">&lt;/load-group-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>city<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>state<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>zipCode<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/load-group&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/load-groups&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;eager-load-group/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;relationships&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;ejb-relation&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relation-name&gt;</span>Gangster-Hangout<span xmlns="" class="perl_Keyword">&lt;/ejb-relation-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;foreign-key-mapping/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                    gangster-has-a-hangout
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;key-fields/&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;read-ahead&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;strategy&gt;</span>on-find<span xmlns="" class="perl_Keyword">&lt;/strategy&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;page-size&gt;</span>4<span xmlns="" class="perl_Keyword">&lt;/page-size&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;eager-load-group&gt;</span>quick info<span xmlns="" class="perl_Keyword">&lt;/eager-load-group&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/read-ahead&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                    hangout-for-a-gangster
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;key-fields&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;key-field&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>locationID<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>hangout<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/key-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/key-fields&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/ejb-relationship-role&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/ejb-relation&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/relationships&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre></div></div><div class="para">
					JBoss will execute the following query for the finder:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> t0_g.<span xmlns="" class="perl_Keyword">id</span>, t0_g.name, t0_g.nick_name, t0_g.badness
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">FROM</span> gangster t0_g
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">ORDER</span> <span xmlns="" class="perl_Keyword">BY</span> t0_g.<span xmlns="" class="perl_Keyword">id</span> <span xmlns="" class="perl_Keyword">ASC</span>
</pre><div class="para">
					Then when the hangout is accessed, JBoss executes the following two queries to load the <code class="literal">city</code>, <code class="literal">state</code>, and <code class="literal">zip</code> fields of the hangout:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> gangster.<span xmlns="" class="perl_Keyword">id</span>, gangster.hangout,
<span xmlns="" class="line">​</span>       location.city, location.st, location.zip
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">FROM</span> gangster, location
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">WHERE</span> (gangster.hangout=location.<span xmlns="" class="perl_Keyword">id</span>) <span xmlns="" class="perl_Keyword">AND</span>
<span xmlns="" class="line">​</span>          ((gangster.<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">0</span>) <span xmlns="" class="perl_Keyword">OR</span> (gangster.<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">1</span>) <span xmlns="" class="perl_Keyword">OR</span>
<span xmlns="" class="line">​</span>          (gangster.<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">2</span>) <span xmlns="" class="perl_Keyword">OR</span> (gangster.<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">3</span>))
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> gangster.<span xmlns="" class="perl_Keyword">id</span>, gangster.hangout,
<span xmlns="" class="line">​</span>       location.city, location.st, location.zip
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">FROM</span> gangster, location
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">WHERE</span> (gangster.hangout=location.<span xmlns="" class="perl_Keyword">id</span>) <span xmlns="" class="perl_Keyword">AND</span>
<span xmlns="" class="line">​</span>          ((gangster.<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">4</span>) <span xmlns="" class="perl_Keyword">OR</span> (gangster.<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">5</span>) <span xmlns="" class="perl_Keyword">OR</span>
<span xmlns="" class="line">​</span>          (gangster.<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">6</span>) <span xmlns="" class="perl_Keyword">OR</span> (gangster.<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">7</span>))
</pre><div class="para">
					The following table shows the execution of the queries:
				</div><div class="table"><a id="Relationships-on_find_Optimized_Relationship_Query_Execution">
      ⁠</a><p class="title"><strong>Table 31.4. on-find Optimized Relationship Query Execution</strong></p><div class="table-contents"><table xmlns:d="http://docbook.org/ns/docbook" class="gt-8-cols gt-7-rows" summary="on-find Optimized Relationship Query Execution"><colgroup><col width="11%" class="c1"/><col width="11%" class="c2"/><col width="11%" class="c3"/><col width="11%"/><col width="11%"/><col width="11%"/><col width="11%"/><col width="11%"/><col width="11%"/></colgroup><thead><tr><th> id </th><th> name </th><th> nick_name </th><th> badness </th><th> hangout </th><th> id </th><th> city </th><th> st </th><th> zip </th></tr></thead><tbody><tr><td> 0 </td><td> Yojimbo </td><td> Bodyguard </td><td> 7 </td><td> 0 </td><td> 0 </td><td> San Fran </td><td> CA </td><td> 94108 </td></tr><tr><td> 1 </td><td> Takeshi </td><td> Master </td><td> 10 </td><td> 1 </td><td> 1 </td><td> San Fran </td><td> CA </td><td> 94133 </td></tr><tr><td> 2 </td><td> Yuriko </td><td> Four finger </td><td> 4 </td><td> 2 </td><td> 2 </td><td> San Fran </td><td> CA </td><td> 94133 </td></tr><tr><td> 3 </td><td> Chow </td><td> Killer </td><td> 9 </td><td> 3 </td><td> 3 </td><td> San Fran </td><td> CA </td><td> 94133 </td></tr><tr><td> 4 </td><td> Shogi </td><td> Lightning </td><td> 8 </td><td> 4 </td><td> 4 </td><td> San Fran </td><td> CA </td><td> 94133 </td></tr><tr><td> 5 </td><td> Valentino </td><td> Pizza-Face </td><td> 4 </td><td> 5 </td><td> 5 </td><td> New York </td><td> NY </td><td> 10017 </td></tr><tr><td> 6 </td><td> Toni </td><td> Toothless </td><td> 2 </td><td> 6 </td><td> 6 </td><td> Chicago </td><td> IL </td><td> 60661 </td></tr><tr><td> 7 </td><td> Corleone </td><td> Godfather </td><td> 6 </td><td> 7 </td><td> 7 </td><td> Las Vegas </td><td> NV </td><td> 89109 </td></tr></tbody></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Loading_Process-Lazy_loading_result_sets">
      ⁠</a>31.8.4. Lazy loading result sets</h2></div></div></div><div class="para">
				By default, when a multi-object finder or select method is executed the JDBC result set is read to the end immediately. The client receives a collection of <code class="literal">EJBLocalObject</code> or CMP field values which it can then iterate through. For big result sets this approach is not efficient. In some cases it is better to delay reading the next row in the result set until the client tries to read the corresponding value from the collection. You can get this behavior for a query using the <code class="literal">lazy-resultset-loading</code> element.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;query&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;query-method&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>findAll<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/query-method&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;jboss-ql&gt;</span><span xmlns="" class="perl_BaseN">&lt;![CDATA[</span>select object(o) from A o<span xmlns="" class="perl_BaseN">]]&gt;</span><span xmlns="" class="perl_Keyword">&lt;/jboss-ql&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;lazy-resultset-loading&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/lazy-resultset-loading&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/query&gt;</span>
</pre><div class="para">
				The are some issues you should be aware of when using lazy result set loading. Special care should be taken when working with a <code class="literal">Collection</code> associated with a lazily loaded result set. The first call to <code class="literal">iterator()</code> returns a special <code class="literal">Iterator</code> that reads from the <code class="literal">ResultSet</code>. Until this <code class="literal">Iterator</code> has been exhausted, subsequent calls to <code class="literal">iterator()</code> or calls to the <code class="literal">add()</code> method will result in an exception. The <code class="literal">remove()</code> and <code class="literal">size()</code> methods work as would be expected.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-Transactions">
      ⁠</a>31.9. Transactions</h1></div></div></div><div class="para">
			All of the examples presented in this chapter have been defined to run in a transaction. Transaction granularity is a dominating factor in optimized loading because transactions define the lifetime of preloaded data. If the transaction completes, commits, or rolls back, the data in the preload cache is lost. This can result in a severe negative performance impact.
		</div><div class="para">
			The performance impact of running without a transaction will be demonstrated with an example that uses an <code class="literal">on-find</code> optimized query that selects the first four gangsters (to keep the result set small), and it is executed without a wrapper transaction. The example code follows:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">createGangsterHtmlTable_no_tx</span>() <span xmlns="" class="perl_Keyword">throws</span> FinderException
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    StringBuffer table = <span xmlns="" class="perl_Keyword">new</span> StringBuffer();
<span xmlns="" class="line">​</span>    table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;table&gt;"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    Collection gangsters = gangsterHome.<span xmlns="" class="perl_Function">findFour</span>();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">for</span>(Iterator iter = gangsters.<span xmlns="" class="perl_Function">iterator</span>(); iter.<span xmlns="" class="perl_Function">hasNext</span>(); ) {
<span xmlns="" class="line">​</span>        Gangster gangster = (Gangster)iter.<span xmlns="" class="perl_Function">next</span>();
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;tr&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;td&gt;"</span>).<span xmlns="" class="perl_Function">append</span>(gangster.<span xmlns="" class="perl_Function">getName</span>());
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/td&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;td&gt;"</span>).<span xmlns="" class="perl_Function">append</span>(gangster.<span xmlns="" class="perl_Function">getNickName</span>());
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/td&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;td&gt;"</span>).<span xmlns="" class="perl_Function">append</span>(gangster.<span xmlns="" class="perl_Function">getBadness</span>());
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/td&gt;"</span>);
<span xmlns="" class="line">​</span>        table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/tr&gt;"</span>);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    table.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"&lt;/table&gt;"</span>);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">return</span> table.<span xmlns="" class="perl_Function">toString</span>();
<span xmlns="" class="line">​</span>}
</pre><div class="para">
			The finder results in the following query being executed:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> t0_g.<span xmlns="" class="perl_Keyword">id</span>, t0_g.name, t0_g.nick_name, t0_g.badness
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster t0_g
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">WHERE</span> t0_g.<span xmlns="" class="perl_Keyword">id</span> &lt; <span xmlns="" class="perl_Float">4</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">ORDER</span> <span xmlns="" class="perl_Keyword">BY</span> t0_g.<span xmlns="" class="perl_Keyword">id</span> <span xmlns="" class="perl_Keyword">ASC</span>
</pre><div class="para">
			Normally this would be the only query executed, but since this code is not running in a transaction, all of the preloaded data is thrown away as soon as finder returns. Then when the CMP field is accessed JBoss executes the following four queries (one for each loop):
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> <span xmlns="" class="perl_Keyword">id</span>, name, nick_name, badness
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">0</span>) <span xmlns="" class="perl_Keyword">OR</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">1</span>) <span xmlns="" class="perl_Keyword">OR</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">2</span>) <span xmlns="" class="perl_Keyword">OR</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">3</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> <span xmlns="" class="perl_Keyword">id</span>, name, nick_name, badness
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">1</span>) <span xmlns="" class="perl_Keyword">OR</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">2</span>) <span xmlns="" class="perl_Keyword">OR</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">3</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> <span xmlns="" class="perl_Keyword">id</span>, name, nick_name, badness
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">2</span>) <span xmlns="" class="perl_Keyword">OR</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">3</span>)
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">SELECT</span> name, nick_name, badness
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">FROM</span> gangster
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">WHERE</span> (<span xmlns="" class="perl_Keyword">id</span>=<span xmlns="" class="perl_Float">3</span>)
</pre><div class="para">
			It is actually worse than this. JBoss executes each of these queries three times; once for each CMP field that is accessed. This is because the preloaded values are discarded between the CMP field accessor calls.
		</div><div class="para">
			The following figure shows the execution of the queries:
		</div><div class="figure"><a id="Transactions-No_Transaction_on_find_optimized_query_execution">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/Chap11-16.png" align="middle" alt="No Transaction on-find optimized query execution" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.13. No Transaction on-find optimized query execution</strong></p></div><div class="para">
			This performance is much worse than <span class="emphasis"><em>read ahead none</em></span> because of the amount of data loaded from the database. The number of rows loaded is determined by the following equation:
		</div><div class="example"><a id="idm139776752422672">
      ⁠</a><p class="title"><strong>Example 31.5. </strong></p><div class="example-contents"><div class="informalequation"><span class="mathphrase">n + n - 1 + n - 2 + ... + 1 + = ((n · (n+1)) / 2) = O(n<sup>2</sup>)</span></div></div></div><div class="para">
			This all happens because the transaction in the example is bounded by a single call on the entity. This brings up the important question "How do I run my code in a transaction?" The answer depends on where the code runs. If it runs in an EJB (session, entity, or message driven), the method must be marked with the <code class="literal">Required</code> or <code class="literal">RequiresNew</code><code class="literal">trans-attribute</code> in the <code class="literal">assembly-descriptor</code>. If the code is not running in an EJB, a user transaction is necessary. The following code wraps a call to the declared method with a user transaction:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> String <span xmlns="" class="perl_Function">createGangsterHtmlTable_with_tx</span>()
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">throws</span> FinderException
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    UserTransaction tx = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>        InitialContext ctx = <span xmlns="" class="perl_Keyword">new</span> InitialContext();
<span xmlns="" class="line">​</span>        tx = (UserTransaction) ctx.<span xmlns="" class="perl_Function">lookup</span>(<span xmlns="" class="perl_String">"UserTransaction"</span>);
<span xmlns="" class="line">​</span>        tx.<span xmlns="" class="perl_Function">begin</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        String table = <span xmlns="" class="perl_Function">createGangsterHtmlTable_no_tx</span>();
<span xmlns="" class="line">​</span>	
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> (tx.<span xmlns="" class="perl_Function">getStatus</span>() == Status.<span xmlns="" class="perl_Function">STATUS_ACTIVE</span>) {
<span xmlns="" class="line">​</span>	        tx.<span xmlns="" class="perl_Function">commit</span>();
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">return</span> table;
<span xmlns="" class="line">​</span>    } <span xmlns="" class="perl_Keyword">catch</span> (Exception e) {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">if</span> (tx != <span xmlns="" class="perl_Keyword">null</span>) tx.<span xmlns="" class="perl_Function">rollback</span>();
<span xmlns="" class="line">​</span>        } <span xmlns="" class="perl_Keyword">catch</span> (SystemException unused) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">// eat the exception we are exceptioning out anyway</span>
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> (e <span xmlns="" class="perl_Keyword">instanceof</span> FinderException) {
<span xmlns="" class="line">​</span>	        <span xmlns="" class="perl_Keyword">throw</span> (FinderException) e;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> (e <span xmlns="" class="perl_Keyword">instanceof</span> RuntimeException) {
<span xmlns="" class="line">​</span>	        <span xmlns="" class="perl_Keyword">throw</span> (RuntimeException) e;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">EJBException</span>(e);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
</pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-Optimistic_Locking">
      ⁠</a>31.10. Optimistic Locking</h1></div></div></div><div class="para">
			JBoss has supports for optimistic locking of entity beans. Optimistic locking allows multiple instances of the same entity bean to be active simultaneously. Consistency is enforced based on the optimistic locking policy choice. The optimistic locking policy choice defines the set of fields that are used in the commit time write of modified data to the database. The optimistic consistency check asserts that the values of the chosen set of fields has the same values in the database as existed when the current transaction was started. This is done using a <code class="literal">select for UPDATE WHERE ...</code> statement that contains the value assertions.
		</div><div class="para">
			You specify the optimistic locking policy choice using an <code class="literal">optimistic-locking</code> element in the <code class="literal">jbosscmp-jdbc.xml</code> descriptor. The content model of the <code class="literal">optimistic-locking</code> element is shown below and the description of the elements follows.
		</div><div class="figure"><a id="Optimistic_Locking-The_jbosscmp_jdbc_optimistic_locking_element_content_model">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_optimistic-locking.png" align="middle" alt="The jbosscmp-jdbc optimistic-locking element content model" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.14. The jbosscmp-jdbc optimistic-locking element content model</strong></p></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					<span class="bold bold"><strong>group-name</strong></span>: This element specifies that optimistic locking is based on the fields of a <code class="literal">load-group</code>. This value of this element must match one of the entity's <code class="literal">load-group-name</code>. The fields in this group will be used for optimistic locking.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>modified-strategy</strong></span>: This element specifies that optimistic locking is based on the modified fields. This strategy implies that the fields that were modified during transaction will be used for optimistic locking.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>read-strategy</strong></span>: This element specifies that optimistic locking is based on the fields read. This strategy implies that the fields that were read/changed in the transaction will be used for optimistic locking.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>version-column</strong></span>: This element specifies that optimistic locking is based on a version column strategy. Specifying this element will add an additional version field of type <code class="literal">java.lang.Long</code> to the entity bean for optimistic locking. Each update of the entity will increase the value of this field. The <code class="literal">field-name</code> element allows for the specification of the name of the CMP field while the <code class="literal">column-name</code> element allows for the specification of the corresponding table column.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>timestamp-column</strong></span>: This element specifies that optimistic locking is based on a timestamp column strategy. Specifying this element will add an additional version field of type <code class="literal">java.util.Date</code> to the entity bean for optimistic locking. Each update of the entity will set the value of this field to the current time. The <code class="literal">field-name</code> element allows for the specification of the name of the CMP field while the <code class="literal">column-name</code> element allows for the specification of the corresponding table column.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>key-generator-factory</strong></span>: This element specifies that optimistic locking is based on key generation. The value of the element is the JNDI name of a <code class="literal">org.jboss.ejb.plugins.keygenerator.KeyGeneratorFactory</code> implementation. Specifying this element will add an additional version field to the entity bean for optimistic locking. The type of the field must be specified via the <code class="literal">field-type</code> element. Each update of the entity will update the key field by obtaining a new value from the key generator. The <code class="literal">field-name</code> element allows for the specification of the name of the CMP field while the <code class="literal">column-name</code> element allows for the specification of the corresponding table column.
				</div></li></ul></div><div class="para">
			A sample <code class="literal">jbosscmp-jdbc.xml</code> descriptor illustrating all of the optimistic locking strategies is given below.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_DataType">&lt;!DOCTYPE </span>jbosscmp-jdbc PUBLIC 
<span xmlns="" class="line">​</span>    "-//JBoss//DTD JBOSSCMP-JDBC 3.2//EN"
<span xmlns="" class="line">​</span>    "http://www.jboss.org/j2ee/dtd/jbosscmp-jdbc_3_2.dtd"<span xmlns="" class="perl_DataType">&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;defaults&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;datasource&gt;</span>java:/DefaultDS<span xmlns="" class="perl_Keyword">&lt;/datasource&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;datasource-mapping&gt;</span>Hypersonic SQL<span xmlns="" class="perl_Keyword">&lt;/datasource-mapping&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/defaults&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>EntityGroupLocking<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;create-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/create-table&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;remove-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/remove-table&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;table-name&gt;</span>entitygrouplocking<span xmlns="" class="perl_Keyword">&lt;/table-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>dateField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>integerField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>stringField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;load-groups&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;load-group&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;load-group-name&gt;</span>string<span xmlns="" class="perl_Keyword">&lt;/load-group-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>stringField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/load-group&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;load-group&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;load-group-name&gt;</span>all<span xmlns="" class="perl_Keyword">&lt;/load-group-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>stringField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>dateField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/load-group&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/load-groups&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;optimistic-locking&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;group-name&gt;</span>string<span xmlns="" class="perl_Keyword">&lt;/group-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/optimistic-locking&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>EntityModifiedLocking<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;create-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/create-table&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;remove-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/remove-table&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;table-name&gt;</span>entitymodifiedlocking<span xmlns="" class="perl_Keyword">&lt;/table-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>dateField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>integerField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>stringField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;optimistic-locking&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;modified-strategy/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/optimistic-locking&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>EntityReadLocking<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;create-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/create-table&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;remove-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/remove-table&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;table-name&gt;</span>entityreadlocking<span xmlns="" class="perl_Keyword">&lt;/table-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>dateField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>integerField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>stringField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;optimistic-locking&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;read-strategy/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/optimistic-locking&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>EntityVersionLocking<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;create-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/create-table&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;remove-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/remove-table&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;table-name&gt;</span>entityversionlocking<span xmlns="" class="perl_Keyword">&lt;/table-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>dateField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>integerField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>stringField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;optimistic-locking&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;version-column/&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>versionField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>ol_version<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;jdbc-type&gt;</span>INTEGER<span xmlns="" class="perl_Keyword">&lt;/jdbc-type&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;sql-type&gt;</span>INTEGER(5)<span xmlns="" class="perl_Keyword">&lt;/sql-type&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/optimistic-locking&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>EntityTimestampLocking<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;create-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/create-table&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;remove-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/remove-table&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;table-name&gt;</span>entitytimestamplocking<span xmlns="" class="perl_Keyword">&lt;/table-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>dateField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>integerField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>stringField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;optimistic-locking&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;timestamp-column/&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>versionField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>ol_timestamp<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;jdbc-type&gt;</span>TIMESTAMP<span xmlns="" class="perl_Keyword">&lt;/jdbc-type&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;sql-type&gt;</span>DATETIME<span xmlns="" class="perl_Keyword">&lt;/sql-type&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/optimistic-locking&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>EntityKeyGeneratorLocking<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;create-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/create-table&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;remove-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/remove-table&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;table-name&gt;</span>entitykeygenlocking<span xmlns="" class="perl_Keyword">&lt;/table-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>dateField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>integerField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>stringField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;optimistic-locking&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;key-generator-factory&gt;</span>UUIDKeyGeneratorFactory<span xmlns="" class="perl_Keyword">&lt;/key-generator-factory&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-type&gt;</span>java.lang.String<span xmlns="" class="perl_Keyword">&lt;/field-type&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>uuidField<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>ol_uuid<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;jdbc-type&gt;</span>VARCHAR<span xmlns="" class="perl_Keyword">&lt;/jdbc-type&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;sql-type&gt;</span>VARCHAR(32)<span xmlns="" class="perl_Keyword">&lt;/sql-type&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/optimistic-locking&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-Entity_Commands_and_Primary_Key_Generation">
      ⁠</a>31.11. Entity Commands and Primary Key Generation</h1></div></div></div><div class="para">
			Support for primary key generation outside of the entity bean is available through custom implementations of the entity creation command objects used to insert entities into a persistent store. The list of available commands is specified in entity-commands element of the <code class="literal">jbosscmp-jdbc.xml</code> descriptor. The default <code class="literal">entity-command</code> may be specified in the <code class="literal">jbosscmp-jdbc.xml</code> in defaults element. Each entity element can override the <code class="literal">entity-command</code> in defaults by specifying its own <code class="literal">entity-command</code>. The content model of the <code class="literal">entity-commands</code> and child elements is given below.
		</div><div class="figure"><a id="Entity_Commands_and_Primary_Key_Generation-The_jbosscmp_jdbc.xml_entity_commands_element_model">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_entity-commands.png" align="middle" alt="The jbosscmp-jdbc.xml entity-commands element model" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.15. The jbosscmp-jdbc.xml entity-commands element model</strong></p></div><div class="para">
			Each <code class="literal">entity-command</code> element specifies an entity generation implementation. The <code class="literal">name</code> attribute specifies a name that allows the command defined in an <code class="literal">entity-commands</code> section to be referenced in the defaults and entity elements. The <code class="literal">class</code> attribute specifies the implementation of the <code class="literal">org.jboss.ejb.plugins.cmp.jdbc</code>. <code class="literal">JDBCCreateEntityCommand</code> that supports the key generation. Database vendor specific commands typically subclass the <code class="literal">org.jboss.ejb.plugins.cmp.jdbc</code>. <code class="literal">JDBCIdentityColumnCreateCommand</code> if the database generates the primary key as a side effect of doing an insert, or the <code class="literal">org.jboss.ejb.plugins.cmp.jdbc.JDBCInsertPKCreateCommand</code> if the command must insert the generated key.
		</div><div class="para">
			The optional <code class="literal">attribute</code> element(s) allows for the specification of arbitrary name/value property pairs that will be available to the entity command implementation class. The <code class="literal">attribute</code> element has a required <code class="literal">name</code> attribute that specifies the name property, and the <code class="literal">attribute</code> element content is the value of the property. The attribute values are accessible through the <code class="literal">org.jboss.ejb.plugins.cmp.jdbc.metadata.JDBCEntityCommandMetaData.getAttribute</code>(String) method.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Entity_Commands_and_Primary_Key_Generation-Existing_Entity_Commands">
      ⁠</a>31.11.1. Existing Entity Commands</h2></div></div></div><div class="para">
				The following are the current <code class="literal">entity-command</code> definitions found in the <code class="literal">standardjbosscmp-jdbc.xml</code> descriptor:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>default</strong></span>: (<code class="literal">org.jboss.ejb.plugins.cmp.jdbc.JDBCCreateEntityCommand</code>) The <code class="literal">JDBCCreateEntityCommand</code> is the default entity creation as it is the <code class="literal">entity-command</code> referenced in the <code class="literal">standardjbosscmp-jdbc.xml</code> defaults element. This entity-command executes an <code class="literal">INSERT INTO</code> query using the assigned primary key value.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>no-select-before-insert</strong></span>: (<code class="literal">org.jboss.ejb.plugins.cmp.jdbc.JDBCCreateEntityCommand</code>) This is a variation on <code class="literal">default</code> that skips select before insert by specifying an attribute <code class="literal">name="SQLExceptionProcessor"</code> that points to the <code class="literal">jboss.jdbc:service=SQLExceptionProcessor</code> service. The <code class="literal">SQLExceptionProcessor</code> service provides a <code class="literal">boolean isDuplicateKey(SQLException e)</code> operation that allows a for determination of any unique constraint violation.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>pk-sql</strong></span> (<code class="literal">org.jboss.ejb.plugins.cmp.jdbc.keygen.JDBCPkSqlCreateCommand</code>) The <code class="literal">JDBCPkSqlCreateCommand</code> executes an <code class="literal">INSERT INTO</code> query statement provided by the <code class="literal">pk-sql</code> attribute to obtain the next primary key value. Its primary target usage are databases with sequence support.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>mysql-get-generated-keys</strong></span>: (<code class="literal">org.jboss.ejb.plugins.cmp.jdbc.keygen.JDBCMySQLCreateCommand</code>) The <code class="literal">JDBCMySQLCreateCommand</code> executes an <code class="literal">INSERT INTO</code> query using the <code class="literal">getGeneratedKeys</code> method from MySQL native <code class="literal">java.sql.Statement</code> interface implementation to fetch the generated key.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>oracle-sequence</strong></span>: (<code class="literal">org.jboss.ejb.plugins.cmp.jdbc.keygen.JDBCOracleCreateCommand</code>) The <code class="literal">JDBCOracleCreateCommand</code> is a create command for use with Oracle that uses a sequence in conjunction with a <code class="literal">RETURNING</code> clause to generate keys in a single statement. It has a required <code class="literal">sequence</code> element that specifies the name of the sequence column.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>hsqldb-fetch-key</strong></span>: (<code class="literal">org.jboss.ejb.plugins.cmp.jdbc.keygen.JDBCHsqldbCreateCommand</code>) The <code class="literal">JDBCHsqldbCreateCommand</code> executes an <code class="literal">INSERT INTO</code> query after executing a <code class="literal">CALL IDENTITY()</code> statement to fetch the generated key.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>sybase-fetch-key</strong></span>: (<code class="literal">org.jboss.ejb.plugins.cmp.jdbc.keygen.JDBCSybaseCreateCommand</code>) The <code class="literal">JDBCSybaseCreateCommand</code> executes an <code class="literal">INSERT</code> INTO query after executing a <code class="literal">SELECT @@IDENTITY</code> statement to fetch the generated key.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>mssql-fetch-key</strong></span>: (<code class="literal">org.jboss.ejb.plugins.cmp.jdbc.keygen.JDBCSQLServerCreateCommand</code>) The <code class="literal">JDBCSQLServerCreateCommand</code> for Microsoft SQL Server that uses the value from an <code class="literal">IDENTITY</code> columns. By default uses <code class="literal">SELECT SCOPE_IDENTITY()</code> to reduce the impact of triggers; can be overridden with <code class="literal">pk-sql</code> attribute e.g. for V7.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>informix-serial</strong></span>: (<code class="literal">org.jboss.ejb.plugins.cmp.jdbc.keygen.JDBCInformixCreateCommand</code>) The <code class="literal">JDBCInformixCreateCommand</code> executes an <code class="literal">INSERT</code> INTO query after using the <code class="literal">getSerial</code> method from Informix native <code class="literal">java.sql.Statement</code> interface implementation to fetch the generated key.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>postgresql-fetch-seq</strong></span>: (<code class="literal">org.jboss.ejb.plugins.cmp.jdbc.keygen.JDBCPostgreSQLCreateCommand</code>) The <code class="literal">JDBCPostgreSQLCreateCommand</code> for PostgreSQL that fetches the current value of the sequence. The optional <code class="literal">sequence</code> attribute can be used to change the name of the sequence, with the default being <code class="literal">table_pkColumn_seq</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>key-generator</strong></span>: (<code class="literal">org.jboss.ejb.plugins.cmp.jdbc.keygen.JDBCKeyGeneratorCreateCommand</code>) The <code class="literal">JDBCKeyGeneratorCreateCommand</code> executes an <code class="literal">INSERT INTO</code> query after obtaining a value for the primary key from the key generator referenced by the <code class="literal">key-generator-factory</code>. The <code class="literal">key-generator-factory</code> attribute must provide the name of a JNDI binding of the <code class="literal">org.jboss.ejb.plugins.keygenerator.KeyGeneratorFactory</code> implementation.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>get-generated-keys</strong></span>: (org.jboss.ejb.plugins.cmp.jdbc.jdbc3.JDBCGetGeneratedKeysCreateCommand) The <code class="literal">JDBCGetGeneratedKeysCreateCommand</code> executes an <code class="literal">INSERT INTO</code> query using a statement built using the JDBC3 <code class="literal">prepareStatement(String, Statement.RETURN_GENERATED_KEYS)</code> that has the capability to retrieve the auto-generated key. The generated key is obtained by calling the <code class="literal">PreparedStatement.getGeneratedKeys</code> method. Since this requires JDBC3 support it is only available in JDK1.4.1+ with a supporting JDBC driver.
					</div></li></ul></div><div class="para">
				An example configuration using the <code class="literal">hsqldb-fetch-key</code><code class="literal">entity-command</code> with the generated key mapped to a known primary key <code class="literal">cmp-field</code> is shown below.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>LocationEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;pk-constraint&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/pk-constraint&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;table-name&gt;</span>location<span xmlns="" class="perl_Keyword">&lt;/table-name&gt;</span>
<span xmlns="" class="line">​</span>                 
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;cmp-field&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>locationID<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>id<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;auto-increment/&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/cmp-field&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Comment">&lt;!-- ... --&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;entity-command</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"hsqldb-fetch-key"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>                 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="para">
				An alternate example using an unknown primary key without an explicit <code class="literal">cmp-field</code> is shown below.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>LocationEJB<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;pk-constraint&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/pk-constraint&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;table-name&gt;</span>location<span xmlns="" class="perl_Keyword">&lt;/table-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;unknown-pk&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;unknown-pk-class&gt;</span>java.lang.Integer<span xmlns="" class="perl_Keyword">&lt;/unknown-pk-class&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;field-name&gt;</span>locationID<span xmlns="" class="perl_Keyword">&lt;/field-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;column-name&gt;</span>id<span xmlns="" class="perl_Keyword">&lt;/column-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;jdbc-type&gt;</span>INTEGER<span xmlns="" class="perl_Keyword">&lt;/jdbc-type&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;sql-type&gt;</span>INTEGER<span xmlns="" class="perl_Keyword">&lt;/sql-type&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;auto-increment/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/unknown-pk&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!--...--&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;entity-command</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"hsqldb-fetch-key"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-Defaults">
      ⁠</a>31.12. Defaults</h1></div></div></div><div class="para">
			JBoss global defaults are defined in the <code class="literal">standardjbosscmp-jdbc.xml</code> file of the <code class="literal">server/&lt;server-name&gt;/conf/</code> directory. Each application can override the global defaults in the <code class="literal">jbosscmp-jdbc.xml</code> file. The default options are contained in a defaults element of the configuration file, and the content model is shown below.
		</div><div class="figure"><a id="Defaults-The_jbosscmp_jdbc.xml_defaults_content_model">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_defaults.png" align="middle" alt="The jbosscmp-jdbc.xml defaults content model" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.16. The jbosscmp-jdbc.xml defaults content model</strong></p></div><div class="para">
			An example of the defaults section follows:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;defaults&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;datasource&gt;</span>java:/DefaultDS<span xmlns="" class="perl_Keyword">&lt;/datasource&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;datasource-mapping&gt;</span>Hypersonic SQL<span xmlns="" class="perl_Keyword">&lt;/datasource-mapping&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;create-table&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/create-table&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;remove-table&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/remove-table&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;read-only&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/read-only&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;read-time-out&gt;</span>300000<span xmlns="" class="perl_Keyword">&lt;/read-time-out&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;pk-constraint&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/pk-constraint&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;fk-constraint&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/fk-constraint&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;row-locking&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/row-locking&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;preferred-relation-mapping&gt;</span>foreign-key<span xmlns="" class="perl_Keyword">&lt;/preferred-relation-mapping&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;read-ahead&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;strategy&gt;</span>on-load<span xmlns="" class="perl_Keyword">&lt;/strategy&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;page-size&gt;</span>1000<span xmlns="" class="perl_Keyword">&lt;/page-size&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;eager-load-group&gt;</span>*<span xmlns="" class="perl_Keyword">&lt;/eager-load-group&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/read-ahead&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;list-cache-max&gt;</span>1000<span xmlns="" class="perl_Keyword">&lt;/list-cache-max&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/defaults&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Defaults-A_sample_jbosscmp_jdbc.xml_defaults_declaration">
      ⁠</a>31.12.1. A sample jbosscmp-jdbc.xml defaults declaration</h2></div></div></div><div class="para">
				Each option can apply to entities, relationships, or both, and can be overridden in the specific entity or relationship. A detailed description of each option follows:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>datasource</strong></span>: This optional element is the <code class="literal">jndi-name</code> used to look up the datasource. All database connections used by an entity or <code class="literal">relation-table</code> are obtained from the datasource. Having different datasources for entities is not recommended, as it vastly constrains the domain over which finders and ejbSelects can query.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>datasource-mapping</strong></span>: This optional element specifies the name of the <code class="literal">type-mapping</code>, which determines how Java types are mapped to SQL types, and how EJB-QL functions are mapped to database specific functions. Type mappings are discussed in <a class="xref" href="The_CMP_Engine.html#Datasource_Customization-Mapping">Section 31.13.3, “Mapping”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>create-table</strong></span>: This optional element when true, specifies that JBoss should attempt to create a table for the entity. When the application is deployed, JBoss checks if a table already exists before creating the table. If a table is found, it is logged, and the table is not created. This option is very useful during the early stages of development when the table structure changes often. The default is false.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>alter-table</strong></span>: If <code class="literal">create-table</code> is used to automatically create the schema, <code class="literal">alter-table</code> can be used to keep the schema current with changes to the entity bean. Alter table will perform the following specific tasks:
					</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
								new fields will be created
							</div></li><li class="listitem"><div class="para">
								fields which are no longer used will be removed
							</div></li><li class="listitem"><div class="para">
								string fields which are shorter than the declared length will have their length increased to the declared length. (not supported by all databases)
							</div></li></ul></div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>remove-table</strong></span>: This optional element when true, JBoss will attempt to drop the table for each entity and each relation table mapped relationship. When the application is undeployed, JBoss will attempt to drop the table. This option is very useful during the early stages of development when the table structure changes often. The default is false.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>read-only</strong></span>: This optional element when true specifies that the bean provider will not be allowed to change the value of any fields. A field that is read-only will not be stored in, or inserted into, the database. If a primary key field is read-only, the create method will throw a <code class="literal">CreateException</code>. If a set accessor is called on a <code class="literal">read-only</code> field, it throws an <code class="literal">EJBException</code>. Read only fields are useful for fields that are filled in by database triggers, such as last update. The <code class="literal">read-only</code> option can be overridden on a per field basis. The default is false.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>read-time-out</strong></span>: This optional element is the amount of time in milliseconds that a read on a read only field is valid. A value of 0 means that the value is always reloaded at the start of a transaction, and a value of -1 means that the value never times out. This option can also be overridden on a per CMP field basis. If <code class="literal">read-only</code> is false, this value is ignored. The default is -1.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>row-locking</strong></span>: This optional element if true specifies that JBoss will lock all rows loaded in a transaction. Most databases implement this by using the <code class="literal">SELECT FOR UPDATE</code> syntax when loading the entity, but the actual syntax is determined by the <code class="literal">row-locking-template</code> in the <code class="literal">datasource-mapping</code> used by this entity. The default is false.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>pk-constraint</strong></span>: This optional element if true specifies that JBoss will add a primary key constraint when creating tables. The default is true.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>preferred-relation-mapping</strong></span>: This optional element specifies the preferred mapping style for relationships. The <code class="literal">preferred-relation-mapping</code> element must be either <code class="literal">foreign-key</code> or <code class="literal">relation-table</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>read-ahead</strong></span>: This optional element controls caching of query results and CMR fields for the entity. This option is discussed in <a class="xref" href="The_CMP_Engine.html#Optimized_Loading-Read_ahead">Section 31.7.3, “Read-ahead”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>list-cache-max</strong></span>: This optional element specifies the number of <code class="literal">read-lists</code> that can be tracked by this entity. This option is discussed in <a class="xref" href="The_CMP_Engine.html#Read_ahead-on_load">Section 31.7.3.2, “on-load”</a>. The default is 1000.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>clean-read-ahead-on-load</strong></span>: When an entity is loaded from the read ahead cache, JBoss can remove the data used from the read ahead cache. The default is <code class="literal">false</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>fetch-size</strong></span>: This optional element specifies the number of entities to read in one round-trip to the underlying datastore. The default is 0.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>unknown-pk</strong></span>: This optional element allows one to define the default mapping of an unknown primary key type of <code class="literal">java.lang.Object</code> maps to the persistent store.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>entity-command</strong></span>: This optional element allows one to define the default command for entity creation. This is described in detail in <a class="xref" href="The_CMP_Engine.html#The_CMP_Engine-Entity_Commands_and_Primary_Key_Generation">Section 31.11, “Entity Commands and Primary Key Generation”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>ql-compiler</strong></span>: This optional elements allows a replacement query compiler to be specified. Alternate query compilers were discussed in <a class="xref" href="The_CMP_Engine.html#Queries-EJBQL_2.1_and_SQL92_queries">Section 31.6.7, “EJBQL 2.1 and SQL92 queries”</a>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>throw-runtime-exceptions</strong></span>: This attribute, if set to true, indicates that an error in connecting to the database should be seen in the application as runtime <code class="literal">EJBException</code> rather than as a checked exception.
					</div></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="The_CMP_Engine-Datasource_Customization">
      ⁠</a>31.13. Datasource Customization</h1></div></div></div><div class="para">
			JBoss includes predefined type-mappings for many databases including: Cloudscape, DB2, DB2/400, Hypersonic SQL, InformixDB, InterBase, MS SQLSERVER, MS SQLSERVER2000, mySQL, Oracle7, Oracle8, Oracle9i, PointBase, PostgreSQL, PostgreSQL 7.2, SapDB, SOLID, and Sybase. If you do not like the supplied mapping, or a mapping is not supplied for your database, you will have to define a new mapping. If you find an error in one of the supplied mappings, or if you create a new mapping for a new database, please consider posting a patch at the JBoss project page on SourceForge.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Datasource_Customization-Type_Mapping">
      ⁠</a>31.13.1. Type Mapping</h2></div></div></div><div class="para">
				Customization of a database is done through the <code class="literal">type-mapping</code> section of the <code class="literal">jbosscmp-jdbc.xml</code> descriptor. The content model for the type-mapping element is given in <a class="xref" href="The_CMP_Engine.html#Type_Mapping-The_jbosscmp_jdbc_type_mapping_element_content_model.">Figure 31.17, “The jbosscmp-jdbc type-mapping element content model.”</a>.
			</div><div class="para">
				<div class="figure"><a id="Type_Mapping-The_jbosscmp_jdbc_type_mapping_element_content_model.">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_type-mapping.png" align="middle" alt="The jbosscmp-jdbc type-mapping element content model." style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.17. The jbosscmp-jdbc type-mapping element content model.</strong></p></div>

			</div><div class="para">
				The elements are:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>name</strong></span>: This required element provides the name identifying the database customization. It is used to refer to the mapping by the <code class="literal">datasource-mapping</code> elements found in defaults and entity.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>row-locking-template</strong></span>: This required element gives the <code class="literal">PreparedStatement</code> template used to create a row lock on the selected rows. The template must support three arguments:
					</div><div class="orderedlist"><ol><li class="listitem"><div class="para">
								the select clause
							</div></li><li class="listitem"><div class="para">
								the from clause. The order of the tables is currently not guaranteed
							</div></li><li class="listitem"><div class="para">
								the where clause
							</div></li></ol></div><div class="para">
						If row locking is not supported in select statement this element should be empty. The most common form of row locking is select for update as in: <code class="literal">SELECT ?1 FROM ?2 WHERE ?3 FOR UPDATE</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>pk-constraint-template</strong></span>: This required element gives the <code class="literal">PreparedStatement</code> template used to create a primary key constraint in the create table statement. The template must support two arguments
					</div><div class="orderedlist"><ol><li class="listitem"><div class="para">
								Primary key constraint name; which is always <code class="literal">pk_{table-name}</code>
							</div></li><li class="listitem"><div class="para">
								Comma separated list of primary key column names
							</div></li></ol></div><div class="para">
						If a primary key constraint clause is not supported in a create table statement this element should be empty. The most common form of a primary key constraint is: <code class="literal">CONSTRAINT ?1 PRIMARY KEY (?2)</code>
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>fk-constraint-template</strong></span>: This is the template used to create a foreign key constraint in separate statement. The template must support five arguments:
					</div><div class="orderedlist"><ol><li class="listitem"><div class="para">
								Table name
							</div></li><li class="listitem"><div class="para">
								Foreign key constraint name; which is always <code class="literal">fk_{table-name}_{cmr-field-name}</code>
							</div></li><li class="listitem"><div class="para">
								Comma separated list of foreign key column names
							</div></li><li class="listitem"><div class="para">
								References table name
							</div></li><li class="listitem"><div class="para">
								Comma separated list of the referenced primary key column names
							</div></li></ol></div><div class="para">
						If the datasource does not support foreign key constraints this element should be empty. The most common form of a foreign key constraint is: <code class="literal">ALTER TABLE ?1 ADD CONSTRAINT ?2 FOREIGN KEY (?3) REFERENCES ?4 (?5)</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>auto-increment-template</strong></span>: This declares the SQL template for specifying auto increment columns.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>add-column-template</strong></span>: When <code class="literal">alter-table</code> is true, this SQL template specifies the syntax for adding a column to an existing table. The default value is <code class="literal">ALTER TABLE ?1 ADD ?2 ?3</code>. The parameters are:
					</div><div class="orderedlist"><ol><li class="listitem"><div class="para">
								the table name
							</div></li><li class="listitem"><div class="para">
								the column name
							</div></li><li class="listitem"><div class="para">
								the column type
							</div></li></ol></div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>alter-column-template</strong></span>: When <code class="literal">alter-table</code> is true, this SQL template specifies the syntax for dropping a column to from an existing table. The default value is <code class="literal">ALTER TABLE ?1 ALTER ?2 TYPE ?3</code>. The parameters are:
					</div><div class="orderedlist"><ol><li class="listitem"><div class="para">
								the table name
							</div></li><li class="listitem"><div class="para">
								the column name
							</div></li><li class="listitem"><div class="para">
								the column type
							</div></li></ol></div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>drop-column-template</strong></span>: When <code class="literal">alter-table</code> is true, this SQL template specifies the syntax for dropping a column to from an existing table. The default value is <code class="literal">ALTER TABLE ?1 DROP ?2</code>. The parameters are:
					</div><div class="orderedlist"><ol><li class="listitem"><div class="para">
								the table name
							</div></li><li class="listitem"><div class="para">
								the column name
							</div></li></ol></div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>alias-header-prefix</strong></span>: This required element gives the prefix used in creating the alias header. An alias header is prepended to a generated table alias by the EJB-QL compiler to prevent name collisions. The alias header is constructed as follows: alias-header-prefix + int_counter + alias-header-suffix. An example alias header would be <code class="literal">t0_</code> for an alias-header-prefix of "<code class="literal">t</code>" and an alias-header-suffix of "<code class="literal">_</code>".
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>alias-header-suffix</strong></span>: This required element gives the suffix portion of the generated alias header.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>alias-max-length</strong></span>: This required element gives the maximum allowed length for the generated alias header.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>subquery-supported</strong></span>: This required element specifies if this <code class="literal">type-mapping</code> subqueries as either true or false. Some EJB-QL operators are mapped to exists subqueries. If <code class="literal">subquery-supported</code> is false, the EJB-QL compiler will use a left join and is null.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>true-mapping</strong></span>: This required element defines <span class="emphasis"><em>true</em></span> identity in EJB-QL queries. Examples include <code class="literal">TRUE</code>, <code class="literal">1</code>, and <code class="literal">(1=1)</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>false-mapping</strong></span>: This required element defines <span class="emphasis"><em>false</em></span> identity in EJB-QL queries. Examples include <code class="literal">FALSE</code>, <code class="literal">0</code>, and <code class="literal">(1=0)</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>function-mapping</strong></span>: This optional element specifies one or more the mappings from an EJB-QL function to an SQL implementation. See <a class="xref" href="The_CMP_Engine.html#Datasource_Customization-Function_Mapping">Section 31.13.2, “Function Mapping”</a> for the details.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>mapping</strong></span>: This required element specifies the mappings from a Java type to the corresponding JDBC and SQL type. See <a class="xref" href="The_CMP_Engine.html#Datasource_Customization-Mapping">Section 31.13.3, “Mapping”</a> for the details.
					</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Datasource_Customization-Function_Mapping">
      ⁠</a>31.13.2. Function Mapping</h2></div></div></div><div class="para">
				The function-mapping element model is show below.
			</div><div class="figure"><a id="Function_Mapping-The_jbosscmp_jdbc_function_mapping_element_content_model">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_function-mapping.png" align="middle" alt="The jbosscmp-jdbc function-mapping element content model" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.18. The jbosscmp-jdbc function-mapping element content model</strong></p></div><div class="para">
				The allowed child elements are:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>function-name</strong></span>: This required element gives the EJB-QL function name, e.g., <code class="literal">concat</code>, <code class="literal">substring</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>function-sql</strong></span>: This required element gives the SQL for the function as appropriate for the underlying database. Examples for a <code class="literal">concat</code> function include: <code class="literal">(?1 || ?2)</code>, <code class="literal">concat(?1, ?2)</code>, <code class="literal">(?1 + ?2)</code>.
					</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Datasource_Customization-Mapping">
      ⁠</a>31.13.3. Mapping</h2></div></div></div><div class="para">
				A <code class="literal">type-mapping</code> is simply a set of mappings between Java class types and database types. A set of type mappings is defined by a set of <code class="literal">mapping</code> elements, the content model for which is shown in <a class="xref" href="The_CMP_Engine.html#Mapping-The_jbosscmp_jdbc_mapping_element_content_model.">Figure 31.19, “The jbosscmp-jdbc mapping element content model.”</a>.
			</div><div class="figure"><a id="Mapping-The_jbosscmp_jdbc_mapping_element_content_model.">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp_jdbc_mapping.png" align="middle" alt="The jbosscmp-jdbc mapping element content model." style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.19. The jbosscmp-jdbc mapping element content model.</strong></p></div><div class="para">
				If JBoss cannot find a mapping for a type, it will serialize the object and use the <code class="literal">java.lang.Object</code> mapping. The following describes the three child elements of the mapping element:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>java-type</strong></span>: This required element gives the fully qualified name of the Java class to be mapped. If the class is a primitive wrapper class such as <code class="literal">java.lang.Short</code>, the mapping also applies to the primitive type.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>jdbc-type</strong></span>: This required element gives the JDBC type that is used when setting parameters in a JDBC <code class="literal">PreparedStatement</code> or loading data from a JDBC <code class="literal">ResultSet</code>. The valid types are defined in <code class="literal">java.sql.Types</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>sql-type</strong></span>: This required element gives the SQL type that is used in create table statements. Valid types are only limited by your database vendor.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>param-setter</strong></span>: This optional element specifies the fully qualified name of the <code class="literal">JDBCParameterSetter</code> implementation for this mapping.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>result-reader</strong></span>: This option element specifies the fully qualified name of the <code class="literal">JDBCResultSetReader</code> implementation for this mapping.
					</div></li></ul></div><div class="para">
				An example mapping element for a short in Oracle9i is shown below.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jbosscmp-jdbc&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;type-mappings&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;type-mapping&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;name&gt;</span>Oracle9i<span xmlns="" class="perl_Keyword">&lt;/name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!--...--&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;mapping&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;java-type&gt;</span>java.lang.Short<span xmlns="" class="perl_Keyword">&lt;/java-type&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;jdbc-type&gt;</span>NUMERIC<span xmlns="" class="perl_Keyword">&lt;/jdbc-type&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;sql-type&gt;</span>NUMBER(5)<span xmlns="" class="perl_Keyword">&lt;/sql-type&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/mapping&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/type-mapping&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/type-mappings&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jbosscmp-jdbc&gt;</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Datasource_Customization-User_Type_Mappings">
      ⁠</a>31.13.4. User Type Mappings</h2></div></div></div><div class="para">
				User type mappings allow one to map from JDBC column types to custom CMP fields types by specifying an instance of <code class="classname">org.jboss.ejb.plugins.cmp.jdbc.Mapper</code> interface, the definition of which is shown below.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> Mapper
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called when CMP field is stored.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param fieldValue </span><span xmlns="" class="perl_Comment">- CMP field value</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">column value.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    Object <span xmlns="" class="perl_Function">toColumnValue</span>(Object fieldValue);    
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called when CMP field is loaded.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param columnValue </span><span xmlns="" class="perl_Comment">- loaded column value.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">CMP field value.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    Object <span xmlns="" class="perl_Function">toFieldValue</span>(Object columnValue);
<span xmlns="" class="line">​</span>}
</pre><div class="para">
				A prototypical use case is the mapping of an integer type to its type-safe Java enumeration instance. The content model of the <code class="literal">user-type-mappings</code> element consists of one or more <code class="literal">user-type-mapping</code> elements, the content model of which is shown in <a class="xref" href="The_CMP_Engine.html#User_Type_Mappings-The_user_type_mapping_content_model_">Figure 31.20, “The user-type-mapping content model &gt;”</a>.
			</div><div class="para">
				<div class="figure"><a id="User_Type_Mappings-The_user_type_mapping_content_model_">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jbosscmp-jdbc_user-type-mapping.png" align="middle" alt="The user-type-mapping content model &gt;" style="text-align: middle"/></div></div><p class="title"><strong>Figure 31.20. The user-type-mapping content model &gt;</strong></p></div>

			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>java-type</strong></span>: the fully qualified name of the CMP field type in the mapping.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>mapped-type</strong></span>: the fully qualified name of the database type in the mapping.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>mapper</strong></span>: the fully qualified name of the <code class="literal">Mapper</code> interface implementation that handles the conversion between the <code class="literal">java-type</code> and <code class="literal">mapped-type</code>.
					</div></li></ul></div></div></div></div></body></html>