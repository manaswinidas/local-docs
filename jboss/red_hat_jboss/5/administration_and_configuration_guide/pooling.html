<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 18. Pooling</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="pooling">
      ⁠</a>Chapter 18. Pooling</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776693357344">
      ⁠</a>18.1. Strategy</h1></div></div></div><div class="para">
			<a id="idm139776687832928" class="indexterm"/> JCA uses a <code class="literal">ManagedConnectionPool</code> to perform the pooling. The <code class="literal">ManagedConnectionPool</code> is made up of subpools depending upon the strategy chosen and other pooling parameters.
		</div><div class="informaltable"><table xmlns:d="http://docbook.org/ns/docbook" class="gt-4-cols lt-7-rows"><colgroup><col/><col/><col/><col/></colgroup><thead><tr><th> <div class="para">
							XML
						</div>
						 </th><th> <div class="para">
							mbean
						</div>
						 </th><th> <div class="para">
							Internal Name
						</div>
						 </th><th> <div class="para">
							Description
						</div>
						 </th></tr></thead><tbody><tr><td> <div class="para">
							 
						</div>
						 </td><td> <div class="para">
							ByNothing
						</div>
						 </td><td> <div class="para">
							OnePool
						</div>
						 </td><td> <div class="para">
							A single pool of equivalent connections
						</div>
						 </td></tr><tr><td> <div class="para">
							&lt;application-managed-security/&gt;
						</div>
						 </td><td> <div class="para">
							ByApplication
						</div>
						 </td><td> <div class="para">
							PoolByCRI
						</div>
						 </td><td> <div class="para">
							Use the connection properties from allocateConnection()
						</div>
						 </td></tr><tr><td> <div class="para">
							&lt;security-domain/&gt;
						</div>
						 </td><td> <div class="para">
							ByContainer
						</div>
						 </td><td> <div class="para">
							PoolBySubject
						</div>
						 </td><td> <div class="para">
							A pool per Subject, e.g. preconfigured or EJB/Web log in subjects
						</div>
						 </td></tr><tr><td> <div class="para">
							&lt;security-domain-and-application/&gt;
						</div>
						 </td><td> <div class="para">
							ByContainerAndApplicaton
						</div>
						 </td><td> <div class="para">
							PoolBySubjectAndCri
						</div>
						 </td><td> <div class="para">
							A per Subject and connection property combination
						</div>
						 </td></tr></tbody></table></div><div class="para">
			For &lt;security-domain-and-application/&gt; the <code class="literal">Subject</code> always overrides any user/password from createConnection(user, password) in the CRI:
		</div><pre class="screen">(
ConnectionRequestInfo
)</pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776725833696">
      ⁠</a>18.2. Workaround for Oracle's JDK</h1></div></div></div><div class="para">
			Oracle's JDK does not work well with XA connections when used both inside and outside a JTA transaction. To workaround the problem you can create separate sub-pools for the different contexts using &lt;no-tx-separate-pools/&gt;.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776725832080">
      ⁠</a>18.3. Pool Access</h1></div></div></div><div class="para">
			The pool is designed for concurrent usage.
		</div><div class="para">
			Up to &lt;max-pool-size/&gt; threads can be inside the pool at the same time (or using connections from a pool).
		</div><div class="para">
			Once this limit is reached, threads wait for the &lt;blocking-timeout-seconds/&gt; to use the pool before throwing a <code class="systemitem">No Managed Connections Available</code> exception. More information about this exception can be found at <a href="http://www.jboss.org/community/wiki/WhatDoesTheMessageNoManagedConnectionsAvailableMean">http://www.jboss.org/community/wiki/WhatDoesTheMessageNoManagedConnectionsAvailableMean</a>.
		</div><div class="para">
			You may need to use the <em class="parameter"><code>&lt;allocation-retry/&gt;</code></em> and <em class="parameter"><code>&lt;allocation-retry-wait-millis/&gt;</code></em> elements to have the pool retry to obtain a connection before throwing the exception.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776686607600">
      ⁠</a>18.4. Pool Filling</h1></div></div></div><div class="para">
			The number of connections in the pool is controlled by the pool sizes.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					&lt;min-pool-size/&gt; - When the number of connections falls below this size, new connections are created
				</div></li><li class="listitem"><div class="para">
					&lt;max-pool-size/&gt; - No more than this number of connections are created
				</div></li><li class="listitem"><div class="para">
					&lt;prefill/&gt; - Feature Request has been implemented for 4.0.5.
				</div></li></ul></div><div class="para">
			The pool filling is done by a separate "Pool Filler" thread rather than blocking application threads.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Pool Filling to Minimum Pool Size</strong></p></div><div class="admonition"><div class="para">
				Connection pools are filled to their <em class="parameter"><code>min-pool-size</code></em> only on their first usage.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776755853376">
      ⁠</a>18.5. Idle Connections</h1></div></div></div><div class="para">
			You can configure connections to be closed when they are idle. For example; if you just had a peak period and now want to reap the unused ones. This is done via the <em class="parameter"><code>idle-timeout-minutes</code></em> parameter.
		</div><div class="para">
			Idle checking is done on a separate <span class="emphasis"><em>Idle Remover</em></span> thread on an 'least recently used' (<abbr class="abbrev">LRU</abbr>) basis.
		</div><div class="para">
			Idle connections (connections that have been unused for the period defined by <em class="parameter"><code>idle-timeout-minutes</code></em>) are purged regularly. The check is performed at an interval that is half of the <em class="parameter"><code>idle-timeout-minutes</code></em> value.
		</div><div class="para">
			The pool itself operates on an 'most recently used' (<abbr class="abbrev">MRU</abbr>) basis. This allows the excess connections to be easily identified.
		</div><div class="para">
			Should closing idle connections cause the pool to fall below the <em class="parameter"><code>min-pool-size</code></em> value, new connections are created.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong/></p></div><div class="admonition"><div class="para">
				If you have long-running transactions and you use interleaving (i.e. do not track-connection-by-tx) make sure the idle timeout is greater than the transaction timeout. When interleaving the connection is returned to the pool for others to use. If however nobody does use it, it would be a candidate for removal before the transaction is committed.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776734707344">
      ⁠</a>18.6. Dead connections</h1></div></div></div><div class="para">
			The JDBC protocol does not provide a natural <code class="literal">connectionErrorOccured()</code> event when a connection is broken. To support dead/broken connection checking there are a number of plug-ins.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139776734705552">
      ⁠</a>18.6.1. Valid connection checking</h2></div></div></div><div class="para">
				Valid connections can be checked with an <abbr class="abbrev">SQL</abbr> statement (as shown below) before handing the connection to the application.
			</div><pre class="screen">&lt;check-valid-connection-sql&gt;select 1 from dual&lt;/check-valid-connection-sql&gt;</pre><div class="para">
				If this fails, another connection is selected until there are no more connections at which point new connections are constructed.
			</div><div class="para">
				A potentially more performant check is to use vendor specific features, for example Oracle or MySQL's <code class="code">pingDatabase()</code> tool:
			</div><pre class="screen">&lt;valid-connection-checker-class-name/&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139776736918864">
      ⁠</a>18.6.2. Errors during SQL queries</h2></div></div></div><div class="para">
				You can check if a connection broke during a query by the reviewing the error codes or messages of the <code class="systemitem">SQLException</code> for <code class="literal">FATAL</code> errors rather than normal <code class="systemitem">SQLExceptions</code>. These codes or messages can be vendor specific, such as: 
<pre class="screen">&lt;exception-sorter-class-name&gt;org.jboss.resource.adapter.jdbc.vendor.OracleExceptionSorter&lt;/exception-sorter-class-name&gt;</pre>

			</div><div class="para">
				For <code class="literal">FATAL</code> errors, the connection will be closed.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139776741071072">
      ⁠</a>18.6.3. Changing, Closing or Flushing the pool</h2></div></div></div><div class="para">
				To change, close or flush the pool, do the following:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="idm139776741069856">
      ⁠</a><p class="title"><strong>Procedure 18.1. Changing or Flushing the pool</strong></p><ol class="1"><li class="step"><div class="para">
						Use JMX to change the attributes on the connection pool <code class="systemitem">jboss.jca:service=JBossManagedConnectionPool,name=<em class="replaceable">&lt;jndi-name&gt;</em></code>.
					</div></li><li class="step"><div class="para">
						Use JMX to invoke <code class="code">flush()</code> to reset the pools.
					</div></li></ol></div><div class="para">
				Also, closing or undeploying the pool will force a flush first.
			</div><div class="para">
				When <code class="code">flush()</code> is invoked;
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						All idle connections are immediately closed;
					</div></li><li class="listitem"><div class="para">
						Any in use connections are closed when the application finishes with them;
					</div></li><li class="listitem"><div class="para">
						New connections are created.
					</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139776738103056">
      ⁠</a>18.6.4. Using Third Party Pools</h2></div></div></div><div class="para">
				If you want to use an <span class="emphasis"><em>XADataSource</em></span>, the JBoss JCA can use the standard API.
			</div><div class="para">
				If it is a <span class="bold bold"><strong>non</strong></span>-<span class="emphasis"><em>XADataSource</em></span> that does internal pooling (such as Oracle's DataSource for use with RAC), then the pool will not understand the transacting or security configurations (nor any other component that expects the connection to be controlled by the JCA).
			</div><div class="para">
				These DataSources are intended for use outside a J2EE environment.
			</div><div class="para">
				JBoss uses standard JDBC drivers and adds the behaviour to turn them into DataSources with the full J2EE contract.
			</div><div class="para">
				Non-<span class="emphasis"><em>XADataSource</em></span> datasources should only be used by administrators with a thorough understanding of the topic and its inherent problems.
			</div></div></div></div></body></html>