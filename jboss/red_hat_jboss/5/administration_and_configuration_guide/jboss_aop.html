<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 12. JBoss AOP</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="jboss_aop">
      ⁠</a>Chapter 12. JBoss AOP</h1></div></div></div><div class="para">
		<a id="idm139776755633968" class="indexterm"/><a id="idm139776693702032" class="indexterm"/> JBoss AOP is a 100% Pure Java Aspected Oriented Framework usable in any programming environment or tightly integrated with our application server. Aspects allow you to more easily modularize your code base when regular object oriented programming just does not fit the bill. It can provide a cleaner separation from application logic and system code. It provides a great way to expose integration points into your software. Combined with Java Annotations, it also is a great way to expand the Java language in a clean pluggable way rather than using annotations solely for code generation.
	</div><div class="para">
		JBoss AOP is not only a framework, but also a prepackaged set of aspects that are applied via annotations, pointcut expressions, or dynamically at runtime. Some of these include caching, asynchronous communication, transactions, security, remoting, and many more.
	</div><div class="para">
		An aspect is a common feature that is typically scattered across methods, classes, object hierarchies, or even entire object models. It is behavior that looks and smells like it should have structure, but you can not find a way to express this structure in code with traditional object-oriented techniques.
	</div><div class="para">
		For example, metrics is one common aspect. To generate useful logs from your application, you have to (often liberally) sprinkle informative messages throughout your code. However, metrics is something that your class or object model really should not be concerned about. After all, metrics is irrelevant to your actual application: it does not represent a customer or an account, and it does not realize a business rule. It's simply orthogonal.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776763644448">
      ⁠</a>12.1. Some key terms</h1></div></div></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Joinpoint</div>
				A <span class="emphasis"><em>joinpoint</em></span> is any point in your Java program. The call of a method, the execution of a constructor, the access of a field; all these are joinpoints. You could also think of a joinpoint as a particular Java event, where an event is a method call, constructor call, field access, etc.
			</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Invocation</div>
				An <span class="emphasis"><em>invocation</em></span> is a JBoss AOP class that encapsulates what a joinpoint is at runtime. It could contain information like which method is being called, the arguments of the method, etc.
			</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Advice</div>
				An <span class="emphasis"><em>advice</em></span> is a method that is called when a particular joinpoint is executed, such as the behavior that is triggered when a method is called. It could also be thought of as the code that performs the interception. Another analogy is that an advice is an "event handler".
			</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Pointcut</div>
				<span class="emphasis"><em>Pointcuts</em></span> are AOP's expression language. Just as a regular expression matches strings, a pointcut expression matches a particular joinpoint.
			</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Introduction</div>
				An <span class="emphasis"><em>introduction</em></span> modifies the type and structure of a Java class. It can be used to force an existing class to implement an interface or to add an annotation to anything.
			</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Aspect</div>
				An <span class="emphasis"><em>aspect</em></span> is a plain Java class that encapsulates any number of advices, pointcut definitions, mixins, or any other JBoss AOP construct.
			</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Interceptor</div>
				An <span class="emphasis"><em>interceptor</em></span> is an aspect with only one advice, named <code class="literal">invoke</code>. It is a specific interface that you can implement if you want your code to be checked by forcing your class to implement an interface. It also will be portable and can be reused in other JBoss environments like EJBs and JMX MBeans.
			</div><div class="para">
			In AOP, a feature like metrics is called a <span class="emphasis"><em>crosscutting concern</em></span>, as it is a behavior that "cuts" across multiple points in your object models, yet is distinctly different. As a development methodology, AOP recommends that you abstract and encapsulate crosscutting concerns.
		</div><div class="para">
			For example, let us say you wanted to add code to an application to measure the amount of time it would take to invoke a particular method. In plain Java, the code would look something like the following.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> BankAccountDAO
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span> <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">withdraw</span>(<span xmlns="" class="perl_DataType">double</span> amount)
<span xmlns="" class="line">​</span> {
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_DataType">long</span> startTime = System.<span xmlns="" class="perl_Function">currentTimeMillis</span>();
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>  {
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Comment">// Actual method body...</span>
<span xmlns="" class="line">​</span>  }
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">finally</span>
<span xmlns="" class="line">​</span>  {
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_DataType">long</span> endTime = System.<span xmlns="" class="perl_Function">currentTimeMillis</span>() - startTime;
<span xmlns="" class="line">​</span>   System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"withdraw took: "</span> + endTime);
<span xmlns="" class="line">​</span>  }
<span xmlns="" class="line">​</span> }
<span xmlns="" class="line">​</span>}</pre><div class="para">
			While this code works, there are a few problems with this approach: 
			<div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
						It's extremely difficult to turn metrics on and off, as you have to manually add the code in the <code class="code">try</code>/<code class="code">finally</code> blocks to each and every method or constructor you want to benchmark.
					</div></li><li class="listitem"><div class="para">
						Profiling code should not be combined with your application code. It makes your code more verbose and difficult to read, since the timings must be enclosed within the <code class="code">try</code>/<code class="code">finally</code> blocks.
					</div></li><li class="listitem"><div class="para">
						If you wanted to expand this functionality to include a method or failure count, or even to register these statistics to a more sophisticated reporting mechanism, you'd have to modify a lot of different files (again).
					</div></li></ol></div>

		</div><div class="para">
			This approach to metrics is very difficult to maintain, expand, and extend, because it is dispersed throughout your entire code base. In many cases, OOP may not always be the best way to add metrics to a class.
		</div><div class="para">
			Aspect-oriented programming gives you a way to encapsulate this type of behavior functionality. It allows you to add behavior such as metrics "around" your code. For example, AOP provides you with programmatic control to specify that you want calls to <code class="classname">BankAccountDAO</code> to go through a metrics aspect before executing the actual body of that code.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776698860960">
      ⁠</a>12.2. Creating Aspects in JBoss AOP</h1></div></div></div><div class="para">
			<a id="idm139776698859872" class="indexterm"/> In short, all AOP frameworks define two things: a way to implement crosscutting concerns, and a programmatic construct — a programming language or a set of tags to specify how you want to apply those snippets of code. Let us take a look at how JBoss AOP, its cross-cutting concerns, and how you can implement a metrics aspect in JBoss Enterprise Application Platform.
		</div><div class="para">
			The first step in creating a metrics aspect in JBoss AOP is to encapsulate the metrics feature in its own Java class. The following code extracts the <code class="code">try</code>/<code class="code">finally</code> block in our first code example's <code class="methodname">BankAccountDAO.withdraw()</code> method into <code class="literal">Metrics</code>, an implementation of a JBoss AOP Interceptor class.
		</div><div class="para">
			The following example code demonstrates implementing metrics in a JBoss AOP Interceptor
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">01.</span> <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> Metrics <span xmlns="" class="perl_Keyword">implements</span> org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">aop</span>.<span xmlns="" class="perl_Function">advice</span>.<span xmlns="" class="perl_Function">Interceptor</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">02.</span> {
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">03.</span>   <span xmlns="" class="perl_Keyword">public</span> Object <span xmlns="" class="perl_Function">invoke</span>(Invocation invocation) <span xmlns="" class="perl_Keyword">throws</span> Throwable
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">04.</span>   {
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">05.</span>     <span xmlns="" class="perl_DataType">long</span> startTime = System.<span xmlns="" class="perl_Function">currentTimeMillis</span>();
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">06.</span>     <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">07.</span>     {
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">08.</span>       <span xmlns="" class="perl_Keyword">return</span> invocation.<span xmlns="" class="perl_Function">invokeNext</span>();
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">09.</span>     }
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">10.</span>     <span xmlns="" class="perl_Keyword">finally</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">11.</span>     {
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">12.</span>       <span xmlns="" class="perl_DataType">long</span> endTime = System.<span xmlns="" class="perl_Function">currentTimeMillis</span>() - startTime;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">13.</span>       java.<span xmlns="" class="perl_Function">lang</span>.<span xmlns="" class="perl_Function">reflect</span>.<span xmlns="" class="perl_Function">Method</span> m = ((MethodInvocation)invocation).<span xmlns="" class="perl_Function">method</span>;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">14.</span>       System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>(<span xmlns="" class="perl_String">"method "</span> + m.<span xmlns="" class="perl_Function">toString</span>() + <span xmlns="" class="perl_String">" time: "</span> + endTime + <span xmlns="" class="perl_String">"ms"</span>);
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">15.</span>     }
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">16.</span>   }
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Float">17.</span> }</pre><div class="para">
			Under JBoss AOP, the Metrics class wraps <code class="methodname">withdraw()</code>: when calling code invokes <code class="methodname">withdraw()</code>, the AOP framework breaks the method call into its parts and encapsulates those parts into an Invocation object. The framework then calls any aspects that sit between the calling code and the actual method body.
		</div><div class="para">
			When the AOP framework is done dissecting the method call, it calls <code class="classname">Metrics</code>'s invoke method at line 3. Line 8 wraps and delegates to the actual method and uses an enclosing <code class="code">try</code>/<code class="code">finally</code> block to perform the timings. Line 13 obtains contextual information about the method call from the <code class="classname">Invocation</code> object, while line 14 displays the method name and the calculated metrics.
		</div><div class="para">
			Having the <code class="classname">Metrics</code> code within its own object allows us to easily expand and capture additional measurements later on. Now that metrics are encapsulated into an aspect, let us see how to apply it.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776679429104">
      ⁠</a>12.3. Applying Aspects in JBoss AOP</h1></div></div></div><div class="para">
			<a id="idm139776699312400" class="indexterm"/> To apply an aspect, you define when to execute the aspect code. Those points in execution are called <span class="emphasis"><em>pointcuts</em></span>. An analogy to a pointcut is a regular expression. Where a regular expression matches strings, a pointcut expression matches events or <span class="emphasis"><em>points</em></span> within your application. For example, a valid pointcut definition would be, "for all calls to the JDBC method <code class="methodname">executeQuery()</code>, call the aspect that verifies SQL syntax."
		</div><div class="para">
			An entry point could be a field access, or a method or constructor call. An event could be an exception being thrown. Some AOP implementations use languages akin to queries to specify pointcuts. Others use tags. JBoss AOP uses both.
		</div><div class="para">
			The following listing demonstrates defining a pointcut for the Metrics example in JBoss AOP:
		</div><div class="programlistingco"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"SimpleInterceptor"</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"com.mc.Metrics"</span><span xmlns="" class="perl_Keyword">/&gt;</span>                 <img class="callout" alt="1" src="Common_Content/images/1.png"/>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;bind</span><span xmlns="" class="perl_Others"> pointcut=</span><span xmlns="" class="perl_String">"execution (public void com.mc.BankAccountDAO-&gt;withdraw(double amount))"</span> <span xmlns="" class="perl_Keyword">&gt;</span>                                                                      <img class="callout" alt="2" src="Common_Content/images/2.png"/>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor-ref</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"SimpleInterceptor"</span> <span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/bind&gt;</span>                                                                        <img class="callout" alt="2" src="Common_Content/images/2.png"/>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;bind</span><span xmlns="" class="perl_Others"> pointcut=</span><span xmlns="" class="perl_String">"execution (* com.mc.billing.-&gt;(..))"</span><span xmlns="" class="perl_Keyword">&gt;</span>                          <img class="callout" alt="3" src="Common_Content/images/3.png"/>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor-ref</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"com.mc.Metrics"</span> <span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/bind&gt;</span>                                                                        <img class="callout" alt="3" src="Common_Content/images/3.png"/>
</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td valign="top" align="left"><p><img class="callout" src="Common_Content/images/1.png" alt="1"/></p></td><td valign="top" align="left"><div class="para">
						Defines the mapping of the interceptor name to the <code class="classname">interceptor</code> class.
					</div></td></tr><tr><td valign="top" align="left"><p><img class="callout" src="Common_Content/images/2.png" alt="2"/></p></td><td valign="top" align="left"><div class="para">
						Lines 2-4 define a pointcut that applies the <code class="literal">metrics</code> aspect to the specific method <code class="methodname">BankAccountDAO.withdraw()</code>.
					</div></td></tr><tr><td valign="top" align="left"><p><img class="callout" src="Common_Content/images/3.png" alt="3"/></p></td><td valign="top" align="left"><div class="para">
						Lines 5-7 define a general pointcut that applies the <code class="literal">metrics</code> aspect to all methods in all classes in the <code class="filename">com.mc.billing</code> package. There is also an optional annotation mapping if you prefer to avoid XML.
					</div></td></tr></table></div></div><div class="para">
			For more information, see the JBoss AOP reference documentation.
		</div><div class="para">
			JBoss AOP has a rich set of pointcut expressions that you can use to define various points or events in your Java application. Once your points are defined, you can apply aspects to them. You can attach your aspects to a specific Java class in your application or you can use more complex compositional pointcuts to specify a wide range of classes within one expression.
		</div><div class="para">
			With AOP, as this example shows, you can combine all crosscutting behavior into one object and apply it easily and simply, without complicating your code with features unrelated to business logic. Instead, common crosscutting concerns can be maintained and extended in one place.
		</div><div class="para">
			Note that code within the <code class="classname">BankAccountDAO</code> class does not detect that it is being profiled. Profiling is part of what aspect-oriented programmers deem orthogonal concerns. In the object-oriented programming code snippet at the beginning of this chapter, profiling was part of the application code. AOP allows you to remove that code. A modern promise of middleware is transparency, and AOP clearly delivers.
		</div><div class="para">
			Orthogonal behavior can also be included after development. In object-oriented code, monitoring and profiling must be added at development time. With AOP, a developer or an administrator can easily add monitoring and metrics as needed without touching the code. This is a very subtle but significant part of AOP, as this separation allows aspects to be layered on top of or below the code that they cut across. A layered design allows features to be added or removed at will. For instance, perhaps you snap on metrics only when you are doing some benchmarks, but remove it for production. With AOP, this can be done without editing, recompiling, or repackaging the code.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776768068064">
      ⁠</a>12.4. Packaging AOP Applications</h1></div></div></div><div class="para">
			To deploy an AOP application in JBoss Enterprise Application Platform you need to package it. AOP is packaged similarly to SARs (MBeans). You can either deploy an XML file directly in the <code class="filename">deploy/</code> directory with the signature <code class="filename">*-aop.xml</code> along with your package (this is how the <code class="filename">base-aop.xml</code>, included in the <code class="filename">jboss-aop.deployer</code> file works) or you can include it in the JAR file containing your classes. If you include your XML file in your JAR, it must have the file extension <code class="filename">.aop</code> and a <code class="filename">jboss-aop.xml</code> file must be contained in a <code class="filename">META-INF</code> directory, for instance: <code class="filename">META-INF/jboss-aop.xml</code>.
		</div><div class="para">
			In the JBoss Enterprise Application Platform 5, you <span class="emphasis"><em>must</em></span> specify the schema used, otherwise your information will not be parsed correctly. You do this by adding the <code class="varname">xmlns="urn:jboss:aop-beans:1:0</code> attribute to the root <code class="literal">aop</code> element, as shown here:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;aop</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:aop-beans:1.0"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/aop&gt;</span>
</pre><div class="para">
			If you want to create anything more than a non-trivial example, using the <code class="filename">.aop</code> JAR files, you can make any top-level deployment contain an AOP file containing the XML binding configuration. For instance you can have an AOP file in an EAR file, or an AOP file in a WAR file. The bindings specified in the <code class="filename">META-INF/jboss-aop.xml</code> file contained in the AOP file will affect all the classes in the whole WAR file.
		</div><div class="para">
			To pick up an AOP file in an EAR file, it must be listed in the <code class="filename">.ear/META-INF/application.xml</code> as a Java module, as follows:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version='1.0'  encoding='UTF-8'<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_DataType">&lt;!DOCTYPE </span>application PUBLIC '-//Sun Microsystems, Inc.//DTD J2EE Application 1.2//EN''http://java.sun.com/j2ee/dtds/application_1_2.dtd'<span xmlns="" class="perl_DataType">&gt;</span>
<span xmlns="" class="line">​</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;application&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;display-name&gt;</span>AOP in JBoss example<span xmlns="" class="perl_Keyword">&lt;/display-name&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;module&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;java&gt;</span>example.aop<span xmlns="" class="perl_Keyword">&lt;/java&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/module&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;module&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;ejb&gt;</span>aopexampleejb.jar<span xmlns="" class="perl_Keyword">&lt;/ejb&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/module&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;module&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;web&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;web-uri&gt;</span>aopexample.war<span xmlns="" class="perl_Keyword">&lt;/web-uri&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;context-root&gt;</span>/aopexample<span xmlns="" class="perl_Keyword">&lt;/context-root&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/web&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/module&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/application&gt;</span>
</pre><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
				In the JBoss Enterprise Application Platform 5, the contents of the <code class="filename">.ear</code> file are deployed in the order they are listed in the <code class="filename">application.xml</code>. When using loadtime weaving the bindings listed in the <code class="filename">example.aop</code> file must be deployed before the classes being advised are deployed, so that the bindings exist in the system before (for example) the <code class="classname">ejb</code> and <code class="classname">servlet</code> classes are loaded. This is achieved by listing the AOP file at the start of the <code class="filename">application.xml</code>. Other types of archives are deployed before anything else and so do not require special consideration, such as <code class="filename">.sar</code> and <code class="filename">.war</code> files.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776689981440">
      ⁠</a>12.5. The JBoss AspectManager Service</h1></div></div></div><div class="para">
			The <code class="classname">AspectManager</code> Service can be managed at runtime using the JMX console, which is found at <code class="filename">http://localhost:8080/jmx-console</code>. It is registered under the ObjectName <code class="literal">jboss.aop:service=AspectManager</code>. If you want to configure it on start up you need to edit some configuration files.
		</div><div class="para">
			In JBoss Enterprise Application Platform 5 the <code class="classname">AspectManager</code> Service is configured using a JBoss Microcontainer bean. The configuration file is <code class="filename">jboss-as/server/<em class="replaceable">PROFILE</em>/conf/bootstrap/aop.xml</code>. The <code class="classname">AspectManager</code> Service is deployed with the following XML:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;bean</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"AspectManager"</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"org.jboss.aop.deployers.AspectManagerJDK5"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>     
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;property</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"jbossIntegration"</span><span xmlns="" class="perl_Keyword">&gt;&lt;inject</span><span xmlns="" class="perl_Others"> bean=</span><span xmlns="" class="perl_String">"AOPJBossIntegration"</span><span xmlns="" class="perl_Keyword">/&gt;&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>                               
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;property</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"enableLoadtimeWeaving"</span><span xmlns="" class="perl_Keyword">&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- only relevant when EnableLoadtimeWeaving is true.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">    When transformer is on, every loaded class gets transformed.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">    If AOP can not find the class, then it throws an exception.  </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">    Sometimes, classes may not have all the classes they reference.  </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">    So, the Suppressing is needed.  (For instance, JBoss cache in the default configuration) --&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;property</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"suppressTransformationErrors"</span><span xmlns="" class="perl_Keyword">&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;property</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"prune"</span><span xmlns="" class="perl_Keyword">&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;property</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"include"</span><span xmlns="" class="perl_Keyword">&gt;</span>org.jboss.test., org.jboss.injbossaop.<span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;property</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"exclude"</span><span xmlns="" class="perl_Keyword">&gt;</span>org.jboss.<span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- This avoids instrumentation of hibernate cglib enhanced proxies</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">    </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">    &lt;property name="ignore"&gt;*$$EnhancerByCGLIB$$*&lt;/property&gt; --&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;property</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"optimized"</span><span xmlns="" class="perl_Keyword">&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;property</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"verbose"</span><span xmlns="" class="perl_Keyword">&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/property&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- Available choices for this attribute are: org.jboss.aop.instrument.ClassicInstrumentor (default)</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">    org.jboss.aop.instrument.GeneratedAdvisorInstrumentor --&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- &lt;property name="instrumentor"&gt;org.jboss.aop.instrument.ClassicInstrumentor&lt;/property&gt;--&gt;</span>
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- By default the deployment of the aspects contained in </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">    ../deployers/jboss-aop-jboss5.deployer/base-aspects.xml</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">    are not deployed. To turn on deployment uncomment this property</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">    &lt;property name="useBaseXml"&gt;true&lt;/property&gt;--&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/bean&gt;</span>
</pre><div class="para">
			Later we will talk about changing the class of the <code class="classname">AspectManager</code> Service. To do this, replace the contents of the <code class="varname">class</code> attribute of the <code class="classname">bean</code> element.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="running-as-sun-jdk">
      ⁠</a>12.6. Loadtime transformation in the JBoss Enterprise Application Platform Using Sun JDK</h1></div></div></div><div class="para">
			The JBoss Enterprise Application Platform has special integration with JDK to do loadtime transformations. This section explains how to use it.
		</div><div class="para">
			If you want to do load-time transformations with JBoss Enterprise Application Platform 5 and Sun JDK, these are the steps you must take.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					Set the <code class="varname">enableLoadtimeWeaving</code> attribute/property to <code class="literal">true</code>. By default, JBoss Enterprise Application Platform will not do load-time bytecode manipulation of AOP files unless this is set. If <code class="varname">suppressTransformationErrors</code> is <code class="literal">true</code>, failed bytecode transformation will only give an error warning. This flag is needed because sometimes a JBoss deployment will not include all of the classes referenced.
				</div></li><li class="listitem"><div class="para">
					Copy the <code class="filename">pluggable-instrumentor.jar</code> from the <code class="filename">lib/</code> directory of your JBoss AOP distribution to the <code class="filename">bin/</code> directory of your JBoss Enterprise Application Platform.
				</div></li><li class="listitem"><div class="para">
					Next edit <code class="filename">run.sh</code> or <code class="literal">run.bat</code> (depending on what OS you are on) and add the following to the <code class="varname">JAVA_OPTS</code> environment variable:
				</div><pre class="programlisting">
set JAVA_OPTS=%JAVA_OPTS% -Dprogram.name=%PROGNAME% -javaagent:pluggable-instrumentor.jar
</pre></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
				The class of the AspectManager Service must be <code class="literal">org.jboss.aop.deployers.AspectManagerJDK5</code> or <code class="literal">org.jboss.aop.deployment.AspectManagerServiceJDK5</code> as these are what work with the <code class="code">-javaagent</code> option.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776768017120">
      ⁠</a>12.7. JRockit</h1></div></div></div><div class="para">
			JRockit also supports the <code class="code">-javaagent</code> switch mentioned in <a class="xref" href="jboss_aop.html#running-as-sun-jdk">Section 12.6, “Loadtime transformation in the JBoss Enterprise Application Platform Using Sun JDK”</a>. If you wish to use that, then the steps in <a class="xref" href="jboss_aop.html#running-as-sun-jdk">Section 12.6, “Loadtime transformation in the JBoss Enterprise Application Platform Using Sun JDK”</a> are sufficient. However, JRockit also comes with its own framework for intercepting when classes are loaded, which might be faster than the <code class="code">-javaagent</code> switch. If you want to do load-time transformations using the special JRockit hooks, these are the steps you must take.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					Set the <code class="literal">enableLoadtimeWeaving</code> attribute/property to true. By default, JBoss Enterprise Application Platform will not do load-time bytecode manipulation of AOP files unless this is set. If <code class="varname">suppressTransformationErrors</code> is <code class="literal">true</code>, failed bytecode transformation will only give an error warning. This flag is needed because sometimes a JBoss deployment will not include all the classes referenced.
				</div></li><li class="listitem"><div class="para">
					Copy the <code class="filename">jrockit-pluggable-instrumentor.jar</code> from the <code class="filename">lib/</code> directory of your JBoss AOP distribution to the <code class="filename">bin/</code> directory of your the JBoss Enterprise Application Platform installation.
				</div></li><li class="listitem"><div class="para">
					Next edit <code class="filename">run.sh</code> or <code class="filename">run.bat</code> (depending on what OS you are on) and add the following to the <code class="varname">JAVA_OPTS</code> and <code class="varname">JBOSS_CLASSPATH</code> environment variables:
				</div><pre class="screen">
# Setup JBoss specific properties

JAVA_OPTS="$JAVA_OPTS -Dprogram.name=$PROGNAME \

-Xmanagement:class=org.jboss.aop.hook.JRockitPluggableClassPreProcessor"

JBOSS_CLASSPATH="$JBOSS_CLASSPATH:jrockit-pluggable-instrumentor.jar"
</pre></li><li class="listitem"><div class="para">
					Set the class of the <code class="classname">AspectManager</code> Service to <code class="literal">org.jboss.aop.deployers.AspectManagerJRockit</code> on JBoss Enterprise Application Platform 5, or <code class="literal">org.jboss.aop.deployment.AspectManagerService</code> as these are what work with special hooks in JRockit.
				</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776741910672">
      ⁠</a>12.8. Improving Loadtime Performance in the JBoss Enterprise Application Platform Environment</h1></div></div></div><div class="para">
			The same rules apply to the JBoss Enterprise Application Platform for tuning loadtime weaving performance as standalone Java. Switches such as pruning, optimized, include and exclude are configured through the <code class="filename">jboss-5.x.x.GA/server/xxx/conf/aop.xml</code> file talked about earlier in this chapter.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139776755435488">
      ⁠</a>12.9. Scoping the AOP to the classloader</h1></div></div></div><div class="para">
			By default all deployments in JBoss are global to the whole application server. That means that any EAR, SAR, or JAR (for example), that is put in the deploy directory can see the classes from any other deployed archive. Similarly, AOP bindings are global to the whole virtual machine. This <span class="emphasis"><em>global</em></span> visibility can be turned off per top-level deployment.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139776755433520">
      ⁠</a>12.9.1. Deploying as part of a scoped classloader</h2></div></div></div><div class="para">
				The following process may change in future versions of JBoss AOP. If you deploy an AOP file as part of a scoped archive, the bindings (for instance) applied within the <code class="filename">.aop/META-INF/jboss-aop.xml</code> file will only apply to the classes within the scoped archive and not to anything else in the application server. Another alternative is to deploy <code class="filename">-aop.xml</code> files as part of a service archive (SAR). Again, if the SAR is scoped, the bindings contained in the <code class="filename">-aop.xml</code> files will only apply to the contents of the SAR file. It is not currently possible to deploy a standalone <code class="filename">-aop.xml</code> file and have that attach to a scoped deployment. Standalone <code class="filename">-aop.xml</code> files will apply to classes in the whole application server.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="idm139776686833920">
      ⁠</a>12.9.2. Attaching to a scoped deployment</h2></div></div></div><div class="para">
				If you have an application that uses classloader isolation, as long as you have prepared your classes, you can later attach an AOP file to that deployment. If we have an EAR file scoped using a <code class="filename">jboss-app.xml</code> file, with the scoped loader repository <code class="literal">jboss.test:service=scoped</code>:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss-app&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;loader-repository&gt;</span>
<span xmlns="" class="line">​</span>        jboss.test:service=scoped
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/loader-repository&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss-app&gt;</span>
</pre><div class="para">
				We can later deploy an AOP file containing aspects and configuration to attach that deployment to the scoped EAR. This is done using the <code class="literal">loader-repository</code> tag in the AOP file's <code class="filename">META-INF/jboss-aop.xml</code> file.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0" encoding="UTF-8"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;aop&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;loader-repository&gt;</span>jboss.test:service=scoped<span xmlns="" class="perl_Keyword">&lt;/loader-repository&gt;</span>
<span xmlns="" class="line">​</span>                                    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- Aspects and bindings --&gt;</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/aop&gt;</span>
</pre><div class="para">
				This has the same effect as deploying the AOP file as part of the EAR as we saw previously, but allows you to hot deploy aspects into your scoped application.
			</div></div></div></div></body></html>