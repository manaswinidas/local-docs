<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 30. EJBs on JBoss</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="EJBs_on_JBoss">
      ⁠</a>Chapter 30. EJBs on JBoss</h1></div><div><h3 class="subtitle"><em>The EJB Container Configuration and Architecture</em></h3></div></div></div><div class="para">
		The JBoss EJB container architecture employs a modular plug-in approach. All key aspects of the EJB container may be replaced by custom versions of a plug-in and/or an interceptor by a developer. This approach allows for fine tuned customization of the EJB container behavior to optimally suite your needs. Most of the EJB container behavior is configurable through the EJB JAR <code class="literal">META-INF/jboss.xml</code> descriptor and the default server-wide equivalent <code class="literal">standardjboss.xml</code> descriptor. We will look at various configuration capabilities throughout this chapter as we explore the container architecture.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="EJBs_on_JBoss-The_EJB_Client_Side_View">
      ⁠</a>30.1. The EJB Client Side View</h1></div></div></div><div class="para">
			We will begin our tour of the EJB container by looking at the client view of an EJB through the home and remote proxies. It is the responsibility of the container provider to generate the <code class="literal">javax.ejb.EJBHome</code> and <code class="literal">javax.ejb.EJBObject</code> for an EJB implementation. A client never references an EJB bean instance directly, but rather references the <code class="literal">EJBHome</code> which implements the bean home interface, and the <code class="literal">EJBObject</code> which implements the bean remote interface. <a class="xref" href="EJBs_on_JBoss.html#The_EJB_Client_Side_View-The_composition_of_an_EJBHome_proxy_in_JBoss.">Figure 30.1, “The composition of an EJBHome proxy in JBoss.”</a> shows the composition of an EJB home proxy and its relation to the EJB deployment.
		</div><div class="figure"><a id="The_EJB_Client_Side_View-The_composition_of_an_EJBHome_proxy_in_JBoss.">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/ejbhomeproxy.png" align="middle" alt="The composition of an EJBHome proxy in JBoss." style="text-align: middle"/></div></div><p class="title"><strong>Figure 30.1. The composition of an EJBHome proxy in JBoss.</strong></p></div><div class="para">
			The numbered items in the figure are:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
					The EJBDeployer (<code class="literal">org.jboss.ejb.EJBDeployer</code>) is invoked to deploy an EJB JAR. An <code class="literal">EJBModule</code> (<code class="literal">org.jboss.ejb.EJBModule</code>) is created to encapsulate the deployment metadata.
				</div></li><li class="listitem"><div class="para">
					The create phase of the <code class="literal">EJBModule</code> life cycle creates an <code class="literal">EJBProxyFactory</code> (<code class="literal">org.jboss.ejb.EJBProxyFactory</code>) that manages the creation of EJB home and remote interface proxies based on the <code class="literal">EJBModule</code><code class="literal">invoker-proxy-bindings</code> metadata. There can be multiple proxy factories associated with an EJB and we will look at how this is defined shortly.
				</div></li><li class="listitem"><div class="para">
					The <code class="literal">ProxyFactory</code> constructs the logical proxies and binds the homes into JNDI. A logical proxy is composed of a dynamic <code class="literal">Proxy</code> (<code class="literal">java.lang.reflect.Proxy</code>), the home interfaces of the EJB that the proxy exposes, the <code class="literal">ProxyHandler</code> (<code class="literal">java.lang.reflect.InvocationHandler</code>) implementation in the form of the <code class="literal">ClientContainer</code> (<code class="literal">org.jboss.proxy.ClientContainer</code>), and the client side interceptors.
				</div></li><li class="listitem"><div class="para">
					The proxy created by the <code class="literal">EJBProxyFactory</code> is a standard dynamic proxy. It is a serializable object that proxies the EJB home and remote interfaces as defined in the <code class="literal">EJBModule</code> metadata. The proxy translates requests made through the strongly typed EJB interfaces into a detyped invocation using the <code class="literal">ClientContainer</code> handler associated with the proxy. It is the dynamic proxy instance that is bound into JNDI as the EJB home interface that clients lookup. When a client does a lookup of an EJB home, the home proxy is transported into the client VM along with the <code class="literal">ClientContainer</code> and its interceptors. The use of dynamic proxies avoids the EJB specific compilation step required by many other EJB containers.
				</div></li><li class="listitem"><div class="para">
					The EJB home interface is declared in the ejb-jar.xml descriptor and available from the EJBModule metadata. A key property of dynamic proxies is that they are seen to implement the interfaces they expose. This is true in the sense of Java's strong type system. A proxy can be cast to any of the home interfaces and reflection on the proxy provides the full details of the interfaces it proxies.
				</div></li><li class="listitem"><div class="para">
					The proxy delegates calls made through any of its interfaces to the <code class="literal">ClientContainer</code> handler. The single method required of the handler is: <code class="literal">public Object invoke(Object proxy, Method m, Object[] args) throws Throwable</code>. The <code class="literal">EJBProxyFactory</code> creates a <code class="literal">ClientContainer</code> and assigns this as the <code class="literal">ProxyHandler</code>. The <code class="literal">ClientContainer</code>'s state consists of an <code class="literal">InvocationContext</code> (<code class="literal">org.jboss.invocation.InvocationContext</code>) and a chain of interceptors (<code class="literal">org.jboss.proxy.Interceptor</code>). The <code class="literal">InvocationContext</code> contains:
				</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
							the JMX <code class="literal">ObjectName</code> of the EJB container MBean the <code class="literal">Proxy</code> is associated with
						</div></li><li class="listitem"><div class="para">
							the <code class="literal">javax.ejb.EJBMetaData</code> for the EJB
						</div></li><li class="listitem"><div class="para">
							the JNDI name of the EJB home interface
						</div></li><li class="listitem"><div class="para">
							the transport specific invoker (<code class="literal">org.jboss.invocation.Invoker</code>)
						</div></li></ul></div><div class="para">
					The interceptor chain consists of the functional units that make up the EJB home or remote interface behavior. This is a configurable aspect of an EJB as we will see when we discuss the <code class="literal">jboss.xml</code> descriptor, and the interceptor makeup is contained in the <code class="literal">EJBModule</code> metadata. Interceptors (<code class="literal">org.jboss.proxy.Interceptor</code>) handle the different EJB types, security, transactions and transport. You can add your own interceptors as well.
				</div></li><li class="listitem"><div class="para">
					The transport specific invoker associated with the proxy has an association to the server side detached invoker that handles the transport details of the EJB method invocation. The detached invoker is a server side component.
				</div></li></ol></div><div class="para">
			The configuration of the client side interceptors is done using the <code class="literal">jboss.xml</code><code class="literal">client-interceptors</code> element. When the <code class="literal">ClientContainer</code> invoke method is called it creates an un-typed <code class="literal">Invocation</code> (<code class="literal">org.jboss.invocation.Invocation</code>) to encapsulate request. This is then passed through the interceptor chain. The last interceptor in the chain will be the transport handler that knows how to send the request to the server and obtain the reply, taking care of the transport specific details.
		</div><div class="para">
			As an example of the client interceptor configuration usage, consider the default stateless session bean configuration found in the <code class="literal">server/production/standardjboss.xml</code> descriptor. <a class="xref" href="EJBs_on_JBoss.html#The_EJB_Client_Side_View-The_client_interceptors_from_the_Standard_Stateless_SessionBean_configuration.">Example 30.1, “The client-interceptors from the Standard Stateless SessionBean configuration.”</a> shows the <code class="literal">stateless-rmi-invoker</code> client interceptors configuration referenced by the Standard Stateless SessionBean.
		</div><div class="example"><a id="The_EJB_Client_Side_View-The_client_interceptors_from_the_Standard_Stateless_SessionBean_configuration.">
      ⁠</a><p class="title"><strong>Example 30.1. The client-interceptors from the Standard Stateless SessionBean configuration.</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;invoker-proxy-binding&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;name&gt;</span>stateless-rmi-invoker<span xmlns="" class="perl_Keyword">&lt;/name&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;invoker-mbean&gt;</span>jboss:service=invoker,type=jrmp<span xmlns="" class="perl_Keyword">&lt;/invoker-mbean&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;proxy-factory&gt;</span>org.jboss.proxy.ejb.ProxyFactory<span xmlns="" class="perl_Keyword">&lt;/proxy-factory&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;proxy-factory-config&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;client-interceptors&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;home&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.ejb.HomeInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.TransactionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> call-by-value=</span><span xmlns="" class="perl_String">"false"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>                    org.jboss.invocation.InvokerInterceptor
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> call-by-value=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>                    org.jboss.invocation.MarshallingInvokerInterceptor
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/home&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;bean&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.ejb.StatelessSessionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.TransactionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> call-by-value=</span><span xmlns="" class="perl_String">"false"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>                    org.jboss.invocation.InvokerInterceptor
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> call-by-value=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>                    org.jboss.invocation.MarshallingInvokerInterceptor
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/bean&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/client-interceptors&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/proxy-factory-config&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/invoker-proxy-binding&gt;</span>
</pre><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;container-configuration&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;container-name&gt;</span>Standard Stateless SessionBean<span xmlns="" class="perl_Keyword">&lt;/container-name&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;call-logging&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/call-logging&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;invoker-proxy-binding-name&gt;</span>stateless-rmi-invoker<span xmlns="" class="perl_Keyword">&lt;/invoker-proxy-binding-name&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- ... --&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/container-configuration&gt;</span>
</pre></div></div><div class="para">
			This is the client interceptor configuration for stateless session beans that is used in the absence of an EJB JAR <code class="literal">META-INF/jboss.xml</code> configuration that overrides these settings. The functionality provided by each client interceptor is:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					<span class="bold bold"><strong>org.jboss.proxy.ejb.HomeInterceptor</strong></span>: handles the <code class="literal">getHomeHandle</code>, <code class="literal">getEJBMetaData</code>, and remove methods of the <code class="literal">EJBHome</code> interface locally in the client VM. Any other methods are propagated to the next interceptor.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>org.jboss.proxy.ejb.StatelessSessionInterceptor</strong></span>: handles the <code class="literal">toString</code>, <code class="literal">equals</code>, <code class="literal">hashCode</code>, <code class="literal">getHandle</code>, <code class="literal">getEJBHome</code> and <code class="literal">isIdentical</code> methods of the <code class="literal">EJBObject</code> interface locally in the client VM. Any other methods are propagated to the next interceptor.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>org.jboss.proxy.SecurityInterceptor</strong></span>: associates the current security context with the method invocation for use by other interceptors or the server.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>org.jboss.proxy.TransactionInterceptor</strong></span>: associates any active transaction with the invocation method invocation for use by other interceptors.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>org.jboss.invocation.InvokerInterceptor</strong></span>: encapsulates the dispatch of the method invocation to the transport specific invoker. It knows if the client is executing in the same VM as the server and will optimally route the invocation to a by reference invoker in this situation. When the client is external to the server VM, this interceptor delegates the invocation to the transport invoker associated with the invocation context. In the case of the <a class="xref" href="EJBs_on_JBoss.html#The_EJB_Client_Side_View-The_client_interceptors_from_the_Standard_Stateless_SessionBean_configuration.">Example 30.1, “The client-interceptors from the Standard Stateless SessionBean configuration.”</a> configuration, this would be the invoker stub associated with the <code class="literal">jboss:service=invoker,type=jrmp</code>, the <code class="literal">JRMPInvoker</code> service.
				</div><div class="para">
					<span class="bold bold"><strong>org.jboss.invocation.MarshallingInvokerInterceptor</strong></span>: extends the <code class="literal">InvokerInterceptor</code> to not optimize in-VM invocations. This is used to force <code class="literal">call-by-value</code> semantics for method calls.
				</div></li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="The_EJB_Client_Side_View-Specifying_the_EJB_Proxy_Configuration">
      ⁠</a>30.1.1. Specifying the EJB Proxy Configuration</h2></div></div></div><div class="para">
				To specify the EJB invocation transport and the client proxy interceptor stack, you need to define an <code class="literal">invoker-proxy-binding</code> in either the EJB JAR <code class="literal">META-INF/jboss.xml descriptor</code>, or the server <code class="literal">standardjboss.xml</code> descriptor. There are several default <code class="literal">invoker-proxy-bindings</code> defined in the <code class="literal">standardjboss.xml</code> descriptor for the various default EJB container configurations and the standard RMI/JRMP and RMI/IIOP transport protocols. The current default proxy configurations are:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>entity-rmi-invoker</strong></span>: a RMI/JRMP configuration for entity beans
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>clustered-entity-rmi-invoker</strong></span>: a RMI/JRMP configuration for clustered entity beans
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>stateless-rmi-invoker</strong></span>: a RMI/JRMP configuration for stateless session beans
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>clustered-stateless-rmi-invoker</strong></span>: a RMI/JRMP configuration for clustered stateless session beans
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>stateful-rmi-invoker</strong></span>: a RMI/JRMP configuration for clustered stateful session beans
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>clustered-stateful-rmi-invoker</strong></span>: a RMI/JRMP configuration for clustered stateful session beans
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>message-driven-bean</strong></span>: a JMS invoker for message driven beans
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>singleton-message-driven-bean</strong></span>: a JMS invoker for singleton message driven beans
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>message-inflow-driven-bean</strong></span>: a JMS invoker for message inflow driven beans
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>jms-message-inflow-driven-bean</strong></span>: a JMS inflow invoker for standard message driven beans
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>iiop</strong></span>: a RMI/IIOP for use with session and entity beans.
					</div></li></ul></div><div class="para">
				To introduce a new protocol binding, or customize the proxy factory, or the client side interceptor stack, requires defining a new <code class="literal">invoker-proxy-binding</code>. The full <code class="literal">invoker-proxy-binding</code> DTD fragment for the specification of the proxy configuration is given in <a class="xref" href="EJBs_on_JBoss.html#Specifying_the_EJB_Proxy_Configuration-The_invoker_proxy_binding_schema">Figure 30.2, “The invoker-proxy-binding schema”</a>.
			</div><div class="figure"><a id="Specifying_the_EJB_Proxy_Configuration-The_invoker_proxy_binding_schema">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jboss_4_0_invoker_proxy_binding.png" align="middle" alt="The invoker-proxy-binding schema" style="text-align: middle"/></div></div><p class="title"><strong>Figure 30.2. The invoker-proxy-binding schema</strong></p></div><div class="para">
				The <code class="literal">invoker-proxy-binding</code> child elements are:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>name</strong></span>: The <code class="literal">name</code> element gives a unique name for the <code class="literal">invoker-proxy-binding</code>. The name is used to reference the binding from the EJB container configuration when setting the default proxy binding as well as the EJB deployment level to specify addition proxy bindings. You will see how this is done when we look at the <code class="literal">jboss.xml</code> elements that control the server side EJB container configuration.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>invoker-mbean</strong></span>: The <code class="literal">invoker-mbean</code> element gives the JMX <code class="literal">ObjectName</code> string of the detached invoker MBean service the proxy invoker will be associated with.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>proxy-factory</strong></span>: The <code class="literal">proxy-factory</code> element specifies the fully qualified class name of the proxy factory, which must implement the <code class="literal">org.jboss.ejb.EJBProxyFactory</code> interface. The <code class="literal">EJBProxyFactory</code> handles the configuration of the proxy and the association of the protocol specific invoker and context. The current JBoss implementations of the <code class="literal">EJBProxyFactory</code> interface include:
					</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
								<span class="bold bold"><strong>org.jboss.proxy.ejb.ProxyFactory</strong></span>: The RMI/JRMP specific factory.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>org.jboss.proxy.ejb.ProxyFactoryHA</strong></span>: The cluster RMI/JRMP specific factory.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>org.jboss.ejb.plugins.jms.JMSContainerInvoker</strong></span>: The JMS specific factory.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>org.jboss.proxy.ejb.IORFactory</strong></span>: The RMI/IIOP specific factory.
							</div></li></ul></div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>proxy-factory-config</strong></span>: The <code class="literal">proxy-factory-config</code> element specifies additional information for the <code class="literal">proxy-factory</code> implementation. Unfortunately, its currently an unstructured collection of elements. Only a few of the elements apply to each type of proxy factory. The child elements break down into the three invocation protocols: RMI/RJMP, RMI/IIOP and JMS.
					</div></li></ul></div><div class="para">
				For the RMI/JRMP specific proxy factories, <code class="literal">org.jboss.proxy.ejb.ProxyFactory</code> and <code class="literal">org.jboss.proxy.ejb.ProxyFactoryHA</code> the following elements apply:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>client-interceptors</strong></span>: The <code class="literal">client-interceptors</code> define the home, remote and optionally the multi-valued proxy interceptor stacks.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>web-class-loader</strong></span>: The web class loader defines the instance of the <code class="literal">org.jboss.web.WebClassLoader</code> that should be associated with the proxy for dynamic class loading.
					</div></li></ul></div><div class="para">
				The following <code class="literal">proxy-factory-config</code> is for an entity bean accessed over RMI.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;proxy-factory-config&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;client-interceptors&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;home&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.ejb.HomeInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.TransactionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> call-by-value=</span><span xmlns="" class="perl_String">"false"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>                org.jboss.invocation.InvokerInterceptor
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> call-by-value=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>                org.jboss.invocation.MarshallingInvokerInterceptor
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/home&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;bean&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.ejb.EntityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.TransactionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> call-by-value=</span><span xmlns="" class="perl_String">"false"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>                org.jboss.invocation.InvokerInterceptor
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> call-by-value=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>                org.jboss.invocation.MarshallingInvokerInterceptor
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/bean&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;list-entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.ejb.ListEntityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.TransactionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> call-by-value=</span><span xmlns="" class="perl_String">"false"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>                org.jboss.invocation.InvokerInterceptor
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> call-by-value=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>                org.jboss.invocation.MarshallingInvokerInterceptor
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/list-entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/client-interceptors&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/proxy-factory-config&gt;</span>
</pre><div class="para">
				For the RMI/IIOP specific proxy factory, <code class="literal">org.jboss.proxy.ejb.IORFactory</code>, the following elements apply:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>web-class-loader</strong></span>: The web class loader defines the instance of the <code class="literal">org.jboss.web.WebClassLoader</code> that should be associated with the proxy for dynamic class loading.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>poa</strong></span>: The portable object adapter usage. Valid values are <code class="literal">per-servant</code> and <code class="literal">shared</code>.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>register-ejbs-in-jnp-context</strong></span>: A flag indicating if the EJBs should be register in JNDI.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>jnp-context</strong></span>: The JNDI context in which to register EJBs.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>interface-repository-supported</strong></span>: This indicates whether or not a deployed EJB has its own CORBA interface repository.
					</div></li></ul></div><div class="para">
				The following shows a <code class="literal">proxy-factory-config</code> for EJBs accessed over IIOP.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;proxy-factory-config&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;web-class-loader&gt;</span>org.jboss.iiop.WebCL<span xmlns="" class="perl_Keyword">&lt;/web-class-loader&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;poa&gt;</span>per-servant<span xmlns="" class="perl_Keyword">&lt;/poa&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;register-ejbs-in-jnp-context&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/register-ejbs-in-jnp-context&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;jnp-context&gt;</span>iiop<span xmlns="" class="perl_Keyword">&lt;/jnp-context&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/proxy-factory-config&gt;</span>
</pre><div class="para">
				For the JMS specific proxy factory, <code class="literal">org.jboss.ejb.plugins.jms.JMSContainerInvoker</code>, the following elements apply:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>MinimumSize</strong></span>: This specifies the minimum pool size for MDBs processing. This defaults to 1.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>MaximumSize</strong></span>: This specifies the upper limit to the number of concurrent MDBs that will be allowed for the JMS destination. This defaults to 15.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>MaxMessages</strong></span>: This specifies the <code class="literal">maxMessages</code> parameter value for the <code class="literal">createConnectionConsumer</code> method of <code class="literal">javax.jms.QueueConnection</code> and <code class="literal">javax.jms.TopicConnection</code> interfaces, as well as the <code class="literal">maxMessages</code> parameter value for the <code class="literal">createDurableConnectionConsumer</code> method of <code class="literal">javax.jms.TopicConnection</code>. It is the maximum number of messages that can be assigned to a server session at one time. This defaults to 1. This value should not be modified from the default unless your JMS provider indicates this is supported.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>KeepAliveMillis</strong></span>: This specifies the keep alive time interval in milliseconds for sessions in the session pool. The default is 30000 (30 seconds).
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>MDBConfig</strong></span>: Configuration for the MDB JMS connection behavior. Among the elements supported are:
					</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
								<span class="bold bold"><strong>ReconnectIntervalSec</strong></span>: The time to wait (in seconds) before trying to recover the connection to the JMS server.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>DeliveryActive</strong></span>: Whether or not the MDB is active at start up. The default is true.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>DLQConfig</strong></span>: Configuration for an MDB's dead letter queue, used when messages are redelivered too many times.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>JMSProviderAdapterJNDI</strong></span>: The JNDI name of the JMS provider adapter in the <code class="literal">java:/</code> namespace. This is mandatory for an MDB and must implement <code class="literal">org.jboss.jms.jndi.JMSProviderAdapter</code>.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>ServerSessionPoolFactoryJNDI</strong></span>: The JNDI name of the session pool in the <code class="literal">java:/</code> namespace of the JMS provider's session pool factory. This is mandatory for an MDB and must implement <code class="literal">org.jboss.jms.asf.ServerSessionPoolFactory</code>.
							</div></li></ul></div></li></ul></div><div class="para">
				<a class="xref" href="EJBs_on_JBoss.html#Specifying_the_EJB_Proxy_Configuration-A_sample_JMSContainerInvoker_proxy_factory_config">Example 30.2, “A sample JMSContainerInvoker proxy-factory-config”</a> gives a sample <code class="literal">proxy-factory-config</code> fragment taken from the <code class="literal">standardjboss.xml</code> descriptor.
			</div><div class="example"><a id="Specifying_the_EJB_Proxy_Configuration-A_sample_JMSContainerInvoker_proxy_factory_config">
      ⁠</a><p class="title"><strong>Example 30.2. A sample JMSContainerInvoker proxy-factory-config</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;proxy-factory-config&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;JMSProviderAdapterJNDI&gt;</span>DefaultJMSProvider<span xmlns="" class="perl_Keyword">&lt;/JMSProviderAdapterJNDI&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;ServerSessionPoolFactoryJNDI&gt;</span>StdJMSPool<span xmlns="" class="perl_Keyword">&lt;/ServerSessionPoolFactoryJNDI&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;MinimumSize&gt;</span>1<span xmlns="" class="perl_Keyword">&lt;/MinimumSize&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;MaximumSize&gt;</span>15<span xmlns="" class="perl_Keyword">&lt;/MaximumSize&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;KeepAliveMillis&gt;</span>30000<span xmlns="" class="perl_Keyword">&lt;/KeepAliveMillis&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;MaxMessages&gt;</span>1<span xmlns="" class="perl_Keyword">&lt;/MaxMessages&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;MDBConfig&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;ReconnectIntervalSec&gt;</span>10<span xmlns="" class="perl_Keyword">&lt;/ReconnectIntervalSec&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;DLQConfig&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;DestinationQueue&gt;</span>queue/DLQ<span xmlns="" class="perl_Keyword">&lt;/DestinationQueue&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;MaxTimesRedelivered&gt;</span>10<span xmlns="" class="perl_Keyword">&lt;/MaxTimesRedelivered&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;TimeToLive&gt;</span>0<span xmlns="" class="perl_Keyword">&lt;/TimeToLive&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/DLQConfig&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/MDBConfig&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/proxy-factory-config&gt;</span>
</pre></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="EJBs_on_JBoss-The_EJB_Server_Side_View">
      ⁠</a>30.2. The EJB Server Side View</h1></div></div></div><div class="para">
			Every EJB invocation must end up at a server hosted EJB container. In this section we will look at how invocations are transported to the server VM and find their way to the EJB container via the JMX bus.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="The_EJB_Server_Side_View-Detached_Invokers___The_Transport_Middlemen">
      ⁠</a>30.2.1. Detached Invokers - The Transport Middlemen</h2></div></div></div><div class="para">
				We looked at the detached invoker architecture in the context of exposing RMI compatible interfaces of MBean services earlier. Here we will look at how detached invokers are used to expose the EJB container home and bean interfaces to clients. The generic view of the invoker architecture is presented in <a class="xref" href="EJBs_on_JBoss.html#Detached_Invokers___The_Transport_Middlemen-The_transport_invoker_server_side_architecture">Figure 30.3, “The transport invoker server side architecture”</a>.
			</div><div class="figure"><a id="Detached_Invokers___The_Transport_Middlemen-The_transport_invoker_server_side_architecture">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/invoker-architecture.png" align="middle" alt="The transport invoker server side architecture" style="text-align: middle"/></div></div><p class="title"><strong>Figure 30.3. The transport invoker server side architecture</strong></p></div><div class="para">
				For each type of home proxy there is a binding to an invoker and its associated transport protocol. A container may have multiple invocation protocols active simultaneously. In the <code class="literal">jboss.xml</code> file, an <code class="literal">invoker-proxy-binding-name</code> maps to an <code class="literal">invoker-proxy-binding/name</code> element. At the <code class="literal">container-configuration</code> level this specifies the default invoker that will be used for EJBs deployed to the container. At the bean level, the <code class="literal">invoker-bindings</code> specify one or more invokers to use with the EJB container MBean.
			</div><div class="para">
				When one specifies multiple invokers for a given EJB deployment, the home proxy must be given a unique JNDI binding location. This is specified by the <code class="literal">invoker/jndi-name</code> element value. Another issue when multiple invokers exist for an EJB is how to handle remote homes or interfaces obtained when the EJB calls other beans. Any such interfaces need to use the same invoker used to call the outer EJB in order for the resulting remote homes and interfaces to be compatible with the proxy the client has initiated the call through. The <code class="literal">invoker/ejb-ref</code> elements allow one to map from a protocol independent ENC <code class="literal">ejb-ref</code> to the home proxy binding for <code class="literal">ejb-ref</code> target EJB home that matches the referencing invoker type.
			</div><div class="para">
				An example of using a custom <code class="literal">JRMPInvoker</code> MBean that enables compressed sockets for session beans can be found in the <code class="literal">org.jboss.test.jrmp</code> package of the testsuite. The following example illustrates the custom <code class="literal">JRMPInvoker</code> configuration and its mapping to a stateless session bean.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;server&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.invocation.jrmp.server.JRMPInvoker"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">          name=</span><span xmlns="" class="perl_String">"jboss:service=invoker,type=jrmp,socketType=CompressionSocketFactory"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"RMIObjectPort"</span><span xmlns="" class="perl_Keyword">&gt;</span>4445<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"RMIClientSocketFactory"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            org.jboss.test.jrmp.ejb.CompressionClientSocketFactory
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"RMIServerSocketFactory"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            org.jboss.test.jrmp.ejb.CompressionServerSocketFactory
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/server&gt;</span>
</pre><div class="para">
				Here the default <code class="literal">JRMPInvoker</code> has been customized to bind to port 4445 and to use custom socket factories that enable compression at the transport level.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_DataType">&lt;!DOCTYPE </span>jboss PUBLIC
<span xmlns="" class="line">​</span>          "-//JBoss//DTD JBOSS 3.2//EN"
<span xmlns="" class="line">​</span>          "http://www.jboss.org/j2ee/dtd/jboss_3_2.dtd"<span xmlns="" class="perl_DataType">&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">&lt;!-- The jboss.xml descriptor for the jrmp-comp.jar ejb unit --&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;session&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>StatelessSession<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;configuration-name&gt;</span>Standard Stateless SessionBean<span xmlns="" class="perl_Keyword">&lt;/configuration-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;invoker-bindings&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;invoker&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;invoker-proxy-binding-name&gt;</span>
<span xmlns="" class="line">​</span>                        stateless-compression-invoker
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/invoker-proxy-binding-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;jndi-name&gt;</span>jrmp-compressed/StatelessSession<span xmlns="" class="perl_Keyword">&lt;/jndi-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/invoker&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/invoker-bindings&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/session&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>                    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;invoker-proxy-bindings&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;invoker-proxy-binding&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;name&gt;</span>stateless-compression-invoker<span xmlns="" class="perl_Keyword">&lt;/name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;invoker-mbean&gt;</span>
<span xmlns="" class="line">​</span>                jboss:service=invoker,type=jrmp,socketType=CompressionSocketFactory
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/invoker-mbean&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;proxy-factory&gt;</span>org.jboss.proxy.ejb.ProxyFactory<span xmlns="" class="perl_Keyword">&lt;/proxy-factory&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;proxy-factory-config&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;client-interceptors&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;home&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.ejb.HomeInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.TransactionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.invocation.InvokerInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/home&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;bean&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>
<span xmlns="" class="line">​</span>                            org.jboss.proxy.ejb.StatelessSessionInterceptor
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.TransactionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.invocation.InvokerInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/bean&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/client-interceptors&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/proxy-factory-config&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/invoker-proxy-binding&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/invoker-proxy-bindings&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss&gt;</span>
</pre><div class="para">
				The <code class="literal">StatelessSession</code> EJB <code class="literal">invoker-bindings</code> settings specify that the <code class="literal">stateless-compression-invoker</code> will be used with the home interface bound under the JNDI name <code class="literal">jrmp-compressed/StatelessSession</code>. The <code class="literal">stateless-compression-invoker</code> is linked to the custom JRMP invoker we just declared.
			</div><div class="para">
				The following example, <code class="literal">org.jboss.test.hello</code> testsuite package, is an example of using the <code class="literal">HttpInvoker</code> to configure a stateless session bean to use the RMI/HTTP protocol.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0" encoding="UTF-8"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_DataType">&lt;!DOCTYPE </span>jboss PUBLIC
<span xmlns="" class="line">​</span>          "-//JBoss//DTD JBOSS 3.2//EN"
<span xmlns="" class="line">​</span>          "http://www.jboss.org/j2ee/dtd/jboss_3_2.dtd"<span xmlns="" class="perl_DataType">&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;session&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>HelloWorldViaHTTP<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;jndi-name&gt;</span>helloworld/HelloHTTP<span xmlns="" class="perl_Keyword">&lt;/jndi-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;invoker-bindings&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;invoker&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;invoker-proxy-binding-name&gt;</span>
<span xmlns="" class="line">​</span>                        stateless-http-invoker
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/invoker-proxy-binding-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/invoker&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/invoker-bindings&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/session&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;invoker-proxy-bindings&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">&lt;!-- A custom invoker for RMI/HTTP --&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;invoker-proxy-binding&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;name&gt;</span>stateless-http-invoker<span xmlns="" class="perl_Keyword">&lt;/name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;invoker-mbean&gt;</span>jboss:service=invoker,type=http<span xmlns="" class="perl_Keyword">&lt;/invoker-mbean&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;proxy-factory&gt;</span>org.jboss.proxy.ejb.ProxyFactory<span xmlns="" class="perl_Keyword">&lt;/proxy-factory&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;proxy-factory-config&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;client-interceptors&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;home&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.ejb.HomeInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.TransactionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.invocation.InvokerInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/home&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;bean&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>
<span xmlns="" class="line">​</span>                            org.jboss.proxy.ejb.StatelessSessionInterceptor
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.TransactionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.invocation.InvokerInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/bean&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/client-interceptors&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/proxy-factory-config&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/invoker-proxy-binding&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/invoker-proxy-bindings&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss&gt;</span>
</pre><div class="para">
				Here a custom invoker-proxy-binding named <code class="literal">stateless-http-invoker</code> is defined. It uses the <code class="literal">HttpInvoker</code> MBean as the detached invoker. The <code class="literal">jboss:service=invoker,type=http</code> name is the default name of the <code class="literal">HttpInvoker</code> MBean as found in the <code class="literal">http-invoker.sar/META-INF/jboss-service.xml</code> descriptor, and its service descriptor fragment is show here:
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">&lt;!-- The HTTP invoker service configuration --&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.invocation.http.server.HttpInvoker"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">       name=</span><span xmlns="" class="perl_String">"jboss:service=invoker,type=http"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- Use a URL of the form http://&lt;hostname&gt;:8080/invoker/EJBInvokerServlet</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         where &lt;hostname&gt; is InetAddress.getHostname value on which the server</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         is running. --&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"InvokerURLPrefix"</span><span xmlns="" class="perl_Keyword">&gt;</span>http://<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"InvokerURLSuffix"</span><span xmlns="" class="perl_Keyword">&gt;</span>:8080/invoker/EJBInvokerServlet<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"UseHostName"</span><span xmlns="" class="perl_Keyword">&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span>
</pre><div class="para">
				The client proxy posts the EJB invocation content to the <code class="literal">EJBInvokerServlet</code> URL specified in the <code class="literal">HttpInvoker</code> service configuration.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="The_EJB_Server_Side_View-The_HA_JRMPInvoker___Clustered_RMIJRMP_Transport">
      ⁠</a>30.2.2. The HA JRMPInvoker - Clustered RMI/JRMP Transport</h2></div></div></div><div class="para">
				The <code class="literal">org.jboss.invocation.jrmp.server.JRMPInvokerHA</code> service is an extension of the <code class="literal">JRMPInvoker</code> that is a cluster aware invoker. The <code class="literal">JRMPInvokerHA</code> fully supports all of the attributes of the <code class="literal">JRMPInvoker</code>. This means that customized bindings of the port, interface and socket transport are available to clustered RMI/JRMP as well. For additional information on the clustering architecture and the implementation of the HA RMI proxies see the JBoss Clustering docs.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="The_EJB_Server_Side_View-The_HA_HttpInvoker___Clustered_RMIHTTP_Transport">
      ⁠</a>30.2.3. The HA HttpInvoker - Clustered RMI/HTTP Transport</h2></div></div></div><div class="para">
				The RMI/HTTP layer allows for software load balancing of the invocations in a clustered environment. An HA capable extension of the HTTP invoker has been added that borrows much of its functionality from the HA-RMI/JRMP clustering.
			</div><div class="para">
				To enable HA-RMI/HTTP you need to configure the invokers for the EJB container. This is done through either a <code class="literal">jboss.xml</code> descriptor, or the <code class="literal">standardjboss.xml</code> descriptor. <a class="xref" href="EJBs_on_JBoss.html#The_HA_HttpInvoker___Clustered_RMIHTTP_Transport-A_jboss.xml_stateless_session_configuration_for_HA_RMIHTTP">Example 30.3, “A jboss.xml stateless session configuration for HA-RMI/HTTP”</a> shows is an example of a stateless session configuration taken from the <code class="literal">org.jboss.test.hello</code> testsuite package.
			</div><div class="example"><a id="The_HA_HttpInvoker___Clustered_RMIHTTP_Transport-A_jboss.xml_stateless_session_configuration_for_HA_RMIHTTP">
      ⁠</a><p class="title"><strong>Example 30.3. A jboss.xml stateless session configuration for HA-RMI/HTTP</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;session&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>HelloWorldViaClusteredHTTP<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;jndi-name&gt;</span>helloworld/HelloHA-HTTP<span xmlns="" class="perl_Keyword">&lt;/jndi-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;invoker-bindings&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;invoker&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;invoker-proxy-binding-name&gt;</span>
<span xmlns="" class="line">​</span>                        stateless-httpHA-invoker
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/invoker-proxy-binding-name&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/invoker&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/invoker-bindings&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;clustered&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/clustered&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/session&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;invoker-proxy-bindings&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;invoker-proxy-binding&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;name&gt;</span>stateless-httpHA-invoker<span xmlns="" class="perl_Keyword">&lt;/name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;invoker-mbean&gt;</span>jboss:service=invoker,type=httpHA<span xmlns="" class="perl_Keyword">&lt;/invoker-mbean&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;proxy-factory&gt;</span>org.jboss.proxy.ejb.ProxyFactoryHA<span xmlns="" class="perl_Keyword">&lt;/proxy-factory&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;proxy-factory-config&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;client-interceptors&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;home&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.ejb.HomeInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.TransactionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.invocation.InvokerInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/home&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;bean&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>
<span xmlns="" class="line">​</span>                            org.jboss.proxy.ejb.StatelessSessionInterceptor
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.proxy.TransactionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.invocation.InvokerInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;/bean&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/client-interceptors&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/proxy-factory-config&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/invoker-proxy-binding&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/invoker-proxy-bindings&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss&gt;</span>
</pre></div></div><div class="para">
				The <code class="literal">stateless-httpHA-invoker</code> invoker-proxy-binding references the <code class="literal">jboss:service=invoker,type=httpHA</code> invoker service. This service would be configured as shown below.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.invocation.http.server.HttpInvokerHA"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">       name=</span><span xmlns="" class="perl_String">"jboss:service=invoker,type=httpHA"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- Use a URL of the form</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         http://&lt;hostname&gt;:8080/invoker/EJBInvokerHAServlet</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         where &lt;hostname&gt; is InetAddress.getHostname value on which the server</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         is running.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">    --&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"InvokerURLPrefix"</span><span xmlns="" class="perl_Keyword">&gt;</span>http://<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"InvokerURLSuffix"</span><span xmlns="" class="perl_Keyword">&gt;</span>:8080/invoker/EJBInvokerHAServlet<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"UseHostName"</span><span xmlns="" class="perl_Keyword">&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span>
</pre><div class="para">
				The URL used by the invoker proxy is the <code class="literal">EJBInvokerHAServlet</code> mapping as deployed on the cluster node. The <code class="literal">HttpInvokerHA</code> instances across the cluster form a collection of candidate http URLs that are made available to the client side proxy for failover and/or load balancing.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="EJBs_on_JBoss-The_EJB_Container">
      ⁠</a>30.3. The EJB Container</h1></div></div></div><div class="para">
			An EJB container is the component that manages a particular class of EJB. In JBoss there is one instance of the <code class="literal">org.jboss.ejb.Container</code> created for each unique configuration of an EJB that is deployed. The actual object that is instantiated is a subclass of <code class="literal">Container</code> and the creation of the container instance is managed by the <code class="literal">EJBDeployer</code> MBean.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="The_EJB_Container-EJBDeployer_MBean">
      ⁠</a>30.3.1. EJBDeployer MBean</h2></div></div></div><div class="para">
				The <code class="literal">org.jboss.ejb.EJBDeployer</code> MBean is responsible for the creation of EJB containers. Given an EJB JAR that is ready for deployment, the <code class="literal">EJBDeployer</code> will create and initialize the necessary EJB containers, one for each type of EJB. The configurable attributes of the <code class="literal">EJBDeployer</code> are:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>VerifyDeployments</strong></span>: a boolean flag indicating if the EJB verifier should be run. This validates that the EJBs in a deployment unit conform to the EJB 2.1 specification. Setting this to true is useful for ensuring your deployments are valid.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>VerifierVerbose</strong></span>: A boolean that controls the verbosity of any verification failures/warnings that result from the verification process.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>StrictVerifier</strong></span>: A boolean that enables/disables strict verification. When strict verification is enable an EJB will deploy only if verifier reports no errors.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>CallByValue</strong></span>: a boolean flag that indicates call by value semantics should be used by default.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>ValidateDTDs</strong></span>: a boolean flag that indicates if the <code class="literal">ejb-jar.xml</code> and <code class="literal">jboss.xml</code> descriptors should be validated against their declared DTDs. Setting this to true is useful for ensuring your deployment descriptors are valid.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>MetricsEnabled</strong></span>: a boolean flag that controls whether container interceptors marked with an <code class="literal">metricsEnabled=true</code> attribute should be included in the configuration. This allows one to define a container interceptor configuration that includes metrics type interceptors that can be toggled on and off.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>WebServiceName</strong></span>: The JMX ObjectName string of the web service MBean that provides support for the dynamic class loading of EJB classes.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>TransactionManagerServiceName</strong></span>: The JMX ObjectName string of the JTA transaction manager service. This must have an attribute named <code class="literal">TransactionManager</code> that returns that <code class="literal">javax.transaction.TransactionManager</code> instance.
					</div></li></ul></div><div class="para">
				The deployer contains two central methods: deploy and undeploy. The deploy method takes a URL, which either points to an EJB JAR, or to a directory whose structure is the same as a valid EJB JAR (which is convenient for development purposes). Once a deployment has been made, it can be undeployed by calling undeploy on the same URL. A call to deploy with an already deployed URL will cause an undeploy, followed by deployment of the URL. JBoss has support for full re-deployment of both implementation and interface classes, and will reload any changed classes. This will allow you to develop and update EJBs without ever stopping a running server.
			</div><div class="para">
				During the deployment of the EJB JAR the <code class="literal">EJBDeployer</code> and its associated classes perform three main functions, verify the EJBs, create a container for each unique EJB, initialize the container with the deployment configuration information. We will talk about each function in the following sections.
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="EJBDeployer_MBean-Verifying_EJB_deployments">
      ⁠</a>30.3.1.1. Verifying EJB deployments</h3></div></div></div><div class="para">
					When the <code class="literal">VerifyDeployments</code> attribute of the <code class="literal">EJBDeployer</code> is true, the deployer performs a verification of EJBs in the deployment. The verification checks that an EJB meets EJB specification compliance. This entails validating that the EJB deployment unit contains the required home and remote, local home and local interfaces. It will also check that the objects appearing in these interfaces are of the proper types and that the required methods are present in the implementation class. This is a useful behavior that is enabled by default since there are a number of steps that an EJB developer and deployer must perform correctly to construct a proper EJB JAR, and it is easy to make a mistake. The verification stage attempts to catch any errors and fail the deployment with an error that indicates what needs to be corrected.
				</div><div class="para">
					Probably the most problematic aspect of writing EJBs is the fact that there is a disconnection between the bean implementation and its remote and home interfaces, as well as its deployment descriptor configuration. It is easy to have these separate elements get out of sync. One tool that helps eliminate this problem is XDoclet. It allows you to use custom JavaDoc-like tags in the EJB bean implementation class to generate the related bean interfaces, deployment descriptors and related objects. See the XDoclet home page, <a href="http://sourceforge.net/projects/xdoclet">http://sourceforge.net/projects/xdoclet</a> for additional details.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="EJBDeployer_MBean-Deploying_EJBs_Into_Containers">
      ⁠</a>30.3.1.2. Deploying EJBs Into Containers</h3></div></div></div><div class="para">
					The most important role performed by the <code class="literal">EJBDeployer</code> is the creation of an EJB container and the deployment of the EJB into the container. The deployment phase consists of iterating over EJBs in an EJB JAR, and extracting the bean classes and their metadata as described by the <code class="literal">ejb-jar.xml</code> and <code class="literal">jboss.xml</code> deployment descriptors. For each EJB in the EJB JAR, the following steps are performed:
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							Create subclass of <code class="literal">org.jboss.ejb.Container</code> depending on the type of the EJB: stateless, stateful, BMP entity, CMP entity, or message driven. The container is assigned a unique <code class="literal">ClassLoader</code> from which it can load local resources. The uniqueness of the <code class="literal">ClassLoader</code> is also used to isolate the standard <code class="literal">java:comp</code> JNDI namespace from other J2EE components.
						</div></li><li class="listitem"><div class="para">
							Set all container configurable attributes from a merge of the <code class="literal">jboss.xml</code> and <code class="literal">standardjboss.xml</code> descriptors.
						</div></li><li class="listitem"><div class="para">
							Create and add the container interceptors as configured for the container.
						</div></li><li class="listitem"><div class="para">
							Associate the container with an application object. This application object represents a J2EE enterprise application and may contain multiple EJBs and web contexts.
						</div></li></ul></div><div class="para">
					If all EJBs are successfully deployed, the application is started which in turn starts all containers and makes the EJBs available to clients. If any EJB fails to deploy, a deployment exception is thrown and the deployment module is failed.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="EJBDeployer_MBean-Container_configuration_information">
      ⁠</a>30.3.1.3. Container configuration information</h3></div></div></div><div class="para">
					JBoss externalizes most if not all of the setup of the EJB containers using an XML file that conforms to the <code class="literal">jboss_4_0.dtd</code>. The section DTD that relates to container configuration information is shown in <a class="xref" href="EJBs_on_JBoss.html#Container_configuration_information-The_jboss_4_0_DTD_elements_related_to_container_configuration.">Figure 30.4, “The jboss_4_0 DTD elements related to container configuration.”</a>.
				</div><div class="figure"><a id="Container_configuration_information-The_jboss_4_0_DTD_elements_related_to_container_configuration.">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jboss_4_0_container_configuration.png" align="middle" alt="The jboss_4_0 DTD elements related to container configuration." style="text-align: middle"/></div></div><p class="title"><strong>Figure 30.4. The jboss_4_0 DTD elements related to container configuration.</strong></p></div><div class="para">
					The <code class="literal">container-configuration</code> element and its subelements specify container configuration settings for a type of container as given by the <code class="literal">container-name</code> element. Each configuration specifies information such as the default invoker type, the container interceptor makeup, instance caches/pools and their sizes, persistence manager, security, and so on. Because this is a large amount of information that requires a detailed understanding of the JBoss container architecture, JBoss ships with a standard configuration for the four types of EJBs. This configuration file is called <code class="literal">standardjboss.xml</code> and it is located in the conf directory of any configuration file set that uses EJBs. The following is a sample of <code class="literal">container-configuration</code> from <code class="literal">standardjboss.xml</code>.
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;container-configuration&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;container-name&gt;</span>Standard CMP 2.x EntityBean<span xmlns="" class="perl_Keyword">&lt;/container-name&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;call-logging&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/call-logging&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;invoker-proxy-binding-name&gt;</span>entity-rmi-invoker<span xmlns="" class="perl_Keyword">&lt;/invoker-proxy-binding-name&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;sync-on-commit-only&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/sync-on-commit-only&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;insert-after-ejb-post-create&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/insert-after-ejb-post-create&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;call-ejb-store-on-clean&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/call-ejb-store-on-clean&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;container-interceptors&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.ProxyFactoryFinderInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.LogInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.TxInterceptorCMT<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.CallValidationInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> metricsEnabled=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            org.jboss.ejb.plugins.MetricsInterceptor
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.EntityCreationInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.EntityLockInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.EntityInstanceInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.EntityReentranceInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>
<span xmlns="" class="line">​</span>             org.jboss.resource.connectionmanager.CachedConnectionInterceptor
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.EntitySynchronizationInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.cmp.jdbc.JDBCRelationInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/container-interceptors&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;instance-pool&gt;</span>org.jboss.ejb.plugins.EntityInstancePool<span xmlns="" class="perl_Keyword">&lt;/instance-pool&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;instance-cache&gt;</span>org.jboss.ejb.plugins.InvalidableEntityInstanceCache<span xmlns="" class="perl_Keyword">&lt;/instance-cache&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;persistence-manager&gt;</span>org.jboss.ejb.plugins.cmp.jdbc.JDBCStoreManager<span xmlns="" class="perl_Keyword">&lt;/persistence-manager&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;locking-policy&gt;</span>org.jboss.ejb.plugins.lock.QueuedPessimisticEJBLock<span xmlns="" class="perl_Keyword">&lt;/locking-policy&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;container-cache-conf&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;cache-policy&gt;</span>org.jboss.ejb.plugins.LRUEnterpriseContextCachePolicy<span xmlns="" class="perl_Keyword">&lt;/cache-policy&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;cache-policy-conf&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;min-capacity&gt;</span>50<span xmlns="" class="perl_Keyword">&lt;/min-capacity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;max-capacity&gt;</span>1000000<span xmlns="" class="perl_Keyword">&lt;/max-capacity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;overager-period&gt;</span>300<span xmlns="" class="perl_Keyword">&lt;/overager-period&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;max-bean-age&gt;</span>600<span xmlns="" class="perl_Keyword">&lt;/max-bean-age&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;resizer-period&gt;</span>400<span xmlns="" class="perl_Keyword">&lt;/resizer-period&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;max-cache-miss-period&gt;</span>60<span xmlns="" class="perl_Keyword">&lt;/max-cache-miss-period&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;min-cache-miss-period&gt;</span>1<span xmlns="" class="perl_Keyword">&lt;/min-cache-miss-period&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;cache-load-factor&gt;</span>0.75<span xmlns="" class="perl_Keyword">&lt;/cache-load-factor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/cache-policy-conf&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/container-cache-conf&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;container-pool-conf&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;MaximumSize&gt;</span>100<span xmlns="" class="perl_Keyword">&lt;/MaximumSize&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/container-pool-conf&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;commit-option&gt;</span>B<span xmlns="" class="perl_Keyword">&lt;/commit-option&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/container-configuration&gt;</span>
</pre><div class="para">
					These two examples demonstrate how extensive the container configuration options are. The container configuration information can be specified at two levels. The first is in the <code class="literal">standardjboss.xml</code> file contained in the configuration file set directory. The second is at the EJB JAR level. By placing a <code class="literal">jboss.xml</code> file in the EJB JAR <code class="literal">META-INF</code> directory, you can specify either overrides for container configurations in the <code class="literal">standardjboss.xml</code> file, or entirely new named container configurations. This provides great flexibility in the configuration of containers. As you have seen, all container configuration attributes have been externalized and as such are easily modifiable. Knowledgeable developers can even implement specialized container components, such as instance pools or caches, and easily integrate them with the standard container configurations to optimize behavior for a particular application or environment.
				</div><div class="para">
					How an EJB deployment chooses its container configuration is based on the explicit or implicit <code class="literal">jboss/enterprise-beans/&lt;type&gt;/configuration-name</code> element. The <code class="literal">configuration-name</code> element is a link to a <code class="literal">container-configurations/container-configuration</code> element. It specifies which container configuration to use for the referring EJB. The link is from a <code class="literal">configuration-name</code> element to a <code class="literal">container-name</code> element.
				</div><div class="para">
					You are able to specify container configurations per class of EJB by including a <code class="literal">container-configuration</code> element in the EJB definition. Typically one does not define completely new container configurations, although this is supported. The typical usage of a <code class="literal">jboss.xml</code> level <code class="literal">container-configuration</code> is to override one or more aspects of a <code class="literal">container-configuration</code> coming from the <code class="literal">standardjboss.xml</code> descriptor. This is done by specifying <code class="literal">container-configuration</code> that references the name of an existing <code class="literal">standardjboss.xml</code><code class="literal">container-configuration/container-name</code> as the value for the <code class="literal">container-configuration/extends</code> attribute. The following example shows an example of defining a new <code class="literal">Secured Stateless SessionBean</code> configuration that is an extension of the <code class="literal">Standard Stateless SessionBean</code> configuration.
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;session&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>EchoBean<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;configuration-name&gt;</span>Secured Stateless SessionBean<span xmlns="" class="perl_Keyword">&lt;/configuration-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- ... --&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/session&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;container-configurations&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;container-configuration</span><span xmlns="" class="perl_Others"> extends=</span><span xmlns="" class="perl_String">"Standard Stateless SessionBean"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;container-name&gt;</span>Secured Stateless SessionBean<span xmlns="" class="perl_Keyword">&lt;/container-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Comment">&lt;!-- Override the container security domain --&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;security-domain&gt;</span>java:/jaas/my-security-domain<span xmlns="" class="perl_Keyword">&lt;/security-domain&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/container-configuration&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/container-configurations&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss&gt;</span>
</pre><div class="para">
					If an EJB does not provide a container configuration specification in the deployment unit EJB JAR, the container factory chooses a container configuration from the <code class="literal">standardjboss.xml</code> descriptor based on the type of the EJB. So, in reality there is an implicit <code class="literal">configuration-name</code> element for every type of EJB, and the mappings from the EJB type to default container configuration name are as follows:
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							container-managed persistence entity version 2.0 = Standard CMP 2.x EntityBean
						</div></li><li class="listitem"><div class="para">
							container-managed persistence entity version 1.1 = Standard CMP EntityBean
						</div></li><li class="listitem"><div class="para">
							bean-managed persistence entity = Standard BMP EntityBean
						</div></li><li class="listitem"><div class="para">
							stateless session = Standard Stateless SessionBean
						</div></li><li class="listitem"><div class="para">
							stateful session = Standard Stateful SessionBean
						</div></li><li class="listitem"><div class="para">
							message driven = Standard Message Driven Bean
						</div></li></ul></div><div class="para">
					It is not necessary to indicate which container configuration an EJB is using if you want to use the default based on the bean type. It probably provides for a more self-contained descriptor to include the <code class="literal">configuration-name</code> element, but this is purely a matter of style.
				</div><div class="para">
					Now that you know how to specify which container configuration an EJB is using and can define a deployment unit level override, we now will look at the <code class="literal">container-configuration</code> child elements in the following sections. A number of the elements specify interface class implementations whose configuration is affected by other elements, so before starting in on the configuration elements you need to understand the <code class="literal">org.jboss.metadata.XmlLoadable</code> interface.
				</div><div class="para">
					The <code class="literal">XmlLoadable</code> interface is a simple interface that consists of a single method. The interface definition is:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.w3c.dom.Element;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> XmlLoadable
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">importXml</span>(Element element) <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>}
</pre><div class="para">
					Classes implement this interface to allow their configuration to be specified via an XML document fragment. The root element of the document fragment is what would be passed to the <code class="literal">importXml</code> method. You will see a few examples of this as the container configuration elements are described in the following sections.
				</div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_container_name_element">
      ⁠</a>30.3.1.3.1. The container-name element</h4></div></div></div><div class="para">
						The <code class="literal">container-name</code> element specifies a unique name for a given configuration. EJBs link to a particular container configuration by setting their <code class="literal">configuration-name</code> element to the value of the <code class="literal">container-name</code> for the container configuration.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_call_logging_element">
      ⁠</a>30.3.1.3.2. The call-logging element</h4></div></div></div><div class="para">
						The <code class="literal">call-logging</code> element expects a boolean (true or false) as its value to indicate whether or not the <code class="literal">LogInterceptor</code> should log method calls to a container. This is somewhat obsolete with the change to log4j, which provides a fine-grained logging API.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_invoker_proxy_binding_name_element">
      ⁠</a>30.3.1.3.3. The invoker-proxy-binding-name element</h4></div></div></div><div class="para">
						The <code class="literal">invoker-proxy-binding-name</code> element specifies the name of the default invoker to use. In the absence of a bean level <code class="literal">invoker-bindings</code> specification, the <code class="literal">invoker-proxy-binding</code> whose name matches the <code class="literal">invoker-proxy-binding-name</code> element value will be used to create home and remote proxies.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_sync_on_commit_only_element">
      ⁠</a>30.3.1.3.4. The sync-on-commit-only element</h4></div></div></div><div class="para">
						This configures a performance optimization that will cause entity bean state to be synchronized with the database only at commit time. Normally the state of all the beans in a transaction would need to be synchronized when an finder method is called or when an remove method is called, for example.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-insert_after_ejb_post_create">
      ⁠</a>30.3.1.3.5. insert-after-ejb-post-create</h4></div></div></div><div class="para">
						This is another entity bean optimization which cause the database insert command for a new entity bean to be delayed until the <code class="literal">ejbPostCreate</code> method is called. This allows normal CMP fields as well as CMR fields to be set in a single insert, instead of the default insert followed by an update, which allows removes the requirement for relation ship fields to allow null values.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-call_ejb_store_on_clean">
      ⁠</a>30.3.1.3.6. call-ejb-store-on-clean</h4></div></div></div><div class="para">
						By the specification the container is required to call <code class="literal">ejbStore</code> method on an entity bean instance when transaction commits even if the instance was not modified in the transaction. Setting this to false will cause JBoss to only call <code class="literal">ejbStore</code> for dirty objects.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_container_interceptors_Element">
      ⁠</a>30.3.1.3.7. The container-interceptors Element</h4></div></div></div><div class="para">
						The <code class="literal">container-interceptors</code> element specifies one or more interceptor elements that are to be configured as the method interceptor chain for the container. The value of the interceptor element is a fully qualified class name of an <code class="literal">org.jboss.ejb.Interceptor</code> interface implementation. The container interceptors form a <code class="literal">linked-list</code> structure through which EJB method invocations pass. The first interceptor in the chain is invoked when the <code class="literal">MBeanServer</code> passes a method invocation to the container. The last interceptor invokes the business method on the bean. We will discuss the <code class="literal">Interceptor</code> interface latter in this chapter when we talk about the container plug-in framework. Generally, care must be taken when changing an existing standard EJB interceptor configuration as the EJB contract regarding security, transactions, persistence, and thread safety derive from the interceptors.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_instance_pool_element">
      ⁠</a>30.3.1.3.8. The instance-pool element</h4></div></div></div><div class="para">
						The <code class="literal">instance-pool</code> element specifies the fully qualified class name of an <code class="literal">org.jboss.ejb.InstancePool</code> interface implementation to use as the container <code class="literal">InstancePool</code>. We will discuss the InstancePool interface in detail latter in this chapter when we talk about the container plug-in framework.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_container_pool_conf_element">
      ⁠</a>30.3.1.3.9. The container-pool-conf element</h4></div></div></div><div class="para">
						The <code class="literal">container-pool-conf</code> is passed to the <code class="literal">InstancePool</code> implementation class given by the <code class="literal">instance-pool</code> element if it implements the <code class="literal">XmlLoadable</code> interface. All current JBoss <code class="literal">InstancePool</code> implementations derive from the <code class="literal">org.jboss.ejb.plugins.AbstractInstancePool</code> class which provides support for elements shown in <a class="xref" href="EJBs_on_JBoss.html#The_container_pool_conf_element-The_container_pool_conf_element_DTD">Figure 30.5, “The container-pool-conf element DTD”</a>.
					</div><div class="figure"><a id="The_container_pool_conf_element-The_container_pool_conf_element_DTD">
      ⁠</a><div class="figure-contents"><div class="mediaobject"><img src="images/jboss_4_0_container_pool_conf.png" alt="The container-pool-conf element DTD"/></div></div><p class="title"><strong>Figure 30.5. The container-pool-conf element DTD</strong></p></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
								<span class="bold bold"><strong>MinimumSize</strong></span>: The <code class="literal">MinimumSize</code> element gives the minimum number of instances to keep in the pool, although JBoss does not currently seed an <code class="literal">InstancePool</code> to the <code class="literal">MinimumSize</code> value.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>MaximumSize</strong></span>: The <code class="literal">MaximumSize</code> specifies the maximum number of pool instances that are allowed. The default use of <code class="literal">MaximumSize</code> may not be what you expect. The pool <code class="literal">MaximumSize</code> is the maximum number of EJB instances that are kept available, but additional instances can be created if the number of concurrent requests exceeds the <code class="literal">MaximumSize</code> value.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>strictMaximumSize</strong></span>: If you want to limit the maximum concurrency of an EJB to the pool <code class="literal">MaximumSize</code>, you need to set the <code class="literal">strictMaximumSize</code> element to true. When <code class="literal">strictMaximumSize</code> is true, only <code class="literal">MaximumSize</code> EJB instances may be active. When there are <code class="literal">MaximumSize</code> active instances, any subsequent requests will be blocked until an instance is freed back to the pool. The default value for <code class="literal">strictMaximumSize</code> is false.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>strictTimeout</strong></span>: How long a request blocks waiting for an instance pool object is controlled by the <code class="literal">strictTimeout</code> element. The <code class="literal">strictTimeout</code> defines the time in milliseconds to wait for an instance to be returned to the pool when there are <code class="literal">MaximumSize</code> active instances. A value less than or equal to 0 will mean not to wait at all. When a request times out waiting for an instance a <code class="literal">java.rmi.ServerException</code> is generated and the call aborted. This is parsed as a <code class="literal">Long</code> so the maximum possible wait time is 9,223,372,036,854,775,807 or about 292,471,208 years, and this is the default value.
							</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_instance_cache_element">
      ⁠</a>30.3.1.3.10. The instance-cache element</h4></div></div></div><div class="para">
						The <code class="literal">instance-cache</code> element specifies the fully qualified class name of the <code class="literal">org.jboss.ejb.InstanceCache</code> interface implementation. This element is only meaningful for entity and stateful session beans as these are the only EJB types that have an associated identity. We will discuss the <code class="literal">InstanceCache</code> interface in detail latter in this chapter when we talk about the container plug-in framework.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_container_cache_conf_element">
      ⁠</a>30.3.1.3.11. The container-cache-conf element</h4></div></div></div><div class="para">
						The <code class="literal">container-cache-conf</code> element is passed to the <code class="literal">InstanceCache</code> implementation if it supports the <code class="literal">XmlLoadable</code> interface. All current JBoss <code class="literal">InstanceCache</code> implementations derive from the <code class="literal">org.jboss.ejb.plugins.AbstractInstanceCache</code> class which provides support for the <code class="literal">XmlLoadable</code> interface and uses the <code class="literal">cache-policy</code> child element as the fully qualified class name of an <code class="literal">org.jboss.util.CachePolicy</code> implementation that is used as the instance cache store. The <code class="literal">cache-policy-conf</code> child element is passed to the <code class="literal">CachePolicy</code> implementation if it supports the <code class="literal">XmlLoadable</code> interface. If it does not, the <code class="literal">cache-policy-conf</code> will silently be ignored.
					</div><div class="para">
						There are two JBoss implementations of CachePolicy used by the <code class="literal">standardjboss.xml</code> configuration that support the current array of <code class="literal">cache-policy-conf</code> child elements. The classes are <code class="literal">org.jboss.ejb.plugins.LRUEnterpriseContextCachePolicy</code> and <code class="literal">org.jboss.ejb.plugins.LRUStatefulContextCachePolicy</code>. The <code class="literal">LRUEnterpriseContextCachePolicy</code> is used by entity bean containers while the <code class="literal">LRUStatefulContextCachePolicy</code> is used by stateful session bean containers. Both cache policies support the following <code class="literal">cache-policy-conf</code> child elements, shown in <a class="xref" href="EJBs_on_JBoss.html#The_container_cache_conf_element-The_container_cache_conf_element_DTD">Figure 30.6, “The container-cache-conf element DTD”</a>.
					</div><div class="figure"><a id="The_container_cache_conf_element-The_container_cache_conf_element_DTD">
      ⁠</a><div class="figure-contents"><div class="mediaobject"><img src="images/jboss_4_0_container_cache_conf.png" alt="The container-cache-conf element DTD"/></div></div><p class="title"><strong>Figure 30.6. The container-cache-conf element DTD</strong></p></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
								<span class="bold bold"><strong>min-capacity</strong></span>: specifies the minimum capacity of this cache
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>max-capacity</strong></span>: specifies the maximum capacity of the cache, which cannot be less than <code class="literal">min-capacity</code>.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>overager-period</strong></span>: specifies the period in seconds between runs of the overager task. The purpose of the overager task is to see if the cache contains beans with an age greater than the <code class="literal">max-bean-age</code> element value. Any beans meeting this criterion will be passivated.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>max-bean-age</strong></span>: specifies the maximum period of inactivity in seconds a bean can have before it will be passivated by the overager process.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>resizer-period</strong></span>: specifies the period in seconds between runs of the resizer task. The purpose of the resizer task is to contract or expand the cache capacity based on the remaining three element values in the following way. When the resizer task executes it checks the current period between cache misses, and if the period is less than the <code class="literal">min-cache-miss-period</code> value the cache is expanded up to the <code class="literal">max-capacity</code> value using the <code class="literal">cache-load-factor</code>. If instead the period between cache misses is greater than the <code class="literal">max-cache-miss-period</code> value the cache is contracted using the <code class="literal">cache-load-factor</code>.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>max-cache-miss-period</strong></span>: specifies the time period in seconds in which a cache miss should signal that the cache capacity be contracted. It is equivalent to the minimum miss rate that will be tolerated before the cache is contracted.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>min-cache-miss-period</strong></span>: specifies the time period in seconds in which a cache miss should signal that the cache capacity be expanded. It is equivalent to the maximum miss rate that will be tolerated before the cache is expanded.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>cache-load-factor</strong></span>: specifies the factor by which the cache capacity is contracted and expanded. The factor should be less than 1. When the cache is contracted the capacity is reduced so that the current ratio of beans to cache capacity is equal to the cache-load-factor value. When the cache is expanded the new capacity is determined as <code class="literal">current-capacity * 1/cache-load-factor</code>. The actual expansion factor may be as high as 2 based on an internal algorithm based on the number of cache misses. The higher the cache miss rate the closer the true expansion factor will be to 2.
							</div></li></ul></div><div class="para">
						The <code class="literal">LRUStatefulContextCachePolicy</code> also supports the remaining child elements:
					</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
								<span class="bold bold"><strong>remover-period</strong></span>: specifies the period in seconds between runs of the remover task. The remover task removes passivated beans that have not been accessed in more than <code class="literal">max-bean-life</code> seconds. This task prevents stateful session beans that were not removed by users from filling up the passivation store.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>max-bean-life</strong></span>: specifies the maximum period in seconds that a bean can exist inactive. After this period, as a result, the bean will be removed from the passivation store.
							</div></li></ul></div><div class="para">
						An alternative cache policy implementation is the <code class="literal">org.jboss.ejb.plugins.NoPassivationCachePolicy</code> class, which simply never passivates instances. It uses an in-memory <code class="literal">HashMap</code> implementation that never discards instances unless they are explicitly removed. This class does not support any of the <code class="literal">cache-policy-conf</code> configuration elements.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_persistence_manager_element">
      ⁠</a>30.3.1.3.12. The persistence-manager element</h4></div></div></div><div class="para">
						The <code class="literal">persistence-manager</code> element value specifies the fully qualified class name of the persistence manager implementation. The type of the implementation depends on the type of EJB. For stateful session beans it must be an implementation of the <code class="literal">org.jboss.ejb.StatefulSessionPersistenceManager</code> interface. For BMP entity beans it must be an implementation of the <code class="literal">org.jboss.ejb.EntityPersistenceManager</code> interface, while for CMP entity beans it must be an implementation of the <code class="literal">org.jboss.ejb.EntityPersistenceStore</code> interface.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_web_class_loader_Element">
      ⁠</a>30.3.1.3.13. The web-class-loader Element</h4></div></div></div><div class="para">
						The <code class="literal">web-class-loader</code> element specifies a subclass of <code class="literal">org.jboss.web.WebClassLoader</code> that is used in conjunction with the <code class="literal">WebService</code> MBean to allow dynamic loading of resources and classes from deployed ears, EJB JARs and WARs. A <code class="literal">WebClassLoader</code> is associated with a <code class="literal">Container</code> and must have an <code class="literal">org.jboss.mx.loading.UnifiedClassLoader</code> as its parent. It overrides the <code class="literal">getURLs()</code> method to return a different set of URLs for remote loading than what is used for local loading.
					</div><div class="para">
						<code class="literal">WebClassLoader</code> has two methods meant to be overridden by subclasses: <code class="literal">getKey()</code> and <code class="literal">getBytes()</code>. The latter is a no-op in this implementation and should be overridden by subclasses with bytecode generation ability, such as the classloader used by the iiop module.
					</div><div class="para">
						<code class="literal">WebClassLoader</code> subclasses must have a constructor with the same signature as the <code class="literal">WebClassLoader(ObjectName containerName, UnifiedClassLoader parent)</code> constructor.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_locking_policy_element">
      ⁠</a>30.3.1.3.14. The locking-policy element</h4></div></div></div><div class="para">
						The <code class="literal">locking-policy</code> element gives the fully qualified class name of the EJB lock implementation to use. This class must implement the <code class="literal">org.jboss.ejb.BeanLock</code> interface. The current JBoss versions include:
					</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
								<span class="bold bold"><strong>org.jboss.ejb.plugins.lock.QueuedPessimisticEJBLock</strong></span>: an implementation that holds threads awaiting the transactional lock to be freed in a fair FIFO queue. Non-transactional threads are also put into this wait queue as well. This class pops the next waiting transaction from the queue and notifies only those threads waiting associated with that transaction. The <code class="literal">QueuedPessimisticEJBLock</code> is the current default used by the standard configurations.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>org.jboss.ejb.plugins.lock.QueuedPessimisticEJBLockNoADE</strong></span>: This behaves the same as the <code class="literal">QueuedPessimisticEJBLock</code> except that deadlock detection is disabled.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>org.jboss.ejb.plugins.lock.SimpleReadWriteEJBLock</strong></span>: This lock allows multiple read locks concurrently. Once a writer has requested the lock, future read-lock requests whose transactions do not already have the read lock will block until all writers are done; then all the waiting readers will concurrently go (depending on the reentrant setting / methodLock). A reader who promotes gets first crack at the write lock, ahead of other waiting writers. If there is already a reader that is promoting, we throw an inconsistent read exception. Of course, writers have to wait for all read-locks to release before taking the write lock.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>org.jboss.ejb.plugins.lock.NoLock</strong></span>: an anti-locking policy used with the instance per transaction container configurations.
							</div></li></ul></div><div class="para">
						Locking and deadlock detection will be discussed in more detail in <a class="xref" href="EJBs_on_JBoss.html#EJBs_on_JBoss-Entity_Bean_Locking_and_Deadlock_Detection">Section 30.4, “Entity Bean Locking and Deadlock Detection”</a>.
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_commit_option_and_optiond_refresh_rate_elements">
      ⁠</a>30.3.1.3.15. The commit-option and optiond-refresh-rate elements</h4></div></div></div><div class="para">
						The commit-option value specifies the EJB entity bean persistent storage commit option. It must be one of <code class="literal">A</code>, <code class="literal">B</code>, <code class="literal">C</code> or <code class="literal">D</code>.
					</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
								<span class="bold bold"><strong>A</strong></span>: the container caches the beans state between transactions. This option assumes that the container is the only user accessing the persistent store. This assumption allows the container to synchronize the in-memory state from the persistent storage only when absolutely necessary. This occurs before the first business method executes on a found bean or after the bean is passivated and reactivated to serve another business method. This behavior is independent of whether the business method executes inside a transaction context.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>B</strong></span>: the container caches the bean state between transactions. However, unlike option <code class="literal">A</code> the container does not assume exclusive access to the persistent store. Therefore, the container will synchronize the in-memory state at the beginning of each transaction. Thus, business methods executing in a transaction context do not see much benefit from the container caching the bean, whereas business methods executing outside a transaction context (transaction attributes Never, NotSupported or Supports) access the cached (and potentially invalid) state of the bean.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>C</strong></span>: the container does not cache bean instances. The in-memory state must be synchronized on every transaction start. For business methods executing outside a transaction the synchronization is still performed, but the <code class="literal">ejbLoad</code> executes in the same transaction context as that of the caller.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>D</strong></span>: is a JBoss-specific commit option which is not described in the EJB specification. It is a lazy read scheme where bean state is cached between transactions as with option <code class="literal">A</code>, but the state is periodically re-synchronized with that of the persistent store. The default time between reloads is 30 seconds, but may configured using the <code class="literal">optiond-refresh-rate</code> element.
							</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_security_domain_element">
      ⁠</a>30.3.1.3.16. The security-domain element</h4></div></div></div><div class="para">
						The <code class="literal">security-domain</code> element specifies the JNDI name of the object that implements the <code class="literal">org.jboss.security.AuthenticationManager</code> and <code class="literal">org.jboss.security.RealmMapping</code> interfaces. It is more typical to specify the <code class="literal">security-domain</code> under the <code class="literal">jboss</code> root element so that all EJBs in a given deployment are secured in the same manner. However, it is possible to configure the security domain for each bean configuration. 
					</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-cluster_config">
      ⁠</a>30.3.1.3.17. cluster-config</h4></div></div></div><div class="para">
						The <code class="literal">cluster-config</code> element allows to specify cluster specific settings for all EJBs that use the container configuration. Specification of the cluster configuration may be done at the container configuration level or at the individual EJB deployment level.
					</div><div class="figure"><a id="cluster_config-The_cluster_config_and_related_elements">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/jboss_4_0_cluster_config.png" align="middle" alt="The cluster-config and related elements" style="text-align: middle"/></div></div><p class="title"><strong>Figure 30.7. The cluster-config and related elements</strong></p></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
								<span class="bold bold"><strong>partition-name</strong></span>: The <code class="literal">partition-name</code> element indicates where to find the <code class="literal">org.jboss.ha.framework.interfaces.HAPartition</code> interface to be used by the container to exchange clustering information. This is not the full JNDI name under which <code class="literal">HAPartition</code> is bound. Rather, it should correspond to the <code class="literal">PartitionName</code> attribute of the <code class="literal">ClusterPartitionMBean</code> service that is managing the desired cluster. The actual JNDI name of the <code class="literal">HAPartition</code> binding will be formed by appending <code class="literal">/HASessionState/</code> to the partition-name value. The default value is <code class="literal">DefaultPartition</code>.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>home-load-balance-policy</strong></span>: The <code class="literal">home-load-balance-policy</code> element indicates the Java class name to be used to load balance calls made on the home proxy. The class must implement the <code class="literal">org.jboss.ha.framework.interface.LoadBalancePolicy</code> interface. The default policy is <code class="literal">org.jboss.ha.framework.interfaces.RoundRobin</code>.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>bean-load-balance-policy</strong></span>: The <code class="literal">bean-load-balance-policy</code> element indicates the java class name to be used to load balance calls in the bean proxy. The class must implement the <code class="literal">org.jboss.ha.framework.interface.LoadBalancePolicy</code> interface. For entity beans and stateful session beans, the default is <code class="literal">org.jboss.ha.framework.interfaces.FirstAvailavble</code>. For stateless session beans, <code class="literal">org.jboss.ha.framework.interfaces.RoundRobin</code>.
							</div></li><li class="listitem"><div class="para">
								<span class="bold bold"><strong>session-state-manager-jndi-name</strong></span>: The <code class="literal">session-state-manager-jndi-name</code> element indicates the name of the <code class="literal">org.jboss.ha.framework.interfaces.HASessionState</code> to be used by the container as a backend for state session management in the cluster. Unlike the partition-name element, this is a JNDI name under which the <code class="literal">HASessionState</code> implementation is bound. The default location used is <code class="literal">/HASessionState/Default</code>.
							</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="Container_configuration_information-The_depends_element">
      ⁠</a>30.3.1.3.18. The depends element</h4></div></div></div><div class="para">
						The <code class="literal">depends</code> element gives a JMX <code class="literal">ObjectName</code> of a service on which the container or EJB depends. Specification of explicit dependencies on other services avoids having to rely on the deployment order being after the required services are started.
					</div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="The_EJB_Container-Container_Plug_in_Framework_">
      ⁠</a>30.3.2. Container Plug-in Framework </h2></div></div></div><div class="para">
				The JBoss EJB container uses a framework pattern that allows one to change implementations of various aspects of the container behavior. The container itself does not perform any significant work other than connecting the various behavioral components together. Implementations of the behavioral components are referred to as plug-ins, because you can plug in a new implementation by changing a container configuration. Examples of plug-in behavior you may want to change include persistence management, object pooling, object caching, container invokers and interceptors. There are four subclasses of the <code class="literal">org.jboss.ejb.Container</code> class, each one implementing a particular bean type:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>org.jboss.ejb.EntityContainer</strong></span>: handles <code class="literal">javax.ejb.EntityBean</code> types
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>org.jboss.ejb.StatelessSessionContainer</strong></span>: handles Stateless <code class="literal">javax.ejb.SessionBean</code> types
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>org.jboss.ejb.StatefulSessionContainer</strong></span>: handles Stateful <code class="literal">javax.ejb.SessionBean</code> types
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>org.jboss.ejb.MessageDrivenContainer</strong></span> handles <code class="literal">javax.ejb.MessageDrivenBean</code> types
					</div></li></ul></div><div class="para">
				The EJB containers delegate much of their behavior to components known as container plug-ins. The interfaces that make up the container plug-in points include the following:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						org.jboss.ejb.ContainerPlugin
					</div></li><li class="listitem"><div class="para">
						org.jboss.ejb.ContainerInvoker
					</div></li><li class="listitem"><div class="para">
						org.jboss.ejb.Interceptor
					</div></li><li class="listitem"><div class="para">
						org.jboss.ejb.InstancePool
					</div></li><li class="listitem"><div class="para">
						org.jboss.ejb.InstanceCache
					</div></li><li class="listitem"><div class="para">
						org.jboss.ejb.EntityPersistanceManager
					</div></li><li class="listitem"><div class="para">
						org.jboss.ejb.EntityPersistanceStore
					</div></li><li class="listitem"><div class="para">
						org.jboss.ejb.StatefulSessionPersistenceManager
					</div></li></ul></div><div class="para">
				The container's main responsibility is to manage its plug-ins. This means ensuring that the plug-ins have all the information they need to implement their functionality.
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Container_Plug_in_Framework_-org.jboss.ejb.ContainerPlugin">
      ⁠</a>30.3.2.1. org.jboss.ejb.ContainerPlugin</h3></div></div></div><div class="para">
					The <code class="literal">ContainerPlugin</code> interface is the parent interface of all container plug-in interfaces. It provides a callback that allows a container to provide each of its plug-ins a pointer to the container the plug-in is working on behalf of. The <code class="literal">ContainerPlugin</code> interface is given below.
				</div><div class="example"><a id="org.jboss.ejb.ContainerPlugin-The_org.jboss.ejb.ContainerPlugin_interface">
      ⁠</a><p class="title"><strong>Example 30.4. The org.jboss.ejb.ContainerPlugin interface</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> ContainerPlugin
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> Service, AllowedOperationsFlags
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** co</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This callback is set by the container so that the plugin</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * may access its container</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param con </span><span xmlns="" class="perl_Comment">the container which owns the plugin</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setContainer</span>(Container con);
<span xmlns="" class="line">​</span>}
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Container_Plug_in_Framework_-org.jboss.ejb.Interceptor">
      ⁠</a>30.3.2.2. org.jboss.ejb.Interceptor</h3></div></div></div><div class="para">
					The <code class="literal">Interceptor</code> interface enables one to build a chain of method interceptors through which each EJB method invocation must pass. The <code class="literal">Interceptor</code> interface is given below.
				</div><div class="example"><a id="org.jboss.ejb.Interceptor-The_org.jboss.ejb.Interceptor_interface">
      ⁠</a><p class="title"><strong>Example 30.5. The org.jboss.ejb.Interceptor interface</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.invocation.Invocation;</span>
<span xmlns="" class="line">​</span>                    
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> Interceptor 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> ContainerPlugin
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setNext</span>(Interceptor interceptor);
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Interceptor <span xmlns="" class="perl_Function">getNext</span>();
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Object <span xmlns="" class="perl_Function">invokeHome</span>(Invocation mi) <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> Object <span xmlns="" class="perl_Function">invoke</span>(Invocation mi) <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para">
					All interceptors defined in the container configuration are created and added to the container interceptor chain by the <code class="literal">EJBDeployer</code>. The last interceptor is not added by the deployer but rather by the container itself because this is the interceptor that interacts with the EJB bean implementation.
				</div><div class="para">
					The order of the interceptor in the chain is important. The idea behind ordering is that interceptors that are not tied to a particular <code class="literal">EnterpriseContext</code> instance are positioned before interceptors that interact with caches and pools.
				</div><div class="para">
					Implementers of the <code class="literal">Interceptor</code> interface form a linked-list like structure through which the <code class="literal">Invocation</code> object is passed. The first interceptor in the chain is invoked when an invoker passes a <code class="literal">Invocation</code> to the container via the JMX bus. The last interceptor invokes the business method on the bean. There are usually on the order of five interceptors in a chain depending on the bean type and container configuration. <code class="literal">Interceptor</code> semantic complexity ranges from simple to complex. An example of a simple interceptor would be <code class="literal">LoggingInterceptor</code>, while a complex example is <code class="literal">EntitySynchronizationInterceptor</code>.
				</div><div class="para">
					One of the main advantages of an interceptor pattern is flexibility in the arrangement of interceptors. Another advantage is the clear functional distinction between different interceptors. For example, logic for transaction and security is cleanly separated between the <code class="literal">TXInterceptor</code> and <code class="literal">SecurityInterceptor</code> respectively.
				</div><div class="para">
					If any of the interceptors fail, the call is terminated at that point. This is a fail-quickly type of semantic. For example, if a secured EJB is accessed without proper permissions, the call will fail as the <code class="literal">SecurityInterceptor</code> before any transactions are started or instances caches are updated.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Container_Plug_in_Framework_-org.jboss.ejb.InstancePool">
      ⁠</a>30.3.2.3. org.jboss.ejb.InstancePool</h3></div></div></div><div class="para">
					An <code class="literal">InstancePool</code> is used to manage the EJB instances that are not associated with any identity. The pools actually manage subclasses of the <code class="literal">org.jboss.ejb.EnterpriseContext</code> objects that aggregate un-associated bean instances and related data.
				</div><div class="example"><a id="org.jboss.ejb.InstancePool-_The_org.jboss.ejb.InstancePool_interface">
      ⁠</a><p class="title"><strong>Example 30.6.  The org.jboss.ejb.InstancePool interface</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> InstancePool
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> ContainerPlugin
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Get an instance without identity. Can be used</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * by finders and create-methods, or stateless beans</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">Context /w instance</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@exception RemoteException</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> EnterpriseContext <span xmlns="" class="perl_Function">get</span>() <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** Return an anonymous instance after invocation.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param ctx</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">free</span>(EnterpriseContext ctx);
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Discard an anonymous instance after invocation.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This is called if the instance should not be reused,</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * perhaps due to some exception being thrown from it.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param ctx</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">discard</span>(EnterpriseContext ctx);
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Return the size of the pool.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">the size of the pool.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">getCurrentSize</span>();
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Get the maximum size of the pool.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">the size of the pool.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">int</span> <span xmlns="" class="perl_Function">getMaxSize</span>();
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para">
					Depending on the configuration, a container may choose to have a certain size of the pool contain recycled instances, or it may choose to instantiate and initialize an instance on demand.
				</div><div class="para">
					The pool is used by the <code class="literal">InstanceCache</code> implementation to acquire free instances for activation, and it is used by interceptors to acquire instances to be used for Home interface methods (create and finder calls).
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Container_Plug_in_Framework_-org.jboss.ebj.InstanceCache">
      ⁠</a>30.3.2.4. org.jboss.ebj.InstanceCache</h3></div></div></div><div class="para">
					The container <code class="literal">InstanceCache</code> implementation handles all EJB-instances that are in an active state, meaning bean instances that have an identity attached to them. Only entity and stateful session beans are cached, as these are the only bean types that have state between method invocations. The cache key of an entity bean is the bean primary key. The cache key for a stateful session bean is the session id.
				</div><div class="example"><a id="org.jboss.ebj.InstanceCache-The_org.jboss.ejb.InstanceCache_interface">
      ⁠</a><p class="title"><strong>Example 30.7. The org.jboss.ejb.InstanceCache interface</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> InstanceCache 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> ContainerPlugin
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Gets a bean instance from this cache given the identity.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method may involve activation if the instance is not</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * in the cache.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Implementation should have O(1) complexity.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is never called for stateless session beans.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param id </span><span xmlns="" class="perl_Comment">the primary key of the bean</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">the EnterpriseContext related to the given id</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@exception RemoteException </span><span xmlns="" class="perl_Comment">in case of illegal calls</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * (concurrent / reentrant), NoSuchObjectException if</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * the bean cannot be found.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@see #release</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> EnterpriseContext <span xmlns="" class="perl_Function">get</span>(Object id)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> RemoteException, NoSuchObjectException;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Inserts an active bean instance after creation or activation.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Implementation should guarantee proper locking and O(1) complexity.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param ctx </span><span xmlns="" class="perl_Comment">the EnterpriseContext to insert in the cache</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@see #remove</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">insert</span>(EnterpriseContext ctx);
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Releases the given bean instance from this cache.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method may passivate the bean to get it out of the cache.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Implementation should return almost immediately leaving the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * passivation to be executed by another thread.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param ctx </span><span xmlns="" class="perl_Comment">the EnterpriseContext to release</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@see #get</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">release</span>(EnterpriseContext ctx);
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Removes a bean instance from this cache given the identity.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Implementation should have O(1) complexity and guarantee</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * proper locking.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param id </span><span xmlns="" class="perl_Comment">the primary key of the bean</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@see #insert</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">remove</span>(Object id);
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Checks whether an instance corresponding to a particular</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * id is active</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param id </span><span xmlns="" class="perl_Comment">the primary key of the bean</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@see #insert</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">isActive</span>(Object id);    
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para">
					In addition to managing the list of active instances, the <code class="literal">InstanceCache</code> is also responsible for activating and passivating instances. If an instance with a given identity is requested, and it is not currently active, the <code class="literal">InstanceCache</code> must use the <code class="literal">InstancePool</code> to acquire a free instance, followed by the persistence manager to activate the instance. Similarly, if the <code class="literal">InstanceCache</code> decides to passivate an active instance, it must call the persistence manager to passivate it and release the instance to the <code class="literal">InstancePool</code>.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Container_Plug_in_Framework_-org.jboss.ejb.EntityPersistenceManager">
      ⁠</a>30.3.2.5. org.jboss.ejb.EntityPersistenceManager</h3></div></div></div><div class="para">
					The <code class="literal">EntityPersistenceManager</code> is responsible for the persistence of EntityBeans. This includes the following:
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							Creating an EJB instance in a storage
						</div></li><li class="listitem"><div class="para">
							Loading the state of a given primary key into an EJB instance
						</div></li><li class="listitem"><div class="para">
							Storing the state of a given EJB instance
						</div></li><li class="listitem"><div class="para">
							Removing an EJB instance from storage
						</div></li><li class="listitem"><div class="para">
							Activating the state of an EJB instance
						</div></li><li class="listitem"><div class="para">
							Passivating the state of an EJB instance
						</div></li></ul></div><div class="example"><a id="org.jboss.ejb.EntityPersistenceManager-_The_org.jboss.ejb.EntityPersistenceManager_interface">
      ⁠</a><p class="title"><strong>Example 30.8.  The org.jboss.ejb.EntityPersistenceManager interface</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> EntityPersistenceManager 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> ContainerPlugin
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Returns a new instance of the bean class or a subclass of the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * bean class.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">the new instance</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    Object <span xmlns="" class="perl_Function">createBeanClassInstance</span>() <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>                    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called whenever an entity is to be created. The</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * persistence manager is responsible for calling the ejbCreate method</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * on the instance and to handle the results properly wrt the persistent</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * store.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param m </span><span xmlns="" class="perl_Comment">the create method in the home interface that was</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * called</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param args </span><span xmlns="" class="perl_Comment">any create parameters</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance being used for this create call</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">createEntity</span>(Method m,
<span xmlns="" class="line">​</span>		      Object[] args,
<span xmlns="" class="line">​</span>		      EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called whenever an entity is to be created. The</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * persistence manager is responsible for calling the ejbPostCreate method</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * on the instance and to handle the results properly wrt the persistent</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * store.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param m </span><span xmlns="" class="perl_Comment">the create method in the home interface that was</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * called</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param args </span><span xmlns="" class="perl_Comment">any create parameters</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance being used for this create call</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">postCreateEntity</span>(Method m,
<span xmlns="" class="line">​</span>			  Object[] args,
<span xmlns="" class="line">​</span>			  EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called when single entities are to be found. The</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * persistence manager must find out whether the wanted instance is</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * available in the persistence store, and if so it shall use the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * ContainerInvoker plugin to create an EJBObject to the instance, which</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * is to be returned as result.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param finderMethod </span><span xmlns="" class="perl_Comment">the find method in the home interface that was</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * called</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param args </span><span xmlns="" class="perl_Comment">any finder parameters</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to use for the finder call</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">an EJBObject representing the found entity</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    Object <span xmlns="" class="perl_Function">findEntity</span>(Method finderMethod,
<span xmlns="" class="line">​</span>		      Object[] args,
<span xmlns="" class="line">​</span>		      EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called when collections of entities are to be</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * found. The persistence manager must find out whether the wanted</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * instances are available in the persistence store, and if so it</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * shall use the ContainerInvoker plugin to create EJBObjects to</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * the instances, which are to be returned as result.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param finderMethod </span><span xmlns="" class="perl_Comment">the find method in the home interface that was</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * called</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param args </span><span xmlns="" class="perl_Comment">any finder parameters</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to use for the finder call</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">an EJBObject collection representing the found</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * entities</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    Collection <span xmlns="" class="perl_Function">findEntities</span>(Method finderMethod,
<span xmlns="" class="line">​</span>			    Object[] args,
<span xmlns="" class="line">​</span>			    EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>                     <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called when an entity shall be activated. The</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * persistence manager must call the ejbActivate method on the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * instance.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to use for the activation</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">activateEntity</span>(EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> RemoteException;
<span xmlns="" class="line">​</span>                    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called whenever an entity shall be load from the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * underlying storage. The persistence manager must load the state</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * from the underlying storage and then call ejbLoad on the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * supplied instance.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to synchronize</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">loadEntity</span>(EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> RemoteException;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is used to determine if an entity should be stored.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to check</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">true, if the entity has been modified</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws Exception </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">isModified</span>(EntityEnterpriseContext instance) <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called whenever an entity shall be stored to the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * underlying storage. The persistence manager must call ejbStore</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * on the supplied instance and then store the state to the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * underlying storage.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to synchronize</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">storeEntity</span>(EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> RemoteException;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called when an entity shall be passivate. The</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * persistence manager must call the ejbPassivate method on the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * instance.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to passivate</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">passivateEntity</span>(EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> RemoteException;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called when an entity shall be removed from the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * underlying storage. The persistence manager must call ejbRemove</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * on the instance and then remove its state from the underlying</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * storage.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to remove</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoveException </span><span xmlns="" class="perl_Comment">thrown if the instance could not be removed</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">removeEntity</span>(EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> RemoteException, RemoveException;
<span xmlns="" class="line">​</span>}
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Container_Plug_in_Framework_-The_org.jboss.ejb.EntityPersistenceStore_interface">
      ⁠</a>30.3.2.6. The org.jboss.ejb.EntityPersistenceStore interface</h3></div></div></div><div class="para">
					As per the EJB 2.1 specification, JBoss supports two entity bean persistence semantics: container managed persistence (CMP) and bean managed persistence (BMP). The CMP implementation uses an implementation of the <code class="literal">org.jboss.ejb.EntityPersistanceStore</code> interface. By default this is the <code class="literal">org.jboss.ejb.plugins.cmp.jdbc.JDBCStoreManager</code> which is the entry point for the CMP2 persistence engine. The <code class="literal">EntityPersistanceStore</code> interface is shown below.
				</div><div class="example"><a id="The_org.jboss.ejb.EntityPersistenceStore_interface-_The_org.jboss.ejb.EntityPersistanceStore_interface">
      ⁠</a><p class="title"><strong>Example 30.9.  The org.jboss.ejb.EntityPersistanceStore interface</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> EntityPersistenceStore 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> ContainerPlugin
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Returns a new instance of the bean class or a subclass of the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * bean class.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">the new instance</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws Exception</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    Object <span xmlns="" class="perl_Function">createBeanClassInstance</span>() 
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Initializes the instance context.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">&lt;p&gt;</span><span xmlns="" class="perl_Comment">This method is called before createEntity, and should</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * reset the value of all cmpFields to 0 or null.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param ctx</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">initEntity</span>(EntityEnterpriseContext ctx);
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called whenever an entity is to be created.  The</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * persistence manager is responsible for handling the results</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * properly wrt the persistent store.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param m </span><span xmlns="" class="perl_Comment">the create method in the home interface that was</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * called</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param args </span><span xmlns="" class="perl_Comment">any create parameters</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance being used for this create call</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">The primary key computed by CMP PM or null for BMP</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws Exception</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    Object <span xmlns="" class="perl_Function">createEntity</span>(Method m,
<span xmlns="" class="line">​</span>			Object[] args,
<span xmlns="" class="line">​</span>			EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called when single entities are to be found. The</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * persistence manager must find out whether the wanted instance</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * is available in the persistence store, if so it returns the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * primary key of the object.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param finderMethod </span><span xmlns="" class="perl_Comment">the find method in the home interface that was</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * called</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param args </span><span xmlns="" class="perl_Comment">any finder parameters</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to use for the finder call</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">a primary key representing the found entity</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws FinderException </span><span xmlns="" class="perl_Comment">thrown if some heuristic problem occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    Object <span xmlns="" class="perl_Function">findEntity</span>(Method finderMethod,
<span xmlns="" class="line">​</span>		      Object[] args,
<span xmlns="" class="line">​</span>		      EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called when collections of entities are to be</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * found. The persistence manager must find out whether the wanted</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * instances are available in the persistence store, and if so it</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * must return a collection of primaryKeys.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param finderMethod </span><span xmlns="" class="perl_Comment">the find method in the home interface that was</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * called</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param args </span><span xmlns="" class="perl_Comment">any finder parameters</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to use for the finder call</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">an primary key collection representing the found</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * entities</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws FinderException </span><span xmlns="" class="perl_Comment">thrown if some heuristic problem occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    Collection <span xmlns="" class="perl_Function">findEntities</span>(Method finderMethod,
<span xmlns="" class="line">​</span>			    Object[] args,
<span xmlns="" class="line">​</span>			    EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called when an entity shall be activated.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">&lt;p&gt;</span><span xmlns="" class="perl_Comment">With the PersistenceManager factorization most EJB</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * calls should not exists However this calls permits us to</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * introduce optimizations in the persistence store. Particularly</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * the context has a "PersistenceContext" that a PersistenceStore</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * can use (JAWS does for smart updates) and this is as good a</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * callback as any other to set it up.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to use for the activation</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">activateEntity</span>(EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> RemoteException;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called whenever an entity shall be load from the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * underlying storage. The persistence manager must load the state</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * from the underlying storage and then call ejbLoad on the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * supplied instance.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to synchronize</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">loadEntity</span>(EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> RemoteException;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is used to determine if an entity should be stored.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to check</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">true, if the entity has been modified</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws Exception </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">isModified</span>(EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called whenever an entity shall be stored to the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * underlying storage. The persistence manager must call ejbStore</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * on the supplied instance and then store the state to the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * underlying storage.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to synchronize</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">storeEntity</span>(EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> RemoteException;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called when an entity shall be passivate. The</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * persistence manager must call the ejbPassivate method on the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * instance.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">&lt;p&gt;</span><span xmlns="" class="perl_Comment">See the activate discussion for the reason for</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * exposing EJB callback * calls to the store.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to passivate</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">passivateEntity</span>(EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> RemoteException;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * This method is called when an entity shall be removed from the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * underlying storage. The persistence manager must call ejbRemove</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * on the instance and then remove its state from the underlying</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * storage.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param instance </span><span xmlns="" class="perl_Comment">the instance to remove</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoteException </span><span xmlns="" class="perl_Comment">thrown if some system exception occurs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@throws RemoveException </span><span xmlns="" class="perl_Comment">thrown if the instance could not be removed</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">removeEntity</span>(EntityEnterpriseContext instance)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> RemoteException, RemoveException;
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para">
					The default BMP implementation of the <code class="literal">EntityPersistenceManager</code> interface is <code class="literal">org.jboss.ejb.plugins.BMPPersistenceManager</code>. The BMP persistence manager is fairly simple since all persistence logic is in the entity bean itself. The only duty of the persistence manager is to perform container callbacks.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Container_Plug_in_Framework_-org.jboss.ejb.StatefulSessionPersistenceManager">
      ⁠</a>30.3.2.7. org.jboss.ejb.StatefulSessionPersistenceManager</h3></div></div></div><div class="para">
					The <code class="literal">StatefulSessionPersistenceManager</code> is responsible for the persistence of stateful <code class="literal">SessionBeans</code>. This includes the following:
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							Creating stateful sessions in a storage
						</div></li><li class="listitem"><div class="para">
							Activating stateful sessions from a storage
						</div></li><li class="listitem"><div class="para">
							Passivating stateful sessions to a storage
						</div></li><li class="listitem"><div class="para">
							Removing stateful sessions from a storage
						</div></li></ul></div><div class="para">
					The <code class="literal">StatefulSessionPersistenceManager</code> interface is shown below.
				</div><div class="example"><a id="org.jboss.ejb.StatefulSessionPersistenceManager-The_org.jboss.ejb.StatefulSessionPersistenceManager_interface">
      ⁠</a><p class="title"><strong>Example 30.10. The org.jboss.ejb.StatefulSessionPersistenceManager interface</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> StatefulSessionPersistenceManager 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> ContainerPlugin
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">createSession</span>(Method m, Object[] args,
<span xmlns="" class="line">​</span>			      StatefulSessionEnterpriseContext ctx)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> Exception;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">activateSession</span>(StatefulSessionEnterpriseContext ctx)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> RemoteException;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">passivateSession</span>(StatefulSessionEnterpriseContext ctx)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> RemoteException;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">removeSession</span>(StatefulSessionEnterpriseContext ctx)
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">throws</span> RemoteException, RemoveException;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">removePassivated</span>(Object key);
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para">
					The default implementation of the <code class="literal">StatefulSessionPersistenceManager</code> interface is <code class="literal">org.jboss.ejb.plugins.StatefulSessionFilePersistenceManager</code>. As its name implies, <code class="literal">StatefulSessionFilePersistenceManager</code> utilizes the file system to persist stateful session beans. More specifically, the persistence manager serializes beans in a flat file whose name is composed of the bean name and session id with a <code class="literal">.ser</code> extension. The persistence manager restores a bean's state during activation and respectively stores its state during passivation from the bean's <code class="literal">.ser</code> file.
				</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="EJBs_on_JBoss-Entity_Bean_Locking_and_Deadlock_Detection">
      ⁠</a>30.4. Entity Bean Locking and Deadlock Detection</h1></div></div></div><div class="para">
			This section provides information on what entity bean locking is and how entity beans are accessed and locked within JBoss. It also describes the problems you may encounter as you use entity beans within your system and how to combat these issues. Deadlocking is formally defined and examined. And, finally, we walk you through how to fine tune your system in terms of entity bean locking.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Entity_Bean_Locking_and_Deadlock_Detection-Why_JBoss_Needs_Locking">
      ⁠</a>30.4.1. Why JBoss Needs Locking</h2></div></div></div><div class="para">
				Locking is about protecting the integrity of your data. Sometimes you need to be sure that only one user can update critical data at one time. Sometimes, access to sensitive objects in your system need to be serialized so that data is not corrupted by concurrent reads and writes. Databases traditionally provide this sort of functionality with transactional scopes and table and row locking facilities.
			</div><div class="para">
				Entity beans are a great way to provide an object-oriented interface to relational data. Beyond that, they can improve performance by taking the load off of the database through caching and delaying updates until absolutely needed so that the database efficiency can be maximized. But, with caching, data integrity is a problem, so some form of application server level locking is needed for entity beans to provide the transaction isolation properties that you are used to with traditional databases.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Entity_Bean_Locking_and_Deadlock_Detection-Entity_Bean_Lifecycle">
      ⁠</a>30.4.2. Entity Bean Lifecycle</h2></div></div></div><div class="para">
				With the default configuration of JBoss there is only one active instance of a given entity bean in memory at one time. This applies for every cache configuration and every type of <code class="literal">commit-option</code>. The lifecycle for this instance is different for every commit-option though.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						For commit option <span class="emphasis"><em>A</em></span>, this instance is cached and used between transactions.
					</div></li><li class="listitem"><div class="para">
						For commit option <span class="emphasis"><em>B</em></span>, this instance is cached and used between transactions, but is marked as dirty at the end of a transaction. This means that at the start of a new transaction <code class="literal">ejbLoad</code> must be called.
					</div></li><li class="listitem"><div class="para">
						For commit option <span class="emphasis"><em>C</em></span>, this instance is marked as dirty, released from the cache, and marked for passivation at the end of a transaction.
					</div></li><li class="listitem"><div class="para">
						For commit option <span class="emphasis"><em>D</em></span>, a background refresh thread periodically calls <code class="literal">ejbLoad</code> on stale beans within the cache. Otherwise, this option works in the same way as <span class="emphasis"><em>A</em></span>.
					</div></li></ul></div><div class="para">
				When a bean is marked for passivation, the bean is placed in a passivation queue. Each entity bean container has a passivation thread that periodically passivates beans that have been placed in the passivation queue. A bean is pulled out of the passivation queue and reused if the application requests access to a bean of the same primary key.
			</div><div class="para">
				On an exception or transaction rollback, the entity bean instance is thrown out of cache entirely. It is not put into the passivation queue and is not reused by an instance pool. Except for the passivation queue, there is no entity bean instance pooling.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Entity_Bean_Locking_and_Deadlock_Detection-Default_Locking_Behavior">
      ⁠</a>30.4.3. Default Locking Behavior</h2></div></div></div><div class="para">
				Entity bean locking is totally decoupled from the entity bean instance. The logic for locking is totally isolated and managed in a separate lock object. Because there is only one allowed instance of a given entity bean active at one time, JBoss employs two types of locks to ensure data integrity and to conform to the EJB spec.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>Method Lock</strong></span>: The method lock ensures that only one thread of execution at a time can invoke on a given Entity Bean. This is required by the EJB spec.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>Transaction Lock</strong></span>: A transaction lock ensures that only one transaction at a time has access to a give Entity Bean. This ensures the ACID properties of transactions at the application server level. Since, by default, there is only one active instance of any given Entity Bean at one time, JBoss must protect this instance from dirty reads and dirty writes. So, the default entity bean locking behavior will lock an entity bean within a transaction until it completes. This means that if any method at all is invoked on an entity bean within a transaction, no other transaction can have access to this bean until the holding transaction commits or is rolled back.
					</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Entity_Bean_Locking_and_Deadlock_Detection-Pluggable_Interceptors_and_Locking_Policy">
      ⁠</a>30.4.4. Pluggable Interceptors and Locking Policy</h2></div></div></div><div class="para">
				We saw that the basic entity bean lifecycle and behavior is defined by the container configuration defined in <code class="literal">standardjboss.xml</code> descriptor. Let us look at the <code class="literal">container-interceptors</code> definition for the <span class="emphasis"><em>Standard CMP 2.x EntityBean</em></span> configuration.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;container-interceptors&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.ProxyFactoryFinderInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.LogInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.SecurityInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.TxInterceptorCMT<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.CallValidationInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor</span><span xmlns="" class="perl_Others"> metricsEnabled=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">&gt;</span>org.jboss.ejb.plugins.MetricsInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.EntityCreationInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.EntityLockInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.EntityInstanceInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.EntityReentranceInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.resource.connectionmanager.CachedConnectionInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.EntitySynchronizationInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;interceptor&gt;</span>org.jboss.ejb.plugins.cmp.jdbc.JDBCRelationInterceptor<span xmlns="" class="perl_Keyword">&lt;/interceptor&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/container-interceptors&gt;</span>
</pre><div class="para">
				The interceptors shown above define most of the behavior of the entity bean. Below is an explanation of the interceptors that are relevant to this section.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						<span class="bold bold"><strong>EntityLockInterceptor</strong></span>: This interceptor's role is to schedule any locks that must be acquired before the invocation is allowed to proceed. This interceptor is very lightweight and delegates all locking behavior to a pluggable locking policy.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>EntityInstanceInterceptor</strong></span>: The job of this interceptor is to find the entity bean within the cache or create a new one. This interceptor also ensures that there is only one active instance of a bean in memory at one time.
					</div></li><li class="listitem"><div class="para">
						<span class="bold bold"><strong>EntitySynchronizationInterceptor</strong></span>: The role of this interceptor is to synchronize the state of the cache with the underlying storage. It does this with the <code class="literal">ejbLoad</code> and <code class="literal">ejbStore</code> semantics of the EJB specification. In the presence of a transaction this is triggered by transaction demarcation. It registers a callback with the underlying transaction monitor through the JTA interfaces. If there is no transaction the policy is to store state upon returning from invocation. The synchronization polices <span class="emphasis"><em>A</em></span>, <span class="emphasis"><em>B</em></span> and <span class="emphasis"><em>C</em></span> of the specification are taken care of here as well as the JBoss specific commit-option <span class="emphasis"><em>D</em></span>.
					</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Entity_Bean_Locking_and_Deadlock_Detection-Deadlock_">
      ⁠</a>30.4.5. Deadlock </h2></div></div></div><div class="para">
				Finding deadlock problems and resolving them is the topic of this section. We will describe what deadlocking MBeans, how you can detect it within your application, and how you can resolve deadlocks. Deadlock can occur when two or more threads have locks on shared resources. <a class="xref" href="EJBs_on_JBoss.html#Deadlock_-Deadlock_definition_example">Figure 30.8, “Deadlock definition example”</a> illustrates a simple deadlock scenario. Here, <code class="literal">Thread 1</code> has the lock for <code class="literal">Bean A</code>, and <code class="literal">Thread 2</code> has the lock for <code class="literal">Bean B</code>. At a later time, <code class="literal">Thread 1</code> tries to lock <code class="literal">Bean B</code> and blocks because <code class="literal">Thread 2</code> has it. Likewise, as <code class="literal">Thread 2</code> tries to lock A it also blocks because <code class="literal">Thread 1</code> has the lock. At this point both threads are deadlocked waiting for access to the resource already locked by the other thread.
			</div><div class="figure"><a id="Deadlock_-Deadlock_definition_example">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/deadlock-definition.png" align="middle" alt="Deadlock definition example" style="text-align: middle"/></div></div><p class="title"><strong>Figure 30.8. Deadlock definition example</strong></p></div><div class="para">
				The default locking policy of JBoss is to lock an Entity bean when an invocation occurs in the context of a transaction until the transaction completes. Because of this, it is very easy to encounter deadlock if you have long running transactions that access many entity beans, or if you are not careful about ordering the access to them. Various techniques and advanced configurations can be used to avoid deadlocking problems. They are discussed later in this section.
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Deadlock_-Deadlock_Detection">
      ⁠</a>30.4.5.1. Deadlock Detection</h3></div></div></div><div class="para">
					Fortunately, JBoss is able to perform deadlock detection. JBoss holds a global internal graph of waiting transactions and what transactions they are blocking on. Whenever a thread determines that it cannot acquire an entity bean lock, it figures out what transaction currently holds the lock on the bean and add itself to the blocked transaction graph. An example of what the graph may look like is given in <a class="xref" href="EJBs_on_JBoss.html#Deadlock_Detection-An_example_blocked_transaction_table">Table 30.1, “An example blocked transaction table”</a>.
				</div><div class="table"><a id="Deadlock_Detection-An_example_blocked_transaction_table">
      ⁠</a><p class="title"><strong>Table 30.1. An example blocked transaction table</strong></p><div class="table-contents"><table xmlns:d="http://docbook.org/ns/docbook" class="lt-4-cols lt-7-rows" summary="An example blocked transaction table"><colgroup><col/><col/></colgroup><thead><tr><th> Blocking TX </th><th> Tx that holds needed lock </th></tr></thead><tbody><tr><td> Tx1 </td><td> Tx2 </td></tr><tr><td> Tx3 </td><td> Tx4 </td></tr><tr><td> Tx4 </td><td> Tx1 </td></tr></tbody></table></div></div><div class="para">
					Before the thread actually blocks it tries to detect whether there is deadlock problem. It does this by traversing the block transaction graph. As it traverses the graph, it keeps track of what transactions are blocked. If it sees a blocked node more than once in the graph, then it knows there is deadlock and will throw an <code class="literal">ApplicationDeadlockException</code>. This exception will cause a transaction rollback which will cause all locks that transaction holds to be released.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Deadlock_-Catching_ApplicationDeadlockException">
      ⁠</a>30.4.5.2. Catching ApplicationDeadlockException</h3></div></div></div><div class="para">
					Since JBoss can detect application deadlock, you should write your application so that it can retry a transaction if the invocation fails because of the <code class="literal">ApplicationDeadlockException</code>. Unfortunately, this exception can be deeply embedded within a <code class="literal">RemoteException</code>, so you have to search for it in your catch block. For example:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">// ...</span>
<span xmlns="" class="line">​</span>} <span xmlns="" class="perl_Keyword">catch</span> (RemoteException ex) {
<span xmlns="" class="line">​</span>    Throwable cause = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>    RemoteException rex = ex;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">while</span> (rex.<span xmlns="" class="perl_Function">detail</span> != <span xmlns="" class="perl_Keyword">null</span>) {
<span xmlns="" class="line">​</span>        cause = rex.<span xmlns="" class="perl_Function">detail</span>;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> (cause <span xmlns="" class="perl_Keyword">instanceof</span> ApplicationDeadlockException) {
<span xmlns="" class="line">​</span>	        <span xmlns="" class="perl_Comment">// ... We have deadlock, force a retry of the transaction.</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">break</span>;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> (cause <span xmlns="" class="perl_Keyword">instanceof</span> RemoteException) {
<span xmlns="" class="line">​</span>            rex = (RemoteException)cause;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Deadlock_-Viewing_Lock_Information">
      ⁠</a>30.4.5.3. Viewing Lock Information</h3></div></div></div><div class="para">
					The <code class="literal">EntityLockMonitor</code> MBean service allows one to view basic locking statistics as well as printing out the state of the transaction locking table. To enable this monitor uncomment its configuration in the <code class="literal">conf/jboss-service.xml</code>:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.monitor.EntityLockMonitor"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">       name=</span><span xmlns="" class="perl_String">"jboss.monitor:name=EntityLockMonitor"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
</pre><div class="para">
					The <code class="literal">EntityLockMonitor</code> has no configurable attributes. It does have the following read-only attributes:
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							<span class="bold bold"><strong>MedianWaitTime</strong></span>: The median value of all times threads had to wait to acquire a lock.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>AverageContenders</strong></span>: The ratio of the total number of contentions to the sum of all threads that had to wait for a lock.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>TotalContentions</strong></span>: The total number of threads that had to wait to acquire the transaction lock. This happens when a thread attempts to acquire a lock that is associated with another transaction
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>MaxContenders</strong></span>: The maximum number of threads that were waiting to acquire the transaction lock.
						</div></li></ul></div><div class="para">
					It also has the following operations:
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							<span class="bold bold"><strong>clearMonitor</strong></span>: This operation resets the lock monitor state by zeroing all counters.
						</div></li><li class="listitem"><div class="para">
							<span class="bold bold"><strong>printLockMonitor</strong></span>: This operation prints out a table of all EJB locks that lists the <code class="literal">ejbName</code> of the bean, the total time spent waiting for the lock, the count of times the lock was waited on and the number of transactions that timed out waiting for the lock.
						</div></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Entity_Bean_Locking_and_Deadlock_Detection-Advanced_Configurations_and_Optimizations">
      ⁠</a>30.4.6. Advanced Configurations and Optimizations</h2></div></div></div><div class="para">
				The default locking behavior of entity beans can cause deadlock. Since access to an entity bean locks the bean into the transaction, this also can present a huge performance/throughput problem for your application. This section walks through various techniques and configurations that you can use to optimize performance and reduce the possibility of deadlock.
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Advanced_Configurations_and_Optimizations-Short_lived_Transactions">
      ⁠</a>30.4.6.1. Short-lived Transactions</h3></div></div></div><div class="para">
					Make your transactions as short-lived and fine-grained as possible. The shorter the transaction you have, the less likelihood you will have concurrent access collisions and your application throughput will go up.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Advanced_Configurations_and_Optimizations-Ordered_Access">
      ⁠</a>30.4.6.2. Ordered Access</h3></div></div></div><div class="para">
					Ordering the access to your entity beans can help lessen the likelihood of deadlock. This means making sure that the entity beans in your system are always accessed in the same exact order. In most cases, user applications are just too complicated to use this approach and more advanced configurations are needed.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Advanced_Configurations_and_Optimizations-Read_Only_Beans">
      ⁠</a>30.4.6.3. Read-Only Beans</h3></div></div></div><div class="para">
					Entity beans can be marked as read-only. When a bean is marked as read-only, it never takes part in a transaction. This means that it is never transactionally locked. Using commit-option <span class="emphasis"><em>D</em></span> with this option is sometimes very useful when your read-only bean's data is sometimes updated by an external source.
				</div><div class="para">
					To mark a bean as read-only, use the <code class="literal">read-only</code> flag in the <code class="literal">jboss.xml</code> deployment descriptor.
				</div><div class="example"><a id="Read_Only_Beans-Marking_an_entity_bean_read_only_using_jboss.xml">
      ⁠</a><p class="title"><strong>Example 30.11. Marking an entity bean read-only using jboss.xml</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>MyEntityBean<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;jndi-name&gt;</span>MyEntityHomeRemote<span xmlns="" class="perl_Keyword">&lt;/jndi-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;read-only&gt;</span>True<span xmlns="" class="perl_Keyword">&lt;/read-only&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss&gt;</span>
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Advanced_Configurations_and_Optimizations-Explicitly_Defining_Read_Only_Methods">
      ⁠</a>30.4.6.4. Explicitly Defining Read-Only Methods</h3></div></div></div><div class="para">
					After reading and understanding the default locking behavior of entity beans, you are probably wondering, "Why lock the bean if its not modifying the data?" JBoss allows you to define what methods on your entity bean are read only so that it will not lock the bean within the transaction if only these types of methods are called. You can define these read only methods within a <code class="literal">jboss.xml</code> deployment descriptor. Wildcards are allowed for method names. The following is an example of declaring all getter methods and the <code class="literal">anotherReadOnlyMethod</code> as read-only.
				</div><div class="example"><a id="Explicitly_Defining_Read_Only_Methods-Defining_entity_bean_methods_as_read_only">
      ⁠</a><p class="title"><strong>Example 30.12. Defining entity bean methods as read only</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>nextgen.EnterpriseEntity<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;jndi-name&gt;</span>nextgen.EnterpriseEntity<span xmlns="" class="perl_Keyword">&lt;/jndi-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;method-attributes&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;method&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>get*<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;read-only&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/read-only&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/method&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;method&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;method-name&gt;</span>anotherReadOnlyMethod<span xmlns="" class="perl_Keyword">&lt;/method-name&gt;</span>
<span xmlns="" class="line">​</span>                    <span xmlns="" class="perl_Keyword">&lt;read-only&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/read-only&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;/method&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/method-attributes&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss&gt;</span>
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Advanced_Configurations_and_Optimizations-Instance_Per_Transaction_Policy">
      ⁠</a>30.4.6.5. Instance Per Transaction Policy</h3></div></div></div><div class="para">
					The Instance Per Transaction policy is an advanced configuration that can totally wipe away deadlock and throughput problems caused by JBoss's default locking policy. The default Entity Bean locking policy is to only allow one active instance of a bean. The Instance Per Transaction policy breaks this requirement by allocating a new instance of a bean per transaction and dropping this instance at the end of the transaction. Because each transaction has its own copy of the bean, there is no need for transaction based locking.
				</div><div class="para">
					This option does sound great but does have some drawbacks right now. First, the transactional isolation behavior of this option is equivalent to <code class="literal">READ_COMMITTED</code>. This can create repeatable reads when they are not desired. In other words, a transaction could have a copy of a stale bean. Second, this configuration option currently requires commit-option <span class="emphasis"><em>B</em></span> or <span class="emphasis"><em>C</em></span> which can be a performance drain since an ejbLoad must happen at the beginning of the transaction. But, if your application currently requires commit-option <span class="emphasis"><em>B</em></span> or <span class="emphasis"><em>C</em></span> anyways, then this is the way to go. The JBoss developers are currently exploring ways to allow commit-option <span class="emphasis"><em>A</em></span> as well (which would allow the use of caching for this option).
				</div><div class="para">
					JBoss has container configurations named <code class="literal">Instance Per Transaction CMP 2.x EntityBean</code> and <code class="literal">Instance Per Transaction BMP EntityBean</code> defined in the standardjboss.xml that implement this locking policy. To use this configuration, you just have to reference the name of the container configuration to use with your bean in the jboss.xml deployment descriptor as show below.
				</div><div class="example"><a id="Instance_Per_Transaction_Policy-An_example_of_using_the_Instance_Per_Transaction_policy.">
      ⁠</a><p class="title"><strong>Example 30.13. An example of using the Instance Per Transaction policy.</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>MyCMP2Bean<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;jndi-name&gt;</span>MyCMP2<span xmlns="" class="perl_Keyword">&lt;/jndi-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;configuration-name&gt;</span>
<span xmlns="" class="line">​</span>                Instance Per Transaction CMP 2.x EntityBean
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/configuration-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;entity&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;ejb-name&gt;</span>MyBMPBean<span xmlns="" class="perl_Keyword">&lt;/ejb-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;jndi-name&gt;</span>MyBMP<span xmlns="" class="perl_Keyword">&lt;/jndi-name&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;configuration-name&gt;</span>
<span xmlns="" class="line">​</span>                Instance Per Transaction BMP EntityBean
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/configuration-name&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/entity&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/enterprise-beans&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss&gt;</span>
</pre></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Entity_Bean_Locking_and_Deadlock_Detection-Running_Within_a_Cluster">
      ⁠</a>30.4.7. Running Within a Cluster</h2></div></div></div><div class="para">
				Currently there is no distributed locking capability for entity beans within the cluster. This functionality has been delegated to the database and must be supported by the application developer. For clustered entity beans, it is suggested to use commit-option <span class="emphasis"><em>B</em></span> or <span class="emphasis"><em>C</em></span> in combination with a row locking mechanism. For CMP, there is a row-locking configuration option. This option will use a SQL <code class="literal">select for update</code> when the bean is loaded from the database. With commit-option <span class="emphasis"><em>B</em></span> or <span class="emphasis"><em>C</em></span>, this implements a transactional lock that can be used across the cluster. For BMP, you must explicitly implement the select for update invocation within the BMP's <code class="literal">ejbLoad</code> method.
			</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Entity_Bean_Locking_and_Deadlock_Detection-Troubleshooting">
      ⁠</a>30.4.8. Troubleshooting</h2></div></div></div><div class="para">
				This section will describe some common locking problems and their solution.
			</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Troubleshooting-Locking_Behavior_Not_Working">
      ⁠</a>30.4.8.1. Locking Behavior Not Working</h3></div></div></div><div class="para">
					Many JBoss users observe that locking does not seem to be working and see concurrent access to their beans, and thus dirty reads. Here are some common reasons for this:
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							If you have custom <code class="literal">container-configurations</code>, make sure you have updated these configurations.
						</div></li><li class="listitem"><div class="para">
							Make absolutely sure that you have implemented <code class="literal">equals</code> and <code class="literal">hashCode</code> correctly from custom/complex primary key classes.
						</div></li><li class="listitem"><div class="para">
							Make absolutely sure that your custom/complex primary key classes serialize correctly. One common mistake is assuming that member variable initializations will be executed when a primary key is unmarshaled.
						</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Troubleshooting-IllegalStateException">
      ⁠</a>30.4.8.2. IllegalStateException</h3></div></div></div><div class="para">
					An IllegalStateException with the message "removing bean lock and it has tx set!" usually means that you have not implemented <code class="literal">equals</code> and/or <code class="literal">hashCode</code> correctly for your custom/complex primary key class, or that your primary key class is not implemented correctly for serialization.
				</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Troubleshooting-Hangs_and_Transaction_Timeouts">
      ⁠</a>30.4.8.3. Hangs and Transaction Timeouts</h3></div></div></div><div class="para">
					One long outstanding bug of JBoss is that on a transaction timeout, that transaction is only marked for a rollback and not actually rolled back. This responsibility is delegated to the invocation thread. This can cause major problems if the invocation thread hangs indefinitely since things like entity bean locks will never be released. The solution to this problem is not a good one. You really just need to avoid doing stuff within a transaction that could hang indefinitely. One common mistake is making connections across the internet or running a web-crawler within a transaction.
				</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="EJBs_on_JBoss-EJB_Timer_Configuration">
      ⁠</a>30.5. EJB Timer Configuration</h1></div></div></div><div class="para">
			The J2EE timer service allows for any EJB object to register for a timer callback either at a designated time in the future. Timer events can be used for auditing, reporting or other cleanup tasks that need to need to happen at some given time in the future. Timer events are intended to be persistent and should be executed even in the event of a server failure. Coding to EJB timers is a standard part of the J2EE specification, so we will not explore the programming model. We will, instead, look at the configuration of the timer service in JBoss so that you can understand how to make timers work best in your environment
		</div><div class="para">
			The EJB timer service is configure by several related MBeans in the <code class="literal">ejb-deployer.xml</code> file. The primary MBean is the <code class="literal">EJBTimerService</code> MBean.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.ejb.txtimer.EJBTimerServiceImpl"</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"jboss.ejb:service=EJBTimerService"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"RetryPolicy"</span><span xmlns="" class="perl_Keyword">&gt;</span>jboss.ejb:service=EJBTimerService,retryPolicy=fixedDelay<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"PersistencePolicy"</span><span xmlns="" class="perl_Keyword">&gt;</span>jboss.ejb:service=EJBTimerService,persistencePolicy=database<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"TimerIdGeneratorClassName"</span><span xmlns="" class="perl_Keyword">&gt;</span>org.jboss.ejb.txtimer.BigIntegerTimerIdGenerator<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"TimedObjectInvokerClassName"</span><span xmlns="" class="perl_Keyword">&gt;</span>org.jboss.ejb.txtimer.TimedObjectInvokerImpl<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span>
</pre><div class="para">
			The <code class="literal">EJBTimerService</code> has the following configurable attributes:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					<span class="bold bold"><strong>RetryPolicy</strong></span>: This is name of the MBean that implements the retry policy. The MBean must support the <code class="literal">org.jboss.ejb.txtimer.RetryPolicy interface</code>. JBoss provides one implementation, <code class="literal">FixedDelayRetryPolicy</code>, which will be described later.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>PersistencePolicy</strong></span>: This is the name of the MBean that implements the persistence strategy for saving timer events. The MBean must support the <code class="literal">org.jboss.ejb.txtimer.PersistencePolicy</code> interface. JBoss provides two implementations, NoopPersistencePolicy and DatabasePersistencePolicy, which will be described later.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>TimerIdGeneratorClassName</strong></span>: This is the name of a class that provides the timer ID generator strategy. This class must implement the <code class="literal">org.jboss.ejb.txtimer.TimerIdGenerator</code> interface. JBoss provides the <code class="literal">org.jboss.ejb.txtimer.BigIntegerTimerIdGenerator</code> implementation.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>TimedObjectInvokerClassname</strong></span>: This is the name of a class that provides the timer method invocation strategy. This class must implement the <code class="literal">org.jboss.ejb.txtimer.TimedObjectInvoker</code> interface. JBoss provides the <code class="literal">org.jboss.ejb.txtimer.TimedObjectInvokerImpl</code> implementation.
				</div></li></ul></div><div class="para">
			The retry policy MBean definition used is shown here:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.ejb.txtimer.FixedDelayRetryPolicy"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">       name=</span><span xmlns="" class="perl_String">"jboss.ejb:service=EJBTimerService,retryPolicy=fixedDelay"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"Delay"</span><span xmlns="" class="perl_Keyword">&gt;</span>100<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span>
</pre><div class="para">
			The retry policy takes one configuration value:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					<span class="bold bold"><strong>Delay</strong></span>: This is the delay (ms) before retrying a failed timer execution. The default delay is 100ms.
				</div></li></ul></div><div class="para">
			If EJB timers do not need to be persisted, the <code class="literal">NoopPersistence</code> policy can be used. This MBean is commented out by default, but when enabled will look like this:
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.ejb.txtimer.NoopPersistencePolicy"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">       name=</span><span xmlns="" class="perl_String">"jboss.ejb:service=EJBTimerService,persistencePolicy=noop"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
</pre><div class="para">
			Most applications that use timers will want timers to be persisted. For that the <code class="literal">DatabasePersitencePolicy</code> MBean should be used.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.ejb.txtimer.DatabasePersistencePolicy"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">       name=</span><span xmlns="" class="perl_String">"jboss.ejb:service=EJBTimerService,persistencePolicy=database"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- DataSource JNDI name --&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;depends</span><span xmlns="" class="perl_Others"> optional-attribute-name=</span><span xmlns="" class="perl_String">"DataSource"</span><span xmlns="" class="perl_Keyword">&gt;</span>jboss.jca:service=DataSourceBinding,name=DefaultDS<span xmlns="" class="perl_Keyword">&lt;/depends&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- The plugin that handles database persistence --&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"DatabasePersistencePlugin"</span><span xmlns="" class="perl_Keyword">&gt;</span>org.jboss.ejb.txtimer.GeneralPurposeDatabasePersistencePlugin<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span>
</pre><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					<span class="bold bold"><strong>DataSource</strong></span>: This is the MBean for the DataSource that timer data will be written to.
				</div></li><li class="listitem"><div class="para">
					<span class="bold bold"><strong>DatabasePersistencePlugin</strong></span>: This is the name of the class the implements the persistence strategy. This should be <code class="literal">org.jboss.ejb.txtimer.GeneralPurposeDatabasePersistencePlugin</code>.
				</div></li></ul></div></div></div></body></html>