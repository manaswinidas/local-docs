<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 9. The ClassLoading Layer</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="chap-JBoss_Microcontainer_User_Guide-The_ClassLoading_Layer">
      ⁠</a>Chapter 9. The ClassLoading Layer</h1></div></div></div><div class="para">
		JBoss has always had a unique way of dealing with classloading, and the new classloading layer that comes with the Microcontainer is no exception ClassLoading is an optional add-on that you can use when you want non-default classloading. With the rising demand for OSGi-style classloading, and a number of new Java classloading specifications on the horizon, the changes to the ClassLoading layer of EAP 5.1 are useful and timely.
	</div><div class="para">
		The Microcontainer ClassLoading layer is an abstraction layer. Most of the details are hidden behind private and package-private methods, without compromising the extensibility and functionality available through public classes and methods that make the API. This means that you code against policy and not against classloader details.
	</div><div class="para">
		The ClassLoader project is split into 3 sub-projects
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				classloader
			</div></li><li class="listitem"><div class="para">
				classloading
			</div></li><li class="listitem"><div class="para">
				classloading-vfs
			</div></li></ul></div><div class="para">
		<code class="classname">classloader</code> contains a custom <code class="classname">java.lang.ClassLoader</code> extension without any specific classloading policy. A classloading policy includes knowledge of where to load from and how to load.
	</div><div class="para">
		<code class="interfacename">Classloading</code> is an extension of Microcontainer’s dependency mechanisms. Its VFS-backed implementation is <code class="interfacename">classloading-vfs</code>. See <a class="xref" href="chap-JBoss_Microcontainer_User_Guide-The_Virtual_File_System_Classloading_and_Deployers.html">Chapter 8, <em>The Virtual File System</em></a> for more information on VFS.
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-JBoss_Microcontainer_User_Guide-The_ClassLoading_Layer-ClassLoader">
      ⁠</a>9.1. ClassLoader</h1></div></div></div><div class="para">
			The <code class="classname">ClassLoader</code> implementation supports pluggable policies and is itself a final class, not meant to be altered. To write your own ClassLoader implementations, write a <code class="classname">ClassLoaderPolicy</code> which provides a simpler API for locating classes and resources, and for specifying other rules associated with the classloader.
		</div><div class="para">
			To customize classloading, instantiate a <code class="classname">ClassLoaderPolicy</code> and register it with a <code class="classname">ClassLoaderSystem</code> to create a custom <code class="classname">ClassLoader</code>. You can also create a <code class="classname">ClassLoaderDomain</code> to partition the <code class="classname">ClassLoaderSystem</code>.
		</div><div class="para">
			The <code class="classname">ClassLoader</code> layer also includes the implementation of things like DelegateLoader model, classloading, resource filters, and parent-child delegation policies.
		</div><div class="para">
			The run-time is JMX enabled to expose the policy used for each classloader. It also provides classloading statistics and debugging methods to help determine where things are loaded from.
		</div><div class="example"><a id="exam-JBoss_Microcontainer_User_Guide-ClassLoader-ClassLoaderPolicy_Example">
      ⁠</a><p class="title"><strong>Example 9.1. <code class="classname">ClassLoaderPolicy</code> Class</strong></p><div class="example-contents"><div class="para">
				The <code class="classname">ClassLoaderPolicy</code> controls the way your classloading works.
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> ClassLoaderPolicy <span xmlns="" class="perl_Keyword">extends</span> BaseClassLoaderPolicy {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> DelegateLoader <span xmlns="" class="perl_Function">getExported</span>()
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">public</span> String[] <span xmlns="" class="perl_Function">getPackageNames</span>()
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">protected</span> List&lt;? <span xmlns="" class="perl_Keyword">extends</span> DelegateLoader&gt; <span xmlns="" class="perl_Function">getDelegates</span>()
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">isImportAll</span>()
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">isCacheable</span>()
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">isBlackListable</span>()
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> URL <span xmlns="" class="perl_Function">getResource</span>(String path);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> InputStream <span xmlns="" class="perl_Function">getResourceAsStream</span>(String path)
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">getResources</span>(String name, Set&lt;URL&gt; urls) <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> ProtectionDomain <span xmlns="" class="perl_Function">getProtectionDomain</span>(String className, String path)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">public</span> PackageInformation <span xmlns="" class="perl_Function">getPackageInformation</span>(String packageName)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">public</span> PackageInformation <span xmlns="" class="perl_Function">getClassPackageInformation</span>(String className, String packageName)
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">protected</span> ClassLoader <span xmlns="" class="perl_Function">isJDKRequest</span>(String name)
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre></div></div><div class="para">
			The following two examples of <code class="classname">ClassLoaderPolicy</code>. The first one retrieves resources based on regular expressions, while the second one handles encrypted resources.
		</div><div class="example"><a id="exam-JBoss_Microcontainer_User_Guide-ClassLoader-ClassLoaderPolicy_with_Regular_Expression_Support">
      ⁠</a><p class="title"><strong>Example 9.2. ClassLoaderPolicy with Regular Expression Support</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> RegexpClassLoaderPolicy <span xmlns="" class="perl_Keyword">extends</span> ClassLoaderPolicy {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> VirtualFile[] roots;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String[] packageNames;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Function">RegexpClassLoaderPolicy</span>(VirtualFile[] roots)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">this</span>.<span xmlns="" class="perl_Function">roots</span> = roots;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    @Override
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> String[] <span xmlns="" class="perl_Function">getPackageNames</span>()
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">if</span> (packageNames == <span xmlns="" class="perl_Keyword">null</span>)
<span xmlns="" class="line">​</span>	    {
<span xmlns="" class="line">​</span>		Set&lt;String&gt; exportedPackages = PackageVisitor.<span xmlns="" class="perl_Function">determineAllPackages</span>(roots, <span xmlns="" class="perl_Keyword">null</span>, ExportAll.<span xmlns="" class="perl_Function">NON_EMPTY</span>, <span xmlns="" class="perl_Keyword">null</span>, <span xmlns="" class="perl_Keyword">null</span>, <span xmlns="" class="perl_Keyword">null</span>);
<span xmlns="" class="line">​</span>		packageNames = exportedPackages.<span xmlns="" class="perl_Function">toArray</span>(<span xmlns="" class="perl_Keyword">new</span> String[exportedPackages.<span xmlns="" class="perl_Function">size</span>()]);
<span xmlns="" class="line">​</span>	    }
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">return</span> packageNames;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> Pattern <span xmlns="" class="perl_Function">createPattern</span>(String regexp)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_DataType">boolean</span> outside = <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>	StringBuilder builder = <span xmlns="" class="perl_Keyword">new</span> StringBuilder();
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">for</span> (<span xmlns="" class="perl_DataType">int</span> i = <span xmlns="" class="perl_Float">0</span>; i &lt; regexp.<span xmlns="" class="perl_Function">length</span>(); i++)
<span xmlns="" class="line">​</span>	    {
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_DataType">char</span> ch = regexp.<span xmlns="" class="perl_Function">charAt</span>(i);
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">if</span> ((ch == <span xmlns="" class="perl_Char">'['</span> || ch == <span xmlns="" class="perl_Char">']'</span> || ch == <span xmlns="" class="perl_Char">'.'</span>) &amp;&amp; <span xmlns="" class="perl_Function">escaped</span>(regexp, i) == <span xmlns="" class="perl_Keyword">false</span>)
<span xmlns="" class="line">​</span>		    {
<span xmlns="" class="line">​</span>			<span xmlns="" class="perl_Keyword">switch</span> (ch)
<span xmlns="" class="line">​</span>			    {
<span xmlns="" class="line">​</span>			    <span xmlns="" class="perl_Keyword">case</span> <span xmlns="" class="perl_Char">'['</span> : outside = <span xmlns="" class="perl_Keyword">false</span>; <span xmlns="" class="perl_Keyword">break</span>;
<span xmlns="" class="line">​</span>			    <span xmlns="" class="perl_Keyword">case</span> <span xmlns="" class="perl_Char">']'</span> : outside = <span xmlns="" class="perl_Keyword">true</span>; <span xmlns="" class="perl_Keyword">break</span>;
<span xmlns="" class="line">​</span>			    <span xmlns="" class="perl_Keyword">case</span> <span xmlns="" class="perl_Char">'.'</span> : <span xmlns="" class="perl_Keyword">if</span> (outside) builder.<span xmlns="" class="perl_Function">append</span>(<span xmlns="" class="perl_String">"\</span><span xmlns="" class="perl_Char">\"</span><span xmlns="" class="perl_String">); break;</span>
<span xmlns="" class="line">​</span>			    }
<span xmlns="" class="line">​</span>		    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>		builder.<span xmlns="" class="perl_Function">append</span>(ch);
<span xmlns="" class="line">​</span>	    }
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">return</span> Pattern.<span xmlns="" class="perl_Function">compile</span>(builder.<span xmlns="" class="perl_Function">toString</span>());
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">escaped</span>(String regexp, <span xmlns="" class="perl_DataType">int</span> i)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">return</span> i &gt; <span xmlns="" class="perl_Float">0</span> &amp;&amp; regexp.<span xmlns="" class="perl_Function">charAt</span>(i - <span xmlns="" class="perl_Float">1</span>) == '\\';
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> URL <span xmlns="" class="perl_Function">getResource</span>(String path)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	Pattern pattern = <span xmlns="" class="perl_Function">createPattern</span>(path);
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">for</span> (VirtualFile root : roots)
<span xmlns="" class="line">​</span>	    {
<span xmlns="" class="line">​</span>		URL url = <span xmlns="" class="perl_Function">findURL</span>(root, root, pattern);
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">if</span> (url != <span xmlns="" class="perl_Keyword">null</span>)
<span xmlns="" class="line">​</span>		    <span xmlns="" class="perl_Keyword">return</span> url;
<span xmlns="" class="line">​</span>	    }
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> URL <span xmlns="" class="perl_Function">findURL</span>(VirtualFile root, VirtualFile file, Pattern pattern)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>	    {
<span xmlns="" class="line">​</span>		String path = AbstractStructureDeployer.<span xmlns="" class="perl_Function">getRelativePath</span>(root, file);
<span xmlns="" class="line">​</span>		Matcher matcher = pattern.<span xmlns="" class="perl_Function">matcher</span>(path);
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">if</span> (matcher.<span xmlns="" class="perl_Function">matches</span>())
<span xmlns="" class="line">​</span>		    <span xmlns="" class="perl_Keyword">return</span> file.<span xmlns="" class="perl_Function">toURL</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>		List&lt;VirtualFile&gt; children = file.<span xmlns="" class="perl_Function">getChildren</span>();
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">for</span> (VirtualFile child : children)
<span xmlns="" class="line">​</span>		    {
<span xmlns="" class="line">​</span>			URL url = <span xmlns="" class="perl_Function">findURL</span>(root, child, pattern);
<span xmlns="" class="line">​</span>			<span xmlns="" class="perl_Keyword">if</span> (url != <span xmlns="" class="perl_Keyword">null</span>)
<span xmlns="" class="line">​</span>			    <span xmlns="" class="perl_Keyword">return</span> url;
<span xmlns="" class="line">​</span>		    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>	    }
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">catch</span> (Exception e)
<span xmlns="" class="line">​</span>	    {
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> RuntimeException(e);
<span xmlns="" class="line">​</span>	    }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">getResources</span>(String name, Set&lt;URL&gt; urls) <span xmlns="" class="perl_Keyword">throws</span> IOException
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	Pattern pattern = <span xmlns="" class="perl_Function">createPattern</span>(name);
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">for</span> (VirtualFile root : roots)
<span xmlns="" class="line">​</span>	    {
<span xmlns="" class="line">​</span>		RegexpVisitor visitor = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">RegexpVisitor</span>(root, pattern);
<span xmlns="" class="line">​</span>		root.<span xmlns="" class="perl_Function">visit</span>(visitor);
<span xmlns="" class="line">​</span>		urls.<span xmlns="" class="perl_Function">addAll</span>(visitor.<span xmlns="" class="perl_Function">getUrls</span>());
<span xmlns="" class="line">​</span>	    }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_Keyword">class</span> RegexpVisitor <span xmlns="" class="perl_Keyword">implements</span> VirtualFileVisitor
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">private</span> VirtualFile root;
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">private</span> Pattern pattern;
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">private</span> Set&lt;URL&gt; urls = <span xmlns="" class="perl_Keyword">new</span> HashSet&lt;URL&gt;();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_Function">RegexpVisitor</span>(VirtualFile root, Pattern pattern)
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">this</span>.<span xmlns="" class="perl_Function">root</span> = root;
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">this</span>.<span xmlns="" class="perl_Function">pattern</span> = pattern;
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> VisitorAttributes <span xmlns="" class="perl_Function">getAttributes</span>()
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">return</span> VisitorAttributes.<span xmlns="" class="perl_Function">RECURSE_LEAVES_ONLY</span>;
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">visit</span>(VirtualFile file)
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>		{
<span xmlns="" class="line">​</span>		    String path = AbstractStructureDeployer.<span xmlns="" class="perl_Function">getRelativePath</span>(root, file);
<span xmlns="" class="line">​</span>		    Matcher matcher = pattern.<span xmlns="" class="perl_Function">matcher</span>(path);
<span xmlns="" class="line">​</span>		    <span xmlns="" class="perl_Keyword">if</span> (matcher.<span xmlns="" class="perl_Function">matches</span>())
<span xmlns="" class="line">​</span>			urls.<span xmlns="" class="perl_Function">add</span>(file.<span xmlns="" class="perl_Function">toURL</span>());
<span xmlns="" class="line">​</span>		}
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">catch</span> (Exception e)
<span xmlns="" class="line">​</span>		{
<span xmlns="" class="line">​</span>		    <span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> RuntimeException(e);
<span xmlns="" class="line">​</span>		}
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">public</span> Set&lt;URL&gt; <span xmlns="" class="perl_Function">getUrls</span>()
<span xmlns="" class="line">​</span>	{
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">return</span> urls;
<span xmlns="" class="line">​</span>	}
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre><div class="para">
				<code class="classname">RegexpClassLoaderPolicy</code> uses a simplistic mechanism to find matching resources. Real-world implementations would be more comprehensive and elegant.
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> RegexpService <span xmlns="" class="perl_Keyword">extends</span> PrintService {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">start</span>() <span xmlns="" class="perl_Keyword">throws</span> Exception
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	System.<span xmlns="" class="perl_Function">out</span>.<span xmlns="" class="perl_Function">println</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	ClassLoader cl = <span xmlns="" class="perl_Function">getClass</span>().<span xmlns="" class="perl_Function">getClassLoader</span>();
<span xmlns="" class="line">​</span>	Enumeration&lt;URL&gt; urls = cl.<span xmlns="" class="perl_Function">getResources</span>(<span xmlns="" class="perl_String">"config/[^.]+\\.[^.]{1,4}"</span>);
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">while</span> (urls.<span xmlns="" class="perl_Function">hasMoreElements</span>())
<span xmlns="" class="line">​</span>	    {
<span xmlns="" class="line">​</span>		URL url = urls.<span xmlns="" class="perl_Function">nextElement</span>();
<span xmlns="" class="line">​</span>		<span xmlns="" class="perl_Function">print</span>(url.<span xmlns="" class="perl_Function">openStream</span>(), url.<span xmlns="" class="perl_Function">toExternalForm</span>());
<span xmlns="" class="line">​</span>	    }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre><div class="para">
				The regexp service uses the regular expression pattern <code class="systemitem">config/[^.]+\\.[^.]{1,4}</code> to list resources under the <code class="filename">config/</code>/ directory. The suffix length is limited, such that file names such as excluded.properties will be ignored.
			</div></div></div><div class="example"><a id="exam-JBoss_Microcontainer_User_Guide-ClassLoader-ClassLoaderPolicy_with_Encryption_Support">
      ⁠</a><p class="title"><strong>Example 9.3. ClassLoaderPolicy with Encryption Support</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> CrypterClassLoaderPolicy <span xmlns="" class="perl_Keyword">extends</span> VFSClassLoaderPolicy {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> Crypter crypter;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Function">CrypterClassLoaderPolicy</span>(String name, VirtualFile[] roots, VirtualFile[] excludedRoots, Crypter crypter) {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">super</span>(name, roots, excludedRoots);
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">this</span>.<span xmlns="" class="perl_Function">crypter</span> = crypter;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    @Override
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> URL <span xmlns="" class="perl_Function">getResource</span>(String path) {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span>
<span xmlns="" class="line">​</span>            {
<span xmlns="" class="line">​</span>                URL resource = <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getResource</span>(path);
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Function">wrap</span>(resource);
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">catch</span> (IOException e)
<span xmlns="" class="line">​</span>            {
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> RuntimeException(e);
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    @Override
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> InputStream <span xmlns="" class="perl_Function">getResourceAsStream</span>(String path) {
<span xmlns="" class="line">​</span>        InputStream stream = <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getResourceAsStream</span>(path);
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> crypter.<span xmlns="" class="perl_Function">crypt</span>(stream);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    @Override
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">getResources</span>(String name, Set&lt;URL&gt; urls) <span xmlns="" class="perl_Keyword">throws</span> IOException {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getResources</span>(name, urls);
<span xmlns="" class="line">​</span>        Set&lt;URL&gt; temp = <span xmlns="" class="perl_Keyword">new</span> HashSet&lt;URL&gt;(urls.<span xmlns="" class="perl_Function">size</span>());
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">for</span> (URL url : urls)
<span xmlns="" class="line">​</span>            {
<span xmlns="" class="line">​</span>                temp.<span xmlns="" class="perl_Function">add</span>(<span xmlns="" class="perl_Function">wrap</span>(url));
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>        urls.<span xmlns="" class="perl_Function">clear</span>();
<span xmlns="" class="line">​</span>        urls.<span xmlns="" class="perl_Function">addAll</span>(temp);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> URL <span xmlns="" class="perl_Function">wrap</span>(URL url) <span xmlns="" class="perl_Keyword">throws</span> IOException {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">new</span> URL(url.<span xmlns="" class="perl_Function">getProtocol</span>(), url.<span xmlns="" class="perl_Function">getHost</span>(), url.<span xmlns="" class="perl_Function">getPort</span>(), url.<span xmlns="" class="perl_Function">getFile</span>(), <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">CrypterURLStreamHandler</span>(crypter));
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre><div class="para">
				<a class="xref" href="chap-JBoss_Microcontainer_User_Guide-The_ClassLoading_Layer.html#exam-JBoss_Microcontainer_User_Guide-ClassLoader-ClassLoaderPolicy_with_Encryption_Support">Example 9.3, “ClassLoaderPolicy with Encryption Support”</a> shows how to encrypt JARs. You can configure which resources to encrypt by specifying a proper filter. Here, everything is encrypted except for the contents of the <code class="filename">META-INF/</code> directory.
			</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> EncryptedService <span xmlns="" class="perl_Keyword">extends</span> PrintService {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">start</span>() <span xmlns="" class="perl_Keyword">throws</span> Exception
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>	ClassLoader cl = <span xmlns="" class="perl_Function">getClass</span>().<span xmlns="" class="perl_Function">getClassLoader</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	URL url = cl.<span xmlns="" class="perl_Function">getResource</span>(<span xmlns="" class="perl_String">"config/settings.txt"</span>);
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">if</span> (url == <span xmlns="" class="perl_Keyword">null</span>)
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> IllegalArgumentException(<span xmlns="" class="perl_String">"No such settings.txt."</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	InputStream is = url.<span xmlns="" class="perl_Function">openStream</span>();
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Function">print</span>(is, <span xmlns="" class="perl_String">"Printing settings:</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">"</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	is = cl.<span xmlns="" class="perl_Function">getResourceAsStream</span>(<span xmlns="" class="perl_String">"config/properties.xml"</span>);
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">if</span> (is == <span xmlns="" class="perl_Keyword">null</span>)
<span xmlns="" class="line">​</span>	    <span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> IllegalArgumentException(<span xmlns="" class="perl_String">"No such properties.xml."</span>);
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Function">print</span>(is, <span xmlns="" class="perl_String">"</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">Printing properties:</span><span xmlns="" class="perl_Char">\n</span><span xmlns="" class="perl_String">"</span>);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre><div class="para">
				This service prints out the contents of two configuration files. It shows that decryption of any encrypted resources is hidden behind the classloading layer.
			</div><div class="para">
				To properly test this, either encrypt the policy module yourself or use an existing encrypted one. To put this into action, you need to properly tie EncryptedService to <code class="classname">ClassLoaderSystem</code> and deployers.
			</div><div class="para">
				Partitioning <code class="classname">ClassLoaderSystem</code> is discussed later in this chapter.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-JBoss_Microcontainer_User_Guide-The_ClassLoading_Layer-ClassLoading">
      ⁠</a>9.2. ClassLoading</h1></div></div></div><div class="para">
			Instead of using the <code class="classname">ClassLoader</code> abstraction directly, you can create <code class="classname">ClassLoading</code> modules which contain declarations of <code class="classname">ClassLoader</code> dependencies. Once the dependencies are specified the <code class="classname">ClassLoaderPolicy</code>s are constructed and wired together accordingly.
		</div><div class="para">
			To facilitate defining the <code class="classname">ClassLoaders</code> before they actually exist, the abstraction includes a <code class="classname">ClassLoadingMetaData</code> model.
		</div><div class="para">
			The <code class="classname">ClassLoadingMetaData</code> can be exposed as a Managed Object within the new JBoss EAP profile service. This helps system administrators to deal with more abstract policy details rather than the implementation details.
		</div><div class="example"><a id="idm139732969051376">
      ⁠</a><p class="title"><strong>Example 9.4. ClassLoadingMetaData Exposed as a Managed Object</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> ClassLoadingMetaData <span xmlns="" class="perl_Keyword">extends</span> NameAndVersionSupport {
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The serialVersionUID */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_DataType">final</span> <span xmlns="" class="perl_DataType">long</span> serialVersionUID = <span xmlns="" class="perl_DecVal">-2782951093046585620L</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The classloading domain */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String domain;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The parent domain */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String parentDomain;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** Whether to make a subdeployment classloader a top-level classloader */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">boolean</span> topLevelClassLoader = <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** Whether to enforce j2se classloading compliance */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">boolean</span> j2seClassLoadingCompliance = <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** Whether we are cacheable */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">boolean</span> cacheable = <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** Whether we are blacklistable */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">boolean</span> blackListable = <span xmlns="" class="perl_Keyword">true</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** Whether to export all */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> ExportAll exportAll;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** Whether to import all */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">boolean</span> importAll;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The included packages */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String includedPackages;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The excluded packages */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String excludedPackages;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The excluded for export */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String excludedExportPackages;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The included packages */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> ClassFilter included;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The excluded packages */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> ClassFilter excluded;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The excluded for export */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> ClassFilter excludedExport;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The requirements */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> RequirementsMetaData requirements = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">RequirementsMetaData</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The capabilities */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> CapabilitiesMetaData capabilities = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">CapabilitiesMetaData</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">... </span>setters &amp; getters
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre></div></div><div class="para">
			<a class="xref" href="chap-JBoss_Microcontainer_User_Guide-The_ClassLoading_Layer.html#example-classloading-api-as-xml">Example 9.5, “ClassLoading API Defined in XML”</a> and <a class="xref" href="chap-JBoss_Microcontainer_User_Guide-The_ClassLoading_Layer.html#example-classloading-api-as-java">Example 9.6, “ClassLoading API Defined in Java”</a> show the ClassLoading API defined in XML and Java, respectively.
		</div><div class="example"><a id="example-classloading-api-as-xml">
      ⁠</a><p class="title"><strong>Example 9.5. ClassLoading API Defined in XML</strong></p><div class="example-contents"><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;classloading</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:classloading:1.0"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      name=</span><span xmlns="" class="perl_String">"ptd-jsf-1.0.war"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      domain=</span><span xmlns="" class="perl_String">"ptd-jsf-1.0.war"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      parent-domain=</span><span xmlns="" class="perl_String">"ptd-ear-1.0.ear"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      export-all=</span><span xmlns="" class="perl_String">"NON_EMPTY"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      import-all=</span><span xmlns="" class="perl_String">"true"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      parent-first=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre></div></div><div class="example"><a id="example-classloading-api-as-java">
      ⁠</a><p class="title"><strong>Example 9.6. ClassLoading API Defined in Java</strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span>ClassLoadingMetaData clmd = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">ClassLoadingMetaData</span>();
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">if</span> (name != <span xmlns="" class="perl_Keyword">null</span>)
<span xmlns="" class="line">​</span>    clmd.<span xmlns="" class="perl_Function">setDomain</span>(name + <span xmlns="" class="perl_String">"_Domain"</span>);
<span xmlns="" class="line">​</span>clmd.<span xmlns="" class="perl_Function">setParentDomain</span>(parentDomain);
<span xmlns="" class="line">​</span>clmd.<span xmlns="" class="perl_Function">setImportAll</span>(<span xmlns="" class="perl_Keyword">true</span>);
<span xmlns="" class="line">​</span>clmd.<span xmlns="" class="perl_Function">setExportAll</span>(ExportAll.<span xmlns="" class="perl_Function">NON_EMPTY</span>);
<span xmlns="" class="line">​</span>clmd.<span xmlns="" class="perl_Function">setVersion</span>(Version.<span xmlns="" class="perl_Function">DEFAULT_VERSION</span>);
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre></div></div><div class="para">
			You can add ClassLoadingMetaData to your deployment either programmatically, or declaratively, via <code class="filename">jboss-classloading.xml</code>.
		</div><div class="example"><a id="idm139732981782240">
      ⁠</a><p class="title"><strong>Example 9.7. Adding ClassLoadingMetaData Using <code class="filename">jboss-classloading.xml</code></strong></p><div class="example-contents"><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;classloading</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:classloading:1.0"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      domain=</span><span xmlns="" class="perl_String">"DefaultDomain"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      top-level-classloader=</span><span xmlns="" class="perl_String">"true"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      export-all=</span><span xmlns="" class="perl_String">"NON_EMPTY"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      import-all=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/classloading&gt;</span></pre><div class="para">
				The DefaultDomain is shared among all the applications that do not define their own domains.
			</div></div></div><div class="example"><a id="example-putting-classloader-in-defaultdomain">
      ⁠</a><p class="title"><strong>Example 9.8. Typical Domain-Level Isolation</strong></p><div class="example-contents"><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;classloading</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:classloading:1.0"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      domain=</span><span xmlns="" class="perl_String">"IsolatedDomain"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      export-all=</span><span xmlns="" class="perl_String">"NON_EMPTY"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      import-all=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/classloading&gt;</span>
</pre></div></div><div class="example"><a id="idm139732930235216">
      ⁠</a><p class="title"><strong>Example 9.9. Isolation with a Specific Parent</strong></p><div class="example-contents"><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;classloading</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:classloading:1.0"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      domain=</span><span xmlns="" class="perl_String">"IsolatedWithParentDomain"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      parent-domain=</span><span xmlns="" class="perl_String">"DefaultDomain"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      export-all=</span><span xmlns="" class="perl_String">"NON_EMPTY"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      import-all=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/classloading&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre></div></div><div class="example"><a id="idm139732980159248">
      ⁠</a><p class="title"><strong>Example 9.10. Non-Compliance with j2seClassLoadingCompliance</strong></p><div class="example-contents"><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;classloading</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:classloading:1.0"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">	      parent-first=</span><span xmlns="" class="perl_String">"false"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/classloading&gt;</span>
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre><div class="para">
				<code class="filename">.war</code> deployments use this method by default. Instead of doing default parent-first lookups, you first check your own resources.
			</div></div></div><div class="example"><a id="idm139732976073616">
      ⁠</a><p class="title"><strong>Example 9.11. Typical OSGi Implementation</strong></p><div class="example-contents"><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;classloading</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:classloading:1.0"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;requirements&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;package</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"org.jboss.dependency.spi"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/requirements&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;capabilities&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;package</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"org.jboss.cache.api"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;package</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"org.jboss.kernel.spi"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/capabilities&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/classloading&gt;</span></pre></div></div><div class="example"><a id="idm139732971283984">
      ⁠</a><p class="title"><strong>Example 9.12. Importing and Exporting Whole Modules and Libraries, Rather than Fine-Grained Packages</strong></p><div class="example-contents"><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;classloading</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:classloading:1.0"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;requirements&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;module</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"jboss-reflect.jar"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/requirements&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;capabilities&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;module</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"jboss-cache.jar"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/capabilities&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/classloading&gt;</span>
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;classloading</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:classloading:1.0"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;requirements&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;package</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"si.acme.foobar"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;module</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"jboss-reflect.jar"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/requirements&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;capabilities&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;package</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"org.alesj.cl"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;module</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"jboss-cache.jar"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/capabilities&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/classloading&gt;</span>
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre></div></div><div class="para">
			You can also mix the requirements and capabilities types, using packages and modules.
		</div><div class="para">
			The classloading sub-project uses a very small resource-visitor-pattern implementation.
		</div><div class="para">
			In the <code class="classname">ClassLoader</code> project, the connection between deployment and classloading is done through the <code class="classname">Module</code> class, which holds all of the required information to properly apply restrictions on the visitor pattern, such as filtering.
		</div><div class="example"><a id="idm139732981399808">
      ⁠</a><p class="title"><strong>Example 9.13. The <code class="interfacename">ResourceVisitor</code> and <code class="interfacename">ResourceContext</code> Interfaces </strong></p><div class="example-contents"><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> ResourceVisitor {
<span xmlns="" class="line">​</span>    ResourceFilter <span xmlns="" class="perl_Function">getFilter</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">visit</span>(ResourceContext resource);
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> ResourceContext {
<span xmlns="" class="line">​</span>    URL <span xmlns="" class="perl_Function">getUrl</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    ClassLoader <span xmlns="" class="perl_Function">getClassLoader</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    String <span xmlns="" class="perl_Function">getResourceName</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    String <span xmlns="" class="perl_Function">getClassName</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">isClass</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">Class</span>&lt;?&gt; <span xmlns="" class="perl_Function">loadClass</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    InputStream <span xmlns="" class="perl_Function">getInputStream</span>() <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_DataType">byte</span>[] <span xmlns="" class="perl_Function">getBytes</span>() <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>}
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre></div></div><div class="para">
			To use the module, instantiate your ResourceVisitor instance and pass it to <code class="methodname">Module::visit</code> method. This feature is used in the deployment framework to index annotations usage in deployments.
		</div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-JBoss_Microcontainer_User_Guide-The_ClassLoading_Layer-ClassLoading_VFS">
      ⁠</a>9.3. ClassLoading VFS</h1></div></div></div><div class="para">
			These examples provide an implementation of the <code class="classname">ClassLoaderPolicy</code> that uses a JBoss Virtual File System project to load classes and resources. You can use this idea directly or in combination with a classloading framework.
		</div><div class="para">
			Optionally, you can set up your modules inside the Microcontainer configuration.
		</div><div class="example"><a id="idm139732979867120">
      ⁠</a><p class="title"><strong>Example 9.14. Classloading Module Deployer</strong></p><div class="example-contents"><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;deployment</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:bean-deployer:2.0"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;classloader</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"anys-classloader"</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:classloader:1.0"</span><span xmlns="" class="perl_Others"> import-all=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Others"> domain=</span><span xmlns="" class="perl_String">"Anys"</span><span xmlns="" class="perl_Others"> parent-domain=</span><span xmlns="" class="perl_String">"DefaultDomain"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;capabilities&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;package</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"org.jboss.test.deployers.vfs.reflect.support.web"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/capabilities&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;root&gt;</span>${jboss.tests.url}<span xmlns="" class="perl_Keyword">&lt;/root&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/classloader&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;bean</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"AnyServlet"</span><span xmlns="" class="perl_Others"> class=</span><span xmlns="" class="perl_String">"org.jboss.test.deployers.vfs.reflect.support.web.AnyServlet"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;classloader&gt;&lt;inject</span><span xmlns="" class="perl_Others"> bean=</span><span xmlns="" class="perl_String">"anys-classloader:0.0.0"</span><span xmlns="" class="perl_Keyword">/&gt;&lt;/classloader&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/bean&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/deployment&gt;</span>
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>			
<span xmlns="" class="line">​</span>
</pre></div></div><div class="para">
			The <code class="classname">VFSClassLoaderFactory</code> class transforms the XML deployer into a <code class="classname">VFSClassLoaderPolicyModule</code>, which then creates the actual <code class="classname">ClassLoader</code> instance. You can then directly use this new <code class="classname">ClassLoader</code> instance with your beans.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				<code class="classname">VFSClassLoaderFactory</code> extends <code class="classname">ClassLoadingMetaData</code>, so all examples pertaining to <code class="classname">ClassLoadingMetaData</code> apply in this case as well.
			</div></div></div></div></div></body></html>