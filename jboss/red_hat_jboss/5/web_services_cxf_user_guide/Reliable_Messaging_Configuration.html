<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 7.  Using WS-Reliable Messaging</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="Reliable_Messaging_Configuration">
      ⁠</a>Chapter 7.  Using WS-Reliable Messaging </h1></div></div></div><div class="para">
		In order for JBoss WS-CXF/CXF to establish reliable messaging between two points, the CXF RM and addressing interceptors need to be added to the interceptor chains. This can be achieved in one of the ways outlined below.
	</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title"> Using the RMAssertion and the CXF WS-Policy Framework </div>
			The RM interceptors will be automatically added to their respective interceptor chains by the policy framework if the following occurs:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
				A Policy with an RMAssertion element is attached to the <code class="varname">wsdl:service</code> element (or any other WSDL element that is an attachment point for Policy or PolicyReference elements according to the rules for WS-Policy Attachments).
			</div></li><li class="listitem"><div class="para">
				The CXF WS-Policy Framework is enabled
			</div></li></ol></div><div class="para">
		The assertion attributes control the behavior of the source or destination. For example, to enable the WS-Policy Framework on the server side, your configuration file will look like this:
	</div><pre class="programlisting"><span xmlns="" class="line">​</span>  
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jaxws:endpoint</span> <span xmlns="" class="perl_Error">...</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;jaxws:features&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;p:policies/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/jaxws:features&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jaxws:endpoint&gt;</span>
</pre><div class="para">
		Your WSDL will look like this:
	</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;wsp:Policy</span><span xmlns="" class="perl_Others"> wsu:Id=</span><span xmlns="" class="perl_String">"RM"</span><span xmlns="" class="perl_Others"> xmlns:wsp=</span><span xmlns="" class="perl_String">"http://www.w3.org/2006/07/ws-policy"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">xmlns:wsu=</span><span xmlns="" class="perl_String">"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;wsam:Addressing</span><span xmlns="" class="perl_Others"> xmlns:wsam=</span><span xmlns="" class="perl_String">"http://www.w3.org/2007/02/addressing/metadata"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;wsp:Policy/&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/wsam:Addressing&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;wsrmp:RMAssertion</span><span xmlns="" class="perl_Others"> xmlns:wsrmp=</span><span xmlns="" class="perl_String">"http://schemas.xmlsoap.org/ws/2005/02/rm/policy"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;wsrmp:BaseRetransmissionInterval</span><span xmlns="" class="perl_Others"> Milliseconds=</span><span xmlns="" class="perl_String">"10000"</span><span xmlns="" class="perl_Keyword">/&gt;</span> 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/wsrmp:RMAssertion&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/wsp:Policy&gt;</span>
<span xmlns="" class="line">​</span>...
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;wsdl:service</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"ReliableGreeterService"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;wsdl:port</span><span xmlns="" class="perl_Others"> binding=</span><span xmlns="" class="perl_String">"tns:GreeterSOAPBinding"</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"GreeterPort"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;soap:address</span><span xmlns="" class="perl_Others"> location=</span><span xmlns="" class="perl_String">"http://localhost:9020/SoapContext/GreeterPort"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;wsp:PolicyReference</span><span xmlns="" class="perl_Others"> URI=</span><span xmlns="" class="perl_String">"#RM"</span><span xmlns="" class="perl_Others"> xmlns:wsp=</span><span xmlns="" class="perl_String">"http://www.w3.org/2006/07/ws-policy"</span><span xmlns="" class="perl_Keyword">/&gt;</span>        
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/wsdl:port&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/wsdl:service&gt;</span>
</pre><div class="para">
		Instead of attaching the PolicyReference to the <code class="varname">wsdl:port</code> element, you can also specify it as a child element of the policies featured, such as the server endpoint.
	</div><pre class="programlisting"><span xmlns="" class="line">​</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;wsp:Policy</span><span xmlns="" class="perl_Others"> wsu:Id=</span><span xmlns="" class="perl_String">"="</span><span xmlns="" class="perl_Error">RM"</span><span xmlns="" class="perl_Others"> xmlns:wsp=</span><span xmlns="" class="perl_String">"http://www.w3.org/2006/07/ws-policy"</span> <span xmlns="" class="perl_Error">...</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/wsp:Policy&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jaxws:endpoint</span> <span xmlns="" class="perl_Error">...</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;jaxws:features&gt;</span> 
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">&lt;p:policies&gt;</span>
<span xmlns="" class="line">​</span>	  <span xmlns="" class="perl_Keyword">&lt;wsp:PolicyReference</span><span xmlns="" class="perl_Others"> URI=</span><span xmlns="" class="perl_String">"#RM"</span><span xmlns="" class="perl_Others"> xmlns:wsp=</span><span xmlns="" class="perl_String">"http://www.w3.org/2006/07/ws-policy"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>	<span xmlns="" class="perl_Keyword">&lt;/p:policies&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/jaxws:features&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jaxws:endpoint&gt;</span>
</pre><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title"> Using the Reliable Messaging Feature </div>
			You can use the ReliableMessaging feature if you do not want to involve the WS-Policy Framework, or want to configure additional parameters such as the sequence termination policy or the persistent store. The supported child elements are listed below.
		</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"> RMAssertion </span></dt><dd><div class="para">
					An element of type RMAssertion.
				</div></dd><dt><span class="term"> deliveryAssurance </span></dt><dd><div class="para">
					An element of type DeliveryAssuranceType that describes the delivery assurance that should apply (<code class="methodname">AtMostOnce</code>, <code class="methodname">AtLeastOnce</code>, <code class="methodname">InOrder</code>).
				</div></dd><dt><span class="term"> sourcePolicy </span></dt><dd><div class="para">
					An element of type SourcePolicyType that allows you to configure details of the RM source, such as whether an offer should always be included in a <code class="methodname">CreateSequence</code> request, or the sequence termination policy.
				</div></dd><dt><span class="term"> destinationPolicy</span></dt><dd><div class="para">
					An element of type DestinationPolicyType that allows you to configure details of the RM destination, such as whether inbound offers should be accepted.
				</div></dd><dt><span class="term"> store </span></dt><dd><div class="para">
					The store to use (default: <code class="option">null</code>). This must be an element of type jdbcStore (in the same namespace), or a bean or a reference to a bean that implements the RMStore interface.
				</div></dd></dl></div><div class="para">
		The jbdcStore element type is described below.
	</div><div class="para">
		The following example is applied at bus level.
	</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;cxf:bus&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;cxf:features&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;wsa:addressing/&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;wsrm-mgr:reliableMessaging&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;wsrm-policy:RMAssertion&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;wsrm-policy:BaseRetransmissionInterval</span><span xmlns="" class="perl_Others"> Milliseconds=</span><span xmlns="" class="perl_String">"4000"</span><span xmlns="" class="perl_Keyword">/&gt;</span>           
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;wsrm-policy:AcknowledgementInterval</span><span xmlns="" class="perl_Others"> Milliseconds=</span><span xmlns="" class="perl_String">"2000"</span><span xmlns="" class="perl_Keyword">/&gt;</span>          
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/wsrm-policy:RMAssertion&gt;</span> 
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;wsrm-mgr:sourcePolicy&gt;</span>
<span xmlns="" class="line">​</span>                <span xmlns="" class="perl_Keyword">&lt;wsrm-mgr:sequenceTerminationPolicy</span><span xmlns="" class="perl_Others"> maxLength=</span><span xmlns="" class="perl_String">"5"</span><span xmlns="" class="perl_Keyword">/&gt;</span>                    
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/wsrm-mgr:sourcePolicy&gt;</span>     
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;wsrm-mgr:destinationPolicy</span><span xmlns="" class="perl_Others"> acceptOffers=</span><span xmlns="" class="perl_String">"false"</span><span xmlns="" class="perl_Keyword">&gt;</span>            
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;wsrm:store&gt;</span>
<span xmlns="" class="line">​</span>               <span xmlns="" class="perl_Keyword">&lt;ref</span><span xmlns="" class="perl_Others"> bean=</span><span xmlns="" class="perl_String">"myStore"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;/wsrm:store&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/wsrm-mgr:reliableMessaging&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/cxf:features&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/cxf:bus&gt;</span>
</pre><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title"> Configuring the Reliable Messaging Store </div>
			To enable persistence, you must specify the object implementing the persistent store for RM. You can develop your own, or use the JDBC based store that comes with CXF (<code class="filename">class org.apache.cxf.ws.rm.persistence.jdbc.RMTxStore</code>). You can configure the latter using a custom jdbcStore bean. The supported attributes are in the table below.
		</div><div class="table"><a id="Attributes">
      ⁠</a><p class="title"><strong>Table 7.1.  Attributes</strong></p><div class="table-contents"><table xmlns:d="http://docbook.org/ns/docbook" class="lt-4-cols lt-7-rows" summary=" Attributes"><colgroup><col/><col/><col/></colgroup><thead><tr><th> Attribute name </th><th> String </th><th> Default </th></tr></thead><tbody><tr><td> driverClassName </td><td> String </td><td> org.apache.derby.jdbc.EmbeddedDriver </td></tr><tr><td> userName </td><td> String </td><td> null </td></tr><tr><td> passWord </td><td> String </td><td> null </td></tr><tr><td> url </td><td> String </td><td> jdbc:derby:rmdb;create=true </td></tr></tbody></table></div></div><div class="para">
		Here is an example:
	</div><pre class="screen XML"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;wsrm-mgr:jdbcStore</span><span xmlns="" class="perl_Others"> id=</span><span xmlns="" class="perl_String">"myStore"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">    driverClassName=</span><span xmlns="" class="perl_String">"org.apache.derby.jdbc.ClientDriver"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">    url=</span><span xmlns="" class="perl_String">"jdbc:derby://localhost:1527/rmdb;create=true"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">    password=</span><span xmlns="" class="perl_String">"password"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
</pre><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title"> Configuring the Reliable Messaging Manager Manually </div>
			To configure properties of the RM Manager, you can use the RMManager element. It supports the same child elements as the ReliableMessaging feature element above. For example, without using features, you can determine that sequences should have a maximum length of five as follows:
		</div><pre class="programlisting XML"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;wsrm-mgr:rmManager</span><span xmlns="" class="perl_Others"> xmlns:wsrm-mgr=</span><span xmlns="" class="perl_String">"http://cxf.apache.org/ws/rm/manager"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;wsrm-mgr:sourcePolicy&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;wsrm-mgr:sequenceTerminationPolicy</span><span xmlns="" class="perl_Others"> maxLength=</span><span xmlns="" class="perl_String">"5"</span><span xmlns="" class="perl_Keyword">/&gt;</span>                    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/wsrm-mgr:sourcePolicy&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/wsrm-mgr:rmManager&gt;</span>
</pre></div></body></html>