<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 12. Login Modules</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="idm139921684810688">
      ⁠</a>Chapter 12. Login Modules</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="chap-JBoss_Login_Modules">
      ⁠</a>12.1. Using Modules</h1></div></div></div><div class="para">
			JBoss Enterprise Application Platform includes several bundled login modules suitable for most user management needs. JBoss Enterprise Application Platform can read user information from a relational database, an Lightweight Directory Access Protocol (LDAP) server or flat files. In addition to these core login modules, JBoss provides other login modules that provide user information for very customized needs in JBoss.
		</div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-LdapLoginModule">
      ⁠</a>12.1.1. LdapLoginModule</h2></div></div></div><div class="para">
		<code class="literal">LdapLoginModule</code> is a <code class="literal">LoginModule</code> implementation that authenticates against a Lightweight Directory Access Protocol (LDAP) server. Use the <code class="literal">LdapLoginModule</code> if your user name and credentials are stored in an LDAP server that is accessible using a Java Naming and Directory Interface (JNDI) LDAP provider.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>AdvancedLDAPLoginModule</strong></p></div><div class="admonition"><div class="para">
			If you wish to use LDAP with the SPNEGO authentication or skip some of the authentication phases while using an LDAP server, consider using the AdvancedLDAPLogiModule chained with the SPNEGOLoginModule or only the AdvancedLDAPLoginModule (refer to Negotiation User Guide).
		</div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Distinguished Name (DN)</span></dt><dd><div class="para">
					In Lightweight Directory Access Protocol (LDAP), the distinguished name uniquely identifies an object in a directory. Each distinguished name must have a unique name and location from all other objects, which is achieved using a number of attribute-value pairs (AVPs). The AVPs define information such as common names, organization unit, among others. The combination of these values results in a unique string required by the LDAP.
				</div></dd></dl></div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			This login module also supports unauthenticated identity and password stacking.
		</div></div></div><div class="para">
		The LDAP connectivity information is provided as configuration options that are passed through to the environment object used to create JNDI initial context. The standard LDAP JNDI properties used include the following:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="property">java.naming.factory.initial</span></span></dt><dd><div class="para">
					<code class="classname">InitialContextFactory</code> implementation class name. This defaults to the Sun LDAP provider implementation <code class="literal">com.sun.jndi.ldap.LdapCtxFactory</code>.
				</div></dd><dt><span class="term"><span class="property">java.naming.provider.url</span></span></dt><dd><div class="para">
					LDAP URL for the LDAP server.
				</div></dd><dt><span class="term"><span class="property">java.naming.security.authentication</span></span></dt><dd><div class="para">
					Security protocol level to use. The available values include <code class="literal">none</code>, <code class="literal">simple</code>, and <code class="literal">strong</code>. If the property is undefined, the behavior is determined by the service provider.
				</div></dd><dt><span class="term"><span class="property">java.naming.security.protocol</span></span></dt><dd><div class="para">
					Transport protocol to use for secure access. Set this configuration option to the type of service provider (for example, SSL). If the property is undefined, the behavior is determined by the service provider.
				</div></dd><dt><span class="term"><span class="property">java.naming.security.principal</span></span></dt><dd><div class="para">
					Specifies the identity of the Principal for authenticating the caller to the service. This is built from other properties as described below.
				</div></dd><dt><span class="term"><span class="property">java.naming.security.credentials</span></span></dt><dd><div class="para">
					Specifies the credentials of the Principal for authenticating the caller to the service. Credentials can take the form of a hashed password, a clear-text password, a key, or a certificate. If the property is undefined, the behavior is determined by the service provider.
				</div></dd></dl></div><div class="para">
		The supported login module configuration options include the following:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="property">principalDNPrefix</span></span></dt><dd><div class="para">
					Prefix added to the user name to form the user <em class="firstterm"> distinguished name </em> . See <code class="literal">principalDNSuffix</code> for more info.
				</div></dd><dt><span class="term"><span class="property">principalDNSuffix</span></span></dt><dd><div class="para">
					Suffix added to the user name when forming the user distinguished name. This is useful if you prompt a user for a user name and you do not want the user to have to enter the fully distinguished name. Using this property and <code class="literal">principalDNSuffix</code> the <code class="literal">userDN</code> will be formed as <code class="literal">principalDNPrefix + username + principalDNSuffix</code>
				</div></dd><dt><span class="term"><span class="property">rolesCtxDN</span></span></dt><dd><div class="para">
					Fixed, distinguished name to the context for searching user roles.
				</div></dd><dt><span class="term"><span class="property">userRolesCtxDNAttributeName</span></span></dt><dd><div class="para">
					Name of an attribute in the user object that contains the distinguished name to the context to search for user roles. This differs from <code class="literal">rolesCtxDN</code> in that the context to search for a user's roles can be unique for each user.
				</div></dd><dt><span class="term"><span class="property">roleAttributeID</span></span></dt><dd><div class="para">
					Name of the attribute containing the user roles. If not specified, this defaults to <code class="literal">roles</code>.
				</div></dd><dt><span class="term"><span class="property">roleAttributeIsDN</span></span></dt><dd><div class="para">
					Flag indicating whether the <span class="property">roleAttributeID</span> contains the fully distinguished name of a role object, or the role name. The role name is taken from the value of the <span class="property">roleNameAttributeId</span> attribute of the context name by the distinguished name.
				</div><div class="para">
					If true, the role attribute represents the distinguished name of a role object. If false, the role name is taken from the value of <code class="literal">roleAttributeID</code>. The default is <code class="literal">false</code>.
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
						In certain directory schemas (e.g., MS ActiveDirectory), role attributes in the user object are stored as DNs to role objects instead of simple names. For implementations that use this schema type, <span class="property">roleAttributeIsDN</span> must be set to <code class="literal">true</code>.
					</div></div></div></dd><dt><span class="term"><span class="property">roleNameAttributeID</span></span></dt><dd><div class="para">
					Name of the attribute of the context pointed to by the <span class="property">roleCtxDN</span> distinguished name value which contains the role name. If the <span class="property">roleAttributeIsDN</span> property is set to <code class="literal">true</code>, this property is used to find the role object's <code class="literal">name</code> attribute. The default is <code class="literal">group</code>.
				</div></dd><dt><span class="term"><span class="property">uidAttributeID</span></span></dt><dd><div class="para">
					Name of the attribute in the object containing the user roles that corresponds to the user ID. This is used to locate the user roles. If not specified this defaults to <code class="literal">uid</code>.
				</div></dd><dt><span class="term"><span class="property">matchOnUserDN</span></span></dt><dd><div class="para">
					Flag that specifies whether the search for user roles should match on the user's fully distinguished name. If <code class="literal">true</code>, the full <code class="literal">userDN</code> is used as the match value. If <code class="literal">false</code>, only the user name is used as the match value against the <span class="property">uidAttributeName</span> attribute. The default value is <code class="literal">false</code>.
				</div></dd><dt><span class="term"><span class="property">unauthenticatedIdentity</span></span></dt><dd><div class="para">
					Principal name to assign to requests containing no authentication information. This behavior is inherited from the <code class="classname">UsernamePasswordLoginModule</code> superclass.
				</div></dd><dt><span class="term"><span class="property">allowEmptyPasswords</span></span></dt><dd><div class="para">
					A flag indicating if empty (length 0) passwords should be passed to the LDAP server. An empty password is treated as an anonymous log in by some LDAP servers, and this may not be a desirable feature. To reject empty passwords, set this to <code class="literal">false</code> . If set to <code class="literal">true</code>, the LDAP server will validate the empty password. The default is <code class="literal">true</code>.
				</div></dd><dt><span class="term">searchTimeLimit</span></dt><dd><div class="para">
					The timeout in milliseconds for the user/role searches. Defaults to 10000 (10 seconds).
				</div></dd><dt><span class="term">searchScope</span></dt><dd><div class="para">
					Sets the search scope to one of the strings. The default is SUBTREE_SCOPE. Other supported values include:
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							OBJECT_SCOPE : only search the named roles context.
						</div></li><li class="listitem"><div class="para">
							ONELEVEL_SCOPE : search directly under the named roles context.
						</div></li><li class="listitem"><div class="para">
							SUBTREE_SCOPE : If the roles context is not a DirContext, search only the object. If the roles context is a DirContext, search the subtree rooted at the named object, including the named object itself.
						</div></li></ul></div></dd><dt><span class="term">jaasSecurityDomain</span></dt><dd><div class="para">
					The JMX ObjectName of the JaasSecurityDomain used to decrypt the java.naming.security.principal. The encrypted form of the password is that returned by the JaasSecurityDomainencrypt64(byte[]) method. The org.jboss.security.plugins.PBEUtils can also be used to generate the encrypted form.
				</div></dd></dl></div><div class="para">
		User authentication is performed by connecting to the LDAP server, based on the login module configuration options. Connecting to the LDAP server is done by creating an <code class="literal">InitialLdapContext</code> with an environment composed of the LDAP JNDI properties described previously in this section.
	</div><div class="para">
		The <span class="property">Context.SECURITY_PRINCIPAL</span> is set to the distinguished name of the user obtained by the callback handler in combination with the <span class="property">principalDNPrefix</span> and <span class="property">principalDNSuffix</span> option values, and the <span class="property">Context.SECURITY_CREDENTIALS</span> property is set to the respective <span class="property">String</span> password.
	</div><div class="para">
		Once authentication has succeeded (<code class="literal">InitialLdapContext</code> instance is created), the user's roles are queried by performing a search on the <code class="literal">rolesCtxDN</code> location with search attributes set to the <span class="property">roleAttributeName</span> and <span class="property">uidAttributeName</span> option values. The roles names are obtaining by invoking the <code class="methodname"> toString </code> method on the role attributes in the search result set.
	</div><div class="example"><a id="idm139921634436000">
      ⁠</a><p class="title"><strong>Example 12.1. LDAP Login Module Authentication Policy</strong></p><div class="example-contents"><div class="para">
			This authentication policy describes how you use the parameters in a security domain authentication policy
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;application-policy</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"testLDAP"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;authentication&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.auth.spi.LdapLoginModule"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">flag=</span><span xmlns="" class="perl_String">"required"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"java.naming.factory.initial"</span><span xmlns="" class="perl_Keyword">&gt;</span> com.sun.jndi.ldap.LdapCtxFactory
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"java.naming.provider.url"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>ldap://ldaphost.jboss.org:1389/
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"java.naming.security.authentication"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>simple
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"principalDNPrefix"</span><span xmlns="" class="perl_Keyword">&gt;</span>uid=<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>                <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"principalDNSuffix"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>,ou=People,dc=jboss,dc=org
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"rolesCtxDN"</span><span xmlns="" class="perl_Keyword">&gt;</span>                  ou=Roles,dc=jboss,dc=org
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"uidAttributeID"</span><span xmlns="" class="perl_Keyword">&gt;</span>member<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"matchOnUserDN"</span><span xmlns="" class="perl_Keyword">&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"roleAttributeID"</span><span xmlns="" class="perl_Keyword">&gt;</span>cn<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"roleAttributeIsDN"</span><span xmlns="" class="perl_Keyword">&gt;</span>false <span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/authentication&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/application-policy&gt;</span></pre></div></div><div class="para">
		The <em class="parameter"><code>java.naming.factory.initial</code></em>, <em class="parameter"><code>java.naming.factory.url</code></em> and <em class="parameter"><code>java.naming.security</code></em> options in the <span class="property">testLDAP</span> <span class="markup">&lt;login-module&gt;</span> configuration indicate the following conditions:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				The Sun LDAP JNDI provider implementation will be used
			</div></li><li class="listitem"><div class="para">
				The LDAP server is located on host <code class="literal">ldaphost.jboss.org</code> on port 1389
			</div></li><li class="listitem"><div class="para">
				The LDAP simple authentication method will be use to connect to the LDAP server.
			</div></li></ul></div><div class="para">
		The login module attempts to connect to the LDAP server using a Distinguished Name (DN) representing the user it is trying to authenticate. This DN is constructed from the passed <span class="property">principalDNPrefix</span>, the user name of the user and the <span class="property">principalDNSuffix</span> as described above. In <a class="xref" href="ch12.html#exam-LDIF_File_Example">Example 12.2, “LDIF File Example”</a>, the user name <code class="literal">jsmith</code> would map to <code class="literal">uid=jsmith,ou=People,dc=jboss,dc=org</code>.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			The example assumes the LDAP server authenticates users using the <code class="literal">userPassword</code> attribute of the user's entry (<code class="literal">theduke</code> in this example). Most LDAP servers operate in this manner, however if your LDAP server handles authentication differently you must ensure LDAP is configured according to your production environment requirements.
		</div></div></div><div class="para">
		Once authentication succeeds, the roles on which authorization will be based are retrieved by performing a subtree search of the <code class="literal">rolesCtxDN</code> for entries whose <span class="property">uidAttributeID</span> match the user. If <span class="property">matchOnUserDN</span> is true, the search will be based on the full DN of the user. Otherwise the search will be based on the actual user name entered. In this example, the search is under <code class="literal">ou=Roles,dc=jboss,dc=org</code> for any entries that have a <code class="literal">member</code> attribute equal to <code class="literal">uid=jduke,ou=People,dc=jboss,dc=org</code>. The search would locate <code class="literal">cn=JBossAdmin</code> under the roles entry.
	</div><div class="para">
		The search returns the attribute specified in the <span class="property">roleAttributeID</span> option. In this example, the attribute is <code class="literal">cn</code>. The value returned would be <code class="literal">JBossAdmin</code>, so the <code class="literal">jsmith</code> user is assigned to the <code class="literal">JBossAdmin</code> role.
	</div><div class="para">
		A local LDAP server often provides identity and authentication services, but is unable to use authorization services. This is because application roles do not always map well onto LDAP groups, and LDAP administrators are often hesitant to allow external application-specific data in central LDAP servers. The LDAP authentication module is often paired with another login module, such as the database login module, that can provide roles more suitable to the application being developed.
	</div><div class="para">
		An LDAP Data Interchange Format (LDIF) file representing the structure of the directory this data operates against is shown in <a class="xref" href="ch12.html#exam-LDIF_File_Example">Example 12.2, “LDIF File Example”</a>.
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">LDAP Data Interchange Format (LDIF)</span></dt><dd><div class="para">
					Plain text data interchange format used to represent LDAP directory content and update requests. Directory content is represented as one record for each object or update request. Content consists of add, modify, delete, and rename requests.
				</div></dd></dl></div><div class="example"><a id="exam-LDIF_File_Example">
      ⁠</a><p class="title"><strong>Example 12.2. LDIF File Example</strong></p><div class="example-contents"><pre class="programlisting">dn: dc=jboss,dc=org
objectclass: top
objectclass: dcObject
objectclass: organization
dc: jboss
o: JBoss

dn: ou=People,dc=jboss,dc=org
objectclass: top
objectclass: organizationalUnit
ou: People

dn: uid=jsmith,ou=People,dc=jboss,dc=org
objectclass: top
objectclass: uidObject
objectclass: person
uid: jsmith
cn: John
sn: Smith
userPassword: theduke

dn: ou=Roles,dc=jboss,dc=org
objectclass: top
objectclass: organizationalUnit
ou: Roles

dn: cn=JBossAdmin,ou=Roles,dc=jboss,dc=org
objectclass: top
objectclass: groupOfNames
cn: JBossAdmin
member: uid=jsmith,ou=People,dc=jboss,dc=org
description: the JBossAdmin group
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-LdapExtLoginModule">
      ⁠</a>12.1.2. LdapExtLoginModule</h2></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Distinguished Name (DN)</span></dt><dd><div class="para">
					In Lightweight Directory Access Protocol (LDAP), the distinguished name uniquely identifies an object in a directory. Each distinguished name must have a unique name and location from all other objects, which is achieved using a number of attribute-value pairs (AVPs). The AVPs define information such as common names, organization unit, among others. The combination of these values results in a unique string required by the LDAP.
				</div></dd></dl></div><div class="para">
		The <code class="classname">org.jboss.security.auth.spi.LdapExtLoginModule</code> searches for the user to bind, as well as the associated roles, for authentication. The roles query recursively follows DNs to navigate a hierarchical role structure.
	</div><div class="para">
		The LoginModule options include whatever options are supported by the chosen LDAP JNDI provider supports. Examples of standard property names are:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<span class="property">Context.INITIAL_CONTEXT_FACTORY</span> = "java.naming.factory.initial"
			</div></li><li class="listitem"><div class="para">
				<span class="property">Context.SECURITY_PROTOCOL</span> = "java.naming.security.protocol"
			</div></li><li class="listitem"><div class="para">
				<span class="property">Context.PROVIDER_URL</span> = "java.naming.provider.url"
			</div></li><li class="listitem"><div class="para">
				<span class="property">Context.SECURITY_AUTHENTICATION</span> = "java.naming.security.authentication"
			</div></li><li class="listitem"><div class="para">
				<span class="property">Context.REFERRAL</span> = "java.naming.referral"
			</div></li></ul></div><div class="para">
		Login module implementation logic follows the order below:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
				The initial LDAP server bind is authenticated using the <span class="property">bindDN</span> and <span class="property">bindCredential</span> properties. The <span class="property">bindDN</span> is a user with permissions to search both the <span class="property">baseCtxDN</span> and <span class="property">rolesCtxDN</span> trees for the user and roles. The <span class="property">user DN</span> to authenticate against is queried using the filter specified by the <span class="property">baseFilter</span> property.
			</div></li><li class="listitem"><div class="para">
				The resulting <span class="property">userDN</span> is authenticated by binding to the LDAP server using the <span class="property">userDN</span> as the InitialLdapContext environment <span class="property">Context.SECURITY_PRINCIPAL</span>. The <span class="property">Context.SECURITY_CREDENTIALS</span> property is either set to the String password obtained by the callback handler.
			</div></li><li class="listitem"><div class="para">
				If this is successful, the associated user roles are queried using the rolesCtxDN, roleAttributeID, roleAttributeIsDN, roleNameAttributeID, and roleFilter options.
			</div></li></ol></div><div class="variablelist"><p class="title"><strong>LdapExtLoginModule Properties</strong></p><dl class="variablelist"><dt><span class="term"><span class="property">baseCtxDN</span></span></dt><dd><div class="para">
					Specifies the fixed DN of the context to start the user search from.
				</div></dd><dt><span class="term"><span class="property">bindDN</span></span></dt><dd><div class="para">
					Specifies the DN used to bind against the LDAP server for the user and role queries. Set <span class="property">bindDN</span> to a DN with read/search permissions on the <span class="property">baseCtxDN</span> and <span class="property">rolesCtxDn</span> properties.
				</div></dd><dt><span class="term"><span class="property">bindCredential</span></span></dt><dd><div class="para">
					The password for the <span class="property">bindDN</span>. <span class="property">bindCredential</span> can be encrypted if <span class="property">jaasSecurityDomain</span> is specified. This property allows an external command to read the password. For example <code class="code">{EXT}cat file_with_password</code>.
				</div></dd><dt><span class="term"><span class="property">jaasSecurityDomain</span></span></dt><dd><div class="para">
					The JMX ObjectName of the JaasSecurityDomain used to decrypt the <code class="classname">java.naming.security.principal</code>. The encrypted form of the password is that returned by the <code class="methodname"> JaasSecurityDomainencrypt64(byte[]) </code> method. The <span class="package"> org.jboss.security.plugins.PBEUtils </span> can also be used to generate the encrypted form.
				</div></dd><dt><span class="term"><span class="property">baseFilter</span></span></dt><dd><div class="para">
					A search filter used to locate the context of the user to authenticate. The input username/<span class="property">userDN</span> as obtained from the login module callback is substituted into the filter anywhere a <code class="literal">{0}</code> expression exists. This substitution behavior originates from the standard <code class="methodname"> DirContext.search(Name, String, Object[], SearchControls cons) </code> method. An common example search filter is <code class="code">(uid={0})</code>.
				</div></dd><dt><span class="term"><span class="property">rolesCtxDN</span></span></dt><dd><div class="para">
					The fixed DN of the context to search for user roles. This is not the DN of where the actual roles are; this is the DN of where the objects containing the user roles are. For example, in active directory, this is the DN where the user account is.
				</div></dd><dt><span class="term"><span class="property">roleFilter</span></span></dt><dd><div class="para">
					Search filter used to locate the roles associated with the authenticated user. The input username/<span class="property">userDN</span> as obtained from the login module callback is substituted into the filter anywhere a <code class="literal">{0}</code> expression exists. The authenticated <span class="property">userDN</span> is substituted into the filter anywhere a <code class="literal">{1}</code> is seen. An example search filter that matches on the input username is <code class="code">(member={0})</code>. An alternative that matches on the authenticated userDN is <code class="code">(member={1})</code>.
				</div></dd><dt><span class="term"><span class="property"> <span class="property">roleAttributeIsDN</span> </span></span></dt><dd><div class="para">
					Flag indicating whether the <span class="property">roleAttributeID</span> contains the full DN of a role object, or the role name. The role name is derived from the value of the <span class="property">roleNameAttributeId</span> attribute of the context name by the distinguished name.
				</div><div class="para">
					If set to <code class="literal">true</code>, the role attribute represents the distinguished name of a role object. If set to <code class="literal">false</code>, the role name is taken from the value of <code class="literal">roleAttributeID</code>. The default is <code class="literal">false</code>.
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
						In certain directory schemas (e.g., MS ActiveDirectory), role attributes in the user object are stored as DNs to role objects instead of simple names. For implementations that use this schema type, <span class="property">roleAttributeIsDN</span> must be set to <code class="literal">true</code>.
					</div></div></div></dd><dt><span class="term"><span class="property"> <span class="property">roleAttributeID</span> </span></span></dt><dd><div class="para">
					Name of the attribute containing the user roles. If <span class="property">roleAttributeIsDN</span> is set to <code class="literal">true</code>, this property is the DN of the context to query for the <span class="property">roleNameAttributeID</span> attribute. If the <span class="property">roleAttributeIsDN</span> property is set to <code class="literal">false</code>, this property is the attribute name of the role name.
				</div></dd><dt><span class="term"><span class="property"> <span class="property">roleNameAttributeID</span> </span></span></dt><dd><div class="para">
					Name of the attribute of the context pointed to by the <span class="property">roleCtxDN</span> distinguished name value which contains the role name. If the <span class="property">roleAttributeIsDN</span> property is set to <code class="literal">true</code>, this property is used to find the role object's <code class="literal">name</code> attribute. The default is <code class="literal">group</code>.
				</div></dd><dt><span class="term"><span class="property">roleRecursion</span></span></dt><dd><div class="para">
					Specifies how many levels the role search traverses a given matching context. The default is <code class="literal">0</code> (deactivated).
				</div></dd><dt><span class="term"><span class="property">searchTimeLimit</span></span></dt><dd><div class="para">
					The timeout in milliseconds for the user/role searches. Defaults to 10000 (10 seconds).
				</div></dd><dt><span class="term"><span class="property">searchScope</span></span></dt><dd><div class="para">
					Sets the search scope to one of the strings. The default is SUBTREE_SCOPE. Other supported values include:
				</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
							OBJECT_SCOPE : only search the named roles context.
						</div></li><li class="listitem"><div class="para">
							ONELEVEL_SCOPE : search directly under the named roles context.
						</div></li><li class="listitem"><div class="para">
							SUBTREE_SCOPE : If the roles context is not a DirContext, search only the object. If the roles context is a DirContext, search the subtree rooted at the named object, including the named object itself.
						</div></li></ul></div></dd><dt><span class="term"><span class="property">allowEmptyPasswords</span></span></dt><dd><div class="para">
					A flag indicating if <code class="code">empty(length==0)</code> passwords should be passed to the LDAP server.
				</div><div class="para">
					An empty password is treated as an anonymous log in by some LDAP servers. If set to <code class="literal">false</code>, empty passwords are rejected. If set to <code class="literal">true</code>, the LDAP server validates the empty password. The default is <code class="literal">true</code>.
				</div></dd><dt><span class="term"><span class="property">defaultRole</span></span></dt><dd><div class="para">
					A role included for all authenticated users.
				</div></dd><dt><span class="term"><span class="property">parseRoleNameFromDN</span></span></dt><dd><div class="para">
					A flag indicating if the DN returned by a query contains the roleNameAttributeID. If set to <code class="literal">true</code>, the DN is checked for the roleNameAttributeID. If set to <code class="literal">false</code>, the DN is not checked for the roleNameAttributeID. This flag can improve the performance of LDAP queries.
				</div></dd><dt><span class="term"><span class="property">parseUsername</span></span></dt><dd><div class="para">
					A flag indicating if the DN is to be parsed for the username. If set to <code class="literal">true</code>, the DN is parsed for the username. If set to <code class="literal">false</code> the DN is not parsed for the username. This option is used together with <span class="property">usernameBeginString</span> and <span class="property">usernameEndString</span>.
				</div></dd><dt><span class="term"><span class="property">usernameBeginString</span></span></dt><dd><div class="para">
					Defines the string which is to be removed from the start of the DN to reveal the username. This option is used together with <span class="property">usernameEndString</span>.
				</div></dd><dt><span class="term"><span class="property">usernameEndString</span></span></dt><dd><div class="para">
					Defines the string which is to be removed from the end of the DN to reveal the username. This option is used together with <span class="property">usernameBeginString</span>.
				</div></dd><dt><span class="term">distinguishedNameAttribute</span></dt><dd><div class="para">
					Defines a distinguished name to provide a unique 'path' to any object in the LDAP database.
				</div></dd></dl></div><div class="figure"><a id="idm139921669126640">
      ⁠</a><div class="figure-contents"><div class="mediaobject"><img src="images/ldap_examples.png" alt="LDAP Structure Example"/></div></div><p class="title"><strong>Figure 12.1. LDAP Structure Example</strong></p></div><div class="example"><a id="idm139921669414544">
      ⁠</a><p class="title"><strong>Example 12.3. Example 2 LDAP Configuration</strong></p><div class="example-contents"><pre class="programlisting">version: 1
dn: o=example2,dc=jboss,dc=org
objectClass: top
objectClass: dcObject
objectClass: organization
dc: jboss
o: JBoss

dn: ou=People,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: organizationalUnit
ou: People

dn: uid=jduke,ou=People,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: uidObject
objectClass: person
objectClass: inetOrgPerson
cn: Java Duke
employeeNumber: judke-123
sn: Duke
uid: jduke
userPassword:: dGhlZHVrZQ==

dn: uid=jduke2,ou=People,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: uidObject
objectClass: person
objectClass: inetOrgPerson
cn: Java Duke2
employeeNumber: judke2-123
sn: Duke2
uid: jduke2
userPassword:: dGhlZHVrZTI=

dn: ou=Roles,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: organizationalUnit
ou: Roles

dn: uid=jduke,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: groupUserEx
memberOf: cn=Echo,ou=Roles,o=example2,dc=jboss,dc=org
memberOf: cn=TheDuke,ou=Roles,o=example2,dc=jboss,dc=org
uid: jduke

dn: uid=jduke2,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: groupUserEx
memberOf: cn=Echo2,ou=Roles,o=example2,dc=jboss,dc=org
memberOf: cn=TheDuke2,ou=Roles,o=example2,dc=jboss,dc=org
uid: jduke2

dn: cn=Echo,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: groupOfNames
cn: Echo
description: the echo role
member: uid=jduke,ou=People,dc=jboss,dc=org

dn: cn=TheDuke,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: TheDuke
description: the duke role
member: uid=jduke,ou=People,o=example2,dc=jboss,dc=org

dn: cn=Echo2,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: groupOfNames
cn: Echo2
description: the Echo2 role
member: uid=jduke2,ou=People,dc=jboss,dc=org

dn: cn=TheDuke2,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: TheDuke2
description: the duke2 role
member: uid=jduke2,ou=People,o=example2,dc=jboss,dc=org

dn: cn=JBossAdmin,ou=Roles,o=example2,dc=jboss,dc=org
objectClass: top
objectClass: groupOfNames
cn: JBossAdmin
description: the JBossAdmin group
member: uid=jduke,ou=People,dc=jboss,dc=org</pre><div class="para">
			The module configuration for this LDAP structure example is outlined in the code sample.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span>testLdapExample2 {
<span xmlns="" class="line">​</span>   org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">auth</span>.<span xmlns="" class="perl_Function">spi</span>.<span xmlns="" class="perl_Function">LdapExtLoginModule</span>
<span xmlns="" class="line">​</span>      java.<span xmlns="" class="perl_Function">naming</span>.<span xmlns="" class="perl_Function">factory</span>.<span xmlns="" class="perl_Function">initial</span>=com.<span xmlns="" class="perl_Function">sun</span>.<span xmlns="" class="perl_Function">jndi</span>.<span xmlns="" class="perl_Function">ldap</span>.<span xmlns="" class="perl_Function">LdapCtxFactory</span>
<span xmlns="" class="line">​</span>      java.<span xmlns="" class="perl_Function">naming</span>.<span xmlns="" class="perl_Function">provider</span>.<span xmlns="" class="perl_Function">url</span>=<span xmlns="" class="perl_String">"ldap://lamia/"</span>
<span xmlns="" class="line">​</span>      java.<span xmlns="" class="perl_Function">naming</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">authentication</span>=simple
<span xmlns="" class="line">​</span>      bindDN=<span xmlns="" class="perl_String">"cn=Root,dc=jboss,dc=org"</span>
<span xmlns="" class="line">​</span>      bindCredential=secret1
<span xmlns="" class="line">​</span>      baseCtxDN=<span xmlns="" class="perl_String">"ou=People,o=example2,dc=jboss,dc=org"</span>
<span xmlns="" class="line">​</span>      baseFilter=<span xmlns="" class="perl_String">"(uid={0})"</span>
<span xmlns="" class="line">​</span>      rolesCtxDN=<span xmlns="" class="perl_String">"ou=Roles,o=example2,dc=jboss,dc=org"</span>;
<span xmlns="" class="line">​</span>      roleFilter=<span xmlns="" class="perl_String">"(uid={0})"</span>
<span xmlns="" class="line">​</span>      roleAttributeIsDN=<span xmlns="" class="perl_String">"true"</span>
<span xmlns="" class="line">​</span>      roleAttributeID=<span xmlns="" class="perl_String">"memberOf"</span>
<span xmlns="" class="line">​</span>      roleNameAttributeID=<span xmlns="" class="perl_String">"cn"</span>
<span xmlns="" class="line">​</span>};</pre></div></div><div class="example"><a id="idm139921681210928">
      ⁠</a><p class="title"><strong>Example 12.4. Example 3 LDAP Configuration</strong></p><div class="example-contents"><pre class="programlisting">dn: o=example3,dc=jboss,dc=org
objectclass: top
objectclass: dcObject
objectclass: organization
dc: jboss
o: JBoss

dn: ou=People,o=example3,dc=jboss,dc=org
objectclass: top
objectclass: organizationalUnit
ou: People

dn: uid=jduke,ou=People,o=example3,dc=jboss,dc=org
objectclass: top
objectclass: uidObject
objectclass: person
objectClass: inetOrgPerson
uid: jduke
employeeNumber: judke-123
cn: Java Duke
sn: Duke
userPassword: theduke

dn: ou=Roles,o=example3,dc=jboss,dc=org
objectClass: top
objectClass: organizationalUnit
ou: Roles

dn: uid=jduke,ou=Roles,o=example3,dc=jboss,dc=org
objectClass: top
objectClass: groupUserEx
memberOf: cn=Echo,ou=Roles,o=example3,dc=jboss,dc=org
memberOf: cn=TheDuke,ou=Roles,o=example3,dc=jboss,dc=org
uid: jduke

dn: cn=Echo,ou=Roles,o=example3,dc=jboss,dc=org
objectClass: top
objectClass: groupOfNames
cn: Echo
description: the JBossAdmin group
member: uid=jduke,ou=People,o=example3,dc=jboss,dc=org

dn: cn=TheDuke,ou=Roles,o=example3,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: TheDuke
member: uid=jduke,ou=People,o=example3,dc=jboss,dc=org</pre><div class="para">
			The module configuration for this LDAP structure example is outlined in the code sample.
		</div><pre class="programlisting">testLdapExample3 {
   org.jboss.security.auth.spi.LdapExtLoginModule
      java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory
      java.naming.provider.url="ldap://lamia/"
      java.naming.security.authentication=simple
      bindDN="cn=Root,dc=jboss,dc=org"
      bindCredential=secret1
      baseCtxDN="ou=People,o=example3,dc=jboss,dc=org"
      baseFilter="(cn={0})"
      rolesCtxDN="ou=Roles,o=example3,dc=jboss,dc=org";
      roleFilter="(member={1})"
      roleAttributeID="cn"
};</pre></div></div><div class="example"><a id="idm139921632791376">
      ⁠</a><p class="title"><strong>Example 12.5. Example 4 LDAP Configuration</strong></p><div class="example-contents"><pre class="programlisting">dn: o=example4,dc=jboss,dc=org
objectclass: top
objectclass: dcObject
objectclass: organization
dc: jboss
o: JBoss

dn: ou=People,o=example4,dc=jboss,dc=org
objectclass: top
objectclass: organizationalUnit
ou: People

dn: uid=jduke,ou=People,o=example4,dc=jboss,dc=org
objectClass: top
objectClass: uidObject
objectClass: person
objectClass: inetOrgPerson
cn: Java Duke
employeeNumber: jduke-123
sn: Duke
uid: jduke
userPassword:: dGhlZHVrZQ==

dn: ou=Roles,o=example4,dc=jboss,dc=org
objectClass: top
objectClass: organizationalUnit
ou: Roles

dn: cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: RG1
member: cn=empty

dn: cn=RG2,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: RG2
member: cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org
member: uid=jduke,ou=People,o=example4,dc=jboss,dc=org

dn: cn=RG3,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: RG3
member: cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org

dn: cn=R1,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: R1
member: cn=RG2,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org

dn: cn=R2,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: R2
member: cn=RG2,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org

dn: cn=R3,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: R3
member: cn=RG2,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org
member: cn=RG3,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org

dn: cn=R4,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: R4
member: cn=RG3,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org

dn: cn=R5,ou=Roles,o=example4,dc=jboss,dc=org
objectClass: groupOfNames
objectClass: top
cn: R5
member: cn=RG3,cn=RG1,ou=Roles,o=example4,dc=jboss,dc=org
member: uid=jduke,ou=People,o=example4,dc=jboss,dc=org</pre><div class="para">
			The module configuration for this LDAP structure example is outlined in the code sample.
		</div><pre class="programlisting">testLdapExample4 {
   org.jboss.security.auth.spi.LdapExtLoginModule
      java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory
      java.naming.provider.url="ldap://lamia/"
      java.naming.security.authentication=simple
      bindDN="cn=Root,dc=jboss,dc=org"
      bindCredential=secret1
      baseCtxDN="ou=People,o=example4,dc=jboss,dc=org"
      baseFilter="(cn={0})"
      rolesCtxDN="ou=Roles,o=example4,dc=jboss,dc=org";
      roleFilter="(member={1})"
      roleAttributeID="memberOf"
};</pre></div></div><div class="example"><a id="exam-Default_ActiveDirectory_Configuration">
      ⁠</a><p class="title"><strong>Example 12.6. Default ActiveDirectory Configuration</strong></p><div class="example-contents"><div class="para">
			The example below is represents the configuration for a default Active Directory configuration.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0" encoding="UTF-8"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;application-policy</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"AD_Default"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;authentication&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.auth.spi.LdapExtLoginModule"</span><span xmlns="" class="perl_Others"> flag=</span><span xmlns="" class="perl_String">"required"</span> <span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Comment">&lt;!--</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">      Some AD configurations may require searching against</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">      the Global Catalog on port 3268 instead of the usual</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">      port 389.  This is most likely when the AD forest</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">      includes multiple domains.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">      --&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"java.naming.provider.url"</span><span xmlns="" class="perl_Keyword">&gt;</span>ldap://ldap.jboss.org:389<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"bindDN"</span><span xmlns="" class="perl_Keyword">&gt;</span>JBOSS\someadmin<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"bindCredential"</span><span xmlns="" class="perl_Keyword">&gt;</span>password<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"baseCtxDN"</span><span xmlns="" class="perl_Keyword">&gt;</span>cn=Users,dc=jboss,dc=org<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"baseFilter"</span><span xmlns="" class="perl_Keyword">&gt;</span>(sAMAccountName={0})<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"rolesCtxDN"</span><span xmlns="" class="perl_Keyword">&gt;</span>cn=Users,dc=jboss,dc=org<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"roleFilter"</span><span xmlns="" class="perl_Keyword">&gt;</span>(sAMAccountName={0})<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"roleAttributeID"</span><span xmlns="" class="perl_Keyword">&gt;</span>memberOf<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"roleAttributeIsDN"</span><span xmlns="" class="perl_Keyword">&gt;</span>true<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"roleNameAttributeID"</span><span xmlns="" class="perl_Keyword">&gt;</span>cn<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"searchScope"</span><span xmlns="" class="perl_Keyword">&gt;</span>ONELEVEL_SCOPE<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"allowEmptyPasswords"</span><span xmlns="" class="perl_Keyword">&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/authentication&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/application-policy&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>		
<span xmlns="" class="line">​</span>		
<span xmlns="" class="line">​</span>		
<span xmlns="" class="line">​</span>
</pre></div></div><div class="example"><a id="idm139921636466784">
      ⁠</a><p class="title"><strong>Example 12.7. Recursive Roles ActiveDirectory Configuration</strong></p><div class="example-contents"><div class="para">
			The example below implements a recursive role search within ActiveDirectory. The key difference between <a class="xref" href="ch12.html#exam-Default_ActiveDirectory_Configuration">Example 12.6, “Default ActiveDirectory Configuration”</a> is the role search has been replaced to search the member attribute using the DN of the user. The login module then uses the DN of the role to find groups that the group is a member of.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0" encoding="UTF-8"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;application-policy</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"AD_Recursive"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;authentication&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.auth.spi.LdapExtLoginModule"</span><span xmlns="" class="perl_Others"> flag=</span><span xmlns="" class="perl_String">"required"</span> <span xmlns="" class="perl_Keyword">&gt;</span> 
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"java.naming.provider.url"</span><span xmlns="" class="perl_Keyword">&gt;</span>ldap://ad.jboss.org:389<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"bindDN"</span><span xmlns="" class="perl_Keyword">&gt;</span>JBOSS\searchuser<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"bindCredential"</span><span xmlns="" class="perl_Keyword">&gt;</span>password<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"baseCtxDN"</span><span xmlns="" class="perl_Keyword">&gt;</span>CN=Users,DC=jboss,DC=org<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"baseFilter"</span><span xmlns="" class="perl_Keyword">&gt;</span>(sAMAccountName={0})<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"rolesCtxDN"</span><span xmlns="" class="perl_Keyword">&gt;</span>CN=Users,DC=jboss,DC=org<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"roleFilter"</span><span xmlns="" class="perl_Keyword">&gt;</span>(member={1})<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"roleAttributeID"</span><span xmlns="" class="perl_Keyword">&gt;</span>cn<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"roleAttributeIsDN"</span><span xmlns="" class="perl_Keyword">&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"roleRecursion"</span><span xmlns="" class="perl_Keyword">&gt;</span>2<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"searchScope"</span><span xmlns="" class="perl_Keyword">&gt;</span>ONELEVEL_SCOPE<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"allowEmptyPasswords"</span><span xmlns="" class="perl_Keyword">&gt;</span>false<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"java.naming.referral"</span><span xmlns="" class="perl_Keyword">&gt;</span>follow<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/authentication&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/application-policy&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>		
<span xmlns="" class="line">​</span>		
<span xmlns="" class="line">​</span>		
<span xmlns="" class="line">​</span>
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-Password_Stacking">
      ⁠</a>12.1.3. Password Stacking</h2></div></div></div><div class="para">
		Multiple login modules can be chained together in a stack, with each login module providing both the authentication and authorization components. This works for many use cases, but sometimes authentication and authorization are split across multiple user management stores.
	</div><div class="para">
		<a class="xref" href="ch12.html#sect-LdapLoginModule">Section 12.1.1, “LdapLoginModule”</a>describes how to combine LDAP and a relational database, allowing a user to be authenticated by either system. However, consider the case where users are managed in a central LDAP server but application-specific roles are stored in the application's relational database. The password-stacking module option captures this relationship.
	</div><div class="para">
		To use password stacking, each login module should set the <span class="markup">&lt;module-option&gt;</span> <code class="literal">password-stacking</code> attribute to <code class="literal">useFirstPass</code>. If a previous module configured for password stacking has authenticated the user, all the other stacking modules will consider the user authenticated and only attempt to provide a set of roles for the authorization step.
	</div><div class="para">
		When <code class="literal">password-stacking</code> option is set to <code class="literal">useFirstPass</code>, this module first looks for a shared user name and password under the property names <span class="property">javax.security.auth.login.name</span> and <span class="property">javax.security.auth.login.password</span> respectively in the login module shared state map.
	</div><div class="para">
		If found, these properties are used as the principal name and password. If not found, the principal name and password are set by this login module and stored under the property names <span class="property">javax.security.auth.login.name</span> and <span class="property">javax.security.auth.login.password</span> respectively.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			When using password stacking, set all modules to be required. This ensures that all modules are considered, and have the chance to contribute roles to the authorization process.
		</div></div></div><div class="example"><a id="exam-Password_Stacking_Example">
      ⁠</a><p class="title"><strong>Example 12.8. Password Stacking Sample</strong></p><div class="example-contents"><div class="para">
			This example shows how password stacking could be used.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;application-policy</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"todo"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;authentication&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.auth.spi.LdapLoginModule"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">flag=</span><span xmlns="" class="perl_String">"required"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Comment">&lt;!-- LDAP configuration --&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"password-stacking"</span><span xmlns="" class="perl_Keyword">&gt;</span>useFirstPass<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.auth.spi.DatabaseServerLoginModule"</span><span xmlns="" class="perl_Others"> flag=</span><span xmlns="" class="perl_String">"required"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Comment">&lt;!-- database configuration --&gt;</span>                
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"password-stacking"</span><span xmlns="" class="perl_Keyword">&gt;</span>useFirstPass<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/authentication&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/application-policy&gt;</span></pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Using_JBoss_Login_Modules-Password_Hashing">
      ⁠</a>12.1.4. Password Hashing</h2></div></div></div><div class="para">
		Most login modules must compare a client-supplied password to a password stored in a user management system. These modules generally work with plain text passwords, but can be configured to support hashed passwords to prevent plain text passwords from being stored on the server side.
	</div><div class="example"><a id="idm139921662423392">
      ⁠</a><p class="title"><strong>Example 12.9. Password Hashing</strong></p><div class="example-contents"><div class="para">
			The following is a login module configuration that assigns unauthenticated users the principal name <code class="literal">nobody</code> and contains based64-encoded, MD5 hashes of the passwords in a <code class="filename">usersb64.properties</code> file. The <code class="filename">usersb64.properties</code> file can be part of the deployment classpath, or be saved in the <code class="filename">/conf</code> directory.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;policy&gt;</span> 
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;application-policy</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"testUsersRoles"</span><span xmlns="" class="perl_Keyword">&gt;</span> 
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;authentication&gt;</span> 
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.auth.spi.UsersRolesLoginModule"</span><span xmlns="" class="perl_Others"> flag=</span><span xmlns="" class="perl_String">"required"</span><span xmlns="" class="perl_Keyword">&gt;</span> 
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"usersProperties"</span><span xmlns="" class="perl_Keyword">&gt;</span>usersb64.properties<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span> 
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"rolesProperties"</span><span xmlns="" class="perl_Keyword">&gt;</span>test-users-roles.properties<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span> 
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"unauthenticatedIdentity"</span><span xmlns="" class="perl_Keyword">&gt;</span>nobody<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span> 
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"hashAlgorithm"</span><span xmlns="" class="perl_Keyword">&gt;</span>MD5<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span> 
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"hashEncoding"</span><span xmlns="" class="perl_Keyword">&gt;</span>base64<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span> 
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span> 
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/authentication&gt;</span> 
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/application-policy&gt;</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/policy&gt;</span></pre></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">hashAlgorithm</span></dt><dd><div class="para">
					Name of the <code class="literal">java.security.MessageDigest</code> algorithm to use to hash the password. There is no default so this option must be specified to enable hashing. Typical values are <code class="literal">MD5</code> and <code class="literal">SHA</code>.
				</div></dd><dt><span class="term">hashEncoding</span></dt><dd><div class="para">
					String that specifies one of three encoding types: <code class="literal">base64</code>, <code class="literal">hex</code> or <code class="literal">rfc2617</code>. The default is <code class="literal">base64</code>.
				</div></dd><dt><span class="term">hashCharset</span></dt><dd><div class="para">
					Encoding character set used to convert the clear text password to a byte array. The platform default encoding is the default.
				</div></dd><dt><span class="term">hashUserPassword</span></dt><dd><div class="para">
					Specifies the hashing algorithm must be applied to the password the user submits. The hashed user password is compared against the value in the login module, which is expected to be a hash of the password. The default is <code class="literal">true</code>.
				</div></dd><dt><span class="term">hashStorePassword</span></dt><dd><div class="para">
					Specifies the hashing algorithm must be applied to the password stored on the server side. This is used for digest authentication, where the user submits a hash of the user password along with a request-specific tokens from the server to be compare. The hash algorithm (for digest, this would be <code class="literal">rfc2617</code>) is utilized to compute a server-side hash, which should match the hashed value sent from the client.
				</div></dd></dl></div><div class="para">
		If you must generate passwords in code, the <code class="classname">org.jboss.security.Util</code> class provides a static helper method that will hash a password using the specified encoding. The following example produces a base64-encoded, MD5 hashed password.
	</div><pre class="programlisting">String hashedPassword = Util.createPasswordHash("MD5",
 Util.BASE64_ENCODING, null, null, "password");
</pre><div class="para">
		OpenSSL provides an alternative way to quickly generate hashed passwords at the command-line. The following example also produces a base64-encoded, MD5 hashed password. Here the password in plain text - <code class="literal">password</code> - is piped into the OpenSSL digest function then piped into another OpenSSL function to convert into base64-encoded format.
	</div><pre class="programlisting">echo -n password | openssl dgst -md5 -binary | openssl base64</pre><div class="para">
		In both cases, the hashed version of the password is the same: <code class="literal">X03MO1qnZdYdgyfeuILPmQ==</code>. This value must be stored in the users properties file specified in the application policy - <code class="filename">usersb64.properties</code> - in the example above.
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Using_JBoss_Login_Modules-Unauthenticated_Identity">
      ⁠</a>12.1.5. Unauthenticated Identity</h2></div></div></div><div class="para">
		Not all requests are received in an authenticated format. <code class="literal">unauthenticatedIdentity</code> is a login module configuration option that assigns a specific identity (guest, for example) to requests that are made with no associated authentication information. This can be used to allow unprotected servlets to invoke methods on EJBs that do not require a specific role. Such a principal has no associated roles and so can only access either unsecured EJBs or EJB methods that are associated with the unchecked permission constraint.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<span class="bold bold"><strong>unauthenticatedIdentity</strong></span>: This defines the principal name that should be assigned to requests that contain no authentication information.
			</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-UsersRolesLoginModule">
      ⁠</a>12.1.6. UsersRolesLoginModule</h2></div></div></div><div class="para">
		<code class="literal">UsersRolesLoginModule</code> is a simple login module that supports multiple users and user roles loaded from Java properties files. The user name-to-password mapping file is called <code class="filename">users.properties</code> and the user name-to-roles mapping file is called <code class="filename">roles.properties</code>.
	</div><div class="para">
		The supported login module configuration options include the following:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">usersProperties</span></dt><dd><div class="para">
					Name of the properties resource (file) containing the user name to password mappings. This defaults to <code class="filename">&lt;file_prefix&gt;-users.properties</code>.
				</div></dd><dt><span class="term">rolesProperties</span></dt><dd><div class="para">
					Name of the properties resource (file) containing the user name to roles mappings. This defaults to <code class="filename">&lt;file_prefix&gt;-roles.properties</code>.
				</div></dd></dl></div><div class="para">
		This login module supports password stacking, password hashing, and unauthenticated identity.
	</div><div class="para">
		The properties files are loaded during initialization using the initialize method thread context class loader. This means that these files can be placed into the Java EE deployment JAR, the JBoss configuration directory, or any directory on the server or system classpath. The primary purpose of this login module is to easily test the security settings of multiple users and roles using properties files deployed with the application.
	</div><div class="example"><a id="exam-UsersRoleLoginModule">
      ⁠</a><p class="title"><strong>Example 12.10. UserRolesLoginModule</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;deployment</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:bean-deployer:2.0"</span><span xmlns="" class="perl_Keyword">&gt;</span> 
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Comment">&lt;!-- ejb3 test application-policy definition --&gt;</span> 
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;application-policy</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"urn:jboss:security-beans:1.0"</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"ejb3-sampleapp"</span><span xmlns="" class="perl_Keyword">&gt;</span> 
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;authentication&gt;</span> 
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.auth.spi.UsersRolesLoginModule"</span><span xmlns="" class="perl_Others"> flag=</span><span xmlns="" class="perl_String">"required"</span><span xmlns="" class="perl_Keyword">&gt;</span> 
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"usersProperties"</span><span xmlns="" class="perl_Keyword">&gt;</span>ejb3-sampleapp-users.properties<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span> 
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"rolesProperties"</span><span xmlns="" class="perl_Keyword">&gt;</span>ejb3-sampleapp-roles.properties<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span> 
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span> 
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/authentication&gt;</span> 
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/application-policy&gt;</span> 
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/deployment&gt;</span></pre></div></div><div class="para">
		In <a class="xref" href="ch12.html#exam-UsersRoleLoginModule">Example 12.10, “UserRolesLoginModule”</a>, the <code class="filename">ejb3-sampleapp-users.properties</code> file uses a <code class="filename">username=password</code> format with each user entry on a separate line:
	</div><pre class="programlisting">username1=password1
username2=password2
...
</pre><div class="para">
		The <code class="filename">ejb3-sampleapp-roles.properties</code> file referenced in <a class="xref" href="ch12.html#exam-UsersRoleLoginModule">Example 12.10, “UserRolesLoginModule”</a> uses the pattern <code class="literal">username=role1,role2,</code> with an optional group name value. For example:
	</div><pre class="programlisting">username1=role1,role2,...
username1.RoleGroup1=role3,role4,...
username2=role1,role3,...
</pre><div class="para">
		The <span class="property">user name.XXX</span> property name pattern present in <code class="filename">ejb3-sampleapp-roles.properties</code> is used to assign the user name roles to a particular named group of roles where the <code class="literal">XXX</code> portion of the property name is the group name. The <span class="property">user name=...</span> form is an abbreviation for <span class="property">user name.Roles=...</span>, where the <code class="literal">Roles</code> group name is the standard name the <code class="literal">JaasSecurityManager</code> expects to contain the roles which define the users permissions.
	</div><div class="para">
		The following would be equivalent definitions for the <code class="literal">jduke</code> user name:
	</div><pre class="programlisting">jduke=TheDuke,AnimatedCharacter
jduke.Roles=TheDuke,AnimatedCharacter
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-DatabaseServerLoginModule">
      ⁠</a>12.1.7. DatabaseServerLoginModule</h2></div></div></div><div class="para">
		The <code class="literal">DatabaseServerLoginModule</code> is a Java Database Connectivity-based (JDBC) login module that supports authentication and role mapping. Use this login module if you have your user name, password and role information stored in a relational database.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			This module supports password stacking, password hashing and unauthenticated identity.
		</div></div></div><div class="para">
		The <code class="literal">DatabaseServerLoginModule</code> is based on two logical tables:
	</div><pre class="programlisting">Table Principals(PrincipalID text, Password text)
Table Roles(PrincipalID text, Role text, RoleGroup text)
</pre><div class="para">
		The <code class="literal">Principals</code> table associates the user <code class="literal">PrincipalID</code> with the valid password and the <code class="literal">Roles</code> table associates the user <code class="literal">PrincipalID</code> with its role sets. The roles used for user permissions must be contained in rows with a <code class="literal">RoleGroup</code> column value of <code class="literal">Roles</code>.
	</div><div class="para">
		The tables are logical in that you can specify the SQL query that the login module uses. The only requirement is that the <code class="literal">java.sql.ResultSet</code> has the same logical structure as the <code class="literal">Principals</code> and <code class="literal">Roles</code> tables described previously. The actual names of the tables and columns are not relevant as the results are accessed based on the column index.
	</div><div class="para">
		To clarify this notion, consider a database with two tables, <code class="literal">Principals</code> and <code class="literal">Roles</code>, as already declared. The following statements populate the tables with the following data:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<code class="literal">PrincipalID</code> <code class="literal">java</code> with a <code class="literal">Password</code> of <code class="literal">echoman</code> in the <code class="literal">Principals</code> table
			</div></li><li class="listitem"><div class="para">
				<code class="literal">PrincipalID</code> <code class="literal">java</code> with a role named <code class="literal">Echo</code> in the <code class="literal">Roles</code><code class="literal">RoleGroup</code> in the <code class="literal">Roles</code> table
			</div></li><li class="listitem"><div class="para">
				<code class="literal">PrincipalID</code> <code class="literal">java</code> with a role named <code class="literal">caller_java</code> in the <code class="literal">CallerPrincipal</code><code class="literal">RoleGroup</code> in the <code class="literal">Roles</code> table
			</div></li></ul></div><pre class="programlisting">INSERT INTO Principals VALUES('java', 'echoman')
INSERT INTO Roles VALUES('java', 'Echo', 'Roles')
INSERT INTO Roles VALUES('java', 'caller_java', 'CallerPrincipal')
</pre><div class="para">
		The supported login module configuration options include the following:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">dsJndiName</span></dt><dd><div class="para">
					The JNDI name for the <code class="literal">DataSource</code> of the database containing the logical <code class="literal">Principals</code> and <code class="literal">Roles</code> tables. If not specified this defaults to <code class="literal">java:/DefaultDS</code>.
				</div></dd><dt><span class="term">principalsQuery</span></dt><dd><div class="para">
					The prepared statement query equivalent to: <code class="literal">select Password from Principals where PrincipalID=?</code>. If not specified this is the exact prepared statement that will be used.
				</div></dd><dt><span class="term">rolesQuery</span></dt><dd><div class="para">
					The prepared statement query equivalent to: <code class="literal">select Role, RoleGroup from Roles where PrincipalID=?</code>. If not specified this is the exact prepared statement that will be used.
				</div></dd><dt><span class="term">ignorePasswordCase</span></dt><dd><div class="para">
					A boolean flag indicating if the password comparison should ignore case. This can be useful for hashed password encoding where the case of the hashed password is not significant.
				</div></dd><dt><span class="term">principalClass</span></dt><dd><div class="para">
					An option that specifies a <code class="literal">Principal</code> implementation class. This must support a constructor taking a string argument for the principal name.
				</div></dd><dt><span class="term">transactionManagerJndiName</span></dt><dd><div class="para">
					The JNDI name of the transaction manager used by the login module. If no value is provided, the default <code class="literal">java:/TransactionManager</code> is used.
				</div></dd><dt><span class="term">suspendResume</span></dt><dd><div class="para">
					A boolean flag indicating whether an active transaction associated with the current thread should be suspended during a database operation and resumed after the operation is completed. The default value is <code class="literal">true</code>.
				</div></dd></dl></div><div class="para">
		An example <code class="literal">DatabaseServerLoginModule</code> configuration could be constructed as follows:
	</div><pre class="programlisting">CREATE TABLE Users(username VARCHAR(64) PRIMARY KEY, passwd VARCHAR(64))
CREATE TABLE UserRoles(username VARCHAR(64), userRoles VARCHAR(32))
</pre><div class="para">
		A corresponding <code class="literal">login-config.xml</code> entry would be:
	</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;policy&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;application-policy</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"testDB"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;authentication&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.auth.spi.DatabaseServerLoginModule"</span><span xmlns="" class="perl_Others"> flag=</span><span xmlns="" class="perl_String">"required"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"dsJndiName"</span><span xmlns="" class="perl_Keyword">&gt;</span>java:/MyDatabaseDS<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"principalsQuery"</span><span xmlns="" class="perl_Keyword">&gt;</span>select passwd from Users username where username=?<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"rolesQuery"</span><span xmlns="" class="perl_Keyword">&gt;</span>select userRoles, 'Roles' from UserRoles where username=?<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/authentication&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/application-policy&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/policy&gt;</span></pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-BaseCertLoginModule">
      ⁠</a>12.1.8. BaseCertLoginModule</h2></div></div></div><div class="para">
		<code class="literal">BaseCertLoginModule</code> authenticates users based on X509 certificates. A typical use case for this login module is <code class="literal">CLIENT-CERT</code> authentication in the web tier.
	</div><div class="para">
		This login module only performs authentication: you must combine it with another login module capable of acquiring authorization roles to completely define access to a secured web or EJB component. Two subclasses of this login module, <code class="literal">CertRolesLoginModule</code> and <code class="literal">DatabaseCertLoginModule</code> extend the behavior to obtain the authorization roles from either a properties file or database.
	</div><div class="para">
		The <code class="literal">BaseCertLoginModule</code> needs a <code class="literal">KeyStore</code> to perform user validation. This is obtained through a <code class="literal">org.jboss.security.SecurityDomain</code> implementation. Typically, the <code class="literal">SecurityDomain</code> implementation is configured using the <code class="literal">org.jboss.security.plugins.JaasSecurityDomain</code> MBean as shown in this <code class="filename">jboss-service.xml</code> configuration fragment:
	</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.plugins.JaasSecurityDomain"</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"jboss.ch8:service=SecurityDomain"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;constructor&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;arg</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"java.lang.String"</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"jmx-console"</span><span xmlns="" class="perl_Keyword">/&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/constructor&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"KeyStoreURL"</span><span xmlns="" class="perl_Keyword">&gt;</span>resource:localhost.keystore<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"KeyStorePass"</span><span xmlns="" class="perl_Keyword">&gt;</span>unit-tests-server<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span></pre><div class="para">
		The configuration creates a security domain with the name <code class="literal">jmx-console</code>, with a <code class="literal">SecurityDomain</code> implementation available through JNDI under the name <code class="literal">java:/jaas/jmx-console</code>. The security domain follows the JBossSX security domain naming pattern.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="proc-Secure_Web_Applications_With_Certs_Role_Based_Authorization">
      ⁠</a><p class="title"><strong>Procedure 12.1. Secure Web Applications with Certificates and Role-based Authorization</strong></p><div class="para">
			This procedure describes how to secure a web application, such as the <code class="filename">jmx-console.war,</code> using client certificates and role-based authorization.
		</div><ol class="1"><li class="step"><p class="title"><strong>Declare Resources and Roles</strong></p><div class="para">
				Modify <code class="filename">web.xml</code> to declare the resources to be secured along with the allowed roles and security domain to be used for authentication and authorization.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;web-app</span><span xmlns="" class="perl_Others"> version=</span><span xmlns="" class="perl_String">"2.5"</span><span xmlns="" class="perl_Others"> xmlns=</span><span xmlns="" class="perl_String">"http://java.sun.com/xml/ns/javaee"</span><span xmlns="" class="perl_Others"> xmlns:xsi=</span><span xmlns="" class="perl_String">"http://www.w3.org/2001/XMLSchema-instance"</span><span xmlns="" class="perl_Others"> xsi:schemaLocation=</span><span xmlns="" class="perl_String">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   
<span xmlns="" class="line">​</span> ...
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Comment">&lt;!-- A security constraint that restricts access to the HTML JMX   console to users with the role JBossAdmin. Edit the roles to what you want and uncomment the WEB-INF/jboss-web.xml/security-domain element to enable secured access to the HTML JMX console. --&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;security-constraint&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;web-resource-collection&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;web-resource-name&gt;</span>HtmlAdaptor<span xmlns="" class="perl_Keyword">&lt;/web-resource-name&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;description&gt;</span>An example security config that only allows users with the role JBossAdmin to access the HTML JMX console web application
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;/description&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;url-pattern&gt;</span>/*<span xmlns="" class="perl_Keyword">&lt;/url-pattern&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/web-resource-collection&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;auth-constraint&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;role-name&gt;</span>JBossAdmin<span xmlns="" class="perl_Keyword">&lt;/role-name&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/auth-constraint&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/security-constraint&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;login-config&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;auth-method&gt;</span>BASIC<span xmlns="" class="perl_Keyword">&lt;/auth-method&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;realm-name&gt;</span>JBoss JMX Console<span xmlns="" class="perl_Keyword">&lt;/realm-name&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/login-config&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;security-role&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;role-name&gt;</span>JBossAdmin<span xmlns="" class="perl_Keyword">&lt;/role-name&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/security-role&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/web-app&gt;</span>
</pre></li><li class="step"><p class="title"><strong>Specify the JBoss Security Domain</strong></p><div class="para">
				In the <code class="literal">jboss-web.xml</code> file, specify the required security domain.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss-web&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;security-domain&gt;</span>jmx-console<span xmlns="" class="perl_Keyword">&lt;/security-domain&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss-web&gt;</span>
</pre></li><li class="step"><p class="title"><strong>Specify Login Module Configuration</strong></p><div class="para">
				Define the login module configuration for the jmx-console security domain you just specified. This is done in the <code class="literal">conf/login-config.xml</code> file.
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;application-policy</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"jmx-console"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;authentication&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.auth.spi.BaseCertLoginModule"</span><span xmlns="" class="perl_Others"> flag=</span><span xmlns="" class="perl_String">"required"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"password-stacking"</span><span xmlns="" class="perl_Keyword">&gt;</span>useFirstPass<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"securityDomain"</span><span xmlns="" class="perl_Keyword">&gt;</span>jmx-console<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.auth.spi.UsersRolesLoginModule"</span><span xmlns="" class="perl_Others"> flag=</span><span xmlns="" class="perl_String">"required"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"password-stacking"</span><span xmlns="" class="perl_Keyword">&gt;</span>useFirstPass<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"usersProperties"</span><span xmlns="" class="perl_Keyword">&gt;</span>jmx-console-users.properties<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"rolesProperties"</span><span xmlns="" class="perl_Keyword">&gt;</span>jmx-console-roles.properties<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/authentication&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/application-policy&gt;</span>
</pre></li></ol></div><div class="para">
		<a class="xref" href="ch12.html#proc-Secure_Web_Applications_With_Certs_Role_Based_Authorization">Procedure 12.1, “Secure Web Applications with Certificates and Role-based Authorization”</a>shows the <code class="literal">BaseCertLoginModule</code> is used for authentication of the client cert, and the <code class="literal">UsersRolesLoginModule</code> is only used for authorization due to the <code class="literal">password-stacking=useFirstPass</code> option. Both the <code class="literal">localhost.keystore</code> and the <code class="literal">jmx-console-roles.properties</code> require an entry that maps to the principal associated with the client cert.
	</div><div class="para">
		By default, the principal is created using the client certificate distinguished name, such as the DN specified in <a class="xref" href="ch12.html#exam-Certificate_Example">Example 12.11, “Certificate Example”</a>.
	</div><div class="example"><a id="exam-Certificate_Example">
      ⁠</a><p class="title"><strong>Example 12.11. Certificate Example</strong></p><div class="example-contents"><pre class="screen">[conf]$ keytool -printcert -file unit-tests-client.export
Owner: CN=unit-tests-client, OU=JBoss Inc., O=JBoss Inc., ST=Washington, C=US
Issuer: CN=jboss.com, C=US, ST=Washington, L=Snoqualmie Pass, EMAILADDRESS=admin
@jboss.com, OU=QA, O=JBoss Inc.
Serial number: 100103
Valid from: Wed May 26 07:34:34 PDT 2004 until: Thu May 26 07:34:34 PDT 2005
Certificate fingerprints:
         MD5:  4A:9C:2B:CD:1B:50:AA:85:DD:89:F6:1D:F5:AF:9E:AB
         SHA1: DE:DE:86:59:05:6C:00:E8:CC:C0:16:D3:C2:68:BF:95:B8:83:E9:58</pre></div></div><div class="para">
		The <code class="literal">localhost.keystore</code> would need the certificate in <a class="xref" href="ch12.html#exam-Certificate_Example">Example 12.11, “Certificate Example”</a> stored with an alias of <code class="literal">CN=unit-tests-client, OU=JBoss Inc., O=JBoss Inc., ST=Washington, C=US</code>. The <code class="literal">jmx-console-roles.properties</code> would also need an entry for the same entry. Since the DN contains characters that are normally treated as delimiters, you must escape the problem characters using a backslash ('<code class="literal">\</code>') as illustrated below.
	</div><pre class="screen"># A sample roles.properties file for use with the UsersRolesLoginModule
CN\=unit-tests-client,\ OU\=JBoss\ Inc.,\ O\=JBoss\ Inc.,\ ST\=Washington,\ C\=US=JBossAdmin
admin=JBossAdmin</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-IdentityLoginModule">
      ⁠</a>12.1.9. IdentityLoginModule</h2></div></div></div><div class="para">
		<code class="literal">IdentityLoginModule</code> is a simple login module that associates a hard-coded user name to any subject authenticated against the module. It creates a <code class="literal">SimplePrincipal</code> instance using the name specified by the <code class="literal">principal</code> option.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			This module supports password stacking.
		</div></div></div><div class="para">
		This login module is useful when you need to provide a fixed identity to a service, and in development environments when you want to test the security associated with a given principal and associated roles.
	</div><div class="para">
		The supported login module configuration options include:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">principal</span></dt><dd><div class="para">
					This is the name to use for the <code class="literal">SimplePrincipal</code> all users are authenticated as. The principal name defaults to <code class="literal">guest</code> if no principal option is specified.
				</div></dd><dt><span class="term">roles</span></dt><dd><div class="para">
					This is a comma-delimited list of roles that will be assigned to the user.
				</div></dd></dl></div><div class="para">
		A sample XMLLoginConfig configuration entry is described below. The entry authenticates all users as the principal named <code class="literal">jduke</code> and assign role names of <code class="literal">TheDuke</code>, and <code class="literal">AnimatedCharacter</code>:.
	</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;policy&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;application-policy</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"testIdentity"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;authentication&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.auth.spi.IdentityLoginModule"</span><span xmlns="" class="perl_Others"> flag=</span><span xmlns="" class="perl_String">"required"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"principal"</span><span xmlns="" class="perl_Keyword">&gt;</span>jduke<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"roles"</span><span xmlns="" class="perl_Keyword">&gt;</span>TheDuke,AnimatedCharacter<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/authentication&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/application-policy&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/policy&gt;</span></pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-RunAsLoginModule">
      ⁠</a>12.1.10. RunAsLoginModule</h2></div></div></div><div class="para">
		<code class="literal">RunAsLoginModule</code> (<code class="classname">org.jboss.security.auth.spi.RunAsLoginModule</code>) is a helper module that pushes a run as role onto the stack for the duration of the log in phase of authentication, and pops the run as role in either the commit or abort phase.
	</div><div class="para">
		The purpose of this login module is to provide a role for other login modules that must access secured resources in order to perform their authentication (for example, a login module that accesses a secured EJB). <code class="literal">RunAsLoginModule</code> must be configured ahead of the login modules that require a run as role established.
	</div><div class="para">
		The only login module configuration option is:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">roleName</span></dt><dd><div class="para">
					Name of the role to use as the run as role during log in phase. If not specified a default of <code class="literal">nobody</code> is used.
				</div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-RunAsIdentity_Creation">
      ⁠</a>12.1.11. RunAsIdentity Creation</h2></div></div></div><div class="para">
		In order for JBoss Enterprise Application Platform to secure access to EJB methods, the user's identity must be known at the time the method call is made.
	</div><div class="para">
		A user's identity in the server is represented either by a <code class="classname">javax.security.auth.Subject</code> instance or an <code class="classname">org.jboss.security.RunAsIdentity</code> instance. Both these classes store one or more principals that represent the identity and a list of roles that the identity possesses. In the case of the <code class="classname">javax.security.auth.Subject</code> a list of credentials is also stored.
	</div><div class="para">
		In the <span class="markup">&lt;assembly-descriptor&gt;</span> section of the <code class="filename">ejb-jar.xml</code> deployment descriptor, you specify one or more roles that a user must have to access the various EJB methods. A comparison of these lists reveals whether the user has one of the roles necessary to access the EJB method.
	</div><div class="example"><a id="exam-RunAsIdentity_Creation">
      ⁠</a><p class="title"><strong>Example 12.12. org.jboss.security.RunAsIdentity Creation</strong></p><div class="example-contents"><div class="para">
			In the <code class="filename">ejb-jar.xml</code> file, you specify a <span class="markup">&lt;security-identity&gt;</span> element with a <span class="markup">&lt;run-as&gt;</span> role defined as a child of the &lt;session&gt; element.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;session&gt;</span>
<span xmlns="" class="line">​</span>   ...
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;security-identity&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;run-as&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;role-name&gt;</span>Admin<span xmlns="" class="perl_Keyword">&lt;/role-name&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/run-as&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/security-identity&gt;</span>
<span xmlns="" class="line">​</span>   ...
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/session&gt;</span></pre><div class="para">
			This declaration signifies that an "Admin" RunAsIdentity role must be created.
		</div><div class="para">
			To name a principal for the Admin role, you define a <code class="sgmltag-element"> &lt;run-as-principal&gt; </code> element in the <code class="filename">jboss-web.xml</code> file.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;session&gt;</span>
<span xmlns="" class="line">​</span>   ...
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;security-identity&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;run-as-principal&gt;</span>John<span xmlns="" class="perl_Keyword">&lt;/run-as-principal&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/security-identity&gt;</span>
<span xmlns="" class="line">​</span>   ...
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/session&gt;</span></pre><div class="para">
			The <code class="sgmltag-element"> &lt;security-identity&gt; </code> element in both the <code class="filename">ejb-jar.xml</code> and <code class="filename">jboss-web.xml</code> files are parsed at deployment time. The <code class="sgmltag-element"> &lt;run-as&gt; </code> role name and the <code class="sgmltag-element"> &lt;run-as-principal&gt; </code> name are then stored in the <code class="classname">org.jboss.metadata.SecurityIdentityMetaData</code> class.
		</div></div></div><div class="example"><a id="idm139921691202864">
      ⁠</a><p class="title"><strong>Example 12.13. Assigning multiple roles to a RunAsIdentity</strong></p><div class="example-contents"><div class="para">
			You can assign more roles to RunAsIdentity by mapping roles to principals in the <code class="filename">jboss-web.xml</code> deployment descriptor <code class="sgmltag-element"> &lt;assembly-descriptor&gt; </code> element group.
		</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;assembly-descriptor&gt;</span>
<span xmlns="" class="line">​</span>   ...
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;security-role&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;role-name&gt;</span>Support<span xmlns="" class="perl_Keyword">&lt;/role-name&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;principal-name&gt;</span>John<span xmlns="" class="perl_Keyword">&lt;/principal-name&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;principal-name&gt;</span>Jill<span xmlns="" class="perl_Keyword">&lt;/principal-name&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;principal-name&gt;</span>Tony<span xmlns="" class="perl_Keyword">&lt;/principal-name&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/security-role&gt;</span>
<span xmlns="" class="line">​</span>   ...
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/assembly-descriptor&gt;</span></pre><div class="para">
			In <a class="xref" href="ch12.html#exam-RunAsIdentity_Creation">Example 12.12, “org.jboss.security.RunAsIdentity Creation”</a>, the <code class="sgmltag-element"> &lt;run-as-principal&gt; </code> of "Mark" was created. The configuration in this example extends the "Admin" role, by adding the "Support" role. The new role contains extra principals, including the originally defined principal "John".
		</div><div class="para">
			The <code class="sgmltag-element"> &lt;security-role&gt; </code> element in both the <code class="filename">ejb-jar.xml</code> and <code class="filename">jboss.xml</code> files are parsed at deployment time. The <code class="sgmltag-element"> &lt;role-name&gt; </code> and the <code class="sgmltag-element"> &lt;principal-name&gt; </code> data is stored in the <code class="classname">org.jboss.metadata.SecurityIdentityMetaData</code> class.
		</div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-ClientLoginModule">
      ⁠</a>12.1.12. ClientLoginModule</h2></div></div></div><div class="para">
		<code class="literal">ClientLoginModule</code> (<code class="classname">org.jboss.security.ClientLoginModule</code>) is an implementation of <code class="literal">LoginModule</code> for use by JBoss clients for establishing caller identity and credentials. This simply sets the <code class="literal">org.jboss.security.SecurityAssociation.principal</code> to the value of the <code class="literal">NameCallback</code> filled in by the <code class="literal">callbackhandler</code>, and the <code class="literal">org.jboss.security.SecurityAssociation.credential</code> to the value of the <code class="literal">PasswordCallback</code> filled in by the <code class="literal">callbackhandler</code>.
	</div><div class="para">
		<code class="literal">ClientLoginModule</code> is the only supported mechanism for a client to establish the current thread's caller. Both stand-alone client applications, and server environments (acting as JBoss EJB clients where the security environment has not been configured to use JBossSX transparently) must use <code class="literal">ClientLoginModule</code>.
	</div><div class="para">
		Note that this login module does not perform any authentication. It merely copies the login information provided to it into the server EJB invocation layer for subsequent authentication on the server. If you need to perform client-side authentication of users you would need to configure another login module in addition to the <code class="literal">ClientLoginModule</code>.
	</div><div class="para">
		The supported login module configuration options include the following:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">multi-threaded</span></dt><dd><div class="para">
					Value that specifies the way login threads connect to principal and credential storage sources. When set to true, each login thread has its own principal and credential storage and each separate thread must perform its own log in. This is useful in client environments where multiple user identities are active in separate threads. When set to false the login identity and credentials are global variables that apply to all threads in the VM. The default setting is <code class="literal">false</code>.
				</div></dd><dt><span class="term">password-stacking</span></dt><dd><div class="para">
					Activates client-side authentication of clients using other login modules such as the <code class="literal">LdapLoginModule</code>. When <code class="literal">password-stacking</code> option is set to <code class="literal">useFirstPass</code>, the module first looks for a shared user name and password using <code class="literal">javax.security.auth.login.name</code> and <code class="literal">javax.security.auth.login.password</code> respectively in the login module shared state map. This allows a module configured prior to this one to establish a valid JBoss user name and password.
				</div></dd><dt><span class="term">restore-login-identity</span></dt><dd><div class="para">
					Value that specifies whether the <code class="literal">SecurityAssociation</code> principal and credential seen on entry to the <code class="methodname"> login() </code> method are saved and restored on either abort or logout. This is necessary if you must change identities and then restore the original caller identity. If set to <code class="literal">true</code>, the principal and credential information is saved and restored on abort or logout. If set to <code class="literal">false</code>, abort and logout clear the <code class="literal">SecurityAssociation</code>. The default value is <code class="literal">false</code>.
				</div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-SPNEGOLoginModule">
      ⁠</a>12.1.13. SPNEGOLoginModule</h2></div></div></div><div class="para">
		<code class="literal">SPNEGOLoginModule</code> (<code class="classname">org.jboss.security.negotiation.spnego.SPNEGOLoginModule</code>) is an implementation of <code class="literal">LoginModule</code> that establishes caller identity and credentials with a KDC. The module implements SPNEGO (Simple and Protected GSSAPI Negotiation mechanism) and is a part of the JBoss Negotiation project. This authentication can be used in the chained configuration with the AdvancedLDAPLoginModule to allow cooperation with an LDAP server. For further information on <span class="productname">JBoss Negotiation</span> refer to the Negotiation User Guide.
	</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-RoleMappingLoginModule">
      ⁠</a>12.1.14. RoleMappingLoginModule</h2></div></div></div><div class="para">
		<code class="literal">RoleMappingLoginModule</code> is a login module that supports mapping roles that are the end result of the authentication process to one or more declarative roles; for example, if the authentication process has determined that the user "A" has the roles "ldapAdmin" and "testAdmin", and the declarative role defined in the <code class="filename">web.xml</code> or <code class="filename">ejb-jar.xml</code> file for access is "admin", then this login module maps the "admin" roles to the user "A".
	</div><div class="para">
		The supported login module configuration options include the following:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="property">rolesProperties</span></span></dt><dd><div class="para">
					Name of the properties file that defines the addition/substitution rules; the value defines the file in the form as located using Classloader or with its absolute location given by the java.net.url pattern (for example, <code class="filename">file:/rolesMap.properties</code>)
				</div></dd><dt><span class="term"><span class="property">replaceRole</span></span></dt><dd><div class="para">
					Flag determining if the key role is replaced with the mapped roles or the mapped roles are added to the key role (set to <code class="literal">true</code> to have the key role replaced with the mapped roles)
				</div></dd></dl></div><div class="para">
		The <code class="literal">RoleMappingLoginModule</code> must be defined as an optional module to a login module configuration as it alters mapping of the previously mapped roles.
	</div><pre class="programlisting">&lt;application-policy name="jmx-console"&gt;
    &lt;authentication&gt;
      &lt;login-module code="org.jboss.security.auth.spi.UsersRolesLoginModule"
        flag="required"&gt;
        &lt;module-option name="usersProperties"&gt;props/jmx-console-users.properties&lt;/module-option&gt;
        &lt;module-option name="rolesProperties"&gt;props/jmx-console-roles.properties&lt;/module-option&gt;
      &lt;/login-module&gt;
      &lt;login-module code="org.jboss.security.auth.spi.RoleMappingLoginModule"
        flag="optional"&gt; 
        &lt;module-option name="rolesProperties"&gt;props/rolesMapping-roles.properties&lt;/module-option&gt;
      &lt;/login-module&gt;
    &lt;/authentication&gt;
  &lt;/application-policy&gt;</pre><div class="example"><a id="exam-PropertiesFile_RoleMappingLoginModule">
      ⁠</a><p class="title"><strong>Example 12.14. Properties File used by a RoleMappingLoginModule</strong></p><div class="example-contents"><pre class="programlisting">ldapAdmin=admin, testAdmin</pre><div class="para">
			If the authenticated subject contains role "ldapAdmin", then the roles "admin" and "testAdmin" are added to or substitute the authenticated subject depending on the <span class="property">replaceRole</span> property value.
		</div></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Custom_Modules">
      ⁠</a>12.2. Custom Modules</h1></div></div></div><div class="para">
		If the login modules bundled with the JBossSX framework do not work with your security environment, you can write your own custom login module implementation. The <code class="literal">JaasSecurityManager</code> requires a particular usage pattern of the <code class="literal">Subject</code> principals set. You must understand the JAAS Subject class's information storage features and the expected usage of these features to write a login module that works with the <code class="literal">JaasSecurityManager</code>.
	</div><div class="para">
		This section examines this requirement and introduces two abstract base <code class="literal">LoginModule</code> implementations that can help you implement custom login modules.
	</div><div class="para">
		You can obtain security information associated with a <code class="literal">Subject</code> by using the following methods:
	</div><pre class="programlisting"><span xmlns="" class="line">​</span>java.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">Set</span> <span xmlns="" class="perl_Function">getPrincipals</span>()
<span xmlns="" class="line">​</span>java.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">Set</span> <span xmlns="" class="perl_Function">getPrincipals</span>(java.<span xmlns="" class="perl_Function">lang</span>.<span xmlns="" class="perl_Function">Class</span> c)
<span xmlns="" class="line">​</span>java.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">Set</span> <span xmlns="" class="perl_Function">getPrivateCredentials</span>()
<span xmlns="" class="line">​</span>java.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">Set</span> <span xmlns="" class="perl_Function">getPrivateCredentials</span>(java.<span xmlns="" class="perl_Function">lang</span>.<span xmlns="" class="perl_Function">Class</span> c)
<span xmlns="" class="line">​</span>java.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">Set</span> <span xmlns="" class="perl_Function">getPublicCredentials</span>()
<span xmlns="" class="line">​</span>java.<span xmlns="" class="perl_Function">util</span>.<span xmlns="" class="perl_Function">Set</span> <span xmlns="" class="perl_Function">getPublicCredentials</span>(java.<span xmlns="" class="perl_Function">lang</span>.<span xmlns="" class="perl_Function">Class</span> c)</pre><div class="para">
		For <code class="literal">Subject</code> identities and roles, JBossSX has selected the most logical choice: the principals sets obtained via <code class="literal">getPrincipals()</code> and <code class="literal">getPrincipals(java.lang.Class)</code>. The usage pattern is as follows:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				User identities (for example; user name, social security number, employee ID) are stored as <code class="literal">java.security.Principal</code> objects in the <code class="literal">Subject</code><code class="literal">Principals</code> set. The <code class="literal">Principal</code> implementation that represents the user identity must base comparisons and equality on the name of the principal. A suitable implementation is available as the <code class="literal">org.jboss.security.SimplePrincipal</code> class. Other <code class="literal">Principal</code> instances may be added to the <code class="literal">Subject</code><code class="literal">Principals</code> set as needed.
			</div></li><li class="listitem"><div class="para">
				Assigned user roles are also stored in the <code class="literal">Principals</code> set, and are grouped in named role sets using <code class="literal">java.security.acl.Group</code> instances. The <code class="literal">Group</code> interface defines a collection of <code class="literal">Principal</code>s and/or <code class="literal">Group</code>s, and is a subinterface of <code class="literal">java.security.Principal</code>.
			</div></li><li class="listitem"><div class="para">
				Any number of role sets can be assigned to a <code class="literal">Subject</code>.
			</div></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				The JBossSX framework uses two well-known role sets with the names <code class="literal">Roles</code> and <code class="literal">CallerPrincipal</code>.
			</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
						The <code class="literal">Roles</code> group is the collection of <code class="literal">Principal</code>s for the named roles as known in the application domain under which the <code class="literal">Subject</code> has been authenticated. This role set is used by methods like the <code class="literal">EJBContext.isCallerInRole(String)</code>, which EJBs can use to see if the current caller belongs to the named application domain role. The security interceptor logic that performs method permission checks also uses this role set.
					</div></li><li class="listitem"><div class="para">
						The <code class="literal">CallerPrincipal</code> <code class="literal">Group</code> consists of the single <code class="literal">Principal</code> identity assigned to the user in the application domain. The <code class="literal">EJBContext.getCallerPrincipal() </code>method uses the <code class="literal">CallerPrincipal</code> to allow the application domain to map from the operation environment identity to a user identity suitable for the application. If a <code class="literal">Subject</code> does not have a <code class="literal">CallerPrincipal</code> <code class="literal">Group</code>, the application identity is the same as operational environment identity.
					</div></li></ul></div></li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-Subject_Usage_Pattern_Support">
      ⁠</a>12.2.1. Subject Usage Pattern Support</h2></div></div></div><div class="para">
		To simplify correct implementation of the <code class="literal">Subject</code> usage patterns described in <a class="xref" href="ch12.html#sect-Custom_Modules">Section 12.2, “Custom Modules”</a>, JBossSX includes login modules that populate the authenticated <code class="literal">Subject</code> with a template pattern that enforces correct <code class="literal">Subject</code> usage.
	</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">AbstractServerLoginModule</div>
			The most generic of the two is the <code class="literal">org.jboss.security.auth.spi.AbstractServerLoginModule</code> class.
		</div><div class="para">
		It provides an implementation of the <code class="literal">javax.security.auth.spi.LoginModule</code> interface and offers abstract methods for the key tasks specific to an operation environment security infrastructure. The key details of the class are highlighted in <a class="xref" href="ch12.html#exam-AbstractServerLoginModule_Class_Fragment">Example 12.15, “AbstractServerLoginModule Class Fragment”</a>. The JavaDoc comments detail the responsibilities of subclasses.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
			The <code class="literal">loginOk</code> instance variable is pivotal. This must be set to <code class="literal">true</code> if the log in succeeds, or <code class="literal">false</code> by any subclasses that override the log in method. If this variable is incorrectly set, the commit method will not correctly update the subject.
		</div></div></div><div class="para">
		Tracking the log in phase outcomes allows login modules to be chained together with control flags. These control flags do not require the login modules to succeed as part of the authentication process.
	</div><div class="example"><a id="exam-AbstractServerLoginModule_Class_Fragment">
      ⁠</a><p class="title"><strong>Example 12.15. AbstractServerLoginModule Class Fragment</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span>package org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">auth</span>.<span xmlns="" class="perl_Function">spi</span>;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  This class implements the common functionality required for a JAAS</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  server-side LoginModule and implements the JBossSX standard</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  Subject usage pattern of storing identities and roles. Subclass</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  this module to create your own custom LoginModule and override the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  login(), getRoleSets(), and getIdentity() methods.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> AbstractServerLoginModule
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">implements</span> javax.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">auth</span>.<span xmlns="" class="perl_Function">spi</span>.<span xmlns="" class="perl_Function">LoginModule</span>
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> Subject subject;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> CallbackHandler callbackHandler;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> Map sharedState;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> Map options;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> Logger log;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** Flag indicating if the shared credential should be used */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_DataType">boolean</span> useFirstPass;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Flag indicating if the login phase succeeded. Subclasses that</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * override the login method must set this to true on successful</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * completion of login</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_DataType">boolean</span> loginOk;
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">// ...</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Initialize the login module. This stores the subject,</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * callbackHandler and sharedState and options for the login</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * session. Subclasses should override if they need to process</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * their own options. A call to super.initialize(...)  must be</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * made in the case of an override.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">&lt;p&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * The options are checked for the  </span><span xmlns="" class="perl_Keyword">&lt;em&gt;</span><span xmlns="" class="perl_Comment">password-stacking</span><span xmlns="" class="perl_Keyword">&lt;/em&gt;</span><span xmlns="" class="perl_Comment"> parameter.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * If this is set to "useFirstPass", the login identity will be taken from the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">&lt;code&gt;</span><span xmlns="" class="perl_Comment">javax.security.auth.login.name</span><span xmlns="" class="perl_Keyword">&lt;/code&gt;</span><span xmlns="" class="perl_Comment"> value of the sharedState map,</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * and the proof of identity from the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">&lt;code&gt;</span><span xmlns="" class="perl_Comment">javax.security.auth.login.password</span><span xmlns="" class="perl_Keyword">&lt;/code&gt;</span><span xmlns="" class="perl_Comment"> value of the sharedState map.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param subject </span><span xmlns="" class="perl_Comment">the Subject to update after a successful login.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param callbackHandler </span><span xmlns="" class="perl_Comment">the CallbackHandler that will be used to obtain the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * the user identity and credentials.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param sharedState </span><span xmlns="" class="perl_Comment">a Map shared between all configured login module instances</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@param options </span><span xmlns="" class="perl_Comment">the parameters passed to the login module.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> initialize(Subject subject,
<span xmlns="" class="line">​</span>                           CallbackHandler callbackHandler,
<span xmlns="" class="line">​</span>                           Map sharedState,
<span xmlns="" class="line">​</span>                           Map options)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// ...</span>
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Looks for javax.security.auth.login.name and</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  javax.security.auth.login.password values in the sharedState</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  map if the useFirstPass option was true and returns true if</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  they exist. If they do not or are null this method returns</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  false.  </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Note that subclasses that override the login method</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  must set the loginOk var to true if the login succeeds in</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  order for the commit phase to populate the Subject. This</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  implementation sets loginOk to true if the login() method</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  returns true, otherwise, it sets loginOk to false.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">login</span>() 
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> LoginException
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// ...</span>
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Overridden by subclasses to return the Principal that</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  corresponds to the user primary identity.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">protected</span> Principal <span xmlns="" class="perl_Function">getIdentity</span>();
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Overridden by subclasses to return the Groups that correspond</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  to the role sets assigned to the user. Subclasses should</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  create at least a Group named "Roles" that contains the roles</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  assigned to the user.  A second common group is</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  "CallerPrincipal," which provides the application identity of</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  the user rather than the security domain identity.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">Group[] containing the sets of roles</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">protected</span> Group[] <span xmlns="" class="perl_Function">getRoleSets</span>() <span xmlns="" class="perl_Keyword">throws</span> LoginException;
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">UsernamePasswordLoginModule</div>
			The second abstract base login module suitable for custom login modules is the <code class="literal">org.jboss.security.auth.spi.UsernamePasswordLoginModule</code>.
		</div><div class="para">
		This login module further simplifies custom login module implementation by enforcing a string-based user name as the user identity and a <code class="literal">char[]</code> password as the authentication credentials. It also supports the mapping of anonymous users (indicated by a null user name and password) to a principal with no roles. The key details of the class are highlighted in the following class fragment. The JavaDoc comments detail the responsibilities of subclasses.
	</div><div class="example"><a id="exam-UsernamePasswordLoginModule_Class_Fragment">
      ⁠</a><p class="title"><strong>Example 12.16. UsernamePasswordLoginModule Class Fragment</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span>package org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">auth</span>.<span xmlns="" class="perl_Function">spi</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  An abstract subclass of AbstractServerLoginModule that imposes a</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  an identity == String username, credentials == String password</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  view on the login process. Subclasses override the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  getUsersPassword() and getUsersRoles() methods to return the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  expected password and roles for the user.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> */</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">class</span> UsernamePasswordLoginModule
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> AbstractServerLoginModule
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The login identity */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> Principal identity;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The proof of login identity */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> <span xmlns="" class="perl_DataType">char</span>[] credential;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The principal to use when a null username and password are seen */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> Principal unauthenticatedIdentity;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * The message digest algorithm used to hash passwords. If null then</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * plain passwords will be used. */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String hashAlgorithm = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  The name of the charset/encoding to use when converting the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * password String to a byte array. Default is the platform's</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * default encoding.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">private</span> String hashCharset = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The string encoding format to use. Defaults to base64. */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String hashEncoding = <span xmlns="" class="perl_Keyword">null</span>;
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">// ...</span>
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Override the superclass method to look for an</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  unauthenticatedIdentity property. This method first invokes</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  the super version.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  </span><span xmlns="" class="perl_Keyword">@param options,</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  @option unauthenticatedIdentity: the name of the principal to</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  assign and authenticate when a null username and password are</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  seen.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> initialize(Subject subject,
<span xmlns="" class="line">​</span>                           CallbackHandler callbackHandler,
<span xmlns="" class="line">​</span>                           Map sharedState,
<span xmlns="" class="line">​</span>                           Map options)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">initialize</span>(subject, callbackHandler, sharedState,
<span xmlns="" class="line">​</span>                         options);
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Comment">// Check for unauthenticatedIdentity option.</span>
<span xmlns="" class="line">​</span>        Object option = options.<span xmlns="" class="perl_Function">get</span>(<span xmlns="" class="perl_String">"unauthenticatedIdentity"</span>);
<span xmlns="" class="line">​</span>        String name = (String) option;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> (name != <span xmlns="" class="perl_Keyword">null</span>) {
<span xmlns="" class="line">​</span>            unauthenticatedIdentity = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">SimplePrincipal</span>(name);
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">// ...</span>
<span xmlns="" class="line">​</span>                
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  A hook that allows subclasses to change the validation of the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  input password against the expected password. This version</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  checks that neither inputPassword or expectedPassword are null</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  and that inputPassword.equals(expectedPassword) is true;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">true if the inputPassword is valid, false otherwise.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> <span xmlns="" class="perl_DataType">boolean</span> <span xmlns="" class="perl_Function">validatePassword</span>(String inputPassword,
<span xmlns="" class="line">​</span>                                       String expectedPassword)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">if</span> (inputPassword == <span xmlns="" class="perl_Keyword">null</span> || expectedPassword == <span xmlns="" class="perl_Keyword">null</span>) {
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">return</span> <span xmlns="" class="perl_Keyword">false</span>;
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">return</span> inputPassword.<span xmlns="" class="perl_Function">equals</span>(expectedPassword);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Get the expected password for the current username available</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * via the getUsername() method. This is called from within the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * login() method after the CallbackHandler has returned the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * username and candidate password.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * </span><span xmlns="" class="perl_Keyword">@return </span><span xmlns="" class="perl_Comment">the valid password String</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">abstract</span> <span xmlns="" class="perl_Keyword">protected</span> String <span xmlns="" class="perl_Function">getUsersPassword</span>()
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> LoginException;
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Subclassing Login Modules</div>
			The choice of sub-classing the <code class="literal">AbstractServerLoginModule</code> versus <code class="literal">UsernamePasswordLoginModule</code> is based on whether a string-based user name and credentials are usable for the authentication technology you are writing the login module for. If the string-based semantic is valid, then subclass <code class="literal">UsernamePasswordLoginModule</code>, otherwise subclass <code class="literal">AbstractServerLoginModule</code>.
		</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Subclassing Steps</div>
			The steps your custom login module must execute depend on which base login module class you choose. When writing a custom login module that integrates with your security infrastructure, you should start by sub-classing <code class="literal">AbstractServerLoginModule</code> or <code class="literal">UsernamePasswordLoginModule</code> to ensure that your login module provides the authenticated <code class="literal">Principal</code> information in the form expected by the JBossSX security manager.
		</div><div class="para">
		When sub-classing the <code class="literal">AbstractServerLoginModule</code>, you must override the following:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<code class="literal">void initialize(Subject, CallbackHandler, Map, Map)</code>: if you have custom options to parse.
			</div></li><li class="listitem"><div class="para">
				<code class="literal">boolean login()</code>: to perform the authentication activity. Be sure to set the <code class="literal">loginOk</code> instance variable to true if log in succeeds, false if it fails.
			</div></li><li class="listitem"><div class="para">
				<code class="literal">Principal getIdentity()</code>: to return the <code class="literal">Principal</code> object for the user authenticated by the <code class="literal">log()</code> step.
			</div></li><li class="listitem"><div class="para">
				<code class="literal">Group[] getRoleSets()</code>: to return at least one <code class="literal">Group</code> named <code class="literal">Roles</code> that contains the roles assigned to the <code class="literal">Principal</code> authenticated during <code class="literal">login()</code>. A second common <code class="literal">Group</code> is named <code class="literal">CallerPrincipal</code> and provides the user's application identity rather than the security domain identity.
			</div></li></ul></div><div class="para">
		When sub-classing the <code class="literal">UsernamePasswordLoginModule</code>, you must override the following:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				<code class="literal">void initialize(Subject, CallbackHandler, Map, Map)</code>: if you have custom options to parse.
			</div></li><li class="listitem"><div class="para">
				<code class="literal">Group[] getRoleSets()</code>: to return at least one <code class="literal">Group</code> named <code class="literal">Roles</code> that contains the roles assigned to the <code class="literal">Principal</code> authenticated during <code class="literal">login()</code>. A second common <code class="literal">Group</code> is named <code class="literal">CallerPrincipal</code> and provides the user's application identity rather than the security domain identity.
			</div></li><li class="listitem"><div class="para">
				<code class="literal">String getUsersPassword()</code>: to return the expected password for the current user name available via the <code class="literal">getUsername()</code> method. The <code class="literal">getUsersPassword()</code> method is called from within <code class="literal">login()</code> after the <code class="literal">callbackhandler</code> returns the user name and candidate password.
			</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-Custom_LoginModule_Example">
      ⁠</a>12.2.2. Custom LoginModule Example</h2></div></div></div><div class="para">
		The following information will help you to create a custom Login Module example that extends the <code class="literal">UsernamePasswordLoginModule</code> and obtains a user's password and role names from a JNDI lookup.
	</div><div class="para">
		At the end of this section you will have created a custom JNDI context login module that will return a user's password if you perform a lookup on the context using a name of the form <code class="literal">password/&lt;username&gt;</code> (where <code class="literal">&lt;username&gt;</code> is the current user being authenticated). Similarly, a lookup of the form <code class="literal">roles/&lt;username&gt;</code> returns the requested user's roles.
	</div><div class="para">
		<a class="xref" href="ch12.html#A_Custom_LoginModule_Example-_A_JndiUserAndPass_custom_login_module">Example 12.17, “JndiUserAndPass Custom Login Module”</a> shows the source code for the <code class="literal">JndiUserAndPass</code> custom login module.
	</div><div class="para">
		Note that because this extends the JBoss <code class="literal">UsernamePasswordLoginModule</code>, all <code class="literal">JndiUserAndPass</code> does is obtain the user's password and roles from the JNDI store. The <code class="literal">JndiUserAndPass</code> does not interact with the JAAS <code class="literal">LoginModule</code> operations.
	</div><div class="example"><a id="A_Custom_LoginModule_Example-_A_JndiUserAndPass_custom_login_module">
      ⁠</a><p class="title"><strong>Example 12.17. JndiUserAndPass Custom Login Module</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span>package org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">book</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">ex2</span>;
<span xmlns="" class="line">​</span>                    
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.security.acl.Group;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.util.Map;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.naming.InitialContext;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.naming.NamingException;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.security.auth.Subject;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.security.auth.callback.CallbackHandler;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import javax.security.auth.login.LoginException;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.security.SimpleGroup;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.security.SimplePrincipal;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import org.jboss.security.auth.spi.UsernamePasswordLoginModule;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">/** </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  An example custom login module that obtains passwords and roles</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  for a user from a JNDI lookup.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *     </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  </span><span xmlns="" class="perl_Keyword">@author </span><span xmlns="" class="perl_Comment">Scott.Stark@jboss.org</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment"> *  </span><span xmlns="" class="perl_Keyword">@version </span><span xmlns="" class="perl_Comment">$Revision: 1.4 $</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">*/</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">class</span> JndiUserAndPass 
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">extends</span> UsernamePasswordLoginModule
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The JNDI name to the context that handles the password/username lookup */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String userPathPrefix;
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** The JNDI name to the context that handles the roles/ username lookup */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">private</span> String rolesPathPrefix;
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Override to obtain the userPathPrefix and rolesPathPrefix options.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> initialize(Subject subject, CallbackHandler callbackHandler,
<span xmlns="" class="line">​</span>                           Map sharedState, Map options)
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">initialize</span>(subject, callbackHandler, sharedState, options);
<span xmlns="" class="line">​</span>        userPathPrefix = (String) options.<span xmlns="" class="perl_Function">get</span>(<span xmlns="" class="perl_String">"userPathPrefix"</span>);
<span xmlns="" class="line">​</span>        rolesPathPrefix = (String) options.<span xmlns="" class="perl_Function">get</span>(<span xmlns="" class="perl_String">"rolesPathPrefix"</span>);
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/**</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     *  Get the roles the current user belongs to by querying the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * rolesPathPrefix + '/' + super.getUsername() JNDI location.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> Group[] <span xmlns="" class="perl_Function">getRoleSets</span>() <span xmlns="" class="perl_Keyword">throws</span> LoginException
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>            InitialContext ctx = <span xmlns="" class="perl_Keyword">new</span> InitialContext();
<span xmlns="" class="line">​</span>            String rolesPath = rolesPathPrefix + <span xmlns="" class="perl_Char">'/'</span> + <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getUsername</span>();
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>            String[] roles = (String[]) ctx.<span xmlns="" class="perl_Function">lookup</span>(rolesPath);
<span xmlns="" class="line">​</span>            Group[] groups = {<span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">SimpleGroup</span>(<span xmlns="" class="perl_String">"Roles"</span>)};
<span xmlns="" class="line">​</span>            log.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Getting roles for user="</span>+<span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getUsername</span>());
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">for</span>(<span xmlns="" class="perl_DataType">int</span> r = <span xmlns="" class="perl_Float">0</span>; r &lt; roles.<span xmlns="" class="perl_Function">length</span>; r ++) {
<span xmlns="" class="line">​</span>                SimplePrincipal role = <span xmlns="" class="perl_Keyword">new</span> <span xmlns="" class="perl_Function">SimplePrincipal</span>(roles[r]);
<span xmlns="" class="line">​</span>                log.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Found role="</span>+roles[r]);
<span xmlns="" class="line">​</span>                groups[<span xmlns="" class="perl_Float">0</span>].<span xmlns="" class="perl_Function">addMember</span>(role);
<span xmlns="" class="line">​</span>            }
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">return</span> groups;
<span xmlns="" class="line">​</span>        } <span xmlns="" class="perl_Keyword">catch</span>(NamingException e) {
<span xmlns="" class="line">​</span>            log.<span xmlns="" class="perl_Function">error</span>(<span xmlns="" class="perl_String">"Failed to obtain groups for</span>
<span xmlns="" class="line">​</span>                        user=<span xmlns="" class="perl_String">"+super.getUsername(), e);</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> LoginException(e.<span xmlns="" class="perl_Function">toString</span>(<span xmlns="" class="perl_Keyword">true</span>));
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>                    
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">/** </span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * Get the password of the current user by querying the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     * userPathPrefix + '/' + super.getUsername() JNDI location.</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">     */</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">protected</span> String <span xmlns="" class="perl_Function">getUsersPassword</span>() 
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> LoginException
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">try</span> {
<span xmlns="" class="line">​</span>            InitialContext ctx = <span xmlns="" class="perl_Keyword">new</span> InitialContext();
<span xmlns="" class="line">​</span>            String userPath = userPathPrefix + <span xmlns="" class="perl_Char">'/'</span> + <span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getUsername</span>();
<span xmlns="" class="line">​</span>            log.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Getting password for user="</span>+<span xmlns="" class="perl_Keyword">super</span>.<span xmlns="" class="perl_Function">getUsername</span>());
<span xmlns="" class="line">​</span>            String passwd = (String) ctx.<span xmlns="" class="perl_Function">lookup</span>(userPath);
<span xmlns="" class="line">​</span>            log.<span xmlns="" class="perl_Function">info</span>(<span xmlns="" class="perl_String">"Found password="</span>+passwd);
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">return</span> passwd;
<span xmlns="" class="line">​</span>        } <span xmlns="" class="perl_Keyword">catch</span>(NamingException e) {
<span xmlns="" class="line">​</span>            log.<span xmlns="" class="perl_Function">error</span>(<span xmlns="" class="perl_String">"Failed to obtain password for</span>
<span xmlns="" class="line">​</span>                        user=<span xmlns="" class="perl_String">"+super.getUsername(), e);</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">throw</span> <span xmlns="" class="perl_Keyword">new</span> LoginException(e.<span xmlns="" class="perl_Function">toString</span>(<span xmlns="" class="perl_Keyword">true</span>));
<span xmlns="" class="line">​</span>        }
<span xmlns="" class="line">​</span>    }   
<span xmlns="" class="line">​</span>}
</pre></div></div><div class="para">
		The details of the JNDI store are found in the <code class="literal">org.jboss.book.security.ex2.service.JndiStore</code> MBean. This service binds an <code class="literal">ObjectFactory</code> that returns a <code class="literal">javax.naming.Context</code> proxy into JNDI. The proxy handles lookup operations done against it by checking the prefix of the lookup name against <code class="literal">password</code> and <code class="literal">roles</code>.
	</div><div class="para">
		When the name begins with <code class="literal">password</code>, a user's password is being requested. When the name begins with <code class="literal">roles</code> the user's roles are being requested. The example implementation always returns a password of <code class="literal">theduke</code> and an array of roles names equal to <code class="literal">{"TheDuke", "Echo"}</code> regardless of what the user name is. You can experiment with other implementations as you wish.
	</div><div class="para">
		The example code includes a simple session bean for testing the custom login module. To build, deploy and run the example, execute the following command in the examples directory.
	</div><pre class="screen">[examples]$ ant -Dchap=security -Dex=2 run-example
...
run-example2:
     [echo] Waiting for 5 seconds for deploy...
     [java] [INFO,ExClient] Login with user name=jduke, password=theduke
     [java] [INFO,ExClient] Looking up EchoBean2
     [java] [INFO,ExClient] Created Echo
     [java] [INFO,ExClient] Echo.echo('Hello') = Hello
</pre><div class="para">
		The choice of using the <code class="literal">JndiUserAndPass</code> custom login module for the server side authentication of the user is determined by the login configuration for the example security domain. The EJB JAR <code class="literal">META-INF/jboss.xml</code> descriptor sets the security domain.
	</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;?xml</span> version="1.0"<span xmlns="" class="perl_Keyword">?&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;jboss&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;security-domain&gt;</span>security-ex2<span xmlns="" class="perl_Keyword">&lt;/security-domain&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/jboss&gt;</span>
</pre><div class="para">
		The SAR <code class="literal">META-INF/login-config.xml</code> descriptor defines the login module configuration.
	</div><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;application-policy</span><span xmlns="" class="perl_Others"> name</span> <span xmlns="" class="perl_Others">=</span> <span xmlns="" class="perl_String">"security-ex2"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;authentication&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.book.security.ex2.JndiUserAndPass"</span><span xmlns="" class="perl_Others"> flag=</span><span xmlns="" class="perl_String">"required"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"userPathPrefix"</span><span xmlns="" class="perl_Keyword">&gt;</span>/security/store/password<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name</span> <span xmlns="" class="perl_Others">=</span> <span xmlns="" class="perl_String">"rolesPathPrefix"</span><span xmlns="" class="perl_Keyword">&gt;</span>/security/store/roles<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/authentication&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/application-policy&gt;</span>
</pre></div></div></div></body></html>