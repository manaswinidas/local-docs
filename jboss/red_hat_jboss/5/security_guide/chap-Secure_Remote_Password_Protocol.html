<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 13. Secure Remote Password Protocol</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="chap-Secure_Remote_Password_Protocol">
      ⁠</a>Chapter 13. Secure Remote Password Protocol</h1></div></div></div><div class="para">
		The Secure Remote Password (SRP) protocol is an implementation of a public key exchange handshake described in the Internet Standards Working Group Request For Comments 2945 (RFC2945). The RFC2945 abstract states:
	</div><div class="blockquote"><blockquote class="blockquote"><div class="para">
			This document describes a cryptographically strong network authentication mechanism known as the Secure Remote Password (SRP) protocol. This mechanism is suitable for negotiating secure connections using a user-supplied password, while eliminating the security problems traditionally associated with reusable passwords. This system also performs a secure key exchange in the process of authentication, allowing security layers (privacy and/or integrity protection) to be enabled during the session. Trusted key servers and certificate infrastructures are not required, and clients are not required to store or manage any long-term keys. SRP offers both security and deployment advantages over existing challenge-response techniques, making it an ideal drop-in replacement where secure password authentication is needed.
		</div></blockquote></div><div class="para">
		The complete RFC2945 specification can be obtained from <a href="http://www.rfc-editor.org/rfc.html">http://www.rfc-editor.org/rfc.html</a>. Additional information on the SRP algorithm and its history can be found at <a href="http://www-cs-students.stanford.edu/~tjw/srp/">http://www-cs-students.stanford.edu/~tjw/srp/</a> .
	</div><div class="para">
		Algorithms like <em class="firstterm"> Diffie-Hellman </em> and <em class="firstterm"> RSA </em> are known as public key exchange algorithms. The concept of public key algorithms is that you have two keys, one public that is available to everyone, and one that is private and known only to you. When someone wants to send encrypted information to you, they encrypt the information using your public key. Only you are able to decrypt the information using your private key. Contrast this with the more traditional shared password based encryption schemes that require the sender and receiver to know the shared password. Public key algorithms eliminate the need to share passwords.
	</div><div class="para">
		The JBossSX framework includes an implementation of SRP that consists of the following elements:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				An implementation of the SRP handshake protocol that is independent of any particular client/server protocol
			</div></li><li class="listitem"><div class="para">
				An RMI implementation of the handshake protocol as the default client/server SRP implementation
			</div></li><li class="listitem"><div class="para">
				A client side JAAS <code class="literal">LoginModule</code> implementation that uses the RMI implementation for use in authenticating clients in a secure fashion
			</div></li><li class="listitem"><div class="para">
				A JMX MBean for managing the RMI server implementation. The MBean allows the RMI server implementation to be plugged into a JMX framework and externalizes the configuration of the verification information store. It also establishes an authentication cache that is bound into the server JNDI namespace.
			</div></li><li class="listitem"><div class="para">
				A server side JAAS <code class="literal">LoginModule</code> implementation that uses the authentication cache managed by the SRP JMX MBean.
			</div></li></ul></div><div class="para">
		<a class="xref" href="chap-Secure_Remote_Password_Protocol.html#The_Secure_Remote_Password_SRP_Protocol-The_JBossSX_components_of_the_SRP_client_server_framework.">Figure 13.1, “The JBossSX components of the SRP client-server framework.”</a> describes the key components involved in the JBossSX implementation of the SRP client/server framework.
	</div><div class="figure"><a id="The_Secure_Remote_Password_SRP_Protocol-The_JBossSX_components_of_the_SRP_client_server_framework.">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/j2ee_chap8-13.png" align="middle" alt="The JBossSX components of the SRP client-server framework." style="text-align: middle"/></div></div><p class="title"><strong>Figure 13.1. The JBossSX components of the SRP client-server framework.</strong></p></div><div class="para">
		On the client side, SRP shows up as a custom JAAS <code class="literal">LoginModule</code> implementation that communicates with the authentication server through an <code class="literal">org.jboss.security.srp.SRPServerInterface</code> proxy. A client enables authentication using SRP by creating a login configuration entry that includes the <code class="literal">org.jboss.security.srp.jaas.SRPLoginModule</code> . This module supports the following configuration options:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">srpServerJndiName</span></dt><dd><div class="para">
					JNDI name of the <code class="literal">SRPServerInterface</code> object used to communicate with the SRP authentication server. If both <code class="literal">srpServerJndiName</code> and <code class="literal">srpServerRmiUrl</code> options are specified, <code class="literal">srpServerJndiName</code> takes priority over <code class="literal">srpServerRmiUrl</code> .
				</div></dd><dt><span class="term">srpServerRmiUrl</span></dt><dd><div class="para">
					RMI protocol URL string for the location of the <code class="literal">SRPServerInterface</code> proxy used to communicate with the SRP authentication server.
				</div></dd><dt><span class="term">externalRandomA</span></dt><dd><div class="para">
					Flag that specifies whether the random component of the client public key "A" should come from the user callback. This can be used to input a strong cryptographic random number coming from a hardware token. If set to <code class="literal">true</code> , the feature is activated.
				</div></dd><dt><span class="term">hasAuxChallenge</span></dt><dd><div class="para">
					Flag that specifies whether a string will be sent to the server as an additional challenge for the server to validate. If the client session supports an encryption cipher then a temporary cipher will be created using the session private key and the challenge object sent as a <code class="literal">javax.crypto.SealedObject</code> . If set to <code class="literal">true</code> , the feature is activated.
				</div></dd><dt><span class="term">multipleSessions</span></dt><dd><div class="para">
					Flag that specifies whether a given client may have multiple SRP log in sessions active. If set to <code class="literal">true</code> , the feature is activated.
				</div></dd></dl></div><div class="para">
		Any other passed options that do not match one of the previously named options are treated as a JNDI property to use for the environment passed to the <code class="literal">InitialContext</code> constructor. This is useful if the SRP server interface is not available from the default <code class="literal">InitialContext</code> .
	</div><div class="para">
		The <code class="literal">SRPLoginModule</code> and the standard <code class="literal">ClientLoginModule</code> must be configured to allow SRP authentication credentials to be used for access validation to security Java EE components. An example login configuration is described in <a class="xref" href="chap-Secure_Remote_Password_Protocol.html#exam-Login_Configuration_Entry">Example 13.1, “Login Configuration Entry”</a> .
	</div><div class="example"><a id="exam-Login_Configuration_Entry">
      ⁠</a><p class="title"><strong>Example 13.1. Login Configuration Entry</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span>srp {
<span xmlns="" class="line">​</span>    org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">srp</span>.<span xmlns="" class="perl_Function">jaas</span>.<span xmlns="" class="perl_Function">SRPLoginModule</span> required
<span xmlns="" class="line">​</span>    srpServerJndiName=<span xmlns="" class="perl_String">"SRPServerInterface"</span>
<span xmlns="" class="line">​</span>    ;
<span xmlns="" class="line">​</span>            
<span xmlns="" class="line">​</span>    org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">ClientLoginModule</span> required
<span xmlns="" class="line">​</span>    password-stacking=<span xmlns="" class="perl_String">"useFirstPass"</span>
<span xmlns="" class="line">​</span>    ;
<span xmlns="" class="line">​</span>};
</pre></div></div><div class="para">
		On the server side, there are two MBeans that manage the objects that collectively make up the SRP server. The primary service is the <code class="literal">org.jboss.security.srp.SRPService</code> MBean. The other MBean is <code class="classname">org.jboss.security.srp.SRPVerifierStoreService</code> .
	</div><div class="para">
		<code class="literal">org.jboss.security.srp.SRPService</code> is responsible for exposing an RMI accessible version of the SRPServerInterface as well as updating the SRP authentication session cache.
	</div><div class="para">
		The configurable SRPService MBean attributes include the following:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">JndiName</span></dt><dd><div class="para">
					Specifies the name from which the SRPServerInterface proxy should be available. This is the location where the <code class="literal">SRPService</code> binds the serializable dynamic proxy to the <code class="literal">SRPServerInterface</code> . The default value is <code class="literal">srp/SRPServerInterface</code> .
				</div></dd><dt><span class="term">VerifierSourceJndiName</span></dt><dd><div class="para">
					Specifies the name of the <code class="literal">SRPVerifierSource</code> implementation the <code class="literal">SRPService</code> must use. The source JNDI name defaults to <code class="literal">srp/DefaultVerifierSource</code> .
				</div></dd><dt><span class="term">AuthenticationCacheJndiName</span></dt><dd><div class="para">
					Specifies the name under which the <code class="literal">org.jboss.util.CachePolicy</code> authentication implementation used for caching authentication information is bound. The SRP session cache is made available for use through this binding. The authentication JNDI cache defaults to <code class="literal">srp/AuthenticationCache</code> .
				</div></dd><dt><span class="term">ServerPort</span></dt><dd><div class="para">
					RMI port for the <code class="literal">SRPRemoteServerInterface</code> . The default value is 10099.
				</div></dd><dt><span class="term">ClientSocketFactory</span></dt><dd><div class="para">
					Optional custom <code class="literal">java.rmi.server.RMIClientSocketFactory</code> implementation class name used during the export of the <code class="literal">SRPServerInterface</code> . The default value is <code class="literal">RMIClientSocketFactory</code> .
				</div></dd><dt><span class="term">ServerSocketFactory</span></dt><dd><div class="para">
					Optional custom <code class="literal">java.rmi.server.RMIServerSocketFactory</code> implementation class name used during the export of the <code class="literal">SRPServerInterface</code> . The default value is <code class="literal">RMIServerSocketFactory</code> .
				</div></dd><dt><span class="term">AuthenticationCacheTimeout</span></dt><dd><div class="para">
					Cache policy timeout (in seconds). The default value is 1800 (30 minutes).
				</div></dd><dt><span class="term">AuthenticationCacheResolution</span></dt><dd><div class="para">
					Specifies the timed cache policy resolution (in seconds). This controls the interval between checks for timeouts. The default value is 60 (1 minute).
				</div></dd><dt><span class="term">RequireAuxChallenge</span></dt><dd><div class="para">
					Set if the client must supply an auxiliary challenge as part of the verify phase. This gives control over whether the <code class="literal">SRPLoginModule</code> configuration used by the client must have the <code class="literal">useAuxChallenge</code> option enabled.
				</div></dd><dt><span class="term">OverwriteSessions</span></dt><dd><div class="para">
					Specifies whether a successful user authentication for an existing session should overwrite the current session. This controls the behavior of the server SRP session cache when clients have not enabled the multiple session per user mode. If set to <code class="literal">false</code> , the second user authentication attempt will succeed, however the resulting SRP session will not overwrite the previous SRP session state. The default value is <code class="literal">false</code> .
				</div></dd><dt><span class="term">VerifierStoreJndiName</span></dt><dd><div class="para">
					Specifies the location of the SRP password information store implementation that must be provided and made available through JNDI.
				</div></dd></dl></div><div class="para">
		<code class="classname">org.jboss.security.srp.SRPVerifierStoreService</code> is an example MBean service that binds an implementation of the <code class="literal">SRPVerifierStore</code> interface that uses a file of serialized objects as the persistent store. Although not realistic for a production environment, it does allow for testing of the SRP protocol and provides an example of the requirements for an <code class="literal">SRPVerifierStore</code> service.
	</div><div class="para">
		The configurable <code class="literal">SRPVerifierStoreService</code> MBean attributes include the following:
	</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">JndiName</span></dt><dd><div class="para">
					JNDI name from which the <code class="literal">SRPVerifierStore</code> implementation should be available. If not specified it defaults to <code class="literal">srp/DefaultVerifierSource</code> .
				</div></dd><dt><span class="term">StoreFile</span></dt><dd><div class="para">
					Location of the user password verifier serialized object store file. This can be either a URL or a resource name to be found in the classpath. If not specified it defaults to <code class="literal">SRPVerifierStore.ser</code> .
				</div></dd></dl></div><div class="para">
		The <code class="literal">SRPVerifierStoreService</code> MBean also supports <em class="parameter"><code>addUser</code></em> and <em class="parameter"><code>delUser</code></em> operations for addition and deletion of users. The signatures are:
	</div><pre class="programlisting JAVA"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">addUser</span>(String username, String password) <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">delUser</span>(String username) <span xmlns="" class="perl_Keyword">throws</span> IOException;
</pre><div class="para">
		An example configuration of these services is presented in <a class="xref" href="chap-Secure_Remote_Password_Protocol.html#Providing_Password_Information_for_SRP-The_SRPVerifierStore_Interface">Example 13.2, “The SRPVerifierStore interface”</a> .
	</div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Understanding_The_Algorithm">
      ⁠</a>13.1. Understanding the Algorithm</h1></div></div></div><div class="para">
		The appeal of the SRP algorithm is that is allows for mutual authentication of client and server using simple text passwords without a secure communication channel.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			Additional information on the SRP algorithm and its history can be found at <a href="http://srp.stanford.edu/">http://srp.stanford.edu/</a>.
		</div></div></div><div class="para">
		There are six steps that are performed to complete authentication:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
				The client side <code class="literal">SRPLoginModule</code> retrieves from the naming service the SRPServerInterface instance for the remote authentication server.
			</div></li><li class="listitem"><div class="para">
				The client side <code class="literal">SRPLoginModule</code> next requests the SRP parameters associated with the user name attempting the log in. There are a number of parameters involved in the SRP algorithm that must be chosen when the user password is first transformed into the verifier form used by the SRP algorithm. Rather than hard-coding the parameters (which could be done with minimal security risk), the JBossSX implementation allows a user to retrieve this information as part of the exchange protocol. The <code class="literal">getSRPParameters(username)</code> call retrieves the SRP parameters for the given user name.
			</div></li><li class="listitem"><div class="para">
				The client side <code class="literal">SRPLoginModule</code> begins an SRP session by creating an <code class="literal">SRPClientSession</code> object using the login user name, clear-text password, and SRP parameters obtained from step 2. The client then creates a random number A that will be used to build the private SRP session key. The client then initializes the server side of the SRP session by invoking the <code class="literal">SRPServerInterface.init</code> method and passes in the user name and client generated random number <code class="literal">A</code>. The server returns its own random number <code class="literal">B</code>. This step corresponds to the exchange of public keys.
			</div></li><li class="listitem"><div class="para">
				The client side <code class="literal">SRPLoginModule</code> obtains the private SRP session key that has been generated as a result of the previous messages exchanges. This is saved as a private credential in the login <code class="literal">Subject</code>. The server challenge response <code class="literal">M2</code> from step 4 is verified by invoking the <code class="literal">SRPClientSession.verify</code> method. If this succeeds, mutual authentication of the client to server, and server to client have been completed. The client side <code class="literal">SRPLoginModule</code> next creates a challenge <code class="literal">M1</code> to the server by invoking <code class="literal">SRPClientSession.response</code> method passing the server random number <code class="literal">B</code> as an argument. This challenge is sent to the server via the <code class="literal">SRPServerInterface.verify</code> method and server's response is saved as <code class="literal">M2</code>. This step corresponds to an exchange of challenges. At this point the server has verified that the user is who they say they are.
			</div></li><li class="listitem"><div class="para">
				The client side <code class="literal">SRPLoginModule</code> saves the login user name and <code class="literal">M1</code> challenge into the <code class="literal">LoginModule</code> sharedState map. This is used as the Principal name and credentials by the standard JBoss <code class="literal">ClientLoginModule</code>. The <code class="literal">M1</code> challenge is used in place of the password as proof of identity on any method invocations on Java EE components. The <code class="literal">M1</code> challenge is a cryptographically strong hash associated with the SRP session. Its interception via a third partly cannot be used to obtain the user's password.
			</div></li><li class="listitem"><div class="para">
				At the end of this authentication protocol, the SRPServerSession has been placed into the SRPService authentication cache for subsequent use by the <code class="literal">SRPCacheLoginModule</code>.
			</div></li></ol></div><div class="para">
		Although SRP has many interesting properties, it is still an evolving component in the JBossSX framework and has some limitations of which you should be aware. Issues of note include the following:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				Where authentication is performed, the way in which JBoss detaches the method transport protocol from the component container could allow a user to snoop the SRP <code class="literal">M1</code> challenge and effectively use the challenge to make requests as the associated user name. Custom interceptors can be used to prevent the issue, by encrypting the challenge using the SRP session key.
			</div></li><li class="listitem"><div class="para">
				The SRPService maintains a cache of SRP sessions that time out after a configurable period. Once they time out, any subsequent Java EE component access will fail because there is currently no mechanism for transparently renegotiating the SRP authentication credentials. You must either set the authentication cache timeout quite high, or handle re-authentication in your code on failure.
			</div><div class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					The SRPService supports timeout durations up to 2,147,483,647 seconds, or approximately 68 years.
				</div></div></div></li><li class="listitem"><div class="para">
				There can only be one SRP session for a given user name by default. The session is classed as stateful, because the negotiated SRP session produces a private session key that can be used for encryption and decryption between the client and server. JBoss supports multiple SRP sessions per user, however it is not possible to encrypt data with one session key, and decrypt it with another.
			</div></li></ul></div><div class="para">
		To use end-to-end SRP authentication for Java EE component calls, you must configure the security domain under which the components are secured to use the <code class="classname">org.jboss.security.srp.jaas.SRPCacheLoginModule</code>. The <code class="literal">SRPCacheLoginModule</code> has a single configuration option named <code class="literal">cacheJndiName</code> that sets the JNDI location of the SRP authentication <code class="literal">CachePolicy</code> instance. This must correspond to the <code class="literal">AuthenticationCacheJndiName</code> attribute value of the <code class="literal">SRPService</code> MBean.
	</div><div class="para">
		The <code class="literal">SRPCacheLoginModule</code> authenticates user credentials by obtaining the client challenge from the <code class="literal">SRPServerSession</code> object in the authentication cache and comparing this to the challenge passed as the user credentials. <a class="xref" href="chap-Secure_Remote_Password_Protocol.html#fig-SRPCacheLoginModule_with_SRP_Session_Cache">Figure 13.2, “SRPCacheLoginModule with SRP Session Cache”</a> illustrates the operation of the SRPCacheLoginModule.login method implementation.
	</div><div class="figure"><a id="fig-SRPCacheLoginModule_with_SRP_Session_Cache">
      ⁠</a><div class="figure-contents"><div class="mediaobject" style="text-align: center"><img src="images/j2ee_chap8-14.png" align="middle" alt="SRPCacheLoginModule with SRP Session Cache" style="text-align: middle"/></div></div><p class="title"><strong>Figure 13.2. SRPCacheLoginModule with SRP Session Cache</strong></p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Configure_Secure_Remote_Password_Information">
      ⁠</a>13.2. Configure Secure Remote Password Information</h1></div></div></div><div class="para">
		You must create a MBean service that provides an implementation of the <code class="literal">SRPVerifierStore</code> interface that integrates with your existing security information stores. The <code class="literal">SRPVerifierStore</code> interface is shown in <a class="xref" href="chap-Secure_Remote_Password_Protocol.html#Providing_Password_Information_for_SRP-The_SRPVerifierStore_Interface">Example 13.2, “The SRPVerifierStore interface”</a>.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
			The default implementation of the <code class="literal">SRPVerifierStore</code> interface is not recommended for a production security environment because it requires all password hash information to be available as a file of serialized objects.
		</div></div></div><div class="example"><a id="Providing_Password_Information_for_SRP-The_SRPVerifierStore_Interface">
      ⁠</a><p class="title"><strong>Example 13.2. The SRPVerifierStore interface</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span>package org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">srp</span>;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.io.IOException;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.io.Serializable;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">import java.security.KeyException;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_Keyword">interface</span> SRPVerifierStore
<span xmlns="" class="line">​</span>{
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">static</span> <span xmlns="" class="perl_Keyword">class</span> VerifierInfo <span xmlns="" class="perl_Keyword">implements</span> Serializable
<span xmlns="" class="line">​</span>    {
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">public</span> String username;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">byte</span>[] salt;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">byte</span>[] g;
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">byte</span>[] N;
<span xmlns="" class="line">​</span>    }
<span xmlns="" class="line">​</span>    
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> VerifierInfo <span xmlns="" class="perl_Function">getUserVerifier</span>(String username)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> KeyException, IOException;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">setUserVerifier</span>(String username, VerifierInfo info)
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">throws</span> IOException;
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">public</span> <span xmlns="" class="perl_DataType">void</span> <span xmlns="" class="perl_Function">verifyUserChallenge</span>(String username, Object auxChallenge)
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">throws</span> SecurityException;
<span xmlns="" class="line">​</span>}
</pre><div class="para">
			The primary function of a <code class="literal">SRPVerifierStore</code> implementation is to provide access to the <code class="literal">SRPVerifierStore.VerifierInfo</code> object for a given user name. The <code class="literal">getUserVerifier(String)</code> method is called by the <code class="literal">SRPService</code> at that start of a user SRP session to obtain the parameters needed by the SRP algorithm. The elements of the <code class="literal">VerifierInfo</code> objects are:
		</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="markup">username</span></span></dt><dd><div class="para">
						The user's name or id used to log in.
					</div></dd><dt><span class="term"><span class="markup">verifier</span></span></dt><dd><div class="para">
						One-way hash of the password or PIN the user enters as proof of identity. The <code class="classname">org.jboss.security.Util</code> class has a <code class="methodname"> calculateVerifier </code> method that performs that password hashing algorithm. The output password takes the form <code class="literal">H(salt | H(username | ':' | password))</code>, where <code class="literal">H</code> is the SHA secure hash function as defined by RFC2945. The user name is converted from a string to a <code class="literal">byte[]</code> using UTF-8 encoding.
					</div></dd><dt><span class="term">salt</span></dt><dd><div class="para">
						Random number used to increase the difficulty of a brute force dictionary attack on the verifier password database in the event that the database is compromised. The value should be generated from a cryptographically strong random number algorithm when the user's existing clear-text password is hashed.
					</div></dd><dt><span class="term">g</span></dt><dd><div class="para">
						SRP algorithm primitive generator. This can be a well known fixed parameter rather than a per-user setting. The <code class="classname">org.jboss.security.srp.SRPConf</code> utility class provides several settings for <code class="literal">g</code>, including a suitable default obtained via <code class="literal">SRPConf.getDefaultParams().g()</code>.
					</div></dd><dt><span class="term">N</span></dt><dd><div class="para">
						SRP algorithm safe-prime modulus. This can be a well known fixed parameter rather than a per-user setting. The <code class="classname">org.jboss.security.srp.SRPConf</code> utility class provides several settings for <code class="literal">N</code> including a good default which can obtained via <code class="literal">SRPConf.getDefaultParams().N()</code>.
					</div></dd></dl></div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="idm139921665688064">
      ⁠</a><p class="title"><strong>Procedure 13.1. Integrate Existing Password Store</strong></p><div class="para">
				Read this procedure to understand the steps involved to integrate your existing password store.
			</div><ol class="1"><li class="step"><p class="title"><strong>Create Hashed Password Information Store</strong></p><div class="para">
					If your passwords are already stored in an irreversible hashed form, then this can only be done on a per-user basis (for example, as part of an upgrade procedure).
				</div><div class="para">
					You can implement <code class="literal">setUserVerifier(String, VerifierInfo)</code> as a <code class="methodname"> noOp </code> method, or a method that throws an exception stating that the store is read-only.
				</div></li><li class="step"><p class="title"><strong>Create SRPVerifierStore Interface</strong></p><div class="para">
					You must create a custom <code class="literal">SRPVerifierStore</code> interface implementation that understands how to obtain the <code class="literal">VerifierInfo</code> from the store you created.
				</div><div class="para">
					The <code class="methodname"> verifyUserChallenge(String, Object) </code> can be used to integrate existing hardware token based schemes like SafeWord or Radius into the SRP algorithm. This interface method is called only when the client <code class="literal">SRPLoginModule</code> configuration specifies the <code class="literal">hasAuxChallenge</code> option.
				</div></li><li class="step"><p class="title"><strong>Create JNDI MBean</strong></p><div class="para">
					You must create a MBean that exposes the <code class="literal">SRPVerifierStore</code> interface available to JNDI, and exposes any configurable parameters required.
				</div><div class="para">
					The default <code class="literal">org.jboss.security.srp.SRPVerifierStoreService</code> will allow you to implement this, however you can also implement the MBean using a Java properties file implementation of <code class="literal">SRPVerifierStore</code> (refer to <a class="xref" href="chap-Secure_Remote_Password_Protocol.html#sect-Secure_Remote_Password_Example">Section 13.3, “Secure Remote Password Example”</a>).
				</div></li></ol></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="sect-Secure_Remote_Password_Example">
      ⁠</a>13.3. Secure Remote Password Example</h1></div></div></div><div class="para">
		The example presented in this section demonstrates client side authentication of the user via SRP as well as subsequent secured access to a simple EJB using the SRP session challenge as the user credential. The test code deploys an EJB JAR that includes a SAR for the configuration of the server side login module configuration and SRP services.
	</div><div class="para">
		The server side login module configuration is dynamically installed using the <code class="literal">SecurityConfig</code> MBean. A custom implementation of the <code class="literal">SRPVerifierStore</code> interface is also used in the example. The interface uses an in-memory store that is seeded from a Java properties file, rather than a serialized object store as used by the <code class="literal">SRPVerifierStoreService</code>.
	</div><div class="para">
		This custom service is <code class="literal">org.jboss.book.security.ex3.service.PropertiesVerifierStore</code>. The following shows the contents of the JAR that contains the example EJB and SRP services.
	</div><pre class="screen">[examples]$ jar tf output/security/security-ex3.jar 
META-INF/MANIFEST.MF
META-INF/ejb-jar.xml
META-INF/jboss.xml
org/jboss/book/security/ex3/Echo.class
org/jboss/book/security/ex3/EchoBean.class
org/jboss/book/security/ex3/EchoHome.class
roles.properties
users.properties
security-ex3.sar</pre><div class="para">
		The key SRP related items in this example are the SRP MBean services configuration, and the SRP login module configurations. The <code class="filename">jboss-service.xml</code> descriptor of the <code class="filename">security-ex3.sar</code> is described in <a class="xref" href="chap-Secure_Remote_Password_Protocol.html#An_SRP_example-The_security_ex3.sar_jboss_service.xml_descriptor_for_the_SRP_services">Example 13.3, “The security-ex3.sar jboss-service.xml Descriptor”</a>.
	</div><div class="para">
		The example client side and server side login module configurations are described in <a class="xref" href="chap-Secure_Remote_Password_Protocol.html#An_SRP_example-The_client_side_standard_JAAS_configuration">Example 13.4, “The client side standard JAAS configuration”</a> and <a class="xref" href="chap-Secure_Remote_Password_Protocol.html#An_SRP_example-The_server_side_XMLLoginConfig_configuration">Example 13.5, “The server side XMLLoginConfig configuration”</a> give .
	</div><div class="example"><a id="An_SRP_example-The_security_ex3.sar_jboss_service.xml_descriptor_for_the_SRP_services">
      ⁠</a><p class="title"><strong>Example 13.3. The security-ex3.sar jboss-service.xml Descriptor</strong></p><div class="example-contents"><pre class="programlisting XML"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;server&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- The custom JAAS login configuration that installs</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         a Configuration capable of dynamically updating the</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         config settings --&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.book.security.service.SecurityConfig"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">           name=</span><span xmlns="" class="perl_String">"jboss.docs.security:service=LoginConfig-EX3"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"AuthConfig"</span><span xmlns="" class="perl_Keyword">&gt;</span>META-INF/login-config.xml<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"SecurityConfigName"</span><span xmlns="" class="perl_Keyword">&gt;</span>jboss.security:name=SecurityConfig<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- The SRP service that provides the SRP RMI server and server side</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         authentication cache --&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.srp.SRPService"</span> 
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">           name=</span><span xmlns="" class="perl_String">"jboss.docs.security:service=SRPService"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"VerifierSourceJndiName"</span><span xmlns="" class="perl_Keyword">&gt;</span>srp-test/security-ex3<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"JndiName"</span><span xmlns="" class="perl_Keyword">&gt;</span>srp-test/SRPServerInterface<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"AuthenticationCacheJndiName"</span><span xmlns="" class="perl_Keyword">&gt;</span>srp-test/AuthenticationCache<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"ServerPort"</span><span xmlns="" class="perl_Keyword">&gt;</span>0<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;depends&gt;</span>jboss.docs.security:service=PropertiesVerifierStore<span xmlns="" class="perl_Keyword">&lt;/depends&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Comment">&lt;!-- The SRP store handler service that provides the user password verifier</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Comment">         information --&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.ex3.service.PropertiesVerifierStore"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">           name=</span><span xmlns="" class="perl_String">"jboss.docs.security:service=PropertiesVerifierStore"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"JndiName"</span><span xmlns="" class="perl_Keyword">&gt;</span>srp-test/security-ex3<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/server&gt;</span>
</pre></div></div><div class="para">
		The example services are the <code class="literal">ServiceConfig</code> and the <code class="literal">PropertiesVerifierStore</code> and <code class="literal">SRPService</code> MBeans. Note that the <code class="literal">JndiName</code> attribute of the <code class="literal">PropertiesVerifierStore</code> is equal to the <code class="literal">VerifierSourceJndiName</code> attribute of the <code class="literal">SRPService</code>, and that the <code class="literal">SRPService</code> depends on the <code class="literal">PropertiesVerifierStore</code>. This is required because the <code class="literal">SRPService</code> needs an implementation of the <code class="literal">SRPVerifierStore</code> interface for accessing user password verification information.
	</div><div class="example"><a id="An_SRP_example-The_client_side_standard_JAAS_configuration">
      ⁠</a><p class="title"><strong>Example 13.4. The client side standard JAAS configuration</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span>srp {
<span xmlns="" class="line">​</span>    org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">srp</span>.<span xmlns="" class="perl_Function">jaas</span>.<span xmlns="" class="perl_Function">SRPLoginModule</span> required
<span xmlns="" class="line">​</span>    srpServerJndiName=<span xmlns="" class="perl_String">"srp-test/SRPServerInterface"</span>
<span xmlns="" class="line">​</span>    ;
<span xmlns="" class="line">​</span>                    
<span xmlns="" class="line">​</span>    org.<span xmlns="" class="perl_Function">jboss</span>.<span xmlns="" class="perl_Function">security</span>.<span xmlns="" class="perl_Function">ClientLoginModule</span> required
<span xmlns="" class="line">​</span>    password-stacking=<span xmlns="" class="perl_String">"useFirstPass"</span>
<span xmlns="" class="line">​</span>    ;
<span xmlns="" class="line">​</span>};
</pre></div></div><div class="para">
		The client side login module configuration makes use of the <code class="literal">SRPLoginModule</code> with a <code class="literal">srpServerJndiName</code> option value that corresponds to the server component <code class="literal">SRPService</code> JndiName attribute value(<code class="literal">srp-test/SRPServerInterface</code>). The <code class="literal">ClientLoginModule</code> must also be configured with the <code class="literal">password-stacking="useFirstPass"</code> value to propagate the user authentication credentials generated by the <code class="literal">SRPLoginModule</code> to the EJB invocation layer.
	</div><div class="example"><a id="An_SRP_example-The_server_side_XMLLoginConfig_configuration">
      ⁠</a><p class="title"><strong>Example 13.5. The server side XMLLoginConfig configuration</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;application-policy</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"security-ex3"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;authentication&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.srp.jaas.SRPCacheLoginModule"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">                      flag</span> <span xmlns="" class="perl_Others">=</span> <span xmlns="" class="perl_String">"required"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"cacheJndiName"</span><span xmlns="" class="perl_Keyword">&gt;</span>srp-test/AuthenticationCache<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;login-module</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.auth.spi.UsersRolesLoginModule"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">                      flag</span> <span xmlns="" class="perl_Others">=</span> <span xmlns="" class="perl_String">"required"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>            <span xmlns="" class="perl_Keyword">&lt;module-option</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"password-stacking"</span><span xmlns="" class="perl_Keyword">&gt;</span>useFirstPass<span xmlns="" class="perl_Keyword">&lt;/module-option&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;/login-module&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/authentication&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/application-policy&gt;</span>
</pre></div></div><div class="para">
		There are two issues to note about the server side login module configuration:
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
				The <code class="literal">cacheJndiName=srp-test/AuthenticationCache</code> configuration option tells the <code class="literal">SRPCacheLoginModule</code> the location of the <code class="literal">CachePolicy</code> that contains the <code class="literal">SRPServerSession</code> for users who have authenticated against the <code class="literal">SRPService</code>. This value corresponds to the <code class="literal">SRPService</code><code class="literal">AuthenticationCacheJndiName</code> attribute value.
			</div></li><li class="listitem"><div class="para">
				The configuration includes a <code class="literal">UsersRolesLoginModule</code> with the <code class="literal">password-stacking=useFirstPass</code> configuration option. You must use a second login module with the <code class="literal">SRPCacheLoginModule</code> because SRP is only an authentication technology. To set the principal's roles that in turn determine the associated permissions, a second login module must be configured to accept the authentication credentials validated by the <code class="literal">SRPCacheLoginModule</code> .
			</div></li></ol></div><div class="para">
		The <code class="literal">UsersRolesLoginModule</code> is augmenting the SRP authentication with properties file based authorization. The user's roles are obtained from the <code class="literal">roles.properties</code> file included in the EJB JAR.
	</div><div class="para">
		Run the example 3 client by executing the following command from the book examples directory:
	</div><pre class="screen">[examples]$ ant -Dchap=security -Dex=3 run-example
...
run-example3:
     [echo] Waiting for 5 seconds for deploy...
     [java] Logging in using the 'srp' configuration
     [java] Created Echo
     [java] Echo.echo()#1 = This is call 1
     [java] Echo.echo()#2 = This is call 2</pre><div class="para">
		In the <code class="literal">examples/logs</code> directory, the <code class="literal">ex3-trace.log</code> file contains a detailed trace of the client side of the SRP algorithm. The traces show step-by-step the construction of the public keys, challenges, session key and verification.
	</div><div class="para">
		Observe that the client takes a long time to run, relative to the other simple examples. The reason for this is the construction of the client's public key. This involves the creation of a cryptographically strong random number, and this process takes longer when it first executes. Subsequent authentication attempts within the same VM are much faster.
	</div><div class="para">
		Note that <code class="literal">Echo.echo()#2</code> fails with an authentication exception. The client code sleeps for 15 seconds after making the first call to demonstrate the behavior of the <code class="literal">SRPService</code> cache expiration. The <code class="literal">SRPService</code> cache policy timeout has been set to 10 seconds to force this issue. As discussed in <a class="xref" href="chap-Secure_Remote_Password_Protocol.html#sect-Secure_Remote_Password_Example">Section 13.3, “Secure Remote Password Example”</a> you must set the cache timeout correctly, or handle re-authentication on failure.
	</div></div></div></body></html>