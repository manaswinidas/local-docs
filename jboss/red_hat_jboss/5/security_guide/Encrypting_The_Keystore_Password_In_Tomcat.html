<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook">Chapter 18. Encrypting the Keystore Password in a Tomcat Connector</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.3"/><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content=""/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="Encrypting_The_Keystore_Password_In_Tomcat">
      ⁠</a>Chapter 18. Encrypting the Keystore Password in a Tomcat Connector</h1></div></div></div><div class="para">
		JBoss Web is based on Apache Tomcat.
	</div><div class="para">
		SSL with Tomcat requires a secure connector. This means that the keystore/truststore password cannot be passed as an attribute in the connector element of Tomcat's <code class="filename">server.xml</code> file.
	</div><div class="para">
		A working understanding of the JaasSecurityDomain that supports keystores, truststores, and password based encryption is advised.
	</div><div class="para">
		Refer to <a class="xref" href="chap-Secure_Remote_Password_Protocol.html">Chapter 13, <em>Secure Remote Password Protocol</em></a> and <a class="xref" href="Encrypting_Data_Source_Passwords.html">Chapter 17, <em>Encrypting Data Source Passwords</em></a> for supporting information and related procedures.
	</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="proc-Encrypt_Tomcat_Container_Keystore_Password">
      ⁠</a><p class="title"><strong>Procedure 18.1. Encrypt Tomcat Container Keystore Password</strong></p><ol class="1"><li class="step"><p class="title"><strong>Append connector element</strong></p><div class="para">
				Add a connector element in <code class="filename">server.xml</code> in <code class="filename">$JBOSS_HOME/server/<em class="replaceable">$PROFILE</em>/deploy/jbossweb.sar</code>
<pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Comment">&lt;!-- SSL/TLS Connector with encrypted keystore password configuration  --&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;Connector</span><span xmlns="" class="perl_Others"> port=</span><span xmlns="" class="perl_String">"8443"</span><span xmlns="" class="perl_Others"> address=</span><span xmlns="" class="perl_String">"${jboss.bind.address}"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">   maxThreads=</span><span xmlns="" class="perl_String">"100"</span><span xmlns="" class="perl_Others"> minSpareThreads=</span><span xmlns="" class="perl_String">"5"</span><span xmlns="" class="perl_Others"> maxSpareThreads=</span><span xmlns="" class="perl_String">"15"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">   scheme=</span><span xmlns="" class="perl_String">"https"</span><span xmlns="" class="perl_Others"> secure=</span><span xmlns="" class="perl_String">"true"</span><span xmlns="" class="perl_Others"> clientAuth=</span><span xmlns="" class="perl_String">"true"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">   sslProtocol=</span><span xmlns="" class="perl_String">"TLS"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">   securityDomain=</span><span xmlns="" class="perl_String">"java:/jaas/encrypt-keystore-password"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">   SSLImplementation=</span><span xmlns="" class="perl_String">"org.jboss.net.ssl.JBossImplementation"</span> <span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/Connector&gt;</span></pre>
				 .
			</div></li><li class="step"><p class="title"><strong>Configure JaasSecurityDomain MBean</strong></p><div class="para">
				Set the JaasSecurityDomain MBean in the <code class="filename">$JBOSS_HOME/server/<em class="replaceable">$PROFILE</em>/deploy/security-service.xml</code> file.
			</div><div class="para">
				If the file does not exist, create it. The code sample in <a class="xref" href="Encrypting_The_Keystore_Password_In_Tomcat.html#example-security-service.xml">Example 18.1, “security-service.xml”</a> shows the content you need to add to a newly-created <code class="filename">service-security.xml</code> file. If the <code class="filename">security-service.xml</code> file exists, append the <span class="markup">&lt;mbean&gt;</span> element block to the file.
			</div><div class="example"><a id="example-security-service.xml">
      ⁠</a><p class="title"><strong>Example 18.1. security-service.xml</strong></p><div class="example-contents"><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;server&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.plugins.JaasSecurityDomain"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">      name=</span><span xmlns="" class="perl_String">"jboss.security:service=PBESecurityDomain"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;constructor&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;arg</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"java.lang.String"</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"encrypt-keystore-password"</span><span xmlns="" class="perl_Keyword">&gt;&lt;/arg&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/constructor&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"KeyStoreURL"</span><span xmlns="" class="perl_Keyword">&gt;</span>resource:localhost.keystore<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"KeyStorePass"</span><span xmlns="" class="perl_Keyword">&gt;</span>{CLASS}org.jboss.security.plugins.FilePassword:${jboss.server.home.dir}/conf/keystore.password<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"Salt"</span><span xmlns="" class="perl_Keyword">&gt;</span>welcometojboss<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"IterationCount"</span><span xmlns="" class="perl_Keyword">&gt;</span>13<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/server&gt;</span></pre></div></div><div class="note"><div class="admonition_header"><p><strong>Alias Certificate</strong></p></div><div class="admonition"><div class="para">
					If the keystore contains multiple certificates, you can use the <span class="property">ServerAlias</span> property. The property value specifies the alias of the certificate retrieved by the SSL connector.
				</div><pre class="screen">&lt;attribute name="ServerAlias"&gt;ssl&lt;/attribute&gt;</pre></div></div><div class="para">
				The Salt and IterationCount are the variables that define the strength of your encrypted password, so you can vary it from what is shown. Ensure you record the new values, and use when generating the encrypted password.
			</div><div class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					The Salt must be at least eight characters long.
				</div></div></div></li><li class="step"><p class="title"><strong>Generate encrypted password</strong></p><div class="para">
				The &lt;mbean&gt; configuration specifies that the keystore is stored in the <code class="filename">jboss-as/server/<em class="replaceable">$PROFILE</em>/conf/localhost.keystore</code> file. The <span class="markup">&lt;mbean&gt;</span> also specifies the encrypted password file is stored in <code class="filename">jboss-as/server/<em class="replaceable">$PROFILE</em>/conf/keystore.password</code> file.
			</div><div class="para">
				You must create the <code class="filename">localhost.keystore</code> file.
			</div><div class="para">
				Execute the following command in the <code class="filename">jboss-as/server/<em class="replaceable">$PROFILE</em>/conf</code> directory.
			</div><pre class="screen">[conf]$ java -cp $JBOSS_HOME/lib/jbosssx.jar \org.jboss.security.plugins.FilePassword welcometojboss 13 unit-tests-server keystore.password</pre><div class="para">
				This command uses jbosssx.jar as the classpath (<code class="literal">-cp</code>) and the FilePassword security plug-in to create a <code class="filename">keystore.password</code> file with the password set as <code class="literal">unit-tests-server</code>. To verify you have permission to create a <code class="filename">keystore.password</code> file, you supply the salt and iteration parameters configured in the <span class="markup">&lt;mbean&gt;</span> <span class="markup">&lt;attribute&gt;</span> elements of the JaasSecurityDomain.
			</div><div class="para">
				You execute this command in the <code class="filename">/conf</code> directory so the <code class="filename">keystore.password</code> file is saved to this directory.
			</div></li><li class="step"><p class="title"><strong>Update the Tomcat service MBean</strong></p><div class="para">
				Navigate to <code class="filename">$JBOSS_HOME/server/<em class="replaceable">$PROFILE</em>/deploy/jbossweb.sar/META-INF/</code>.
			</div><div class="para">
				Open <code class="filename">jboss-beans.xml</code> and append the following <span class="markup">&lt;depends&gt;</span> tag to the <code class="classname">WebServer</code> end of the file. Adding the <span class="markup">&lt;depends&gt;</span> tag specifies that Tomcat must start after <code class="methodname"> jboss.security:service=PBESecurityDomain </code> .
			</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;bean</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"WebServer"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">class=</span><span xmlns="" class="perl_String">"org.jboss.web.tomcat.service.deployers.TomcatService"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>...
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;depends&gt;</span>jboss.security:service=PBESecurityDomain<span xmlns="" class="perl_Keyword">&lt;/depends&gt;</span>
<span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span>...</pre></li></ol></div><div class="para">

	</div><div class="example"><a id="idm139921692113648">
      ⁠</a><p class="title"><strong>Example 18.2. JaasSecurityDomain definition for pkcs12 keystores</strong></p><div class="example-contents"><div class="para">
			Based on <a class="xref" href="Encrypting_The_Keystore_Password_In_Tomcat.html#proc-Encrypt_Tomcat_Container_Keystore_Password">Procedure 18.1, “Encrypt Tomcat Container Keystore Password”</a>, pkcs12 keystore containers referenced by the Tomcat Connector would look similar to this example.
		</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.plugins.JaasSecurityDomain"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">      name=</span><span xmlns="" class="perl_String">"jboss.security:service=PBESecurityDomain"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;constructor&gt;</span>
<span xmlns="" class="line">​</span>       <span xmlns="" class="perl_Keyword">&lt;arg</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"java.lang.String"</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"encrypt-keystore-password"</span><span xmlns="" class="perl_Keyword">&gt;&lt;/arg&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;/constructor&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"KeyStoreType"</span><span xmlns="" class="perl_Keyword">&gt;</span>pkcs12<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"KeyStoreURL"</span><span xmlns="" class="perl_Keyword">&gt;</span>resource:localhost.keystore<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"KeyStorePass"</span><span xmlns="" class="perl_Keyword">&gt;</span>{CLASS}org.jboss.security.plugins.FilePassword:${jboss.server.home.dir}/conf/keystore.password<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"Salt"</span><span xmlns="" class="perl_Keyword">&gt;</span>welcometojboss<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>    <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"IterationCount"</span><span xmlns="" class="perl_Keyword">&gt;</span>13<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="idm139921675418208">
      ⁠</a>18.1. Medium Security Usecase</h1></div></div></div><div class="para">
			A user does not want to encrypt the keystore password but wants to externalize it (outside of <code class="filename">server.xml</code> ) or wants to make use of a predefined JaasSecurityDomain.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="predefined_JaasSecurityDomain">
      ⁠</a><p class="title"><strong>Procedure 18.2. Predefined JaasSecurityDomain</strong></p><ol class="1"><li class="step"><p class="title"><strong>Update jboss-service.xml to add a connector</strong></p><div class="para">
					Navigate to <code class="filename">$JBOSS_HOME/server/<code class="filename"> <em class="replaceable">$PROFILE</em> </code>/deploy/jbossweb.sar/META-INF</code>, and add the following code block to the <code class="filename">jboss-service.xml</code> file.
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.plugins.JaasSecurityDomain"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">      name=</span><span xmlns="" class="perl_String">"jboss.security:service=SecurityDomain"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;constructor&gt;</span>
<span xmlns="" class="line">​</span>         <span xmlns="" class="perl_Keyword">&lt;arg</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"java.lang.String"</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"jbosstest-ssl"</span><span xmlns="" class="perl_Keyword">&gt;&lt;/arg&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;/constructor&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"KeyStoreURL"</span><span xmlns="" class="perl_Keyword">&gt;</span>resource:localhost.keystore<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>      <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"KeyStorePass"</span><span xmlns="" class="perl_Keyword">&gt;</span>unit-tests-server<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span>
</pre></li><li class="step"><p class="title"><strong>Add a &lt;depends&gt; tag to the Tomcat service</strong></p><div class="para">
					Navigate to <code class="filename">$JBOSS_HOME/server/<em class="replaceable">$PROFILE</em>/deploy/jbossweb.sar</code> .
				</div><div class="para">
					Open <code class="filename">server.xml</code> and append the following <span class="markup">&lt;depends&gt;</span> element toward the end of the file:
				</div><pre class="programlisting"><span xmlns="" class="line">​</span><span xmlns="" class="perl_Keyword">&lt;depends&gt;</span>jboss.security:service=SecurityDomain<span xmlns="" class="perl_Keyword">&lt;/depends&gt;</span>
<span xmlns="" class="line">​</span>   <span xmlns="" class="perl_Error">&lt;</span>/mbean&gt;
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Error">&lt;</span>/server&gt;
</pre></li><li class="step"><p class="title"><strong>Define the JaasSecurityDomain MBean in a *-service.xml file</strong></p><div class="para">
					<code class="filename">security-service.xml</code> in the deploy directory, for example.
				</div><pre class="programlisting"><span xmlns="" class="line">​</span>
<span xmlns="" class="line">​</span> <span xmlns="" class="perl_Keyword">&lt;mbean</span><span xmlns="" class="perl_Others"> code=</span><span xmlns="" class="perl_String">"org.jboss.security.plugins.JaasSecurityDomain"</span>
<span xmlns="" class="line">​</span><span xmlns="" class="perl_Others">     name=</span><span xmlns="" class="perl_String">"jboss.security:service=SecurityDomain"</span><span xmlns="" class="perl_Keyword">&gt;</span>
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">&lt;constructor&gt;</span>
<span xmlns="" class="line">​</span>        <span xmlns="" class="perl_Keyword">&lt;arg</span><span xmlns="" class="perl_Others"> type=</span><span xmlns="" class="perl_String">"java.lang.String"</span><span xmlns="" class="perl_Others"> value=</span><span xmlns="" class="perl_String">"jbosstest-ssl"</span><span xmlns="" class="perl_Keyword">&gt;&lt;/arg&gt;</span>
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">&lt;/constructor&gt;</span>
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"KeyStoreURL"</span><span xmlns="" class="perl_Keyword">&gt;</span>resource:localhost.keystore<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>     <span xmlns="" class="perl_Keyword">&lt;attribute</span><span xmlns="" class="perl_Others"> name=</span><span xmlns="" class="perl_String">"KeyStorePass"</span><span xmlns="" class="perl_Keyword">&gt;</span>unit-tests-server<span xmlns="" class="perl_Keyword">&lt;/attribute&gt;</span>
<span xmlns="" class="line">​</span>  <span xmlns="" class="perl_Keyword">&lt;/mbean&gt;</span>
</pre></li></ol></div><div class="para">
			<div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>File Permission issue reading the keystore (or FileNotFoundException)</strong></p></div><div class="admonition"><div class="para">
					If you see this error, remember the keystore file should be writable by the user id that is running JBoss Enterprise Application Platform.
				</div></div></div>

		</div></div></div></body></html>