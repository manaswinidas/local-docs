<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 3. mod_cluster Connector</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="mod_cluster_connector"/>Chapter 3. mod_cluster Connector</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="overview"/>Overview</h1></div></div></div><p>
				The mod_cluster connector is a reduced configuration, intelligent load-balancing solution for JBoss EAP and JBoss Web Server Tomcat, and is based on technology originally developed by the JBoss mod_cluster community project.
			</p><p>
				The mod_cluster module load-balances HTTP requests to JBoss EAP and JBoss Web Server Tomcat worker nodes, utilizing Apache HTTP Server as the proxy server.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="key_features"/>Key Features</h2></div></div></div><p>
					The mod_cluster connector has several advantages over the mod_jk connector:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							The mod_cluster Management Protocol (MCMP) is an additional connection between the Tomcat servers and the Apache HTTP Server with the mod_cluster module enabled. It is used by the Tomcat servers to transmit server-side load figures and lifecycle events back to Apache HTTP Server via a custom set of HTTP methods.
						</li><li class="listitem">
							Dynamic configuration of Apache HTTP Server with mod_cluster allows Tomcat servers that have mod_cluster listeners to join the load balancing arrangement without manual configuration.
						</li><li class="listitem">
							Tomcat servers perform the load calculations, rather than relying on Apache HTTP Server. This makes load balancing metrics more accurate than other connectors.
						</li><li class="listitem">
							The mod_cluster connector gives fine-grained application lifecycle control. Each Tomcat server forwards web application context lifecycle events to the Apache HTTP Server, informing it to start or stop routing requests for a given context. This prevents end users from seeing HTTP errors due to unavailable resources.
						</li><li class="listitem">
							AJP, HTTP, or HTTPS transports can be used.
						</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="mod_cluster_components"/>Components</h2></div></div></div><p>
					On the proxy server, mod_cluster consists of four Apache modules.
				</p><div class="table"><a id="idm140328000160560"/><p class="title"><strong>Table 3.1. Components</strong></p><div class="table-contents"><table summary="Components" border="1"><colgroup><col class="col_1"/><col class="col_2"/></colgroup><thead><tr><th style="text-align: left" valign="top">Component</th><th style="text-align: left" valign="top">Description</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
									<code class="literal">mod_cluster_slotmem.so</code>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									The Shared Memory Manager module shares real-time worker node information with multiple Apache HTTP Server processes.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<code class="literal">mod_manager.so</code>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									The Cluster Manager module receives and acknowledges messages from worker nodes, including node registrations, node load data, and node application life cycle events.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<code class="literal">mod_proxy_cluster.so</code>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									The Proxy Balancer Module handles request routing to cluster nodes. The Proxy Balancer selects the appropriate destination node based on application location in the cluster, the current state of each of the cluster nodes, and the Session ID (if a request is part of an established session).
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<code class="literal">mod_advertise.so</code>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									The Proxy Advertisement Module broadcasts the existence of the proxy server via UDP multicast messages. The server advertisement messages contain the IP address and port number where the proxy server is listening for responses from worker nodes that want to join the load-balancing cluster.
								</p>
								 </td></tr></tbody></table></div></div><p>
					See the <a class="link" href="apache_http_server_reference.html#apache_http_modules" title="Apache HTTP Server Modules">Apache HTTP Server Modules appendix</a> for detailed information about the available modules, including user-configurable parameters.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="character_limits"/>Character Limits</h2></div></div></div><p>
					mod_cluster uses shared memory to keep the nodes description. The shared memory is created at the startup of Apache HTTP Server, and the structure of each item is fixed. When defining proxy server and worker node properties, ensure that you follow these character limits:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<span class="strong"><strong>Maximum alias length</strong></span>: 100 characters (alias corresponds to the network name of the respective virtual host; the name is defined in the <code class="literal">Host</code> element).
						</li><li class="listitem">
							<span class="strong"><strong>Maximum context length</strong></span>: 40 characters (for example, if <code class="literal">myapp.war</code> is deployed in <code class="literal">/myapp</code> , then <code class="literal">/myapp</code> is included in the context).
						</li><li class="listitem">
							<span class="strong"><strong>Maximum balancer name length</strong></span>: 40 characters (the balancer property in <code class="literal">mbean</code>).
						</li><li class="listitem">
							<span class="strong"><strong>Maximum <code class="literal">JVMRoute</code> string length</strong></span>: 80 characters (<code class="literal">JVMRoute</code> in the <code class="literal">&lt;Engine&gt;</code> element).
						</li><li class="listitem">
							<span class="strong"><strong>Maximum domain name length</strong></span>: 20 characters (the domain property in <code class="literal">mbean</code>).
						</li><li class="listitem">
							<span class="strong"><strong>Maximum hostname length for a node</strong></span>: 64 characters (hostname address in the <code class="literal">&lt;Connector&gt;</code> element).
						</li><li class="listitem">
							<span class="strong"><strong>Maximum port length for a node</strong></span>: 7 characters (the port property in the <code class="literal">&lt;Connector&gt;</code> element, <code class="literal">8009</code> is 4 characters).
						</li><li class="listitem">
							<span class="strong"><strong>Maximum scheme length for a node</strong></span>: 6 characters (the protocol of the connector; possible values are <code class="literal">http</code> , <code class="literal">https</code> , <code class="literal">ajp</code>).
						</li><li class="listitem">
							<span class="strong"><strong>Maximum cookie name length</strong></span>: 30 characters (the header cookie name for session ID. Default value: <code class="literal">JSESSIONID</code> from <code class="literal">org.apache.catalina.Globals.SESSION_COOKIE_NAME</code>).
						</li><li class="listitem">
							<span class="strong"><strong>Maximum path name length</strong></span>: 30 characters (the parameter name for the session ID. Default value: <code class="literal">JSESSIONID</code> from <code class="literal">org.apache.catalina.Globals.SESSION_PARAMETER_NAME</code>).
						</li><li class="listitem">
							<span class="strong"><strong>Maximum length of a session ID</strong></span>: 120 characters (session ID resembles the following: <code class="literal">BE81FAA969BF64C8EC2B6600457EAAAA.node01</code>).
						</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="downloading_and_installing_mod_cluster"/>Downloading and Installing mod_cluster</h1></div></div></div><p>
				The mod_cluster module is included in the Apache HTTP Server part of a JBoss Core Services installation.
			</p><p>
				Follow the procedures in the JBoss Core Services <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_core_services/2.4.29/html-single/apache_http_server_installation_guide/"><span class="emphasis"><em>Installation Guide</em></span></a> to download and install Apache HTTP Server for your operating system.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_load_balancing_using_apache_http_server_and_mod_cluster"/>Configuring Load Balancing Using Apache HTTP Server and mod_cluster</h1></div></div></div><p>
				In JBoss Web Server 2.1 and higher, mod_cluster is configured correctly for Apache HTTP Server by default. To set a custom configuration, see <a class="link" href="mod_cluster_connector.html#configuring_basic_proxy_server" title="Configuring a Basic Proxy Server">Configuring a Basic Proxy Server</a>.
			</p><p>
				For more information on configuring a Tomcat worker node with mod_cluster, see <a class="link" href="mod_cluster_connector.html#configuring_worker_nodes" title="Configuring Worker Nodes">Configuring Worker Nodes</a>.
			</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					Red Hat customers can also use the <a class="link" href="https://access.redhat.com/labs/lbconfig/">Load Balancer Configuration Tool</a> on the RedHat Customer Portal to quickly generate optimal configuration templates for mod_cluster, as well as Tomcat worker nodes.
				</p><p>
					When using this tool for JBoss Web Server 3, ensure you select <code class="literal">2.4.x</code> as the Apache version, and select <code class="literal">Tomcat</code> as the back end configuration.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring_basic_proxy_server"/>Configuring a Basic Proxy Server</h2></div></div></div><p>
					Proxy server configuration consists of one mandatory and one optional step:
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
							Configure a Proxy Server listener to receive worker node connection requests and worker node feedback.
						</li><li class="listitem">
							Optional: Disable server advertisement.
						</li></ol></div><div class="title"><strong>Server Advertisement</strong></div><p>
						The proxy server advertises itself using UDP multicast. When UDP multicast is available between the proxy server and the worker nodes, server advertisement adds worker nodes without requiring further configuration on the proxy server, and requires only minimal configuration on the worker nodes.
					</p><p>
					If UDP multicast is not available or undesirable, <a class="link" href="mod_cluster_connector.html#worker_node_static_proxy_list" title="Configuring a Worker Node with a Static Proxy List">configure the worker nodes with a static list of proxy servers</a>. In either case, the proxy server does not need to be configured with a list of worker nodes.
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="configuring_a_load_balancing_proxy_using_mod_cluster"/>Configuring a Load-balancing Proxy Using mod_cluster</h3></div></div></div><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist"><li class="listitem">
								Install JBoss Web Server, and configure the mod_cluster modules for your installation. See the JBoss Web Server <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_web_server/5.1/html-single/installation_guide/"><span class="emphasis"><em>Installation Guide</em></span></a> for details.
							</li></ul></div><p>
						To configure the load-balancing proxy using mod_cluster a Virtual Host for the management channel must be configured:
					</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							This address and port combination is only for mod_cluster management messages, not general traffic.
						</p></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Create a Listen directive for the proxy server:
							</p><p class="simpara">
								Edit your mod_cluster configuration file (usually <code class="literal"><span class="emphasis"><em>JBCS_HOME</em></span>/httpd/conf.d/mod_cluster.conf</code>) to add the following:
							</p><pre class="screen">Listen <span class="emphasis"><em>IP_ADDRESS</em></span>:<span class="emphasis"><em>PORT_NUMBER</em></span></pre><p class="simpara">
								Where <code class="literal"><span class="emphasis"><em>IP_ADDRESS</em></span></code> is the address of the server network interface to communicate with the worker nodes, and <code class="literal"><span class="emphasis"><em>PORT_NUMBER</em></span></code> is the port on that interface to listen on.
							</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
									The port must be open for incoming TCP connections.
								</p></div></li><li class="listitem"><p class="simpara">
								Create a virtual host:
							</p><p class="simpara">
								Add the following to your mod_cluster configuration file:
							</p><pre class="programlisting">&lt;VirtualHost <span class="emphasis"><em>IP_ADDRESS</em></span>:<span class="emphasis"><em>PORT_NUMBER</em></span>&gt;

   &lt;Directory /&gt;
      Require ip <span class="emphasis"><em>IP_ADDRESS</em></span>
   &lt;/Directory&gt;

   KeepAliveTimeout 60
   MaxKeepAliveRequests 0

   ManagerBalancerName mycluster
   AdvertiseFrequency 5
   EnableMCPMReceive On

&lt;/VirtualHost&gt;</pre><p class="simpara">
								Where <code class="literal"><span class="emphasis"><em>IP_ADDRESS</em></span></code> and <code class="literal"><span class="emphasis"><em>PORT_NUMBER</em></span></code> are the values from the <code class="literal">Listen</code> directive.
							</p></li><li class="listitem"><p class="simpara">
								<span class="strong"><strong>Optional:</strong></span> Disable server advertisement:
							</p><p class="simpara">
								The <code class="literal">AdvertiseFrequency</code> directive makes the server periodically send server advertisement messages via UDP multicast. By default, this occurs every 10 seconds.
							</p><p class="simpara">
								These server advertisement messages contain the <code class="literal"><span class="emphasis"><em>IP_ADDRESS</em></span></code> and <code class="literal"><span class="emphasis"><em>PORT_NUMBER</em></span></code> specified in the <code class="literal">VirtualHost</code> definition. Worker nodes configured to respond to server advertisements use this information to register themselves with the proxy server.
							</p><p class="simpara">
								To disable server advertisement, add the following directive to the <code class="literal">VirtualHost</code> definition:
							</p><pre class="screen">ServerAdvertise Off</pre><p class="simpara">
								If server advertisements are disabled, or UDP multicast is not available on the network between the proxy server and the worker nodes, <a class="link" href="mod_cluster_connector.html#worker_node_static_proxy_list" title="Configuring a Worker Node with a Static Proxy List">configure worker nodes with a static list of proxy servers</a>.
							</p></li><li class="listitem"><p class="simpara">
								<span class="strong"><strong>Optional:</strong></span> Configure Apache HTTP Server Logging
							</p><p class="simpara">
								You can configure the Apache HTTP Server that is doing the load balancing to log which worker node handled a request. This may be useful when troubleshooting your load balancer.
							</p><p class="simpara">
								To enable this for mod_cluster, you can add the following to your Apache HTTP Server <code class="literal">LogFormat</code> directive(s):
							</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">%{BALANCER_NAME}e </span></dt><dd>
											The name of the balancer that served the request.
										</dd><dt><span class="term">%{BALANCER_WORKER_NAME}e </span></dt><dd>
											The name of the worker node that served the request.
										</dd></dl></div><p class="simpara">
								For more information on Apache HTTP Server logging (including log rotation), see <a class="link" href="http://httpd.apache.org/docs/2.4/logs.html">http://httpd.apache.org/docs/2.4/logs.html</a>.
							</p></li><li class="listitem"><p class="simpara">
								Stop and start the Apache HTTP Server service:
							</p><p class="simpara">
								See the JBoss Core Services <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_core_services/2.4.29/html-single/apache_http_server_installation_guide/"><span class="emphasis"><em>Installation Guide</em></span></a> for detailed instructions.
							</p></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring_worker_nodes"/>Configuring Worker Nodes</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="configuring_tomcat_worker_node"/>Configuring a Tomcat Worker Node</h3></div></div></div><p>
						Follow this procedure to install mod_cluster on a JBoss Web Server node, and configure it for non-clustered operation.
					</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							JBoss Web Server Tomcat worker nodes only support a subset of mod_cluster functionality. Full mod_cluster functionality is available with JBoss EAP.
						</p></div><div class="itemizedlist"><p class="title"><strong>Supported Worker Node types</strong></p><ul class="itemizedlist"><li class="listitem">
								JBoss Web Server Tomcat service.
							</li></ul></div><div class="itemizedlist"><p class="title"><strong>mod_cluster JBoss Web Server Node Limitations</strong></p><ul class="itemizedlist"><li class="listitem">
								Non-clustered mode only.
							</li><li class="listitem">
								Only one load metric can be used at a time when calculating the load balance factor.
							</li></ul></div><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist"><li class="listitem">
								Install a supported instance of JBoss Web Server.
							</li><li class="listitem">
								Understand the <a class="link" href="worker_node_reference.html#mod_cluster_Proxy_and_Proxy_Discovery_Configuration_Attributes" title="mod_cluster Proxy and Proxy Discovery Configuration Attributes">proxy configuration parameters</a>.
							</li></ul></div><p>
						To configure a Tomcat worker node:
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Add a listener to Tomcat:
							</p><p class="simpara">
								Add the following <code class="literal">Listener</code> element beneath the other <code class="literal">Listener</code> elements in <code class="literal"><span class="emphasis"><em>JWS_HOME</em></span>/tomcat<span class="emphasis"><em>&lt;VERSION&gt;</em></span>/conf/server.xml</code>.
							</p><pre class="programlisting">&lt;Listener className="org.jboss.modcluster.container.catalina.standalone.ModClusterListener" advertise="true" stickySession="true" stickySessionForce="false" stickySessionRemove="true" /&gt;</pre></li><li class="listitem"><p class="simpara">
								Give the worker a unique identity:
							</p><p class="simpara">
								Edit <code class="literal"><span class="emphasis"><em>JWS_HOME</em></span>/tomcat<span class="emphasis"><em>&lt;VERSION&gt;</em></span>/conf/server.xml</code> and add the <code class="literal">jvmRoute</code> attribute and value to the <code class="literal">Engine</code> element, as shown below:
							</p><pre class="programlisting">&lt;Engine name="Catalina" defaultHost="localhost" jvmRoute="worker01"&gt;</pre></li><li class="listitem"><p class="simpara">
								Configure <code class="literal">STATUS MCMP</code> message frequency:
							</p><p class="simpara">
								Tomcat worker nodes periodically send status messages containing their current load status to the Apache HTTP Server balancer. The default frequency of these messages is 10 seconds. If you have hundreds of worker nodes, the <code class="literal">STATUS MCMP</code> messages can increase traffic congestion on your Apache HTTP Server network.
							</p><p class="simpara">
								You can configure the <code class="literal">MCMP</code> message frequency by modifying the <code class="literal">org.jboss.modcluster.container.catalina.status-frequency</code> Java system property. By default, the property accepts values in seconds*10. For example, setting the property to <code class="literal">1</code> means 10 seconds. The example below demonstrates setting the frequency to 60 seconds.
							</p><pre class="screen">-Dorg.jboss.modcluster.container.catalina.status-frequency=6</pre></li><li class="listitem"><p class="simpara">
								<span class="strong"><strong>Optional:</strong></span> Configure the firewall for proxy server advertisements:
							</p><p class="simpara">
								A proxy server using mod_cluster can advertise itself via UDP multicast. Most operating system firewalls block this by default. To enable server advertising and receive these multicast messages, open port <code class="literal">23364</code> for UDP connections on the worker node’s firewall.
							</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
										For Red Hat Enterprise Linux 6:
									</p><pre class="screen">/sbin/iptables -A INPUT -m state --state NEW -m udp -p udp --dport
 23364 -j ACCEPT
-m comment -comment receive mod_cluster proxy server advertisements</pre><p class="simpara">
										If automatic proxy discovery is not used, configure worker nodes with a static list of proxies. In this case you can safely ignore the following warning message:
									</p><pre class="screen">[warning] mod_advertise: ServerAdvertise Address or Port not defined, Advertise disabled!!!</pre></li><li class="listitem"><p class="simpara">
										For Red Hat Enterprise Linux 7:
									</p><pre class="screen">firewall-cmd --permanent --zone=public --add-port=23364/udp</pre></li><li class="listitem"><p class="simpara">
										For Microsoft Windows, using PowerShell
									</p><pre class="screen">Start-Process "$psHome\powershell.exe" -Verb Runas -ArgumentList '-command "NetSh Advfirewall firewall add rule name="UDP Port 23364" dir=in  action=allow protocol=UDP localport=23364"'
Start-Process "$psHome\powershell.exe" -Verb Runas -ArgumentList '-command "NetSh Advfirewall firewall add rule name="UDP Port 23364" dir=out action=allow protocol=UDP localport=23364"'</pre></li></ul></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="worker_node_static_proxy_list"/>Configuring a Worker Node with a Static Proxy List</h3></div></div></div><p>
						Server advertisement allows worker nodes to dynamically discover and register themselves with proxy servers. If UDP multicast is not available or server advertisement is disabled, then worker nodes must be configured with a static list of proxy server addresses and ports.
					</p><p>
						Use the following procedure to configure a JBoss Web Server worker node to operate with a static list of proxy servers.
					</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist"><li class="listitem">
								<a class="link" href="mod_cluster_connector.html#configuring_tomcat_worker_node" title="Configuring a Tomcat Worker Node">JBoss Web Server worker node configured</a>.
							</li><li class="listitem">
								Understand the <a class="link" href="worker_node_reference.html#Proxy_Configuration_Values_for_Tomcat" title="Table B.1. Proxy Configuration Values for Tomcat">proxy configuration parameters for Tomcat</a>.
							</li></ul></div><p>
						To configure a worker node with a static proxy list:
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Define a mod_cluster Listener, and disable dynamic proxy discovery:
							</p><p class="simpara">
								Edit <code class="literal"><span class="emphasis"><em>JWS_HOME</em></span>/tomcat<span class="emphasis"><em>&lt;VERSION&gt;</em></span>/conf/server.xml</code> , and add or change the <code class="literal">Listener</code> element for <code class="literal">ModClusterListener</code>. Set the <code class="literal">advertise</code> property to <code class="literal">false</code>. For example:
							</p><pre class="programlisting">&lt;Listener className="org.jboss.modcluster.container.catalina.standalone.ModClusterListener" advertise="false" stickySession="true" stickySessionForce="false" stickySessionRemove="true"/&gt;</pre></li><li class="listitem"><p class="simpara">
								Create a static proxy server list:
							</p><p class="simpara">
								Add a comma separated list of proxies to the Listener in the form of <code class="literal"><span class="emphasis"><em>IP_ADDRESS</em></span>:<span class="emphasis"><em>PORT</em></span></code> as the <code class="literal">proxyList</code> property. For example:
							</p><pre class="programlisting">&lt;Listener className="org.jboss.modcluster.container.catalina.standalone.ModClusterListener" advertise="false" stickySession="true" stickySessionForce="false" stickySessionRemove="true" proxyList="10.33.144.3:6666,10.33.144.1:6666"/&gt;</pre></li></ol></div></div></div></div></div></body></html>