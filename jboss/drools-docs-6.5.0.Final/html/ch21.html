<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 21. Workbench High Availability</title><link rel="stylesheet" type="text/css" href="css/jbossorg.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"/><link rel="home" href="index.html" title="Drools Documentation"/><link rel="up" href="pt05.html" title="Part V. Drools Workbench"/><link rel="prev" href="ch20.html" title="Chapter 20. Workbench Integration"/><link rel="next" href="pt06.html" title="Part VI. KIE Server"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><p id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="ch20.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="pt06.html"><strong>Next</strong></a></li></ul><div class="chapter" title="Chapter 21. Workbench High Availability"><div class="titlepage"><div><div><h2 class="title"><a id="wb.WorkbenchHighAvailability"/>Chapter 21. Workbench High Availability</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ch21.html#wb.HighAvailability">21.1. </a></span></dt><dd><dl><dt><span class="section"><a href="ch21.html#wb.vfsClustering">21.1.1. VFS clustering</a></span></dt><dt><span class="section"><a href="ch21.html#d0e24193">21.1.2. jBPM clustering</a></span></dt></dl></dd></dl></div><div class="section" title="21.1. "><div class="titlepage"/><div class="section" title="21.1.1. VFS clustering"><div class="titlepage"><div><div><h3 class="title"><a id="wb.vfsClustering"/>21.1.1. VFS clustering</h3></div></div></div><p>The <a class="link" href="ch18.html#wb.VFSRepository" title="18.3.3. Repositories">VFS repositories</a> (usually git repositories) stores all the assets
    (such as rules, decision tables, process definitions, forms, etc). If that VFS resides on each local server, then it
    must be kept in sync between all servers of a cluster.</p><p>Use <a class="link" href="http://zookeeper.apache.org/">Apache Zookeeper</a> and <a class="link" href="http://helix.incubator.apache.org/">Apache Helix</a> to accomplish this. Zookeeper glues all the
    parts together. Helix is the cluster management component that registers all cluster details (nodes, resources and
    the cluster itself). Uberfire (on top of which Workbench is build) uses those 2 components to provide VFS
    clustering.</p><p>To create a VFS cluster:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Download <a class="link" href="http://zookeeper.apache.org/">Apache Zookeeper</a> and <a class="link" href="http://helix.incubator.apache.org/">Apache Helix</a>.</p></li><li class="listitem"><p>Install both:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Unzip Zookeeper into a directory (<code class="literal">$ZOOKEEPER_HOME</code>).</p></li><li class="listitem"><p>In <code class="literal">$ZOOKEEPER_HOME</code>, copy <code class="literal">zoo_sample.conf</code> to
            <code class="literal">zoo.conf</code></p></li><li class="listitem"><p>Edit <code class="literal">zoo.conf</code>. Adjust the settings if needed. Usually only these 2 properties are
            relevant:</p><pre><code class="no-highlight"># the directory where the snapshot is stored.
dataDir=/tmp/zookeeper
# the port at which the clients will connect
clientPort=2181</code></pre></li><li class="listitem"><p>Unzip Helix into a directory (<code class="literal">$HELIX_HOME</code>).</p></li></ol></div></li><li class="listitem"><p>Configure the cluster in Zookeeper:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Go to its <code class="literal">bin</code> directory:</p><pre><code class="no-highlight">$ cd $ZOOKEEPER_HOME/bin</code></pre></li><li class="listitem"><p>Start the Zookeeper server:</p><pre><code class="no-highlight">$ sudo ./zkServer.sh start</code></pre><p>If the server fails to start, verify that the <code class="literal">dataDir</code> (as specified in
            <code class="literal">zoo.conf</code>) is accessible.</p></li><li class="listitem"><p>To review Zookeeper's activities, open <code class="literal">zookeeper.out</code>:</p><pre><code class="no-highlight">$ cat $ZOOKEEPER_HOME/bin/zookeeper.out</code></pre></li></ol></div></li><li class="listitem"><p>Configure the cluster in Helix: </p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Go to its <code class="literal">bin</code> directory:</p><pre><code class="no-highlight">$ cd $HELIX_HOME/bin</code></pre></li><li class="listitem"><p>Create the cluster:</p><pre><code class="no-highlight">$ ./helix-admin.sh --zkSvr localhost:2181 --addCluster kie-cluster</code></pre><p>The <code class="literal">zkSvr</code> value must match the used Zookeeper server. The cluster name
            (<code class="literal">kie-cluster</code>) can be changed as needed.</p></li><li class="listitem"><p>Add nodes to the cluster:</p><pre><code class="no-highlight"># Node 1
$ ./helix-admin.sh --zkSvr localhost:2181 --addNode kie-cluster nodeOne:12345
# Node 2
$ ./helix-admin.sh --zkSvr localhost:2181 --addNode kie-cluster nodeTwo:12346
...</code></pre><p>Usually the number of nodes a in cluster equal the number of application servers in the cluster. The
            node names (<code class="literal">nodeOne:12345</code> , ...) can be changed as needed.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p><code class="literal">nodeOne:12345</code> is the unique identifier of the node, which will be referenced
              later on when configuring application servers. It is not a host and port number, but instead it is used to
              uniquely identify the logical node.</p></div></li><li class="listitem"><p>Add resources to the cluster:</p><pre><code class="no-highlight">$ ./helix-admin.sh --zkSvr localhost:2181 --addResource kie-cluster vfs-repo 1 LeaderStandby AUTO_REBALANCE</code></pre><p>The resource name (<code class="literal">vfs-repo</code>) can be changed as needed.</p></li><li class="listitem"><p>Rebalance the cluster to initialize it:</p><pre><code class="no-highlight">$ ./helix-admin.sh --zkSvr localhost:2181 --rebalance kie-cluster vfs-repo 2</code></pre></li><li class="listitem"><p>Start the Helix controller to manage the cluster:</p><pre><code class="no-highlight">$  ./run-helix-controller.sh --zkSvr localhost:2181 --cluster kie-cluster 2&gt;&amp;1 &gt; /tmp/controller.log &amp;</code></pre></li></ol></div></li><li class="listitem"><p>Configure the security domain correctly on the application server. For example on WildFly and JBoss
        EAP:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Edit the file <code class="literal">$JBOSS_HOME/domain/configuration/domain.xml</code>.</p><p>For simplicity sake, presume we use the default domain configuration which uses the profile
            <code class="literal">full</code> that defines two server nodes as part of
            <code class="literal">main-server-group</code>.</p></li><li class="listitem"><p>Locate the profile <code class="literal">full</code> and add a new security domain by copying the other security
            domain already defined there by default:</p><pre><code class="no-highlight">&lt;security-domain name="kie-ide" cache-type="default"&gt;
    &lt;authentication&gt;
         &lt;login-module code="Remoting" flag="optional"&gt;
             &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
         &lt;/login-module&gt;
         &lt;login-module code="RealmDirect" flag="required"&gt;
             &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
         &lt;/login-module&gt;
    &lt;/authentication&gt;
&lt;/security-domain&gt;</code></pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2><p>The security-domain name is a magic value.</p></div></li></ol></div></li><li class="listitem"><p>Configure the <a class="link" href="ch18.html#wb.systemProperties" title="18.1.3. System properties">system properties</a> for the cluster on the
        application server. For example on WildFly and JBoss EAP:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Edit the file <code class="literal">$JBOSS_HOME/domain/configuration/host.xml</code>.</p></li><li class="listitem"><p>Locate the XML elements <code class="literal">server</code> that belong to the
            <code class="literal">main-server-group</code> and add the necessary system property.</p><p>For example for nodeOne:</p><pre><code class="language-xml">&lt;system-properties&gt;
  &lt;property name="jboss.node.name" value="nodeOne" boot-time="false"/&gt;
  &lt;property name="org.uberfire.nio.git.dir" value="/tmp/kie/nodeone" boot-time="false"/&gt;
  &lt;property name="org.uberfire.metadata.index.dir" value="/tmp/kie/nodeone" boot-time="false"/&gt;
  &lt;property name="org.uberfire.cluster.id" value="kie-cluster" boot-time="false"/&gt;
  &lt;property name="org.uberfire.cluster.zk" value="localhost:2181" boot-time="false"/&gt;
  &lt;property name="org.uberfire.cluster.local.id" value="nodeOne_12345" boot-time="false"/&gt;
  &lt;property name="org.uberfire.cluster.vfs.lock" value="vfs-repo" boot-time="false"/&gt;
  &lt;!-- If you're running both nodes on the same machine: --&gt;
  &lt;property name="org.uberfire.nio.git.daemon.port" value="9418" boot-time="false"/&gt;
&lt;/system-properties&gt;</code></pre><p>And for nodeTwo:</p><pre><code class="language-xml">&lt;system-properties&gt;
  &lt;property name="jboss.node.name" value="nodeTwo" boot-time="false"/&gt;
  &lt;property name="org.uberfire.nio.git.dir" value="/tmp/kie/nodetwo" boot-time="false"/&gt;
  &lt;property name="org.uberfire.metadata.index.dir" value="/tmp/kie/nodetwo" boot-time="false"/&gt;
  &lt;property name="org.uberfire.cluster.id" value="kie-cluster" boot-time="false"/&gt;
  &lt;property name="org.uberfire.cluster.zk" value="localhost:2181" boot-time="false"/&gt;
  &lt;property name="org.uberfire.cluster.local.id" value="nodeTwo_12346" boot-time="false"/&gt;
  &lt;property name="org.uberfire.cluster.vfs.lock" value="vfs-repo" boot-time="false"/&gt;
  &lt;!-- If you're running both nodes on the same machine: --&gt;
  &lt;property name="org.uberfire.nio.git.daemon.port" value="9419" boot-time="false"/&gt;
&lt;/system-properties&gt;</code></pre><p>Make sure the cluster, node and resource names match those configured in Helix.</p></li></ol></div></li></ol></div></div><div class="section" title="21.1.2. jBPM clustering"><div class="titlepage"><div><div><h3 class="title"><a id="d0e24193"/>21.1.2. jBPM clustering</h3></div></div></div><p>In addition to the information above, jBPM clustering requires additional configuration. See <a class="link" href="http://mswiderski.blogspot.com.br/2013/06/clustering-in-jbpm-v6.html">this blog post</a> to configure
    the database etc correctly.</p></div></div></div><script type="text/javascript" src="highlight.js/highlight.pack.js"> </script><script type="text/javascript">hljs.initHighlightingOnLoad();</script><ul class="docnav"><li class="previous"><a accesskey="p" href="ch20.html"><strong>Prev</strong>Chapter 20. Workbench Integration</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="pt06.html"><strong>Next</strong>Part VI. KIE Server</a></li></ul></body></html>