<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 13. Integration with Spring</title><link rel="stylesheet" type="text/css" href="css/jbossorg.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"/><link rel="home" href="index.html" title="Drools Documentation"/><link rel="up" href="pt04.html" title="Part IV. Drools Integration"/><link rel="prev" href="ch12.html" title="Chapter 12. CDI"/><link rel="next" href="ch14.html" title="Chapter 14. Android Integration"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><p id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="ch12.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="ch14.html"><strong>Next</strong></a></li></ul><div class="chapter" title="Chapter 13. Integration with Spring"><div class="titlepage"><div><div><h2 class="title"><a id="ch.kie.spring"/>Chapter 13. Integration with Spring</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ch13.html#d0e15103">13.1. Important Changes for Drools 6.0</a></span></dt><dt><span class="section"><a href="ch13.html#d0e15157">13.2. Integration with Drools Expert</a></span></dt><dd><dl><dt><span class="section"><a href="ch13.html#d0e15165">13.2.1. KieModule</a></span></dt><dt><span class="section"><a href="ch13.html#d0e15212">13.2.2. KieBase</a></span></dt><dt><span class="section"><a href="ch13.html#d0e15312">13.2.3. IMPORTANT NOTE</a></span></dt><dt><span class="section"><a href="ch13.html#d0e15337">13.2.4. KieSessions</a></span></dt><dt><span class="section"><a href="ch13.html#d0e15425">13.2.5. Kie:ReleaseId</a></span></dt><dt><span class="section"><a href="ch13.html#d0e15482">13.2.6. Kie:Import</a></span></dt><dt><span class="section"><a href="ch13.html#d0e15565">13.2.7. Annotations</a></span></dt><dt><span class="section"><a href="ch13.html#d0e15688">13.2.8. Event Listeners</a></span></dt><dt><span class="section"><a href="ch13.html#d0e15844">13.2.9. Loggers</a></span></dt><dt><span class="section"><a href="ch13.html#d0e15933">13.2.10. Defining Batch Commands</a></span></dt><dt><span class="section"><a href="ch13.html#d0e16013">13.2.11. Persistence</a></span></dt><dt><span class="section"><a href="ch13.html#d0e16043">13.2.12. Leveraging Other Spring Features</a></span></dt></dl></dd><dt><span class="section"><a href="ch13.html#d0e16083">13.3. Integration with jBPM Human Task</a></span></dt><dd><dl><dt><span class="section"><a href="ch13.html#d0e16088">13.3.1. How to configure Spring with jBPM Human task</a></span></dt></dl></dd></dl></div><div class="section" title="13.1. Important Changes for Drools 6.0"><div class="titlepage"><div><div><h2 class="title"><a id="d0e15103"/>13.1. Important Changes for Drools 6.0</h2></div></div></div><p>Drools Spring integration has undergone a complete makeover inline
    with the changes for Drools 6.0. The following are some of the major
    changes</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The recommended prefix for the Drools Spring has changed from
        'drools:' to 'kie:'</p></li><li class="listitem"><p>New Top Level Tags in 6.0</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>kie:kmodule</p></li><li class="listitem"><p>kie:import (from version 6.2)</p></li><li class="listitem"><p>kie:releaseId (from version 6.2)</p></li></ul></div></li><li class="listitem"><p>The following tags are no longer valid as top level tags.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>kie:kbase - A child of the <span class="emphasis"><em>kie:kmodule</em></span>
            tag.</p></li><li class="listitem"><p>kie:ksession - A child of the <span class="emphasis"><em>kie:kbase</em></span>
            tag.</p></li></ul></div></li><li class="listitem"><p>Removed Tags from previous versions Drools 5.x</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>drools:resources</p></li><li class="listitem"><p>drools:resource</p></li><li class="listitem"><p>drools:grid</p></li><li class="listitem"><p>drools:grid-node</p></li></ul></div></li></ul></div></div><div class="section" title="13.2. Integration with Drools Expert"><div class="titlepage"><div><div><h2 class="title"><a id="d0e15157"/>13.2. Integration with Drools Expert</h2></div></div></div><p>In this section we will explain the <span class="emphasis"><em>kie</em></span>
    namespace.</p><div class="section" title="13.2.1. KieModule"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15165"/>13.2.1. KieModule</h3></div></div></div><p>
      </p><p>The <span class="emphasis"><em>&lt;kie:kmodule&gt;</em></span> defines a collection
      of KieBase and associated KieSession's. The <span class="emphasis"><em>kmodule</em></span>
      tag has one MANDATORY parameter 'id'.</p><div class="table"><a id="d0e15178"/><p class="title"><strong>Table 13.1. Sample</strong></p><div class="table-contents"><table summary="Sample" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="center">Attribute</th><th align="center">Description</th><th align="center">Required</th></tr></thead><tbody><tr><td align="left">id</td><td align="left">Bean's <span class="emphasis"><em>id</em></span> is the name to be
              referenced from other beans. Standard Spring ID semantics
              apply.</td><td align="left">Yes</td></tr></tbody></table></div></div><br class="table-break"/><p>A <span class="emphasis"><em>kmodule</em></span> tag can contain only the following
      tags as children.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>kie:kbase</p></li></ul></div><p>Refer to the documentation of kmodule.xml in the Drools Expert
      documentation for detailed explanation of the need for kmodule.</p></div><div class="section" title="13.2.2. KieBase"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15212"/>13.2.2. KieBase</h3></div></div></div><div class="section" title="13.2.2.1. &lt;kie:kbase&gt;'s parameters as attributes:"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15215"/>13.2.2.1. &lt;kie:kbase&gt;'s parameters as attributes:</h4></div></div></div><div class="table"><a id="d0e15218"/><p class="title"><strong>Table 13.2. Sample</strong></p><div class="table-contents"><table summary="Sample" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="center">Attribute</th><th align="center">Description</th><th align="center">Required</th></tr></thead><tbody><tr><td align="left">name</td><td align="left">Name of the KieBase</td><td align="left">Yes</td></tr><tr><td align="left">packages</td><td align="left">Comma separated list of resource packages to be
                included in this kbase</td><td align="left">No</td></tr><tr><td align="left">includes</td><td align="left">kbase names to be included. All resources from the
                corresponding kbase are included in this kbase.</td><td align="left">No</td></tr><tr><td align="left">default</td><td align="left">Boolean (TRUE/FALSE). Default kbase, if not provided,
                it is assumed to be FALSE</td><td align="left">No</td></tr><tr><td align="left">scope</td><td align="left">prototype | singleton. If not provided assumed to be singleton (default)</td><td align="left">No</td></tr><tr><td align="left">eventProcessingMode</td><td align="left">Event Processing Mode. Valid options are STREAM,
                CLOUD</td><td align="left">No</td></tr><tr><td align="left">equalsBehavior</td><td align="left">Valid options are IDENTITY, EQUALITY</td><td align="left">No</td></tr><tr><td align="left">declarativeAgenda</td><td align="left">Valid options are enabled, disabled, true,
                false</td><td align="left">No</td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" title="13.2.2.2. A kbase tag can contain only the following tags as children."><div class="titlepage"><div><div><h4 class="title"><a id="d0e15287"/>13.2.2.2. A <span class="emphasis"><em>kbase</em></span> tag can contain only the following
        tags as children.</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>kie:ksession</p></li></ul></div></div><div class="section" title="13.2.2.3. &lt;kie:kbase&gt;'s definition example"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15297"/>13.2.2.3. &lt;kie:kbase&gt;'s definition example</h4></div></div></div><p>A kmodule can contain multiple (1..n) kbase elements.</p><div class="example"><a id="d0e15302"/><p class="title"><strong>Example 13.1. kbase definition example</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;kie:kmodule id="sample_module"&gt;
   &lt;kie:kbase name="kbase1" packages="org.drools.spring.sample"&gt;
     ...
   &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/></div><div class="section" title="13.2.2.4. Spring Bean Scope (for KieBase and KieSession)"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15307"/>13.2.2.4. Spring Bean Scope (for KieBase and KieSession)</h4></div></div></div><p>
          When defining a KieBase or a KieSession, you have the option of declaring a scope for that bean.
          For example, To force Spring to produce a new bean instance each time one is needed, you should declare the bean's scope
          attribute to be 'prototype'.
          Similar way if you want Spring to return the same bean instance each time one is needed,
          you should declare the bean's scope attribute to be 'singleton'.
        </p></div></div><div class="section" title="13.2.3. IMPORTANT NOTE"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15312"/>13.2.3. IMPORTANT NOTE</h3></div></div></div><p>For proper initialization of the kmodule objects (kbase/ksession),
      it is mandatory for a bean of type
      <code class="code">org.kie.spring.KModuleBeanFactoryPostProcessor</code> or
        <code class="code">org.kie.spring.annotations.KModuleAnnotationPostProcessor</code> be
      defined.</p><div class="example"><a id="d0e15323"/><p class="title"><strong>Example 13.2. Regular kie-spring post processorbean definition</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/><p/><div class="example"><a id="d0e15329"/><p class="title"><strong>Example 13.3. kie-spring post processorbean definition when annotations are used</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;bean id="kiePostProcessor"
          class="org.kie.spring.annotations.KModuleAnnotationPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Without the
      org.kie.spring.KModuleBeanFactoryPostProcessor or org.kie.spring.annotations.KModuleAnnotationPostProcessor bean
      definition, the kie-spring integration will fail to work.</p></div></div><div class="section" title="13.2.4. KieSessions"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15337"/>13.2.4. KieSessions</h3></div></div></div><p>&lt;kie:ksession&gt; element defines KieSessions. The same tag is
      used to define both Stateful
      (<span class="emphasis"><em>org.kie.api.runtime.KieSession</em></span>) and Stateless
      (<span class="emphasis"><em>org.kie.api.runtime.StatelessKieSession</em></span>)
      sessions.</p><div class="section" title="13.2.4.1. &lt;kie:ksession&gt;'s parameters as attributes:"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15348"/>13.2.4.1. &lt;kie:ksession&gt;'s parameters as attributes:</h4></div></div></div><div class="table"><a id="d0e15351"/><p class="title"><strong>Table 13.3. Sample</strong></p><div class="table-contents"><table summary="Sample" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="center">Attribute</th><th align="center">Description</th><th align="center">Required</th></tr></thead><tbody><tr><td align="left">name</td><td align="left">ksession's name.</td><td align="left">Yes</td></tr><tr><td align="left">type</td><td align="left">is the session <span class="emphasis"><em>stateful</em></span> or
                <span class="emphasis"><em>stateless?</em></span>. If this attribute is empty or
                missing, the session is assumed to be of type
                Stateful.</td><td align="left">No</td></tr><tr><td align="left">default</td><td align="left">Is this the default session?</td><td align="left">no</td></tr><tr><td align="left">scope</td><td align="left">prototype | singleton. If not provided assumed to be singleton (default)</td><td align="left">no</td></tr><tr><td align="left">clockType</td><td align="left">REALTIME or PSEUDO</td><td align="left">no</td></tr><tr><td align="left">listeners-ref</td><td align="left">Specifies the reference to the event listeners group
                (see <a class="link" href="ch13.html#kie-grouping-listeners" title="13.2.8.2. Defining a Group of listeners:">'Defining a Group
                of listeners'</a> section below).</td><td align="left">no</td></tr></tbody></table></div></div><br class="table-break"/><div class="example"><a id="d0e15415"/><p class="title"><strong>Example 13.4. ksession definition example</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;kie:kmodule id="sample-kmodule"&gt;
  &lt;kie:kbase name="drl_kiesample3" packages="drl_kiesample3"&gt;
    &lt;kie:ksession name="ksession1" type="stateless"/&gt;
    &lt;kie:ksession name="ksession2"/&gt;
  &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/></div><div class="section" title="13.2.4.2. Spring Bean Scope (for KieBase and KieSession)"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15420"/>13.2.4.2. Spring Bean Scope (for KieBase and KieSession)</h4></div></div></div><p>
          When defining a KieBase or a KieSession, you have the option of declaring a scope for that bean.
          For example, To force Spring to produce a new bean instance each time one is needed, you should declare the bean's scope
          attribute to be 'prototype'.
          Similar way if you want Spring to return the same bean instance each time one is needed,
          you should declare the bean's scope attribute to be 'singleton'.
        </p></div></div><div class="section" title="13.2.5. Kie:ReleaseId"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15425"/>13.2.5. Kie:ReleaseId</h3></div></div></div><p>
      </p><div class="section" title="13.2.5.1. &lt;kie:releaseId&gt;'s parameters as attributes:"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15430"/>13.2.5.1. &lt;kie:releaseId&gt;'s parameters as attributes:</h4></div></div></div><div class="table"><a id="d0e15433"/><p class="title"><strong>Table 13.4. Sample</strong></p><div class="table-contents"><table summary="Sample" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="center">Attribute</th><th align="center">Description</th><th align="center">Required</th></tr></thead><tbody><tr><td align="left">id</td><td align="left">Bean's <span class="emphasis"><em>id</em></span> is the name to be
                  referenced from other beans. Standard Spring ID semantics
                  apply.</td><td align="left">Yes</td></tr><tr><td align="left">groupId</td><td align="left">groupId from Maven GAV</td><td align="left">Yes</td></tr><tr><td align="left">artifactId</td><td align="left">artifactId from Maven GAV</td><td align="left">Yes</td></tr><tr><td align="left">version</td><td align="left">version from Maven GAV</td><td align="left">Yes</td></tr></tbody></table></div></div><br class="table-break"/><div class="example"><a id="d0e15477"/><p class="title"><strong>Example 13.5. releaseId definition example</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;kie:releaseId id="beanId" groupId="org.kie.spring"
            artifactId="named-artifactId" version="1.0.0-SNAPSHOT"/&gt;</code></pre></div></div><br class="example-break"/></div></div><div class="section" title="13.2.6. Kie:Import"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15482"/>13.2.6. Kie:Import</h3></div></div></div><p>Starting with version 6.2, kie-spring allows for importing of kie objects from kjars found on the classpath. Two modes of importing the kie objects are currently supported.</p><div class="table"><a id="d0e15487"/><p class="title"><strong>Table 13.5. </strong></p><div class="table-contents"><table border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="center">Attribute</th><th align="center">Description</th><th align="center">Required</th></tr></thead><tbody><tr><td align="left">releaseId</td><td align="left">Reference to a Bean ID. Standard Spring ID semantics
                apply.</td><td align="left">No</td></tr><tr><td align="left">enableScanner</td><td align="left">Enable Scanner. This attribute is used only if 'releaseId' is specified.</td><td align="left">No</td></tr><tr><td align="left">scannerInterval</td><td align="left">Scanning Interval in milli seconds. This attribute is used only if 'releaseId' is specified.</td><td align="left">No</td></tr></tbody></table></div></div><br class="table-break"/><div class="section" title="13.2.6.1. Global Import"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15519"/>13.2.6.1. Global Import</h4></div></div></div><p>The <span class="emphasis"><em>import</em></span> tag will force the automatic scan of all the jars on the classpath, initialize the Kie Objects (Kbase/KSessions) and import these objects into the spring context.</p><div class="figure"><a id="d0e15527"/><p class="title"><strong>Figure 13.1. Global Import</strong></p><div class="figure-contents"><pre><code class="language-xml">&lt;kie:import /&gt;</code></pre></div></div><br class="figure-break"/></div><div class="section" title="13.2.6.2. Specific Import - ReleaseId"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15532"/>13.2.6.2. Specific Import - ReleaseId</h4></div></div></div><p>Using the <span class="emphasis"><em>releaseId-ref</em></span> attribute on the import tag will initialize the specific Kie Objects (Kbase/KSessions) and import these objects into the spring context.</p><div class="figure"><a id="d0e15540"/><p class="title"><strong>Figure 13.2. Import Kie Objects using a releaseId</strong></p><div class="figure-contents"><pre><code class="language-xml">&lt;kie:import releaseId-ref="namedKieSession"/&gt;
&lt;kie:releaseId id="namedKieSession" groupId="org.drools"
            artifactId="named-kiesession" version="6.5.0.Final"/&gt;
          </code></pre></div></div><br class="figure-break"/><p>Kie Scanning feature can be enabled for KieBase's imported with a specific releaseId. This feature is currently not available for global imports.</p><div class="figure"><a id="d0e15547"/><p class="title"><strong>Figure 13.3. Import Kie Objects using a releaseId - Enable Scanner</strong></p><div class="figure-contents"><pre><code class="language-xml">&lt;kie:import releaseId-ref="namedKieSession"
            enableScanner="true" scannerInterval="1000"/&gt;

&lt;kie:releaseId id="namedKieSession" groupId="org.drools"
            artifactId="named-kiesession" version="6.5.0.Final"/&gt;
          </code></pre></div></div><br class="figure-break"/><p>If the scanner is defined and enabled, an implicit <span class="emphasis"><em>KieScanner</em></span> object is created and inserted into the spring context. It can be retrived from the
        spring context.</p><div class="figure"><a id="d0e15557"/><p class="title"><strong>Figure 13.4. Retriving the KieScanner from Spring Context</strong></p><div class="figure-contents"><pre><code class="language-java">
// the implicit name would be releaseId#scanner
KieScanner releaseIdScanner = context.getBean("namedKieSession#scanner", KieScanner.class);
releaseIdScanner.scanNow();
          </code></pre></div></div><br class="figure-break"/><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>kie-ci must be available on the classpath for the releaseId importing feature to work.</p></div></div></div><div class="section" title="13.2.7. Annotations"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15565"/>13.2.7. Annotations</h3></div></div></div><p>@KContainer, @KBase and @KSession all support an optional 'name' attribute. Spring typically
        does "get" when it injects, all injections receive the same instance for the same set
        of annotations. the 'name' annotation forces a unique instance for each name, although all
        instance for that name will be identity equals.</p><div class="section" title="13.2.7.1. @KReleaseId"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15570"/>13.2.7.1. @KReleaseId</h4></div></div></div><p>Used to bind an instance to a specific version of a KieModule. If kie-ci is on the
          classpath this will resolve dependencies automatically, downloading from remote
          repositories.</p></div><div class="section" title="13.2.7.2. @KContainer"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15575"/>13.2.7.2. @KContainer</h4></div></div></div><div class="figure"><a id="d0e15578"/><p class="title"><strong>Figure 13.5. Injects Classpath KieContainer</strong></p><div class="figure-contents"><pre><code class="language-java">@KContainer
private KieContainer kContainer;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e15583"/><p class="title"><strong>Figure 13.6. Injects KieContainer for Dynamic KieModule</strong></p><div class="figure-contents"><pre><code class="language-java">@KContainer
@KReleaseId(groupId = "jar1", artifactId = "art1", version = "1.1")
private KieContainer kContainer;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e15588"/><p class="title"><strong>Figure 13.7. Injects named KieContainer for Dynamic KieModule</strong></p><div class="figure-contents"><pre><code class="language-java">@KContainer(name = "kc1")
@KReleaseId(groupId = "jar1", artifactId = "art1", version = "1.1")
private KieContainer kContainer;</code></pre></div></div><br class="figure-break"/></div><div class="section" title="13.2.7.3. @KBase"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15593"/>13.2.7.3. @KBase</h4></div></div></div><p>The default argument, if given, maps to the value attribute and specifies the name of the KieBase from the
          spring xml file.</p><div class="figure"><a id="d0e15598"/><p class="title"><strong>Figure 13.8. Injects the Default KieBase from the Classpath KieContainer</strong></p><div class="figure-contents"><pre><code class="language-java">@KBase
private KieBase kbase;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e15603"/><p class="title"><strong>Figure 13.9. Injects the Default KieBase from a Dynamic KieModule</strong></p><div class="figure-contents"><pre><code class="language-java">@KBase
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.0")
private KieBase kbase;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e15608"/><p class="title"><strong>Figure 13.10. Side by side version loading for 'jar1.KBase1' KieBase</strong></p><div class="figure-contents"><pre><code class="language-java">@KBase("kbase1")
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.0")
private KieBase kbase1v10;

@KBase("kbase1")
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.1")
private KieBase kbase1v11;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e15613"/><p class="title"><strong>Figure 13.11. Side by side version loading for 'jar1.ksession1' KieSession</strong></p><div class="figure-contents"><pre><code class="language-java">@KSession("ksession1")
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.0")
private KieSession ksession11kb2;

@KSession("ksession1")
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.1")
private KieSession ksession11kb2;</code></pre></div></div><br class="figure-break"/></div><div class="section" title="13.2.7.4. @KSession for KieSession"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15618"/>13.2.7.4. @KSession for KieSession</h4></div></div></div><p>The default argument, if given, maps to the value attribute and specifies the name of the KieSession from the
          kmodule.xml or spring xml file</p><div class="figure"><a id="d0e15623"/><p class="title"><strong>Figure 13.12. Injects the Default KieSession from the Classpath KieContainer</strong></p><div class="figure-contents"><pre><code class="language-java">@KSession
private KieSession ksession;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e15628"/><p class="title"><strong>Figure 13.13. Injects the Default KieSession from a Dynamic KieModule</strong></p><div class="figure-contents"><pre><code class="language-java">@KSession
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.0")
private KieSession ksession;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e15633"/><p class="title"><strong>Figure 13.14. Side by side version loading for 'jar1.KBase1' KieBase</strong></p><div class="figure-contents"><pre><code class="language-java">@KSession("ksession1")
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.0")
private KieSession ksessionv10;

@KSession("ksession1")
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.1")
private KieSession ksessionv11;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e15638"/><p class="title"><strong>Figure 13.15. Use 'name' attribute to force new Instance for 'jar1.KBase1' KieSession</strong></p><div class="figure-contents"><pre><code class="language-java">@KSession("ksession1")
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.0")
private KieSession ksession1ks1

@KSession("ksession1")
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.0")
private KieSession ksession1ks2</code></pre></div></div><br class="figure-break"/></div><div class="section" title="13.2.7.5. @KSession for StatelessKieSession"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15643"/>13.2.7.5. @KSession for StatelessKieSession</h4></div></div></div><p>The default argument, if given, maps to the value attribute and specifies the name of the KieSession from the
          kmodule.xml or spring xml file.</p><div class="figure"><a id="d0e15648"/><p class="title"><strong>Figure 13.16. Injects the Default StatelessKieSession from the Classpath KieContainer</strong></p><div class="figure-contents"><pre><code class="language-java">@KSession
private StatelessKieSession ksession;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e15653"/><p class="title"><strong>Figure 13.17. Injects the Default StatelessKieSession from a Dynamic KieModule</strong></p><div class="figure-contents"><pre><code class="language-java">@KSession
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.0")
private StatelessKieSession ksession;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e15658"/><p class="title"><strong>Figure 13.18. Side by side version loading for 'jar1.KBase1' KieBase</strong></p><div class="figure-contents"><pre><code class="language-java">@KSession("ksession1")
@KReleaseId( groupId = "jar1", rtifactId = "art1", version = "1.0")
private StatelessKieSession ksessionv10;

@KSession("ksession1")
@KReleaseId( groupId = "jar1", rtifactId = "art1", version = "1.1")
private StatelessKieSession ksessionv11;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e15663"/><p class="title"><strong>Figure 13.19. </strong></p><div class="figure-contents"><pre><code class="language-java">@KSession(value="ksession1", name="ks1")
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.0")
private StatelessKieSession ksession1ks1

@KSession(value="ksession1", name="ks2")
@KReleaseId( groupId = "jar1", artifactId = "art1", version = "1.0")
private StatelessKieSession ksession1ks2</code></pre></div></div><br class="figure-break"/></div><div class="section" title="13.2.7.6. IMPORTANT NOTE"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15666"/>13.2.7.6. IMPORTANT NOTE</h4></div></div></div><p>When annotations are used, For proper initialization of the kmodule objects (kbase/ksession),
          it is mandatory for either a bean of type
          <code class="code">org.kie.spring.annotations.KModuleAnnotationPostProcessor</code> be
          defined</p> or spring component-scan be enabled. One of the code snippets as shown below is required.

        <div class="example"><a id="d0e15675"/><p class="title"><strong>Example 13.6. kie-spring annotations post processor bean definition</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;bean id="kiePostProcessor"
            class="org.kie.spring.annotations.KModuleAnnotationPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/><div class="example"><a id="d0e15680"/><p class="title"><strong>Example 13.7. kie-spring annotations - Component Scanning</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;context:component-scan base-package="org.kie.spring.annotations"/&gt;</code></pre></div></div><br class="example-break"/><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>The post processor is different when annotations are used.</p></div></div></div><div class="section" title="13.2.8. Event Listeners"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15688"/>13.2.8. Event Listeners</h3></div></div></div><p>Drools supports adding 3 types of listeners to KieSessions -
      <span class="emphasis"><em>AgendaListener</em></span>,
      <span class="emphasis"><em>WorkingMemoryListener</em></span>,
      <span class="emphasis"><em>ProcessEventListener</em></span></p><p>The kie-spring module allows you to configure these listeners to
      KieSessions using XML tags. These tags have identical names as the
      actual listener interfaces i.e., &lt;kie:agendaEventListener....&gt;,
      &lt;kie:ruleRuntimeEventListener....&gt; and
      &lt;kie:processEventListener....&gt;.</p><p>kie-spring provides features to define the listeners as standalone
      (individual) listeners and also to define them as a group.</p><div class="section" title="13.2.8.1. Defining Stand alone Listeners:"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15705"/>13.2.8.1. Defining Stand alone Listeners:</h4></div></div></div><div class="section" title="13.2.8.1.1. Attributes:"><div class="titlepage"><div><div><h5 class="title"><a id="d0e15708"/>13.2.8.1.1. Attributes:</h5></div></div></div><div class="table"><a id="d0e15711"/><p class="title"><strong>Table 13.6. Sample</strong></p><div class="table-contents"><table summary="Sample" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="center">Attribute</th><th align="center">Required</th><th align="center">Description</th></tr></thead><tbody><tr><td align="left">ref</td><td align="left">No</td><td align="left">A reference to another declared bean.</td></tr></tbody></table></div></div><br class="table-break"/><div class="example"><a id="d0e15731"/><p class="title"><strong>Example 13.8. Listener configuration example - using a bean:ref.</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;bean id="mock-agenda-listener" class="mocks.MockAgendaEventListener"/&gt;
&lt;bean id="mock-rr-listener" class="mocks.MockRuleRuntimeEventListener"/&gt;
&lt;bean id="mock-process-listener" class="mocks.MockProcessEventListener"/&gt;

&lt;kie:kmodule id="listeners_kmodule"&gt;
  &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
    &lt;kie:ksession name="ksession2"&gt;
      &lt;kie:agendaEventListener ref="mock-agenda-listener"/&gt;
      &lt;kie:processEventListener ref="mock-process-listener"/&gt;
      &lt;kie:ruleRuntimeEventListener ref="mock-rr-listener"/&gt;
    &lt;/kie:ksession&gt;
  &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/></div><div class="section" title="13.2.8.1.2. Nested Elements:"><div class="titlepage"><div><div><h5 class="title"><a id="d0e15736"/>13.2.8.1.2. Nested Elements:</h5></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>bean</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>class = String</p></li><li class="listitem"><p>name = String (optional)</p></li></ul></div></li></ul></div><div class="example"><a id="d0e15750"/><p class="title"><strong>Example 13.9. Listener configuration example - using nested bean.</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;kie:kmodule id="listeners_module"&gt;
  &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
   &lt;kie:ksession name="ksession1"&gt;
	  &lt;kie:agendaEventListener&gt;
      &lt;bean class="mocks.MockAgendaEventListener"/&gt;
      &lt;/kie:agendaEventListener&gt;
    &lt;/kie:ksession&gt;
  &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/></div><div class="section" title="13.2.8.1.3. Empty Tag : Declaration with no 'ref' and without a nested bean"><div class="titlepage"><div><div><h5 class="title"><a id="d0e15755"/>13.2.8.1.3. Empty Tag : Declaration with no 'ref' and without a nested
          bean</h5></div></div></div><p>When a listener is defined without a reference to a
          implementing bean and does not contain a nested bean,
          <span class="emphasis"><em>&lt;drools:ruleRuntimeEventListener/&gt;</em></span> the
          underlying implementation adds the Debug version of the listener
          defined in the API.</p><p>The debug listeners print the corresponding Event toString
          message to <span class="emphasis"><em>System.err. </em></span></p><div class="example"><a id="d0e15767"/><p class="title"><strong>Example 13.10. Listener configuration example - defaulting to the debug
            versions provided by the Knowledge-API .</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;bean id="mock-agenda-listener" class="mocks.MockAgendaEventListener"/&gt;
&lt;bean id="mock-rr-listener" class="mocks.MockRuleRuntimeEventListener"/&gt;
&lt;bean id="mock-process-listener" class="mocks.MockProcessEventListener"/&gt;

&lt;kie:kmodule id="listeners_module"&gt;
 &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
    &lt;kie:ksession name="ksession2"&gt;
      &lt;kie:agendaEventListener /&gt; 
      &lt;kie:processEventListener /&gt;
      &lt;kie:ruleRuntimeEventListener /&gt;
    &lt;/kie:ksession&gt;
 &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/></div><div class="section" title="13.2.8.1.4. Mix and Match of different declaration styles"><div class="titlepage"><div><div><h5 class="title"><a id="d0e15772"/>13.2.8.1.4. Mix and Match of different declaration styles</h5></div></div></div><p>The drools-spring module allows you to mix and match the
          different declarative styles within the same KieSession. The
          below sample provides more clarity.</p><div class="example"><a id="d0e15777"/><p class="title"><strong>Example 13.11. Listener configuration example - mix and match of
            'ref'/nested-bean/empty styles.</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;bean id="mock-agenda-listener" class="mocks.MockAgendaEventListener"/&gt;
&lt;bean id="mock-rr-listener" class="mocks.MockRuleRuntimeEventListener"/&gt;
&lt;bean id="mock-process-listener" class="mocks.MockProcessEventListener"/&gt;

&lt;kie:kmodule id="listeners_module"&gt;
  &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
    &lt;kie:ksession name="ksession1"&gt;
      &lt;kie:agendaEventListener&gt;
          &lt;bean class="org.kie.spring.mocks.MockAgendaEventListener"/&gt;
      &lt;/kie:agendaEventListener&gt;
    &lt;/kie:ksession&gt;
    &lt;kie:ksession name="ksession2"&gt;
      &lt;kie:agendaEventListener ref="mock-agenda-listener"/&gt;
      &lt;kie:processEventListener ref="mock-process-listener"/&gt;
      &lt;kie:ruleRuntimeEventListener ref="mock-rr-listener"/&gt;
    &lt;/kie:ksession&gt;
  &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/></div><div class="section" title="13.2.8.1.5. Defining multiple listeners of the same type"><div class="titlepage"><div><div><h5 class="title"><a id="d0e15782"/>13.2.8.1.5. Defining multiple listeners of the same type</h5></div></div></div><p>It is also valid to define multiple beans of the same event
          listener types for a KieSession.</p><div class="example"><a id="d0e15787"/><p class="title"><strong>Example 13.12. Listener configuration example - multiple listeners of the
            same type.</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;bean id="mock-agenda-listener" class="mocks.MockAgendaEventListener"/&gt;

&lt;kie:kmodule id="listeners_module"&gt;
  &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
    &lt;kie:ksession name="ksession1"&gt;
      &lt;kie:agendaEventListener ref="mock-agenda-listener"/&gt;
      &lt;kie:agendaEventListener&gt;
          &lt;bean class="org.kie.spring.mocks.MockAgendaEventListener"/&gt;
      &lt;/kie:agendaEventListener&gt;
    &lt;/kie:ksession&gt;
  &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/></div></div><div class="section" title="13.2.8.2. Defining a Group of listeners:"><div class="titlepage"><div><div><h4 class="title"><a id="kie-grouping-listeners"/>13.2.8.2. Defining a Group of listeners:</h4></div></div></div><p>drools-spring allows for grouping of listeners. This is
        particularly useful when you define a set of listeners and want to
        attach them to multiple sessions. The grouping feature is also very
        useful, when we define a set of listeners for 'testing' and then want
        to switch them for 'production' use.</p><div class="section" title="13.2.8.2.1. Attributes:"><div class="titlepage"><div><div><h5 class="title"><a id="d0e15797"/>13.2.8.2.1. Attributes:</h5></div></div></div><div class="table"><a id="d0e15800"/><p class="title"><strong>Table 13.7. Sample</strong></p><div class="table-contents"><table summary="Sample" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="center">Attribute</th><th align="center">Required</th><th align="center">Description</th></tr></thead><tbody><tr><td align="left">ID</td><td align="left">yes</td><td align="left">Unique identifier</td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" title="13.2.8.2.2. Nested Elements:"><div class="titlepage"><div><div><h5 class="title"><a id="d0e15820"/>13.2.8.2.2. Nested Elements:</h5></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>kie:agendaEventListener...</p></li><li class="listitem"><p>kie:ruleRuntimeEventListener...</p></li><li class="listitem"><p>kie:processEventListener...</p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>The above mentioned child elements can be declared in any
          order. Only one declaration of each type is allowed in a
          group.</p></div></div><div class="section" title="13.2.8.2.3. Example:"><div class="titlepage"><div><div><h5 class="title"><a id="d0e15836"/>13.2.8.2.3. Example:</h5></div></div></div><div class="example"><a id="d0e15839"/><p class="title"><strong>Example 13.13. Group of listeners - example</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;bean id="mock-agenda-listener" class="mocks.MockAgendaEventListener"/&gt;
&lt;bean id="mock-rr-listener" class="mocks.MockRuleRuntimeEventListener"/&gt;
&lt;bean id="mock-process-listener" class="mocks.MockProcessEventListener"/&gt;

&lt;kie:kmodule id="listeners_module"&gt;
  &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
    &lt;kie:ksession name="statelessWithGroupedListeners" type="stateless" 
             listeners-ref="debugListeners"/&gt;
  &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

  &lt;kie:eventListeners id="debugListeners"&gt;
  &lt;kie:agendaEventListener ref="mock-agenda-listener"/&gt;
  &lt;kie:processEventListener ref="mock-process-listener"/&gt;
  &lt;kie:ruleRuntimeEventListener ref="mock-rr-listener"/&gt;
&lt;/kie:eventListeners&gt;

&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/></div></div></div><div class="section" title="13.2.9. Loggers"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15844"/>13.2.9. Loggers</h3></div></div></div><p>Drools supports adding 2 types of loggers to KieSessions -
      <span class="emphasis"><em>ConsoleLogger</em></span>,
      <span class="emphasis"><em>FileLogger.</em></span></p><p>The kie-spring module allows you to configure these loggers to
      KieSessions using XML tags. These tags have identical names as the
      actual logger interfaces i.e., &lt;kie:consoleLogger....&gt; and
      &lt;kie:fileLogger....&gt;.</p><div class="section" title="13.2.9.1. Defining a console logger:"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15856"/>13.2.9.1. Defining a console logger:</h4></div></div></div><p>A console logger can be attached to a KieSession by using the
        <span class="emphasis"><em>&lt;kie:consoleLogger/&gt;</em></span> tag. This tag has no
        attributes and must be present directly under a
        &lt;kie:ksession....&gt; element.</p><div class="example"><a id="d0e15864"/><p class="title"><strong>Example 13.14. Defining a console logger - example</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;kie:kmodule id="loggers_module"&gt;
  &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
    &lt;kie:ksession name="ConsoleLogger-statefulSession" type="stateful"&gt;
      &lt;kie:consoleLogger/&gt;
    &lt;/kie:ksession&gt;
  &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/></div><div class="section" title="13.2.9.2. Defining a file logger:"><div class="titlepage"><div><div><h4 class="title"><a id="d0e15869"/>13.2.9.2. Defining a file logger:</h4></div></div></div><p>A file logger can be attached to a KieSession by using the
        <span class="emphasis"><em>&lt;kie:fileLogger/&gt;</em></span> tag. This tag has the
        following attributes and must be present directly under a
        &lt;kie:ksession....&gt; element.</p><div class="table"><a id="d0e15877"/><p class="title"><strong>Table 13.8. Sample</strong></p><div class="table-contents"><table summary="Sample" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="center">Attribute</th><th align="center">Required</th><th align="center">Description</th></tr></thead><tbody><tr><td align="left">ID</td><td align="left">yes</td><td align="left">Unique identifier</td></tr><tr><td align="left">file</td><td align="left">yes</td><td align="left">Path to the actual file on the disk</td></tr><tr><td align="left">threaded</td><td align="left">no</td><td align="left">Defaults to false. Valid values are 'true'or
                'false'</td></tr><tr><td align="left">interval</td><td align="left">no</td><td align="left">Integer. Specifies the interval for flushing the
                contents from memory to the disk.</td></tr></tbody></table></div></div><br class="table-break"/><div class="example"><a id="d0e15918"/><p class="title"><strong>Example 13.15. Defining a file logger - example</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;kie:kmodule id="loggers_module"&gt;
  &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
    &lt;kie:ksession name="ConsoleLogger-statefulSession" type="stateful"&gt;
      &lt;kie:fileLogger id="fl_logger" file="#{ systemProperties['java.io.tmpdir'] }/log1"/&gt;
      &lt;kie:fileLogger id="tfl_logger" file="#{ systemProperties['java.io.tmpdir'] }/log2" 
                          threaded="true" interval="5"/&gt;
    &lt;/kie:ksession&gt;
  &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/><div class="section" title="13.2.9.2.1. Closing a FileLogger"><div class="titlepage"><div><div><h5 class="title"><a id="d0e15923"/>13.2.9.2.1. Closing a FileLogger</h5></div></div></div><p>To prevent leaks, it is advised to close the
          <span class="emphasis"><em>&lt;kie:fileLogger ...&gt; </em></span>
          programmatically.</p><pre><code class="language-java">LoggerAdaptor adaptor = (LoggerAdaptor) context.getBean("fl_logger");
adaptor.close();</code></pre></div></div></div><div class="section" title="13.2.10. Defining Batch Commands"><div class="titlepage"><div><div><h3 class="title"><a id="d0e15933"/>13.2.10. Defining Batch Commands</h3></div></div></div><p>A <span class="emphasis"><em>&lt;kie:batch&gt;</em></span> element can be used to
      define a set of batch commands for a given ksession.This tag has no
      attributes and must be present directly under a &lt;kie:ksession....&gt;
      element. The commands supported are</p><div class="figure"><a id="d0e15941"/><p class="title"><strong>Figure 13.20. Initialization Batch Commands</strong></p><div class="figure-contents"><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>insert-object</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>ref = String (optional)</p></li><li class="listitem"><p>Anonymous bean</p></li></ul></div></li><li class="listitem"><p>set-global</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>identifier = String (required)</p></li><li class="listitem"><p>reg = String (optional)</p></li><li class="listitem"><p>Anonymous bean</p></li></ul></div></li><li class="listitem"><p>fire-all-rules</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>max : n</p></li></ul></div></li><li class="listitem"><p>fire-until-halt</p></li><li class="listitem"><p>start-process</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>parameter</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>identifier = String (required)</p></li><li class="listitem"><p>ref = String (optional)</p></li><li class="listitem"><p>Anonymous bean</p></li></ul></div></li></ul></div></li><li class="listitem"><p>signal-event</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>ref = String (optional)</p></li><li class="listitem"><p>event-type = String (required)</p></li><li class="listitem"><p>process-instance-id =n (optional)</p></li></ul></div></li></ul></div></div></div><br class="figure-break"/><div class="example"><a id="d0e16008"/><p class="title"><strong>Example 13.16. Batch commands - example</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;kie:kmodule id="batch_commands_module"&gt;
  &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
    &lt;kie:ksession name="ksessionForCommands" type="stateful"&gt;
      &lt;kie:batch&gt;
        &lt;kie:insert-object ref="person2"/&gt;
        &lt;kie:set-global identifier="persons" ref="personsList"/&gt;
        &lt;kie:fire-all-rules max="10"/&gt;
      &lt;/kie:batch&gt;
    &lt;/kie:ksession&gt;
  &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div></div><br class="example-break"/></div><div class="section" title="13.2.11. Persistence"><div class="titlepage"><div><div><h3 class="title"><a id="d0e16013"/>13.2.11. Persistence</h3></div></div></div><div class="figure"><a id="d0e16016"/><p class="title"><strong>Figure 13.21. Persistence Configuration Options</strong></p><div class="figure-contents"><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>jpa-persistence</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>transaction-manager</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>ref = String</p></li></ul></div></li><li class="listitem"><p>entity-manager-factory</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>ref = String</p></li></ul></div></li></ul></div></li></ul></div></div></div><br class="figure-break"/><div class="example"><a id="d0e16038"/><p class="title"><strong>Example 13.17. ksession JPA configuration example</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;kie:kstore id="kstore" /&gt; &lt;!-- provides KnowledgeStoreService implementation --&gt;

&lt;bean id="myEmf" 
       class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"&gt;
   &lt;property name="dataSource" ref="ds" /&gt;
   &lt;property name="persistenceUnitName" 
       value="org.drools.persistence.jpa.local" /&gt;
&lt;/bean&gt;

&lt;bean id="txManager" class="org.springframework.orm.jpa.JpaTransactionManager"&gt;
   &lt;property name="entityManagerFactory" ref="myEmf" /&gt;
&lt;/bean&gt;

&lt;kie:kmodule id="persistence_module"&gt;
  &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
    &lt;kie:ksession name="jpaSingleSessionCommandService"&gt;
      &lt;kie:configuration&gt;
         &lt;kie:jpa-persistence&gt;
           &lt;kie:transaction-manager ref="txManager"/&gt;
           &lt;kie:entity-manager-factory ref="myEmf"/&gt;
         &lt;/kie:jpa-persistence&gt;
      &lt;/kie:configuration&gt;
    &lt;/kie:ksession&gt;
  &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor" 
          class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;
</code></pre></div></div><br class="example-break"/></div><div class="section" title="13.2.12. Leveraging Other Spring Features"><div class="titlepage"><div><div><h3 class="title"><a id="d0e16043"/>13.2.12. Leveraging Other Spring Features</h3></div></div></div><p>This section provides details on leveraging other standard spring features when integrating with Drools Expert.</p><div class="section" title="13.2.12.1. Using Spring Expressions (Spel)"><div class="titlepage"><div><div><h4 class="title"><a id="d0e16048"/>13.2.12.1. Using Spring Expressions (Spel) </h4></div></div></div><p/><pre><code class="language-xml">&lt;kie:kmodule id="batch_commands_module"&gt;
  &lt;kie:kbase name="drl_kiesample" packages="#{packageRepository.packages}"&gt;
    &lt;kie:ksession name="ksessionForCommands" type="stateful"/&gt;
  &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor"
      class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;

&lt;bean id="packageRepository" class="sample.package.class.PackageRepo"&gt;
  &lt;property name="packages" value="drl_kiesample3"&gt;
&lt;/bean&gt;
          </code></pre><p/><pre><code class="language-xml">&lt;kie:kmodule id="loggers_module"&gt;
  &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
    &lt;kie:ksession name="ConsoleLogger-statefulSession" type="stateful"&gt;
      &lt;kie:fileLogger id="fl" file="#{ systemProperties['java.io.tmpdir'] }/log1"/&gt;
      &lt;kie:fileLogger id="tfl" file="#{ systemProperties['java.io.tmpdir'] }/log2"
            threaded="true" interval="5"/&gt;
    &lt;/kie:ksession&gt;
  &lt;/kie:kbase&gt;
&lt;/kie:kmodule&gt;

&lt;bean id="kiePostProcessor"
            class="org.kie.spring.KModuleBeanFactoryPostProcessor"/&gt;</code></pre></div><div class="section" title="13.2.12.2. Using Spring Profiles"><div class="titlepage"><div><div><h4 class="title"><a id="d0e16057"/>13.2.12.2. Using Spring Profiles </h4></div></div></div><p>Spring 3.1 introduces a new profile attribute to the beans element of the spring-beans schema.
          This attribute acts as a switch when enabling and disabling profiles in different environments. One potential use of this attribute
        can be to have the same kbase defined with debug loggers in 'dev' environment and without loggers in 'prod' environment.</p><p>
          The below code snippet illustrates the concept of 'profiles'.
        </p><pre><code class="language-xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xmlns:kie="http://drools.org/schema/kie-spring"
xsi:schemaLocation="http://www.springframework.org/schema/beans
http://www.springframework.org/schema/beans/spring-beans-4.0.xsd
http://drools.org/schema/kie-spring http://drools.org/schema/kie-spring.xsd"&gt;
  &lt;beans profile="development"&gt;
    &lt;kie:kmodule id="test-kmodule"&gt;
      &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
        &lt;kie:ksession name="ksession1" type="stateless"&gt;
            &lt;kie:consoleLogger /&gt;
        &lt;/kie:ksession&gt;
      &lt;/kie:kbase&gt;
    &lt;/kie:kmodule&gt;
    ...
  &lt;/beans&gt;

  &lt;beans profile="production"&gt;
    &lt;kie:kmodule id="test-kmodule"&gt;
      &lt;kie:kbase name="drl_kiesample" packages="drl_kiesample"&gt;
        &lt;kie:ksession name="ksession1" type="stateless"/&gt;
      &lt;/kie:kbase&gt;
    &lt;/kie:kmodule&gt;
    ...
  &lt;/beans&gt;
&lt;/beans&gt;</code></pre></div><p>
        As shown above, the Spring XML contains the definition of the profiles. While loading the <span class="emphasis"><em>ApplicationContext</em></span>
        you have to tell Spring which profile you’re loading.
      </p><p>
        There are several ways of selecting your profile and the most useful is by using the "spring.profiles.active" system property.
      </p><pre><code class="no-highlight">System.setProperty("spring.profiles.active", "development");
ApplicationContext ctx = new ClassPathXmlApplicationContext("beans.xml");</code></pre><p>
        Obviously, it is not a good practice to hard code things as shown above and the recommended practice is to keep the system
        properties definitions independent of the application.
      </p><pre><code class="no-highlight">-Dspring.profiles.active="development"</code></pre><p>
        The profiles can also be loaded and enabled programmtically
      </p><pre><code class="no-highlight">...
GenericXmlApplicationContext ctx = new GenericXmlApplicationContext("beans.xml");
ConfigurableEnvironment env = ctx.getEnvironment();
env.setActiveProfiles("development");
ctx.refresh();
...
      </code></pre></div></div><div class="section" title="13.3. Integration with jBPM Human Task"><div class="titlepage"><div><div><h2 class="title"><a id="d0e16083"/>13.3. Integration with jBPM Human Task</h2></div></div></div><p>This chapter describes the infrastructure used when configuring a
    human task server with Spring as well as a little bit about the
    infrastructure used when doing this.</p><div class="section" title="13.3.1. How to configure Spring with jBPM Human task"><div class="titlepage"><div><div><h3 class="title"><a id="d0e16088"/>13.3.1. How to configure Spring with jBPM Human task</h3></div></div></div><p>The jBPM human task server can be configured to use Spring
      persistence. <a class="xref" href="ch13.html#kie-spring-human-task-example" title="Example 13.18. Configuring Human Task with Spring">Example 13.18, “Configuring Human Task with Spring”</a> is an
      example of this which uses local transactions and Spring's thread-safe
      EntityManager proxy.</p><p>The following diagram shows the dependency graph used in <a class="xref" href="ch13.html#kie-spring-human-task-example" title="Example 13.18. Configuring Human Task with Spring">Example 13.18, “Configuring Human Task with Spring”</a>.</p><div class="figure"><a id="d0e16099"/><p class="title"><strong>Figure 13.22. Spring Human Task integration injection dependencies</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Spring/ht-spring-deps.png" align="middle" alt="Spring Human Task integration injection dependencies"/></div></div></div><br class="figure-break"/><p>A <code class="code">TaskService</code> instance is dependent on two other bean
      types: a drools <code class="code">SystemEventListener</code> bean as well as a
      <code class="code">TaskSessionSpringFactoryImpl</code> bean. The
      <code class="code">TaskSessionSpringFactoryImpl</code> bean is howerver
      <span class="emphasis"><em>not</em></span> injected into the <code class="code">TaskService</code> bean
      because this would cause a circular dependency. To solve this problem,
      when the <code class="code">TaskService</code> bean is injected into the
      <code class="code">TaskSessionSpringFactoryImpl</code> bean, the setter method used
      secretly injects the <code class="code">TaskSessionSpringFactoryImpl</code> instance
      back into the <code class="code">TaskService</code> bean and initializes the
      <code class="code">TaskService</code> bean as well.</p><p>The <code class="code">TaskSessionSpringFactoryImpl</code> bean is responsible
      for creating all the internal instances in human task that deal with
      transactions and persistence context management. Besides a
      <code class="code">TaskService</code> instance, this bean also requires a transaction
      manager and a persistence context to be injected. Specifically, it
      requires an instance of a <code class="code">HumanTaskSpringTransactionManager</code>
      bean (as a transaction manager) and an instance of a
      <code class="code">SharedEntityManagerBean</code> bean (as a persistence context
      instance).</p><p>We also use some of the standard Spring beans in order to
      configure persistence: there's a bean to hold the
      <code class="code">EntityManagerFactory</code> instance as well as the
      <code class="code">SharedEntityManagerBean</code> instance. The
      <code class="code">SharedEntityManagerBean</code> provides a shared, thread-safe
      proxy for the actual <code class="code">EntityManager</code>.</p><p>The <code class="code">HumanTaskSpringTransactionManager</code> bean serves as
      a wrapper around the Spring transaction manager, in this case the
      <code class="code">JpaTransactionManager</code>. An instance of a
      <code class="code">JpaTransactionManager</code> bean is also instantiated because of
      this.</p><div class="example"><a id="kie-spring-human-task-example"/><p class="title"><strong>Example 13.18. Configuring Human Task with Spring</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jbpm="http://drools.org/schema/drools-spring"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
       http://drools.org/schema/drools-spring org/drools/container/spring/drools-spring-1.2.0.xsd"&gt;

  &lt;!-- persistence &amp; transactions--&gt;
  &lt;bean id="htEmf" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"&gt;
    &lt;property name="persistenceUnitName" value="org.jbpm.task" /&gt;
  &lt;/bean&gt;

  &lt;bean id="htEm" class="org.springframework.orm.jpa.support.SharedEntityManagerBean"&gt;
    &lt;property name="entityManagerFactory" ref="htEmf"/&gt;
  &lt;/bean&gt;

  &lt;bean id="jpaTxMgr" class="org.springframework.orm.jpa.JpaTransactionManager"&gt;
    &lt;property name="entityManagerFactory" ref="htEmf" /&gt;
    &lt;!-- this must be true if using the SharedEntityManagerBean, and false otherwise --&gt;
    &lt;property name="nestedTransactionAllowed" value="true"/&gt;
  &lt;/bean&gt;

  &lt;bean id="htTxMgr" class="org.drools.container.spring.beans.persistence.HumanTaskSpringTransactionManager"&gt;
    &lt;constructor-arg ref="jpaTxMgr" /&gt;
  &lt;/bean&gt;

  &lt;!-- human-task beans --&gt;

  &lt;bean id="systemEventListener" class="org.drools.SystemEventListenerFactory" factory-method="getSystemEventListener" /&gt;

  &lt;bean id="taskService" class="org.jbpm.task.service.TaskService" &gt;
    &lt;property name="systemEventListener" ref="systemEventListener" /&gt;
  &lt;/bean&gt;

  &lt;bean id="springTaskSessionFactory" class="org.jbpm.task.service.persistence.TaskSessionSpringFactoryImpl"
        init-method="initialize" depends-on="taskService" &gt;
    &lt;!-- if using the SharedEntityManagerBean, make sure to enable nested transactions --&gt;
    &lt;property name="entityManager" ref="htEm" /&gt;
    &lt;property name="transactionManager" ref="htTxMgr" /&gt;
    &lt;property name="useJTA" value="false" /&gt;
    &lt;property name="taskService" ref="taskService" /&gt;
  &lt;/bean&gt;

&lt;/beans&gt;
</code></pre></div></div><br class="example-break"/><p>When using the <code class="code">SharedEntityManagerBean</code> instance, it's
      important to configure the Spring transaction manager to use nested
      transactions. This is because the <code class="code">SharedEntityManagerBean</code>
      is a <span class="emphasis"><em>transactional</em></span> persistence context and will
      close the persistence context after every operation. However, the human
      task server needs to be able to access (persisted) entities after
      operations. Nested transactions allow us to still have access to
      entities that otherwise would have been detached and are no longer
      accessible, especially when using an ORM framework that uses
      lazy-initialization of entities.</p><p>Also, while the <code class="code">TaskSessionSpringFactoryImpl</code> bean
      takes an <span class="quote">“<span class="quote">useJTA</span>”</span> parameter, at the moment, JTA
      transactions with Spring have not yet been fully tested.</p></div></div></div><script type="text/javascript" src="highlight.js/highlight.pack.js"> </script><script type="text/javascript">hljs.initHighlightingOnLoad();</script><ul class="docnav"><li class="previous"><a accesskey="p" href="ch12.html"><strong>Prev</strong>Chapter 12. CDI</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="ch14.html"><strong>Next</strong>Chapter 14. Android Integration</a></li></ul></body></html>