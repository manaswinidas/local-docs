<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 23. Examples</title><link rel="stylesheet" type="text/css" href="css/jbossorg.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"/><link rel="home" href="index.html" title="Drools Documentation"/><link rel="up" href="pt07.html" title="Part VII. Drools Examples"/><link rel="prev" href="pt07.html" title="Part VII. Drools Examples"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><p id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="pt07.html"><strong>Prev</strong></a></li><li class="next"/></ul><div class="chapter" title="Chapter 23. Examples"><div class="titlepage"><div><div><h2 class="title"><a id="d0e25915"/>Chapter 23. Examples</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ch23.html#d0e25918">23.1. Getting the Examples</a></span></dt><dt><span class="section"><a href="ch23.html#d0e25925">23.2. Hello World</a></span></dt><dt><span class="section"><a href="ch23.html#d0e26213">23.3. State Example</a></span></dt><dd><dl><dt><span class="section"><a href="ch23.html#d0e26218">23.3.1. Understanding the State Example</a></span></dt></dl></dd><dt><span class="section"><a href="ch23.html#d0e26472">23.4. Fibonacci Example</a></span></dt><dt><span class="section"><a href="ch23.html#d0e26678">23.5. Banking Tutorial</a></span></dt><dt><span class="section"><a href="ch23.html#d0e27005">23.6. Pricing Rule Decision Table Example</a></span></dt><dd><dl><dt><span class="section"><a href="ch23.html#d0e27029">23.6.1. Executing the example</a></span></dt><dt><span class="section"><a href="ch23.html#d0e27071">23.6.2. The decision table</a></span></dt></dl></dd><dt><span class="section"><a href="ch23.html#d0e27136">23.7. Pet Store Example</a></span></dt><dt><span class="section"><a href="ch23.html#d0e27716">23.8. Honest Politician Example</a></span></dt><dt><span class="section"><a href="ch23.html#d0e27845">23.9. Sudoku Example</a></span></dt><dd><dl><dt><span class="section"><a href="ch23.html#d0e27866">23.9.1. Sudoku Overview</a></span></dt><dt><span class="section"><a href="ch23.html#d0e27880">23.9.2. Running the Example</a></span></dt><dt><span class="section"><a href="ch23.html#d0e27953">23.9.3. Java Source and Rules Overview</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28083">23.9.4. Sudoku Validator Rules (validate.drl)</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28092">23.9.5. Sudoku Solving Rules (sudoku.drl)</a></span></dt></dl></dd><dt><span class="section"><a href="ch23.html#d0e28128">23.10. Number Guess</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28419">23.11. Conway's Game Of Life</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28568">23.12. Invaders</a></span></dt><dd><dl><dt><span class="section"><a href="ch23.html#d0e28601">23.12.1. Invaders1Main</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28613">23.12.2. Invaders2Main</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28623">23.12.3. Invaders3Main</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28633">23.12.4. Invaders4Main</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28643">23.12.5. Invaders5Main</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28648">23.12.6. Invaders6Main</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28653">23.12.7. Invaders4Main</a></span></dt></dl></dd><dt><span class="section"><a href="ch23.html#d0e28663">23.13. Adventures with Drools</a></span></dt><dd><dl><dt><span class="section"><a href="ch23.html#d0e28691">23.13.1. Using the game.</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28725">23.13.2. The code</a></span></dt></dl></dd><dt><span class="section"><a href="ch23.html#d0e28763">23.14. Pong</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28781">23.15. Wumpus World</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28828">23.16. Miss Manners and Benchmarking</a></span></dt><dd><dl><dt><span class="section"><a href="ch23.html#d0e28850">23.16.1. Introduction</a></span></dt><dt><span class="section"><a href="ch23.html#d0e28936">23.16.2. In depth Discussion</a></span></dt><dt><span class="section"><a href="ch23.html#d0e29146">23.16.3. Output Summary</a></span></dt></dl></dd><dt><span class="section"><a href="ch23.html#d0e29201">23.17. Backward-Chaining</a></span></dt><dd><dl><dt><span class="section"><a href="ch23.html#d0e29215">23.17.1. Backward-Chaining Systems</a></span></dt><dt><span class="section"><a href="ch23.html#d0e29220">23.17.2. Cloning Transitive Closures</a></span></dt><dt><span class="section"><a href="ch23.html#d0e29250">23.17.3. Defining a Query</a></span></dt><dt><span class="section"><a href="ch23.html#d0e29275">23.17.4. Transitive Closure Example</a></span></dt><dt><span class="section"><a href="ch23.html#d0e29347">23.17.5. Reactive Transitive Queries</a></span></dt><dt><span class="section"><a href="ch23.html#d0e29372">23.17.6. Queries with Unbound Arguments</a></span></dt><dt><span class="section"><a href="ch23.html#d0e29391">23.17.7. Multiple Unbound Arguments</a></span></dt></dl></dd></dl></div><div class="section" title="23.1. Getting the Examples"><div class="titlepage"><div><div><h2 class="title"><a id="d0e25918"/>23.1. Getting the Examples</h2></div></div></div><p>Make sure the Drools Eclipse plugin is installed, which
      needs the Graphical Editing Framework (GEF) dependency installed
                        first. Then download and extract the
      drools-examples zip file, which includes an already created Eclipse
      project. Import that project into a new Eclipse workspace. The rules
      all have example classes that execute the rules. If you want to try
      the examples in another project (or another IDE) then you will need
      to set up the dependencies by hand, of course. Many, but not all of the
      examples are documented below, enjoy!</p><p>Some examples require Java 1.6 to run.</p></div><div class="section" title="23.2. Hello World"><div class="titlepage"><div><div><h2 class="title"><a id="d0e25925"/>23.2. Hello World</h2></div></div></div><pre class="screen"><span class="bold"><strong>Name:</strong></span> Hello World
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.helloworld.HelloWorldExample
<span class="bold"><strong>Module:</strong></span> drools-examples
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> HelloWorld.drl
<span class="bold"><strong>Objective:</strong></span> demonstrate basic rules in use</pre><p>The "Hello World" example shows a simple application using rules, written both using the MVEL and the Java
    dialects.</p><p>This example demonstrates how to create and use a <code class="code">KieSession</code>. Also, audit logging and debug outputs
    are shown, which is omitted from other examples as it's all very similar. </p><p>The following code snippet shows how the session is created with only 3 lines of code. </p><div class="example"><a id="d0e25956"/><p class="title"><strong>Example 23.1. HelloWorld: Creating the KieSession</strong></p><div class="example-contents"><pre><code class="language-java">        KieServices ks = KieServices.Factory.get();<a class="co" id="co.helloworld.pl.1" href="ch23.html#helloworld.pl.1"><img src="images/callouts/1.png" alt="1" border="0"/></a>
        KieContainer kc = ks.getKieClasspathContainer();<a class="co" id="co.helloworld.pl.2" href="ch23.html#helloworld.pl.2"><img src="images/callouts/2.png" alt="2" border="0"/></a>
        KieSession ksession = kc.newKieSession("HelloWorldKS");<a class="co" id="co.helloworld.pl.3" href="ch23.html#helloworld.pl.3"><img src="images/callouts/3.png" alt="3" border="0"/></a> </code></pre></div></div><br class="example-break"/><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a id="helloworld.pl.1"/><a href="#co.helloworld.pl.1"><img src="images/callouts/1.png" alt="1" border="0"/></a> </p></td><td valign="top" align="left"><p>Obtains the <code class="code">KieServices</code> factory. This is the main interface applications use to interact with
        the engine.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a id="helloworld.pl.2"/><a href="#co.helloworld.pl.2"><img src="images/callouts/2.png" alt="2" border="0"/></a> </p></td><td valign="top" align="left"><p>Creates a <code class="code">KieContainer</code> from the project classpath. This will look for a
          <code class="filename">/META-INF/kmodule.xml</code> file to configure and instantiate the <code class="code">KieModule</code> into
        the <code class="code">KieContainer</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a id="helloworld.pl.3"/><a href="#co.helloworld.pl.3"><img src="images/callouts/3.png" alt="3" border="0"/></a> </p></td><td valign="top" align="left"><p>Creates a session based on the named "HelloWorldKS" session configuration.</p></td></tr></table></div><p>Drools has an event model that exposes much of what's happening internally. Two default debug listeners are
    supplied, <code class="code">DebugAgendaEventListener</code> and <code class="code">DebugWorkingMemoryEventListener</code> which print out
    debug event information to the <code class="code">System.err</code> stream displayed in the Console window. Adding listeners to a
    Session is trivial, as shown in the next snippet. The <code class="code">KieRuntimeLogger</code> provides execution auditing, the
    result of which can be viewed in a graphical viewer. The logger is actually a specialised implementation built on
    the <code class="code">Agenda</code> and <code class="code">RuleRuntime</code> listeners. When the engine has finished executing,
      <code class="code">logger.close()</code> must be called.</p><p>Most of the examples use the Audit logging features of Drools to
  record execution flow for later inspection.</p><div class="example"><a id="d0e26017"/><p class="title"><strong>Example 23.2. HelloWorld: Event logging and Auditing</strong></p><div class="example-contents"><pre><code class="language-java">        // The application can also setup listeners
        ksession.addEventListener( new DebugAgendaEventListener() );
        ksession.addEventListener( new DebugRuleRuntimeEventListener() );

        // To setup a file based audit logger, uncomment the next line 
        // KieRuntimeLogger logger = ks.getLoggers().newFileLogger( ksession, "./helloworld" );
        
        // To setup a ThreadedFileLogger, so that the audit view reflects events whilst debugging,
        // uncomment the next line
        // KieRuntimeLogger logger = ks.getLoggers().newThreadedFileLogger( ksession, "./helloworld", 1000 );</code></pre></div></div><br class="example-break"/><p>The single class used in this example is very simple. It has two fields: the message, which is a
      <code class="code">String</code> and the status which can be one of the two integers <code class="code">HELLO</code> or
    <code class="code">GOODBYE</code>.</p><div class="example"><a id="d0e26033"/><p class="title"><strong>Example 23.3. HelloWorld example: Message Class</strong></p><div class="example-contents"><pre><code class="language-java">public static class Message {
    public static final int HELLO   = 0;
    public static final int GOODBYE = 1;

    private String          message;
    private int             status; 
    ...
}</code></pre></div></div><br class="example-break"/><p>A single <code class="code">Message</code> object is created with the message text "Hello World" and the status
      <code class="code">HELLO</code> and then inserted into the engine, at which point <code class="code">fireAllRules()</code> is executed. </p><div class="example"><a id="d0e26049"/><p class="title"><strong>Example 23.4. HelloWorld: Execution</strong></p><div class="example-contents"><pre><code class="language-java">        // The application can insert facts into the session
        final Message message = new Message();
        message.setMessage( "Hello World" );
        message.setStatus( Message.HELLO );
        ksession.insert( message );

        // and fire the rules
        ksession.fireAllRules();</code></pre></div></div><br class="example-break"/><p>To execute the example as a Java application:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Open the class <code class="code">org.drools.examples.helloworld.HelloWorldExample</code> in your Eclipse IDE</p></li><li class="listitem"><p>Right-click the class and select "Run as..." and then "Java
      application"</p></li></ol></div><p>If we put a breakpoint on the <code class="code">fireAllRules()</code> method and select the <code class="code">ksession</code> variable,
    we can see that the "Hello World" rule is already activate on the Agenda.</p><div class="figure"><a id="d0e26074"/><p class="title"><strong>Figure 23.1. Hello World: fireAllRules Agenda View</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/HelloWorldExample/helloworld_agenda1.png" alt="Hello World: fireAllRules Agenda View"/></div></div></div><br class="figure-break"/><p>The application print outs go to to <code class="code">System.out</code> while the debug listener print outs go to
      <code class="code">System.err</code>.</p><div class="example"><a id="d0e26088"/><p class="title"><strong>Example 23.5. HelloWorld: System.out in the Console window</strong></p><div class="example-contents"><pre><code class="no-highlight">Hello World
Goodbye cruel world</code></pre></div></div><br class="example-break"/><div class="example"><a id="d0e26093"/><p class="title"><strong>Example 23.6. HelloWorld: System.err in the Console window</strong></p><div class="example-contents"><pre><code class="no-highlight">==&gt;[ActivationCreated(0): rule=Hello World; 
                   tuple=[fid:1:1:org.drools.examples.helloworld.HelloWorldExample$Message@17cec96]]
[ObjectInserted: handle=[fid:1:1:org.drools.examples.helloworld.HelloWorldExample$Message@17cec96];
                 object=org.drools.examples.helloworld.HelloWorldExample$Message@17cec96]
[BeforeActivationFired: rule=Hello World; 
                   tuple=[fid:1:1:org.drools.examples.helloworld.HelloWorldExample$Message@17cec96]]
==&gt;[ActivationCreated(4): rule=Good Bye; 
                   tuple=[fid:1:2:org.drools.examples.helloworld.HelloWorldExample$Message@17cec96]]
[ObjectUpdated: handle=[fid:1:2:org.drools.examples.helloworld.HelloWorldExample$Message@17cec96];
                old_object=org.drools.examples.helloworld.HelloWorldExample$Message@17cec96;
                new_object=org.drools.examples.helloworld.HelloWorldExample$Message@17cec96]
[AfterActivationFired(0): rule=Hello World]
[BeforeActivationFired: rule=Good Bye; 
                   tuple=[fid:1:2:org.drools.examples.helloworld.HelloWorldExample$Message@17cec96]]
[AfterActivationFired(4): rule=Good Bye]  </code></pre></div></div><br class="example-break"/><p>The actual rules are inside the file
      <code class="filename">src/main/resources/org/drools/examples/helloworld/HelloWorld.drl</code>:</p><div class="example"><a id="d0e26103"/><p class="title"><strong>Example 23.7. HelloWorld: rule "Hello World"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Hello World"
      dialect "mvel"
  when
      m : Message( status == Message.HELLO, message : message )
  then
      System.out.println( message ); 
      modify ( m ) { message = "Goodbye cruel world",
                     status = Message.GOODBYE };
end</code></pre></div></div><br class="example-break"/><p>The LHS (after <code class="literal">when</code>) section of the rule states that it will be activated for each
      <code class="code">Message</code> object inserted into the Rule Runtime whose status is <code class="code">Message.HELLO</code>. Besides
    that, two variable bindings are created: the variable <code class="code">message</code> is bound to the <code class="code">message</code>
    attribute and the variable <code class="code">m</code> is bound to the matched <code class="code">Message</code> object itself.</p><p>The RHS (after <code class="literal">then</code>) or consequence part of the rule is written using the MVEL expression
    language, as declared by the rule's attribute <code class="code">dialect</code>. After printing the content of the bound variable
      <code class="code">message</code> to <code class="code">System.out</code>, the rule changes the values of the <code class="code">message</code> and
      <code class="code">status</code> attributes of the <code class="code">Message</code> object bound to <code class="code">m</code>. This is done using
    MVEL's <code class="literal">modify</code> statement, which allows you to apply a block of assignments in one statement, with
    the engine being automatically notified of the changes at the end of the block.</p><p>It is possible to set a breakpoint into the DRL, on the <code class="literal">modify</code> call, and inspect the Agenda
    view again during the execution of the rule's consequence. This time we start the execution via "Debug As" and
    "Drools application" and not by running a "Java application":</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Open the class <code class="code">org.drools.examples.HelloWorld</code> in your
      Eclipse IDE.</p></li><li class="listitem"><p>Right-click the class and select "Debug as..." and then "Drools
      application".</p></li></ol></div><p>Now we can see that the other rule <code class="code">"Good Bye"</code>, which
  uses the Java dialect, is activated and placed on the Agenda.</p><div class="figure"><a id="d0e26180"/><p class="title"><strong>Figure 23.2. Hello World: rule "Hello World" Agenda View</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/HelloWorldExample/helloworld_agenda2.png" alt="Hello World: rule &#34;Hello World&#34; Agenda View"/></div></div></div><br class="figure-break"/><p>The "Good Bye" rule, which specifies the "java" dialect, is similar
  to the "Hello World" rule except that it matches <code class="code">Message</code>
  objects whose  status is <code class="code">Message.GOODBYE</code>.</p><div class="example"><a id="d0e26194"/><p class="title"><strong>Example 23.8. HelloWorld: rule "Good Bye"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Good Bye"
      dialect "java"
  when
      Message( status == Message.GOODBYE, message : message )
  then
      System.out.println( message ); 
end</code></pre></div></div><br class="example-break"/><p>The Java code that instantiates the <code class="code">KieRuntimeLogger</code> creates an audit log file that can be loaded
    into the Audit view. The Audit view is used in many of the examples to demonstrate the example execution flow. In
    the view screen shot below we can see that the object is inserted, which creates an activation for the "Hello World"
    rule; the activation is then executed which updates the <code class="code">Message</code> object causing the "Good Bye" rule to
    activate; finally the "Good Bye" rule also executes. Selecting an event in the Audit view highlights the origin
    event in green; therefore the "Activation created" event is highlighted in green as the origin of the "Activation
    executed" event.</p><div class="figure"><a id="d0e26207"/><p class="title"><strong>Figure 23.3. Hello World: Audit View</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/HelloWorldExample/helloworld_auditview1.png" alt="Hello World: Audit View"/></div></div></div><br class="figure-break"/></div><div class="section" title="23.3. State Example"><div class="titlepage"><div><div><h2 class="title"><a id="d0e26213"/>23.3. State Example</h2></div></div></div><p>This example is implemented in two different versions to demonstrate different ways of implementing the same
    basic behavior: forward chaining, i.e., the ability the engine has to evaluate, activate and fire rules in sequence,
    based on changes on the facts in the Working Memory.</p><div class="section" title="23.3.1. Understanding the State Example"><div class="titlepage"><div><div><h3 class="title"><a id="d0e26218"/>23.3.1. Understanding the State Example</h3></div></div></div><pre class="screen"><span class="bold"><strong>Name:</strong></span> State Example
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.state.StateExampleUsingSalience
<span class="bold"><strong>Module:</strong></span> drools-examples
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> StateExampleUsingSalience.drl
<span class="bold"><strong>Objective:</strong></span> Demonstrates basic rule use and Conflict Resolution for rule firing priority.</pre><p>Each <code class="code">State</code> class has fields for its name and its current state (see the class
        <code class="code">org.drools.examples.state.State</code>). The two possible states for each objects are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="code">NOTRUN</code></p></li><li class="listitem"><p><code class="code">FINISHED</code></p></li></ul></div><div class="example"><a id="d0e26257"/><p class="title"><strong>Example 23.9. State Class</strong></p><div class="example-contents"><pre><code class="language-java">public class State {
    public static final int NOTRUN   = 0;
    public static final int FINISHED = 1;

    private final PropertyChangeSupport changes =
        new PropertyChangeSupport( this );

    private String name;
    private int    state;

    ... setters and getters go here...
}</code></pre></div></div><br class="example-break"/><p>Ignoring the <code class="code">PropertyChangeSupport</code>, which will be explained later, we see the creation of four
        <code class="code">State</code> objects named A, B, C and D. Initially their states are set to <code class="code">NOTRUN</code>, which is
      default for the used constructor. Each instance is asserted in turn into the Session and then
        <code class="code">fireAllRules()</code> is called.</p><div class="example"><a id="d0e26276"/><p class="title"><strong>Example 23.10. Salience State: Execution</strong></p><div class="example-contents"><pre><code class="language-java">        final State a = new State( "A" );
        final State b = new State( "B" );
        final State c = new State( "C" );
        final State d = new State( "D" );

        ksession.insert( a );
        ksession.insert( b );
        ksession.insert( c );
        ksession.insert( d );

        ksession.fireAllRules();

        ksession.dispose(); // Stateful rule session must always be disposed when finished  </code></pre></div></div><br class="example-break"/><p>To execute the application:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Open the class <code class="code">org.drools.examples.state.StateExampleUsingSalience</code> in your Eclipse
          IDE.</p></li><li class="listitem"><p>Right-click the class and select "Run as..." and then "Java application"</p></li></ol></div><p>You will see the following output in the Eclipse console window:</p><div class="example"><a id="d0e26295"/><p class="title"><strong>Example 23.11. Salience State: Console Output</strong></p><div class="example-contents"><pre><code class="no-highlight">A finished
B finished
C finished
D finished
</code></pre></div></div><br class="example-break"/><p>There are four rules in total. First, the <code class="code">Bootstrap</code> rule fires, setting A to state
        <code class="code">FINISHED</code>, which then causes B to change its state to <code class="code">FINISHED</code>. C and D are both
      dependent on B, causing a conflict which is resolved by the salience values. Let's look at the way this was
      executed.</p><p>The best way to understand what is happening is to use the Audit Logging feature to graphically see the
      results of each operation. To view the Audit log generated by a run of this example:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>If the Audit View is not visible, click on "Window" and then select "Show View", then "Other..." and
          "Drools" and finally "Audit View".</p></li><li class="listitem"><p>In the "Audit View" click the "Open Log" button and select the file
          "&lt;drools-examples-dir&gt;/log/state.log".</p></li></ol></div><p>After that, the "Audit view" will look like the following screenshot:</p><div class="figure"><a id="d0e26322"/><p class="title"><strong>Figure 23.4. Salience State Example Audit View</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/StateExample/state_example_audit1.png" alt="Salience State Example Audit View"/></div></div></div><br class="figure-break"/><p>Reading the log in the "Audit View", top to bottom, we see every action and the corresponding changes in the
      Working Memory. This way we observe that the assertion of the State object A in the state <code class="code">NOTRUN</code>
      activates the <code class="code">Bootstrap</code> rule, while the assertions of the other <code class="code">State</code> objects have no
      immediate effect.</p><div class="example"><a id="d0e26339"/><p class="title"><strong>Example 23.12. Salience State: Rule "Bootstrap"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule Bootstrap
    when
        a : State(name == "A", state == State.NOTRUN )
    then
        System.out.println(a.getName() + " finished" );
        a.setState( State.FINISHED );
end</code></pre></div></div><br class="example-break"/><p>The execution of rule Bootstrap changes the state of A to <code class="code">FINISHED</code>, which, in turn, activates
      rule "A to B".</p><div class="example"><a id="d0e26349"/><p class="title"><strong>Example 23.13. Salience State: Rule "A to B"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "A to B"
    when
        State(name == "A", state == State.FINISHED )
        b : State(name == "B", state == State.NOTRUN )
    then
        System.out.println(b.getName() + " finished" );
        b.setState( State.FINISHED );
end
</code></pre></div></div><br class="example-break"/><p>The execution of rule "A to B" changes the state of B to <code class="code">FINISHED</code>, which activates both, rules "B
      to C" and "B to D", placing their Activations onto the Agenda. From this moment on, both rules may fire and,
      therefore, they are said to be "in conflict". The conflict resolution strategy allows the engine's Agenda to
      decide which rule to fire. As rule "B to C" has the <span class="bold"><strong>higher salience value</strong></span> (10
      versus the default salience value of 0), it fires first, modifying object C to state <code class="code">FINISHED</code>. The
      Audit view shown above reflects the modification of the <code class="code">State</code> object in the rule "A to B", which
      results in two activations being in conflict. The Agenda view can also be used to investigate the state of the
      Agenda, with debug points being placed in the rules themselves and the Agenda view opened. The screen shot below
      shows the breakpoint in the rule "A to B" and the state of the Agenda with the two conflicting rules.</p><div class="figure"><a id="d0e26368"/><p class="title"><strong>Figure 23.5. State Example Agenda View</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/StateExample/state_example_agenda1.png" alt="State Example Agenda View"/></div></div></div><br class="figure-break"/><div class="example"><a id="d0e26374"/><p class="title"><strong>Example 23.14. Salience State: Rule "B to C"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "B to C"
        salience 10
    when
        State(name == "B", state == State.FINISHED )
        c : State(name == "C", state == State.NOTRUN )
    then
        System.out.println(c.getName() + " finished" );
        c.setState( State.FINISHED );
end
</code></pre></div></div><br class="example-break"/><p>Rule "B to D" fires last, modifying object D to state <code class="code">FINISHED</code>.</p><div class="example"><a id="d0e26384"/><p class="title"><strong>Example 23.15. Salience State: Rule "B to D"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "B to D"
    when
        State(name == "B", state == State.FINISHED )
        d : State(name == "D", state == State.NOTRUN )
    then
        System.out.println(d.getName() + " finished" );
        d.setState( State.FINISHED );
end</code></pre></div></div><br class="example-break"/><p>There are no more rules to execute and so the engine stops.</p><p>Another notable concept in this example is the use of <span class="emphasis"><em>dynamic facts</em></span>, based on
        <code class="code">PropertyChangeListener</code> objects. As described in the documentation, in order for the engine to see
      and react to changes of fact properties, the application must tell the engine that changes occurred. This can be
      done explicitly in the rules by using the <code class="literal">modify</code> statement, or implicitly by letting the engine
      know that the facts implement <code class="code">PropertyChangeSupport</code> as defined by the <span class="emphasis"><em>JavaBeans
        specification</em></span>. This example demonstrates how to use <code class="code">PropertyChangeSupport</code> to avoid the
      need for explicit <code class="literal">modify</code> statements in the rules. To make use of this feature, ensure that your
      facts implement <code class="code">PropertyChangeSupport</code>, the same way the class <code class="code">org.drools.example.State</code>
      does, and use the following code in the rules file to configure the engine to listen for property changes on those
      facts:</p><div class="example"><a id="d0e26420"/><p class="title"><strong>Example 23.16. Declaring a Dynamic Fact</strong></p><div class="example-contents"><pre><code class="language-java">declare type State
    @propertyChangeSupport
end</code></pre></div></div><br class="example-break"/><p>When using <code class="code">PropertyChangeListener</code> objects, each setter must implement a little extra code for the
      notification. Here is the setter for <code class="code">state</code> in the class <code class="code">org.drools.examples</code>:</p><div class="example"><a id="d0e26436"/><p class="title"><strong>Example 23.17. Setter Example with PropertyChangeSupport</strong></p><div class="example-contents"><pre><code class="language-java">public void setState(final int newState) {
    int oldState = this.state;
    this.state = newState;
    this.changes.firePropertyChange( "state",
                                     oldState,
                                     newState );
}</code></pre></div></div><br class="example-break"/><p>There are another class in this example: <code class="code">StateExampleUsingAgendaGroup</code>. It executes from A to B to
      C to D, as just shown, but <code class="code">StateExampleUsingAgendaGroup</code> uses agenda-groups to control the rule
      conflict and which one fires first. </p><p>Agenda groups are a way to partition the Agenda into groups and to control which groups can execute. By
      default, all rules are in the agenda group "MAIN". The "agenda-group" attribute lets you specify a different
      agenda group for the rule. Initially, a Working Memory has its focus on the Agenda group "MAIN". A group's rules
      will only fire when the group receives the focus. This can be achieved either ny using the method by
        <code class="code">setFocus()</code> or the rule attribute <code class="literal">auto-focus</code>. "auto-focus" means that the rule
      automatically sets the focus to its agenda group when the rule is matched and activated. It is this "auto-focus"
      that enables rule "B to C" to fire before "B to D".</p><div class="example"><a id="d0e26457"/><p class="title"><strong>Example 23.18. Agenda Group State Example: Rule "B to C"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "B to C"
      agenda-group "B to C"
      auto-focus true       
  when
      State(name == "B", state == State.FINISHED )      
      c : State(name == "C", state == State.NOTRUN )
  then
      System.out.println(c.getName() + " finished" );
      c.setState( State.FINISHED );
      kcontext.getKnowledgeRuntime().getAgenda().getAgendaGroup( "B to D" ).setFocus();
end</code></pre></div></div><br class="example-break"/><p>The rule "B to C" calls <code class="code">setFocus()</code> on the agenda group "B to D", allowing its active rules to
      fire, which allows the rule "B to D" to fire.</p><div class="example"><a id="d0e26467"/><p class="title"><strong>Example 23.19. Agenda Group State Example: Rule "B to D"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "B to D"
      agenda-group "B to D"
  when
      State(name == "B", state == State.FINISHED )      
      d : State(name == "D", state == State.NOTRUN )
  then
      System.out.println(d.getName() + " finished" );
      d.setState( State.FINISHED );
end</code></pre></div></div><br class="example-break"/></div></div><div class="section" title="23.4. Fibonacci Example"><div class="titlepage"><div><div><h2 class="title"><a id="d0e26472"/>23.4. Fibonacci Example</h2></div></div></div><pre class="screen"><span class="bold"><strong>Name:</strong></span> Fibonacci 
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.fibonacci.FibonacciExample
<span class="bold"><strong>Module:</strong></span> drools-examples
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> Fibonacci.drl
<span class="bold"><strong>Objective:</strong></span> Demonstrates Recursion,
  the CE <code class="literal">not</code> and cross product matching</pre><p>The Fibonacci Numbers (see <a class="link" href="http://en.wikipedia.org/wiki/Fibonacci_number">http://en.wikipedia.org/wiki/Fibonacci_number</a>)
      discovered by Leonardo of Pisa (see <a class="link" href="http://en.wikipedia.org/wiki/Fibonacci">http://en.wikipedia.org/wiki/Fibonacci</a>) is a sequence 
    that starts with 0 and 1. The next Fibonacci number is obtained by adding
    the two preceding Fibonacci numbers. The Fibonacci sequence begins with
    0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987, 1597,
    2584, 4181, 6765, 10946,... The Fibonacci Example demonstrates recursion
    and conflict resolution with salience values.</p><p>The single fact class <code class="code">Fibonacci</code> is used in this
    example. It has two fields, sequence and value. The sequence field
    is used to indicate the position of the object in the Fibonacci
    number sequence. The value field shows the value of that
    Fibonacci object for that sequence position, using -1 to indicate
    a value that still needs to be computed.</p><div class="example"><a id="d0e26510"/><p class="title"><strong>Example 23.20. Fibonacci Class</strong></p><div class="example-contents"><pre><code class="language-java">public static class Fibonacci {
    private int  sequence;
    private long value;

    public Fibonacci( final int sequence ) {
        this.sequence = sequence;
        this.value = -1;
    }

    ... setters and getters go here...
}</code></pre></div></div><br class="example-break"/><p>Execute the example:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Open the class <code class="classname">org.drools.examples.fibonacci.FibonacciExample</code> in your Eclipse IDE.</p></li><li class="listitem"><p>Right-click the class and select "Run as..." and then
        "Java application"</p></li></ol></div><p>Eclipse shows the following output in its console window (with
    "...snip..." indicating lines that were removed to save space):</p><div class="example"><a id="d0e26529"/><p class="title"><strong>Example 23.21. Fibonacci Example: Console Output</strong></p><div class="example-contents"><pre><code class="no-highlight">recurse for 50
recurse for 49
recurse for 48
recurse for 47
...snip...
recurse for 5
recurse for 4
recurse for 3
recurse for 2
1 == 1
2 == 1
3 == 2
4 == 3
5 == 5
6 == 8
...snip...
47 == 2971215073
48 == 4807526976
49 == 7778742049
50 == 12586269025
</code></pre></div></div><br class="example-break"/><p>To kick this off from Java we only insert a single Fibonacci
    object, with a sequence field of 50. A recursive rule is then used
    to insert the other 49 <code class="code">Fibonacci</code> objects. This example
    doesn't use
    <code class="code">PropertyChangeSupport</code>. It uses the MVEL dialect, which
    means we can use the <code class="literal">modify</code> keyword, which allows a block
    setter action which also notifies the engine of changes.</p><div class="example"><a id="d0e26545"/><p class="title"><strong>Example 23.22. Fibonacci Example: Execution</strong></p><div class="example-contents"><pre><code class="language-java">ksession.insert( new Fibonacci( 50 ) );
ksession.fireAllRules();</code></pre></div></div><br class="example-break"/><p>The rule Recurse is very simple. It matches each asserted
    <code class="code">Fibonacci</code> object with a value of -1, creating and 
    asserting a new <code class="code">Fibonacci</code> object with a sequence of
    one less than the currently matched object. Each time a Fibonacci
    object is added while the one with a sequence field equal to 1
    does not exist, the rule re-matches and fires again. The
    <code class="literal">not</code> conditional element is used to stop the rule's matching
    once we have all 50 Fibonacci objects in memory. The rule also has a
    salience value, because we need to have all 50 <code class="code">Fibonacci</code>
    objects asserted before we execute the Bootstrap rule.</p><div class="example"><a id="d0e26564"/><p class="title"><strong>Example 23.23. Fibonacci Example: Rule "Recurse"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule Recurse
    salience 10
    when
        f : Fibonacci ( value == -1 )
        not ( Fibonacci ( sequence == 1 ) )
    then
        insert( new Fibonacci( f.sequence - 1 ) );
        System.out.println( "recurse for " + f.sequence );
end</code></pre></div></div><br class="example-break"/><p>The Audit view shows the original assertion of the
    <code class="code">Fibonacci</code> object with a sequence field of 50, done from
    Java code. From there on, the Audit view shows the continual
    recursion of the rule, where each asserted <code class="code">Fibonacci</code>
    object causes the Recurse rule to become activated and to fire again.</p><div class="figure"><a id="d0e26577"/><p class="title"><strong>Figure 23.6. Fibonacci Example: "Recurse" Audit View 1</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/FibonacciExample/fibonacci1.png" alt="Fibonacci Example: &#34;Recurse&#34; Audit View 1"/></div></div></div><br class="figure-break"/><p>When a <code class="code">Fibonacci</code> object with a sequence field of 2 is
    asserted the "Bootstrap" rule is matched and activated along with the
    "Recurse" rule. Note the multi-restriction on field
    <code class="code">sequence</code>, testing for equality with 1 or 2.</p><div class="example"><a id="d0e26591"/><p class="title"><strong>Example 23.24. Fibonacci Example: Rule "Bootstrap"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule Bootstrap
    when
        f : Fibonacci( sequence == 1 || == 2, value == -1 ) // multi-restriction
    then 
        modify ( f ){ value = 1 };
        System.out.println( f.sequence + " == " + f.value );
end</code></pre></div></div><br class="example-break"/><p>At this point the Agenda looks as shown below. However,
    the "Bootstrap" rule does not fire because the "Recurse" rule has a higher
    salience.</p><div class="figure"><a id="d0e26598"/><p class="title"><strong>Figure 23.7. Fibonacci Example: "Recurse" Agenda View 1</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/FibonacciExample/fibonacci_agenda1.png" alt="Fibonacci Example: &#34;Recurse&#34; Agenda View 1"/></div></div></div><br class="figure-break"/><p>When a <code class="code">Fibonacci</code> object with a sequence of 1 is
    asserted the Bootstrap rule is matched again, causing two activations
    for this rule. Note that the "Recurse" rule does not match and activate
    because the <code class="literal">not</code> conditional element stops the rule's matching
    as soon as a <code class="code">Fibonacci</code> object with a sequence of 1
    exists.</p><div class="figure"><a id="d0e26615"/><p class="title"><strong>Figure 23.8. Fibonacci Example: "Recurse" Agenda View 2</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/FibonacciExample/fibonacci_agenda2.png" alt="Fibonacci Example: &#34;Recurse&#34; Agenda View 2"/></div></div></div><br class="figure-break"/><p>Once we have two <code class="code">Fibonacci</code> objects with values
    not equal to -1 the "Calculate" rule is able to match. It was
    the "Bootstrap" rule that set the objects with sequence 1 and 2 to
    values of 1. At this point we have 50 Fibonacci objects in the Working
    Memory. Now we need to select a suitable triple to calculate each
    of their values in turn. Using three Fibonacci patterns in a rule without
    field constraints to confine the possible cross products would result
    in 50x49x48 possible combinations, leading to about 125,000 possible rule
    firings, most of them incorrect. The "Calculate" rule uses field
    constraints to correctly constraint the thee Fibonacci patterns in the
    correct order; this
    technique is called <span class="emphasis"><em>cross product matching</em></span>. The
    first pattern finds any Fibonacci with a value != -1 and binds both
    the pattern and the field.  The second Fibonacci does this, too, but
    it adds an additional field constraint to ensure that its sequence is
    greater by one than the Fibonacci bound to <code class="code">f1</code>. When this
    rule fires for the first time, we know that only sequences 1 and 2
    have values of 1, and the two constraints ensure that <code class="code">f1</code>
    references sequence 1 and <code class="code">f2</code> references sequence 2. The
    final pattern finds the Fibonacci with a value equal to -1 and with a
    sequence one greater than <code class="code">f2</code>. At this point, we have
    three <code class="code">Fibonacci</code> objects correctly selected from the
    available cross products, and we can calculate the value for the
    third <code class="code">Fibonacci</code> object that's bound to <code class="code">f3</code>.</p><div class="example"><a id="d0e26650"/><p class="title"><strong>Example 23.25. Fibonacci Example: Rule "Calculate"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule Calculate
    when
        // Bind f1 and s1
        f1 : Fibonacci( s1 : sequence, value != -1 )
        // Bind f2 and v2; refer to bound variable s1
        f2 : Fibonacci( sequence == (s1 + 1), v2 : value != -1 )
        // Bind f3 and s3; alternative reference of f2.sequence
        f3 : Fibonacci( s3 : sequence == (f2.sequence + 1 ), value == -1 )      
    then
        // Note the various referencing techniques.
        modify ( f3 ) { value = f1.value + v2 };
        System.out.println( s3 + " == " + f3.value );
end 
</code></pre></div></div><br class="example-break"/><p>The <code class="literal">modify</code> statement updated the value of the
    <code class="code">Fibonacci</code> object bound to <code class="code">f3</code>. This means
    we now have another new Fibonacci object with a value not equal to -1,
    which allows the "Calculate" rule to rematch and calculate the next
    Fibonacci number. The Audit view below shows how the firing of the
    last "Bootstrap" modifies the <code class="code">Fibonacci</code> object,
    enabling the "Calculate" rule to match, which then modifies
    another Fibonacci object allowing the "Calculate" rule to match again.
    This continues till the value is set for all <code class="code">Fibonacci</code>
    objects.</p><div class="figure"><a id="d0e26672"/><p class="title"><strong>Figure 23.9. Fibonacci Example: "Bootstrap" Audit View</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/FibonacciExample/fibonacci4.png" alt="Fibonacci Example: &#34;Bootstrap&#34; Audit View"/></div></div></div><br class="figure-break"/></div><div class="section" title="23.5. Banking Tutorial"><div class="titlepage"><div><div><h2 class="title"><a id="d0e26678"/>23.5. Banking Tutorial</h2></div></div></div><pre class="screen"><span class="bold"><strong>Name:</strong></span> BankingTutorial
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.banking.BankingExamplesApp.java
<span class="bold"><strong>Module:</strong></span> drools-examples
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> org.drools.examples.banking.*.drl
<span class="bold"><strong>Objective:</strong></span> Demonstrate pattern matching, basic sorting and calculation rules.</pre><p>This tutorial demonstrates the process of developing a
    complete personal banking application to handle credits and debits on
    multiple accounts. It uses a set of design patterns that have
    been created for the process.</p><p>The class <code class="code">RuleRunner</code> is a simple harness to execute
    one or more DRL files against a set of data. It compiles the Packages 
    and creates the Knowledge Base for each execution, allowing us to
    easily execute each scenario and inspect the outputs. In reality this
    is not a good solution for a production system, where the Knowledge Base
    should be built just once and cached, but for the purposes of this
    tutorial it shall suffice.</p><div class="example"><a id="d0e26707"/><p class="title"><strong>Example 23.26. Banking Tutorial: RuleRunner</strong></p><div class="example-contents"><pre><code class="language-java">public class RuleRunner {

    public RuleRunner() {
    }

    public void runRules(String[] rules,
                         Object[] facts) throws Exception {

        KnowledgeBase kbase = KnowledgeBaseFactory.newKnowledgeBase();
        KnowledgeBuilder kbuilder = KnowledgeBuilderFactory.newKnowledgeBuilder();

        for ( int i = 0; i &lt; rules.length; i++ ) {
            String ruleFile = rules[i];
            System.out.println( "Loading file: " + ruleFile );
            kbuilder.add( ResourceFactory.newClassPathResource( ruleFile,
                                                                RuleRunner.class ),
                          ResourceType.DRL );
        }

        Collection&lt;KnowledgePackage&gt; pkgs = kbuilder.getKnowledgePackages();
        kbase.addKnowledgePackages( pkgs );
        StatefulKnowledgeSession ksession = kbase.newStatefulKnowledgeSession();

        for ( int i = 0; i &lt; facts.length; i++ ) {
            Object fact = facts[i];
            System.out.println( "Inserting fact: " + fact );
            ksession.insert( fact );
        }

        ksession.fireAllRules();
    }
}</code></pre></div></div><br class="example-break"/><p>The first of our sample Java classes loads and executes a single
    DRL file, <code class="filename">Example.drl</code>, but without inserting any
    data.</p><div class="example"><a id="d0e26717"/><p class="title"><strong>Example 23.27. Banking Tutorial : Java Example1</strong></p><div class="example-contents"><pre><code class="language-java">public class Example1 {
    public static void main(String[] args) throws Exception {
        new RuleRunner().runRules( new String[] { "Example1.drl" },
                                   new Object[0] );
    }
}</code></pre></div></div><br class="example-break"/><p>The first simple rule to execute has a single <code class="literal">eval</code>
    condition that will always be true, so that this rule will match and
    fire, once, after the start.</p><div class="example"><a id="d0e26727"/><p class="title"><strong>Example 23.28. Banking Tutorial: Rule in Example1.drl</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Rule 01"   
    when
        eval( 1==1 )
    then
        System.out.println( "Rule 01 Works" );
end</code></pre></div></div><br class="example-break"/><p>The output for the rule is below, showing that the rule matches
    and executes the single print statement.</p><div class="example"><a id="d0e26734"/><p class="title"><strong>Example 23.29. Banking Tutorial: Output of Example1.java</strong></p><div class="example-contents"><pre><code class="no-highlight">Loading file: Example1.drl
Rule 01 Works</code></pre></div></div><br class="example-break"/><p>The next step is to assert some simple facts and print them
    out.</p><div class="example"><a id="d0e26741"/><p class="title"><strong>Example 23.30. Banking Tutorial: Java Example2</strong></p><div class="example-contents"><pre><code class="language-java">public class Example2 {
    public static void main(String[] args) throws Exception {
        Number[] numbers = new Number[] {wrap(3), wrap(1), wrap(4), wrap(1), wrap(5)};
        new RuleRunner().runRules( new String[] { "Example2.drl" },
                                   numbers );
    }
    
    private static Integer wrap( int i ) {
        return new Integer(i);
    }
}</code></pre></div></div><br class="example-break"/><p>This doesn't use any specific facts but instead asserts a set
    of <code class="code">java.lang.Integer</code> objects. This is not considered
    "best practice" as a number is not a useful fact, but we use it here
    to demonstrate basic techniques before more complexity is added.</p><p>Now we will create a simple rule to print out these numbers.</p><div class="example"><a id="d0e26753"/><p class="title"><strong>Example 23.31. Banking Tutorial: Rule in Example2.drl</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Rule 02"
    when
        Number( $intValue : intValue )
    then
        System.out.println( "Number found with value: " + $intValue ); 
end</code></pre></div></div><br class="example-break"/><p>Once again, this rule does nothing special. It identifies any
    facts that are <code class="code">Number</code> objects and prints out the values.
    Notice the use of the abstract class <code class="code">Number</code>: we inserted
    <code class="code">Integer</code> objects but we now look for any kind of number.
    The pattern matching engine is able to match interfaces and
    superclasses of asserted objects.</p><p>The output shows the DRL being loaded, the facts inserted and
    then the matched and fired rules. We can see that each inserted number
    is matched and fired and thus printed.</p><div class="example"><a id="d0e26771"/><p class="title"><strong>Example 23.32. Banking Tutorial: Output of Example2.java</strong></p><div class="example-contents"><pre><code class="no-highlight">Loading file: Example2.drl
Inserting fact: 3
Inserting fact: 1
Inserting fact: 4
Inserting fact: 1
Inserting fact: 5
Number found with value: 5
Number found with value: 1
Number found with value: 4
Number found with value: 1
Number found with value: 3
</code></pre></div></div><br class="example-break"/><p>There are certainly many better ways to sort numbers than using
    rules, but since we will need to apply some cashflows in date order
    when we start looking at banking rules we'll develop simple rule
    based sorting technique.</p><div class="example"><a id="d0e26778"/><p class="title"><strong>Example 23.33. Banking Tutorial: Example3.java</strong></p><div class="example-contents"><pre><code class="language-java">public class Example3 {
    public static void main(String[] args) throws Exception {
        Number[] numbers = new Number[] {wrap(3), wrap(1), wrap(4), wrap(1), wrap(5)};
        new RuleRunner().runRules( new String[] { "Example3.drl" },
                                   numbers );
    }
    
    private static Integer wrap(int i) {
        return new Integer(i);
    }
}</code></pre></div></div><br class="example-break"/><p>Again we insert our <code class="code">Integer</code> objects, but this time the
    rule is slightly different:</p><div class="example"><a id="d0e26788"/><p class="title"><strong>Example 23.34. Banking Tutorial: Rule in Example3.drl</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Rule 03"
    when
        $number : Number( )
        not Number( intValue &lt; $number.intValue )
    then
        System.out.println("Number found with value: " + $number.intValue() ); 
        retract( $number );
end</code></pre></div></div><br class="example-break"/><p>The first line of the rule identifies a <code class="code">Number</code> and
    extracts the value. The second line ensures that there does not exist
    a smaller number than the one found by the first pattern. We might
    expect to match only one number - the smallest in the set. However,
    the retraction of the number after it has been printed means that the
    smallest number has been removed, revealing the next smallest number,
    and so on. </p><p>The resulting output shows that the numbers are now
    sorted numerically.</p><div class="example"><a id="d0e26800"/><p class="title"><strong>Example 23.35. Banking Tutorial: Output of Example3.java</strong></p><div class="example-contents"><pre><code class="no-highlight">Loading file: Example3.drl
Inserting fact: 3
Inserting fact: 1
Inserting fact: 4
Inserting fact: 1
Inserting fact: 5
Number found with value: 1
Number found with value: 1
Number found with value: 3
Number found with value: 4
Number found with value: 5
</code></pre></div></div><br class="example-break"/><p>We are ready to start moving towards our personal accounting
    rules. The first step is to create a <code class="code">Cashflow</code> object.</p><div class="example"><a id="d0e26810"/><p class="title"><strong>Example 23.36. Banking Tutorial: Class Cashflow</strong></p><div class="example-contents"><pre><code class="language-java">public class Cashflow {
    private Date   date;
    private double amount;

    public Cashflow() {
    }

    public Cashflow(Date date, double amount) {
        this.date = date;
        this.amount = amount;
    }

    public Date getDate() {
        return date;
    }

    public void setDate(Date date) {
        this.date = date;
    }

    public double getAmount() {
        return amount;
    }

    public void setAmount(double amount) {
        this.amount = amount;
    }

    public String toString() {
        return "Cashflow[date=" + date + ",amount=" + amount + "]";
    }
}</code></pre></div></div><br class="example-break"/><p>Class <code class="code">Cashflow</code> has two simple attributes, a date
    and an amount. (Note that using the type <code class="code">double</code> for
    monetary units is generally <span class="emphasis"><em>not</em></span> a good idea
    because floating point numbers cannot represent most numbers accurately.)
    There is also an overloaded constructor to set the values, and a
    method <code class="code">toString</code> to print a cashflow. The Java code of
    <code class="filename">Example4.java</code> inserts five Cashflow objects,
    with varying dates and amounts.</p><div class="example"><a id="d0e26832"/><p class="title"><strong>Example 23.37. Banking Tutorial: Example4.java</strong></p><div class="example-contents"><pre><code class="language-java">public class Example4 {
    public static void main(String[] args) throws Exception {
        Object[] cashflows = {
            new Cashflow(new SimpleDate("01/01/2007"), 300.00),
            new Cashflow(new SimpleDate("05/01/2007"), 100.00),
            new Cashflow(new SimpleDate("11/01/2007"), 500.00),
            new Cashflow(new SimpleDate("07/01/2007"), 800.00),
            new Cashflow(new SimpleDate("02/01/2007"), 400.00),
        };
        
        new RuleRunner().runRules( new String[] { "Example4.drl" },
                                   cashflows );
    }
}</code></pre></div></div><br class="example-break"/><p>The convenience class <code class="code">SimpleDate</code> extends
    <code class="code">java.util.Date</code>, providing a constructor taking
    a String as input and defining a date format. The code is
    listed below</p><div class="example"><a id="d0e26845"/><p class="title"><strong>Example 23.38. Banking Tutorial: Class SimpleDate</strong></p><div class="example-contents"><pre><code class="language-java">public class SimpleDate extends Date {
    private static final SimpleDateFormat format = new SimpleDateFormat("dd/MM/yyyy");
    
    public SimpleDate(String datestr) throws Exception {             
        setTime(format.parse(datestr).getTime());
    }
}</code></pre></div></div><br class="example-break"/><p>Now, let’s look at <code class="filename">Example4.drl</code> to see how
    we print the sorted <code class="code">Cashflow</code> objects:</p><div class="example"><a id="d0e26858"/><p class="title"><strong>Example 23.39. Banking Tutorial: Rule in Example4.drl</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Rule 04"   
    when
        $cashflow : Cashflow( $date : date, $amount : amount )
        not Cashflow( date &lt; $date)
    then
        System.out.println("Cashflow: "+$date+" :: "+$amount);  
        retract($cashflow);
end</code></pre></div></div><br class="example-break"/><p>Here, we identify a <code class="code">Cashflow</code> and extract the date
    and the amount. In the second line of the rule we ensure that there
    is no Cashflow with an earlier date than the one found. In the
    consequence, we print the <code class="code">Cashflow</code> that satisfies the
    rule and then retract it, making way for the next earliest
    <code class="code">Cashflow</code>. So, the output we generate is:</p><div class="example"><a id="d0e26874"/><p class="title"><strong>Example 23.40. Banking Tutorial: Output of Example4.java</strong></p><div class="example-contents"><pre><code class="no-highlight">Loading file: Example4.drl
Inserting fact: Cashflow[date=Mon Jan 01 00:00:00 GMT 2007,amount=300.0]
Inserting fact: Cashflow[date=Fri Jan 05 00:00:00 GMT 2007,amount=100.0]
Inserting fact: Cashflow[date=Thu Jan 11 00:00:00 GMT 2007,amount=500.0]
Inserting fact: Cashflow[date=Sun Jan 07 00:00:00 GMT 2007,amount=800.0]
Inserting fact: Cashflow[date=Tue Jan 02 00:00:00 GMT 2007,amount=400.0]
Cashflow: Mon Jan 01 00:00:00 GMT 2007 :: 300.0
Cashflow: Tue Jan 02 00:00:00 GMT 2007 :: 400.0
Cashflow: Fri Jan 05 00:00:00 GMT 2007 :: 100.0
Cashflow: Sun Jan 07 00:00:00 GMT 2007 :: 800.0
Cashflow: Thu Jan 11 00:00:00 GMT 2007 :: 500.0
</code></pre></div></div><br class="example-break"/><p>Next, we extend our <code class="code">Cashflow</code>, resulting in a
    <code class="code">TypedCashflow</code> which can be a credit or a debit operation.
    (Normally, we would just add this to the <code class="code">Cashflow</code> type, but
    we use extension to keep the previous version of the class intact.)</p><div class="example"><a id="d0e26890"/><p class="title"><strong>Example 23.41. Banking Tutorial: Class TypedCashflow</strong></p><div class="example-contents"><pre><code class="language-java">public class TypedCashflow extends Cashflow {
    public static final int CREDIT = 0;
    public static final int DEBIT  = 1;

    private int             type;

    public TypedCashflow() {
    }

    public TypedCashflow(Date date, int type, double amount) {
        super( date, amount );
        this.type = type;
    }

    public int getType() {
        return type;
    }

    public void setType(int type) {
        this.type = type;
    }

    public String toString() {
        return "TypedCashflow[date=" + getDate() +
               ",type=" + (type == CREDIT ? "Credit" : "Debit") +
               ",amount=" + getAmount() + "]";
    }
}</code></pre></div></div><br class="example-break"/><p>There are lots of ways to improve this code, but for the sake
    of the example this will do.</p><p>Now let's create Example5, a class for running our code.</p><div class="example"><a id="d0e26899"/><p class="title"><strong>Example 23.42. Banking Tutorial: Example5.java</strong></p><div class="example-contents"><pre><code class="language-java">public class Example5 {
    public static void main(String[] args) throws Exception {      
        Object[] cashflows = {
            new TypedCashflow(new SimpleDate("01/01/2007"),    
                              TypedCashflow.CREDIT, 300.00),
            new TypedCashflow(new SimpleDate("05/01/2007"),
                              TypedCashflow.CREDIT, 100.00),
            new TypedCashflow(new SimpleDate("11/01/2007"),
                              TypedCashflow.CREDIT, 500.00),
            new TypedCashflow(new SimpleDate("07/01/2007"),
                              TypedCashflow.DEBIT, 800.00),
            new TypedCashflow(new SimpleDate("02/01/2007"),
                              TypedCashflow.DEBIT, 400.00),
        };
        
        new RuleRunner().runRules( new String[] { "Example5.drl" },
                                   cashflows );
    }
}</code></pre></div></div><br class="example-break"/><p>Here, we simply create a set of <code class="code">Cashflow</code> objects
    which are either credit or debit operations. We supply them and
    <code class="filename">Example5.drl</code> to the RuleEngine. </p><p>Now, let’s look at a rule printing the sorted
    <code class="code">Cashflow</code> objects.</p><div class="example"><a id="d0e26917"/><p class="title"><strong>Example 23.43. Banking Tutorial: Rule in Example5.drl</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Rule 05"  
    when
        $cashflow : TypedCashflow( $date : date,
                                   $amount : amount,
                                   type == TypedCashflow.CREDIT )
        not TypedCashflow( date &lt; $date,
                           type == TypedCashflow.CREDIT )
    then
        System.out.println("Credit: "+$date+" :: "+$amount);   
        retract($cashflow);
end</code></pre></div></div><br class="example-break"/><p>Here, we identify a <code class="code">Cashflow</code> fact with a type
    of <code class="code">CREDIT</code> and extract the date and the amount. In the
    second line of the rule we ensure that there is no <code class="code">Cashflow</code>
    of the same type with an earlier date than the one found. In the
    consequence, we print the cashflow satisfying the patterns and then
    retract it, making way for the next earliest cashflow of type
    <code class="code">CREDIT</code>.</p><p>So, the output we generate is</p><div class="example"><a id="d0e26938"/><p class="title"><strong>Example 23.44. Banking Tutorial: Output of Example5.java</strong></p><div class="example-contents"><pre class="screen">Loading file: Example5.drl
Inserting fact: TypedCashflow[date=Mon Jan 01 00:00:00 GMT 2007,type=Credit,amount=300.0]
Inserting fact: TypedCashflow[date=Fri Jan 05 00:00:00 GMT 2007,type=Credit,amount=100.0]
Inserting fact: TypedCashflow[date=Thu Jan 11 00:00:00 GMT 2007,type=Credit,amount=500.0]
Inserting fact: TypedCashflow[date=Sun Jan 07 00:00:00 GMT 2007,type=Debit,amount=800.0]
Inserting fact: TypedCashflow[date=Tue Jan 02 00:00:00 GMT 2007,type=Debit,amount=400.0]
Credit: Mon Jan 01 00:00:00 GMT 2007 :: 300.0
Credit: Fri Jan 05 00:00:00 GMT 2007 :: 100.0
Credit: Thu Jan 11 00:00:00 GMT 2007 :: 500.0
</pre></div></div><br class="example-break"/><p>Continuing our banking exercise, we are now going to process both
    credits and debits on two bank accounts, calculating the account balance.
    In order to do this, we create two separate <code class="code">Account</code> objects
    and inject them into the <code class="code">Cashflows</code> objects before passing
    them to the Rule Engine. The reason for this is to provide easy access
    to the correct account without having to resort to helper classes. Let’s
    take a look at the <code class="code">Account</code> class first. This is a simple
    Java object with an account number and balance:</p><div class="example"><a id="d0e26954"/><p class="title"><strong>Example 23.45. Banking Tutorial: Class Account</strong></p><div class="example-contents"><pre><code class="language-java">public class Account {
    private long   accountNo;
    private double balance = 0;

    public Account() {
    }

    public Account(long accountNo) {
        this.accountNo = accountNo;
    }

    public long getAccountNo() {
        return accountNo;
    }

    public void setAccountNo(long accountNo) {
        this.accountNo = accountNo;
    }

    public double getBalance() {
        return balance;
    }

    public void setBalance(double balance) {
        this.balance = balance;
    }

    public String toString() {
        return "Account[" + "accountNo=" + accountNo + ",balance=" + balance + "]";
    }
}</code></pre></div></div><br class="example-break"/><p>Now let’s extend our <code class="code">TypedCashflow</code>, resulting in
    <code class="code">AllocatedCashflow</code>, to include an <code class="code">Account</code>
    reference.</p><div class="example"><a id="d0e26970"/><p class="title"><strong>Example 23.46. Banking Tutorial: Class AllocatedCashflow</strong></p><div class="example-contents"><pre><code class="language-java">public class AllocatedCashflow extends TypedCashflow {
    private Account account;

    public AllocatedCashflow() {
    }

    public AllocatedCashflow(Account account, Date date, int type, double amount) {
        super( date, type, amount );
        this.account = account;
    }

    public Account getAccount() {
        return account;
    }

    public void setAccount(Account account) {
        this.account = account;
    }

    public String toString() {
        return "AllocatedCashflow[" +
               "account=" + account +
               ",date=" + getDate() + 
               ",type=" + (getType() == CREDIT ? "Credit" : "Debit") + 
               ",amount=" + getAmount() + "]";
    }
}</code></pre></div></div><br class="example-break"/><p>The Java code of <code class="filename">Example5.java</code> creates 
    two <code class="code">Account</code> objects and passes one of them into each
    cashflow, in the constructor call.</p><div class="example"><a id="d0e26983"/><p class="title"><strong>Example 23.47. Banking Tutorial: Example5.java</strong></p><div class="example-contents"><pre><code class="language-java">public class Example6 {
    public static void main(String[] args) throws Exception {      
        Account acc1 = new Account(1);
        Account acc2 = new Account(2);
           
        Object[] cashflows = {
            new AllocatedCashflow(acc1,new SimpleDate("01/01/2007"),
                                  TypedCashflow.CREDIT, 300.00),
            new AllocatedCashflow(acc1,new SimpleDate("05/02/2007"),
                                  TypedCashflow.CREDIT, 100.00),
            new AllocatedCashflow(acc2,new SimpleDate("11/03/2007"),
                                  TypedCashflow.CREDIT, 500.00),
            new AllocatedCashflow(acc1,new SimpleDate("07/02/2007"),
                                  TypedCashflow.DEBIT,  800.00),
            new AllocatedCashflow(acc2,new SimpleDate("02/03/2007"),
                                  TypedCashflow.DEBIT,  400.00),
            new AllocatedCashflow(acc1,new SimpleDate("01/04/2007"),    
                                  TypedCashflow.CREDIT, 200.00),
            new AllocatedCashflow(acc1,new SimpleDate("05/04/2007"),
                                  TypedCashflow.CREDIT, 300.00),
            new AllocatedCashflow(acc2,new SimpleDate("11/05/2007"),
                                  TypedCashflow.CREDIT, 700.00),
            new AllocatedCashflow(acc1,new SimpleDate("07/05/2007"),
                                  TypedCashflow.DEBIT,  900.00),
            new AllocatedCashflow(acc2,new SimpleDate("02/05/2007"),
                                  TypedCashflow.DEBIT,  100.00)           
        };
        
        new RuleRunner().runRules( new String[] { "Example6.drl" },
                                   cashflows );
    }
}</code></pre></div></div><br class="example-break"/><p>Now, let’s look at the rule in <code class="filename">Example6.drl</code>
    to see how we apply each cashflow in date order and calculate and print
    the balance. </p><div class="example"><a id="d0e26993"/><p class="title"><strong>Example 23.48. Banking Tutorial: Rule in Example6.drl</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Rule 06 - Credit"  
    when
        $cashflow : AllocatedCashflow( $account : account,
                                       $date : date,
                                       $amount : amount,
                                       type == TypedCashflow.CREDIT )
        not AllocatedCashflow( account == $account, date &lt; $date)
    then
        System.out.println("Credit: " + $date + " :: " + $amount);     
        $account.setBalance($account.getBalance()+$amount);
        System.out.println("Account: " + $account.getAccountNo() +
                           " - new balance: " + $account.getBalance());          
        retract($cashflow);
end

rule "Rule 06 - Debit"  
    when
        $cashflow : AllocatedCashflow( $account : account,
                            $date : date,
                            $amount : amount,
                            type == TypedCashflow.DEBIT )
        not AllocatedCashflow( account == $account, date &lt; $date)
    then
        System.out.println("Debit: " + $date + " :: " + $amount);      
        $account.setBalance($account.getBalance() - $amount);
        System.out.println("Account: " + $account.getAccountNo() +
                           " - new balance: " + $account.getBalance());           
        retract($cashflow);
end</code></pre></div></div><br class="example-break"/><p>Although we have separate rules for credits and debits, but we do
    not specify a type when checking for earlier cashflows. This is so that
    all cashflows are applied in date order, regardless of the cashflow type.
    In the conditions we identify the account to work with, and in the
    consequences we update it with the cashflow amount.</p><div class="example"><a id="d0e27000"/><p class="title"><strong>Example 23.49. Banking Tutorial: Output of Example6.java</strong></p><div class="example-contents"><pre><code class="no-highlight">Loading file: Example6.drl
Inserting fact: AllocatedCashflow[account=Account[accountNo=1,balance=0.0],date=Mon Jan 01 00:00:00 GMT 2007,type=Credit,amount=300.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=1,balance=0.0],date=Mon Feb 05 00:00:00 GMT 2007,type=Credit,amount=100.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=2,balance=0.0],date=Sun Mar 11 00:00:00 GMT 2007,type=Credit,amount=500.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=1,balance=0.0],date=Wed Feb 07 00:00:00 GMT 2007,type=Debit,amount=800.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=2,balance=0.0],date=Fri Mar 02 00:00:00 GMT 2007,type=Debit,amount=400.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=1,balance=0.0],date=Sun Apr 01 00:00:00 BST 2007,type=Credit,amount=200.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=1,balance=0.0],date=Thu Apr 05 00:00:00 BST 2007,type=Credit,amount=300.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=2,balance=0.0],date=Fri May 11 00:00:00 BST 2007,type=Credit,amount=700.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=1,balance=0.0],date=Mon May 07 00:00:00 BST 2007,type=Debit,amount=900.0]
Inserting fact: AllocatedCashflow[account=Account[accountNo=2,balance=0.0],date=Wed May 02 00:00:00 BST 2007,type=Debit,amount=100.0]
Debit: Fri Mar 02 00:00:00 GMT 2007 :: 400.0
Account: 2 - new balance: -400.0
Credit: Sun Mar 11 00:00:00 GMT 2007 :: 500.0
Account: 2 - new balance: 100.0
Debit: Wed May 02 00:00:00 BST 2007 :: 100.0
Account: 2 - new balance: 0.0
Credit: Fri May 11 00:00:00 BST 2007 :: 700.0
Account: 2 - new balance: 700.0
Credit: Mon Jan 01 00:00:00 GMT 2007 :: 300.0
Account: 1 - new balance: 300.0
Credit: Mon Feb 05 00:00:00 GMT 2007 :: 100.0
Account: 1 - new balance: 400.0
Debit: Wed Feb 07 00:00:00 GMT 2007 :: 800.0
Account: 1 - new balance: -400.0
Credit: Sun Apr 01 00:00:00 BST 2007 :: 200.0
Account: 1 - new balance: -200.0
Credit: Thu Apr 05 00:00:00 BST 2007 :: 300.0
Account: 1 - new balance: 100.0
Debit: Mon May 07 00:00:00 BST 2007 :: 900.0
Account: 1 - new balance: -800.0
</code></pre></div></div><br class="example-break"/></div><div class="section" title="23.6. Pricing Rule Decision Table Example"><div class="titlepage"><div><div><h2 class="title"><a id="d0e27005"/>23.6. Pricing Rule Decision Table Example</h2></div></div></div><p>The Pricing Rule decision table demonstrates the use of a 
    decision table in a spreadsheet, in Excel's XLS format, in calculating
    the retail cost of an insurance policy. The purpose of the provide set
    of rules is to calculate a base price and a discount for a
    car driver applying for a specific policy. The driver's age, history and
    the policy type all contribute to what the basic premium is, and an
    additional chunk of rules deals with refining this with a discount
    percentage.</p><pre><code class="no-highlight"><span class="bold"><strong>Name:</strong></span> Example Policy Pricing
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.decisiontable.PricingRuleDTExample
<span class="bold"><strong>Module:</strong></span> drools-examples
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> ExamplePolicyPricing.xls
<span class="bold"><strong>Objective:</strong></span> demonstrate spreadsheet-based decision tables.</code></pre><div class="section" title="23.6.1. Executing the example"><div class="titlepage"><div><div><h3 class="title"><a id="d0e27029"/>23.6.1. Executing the example</h3></div></div></div><p>Open the file <code class="filename">PricingRuleDTExample.java</code> and 
      execute it as a Java application. It should produce the following
      output in the Console window:</p><pre><code class="no-highlight">Cheapest possible
BASE PRICE IS: 120
DISCOUNT IS: 20     </code></pre><p>The code to execute the example follows the usual pattern.
      The rules are loaded, the facts inserted and a Stateless Session is
      created. What is different is how the rules are added.</p><pre><code class="language-java">DecisionTableConfiguration dtableconfiguration =
    KnowledgeBuilderFactory.newDecisionTableConfiguration();
        dtableconfiguration.setInputType( DecisionTableInputType.XLS );

        KnowledgeBuilder kbuilder = KnowledgeBuilderFactory.newKnowledgeBuilder();

        Resource xlsRes = ResourceFactory.newClassPathResource( "ExamplePolicyPricing.xls",
                                                                getClass() );
        kbuilder.add( xlsRes,
                      ResourceType.DTABLE,
                      dtableconfiguration );
</code></pre><p>Note the use of the <code class="code">DecisionTableConfiguration</code> object.
      Its input type is set to <code class="code">DecisionTableInputType.XLS</code>.
      If you use the BRMS, all this is of course taken care of for you.</p><p>There are two fact types used in this example, <code class="code">Driver</code>
      and <code class="code">Policy</code>. Both are used with their default values. The
      <code class="code">Driver</code> is 30 years old, has had no prior claims and
      currently has a risk profile of <code class="code">LOW</code>. The <code class="code">Policy</code>
      being applied for is <code class="code">COMPREHENSIVE</code>, and it has not yet been
      approved.</p></div><div class="section" title="23.6.2. The decision table"><div class="titlepage"><div><div><h3 class="title"><a id="d0e27071"/>23.6.2. The decision table</h3></div></div></div><p>In this decision table, each row is a rule, and each column is
      a condition or an action.</p><div class="figure"><a id="d0e27076"/><p class="title"><strong>Figure 23.10. Decision table configuration</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/PricingExample/DT_Config.png" alt="Decision table configuration"/></div></div></div><br class="figure-break"/><p>Referring to the spreadsheet show above, we have the
      <code class="code">RuleSet</code> declaration, which provides the package name.
      There are also other optional items you can have here, such as
      <code class="code">Variables</code> for global variables, and <code class="code">Imports</code>
      for importing classes. In this case, the namespace of the rules is
      the same as the fact classes we are using, so we can omit it.</p><p>Moving further down, we can see the <code class="code">RuleTable</code>
      declaration. The name after this (Pricing bracket) is used as the
      prefix for all the generated rules. Below that, we have
      "CONDITION or ACTION", indicating the purpose of the column, i.e.,
      whether it forms part of the condition or the consequence of the rule
      that will be generated.</p><p>You can see that there is a driver, his data spanned across three
      cells, which means that the template expressions below it apply to that
      fact. We observe the driver's age range (which uses <code class="code">$1</code> and
      <code class="code">$2</code> with comma-separated values), 
      <code class="code">locationRiskProfile</code>, and <code class="code">priorClaims</code> in the
      respective columns. In the action columns, we are set the policy
      base price and log a message.</p><div class="figure"><a id="d0e27112"/><p class="title"><strong>Figure 23.11. Base price calculation</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/PricingExample/DT_Table1.png" alt="Base price calculation"/></div></div></div><br class="figure-break"/><p>In the preceding spreadsheet section, there are broad category
      brackets, indicated by the comment in the leftmost column. As we know
      the details of our drivers and their policies, we can tell (with a bit
      of thought) that they should match row number 18, as they have no
      prior accidents, and are 30 years old. This gives us a base price
      of 120.</p><div class="figure"><a id="d0e27120"/><p class="title"><strong>Figure 23.12. Discount calculation</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/PricingExample/DT_Table2.png" alt="Discount calculation"/></div></div></div><br class="figure-break"/><p>The above section contains the conditions for the discount we
      might grant our driver. The discount results from the <code class="code">Age</code>
      bracket, the number of prior claims, and the policy type. In our case,
      the driver is 30, with no prior claims, and is applying for a
      <code class="code">COMPREHENSIVE</code> policy, which means we can give a discount
      of 20%. Note that this is actually a separate table, but in the same
      worksheet, so that different templates apply.</p><p>It is important to note that decision tables generate rules.
      This means they aren't simply top-down logic, but more a means to
      capture data resulting in rules. This is a subtle difference that
      confuses some people. The evaluation of the rules is not necessarily
      in the given order, since all the normal mechanics of the rule engine
      still apply.</p></div></div><div class="section" title="23.7. Pet Store Example"><div class="titlepage"><div><div><h2 class="title"><a id="d0e27136"/>23.7. Pet Store Example</h2></div></div></div><pre><code class="no-highlight"><span class="bold"><strong>Name:</strong></span> Pet Store 
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.petstore.PetStoreExample
<span class="bold"><strong>Module:</strong></span> drools-examples
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> PetStore.drl
<span class="bold"><strong>Objective:</strong></span> Demonstrate use of Agenda Groups, Global Variables and integration with a GUI,
including callbacks from within the rules
</code></pre><p>The Pet Store example shows how to integrate Rules with a GUI,
      in this case a Swing based desktop application. Within the rules file,
      it demonstrates how to use Agenda groups and auto-focus to control
      which of a set of rules is allowed to fire at any given time. It also
      illustrates the mixing of the Java and MVEL dialects within the rules,
      the use of accumulate functions and the way of calling Java functions
      from within the ruleset.</p><p>All of the Java code is contained in one file,
      <code class="filename">PetStore.java</code>, defining the following principal
      classes (in addition to several classes to handle Swing Events):</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="code">Petstore</code> contains the <code class="code">main()</code>
          method that we will look at shortly.</p></li><li class="listitem"><p><code class="code">PetStoreUI</code> is responsible for creating and
          displaying the Swing based GUI. It contains several smaller
          classes, mainly for responding to various GUI events such as
          mouse button clicks.</p></li><li class="listitem"><p><code class="code">TableModel</code> holds the table data. Think of it
          as a JavaBean that extends the Swing class
          <code class="code">AbstractTableModel</code>.</p></li><li class="listitem"><p><code class="code">CheckoutCallback</code> allows the GUI to interact
          with the Rules.</p></li><li class="listitem"><p><code class="code">Ordershow</code> keeps the items that we wish to
          buy.</p></li><li class="listitem"><p><code class="code">Purchase</code> stores details of the order and
          the products we are buying.</p></li><li class="listitem"><p><code class="code">Product</code> is a JavaBean holding details of
          the product available for purchase, and its price.</p></li></ul></div><p>Much of the Java code is either plain JavaBeans or Swing-based.
      Only a few Swing-related points will be discussed in this section,
      but a good tutorial about Swing components can be found at Sun's
      Swing website, in
      <a class="link" href="http://java.sun.com/docs/books/tutorial/uiswing/">http://java.sun.com/docs/books/tutorial/uiswing/</a>.</p><p>The pieces of Java code in <code class="filename">Petstore.java</code>
      that relate to rules and facts are shown below.</p><div class="example"><a id="d0e27217"/><p class="title"><strong>Example 23.50. Creating the PetStore KieContainer in PetStore.main</strong></p><div class="example-contents"><pre><code class="language-java">// KieServices is the factory for all KIE services 
KieServices ks = KieServices.Factory.get();

// From the kie services, a container is created from the classpath
KieContainer kc = ks.getKieClasspathContainer();

// Create the stock.
Vector&lt;Product&gt; stock = new Vector&lt;Product&gt;();
stock.add( new Product( "Gold Fish", 5 ) );
stock.add( new Product( "Fish Tank", 25 ) );
stock.add( new Product( "Fish Food", 2 ) );

// A callback is responsible for populating the
// Working Memory and for firing all rules.
PetStoreUI ui = new PetStoreUI( stock,
                                new CheckoutCallback( kc ) );
ui.createAndShowGUI();
</code></pre></div></div><br class="example-break"/><p>The code shown above create a <code class="code">KieContainer</code> from the classpath and based on the definitions in
    the <code class="filename">kmodule.xml</code> file. Unlike other examples where the facts are asserted and fired straight
    away, this example defers this step to later. The way it does this is via the second last line where a
      <code class="code">PetStoreUI</code> object is created using a constructor accepting the <code class="code">Vector</code> object
      <code class="code">stock</code> collecting our products, and an instance of the <code class="code">CheckoutCallback</code> class containing
    the Rule Base that we have just loaded.</p><p>The Java code that fires the rules is within the 
      <code class="code">CheckoutCallBack.checkout()</code> method. This is triggered
      (eventually) when the Checkout button is pressed by the user.</p><div class="example"><a id="d0e27247"/><p class="title"><strong>Example 23.51. Firing the Rules - extract from CheckoutCallBack.checkout()</strong></p><div class="example-contents"><pre><code class="language-java">public String checkout(JFrame frame, List&lt;Product&gt; items) {
    Order order = new Order();

    // Iterate through list and add to cart
    for ( Product p: items ) {
        order.addItem( new Purchase( order, p ) );
    }

    // Add the JFrame to the ApplicationData to allow for user interaction

    // From the container, a session is created based on  
    // its definition and configuration in the META-INF/kmodule.xml file 
    KieSession ksession = kcontainer.newKieSession("PetStoreKS");

    ksession.setGlobal( "frame", frame );
    ksession.setGlobal( "textArea", this.output );

    ksession.insert( new Product( "Gold Fish", 5 ) );
    ksession.insert( new Product( "Fish Tank", 25 ) );
    ksession.insert( new Product( "Fish Food", 2 ) );

    ksession.insert( new Product( "Fish Food Sample", 0 ) );

    ksession.insert( order );
    ksession.fireAllRules();

    // Return the state of the cart
    return order.toString();
}
</code></pre></div></div><br class="example-break"/><p>Two items get passed into this method. One is the handle to the
      <code class="code">JFrame</code> Swing component surrounding the output text
      frame, at the bottom of the GUI. The second is a list of order items;
      this comes from the <code class="code">TableModel</code> storing the information
      from the "Table" area at the top right section of the GUI.</p><p>The for loop transforms the list of order items coming from the
      GUI into the <code class="code">Order</code> JavaBean, also contained in the
      file <code class="filename">PetStore.java</code>. Note that it would be 
      possible to refer to the Swing dataset directly within the rules,
      but it is better coding practice to do it this way, using simple
      Java objects. It means that we are not tied to Swing if we wanted
      to transform the sample into a Web application.</p><p>It is important to note that <span class="emphasis"><em>all state in this
      example is stored in the Swing components, and that the rules are
      effectively stateless.</em></span> Each time the "Checkout" button is
      pressed, this code copies the contents of the Swing
      <code class="code">TableModel</code> into the Session's Working Memory.</p><p>Within this code, there are nine calls to the <code class="code">KieSession</code>. The first of these creates a new
      <code class="code">KieSession</code> from the <code class="code">KieContainer</code>. Remember that we passed in this
      <code class="code">KieContainer</code> when we created the <code class="code">CheckoutCallBack</code> class in the <code class="code">main()</code>
    method. The next two calls pass in two objects that we will hold as global variables in the rules: the Swing text
    area and the Swing frame used for writing messages.</p><p>More inserts put information on products into the <code class="code">KieSession</code>, as well as the order list. The
    final call is the standard <code class="code">fireAllRules()</code>. Next, we look at what this method causes to happen within
    the rules file.</p><div class="example"><a id="d0e27304"/><p class="title"><strong>Example 23.52. Package, Imports, Globals and Dialect: extract from PetStore.drl</strong></p><div class="example-contents"><pre><code class="language-java">package org.drools.examples

import org.kie.api.runtime.KieRuntime
import org.drools.examples.petstore.PetStoreExample.Order
import org.drools.examples.petstore.PetStoreExample.Purchase
import org.drools.examples.petstore.PetStoreExample.Product
import java.util.ArrayList
import javax.swing.JOptionPane;

import javax.swing.JFrame 
        
global JFrame frame 
global javax.swing.JTextArea textArea</code></pre></div></div><br class="example-break"/><p>The first part of file <code class="filename">PetStore.drl</code>
      contains the standard package and import statements to make various
      Java classes available to the rules. New to us are the two globals
      <code class="code">frame</code> and <code class="code">textArea</code>. They hold references
      to the Swing components <code class="code">JFrame</code> and <code class="code">JTextArea</code>
      components that were previously passed on by the Java code calling
      the <code class="code">setGlobal()</code> method. Unlike  variables in rules,
      which expire as soon as the rule has fired, global variables retain
      their value for the lifetime of the Session.</p><p>The next extract from the file <code class="filename">PetStore.drl</code>
      contains two functions that are referenced by the rules that we will
      look at shortly.</p><div class="example"><a id="d0e27334"/><p class="title"><strong>Example 23.53. Java Functions in the Rules: extract from PetStore.drl</strong></p><div class="example-contents"><pre><code class="language-java">function void doCheckout(JFrame frame, KieRuntime krt) {
        Object[] options = {"Yes",
                            "No"};
                            
        int n = JOptionPane.showOptionDialog(frame,
                                             "Would you like to checkout?",
                                             "",
                                             JOptionPane.YES_NO_OPTION,
                                             JOptionPane.QUESTION_MESSAGE,
                                             null,
                                             options,
                                             options[0]);

       if (n == 0) {
            krt.getAgenda().getAgendaGroup( "checkout" ).setFocus();
       }   
}

function boolean requireTank(JFrame frame, KieRuntime krt, Order order, Product fishTank, int total) {
        Object[] options = {"Yes",
                            "No"};
                            
        int n = JOptionPane.showOptionDialog(frame,
                                             "Would you like to buy a tank for your " + total + " fish?",
                                             "Purchase Suggestion",
                                             JOptionPane.YES_NO_OPTION,
                                             JOptionPane.QUESTION_MESSAGE,
                                             null,
                                             options,
                                             options[0]);
                                             
       System.out.print( "SUGGESTION: Would you like to buy a tank for your "
                           + total + " fish? - " );

       if (n == 0) {
             Purchase purchase = new Purchase( order, fishTank );
             krt.insert( purchase );
             order.addItem( purchase );
             System.out.println( "Yes" );
       } else {
            System.out.println( "No" );
       }      
       return true;
}

</code></pre></div></div><br class="example-break"/><p>Having these functions in the rules file just makes the Pet Store
      example more compact. In real life you probably have the functions
      in a file of their own, within the same rules package, or as a
      static method on a standard Java class, and import them, using
      <code class="code">import function my.package.Foo.hello</code>.</p><p>The purpose of these two functions is:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="code">doCheckout()</code> displays a dialog asking users whether they wish to checkout. If they do,
        focus is set to the <code class="code">checkout</code> agenda-group, allowing rules in that group to (potentially)
        fire.</p></li><li class="listitem"><p><code class="code">requireTank()</code> displays a dialog asking
          users whether they wish to buy a tank. If so, a new fish tank
          <code class="code">Product</code> is added to the order list in Working
          Memory.</p></li></ul></div><p>We'll see the rules that call these functions later on. The
      next set of examples are from the Pet Store rules themselves. The
      first extract is the one that happens to fire first, partly because
      it has the <code class="literal">auto-focus</code> attribute set to true.</p><div class="example"><a id="d0e27368"/><p class="title"><strong>Example 23.54. Putting items into working memory: extract from PetStore.drl</strong></p><div class="example-contents"><pre><code class="no-highlight">// Insert each item in the shopping cart into the Working Memory 
// Insert each item in the shopping cart into the Working Memory
rule "Explode Cart"
    agenda-group "init"
    auto-focus true
    salience 10
    dialect "java"
when
    $order : Order( grossTotal == -1 )
    $item : Purchase() from $order.items
then
    insert( $item );
    kcontext.getKnowledgeRuntime().getAgenda().getAgendaGroup( "show items" ).setFocus();
    kcontext.getKnowledgeRuntime().getAgenda().getAgendaGroup( "evaluate" ).setFocus();
end</code></pre></div></div><br class="example-break"/><p>This rule matches against all orders that do not yet have their
      <code class="code">grossTotal</code> calculated . It loops for each purchase item
      in that order. Some parts of the "Explode Cart" rule should be familiar:
      the rule name, the salience (suggesting the order for the rules being
      fired) and the dialect set to <code class="code">"java"</code>. There are three
      new features:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">agenda-group</code> <code class="code">"init"</code> defines the name
           of the agenda group. In this case, there is only one rule in the
           group. However, neither the Java code nor a rule consequence sets
           the focus to this group, and therefore it relies on the next
           attribute for its chance to fire.</p></li><li class="listitem"><p><code class="literal">auto-focus</code> <code class="code">true</code> ensures that this rule,
          while being the only rule in the agenda group, gets a chance to fire
          when <code class="code">fireAllRules()</code> is called from the Java code.</p></li><li class="listitem"><p><code class="code">kcontext....setFocus()</code> sets the focus to the
          <code class="code">"show items"</code> and <code class="code">"evaluate"</code> agenda groups
          in turn, permitting their rules to fire. In practice, we loop
          through all items on the order, inserting them into memory, then
          firing the other rules after each insert.</p></li></ul></div><p>The next two listings show the rules within the
      <code class="code">"show items"</code> and <code class="code">evaluate</code> agenda groups.
      We look at them in the order that they are called.</p><div class="example"><a id="d0e27420"/><p class="title"><strong>Example 23.55. Show Items in the GUI - extract from PetStore.drl</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Show Items"
    agenda-group "show items"
    dialect "mvel"
when
    $order : Order( )
    $p : Purchase( order == $order )
then
   textArea.append( $p.product + "\n");
end
</code></pre></div></div><br class="example-break"/><p>The <code class="code">"show items"</code> agenda-group has only one rule,
      called "Show Items" (note the difference in case). For each purchase
      on the order currently in the Working Memory (or Session), it logs
      details to the text area at the bottom of the GUI. The
      <code class="code">textArea</code> variable used to do this is one of the global
      variables we looked at earlier.</p><p>The <code class="code">evaluate</code> Agenda group also gains focus from
      the <code class="code">"Explode Cart"</code> rule listed previously. This
      Agenda group has two rules, <code class="code">"Free Fish Food Sample"</code> and
      <code class="code">"Suggest Tank"</code>, shown below.</p><div class="example"><a id="d0e27447"/><p class="title"><strong>Example 23.56. Evaluate Agenda Group: extract from PetStore.drl</strong></p><div class="example-contents"><pre><code class="no-highlight">// Free Fish Food sample when we buy a Gold Fish if we haven't already bought 
// Fish Food and don't already have a Fish Food Sample
rule "Free Fish Food Sample"
    agenda-group "evaluate"
    dialect "mvel"
when
    $order : Order()
    not ( $p : Product( name == "Fish Food") &amp;amp;&amp;amp; Purchase( product == $p ) )
    not ( $p : Product( name == "Fish Food Sample") &amp;amp;&amp;amp; Purchase( product == $p ) )
    exists ( $p : Product( name == "Gold Fish") &amp;amp;&amp;amp; Purchase( product == $p ) )
    $fishFoodSample : Product( name == "Fish Food Sample" );
then
    System.out.println( "Adding free Fish Food Sample to cart" );
    purchase = new Purchase($order, $fishFoodSample);
    insert( purchase );
    $order.addItem( purchase ); 
end

// Suggest a tank if we have bought more than 5 gold fish and don't already have one
rule "Suggest Tank"
    agenda-group "evaluate"
    dialect "java"
when
    $order : Order()
    not ( $p : Product( name == "Fish Tank") &amp;amp;&amp;amp; Purchase( product == $p ) )
    ArrayList( $total : size &amp;gt; 5 ) from collect( Purchase( product.name == "Gold Fish" ) )
    $fishTank : Product( name == "Fish Tank" )
then
    requireTank(frame, kcontext.getKieRuntime(), $order, $fishTank, $total); 
end
</code></pre></div></div><br class="example-break"/><p>The rule <code class="code">"Free Fish Food Sample"</code> will only fire if</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>we <span class="emphasis"><em>don't </em></span>already have any fish food, <span class="emphasis"><em>and</em></span></p></li><li class="listitem"><p>we <span class="emphasis"><em>don't</em></span> already have a free fish food sample,
          <span class="emphasis"><em>and</em></span></p></li><li class="listitem"><p>we <span class="emphasis"><em>do</em></span> have a Gold Fish in our order.</p></li></ul></div><p>If the rule does fire, it creates a new product (Fish Food Sample), and adds it to the
      order in Working Memory.</p><p>The rule <code class="code">"Suggest Tank"</code> will only fire if</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>we <span class="emphasis"><em>don't </em></span>already have a Fish Tank in our order,
          <span class="emphasis"><em>and</em></span></p></li><li class="listitem"><p>we <span class="emphasis"><em>do</em></span> have more than 5 Gold Fish Products
          in our order.</p></li></ul></div><p>If the rule does fire, it calls the <code class="code">requireTank()</code> function
      that we looked at earlier (showing a Dialog to the user, and adding a Tank to
      the order / working memory if confirmed). When calling the
      <span class="italic">requireTank</span>() function the rule passes
      the global <span class="italic">frame</span> variable so that the
      function has a handle to the Swing GUI.</p><p>The next rule we look at is <code class="code">"do checkout"</code>.</p><div class="example"><a id="d0e27518"/><p class="title"><strong>Example 23.57. Doing the Checkout - extract (6) from PetStore.drl</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "do checkout"
    dialect "java"
    when
    then
        doCheckout(frame, kcontext.getKieRuntime());
end</code></pre></div></div><br class="example-break"/><p>The rule <code class="code">"do checkout"</code> has <span class="bold"><strong>no
      agenda group set and no auto-focus attribute</strong></span>. As such, is is
      deemed part of the default (MAIN) agenda group. This group gets focus by
      default when all the rules in agenda-groups that explicitly had focus set
      to them have run their course.</p><p>There is no LHS to the rule, so the RHS will always call the
      <code class="code">doCheckout()</code> function. When calling the
      <code class="code">doCheckout()</code> function, the rule passes the global
      <code class="code">frame</code> variable to give the function a handle to the Swing GUI.
      As we saw earlier, the <code class="code">doCheckout()</code> function shows a
      confirmation dialog to the user. If confirmed, the function sets the focus
      to the <span class="italic">checkout</span> agenda-group, allowing
      the next lot of rules to fire.</p><div class="example"><a id="d0e27548"/><p class="title"><strong>Example 23.58. Checkout Rules: extract from PetStore.drl</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Gross Total"
    agenda-group "checkout"
    dialect "mvel"
when
   $order : Order( grossTotal == -1)
   Number( total : doubleValue )
       from accumulate( Purchase( $price : product.price ), sum( $price ) )
then
    modify( $order ) { grossTotal = total };
    textArea.append( "\ngross total=" + total + "\n" );
end

rule "Apply 5% Discount"
    agenda-group "checkout"
dialect "mvel"
when
   $order : Order( grossTotal &amp;gt;= 10 &amp;amp;&amp;amp; &amp;lt; 20 )
then
   $order.discountedTotal = $order.grossTotal * 0.95;
   textArea.append( "discountedTotal total=" + $order.discountedTotal + "\n" );
end


rule "Apply 10% Discount"
    agenda-group "checkout"
    dialect "mvel"
when
   $order : Order( grossTotal &amp;gt;= 20 )
then
   $order.discountedTotal = $order.grossTotal * 0.90;
   textArea.append( "discountedTotal total=" + $order.discountedTotal + "\n" );
end
</code></pre></div></div><br class="example-break"/><p>There are three rules in the <span class="italic">checkout</span> agenda-group:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>If we haven't already calculated the gross total, <code class="code">Gross Total</code> accumulates the product
        prices into a total, puts this total into the session, and displays it via the Swing <code class="code">JTextArea</code>,
        using the <code class="code">textArea</code> global variable yet again.</p></li><li class="listitem"><p>If our gross total is between 10 and 20, <code class="code">"Apply 5% Discount"</code> calculates the discounted
        total and adds it to the session and displays it in the text area.</p></li><li class="listitem"><p>If our gross total is not less than 20, <code class="code">"Apply 10% Discount"</code> calculates the discounted
        total and adds it to the session and displays it in the text area.</p></li></ul></div><p>Now that we've run through what happens in the code, let's have a
      look at what happens when we actually run the code. The file
      <code class="filename">PetStore.java</code> contains a <code class="code">main()</code> method,
      so that it can be run as a standard Java application, either from the
      command line or via the IDE. This assumes you have your classpath set
      correctly. (See the start of the examples section for more information.)</p><p>The first screen that we see is the Pet Store Demo. It has a list
      of available products (top left), an empty list of selected products
      (top right), checkout and reset buttons (middle) and an empty system
      messages area (bottom).</p><div class="figure"><a id="d0e27593"/><p class="title"><strong>Figure 23.13. PetStore Demo just after Launch</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/PetStoreExample/1-PetStore-Start-Screen.png" alt="PetStore Demo just after Launch"/></div></div></div><br class="figure-break"/><p>To get to this point, the following things have happened:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>The <code class="code">main()</code> method has run and loaded the Rule Base
          <span class="emphasis"><em>but not yet fired the rules</em></span>. So far, this is the
          only code in connection with rules that has been run.</p></li><li class="listitem"><p>A new <code class="code">PetStoreUI</code> object has been created and given a
          handle to the Rule Base, for later use.</p></li><li class="listitem"><p>Various Swing components do their stuff, and the above screen
          is shown and <span class="emphasis"><em>waits for user input</em></span>.</p></li></ol></div><p>Clicking on various products from the list might give you a
      screen similar to the one below.</p><div class="figure"><a id="d0e27625"/><p class="title"><strong>Figure 23.14. PetStore Demo with Products Selected</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/PetStoreExample/2-stock-added-to-order-list.png" alt="PetStore Demo with Products Selected"/></div></div></div><br class="figure-break"/><p>Note that <span class="emphasis"><em>no rules code has been fired here</em></span>. This
      is only Swing code, listening for mouse click events, and adding some
      selected product to the <code class="code">TableModel</code> object for display in the
      top right hand section. (As an aside, note that this is a classic use of
      the Model View Controller design pattern).</p><p>It is only when we press the "Checkout" button that we fire our
      business rules, in roughly the same order that we walked through the
      code earlier.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Method <code class="code">CheckOutCallBack.checkout()</code> is called
          (eventually) by the Swing class waiting for the click on the
          "Checkout" button. This inserts the data from the
          <code class="code">TableModel</code> object (top right hand side of the GUI),
          and inserts it into the Session's Working Memory. It then fires
          the rules.</p></li><li class="listitem"><p>The <code class="code">"Explode Cart"</code> rule is the first to fire,
          given that it has <code class="literal">auto-focus</code> set to true. It loops through
          all the products in the cart, ensures that the products are in the
          Working Memory, and then gives the <code class="code">"Show Items"</code> and
          <code class="code">Evaluation</code> agenda groups a chance to fire. The rules
          in these groups add the contents of the cart to the text area
          (at the bottom of the window), decide whether or not to give us free
          fish food, and to ask us whether we want to buy a fish tank. This
          is shown in the figure below.</p></li></ol></div><div class="figure"><a id="d0e27666"/><p class="title"><strong>Figure 23.15. Do we want to buy a fish tank?</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/PetStoreExample/3-purchase-suggestion.png" alt="Do we want to buy a fish tank?"/></div></div></div><br class="figure-break"/><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>The <span class="italic">Do Checkout</span> rule is the next to fire as it (a) No other agenda group currently has focus and (b) it is part of the default (MAIN) agenda group. It always calls the<span class="italic"> doCheckout() function </span>which displays a 'Would you like to Checkout?' Dialog Box.</p></li><li class="listitem"><p>The <code class="code">doCheckout()</code> function sets the focus to the
          <code class="code">checkout</code> agenda-group, giving the rules in that group
          the option to fire.</p></li><li class="listitem"><p>The rules in the the <code class="code">checkout</code> agenda-group display
          the contents of the cart and apply the appropriate discount.</p></li><li class="listitem"><p><span class="emphasis"><em>Swing then waits for user input</em></span> to either
          checkout more products (and to cause the rules to fire again), or to
          close the GUI - see the figure below.</p></li></ol></div><div class="figure"><a id="d0e27702"/><p class="title"><strong>Figure 23.16. Petstore Demo after all rules have fired.</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/PetStoreExample/4-Petstore-final-screen.png" alt="Petstore Demo after all rules have fired."/></div></div></div><br class="figure-break"/><p>We could add more System.out calls to demonstrate this flow of
      events. The output, as it currently appears in the Console window, is
      given in the listing below.</p><div class="example"><a id="d0e27710"/><p class="title"><strong>Example 23.59. Console (System.out) from running the PetStore GUI</strong></p><div class="example-contents"><pre><code class="no-highlight">Adding free Fish Food Sample to cart 
SUGGESTION: Would you like to buy a tank for your 6 fish? - Yes</code></pre></div></div><br class="example-break"/></div><div class="section" title="23.8. Honest Politician Example"><div class="titlepage"><div><div><h2 class="title"><a id="d0e27716"/>23.8. Honest Politician Example</h2></div></div></div><pre><code class="no-highlight"><span class="bold"><strong>Name:</strong></span> Honest Politician
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.honestpolitician.HonestPoliticianExample
<span class="bold"><strong>Module:</strong></span> drools-examples
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> HonestPoliticianExample.drl
<span class="bold"><strong>Objective:</strong></span> Illustrate the concept of "truth maintenance" based on the logical insertion of facts
</code></pre><p>The Honest Politician example demonstrates truth maintenance with
  logical assertions. The basic premise is that an object can only exist
  while a statement is true. A rule's consequence can logically insert an 
  object with the <code class="code">insertLogical()</code> method. This means the object
  will only remain in the Working Memory as long as the rule that logically
  inserted  it remains true. When the rule is no longer true the object is
  automatically retracted.</p><p>In this example there is the class <code class="code">Politician</code>, with a
  name and a boolean value for being honest. Four politicians with honest
  state set to true are inserted.</p><div class="example"><a id="d0e27748"/><p class="title"><strong>Example 23.60. Class Politician</strong></p><div class="example-contents"><pre><code class="language-java">public class Politician {
    private String name;
    private boolean honest;
    ...
}</code></pre></div></div><br class="example-break"/><div class="example"><a id="d0e27753"/><p class="title"><strong>Example 23.61. Honest Politician: Execution</strong></p><div class="example-contents"><pre><code class="language-java">Politician blair = new Politician("blair", true);
Politician bush = new Politician("bush", true);
Politician chirac = new Politician("chirac", true);
Politician schroder = new Politician("schroder", true);
    
ksession.insert( blair );
ksession.insert( bush );
ksession.insert( chirac );
ksession.insert( schroder );

ksession.fireAllRules();</code></pre></div></div><br class="example-break"/><p>The Console window output shows that, while there is at
    least one honest politician, democracy lives. However, as each
    politician is in turn corrupted by an evil corporation, so that
    all politicians become dishonest, democracy is dead.</p><div class="example"><a id="d0e27760"/><p class="title"><strong>Example 23.62. Honest Politician: Console Output</strong></p><div class="example-contents"><pre><code class="no-highlight">Hurrah!!! Democracy Lives
I'm an evil corporation and I have corrupted schroder
I'm an evil corporation and I have corrupted chirac
I'm an evil corporation and I have corrupted bush
I'm an evil corporation and I have corrupted blair
We are all Doomed!!! Democracy is Dead
</code></pre></div></div><br class="example-break"/><p>As soon as there is at least one honest politician in the
    Working Memory a new <code class="code">Hope</code> object is logically asserted.
    This object will only exist while there is at least one honest
    politician. As soon as all politicians are dishonest, the
    <code class="code">Hope</code> object will be automatically retracted. This rule
    is given a salience of 10 to ensure that it fires before any other
    rule, as at this stage the "Hope is Dead" rule is actually true.</p><div class="example"><a id="d0e27773"/><p class="title"><strong>Example 23.63. Honest Politician: Rule "We have an honest politician"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "We have an honest Politician"
    salience 10
    when
        exists( Politician( honest == true ) )
    then
        insertLogical( new Hope() );
end</code></pre></div></div><br class="example-break"/><p>As soon as a <code class="code">Hope</code> object exists the "Hope Lives" rule
  matches and fires. It has a salience of 10 so that it takes priority
  over "Corrupt the Honest".</p><div class="example"><a id="d0e27783"/><p class="title"><strong>Example 23.64. Honest Politician: Rule "Hope Lives"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Hope Lives"
    salience 10
        when
            exists( Hope() )
        then
            System.out.println("Hurrah!!! Democracy Lives");
end</code></pre></div></div><br class="example-break"/><p>Now that there is hope and we have, at the start, four honest
    politicians, we have four activations for this rule, all in conflict.
    They will fire in turn, corrupting each politician so that they are
    no longer honest. When all four politicians have been corrupted we
    have no politicians with the property <code class="code">honest == true</code>.
    Thus, the rule "We have an honest Politician" is no longer true and
    the object it logical inserted (due to the last execution of
    <code class="code">new Hope()</code>) is automatically retracted.</p><div class="example"><a id="d0e27796"/><p class="title"><strong>Example 23.65. Honest Politician: Rule "Corrupt the Honest"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Corrupt the Honest"
    when
        politician : Politician( honest == true )   
        exists( Hope() )
    then
        System.out.println( "I'm an evil corporation and I have corrupted " + politician.getName() );
        modify ( politician ) { honest = false };
end</code></pre></div></div><br class="example-break"/><p>With the <code class="code">Hope</code> object being automatically retracted,
    via the truth maintenance system, the conditional element <code class="literal">not</code>
    applied to <code class="code">Hope</code> is no longer true so that the following
    rule will match and fire.</p><div class="example"><a id="d0e27812"/><p class="title"><strong>Example 23.66. Honest Politician: Rule "Hope is Dead"</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Hope is Dead"
    when
        not( Hope() )
    then
        System.out.println( "We are all Doomed!!! Democracy is Dead" );
end</code></pre></div></div><br class="example-break"/><p>Let's take a look at the Audit trail for this application:</p><div class="figure"><a id="d0e27819"/><p class="title"><strong>Figure 23.17. Honest Politician Example Audit View</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/HonestPoliticianExample/honest_politician_audit.png" alt="Honest Politician Example Audit View"/></div></div></div><br class="figure-break"/><p>The moment we insert the first politician we have two activations.
    The rule "We have an honest Politician" is activated only once for the first
    inserted politician because it uses an <code class="literal">exists</code> conditional
    element, which matches once for any number. The rule "Hope is Dead" is
    also activated at this stage, because we have not yet inserted the
    <code class="code">Hope</code> object. Rule "We have an honest Politician" fires first,
    as it has a higher salience than "Hope is Dead", which inserts the
    <code class="code">Hope</code> object. (That action is highlighted green.) The
    insertion of the <code class="code">Hope</code> object activates "Hope Lives" and
    de-activates "Hope is Dead"; it also activates "Corrupt the Honest"
    for each inserted honest politician. Rule "Hope Lives" executes,
    printing  "Hurrah!!! Democracy Lives". Then, for each politician, rule
    "Corrupt the Honest" fires, printing "I'm an evil corporation and I
    have corrupted X", where X is the name of the politician, and modifies
    the politician's honest value to false. When the last honest politician
    is corrupted, <code class="code">Hope</code> is automatically retracted, by the truth
    maintenance system, as shown by the blue highlighted area. The green
    highlighted area shows the origin of the currently selected blue
    highlighted area. Once the <code class="code">Hope</code> fact is retracted, "Hope is
    dead" activates and fires printing "We are all Doomed!!! Democracy is
    Dead".</p></div><div class="section" title="23.9. Sudoku Example"><div class="titlepage"><div><div><h2 class="title"><a id="d0e27845"/>23.9. Sudoku Example</h2></div></div></div><pre><code class="no-highlight"><span class="bold"><strong>Name:</strong></span> Sudoku
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.sudoku.SudokuExample
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> sudoku.drl, validate.drl
<span class="bold"><strong>Objective:</strong></span> Demonstrates the solving of logic problems, and complex pattern matching.
</code></pre><p>This example demonstrates how Drools can be used to find a solution
    in a large potential solution space based on a number of constraints. We
    use the popular puzzle of Sudoku. This example also shows how Drools can
    be integrated into a graphical interface and how callbacks can be used to
    interact with a running Drools rules engine in order to update the
    graphical interface based on changes in the Working Memory at
    runtime.</p><div class="section" title="23.9.1. Sudoku Overview"><div class="titlepage"><div><div><h3 class="title"><a id="d0e27866"/>23.9.1. Sudoku Overview</h3></div></div></div><p>Sudoku is a logic-based number placement puzzle. The objective is
      to fill a 9x9 grid so that each column, each row, and each of the nine
      3x3 zones contains the digits from 1 to 9, once, and only once.</p><p>The puzzle setter provides a partially completed grid and the
      puzzle solver's task is to complete the grid with these
      constraints.</p><p>The general strategy to solve the problem is to ensure that when
      you insert a new number it should be unique in its particular
      3x3 zone, row and column.</p><p>See <a class="link" href="http://en.wikipedia.org/wiki/Sudoku">Wikipedia</a>
      for a more detailed description.</p></div><div class="section" title="23.9.2. Running the Example"><div class="titlepage"><div><div><h3 class="title"><a id="d0e27880"/>23.9.2. Running the Example</h3></div></div></div><p>Download and install drools-examples as described above and then
      execute <code class="filename">java org.drools.examples.DroolsExamplesApp</code> and
      click on "SudokuExample".</p><p>The window contains an empty grid, but the program comes with a number of grids stored
      internally which can be loaded and solved. Click on "File", then "Samples" and select "Simple"
      to load one of the examples. Note that all buttons are disabled until a grid is loaded. 
      </p><div class="figure"><a id="d0e27890"/><p class="title"><strong>Figure 23.18. Initial screen</strong></p><div class="figure-contents"><div class="screenshot"><div class="mediaobject"><img src="images/Examples/SudokuExample/sudoku1.png" alt="Initial screen"/></div></div></div></div><p><br class="figure-break"/>
    </p><p>Loading the "Simple" example fills the grid according to the
        puzzle's initial state. </p><div class="figure"><a id="d0e27900"/><p class="title"><strong>Figure 23.19. After loading "Simple"</strong></p><div class="figure-contents"><div class="screenshot"><div class="mediaobject"><img src="images/Examples/SudokuExample/sudoku2.png" alt="After loading &#34;Simple&#34;"/></div></div></div></div><p><br class="figure-break"/></p><p>Click on the "Solve" button and the Drools-based engine will fill
      out the remaining values, and the buttons are inactive once
      more.</p><div class="figure"><a id="d0e27909"/><p class="title"><strong>Figure 23.20. "Simple" Solved</strong></p><div class="figure-contents"><div class="screenshot"><div class="mediaobject"><img src="images/Examples/SudokuExample/sudoku3.png" alt="&#34;Simple&#34; Solved"/></div></div></div></div><p><br class="figure-break"/></p><p>Alternatively, you may click on the "Step" button to see the next
      digit found by the rule set. The Console window will display detailed
      information about the rules which are executing to solve the step
      in a human readable form. Some examples of these messages are
      presented below.</p><pre class="screen">
single 8 at [0,1]
column elimination due to [1,2]: remove 9 from [4,2]
hidden single 9 at [1,2]
row elimination due to [2,8]: remove 7 from [2,4]
remove 6 from [3,8] due to naked pair at [3,2] and [3,7]
hidden pair in row at [4,6] and [4,4]
</pre><p>Click on the "Dump" button to see the state of the grid, with
      cells showing either the established value or the remaining 
      possibilitiescandidates.</p><pre class="screen">
       Col: 0     Col: 1     Col: 2     Col: 3     Col: 4     Col: 5     Col: 6     Col: 7     Col: 8     
Row 0:   2 4  7 9   2 456        4567 9   23 56  9  --- 5 ---  --- 1 ---    3  67 9  --- 8 ---     4 67   
Row 1:  12    7 9  --- 8 ---  1    67 9   23  6  9  --- 4 ---   23  67    1 3  67 9    3  67 9  --- 5 --- 
Row 2:  1  4  7 9  1  456     --- 3 ---      56 89      5 78       5678   --- 2 ---     4 67 9  1  4 67   
Row 3:  1234       12345      1  45      12  5  8   --- 6 ---   2  5 78       5 78      45 7    --- 9 --- 
Row 4:  --- 6 ---  --- 7 ---      5      --- 4 ---   2  5  8   --- 9 ---      5  8   --- 1 ---  --- 3 --- 
Row 5:  --- 8 ---  12 45      1  45   9  12  5      --- 3 ---   2  5 7        567       4567     2 4 67   
Row 6:  1 3   7    1 3  6     --- 2 ---    3 56 8       5  8     3 56 8   --- 4 ---    3 567 9  1    678  
Row 7:  --- 5 ---  1 34 6     1  4 678     3  6 8   --- 9 ---    34 6 8   1 3  678   --- 2 ---  1    678  
Row 8:    34       --- 9 ---     4 6 8   --- 7 ---  --- 1 ---   23456 8     3 56 8     3 56          6 8  
</pre><p>Now, let us load a Sudoku grid that is deliberately invalid. Click
      on "File", "Samples" and "!DELIBERATELY BROKEN!". Note that this grid
      starts with some issues, for example the value 5 appears twice in the
      first row.</p><div class="figure"><a id="d0e27928"/><p class="title"><strong>Figure 23.21. Broken initial state</strong></p><div class="figure-contents"><div class="screenshot"><div class="mediaobject"><img src="images/Examples/SudokuExample/sudoku4.png" alt="Broken initial state"/></div></div></div></div><p><br class="figure-break"/></p><p>A few simple rules perform a sanity check, right after loading
      a grid. In this case, the following messages are printed on
      standard output:</p><pre class="screen">
cell [0,8]: 5 has a duplicate in row 0
cell [0,0]: 5 has a duplicate in row 0
cell [6,0]: 8 has a duplicate in col 0
cell [4,0]: 8 has a duplicate in col 0
Validation complete.
</pre><p>Nevertheless, click on the "Solve" button to apply the solving
      rules to this invalid grid. This will not complete; some cells
      remain empty. </p><div class="figure"><a id="d0e27942"/><p class="title"><strong>Figure 23.22. Broken "solved" state</strong></p><div class="figure-contents"><div class="screenshot"><div class="mediaobject"><img src="images/Examples/SudokuExample/sudoku5.png" alt="Broken &#34;solved&#34; state"/></div></div></div></div><p><br class="figure-break"/></p><p>The solving functionality has been achieved by the use of
      rules that implement standard solving techniques. They are based
      on the sets of values that are still candidates for a cell. If,
      for instance, such a set contains a single value, then this is
      the value for the cell. A little less obvious is the single
      occurrence of a value in one of the groups of nine cells. The
      rules detecting these situations insert a fact of type Setting
      with the solution value for some specific cell. This fact causes the
      elimination of this value from all other cells in any of the
      groups the cell belongs to. Finally, it is retracted.</p><p>Other rules merely reduce the permissible values for some
      cells. Rules "naked pair", "hidden pair in row", "hidden pair in column"
      and "hidden pair in square" merely eliminate possibilities but
      do not establish solutions. More sophisticated eliminations are done by
      "X-wings in rows", "X-wings in columns", "intersection removal row" and
      "intersection removal column".</p></div><div class="section" title="23.9.3. Java Source and Rules Overview"><div class="titlepage"><div><div><h3 class="title"><a id="d0e27953"/>23.9.3. Java Source and Rules Overview</h3></div></div></div><p>The Java source code can be found in the
      /src/main/java/org/drools/examples/sudoku directory, with the two DRL
      files defining the rules located in the
      /src/main/rules/org/drools/examples/sudoku directory.</p><p>The package <code class="code">org.drools.examples.sudoku.swing</code>
      contains a set of classes which implement a framework for Sudoku
      puzzles. Note that this package does not have any dependencies on
      the Drools libraries. <code class="code">SudokuGridModel</code> defines an
      interface which can be implemented to store a Sudoku puzzle as a 9x9
      grid of <code class="code">Cell</code> objects. <code class="code">SudokuGridView</code> is
      a Swing component which can visualize any implementation of
      <code class="code">SudokuGridModel</code>. <code class="code">SudokuGridEvent</code> and
      <code class="code">SudokuGridListener</code> are used to
      communicate state changes between the model and the view: events are
      fired when a cell's value is resolved or changed. If you are familiar
      with the model-view-controller patterns in other Swing components such
      as <code class="code">JTable</code> then this pattern should be familiar.
      <code class="code">SudokuGridSamples</code> provides a number of partially filled
      Sudoku puzzles for demonstration purposes.</p><p>Package <code class="code">org.drools.examples.sudoku.rules</code> contains a
      utility class with a method for compiling DRL files.</p><p>The package <code class="code">org.drools.examples.sudoku</code> contains a
      set of classes implementing the elementary <code class="code">Cell</code> object
      and its various aggregations: the <code class="code">CellFile</code> subtypes
      <code class="code">CellRow</code> and <code class="code">CellCol</code> as well as
      <code class="code">CellSqr</code>, all of which are subtypes of
      <code class="code">CellGroup</code>. It's interesting to note that <code class="code">Cell</code>
      and <code class="code">CellGroup</code> are subclasses of <code class="code">SetOfNine</code>,
      which provides a property <code class="code">free</code> with the
      type <code class="code">Set&lt;Integer&gt;</code>. For a <code class="code">Cell</code> it
      represents the individual candidate set; for a <code class="code">CellGroup</code>
      the set is the union of all candidate sets of its cells, or, simply,
      the set of digits that still need to be allocated.</p><p>With 81 <code class="code">Cell</code> and 27 <code class="code">CellGroup</code> objects and
      the linkage provided by the <code class="code">Cell</code> properties 
      <code class="code">cellRow</code>, <code class="code">cellCol</code> and <code class="code">cellSqr</code>
      and the <code class="code">CellGroup</code> property <code class="code">cells</code>, a list of
      <code class="code">Cell</code> objects, it is possible to write rules that
      detect the specific situations that permit the allocation of a
      value to a cell or the elimination of a value from some candidate 
      set.</p><p>An object of class <code class="code">Setting</code> is used for triggering
      the operations that accompany the allocation of a value: its removal
      from the candidate sets of sibling cells and associated cell groups.
      Moreover, the presence of a <code class="code">Setting</code> fact is used in
      all rules that should detect a new situation; this is to avoid
      reactions to inconsistent intermediary states.</p><p>An object of class <code class="code">Stepping</code> is used in a
      low priority rule to execute an emergency halt when a "Step"
      does not terminate regularly. This indicates that the puzzle
      cannot be solved by the program.</p><p>The class <code class="code">org.drools.examples.sudoku.SudokuExample</code>
      implements a Java application combining the components described.</p></div><div class="section" title="23.9.4. Sudoku Validator Rules (validate.drl)"><div class="titlepage"><div><div><h3 class="title"><a id="d0e28083"/>23.9.4. Sudoku Validator Rules (validate.drl)</h3></div></div></div><p>Validation rules detect duplicate numbers in cell groups.
      They are combined in an agenda group which enables us to activate
      them, explicitly, after loading a puzzle.</p><p>The three rules "duplicate in cell..." are very similar.
      The first pattern locates a cell with an allocated value. The second
      pattern pulls in any of the three cell groups the cell belongs to.
      The final pattern would find a cell (other than the first one) with
      the same value as the first cell and in the same row, column or
      square, respectively.</p><p>Rule "terminate group" fires last. It prints a message and
      calls halt.</p></div><div class="section" title="23.9.5. Sudoku Solving Rules (sudoku.drl)"><div class="titlepage"><div><div><h3 class="title"><a id="d0e28092"/>23.9.5. Sudoku Solving Rules (sudoku.drl)</h3></div></div></div><p>There are three types of rules in this file: one group
      handles the allocation of a number to a cell, another group
      detects feasible allocations, and the third group eliminates
      values from candidate sets.</p><p>Rules  "set a value", "eliminate a value from Cell" and
      "retract setting" depend on the presence of a <code class="code">Setting</code>
      object. The first rule handles the assignment to the cell and the
      operations for removing the value from the "free" sets of the 
      cell's three groups. Also, it decrements a counter that, when
      zero, returns control to the Java application that has called
      <code class="code">fireUntilHalt()</code>. The purpose of rule
      "eliminate a value from Cell" is to reduce the candidate lists
      of all cells that are related to the newly assigned cell. Finally,
      when all eliminations have been made, rule "retract setting"
      retracts the triggering <code class="code">Setting</code> fact.</p><p>There are just two rules that detect a situation where an
      allocation of a number to a cell is possible. Rule "single" fires
      for a <code class="code">Cell</code> with a candidate set containing a single
      number. Rule "hidden single" fires when there is no cell with a
      single candidate but when there is a cell containing a candidate but  
      this candidate is absent from all other cells in one of the three
      groups the cell belongs to. Both rules create and insert a
      <code class="code">Setting</code> fact.</p><p>Rules from the largest group of rules implement, singly or
      in groups of two or three, various solving techniques, as they are
      employed when solving Sudoku puzzles manually.</p><p>Rule "naked pair" detects identical candidate sets of size 2
      in two cells of a group; these two values may be removed from all
      other candidate sets of that group.</p><p>A similar idea motivates the three rules "hidden pair in...";
      here, the rules look for a subset of two numbers in exactly two cells
      of a group, with neither value occurring in any of the other cells of
      this group. This, then, means that all other candidates can be
      eliminated from the two cells harbouring the hidden pair.</p><p>A pair of rules deals with "X-wings" in rows and columns.
      When there are only two possible cells for a value in each of
      two different rows (or columns) and these candidates lie also
      in the same columns (or rows), then all other candidates for 
      this value in the columns (or rows) can be eliminated. If you
      follow the pattern sequence in one of these rules, you will see
      how the conditions that are conveniently expressed by words such as
      "same" or "only" result in patterns with suitable constraints
      or prefixed with "not".</p><p>The rule pair "intersection removal..." is based on the
      restricted occurrence of some number within one square, either
      in a single row or in a single column. This means that this number
      must be in one of those two or three cells of the row or column;
      hence it can be removed from the candidate sets of all other cells
      of the group. The pattern establishes the restricted occurrence
      and then fires for each cell outside the square and within the
      same cell file.</p><p>These rules are sufficient for many but certainly not for all
      Sudoku puzzles. To solve very difficult grids, the rule set would
      need to be extended with more complex rules. (Ultimately, there
      are puzzles that cannot be solved except by trial and error.)</p></div></div><div class="section" title="23.10. Number Guess"><div class="titlepage"><div><div><h2 class="title"><a id="d0e28128"/>23.10. Number Guess</h2></div></div></div><pre><code class="no-highlight"><span class="bold"><strong>Name:</strong></span> Number Guess
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.numberguess.NumberGuessExample
<span class="bold"><strong>Module:</strong></span> droolsjbpm-integration-examples (Note: this is in a different download, the droolsjbpm-integration download.)
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> NumberGuess.drl
<span class="bold"><strong>Objective:</strong></span> Demonstrate use of Rule Flow to organise Rules
</code></pre><p>The "Number Guess" example shows the use of Rule Flow, a way of controlling the order in which rules are fired.
  It uses widely understood workflow diagrams for defining the order in which groups of rules will be executed.</p><div class="example"><a id="d0e28152"/><p class="title"><strong>Example 23.67. Creating the Number Guess RuleBase: NumberGuessExample.main() - part 1</strong></p><div class="example-contents"><pre><code class="language-java">final KnowledgeBuilder kbuilder = KnowledgeBuilderFactory.newKnowledgeBuilder();
kbuilder.add( ResourceFactory.newClassPathResource( "NumberGuess.drl",
                                                    ShoppingExample.class ),
              ResourceType.DRL );
kbuilder.add( ResourceFactory.newClassPathResource( "NumberGuess.rf",
                                                    ShoppingExample.class ),
              ResourceType.DRF );

final KnowledgeBase kbase = KnowledgeBaseFactory.newKnowledgeBase();
kbase.addKnowledgePackages( kbuilder.getKnowledgePackages() );</code></pre></div></div><br class="example-break"/><p>The creation of the package and the loading of the rules (using the <code class="code">add()</code> method) is the same as
  the previous examples. There is an additional line to add the Rule Flow (<code class="filename">NumberGuess.rf</code>), which
  provides the option of specifying different rule flows for the same Knowledge Base. Otherwise, the Knowledge Base is
  created in the same manner as before.</p><div class="example"><a id="d0e28165"/><p class="title"><strong>Example 23.68. Starting the RuleFlow: NumberGuessExample.main() - part 2</strong></p><div class="example-contents"><pre><code class="language-java">final StatefulKnowledgeSession ksession = kbase.newStatefulKnowledgeSession();

KnowledgeRuntimeLogger logger =
  KnowledgeRuntimeLoggerFactory.newFileLogger(ksession, "log/numberguess");

ksession.insert( new GameRules( 100, 5 ) );
ksession.insert( new RandomNumber() );
ksession.insert( new Game() );

ksession.startProcess( "Number Guess" );
ksession.fireAllRules();

logger.close();

ksession.dispose();</code></pre></div></div><br class="example-break"/><p>Once we have a Knowledge Base, we can use it to obtain a Stateful Session. Into our session we insert our facts,
  i.e., standard Java objects. (For simplicity, in this sample, these classes are all contained within our
  <code class="filename">NumberGuessExample.java</code> file. Class <code class="code">GameRules</code> provides the maximum range and the
  number of guesses allowed. Class <code class="code">RandomNumber</code> automatically generates a number between 0 and 100 and
  makes it available to our rules, by insertion via the <code class="code">getValue()</code> method. Class <code class="code">Game</code> keeps
  track of the guesses we have made before, and their number.</p><p>Note that before we call the standard <code class="code">fireAllRules()</code> method, we also start the process that we
  loaded earlier, via the <code class="code">startProcess()</code> method. We'll learn where to obtain the parameter we pass ("Number
  Guess", i.e., the identifier of the rule flow) when we talk about the rule flow file and the graphical Rule Flow
  Editor below.</p><p>Before we finish the discussion of our Java code, we note that in some real-life application we would examine
  the final state of the objects. (Here, we could retrieve the number of guesses, to add it to a high score table.) For
  this example we are content to ensure that the Working Memory session is cleared by calling the <code class="code">dispose()</code>
  method.</p><div class="figure"><a id="d0e28200"/><p class="title"><strong>Figure 23.23. RuleFlow for the NumberGuess Example</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/NumberGuessExample/numberguess-ruleflow.png" alt="RuleFlow for the NumberGuess Example"/></div></div></div><br class="figure-break"/><p>If you open the <code class="filename">NumberGuess.rf</code> file in the Drools IDE (provided you have the JBoss Rules
  extensions installed correctly in Eclipse) you should see the above diagram, similar to a standard flowchart. Its
  icons are similar (but not exactly the same) as in the JBoss jBPM workflow product. Should you wish to edit the
  diagram, a menu of available components should be available to the left of the diagram in the IDE, which is called the
  <span class="emphasis"><em>palette</em></span>. This diagram is saved in XML, an (almost) human readable format, using XStream.</p><p>If it is not already open, ensure that the Properties View is visible in the IDE. It can be opened by clicking
  "Window", then "Show View" and "Other", where you can select the "Properties" view. If you do this
  <span class="emphasis"><em>before</em></span> you select any item on the rule flow (or click on the blank space in the rule flow) you
  should be presented with the following set of properties.</p><div class="figure"><a id="d0e28219"/><p class="title"><strong>Figure 23.24. Properties for the Number Guess Rule Flow</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/NumberGuessExample/numberguess-ruleflow-properties.png" alt="Properties for the Number Guess Rule Flow"/></div></div></div><br class="figure-break"/><p>Keep an eye on the Properties View as we progress through the example's rule flow, as it presents valuable
  information. In this case, it provides us with the identification of the Rule Flow Process that we used in our earlier
  code snippet, when we called <code class="code">session.startProcess()</code>.</p><p>In the "Number Guess" Rule Flow we encounter several node types, many of them identified by an icon.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The Start node (white arrow in a green circle) and the End node (red box) mark beginning and end of the
        rule flow.</p></li><li class="listitem"><p>A Rule Flow Group box (yellow, without an icon) represents a Rule Flow Groups defined in our rules (DRL)
        file that we will look at later. For example, when the flow reaches the Rule Flow Group "Too High", only those
        rules marked with an attribute of <code class="literal">ruleflow-group</code> <code class="code">"Too High"</code> can potentially
        fire.</p></li><li class="listitem"><p>Action nodes (yellow, cog-shaped icon) perform standard Java method calls. Most action nodes in this
        example call <code class="code">System.out.println()</code>, indicating the program's progress to the user.</p></li><li class="listitem"><p>Split and Join Nodes (blue ovals, no icon) such as "Guess Correct?" and "More guesses Join" mark places
        where the flow of control can split, according to various conditions, and rejoin, respectively</p></li><li class="listitem"><p>Arrows indicate the flow between the various nodes.</p></li></ul></div><p>The various nodes in combination with the rules make the Number Guess game work. For example, the "Guess" Rule
  Flow Group allows only the rule "Get user Guess" to fire, because only that rule has a matching attribute of
  <code class="literal">ruleflow-group</code> <code class="code">"Guess"</code>.</p><div class="example"><a id="d0e28266"/><p class="title"><strong>Example 23.69. A Rule firing only at a specific point in the Rule Flow: NumberGuess.drl</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Get user Guess"
    ruleflow-group "Guess"
    no-loop
    when
        $r : RandomNumber()
        rules : GameRules( allowed : allowedGuesses )
        game : Game( guessCount &lt; allowed )
        not ( Guess() )
    then
        System.out.println( "You have " + ( rules.allowedGuesses - game.guessCount )
                            + " out of " + rules.allowedGuesses
                            + " guesses left.\nPlease enter your guess from 0 to "
                            + rules.maxRange );
        br = new BufferedReader( new InputStreamReader( System.in ) );
        i = br.readLine();        
        modify ( game ) { guessCount = game.guessCount + 1 }
        insert( new Guess( i ) );
end</code></pre></div></div><br class="example-break"/><p>The rest of this rule is fairly standard. The LHS section (after <code class="literal">when</code>) of the rule states
  that it will be activated for each <code class="code">RandomNumber</code> object inserted into the Working Memory where
  <code class="code">guessCount</code> is less than <code class="code">allowedGuesses</code> from the <code class="code">GameRules</code> object and where the
  user has not guessed the correct number.</p><p>The RHS section (or consequence, after <code class="literal">then</code>) prints a message to the user and then awaits
  user input from <code class="code">System.in</code>. After obtaining this input (the <code class="code">readLine()</code> method call blocks
  until the return key is pressed) it modifies the guess count and inserts the new guess, making both available to the
  Working Memory.</p><p>The rest of the rules file is fairly standard: the package declares the dialect as MVEL, and various Java
  classes are imported. In total, there are five rules in this file:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Get User Guess, the Rule we examined above.</p></li><li class="listitem"><p>A Rule to record the highest guess.</p></li><li class="listitem"><p>A Rule to record the lowest guess.</p></li><li class="listitem"><p>A Rule to inspect the guess and retract it from memory if incorrect.</p></li><li class="listitem"><p>A Rule that notifies the user that all guesses have been used up.</p></li></ol></div><p>One point of integration between the standard Rules and the RuleFlow is via the
  <code class="literal">ruleflow-group</code> attribute on the rules, as discussed above. A <span class="emphasis"><em>second point of integration
  between the rules (.drl) file and the Rules Flow .rf files</em></span> is that the Split Nodes (the blue ovals) can use
  values in the Working Memory (as updated by the rules) to decide which flow of action to take. To see how this works,
  click on the "Guess Correct Node"; then within the Properties View, open the Constraints Editor by clicking the button
  at the right that appears once you click on the "Constraints" property line. You should see something similar to the
  diagram below.</p><div class="figure"><a id="d0e28325"/><p class="title"><strong>Figure 23.25. Edit Constraints for the "Guess Correct" Node</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/NumberGuessExample/numberguess-editconstraints.png" alt="Edit Constraints for the &#34;Guess Correct&#34; Node"/></div></div></div><br class="figure-break"/><p>Click on the "Edit" button beside "To node Too High" and you'll see a dialog like the one below. The values in
  the "Textual Editor" window follow the standard rule format for the LHS and can refer to objects in Working Memory.
  The consequence (RHS) is that the flow of control follows this node (i.e., "To node Too High") if the LHS expression
  evaluates to true.</p><div class="figure"><a id="d0e28333"/><p class="title"><strong>Figure 23.26. Constraint Editor for the "Guess Correct" Node: value too high</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/NumberGuessExample/numberguess-constraint-toohigh.png" alt="Constraint Editor for the &#34;Guess Correct&#34; Node: value too high"/></div></div></div><br class="figure-break"/><p>Since the file <code class="filename">NumberGuess.java</code> contains a <code class="code">main()</code> method, it can be run as a
  standard Java application, either from the command line or via the IDE. A typical game might result in the interaction
  below. The numbers in bold are typed in by the user.</p><div class="example"><a id="d0e28347"/><p class="title"><strong>Example 23.70. Example Console output where the Number Guess Example beat the human!</strong></p><div class="example-contents"><pre><code class="no-highlight">You have 5 out of 5 guesses left.
Please enter your guess from 0 to 100
<span class="bold"><strong>50</strong></span>
Your guess was too high
You have 4 out of 5 guesses left.
Please enter your guess from 0 to 100
<span class="bold"><strong>25</strong></span>
Your guess was too low
You have 3 out of 5 guesses left.
Please enter your guess from 0 to 100
<span class="bold"><strong>37</strong></span>
Your guess was too low
You have 2 out of 5 guesses left.
Please enter your guess from 0 to 100
<span class="bold"><strong>44</strong></span>
Your guess was too low
You have 1 out of 5 guesses left.
Please enter your guess from 0 to 100
<span class="bold"><strong>47</strong></span>
Your guess was too low
You have no more guesses
The correct guess was 48 

</code></pre></div></div><br class="example-break"/><p>A summary of what is happening in this sample is:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>The <code class="code">main()</code> method of <code class="filename">NumberGuessExample.java</code> loads a Rule Base, creates a
      Stateful Session and inserts <code class="code">Game</code>, <code class="code">GameRules</code> and <code class="code">RandomNumber</code> (containing
      the target number) objects into it. The method also sets the process flow we are going to use, and fires all
      rules. Control passes to the Rule Flow.</p></li><li class="listitem"><p>File <code class="filename">NumberGuess.rf</code>, the Rule Flow, begins at the "Start" node.</p></li><li class="listitem"><p>Control passes (via the "More guesses" join node) to the Guess node.</p></li><li class="listitem"><p>At the Guess node, the appropriate Rule Flow Group ("Get user Guess") is enabled. In this case the Rule
      "Guess" (in the <code class="filename">NumberGuess.drl</code> file) is triggered. This rule displays a message to the user,
      takes the response, and puts it into Working Memory. Flow passes to the next Rule Flow Node.</p></li><li class="listitem"><p>At the next node, "Guess Correct", constraints inspect the current session and decide which path to
      take.</p><p>If the guess in step 4 was too high or too low, flow proceeds along a path which has an action node with
      normal Java code printing a suitable message and a Rule Flow Group causing a highest guess or lowest guess rule to
      be triggered. Flow passes from these nodes to step 6.</p><p>If the guess in step 4 was right, we proceed along the path towards the end of the Rule Flow. Before we get
      there, an action node with normal Java code prints a statement "you guessed correctly". There is a join node here
      (just before the Rule Flow end) so that our no-more-guesses path (step 7) can also terminate the Rule Flow.</p></li><li class="listitem"><p>Control passes as per the Rule Flow via a join node, a guess incorrect Rule Flow Group (triggering a rule to
      retract a guess from Working Memory) onto the "More guesses" decision node.</p></li><li class="listitem"><p>The "More guesses" decision node (on the right hand side of the rule flow) uses constraints, again looking
      at values that the rules have put into the working memory, to decide if we have more guesses and if so, goto step
      3. If not, we proceed to the end of the rule flow, via a Rule Flow Group that triggers a rule stating "you have no
      more guesses".</p></li><li class="listitem"><p>The loop over steps 3 to 7 continues until the number is guessed correctly, or we run out of guesses.</p></li></ol></div></div><div class="section" title="23.11. Conway's Game Of Life"><div class="titlepage"><div><div><h2 class="title"><a id="d0e28419"/>23.11. Conway's Game Of Life</h2></div></div></div><pre><code class="no-highlight"><span class="bold"><strong>Name:</strong></span> Conway's Game Of Life
<span class="bold"><strong>Main class:</strong></span> org.drools.examples.conway.ConwayAgendaGroupRun
            org.drools.examples.conway.ConwayRuleFlowGroupRun
<span class="bold"><strong>Module:</strong></span> droolsjbpm-integration-examples (Note: this is in a different download, the droolsjbpm-integration download.)
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> conway-ruleflow.drl conway-agendagroup.drl
<span class="bold"><strong>Objective:</strong></span> Demonstrates 'accumulate', 'collect' and 'from'</code></pre><p>Conway's Game Of Life, described in <a class="link" href="http://en.wikipedia.org/wiki/Conway's_Game_of_Life">http://en.wikipedia.org/wiki/Conway's_Game_of_Life</a> and in
    <a class="link" href="http://www.math.com/students/wonders/life/life.html">http://www.math.com/students/wonders/life/life.html</a>,
    is a famous cellular automaton conceived in the early 1970's by the
    mathematician John Conway. While the system is well known as "Conway's
    Game Of Life", it really isn't a game at all. Conway's system is more like
    a simulation of a form of life. Don't be intimidated. The system
    is terribly simple and terribly interesting. Math and Computer Science
    students alike have marvelled over Conway's system for more than 30 years
    now. The application
    presented here is a Swing-based implementation of Conway's Game of Life.
    The rules that govern the system are implemented as business rules using
    Drools. This document will explain the rules that drive the simulation and
    discuss the Drools parts of the implementation.</p><p>We'll first introduce the grid view, shown below, designed for the
    visualisation of the game, showing the "arena" where the life simulation
    takes place. Initially the grid is empty, meaning that there are no live
    cells in the system. Each cell is either alive or dead, with live cells
    showing a green ball. Preselected patterns of live cells can be
    chosen from the "Pattern" drop-down list. Alternatively, individual
    cells can be doubled-clicked to toggle them between live and dead. It's
    important to understand that each cell is related to its neighboring cells,
    which is fundamental for the game's rules. Neighbors include not only
    cells to the left, right, top and bottom but also cells that are connected
    diagonally, so that each cell has a total of 8 neighbors. Exceptions
    are the four corner cells which have only three neighbors, and the cells
    along the four border, with five neighbors each.</p><div class="figure"><a id="d0e28451"/><p class="title"><strong>Figure 23.27. Conway's Game of Life: Starting a new game</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/ConwaysGameOfLifeExample/conway1.png" alt="Conway's Game of Life: Starting a new game"/></div></div></div><br class="figure-break"/><p>So what are the basic rules that govern this game? Its goal is to
    show the development of a population, generation by generation. Each
    generation results from the preceding one, based on the simultaneous
    evaluation of all cells. This is the simple set of rules that
    govern what the next generation will look like:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>If a live cell has fewer than 2 live neighbors, it dies of
        loneliness.</p></li><li class="listitem"><p>If a live cell has more than 3 live neighbors, it dies from
        overcrowding.</p></li><li class="listitem"><p>If a dead cell has exactly 3 live neighbors, it comes to
        life.</p></li></ul></div><p>That is all there is to it. Any cell that doesn't meet any of those
    criteria is left as is for the next generation. With those simple rules in
    mind, go back and play with the system a little bit more and step through
    some generations, one at a time, and notice these rules taking their
    effect.</p><p>The screenshot below shows an example generation, with a number of
    live cells. Don't worry about matching the exact patterns represented in
    the screen shot. Just get some groups of cells added to the grid. Once you
    have groups of live cells in the grid, or select a pre-designed pattern,
    click the "Next Generation" button and notice what happens. Some of the
    live cells are killed (the green ball disappears) and some dead cells come
    to life (a green ball appears). Step through several generations and see
    if you notice any patterns. If you click on the "Start" button, the system
    will evolve itself so you don't need to click the "Next Generation" button
    over and over. Play with the system a little and then come back here for
    more details of how the application works.</p><div class="figure"><a id="d0e28473"/><p class="title"><strong>Figure 23.28. Conway's Game of Life: A running game</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/ConwaysGameOfLifeExample/conway2.png" alt="Conway's Game of Life: A running game"/></div></div></div><br class="figure-break"/><p>Now lets delve into the code. As this is an advanced example we'll
    assume that by now you know your way around the Drools framework and are
    able to connect the presented highlight, so that we'll just focus at a
    high level overview. The example has two ways to execute, one way 
    uses Agenda Groups to manage execution flow, and the other one uses
    Rule Flow Groups to manage execution flow. These two versions are
    implemented in <code class="code">ConwayAgendaGroupRun</code> and
    <code class="code">ConwayRuleFlowGroupRun</code>, respectively. Here,
    we'll discuss the Rule Flow version, as it's what most people will
    use.</p><p>All the <code class="code">Cell</code> objects are inserted into the Session
    and the rules in the <code class="literal">ruleflow-group</code> "register neighbor" are
    allowed to execute by the Rule Flow process. This group of four rules
    creates <code class="code">Neighbor</code> relations between some cell and its
    northeastern, northern, northwestern and western neighbors. This
    relation is bidirectional, which takes care of the other four directions.
    Border cells don't need any special treatment - they simply won't be
    paired with neighboring cells where there isn't any. By
    the time all activations have fired for these rules, all cells are related
    to all their neighboring cells.</p><div class="example"><a id="d0e28498"/><p class="title"><strong>Example 23.71. Conway's Game of Life: Register Cell Neighbour relations</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "register north east"
    ruleflow-group "register neighbor"
when
    $cell: Cell( $row : row, $col : col )            
    $northEast : Cell( row  == ($row - 1), col == ( $col + 1 ) )    
then                    
    insert( new Neighbor( $cell, $northEast ) );
    insert( new Neighbor( $northEast, $cell ) );        
end

rule "register north"
    ruleflow-group "register neighbor"  
when
    $cell: Cell( $row : row, $col : col )   
    $north : Cell( row  == ($row - 1), col == $col )    
then        
    insert( new Neighbor( $cell, $north ) );
    insert( new Neighbor( $north, $cell ) );        
end

rule "register north west"
    ruleflow-group "register neighbor"
when
    $cell: Cell( $row : row, $col : col )           
    $northWest : Cell( row  == ($row - 1), col == ( $col - 1 ) )                        
then        
    insert( new Neighbor( $cell, $northWest ) );
    insert( new Neighbor( $northWest, $cell ) );        
end

rule "register west"
    ruleflow-group "register neighbor"
when
    $cell: Cell( $row : row, $col : col )          
    $west : Cell( row  == $row, col == ( $col - 1 ) )                       
then        
    insert( new Neighbor( $cell, $west ) );
    insert( new Neighbor( $west, $cell ) );         
end</code></pre></div></div><br class="example-break"/><p>Once all the cells are inserted, some Java code applies the pattern
    to the grid, setting certain cells to Live. Then, when the user clicks
    "Start" or "Next Generation", it executes the "Generation" ruleflow. This
    ruleflow is responsible for the management of all changes of cells in each
    generation cycle.</p><div class="figure"><a id="d0e28505"/><p class="title"><strong>Figure 23.29. Conway's Game of Life: rule flow "Generation"</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/ConwaysGameOfLifeExample/conway_ruleflow_generation.png" alt="Conway's Game of Life: rule flow &#34;Generation&#34;"/></div></div></div><br class="figure-break"/><p>The rule flow process first enters the "evaluate" group, which means
    that any active rule in the group can fire. The rules in this group apply
    the Game-of-Life rules discussed in the beginning of the example,
    determining the cells to be killed and the ones to be given life. We use
    the "phase" attribute to drive the reasoning of the Cell by specific
    groups of rules; typically the phase is tied to a Rule Flow Group in the
    Rule Flow process definition. Notice that it doesn't actually change the
    state of any <code class="code">Cell</code> objectss at this point; this is because 
    it's evaluating the grid in turn and it must complete the full evaluation
    until those changes can be applied. To achieve this, it sets the cell to
    a "phase" which is either <code class="code">Phase.KILL</code> or
    <code class="code">Phase.BIRTH</code>, used later to control actions applied
    to the <code class="code">Cell</code> object.</p><div class="example"><a id="d0e28525"/><p class="title"><strong>Example 23.72. Conway's Game of Life: Evaluate Cells with state changes</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Kill The Lonely"
    ruleflow-group "evaluate"
    no-loop
when
//  A live cell has fewer than 2 live neighbors
    theCell: Cell( liveNeighbors &lt; 2, cellState == CellState.LIVE,
                   phase == Phase.EVALUATE )
then
    modify( theCell ){
        setPhase( Phase.KILL );
    }
end

rule "Kill The Overcrowded"
    ruleflow-group "evaluate"
    no-loop
when
//  A live cell has more than 3 live neighbors
    theCell: Cell( liveNeighbors &gt; 3, cellState == CellState.LIVE,
                   phase == Phase.EVALUATE )
then
    modify( theCell ){
        setPhase( Phase.KILL );
    }
end

rule "Give Birth"
    ruleflow-group "evaluate"
    no-loop
when
//  A dead cell has 3 live neighbors
    theCell: Cell( liveNeighbors == 3, cellState == CellState.DEAD,
                   phase == Phase.EVALUATE )
then
    modify( theCell ){
        theCell.setPhase( Phase.BIRTH );
    }
end
</code></pre></div></div><br class="example-break"/><p>Once all <code class="code">Cell</code> objects in the grid have been evaluated,
    we first clear any calculation activations that occurred from any previous
    data changes. This is done via the "reset calculate" rule, which clears
    any activations in the "calculate" group. We then enter a split in the
    rule flow which allows any activations in both the "kill" and the "birth"
    group to fire. These rules are responsible for applying the state
    change.</p><div class="example"><a id="d0e28535"/><p class="title"><strong>Example 23.73. Conway's Game of Life: Apply the state changes</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "reset calculate"
    ruleflow-group "reset calculate"
when
then
    WorkingMemory wm = drools.getWorkingMemory();
    wm.clearRuleFlowGroup( "calculate" );
end

rule "kill"
    ruleflow-group "kill"
    no-loop
when
    theCell: Cell( phase == Phase.KILL )
then
    modify( theCell ){
        setCellState( CellState.DEAD ),
        setPhase( Phase.DONE );   
    }
end 
 
rule "birth"
    ruleflow-group "birth"
    no-loop
when
    theCell: Cell( phase == Phase.BIRTH )
then
    modify( theCell ){
        setCellState( CellState.LIVE ),
        setPhase( Phase.DONE );
    }
end </code></pre></div></div><br class="example-break"/><p>At this stage, a number of <code class="code">Cell</code> objects have been
    modified with the state changed to either <code class="code">LIVE</code> or
    <code class="code">DEAD</code>. Now we get to see the power of the
    <code class="code">Neighbor</code> facts defining the cell relations. When a cell
    becomes live or dead, we use the <code class="code">Neighbor</code> relation to
    iterate over all surrounding cells, increasing or decreasing the
    <code class="code">liveNeighbor</code> count. Any cell that has its count changed
    is also set to to the <code class="code">EVALUATE</code> phase, to make sure
    it is included in the reasoning during the evaluation stage of the
    Rule Flow Process. Notice that we don't have to do any iteration
    ourselves; simply by applying the relations in the rules we make
    the rule engine do all the hard work for us, with a minimal amount of
    code. Once the live count has been determined and set for all cells,
    the Rule Flow Process comes to and end. If the user has initially
    clicked the "Start" button, the engine will restart the rule flow;
    otherwise the user may request another generation.</p><div class="example"><a id="d0e28563"/><p class="title"><strong>Example 23.74. Conway's Game of Life: Evaluate cells with state changes</strong></p><div class="example-contents"><pre><code class="no-highlight">rule "Calculate Live"
    ruleflow-group "calculate"
    lock-on-active  
when
    theCell: Cell( cellState == CellState.LIVE )
    Neighbor( cell == theCell, $neighbor : neighbor ) 
then
    modify( $neighbor ){
        setLiveNeighbors( $neighbor.getLiveNeighbors() + 1 ),
        setPhase( Phase.EVALUATE );   
    }
end 

rule "Calculate Dead"
    ruleflow-group "calculate"
    lock-on-active  
when
    theCell: Cell( cellState == CellState.DEAD )
    Neighbor( cell == theCell, $neighbor : neighbor )
then
    modify( $neighbor ){
        setLiveNeighbors( $neighbor.getLiveNeighbors() - 1 ),
        setPhase( Phase.EVALUATE );
    }
end </code></pre></div></div><br class="example-break"/></div><div class="section" title="23.12. Invaders"><div class="titlepage"><div><div><h2 class="title"><a id="d0e28568"/>23.12. Invaders</h2></div></div></div><p>A simplifed version of the Space Invaders game. Use the keys Z and K, to move left and right and M to fire a
    misile. The example is built up over 6 projects, each adding slightly more complexity to the last.</p><pre><code class="no-highlight"><span class="bold"><strong>Name:</strong></span> Example Invaders
<span class="bold"><strong>Main class:</strong></span> org.drools.games.invaders.Invaders1Main
<span class="bold"><strong>Main class:</strong></span> org.drools.games.invaders.Invaders2Main
<span class="bold"><strong>Main class:</strong></span> org.drools.games.invaders.Invaders3Main
<span class="bold"><strong>Main class:</strong></span> org.drools.games.invaders.Invaders4Main
<span class="bold"><strong>Main class:</strong></span> org.drools.games.invaders.Invaders5Main
<span class="bold"><strong>Main class:</strong></span> org.drools.games.invaders.Invaders6Main</code></pre><div class="figure"><a id="d0e28595"/><p class="title"><strong>Figure 23.30. Pong Screenshot</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/Invaders/invaders.png" alt="Pong Screenshot"/></div></div></div><br class="figure-break"/><div class="section" title="23.12.1. Invaders1Main"><div class="titlepage"><div><div><h3 class="title"><a id="d0e28601"/>23.12.1. Invaders1Main</h3></div></div></div><p>Invaders1Main creates the frame and attaches the KeyListener, feeding key events into the engine. It also sets up the main game loop which can be found in "Main.drl". 
    The typical convention used through out the example is to have one agenda group per file, and all rules in that file in the same agenda group.</p><p>The Run fact is used to drive the repeat of the Game loop. Initially there are only one groups that is evaluated, Keys. The "keys.drl" file is shared by several examples, and illustrates rule re-use across multipel projects.</p><div class="example"><a id="d0e28608"/><p class="title"><strong>Example 23.75. Game Loop</strong></p><div class="example-contents"><pre><code class="language-drl">
rule "init" when
then
    insert( new Run() );
    setFocus( "Init" );
end

rule GameLoop when
    r : Run()
then
    setFocus( "Keys" );
end


rule Draw when
    r : Run()
then
    ui.show();
    modify( r ) {} // force loop
end        
      </code></pre></div></div><br class="example-break"/></div><div class="section" title="23.12.2. Invaders2Main"><div class="titlepage"><div><div><h3 class="title"><a id="d0e28613"/>23.12.2. Invaders2Main</h3></div></div></div><p>Invaders2Main adds the "Draw" stage to the game loop and draws the SpaceShip</p><div class="example"><a id="d0e28618"/><p class="title"><strong>Example 23.76. Game Loop</strong></p><div class="example-contents"><pre><code class="language-drl">
rule GameLoop when
    r : Run()
then
    setFocus( "Draw" );
    setFocus( "Keys" );
end    
      </code></pre></div></div><br class="example-break"/></div><div class="section" title="23.12.3. Invaders3Main"><div class="titlepage"><div><div><h3 class="title"><a id="d0e28623"/>23.12.3. Invaders3Main</h3></div></div></div><p>Invaders3Main adds move controls to the spaceship, notice the ship moves out of the boundaries of the screen. KeyPressed is detected and that sets a delta of dx on the ship direction. That delta is then repeated applied to the x position of the ship</p><div class="example"><a id="d0e28628"/><p class="title"><strong>Example 23.77. Move Ship</strong></p><div class="example-contents"><pre><code class="language-drl">
rule ShipDeltaMoveLeft agenda-group "Move" when
    s : Ship()
        KeyPressed( keyText == "Z" )
then
    modify( s ) { dx = 0 - s.speed }
end

rule ShipDeltaStopLeft agenda-group "Move" when
    s : Ship()
        not KeyPressed( keyText == "Z" )
then
    modify( s ) { dx = 0 }
end

rule ShipMove agenda-group "Move" when
    s : Ship( dx != 0 )
    Run()
then
    modify( s ) { x = s.x + s.dx }
end
      </code></pre></div></div><br class="example-break"/></div><div class="section" title="23.12.4. Invaders4Main"><div class="titlepage"><div><div><h3 class="title"><a id="d0e28633"/>23.12.4. Invaders4Main</h3></div></div></div><p>Invaders4Main adds boundari control to the ShipMove rule, so it doesn't move off the screen. Notice the use of "@watch( !x )", this ensures that while the rule wil modify
    the x property, it will not react to changes to x, which avoids recursion issues.</p><div class="example"><a id="d0e28638"/><p class="title"><strong>Example 23.78. Move Ship with Boundaries</strong></p><div class="example-contents"><pre><code class="language-drl">
rule ShipMove agenda-group "Move" when
    s : Ship( dx != 0, x + dx &gt; 0,  x + dx + width &lt; conf.windowWidth ) @watch( !x )
    Run()
then
    modify( s ) { x = s.x + s.dx }
end
      </code></pre></div></div><br class="example-break"/></div><div class="section" title="23.12.5. Invaders5Main"><div class="titlepage"><div><div><h3 class="title"><a id="d0e28643"/>23.12.5. Invaders5Main</h3></div></div></div><p>Invaders5Main updates the "Draw" group to draw 5 Invaders.</p></div><div class="section" title="23.12.6. Invaders6Main"><div class="titlepage"><div><div><h3 class="title"><a id="d0e28648"/>23.12.6. Invaders6Main</h3></div></div></div><p>Invaders6Main adds a lot more meat. Pressing the "M" key fires a missile that travels up the screen, while moving collision between the missile and the invader is checked.</p></div><div class="section" title="23.12.7. Invaders4Main"><div class="titlepage"><div><div><h3 class="title"><a id="d0e28653"/>23.12.7. Invaders4Main</h3></div></div></div><p>Invaders4Main adds boundari control to the ShipMove rule, so it doesn't move off the screen. Notice the use of "@watch( !x )", this ensures that while the rule wil modify
        the x property, it will not react to changes to x, which avoids recursion issues.</p><div class="example"><a id="d0e28658"/><p class="title"><strong>Example 23.79. Fire Missile</strong></p><div class="example-contents"><pre><code class="language-drl">
rule InsertBullet agenda-group "Bullet" when
        KeyPressed( keyText == "M" )
    s : Ship()
    not Bullet()
then
    b = new Bullet();
    b.x = s.x + (s.width/2) - (b.width/2);
    b.y = s.y - s.height - b.height;
    b.width = conf.bulletWidth;
    b.height = conf.bulletHeight;
    b.dy = 0 - conf.bulletSpeed;
    insert( b );
end


rule BulletMove agenda-group "Bullet" when
    b : Bullet( y &gt; 0 ) @watch( !y )
    Run()
then
    modify( b ) { y = b.y + b.dy }
end

rule Collision agenda-group "Bullet" when
    b : Bullet( ) @watch( y )
    i : Invader( x &lt; b.x, x + width &gt; b.x, y &gt; b.y)
    Run()
then
    modify( i ) { alive = false }
end
      </code></pre></div></div><br class="example-break"/></div></div><div class="section" title="23.13. Adventures with Drools"><div class="titlepage"><div><div><h2 class="title"><a id="d0e28663"/>23.13. Adventures with Drools</h2></div></div></div><p>Based on the Adventure in Prolog, over at the Amzi website, <a class="link" href="http://www.amzi.com/AdventureInProlog/">http://www.amzi.com/AdventureInProlog/</a>,
  we started to work on a text adventure game for Drools. They are ideal as
  they can start off simple and build in complexity and size over time, they
  also demonstrate key aspects of declarative relational programming.</p><pre><code class="no-highlight"><span class="bold"><strong>Name:</strong></span> Example Text Adventure
<span class="bold"><strong>Main class:</strong></span> org.drools.games.adventure.TextAdventure</code></pre><p>The game allows you to play as the hero or the monster. If you click "New Window" you can open one window as the
    hero and another as the monster, and play them both at the same time. The game allows either character to move
    around rooms, pick up, drop or use things. Doors can be locked and unlocked, by using the key on teh exit room, and
    the hero can kill the monster by using the umbrella on the monster.</p><p>You can view the 8 minute demonstration and introduction for the
  example at <a class="link" href="http://downloads.jboss.org/drools/videos/text-adventures.swf">http://downloads.jboss.org/drools/videos/text-adventures.swf</a>. Be aware the video is now much 
    older than the current improved example.</p><div class="figure"><a id="d0e28685"/><p class="title"><strong>Figure 23.31. Text Adventure Screenshot</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/TextAdventureExample/textadventure.png" alt="Text Adventure Screenshot"/></div></div></div><br class="figure-break"/><div class="section" title="23.13.1. Using the game."><div class="titlepage"><div><div><h3 class="title"><a id="d0e28691"/>23.13.1. Using the game.</h3></div></div></div><p>Each action follows the constructor arguments of the associated Command java class.</p><div class="example"><a id="d0e28696"/><p class="title"><strong>Example 23.80. MoveCommand</strong></p><div class="example-contents"><pre><code class="language-java">
  @PropertyReactive
  public class MoveCommand extends Command {
  
      @Position(1)
      private Character character;
  
      @Position(2)
      private Room      room;
  
      public MoveCommand(Character character, Room room) {
          this.character = character;
          this.room = room;
      }    
    </code></pre></div></div><br class="example-break"/><p>To issue a move action, select the "Move" button, then select the exit room. Notice when you press "Move" it adds the text to the white bar at the bottom.
    When the exit room is selected, it also is added to the white bar. Then press send and the game engine will execute the command. Internally it uses reflection to
    instantiate the Command and insert it into the engine. If you select incorrect arguments, such as pressing exits multiple times, the reflection will fail and you can attempt it again.
  </p><div class="figure"><a id="d0e28703"/><p class="title"><strong>Figure 23.32. Move Action</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/TextAdventureExample/MoveCommand.png" alt="Move Action"/></div></div></div><br class="figure-break"/><p>The Things list displays anything you can see in the room, not all things can be picked up. For instance you can pick up the key and the torch, but not the monster.
  When something is picked up it moves from the Things list to the Inventory List. The reverse is true when something is dropped.</p><div class="figure"><a id="d0e28711"/><p class="title"><strong>Figure 23.33. Pickup Action</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/TextAdventureExample/PickUpCommand.png" alt="Pickup Action"/></div></div></div><br class="figure-break"/><p>The key is in the office, move upstairs and into the office. Then pick up the key. Move back downstairs and into the kitchen. Try and walk into the basement, notice it's locked.</p><p>Select the "Use" action, the select the key and then the basement exit. This will unlock the door and you can now walk through.</p><p>To kill the monster pick up the umbrella from the lounge and then select "Use", then select the imbrella and
      finally select the monster.</p><p>Don't forget to open a "New Window" to play as the monster, although you will not be able to exit the basement
      until the hero has opened it with the key. The monster and the hero can also give items to each other, moving
      items between each playsers inventory.</p></div><div class="section" title="23.13.2. The code"><div class="titlepage"><div><div><h3 class="title"><a id="d0e28725"/>23.13.2. The code</h3></div></div></div><p>The model is written in Java classes. Each classes uses @PropertyReactive and @Position. @PropertyReactive allows control of which fields patterns react to, and @Position maps
      a field to a argument position allowing positional as well as named arguments for patterns.</p><div class="example"><a id="d0e28730"/><p class="title"><strong>Example 23.81. Game World Data Example</strong></p><div class="example-contents"><pre><code class="language-java">
@PropertyReactive
public class Thing {
    @Position(0)
    private long id;

    @Position(1)
    private String name;

    public Thing(long id, String name) {
        this.id = id;
        this.name = name;
    }
    ...
}
    </code></pre></div></div><br class="example-break"/><p>An MVEL data file is used to populate our world, see "data.mvel". You can edit this file to add new rooms,
      items and characters, as well as locks for doors.</p><div class="example"><a id="d0e28737"/><p class="title"><strong>Example 23.82. Game World Data Example</strong></p><div class="example-contents"><pre><code class="language-xml">
rooms = [
    "basement" : new Room("basement"),
    "lounge" : new Room("lounge"),
    "kitchen" : new Room("kitchen"),
    "ground floor hallway" : new Room("ground floor hallway"),
    "bedroom" : new Room("bedroom"),
    "office" : new Room("office"),
    "first floor hallway" : new Room("first floor hallway")
];

doors = [
    "d1" : new Door( rooms["kitchen"], rooms["basement"] ),
    "d2" : new Door( rooms["ground floor hallway"], rooms["lounge"]),
    "d4" : new Door( rooms["ground floor hallway"], rooms["kitchen"]),
    "d5" : new Door( rooms["ground floor hallway"], rooms[ "first floor hallway"] ),
    "d8" : new Door( rooms["first floor hallway"], rooms[ "bedroom"] ),
    "d9" : new Door( rooms["first floor hallway"], rooms[ "office"] )
];

locations = [
    "monster" :  new Location( characters["monster"], rooms["basement"] ),
    "hero" :  new Location( characters["hero"], rooms["ground floor hallway"] ),
    "umbrella" :  new Location( items["umbrella"], rooms["lounge"] ),
    "key1" :  new Location( items["key1"], rooms["office"] )
];
    </code></pre></div></div><br class="example-break"/><p>The game creates commands, which it inserts into the engine. These commands are then used to change the state
      of the world and that state is reflected back in the UI. The commands can be found in the "commands.drl" file. The
      following rule matches the MoveCommand and if it's valid it will make the move happen.</p><div class="example"><a id="d0e28744"/><p class="title"><strong>Example 23.83. Move a Characters</strong></p><div class="example-contents"><pre><code class="language-drl">
rule validMove agenda-group "commands" when
    mc : MoveCommand( c : character, r : room )
    l  : Location( thing == c, ltarget : target ) @watch( !target )
    ?connect( d, r, ltarget; )
then
    exit = new ExitEvent( c, (Room) l.target );
    enter = new EnterEvent( c, r );

    modify( l ) { target = r };

    insert( exit );
    insert( enter );

    mc.session.channels["output"].send( "You have entered the " + l.target.name + "\n" );
end
    </code></pre></div></div><br class="example-break"/><p>In the above rules notice the "connect" pattern, this is actually a query. In the MVEL data file doors are
      only described one way, we can use a query to check connections bi-directionally. The queries can be found in the
      "queries.drl" file.</p><div class="example"><a id="d0e28751"/><p class="title"><strong>Example 23.84. connect</strong></p><div class="example-contents"><pre><code class="language-drl">
query connect( Door $d, Room $x, Room $y )
    $d := Door($id, $name, $x, $y;)
    or 
    $d :=Door($id, $name, $y, $x;)
end
    </code></pre></div></div><br class="example-break"/><p>The UI has its list boxes populated by rules found in "UiView.drl", those rules in turn use queries. Here is
      how the "Things" list box is populated, when ever the world changes.</p><div class="example"><a id="d0e28758"/><p class="title"><strong>Example 23.85. Update the UI</strong></p><div class="example-contents"><pre><code class="language-drl">
rule updateThings salience 5  when                            
    session : UserSession( $char : character )
    things( $char, $things; )                                                      
then
    session.channels["things"].send( $things );
end

query things(Character $char, List $things)
    $char := Character()
    Location( $char, $room; )
    $things := List() from accumulate( Location($thing, $room; thing != $char),
                                       collectList( $thing ) )      
end
    </code></pre></div></div><br class="example-break"/></div></div><div class="section" title="23.14. Pong"><div class="titlepage"><div><div><h2 class="title"><a id="d0e28763"/>23.14. Pong</h2></div></div></div><p>A Conversion for the classic game Pong. Use the keys A, Z and K, M.
  The ball should get faster after each bounce.</p><pre><code class="no-highlight"><span class="bold"><strong>Name:</strong></span> Example Pong
<span class="bold"><strong>Main class:</strong></span> org.drools.games.pong.PongMain</code></pre><div class="figure"><a id="d0e28775"/><p class="title"><strong>Figure 23.34. Pong Screenshot</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/PongExample/pong.png" alt="Pong Screenshot"/></div></div></div><br class="figure-break"/></div><div class="section" title="23.15. Wumpus World"><div class="titlepage"><div><div><h2 class="title"><a id="d0e28781"/>23.15. Wumpus World</h2></div></div></div><pre><code class="no-highlight"><span class="bold"><strong>Name:</strong></span> Example Wumpus World
<span class="bold"><strong>Main class:</strong></span> org.drools.games.wumpus.WumpusWorldMain</code></pre><p>Wumpus World is an AI example covered in the book "Artificial
  Intelligence : A Modern Approach". When the game first starts all the cells
  are greyed out. As you walk around they become visible. The cave has pits, a
  wumpus and gold. When you are next to a pit you will feel a breeze, when you
  are next to the wumpus you will smell a stench and see glitter when next to
  gold. The sensor icons are shown above the move buttons. If you walk into a
  pit or the wumpus, you die. A more detailed overview of Wumpus World can be
  found at <a class="link" href="http://www.cis.temple.edu/~giorgio/cis587/readings/wumpus.shtml">http://www.cis.temple.edu/~giorgio/cis587/readings/wumpus.shtml</a>.
  A 20 minute video showing how the game is created and works is at <a class="link" href="http://www.youtube.com/watch?v=4CvjKqUOEzM">http://www.youtube.com/watch?v=4CvjKqUOEzM.</a></p><div class="figure"><a id="d0e28798"/><p class="title"><strong>Figure 23.35. Wumpus World</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/WumpusWorldExample/wumpus1.png" alt="Wumpus World"/></div></div></div><br class="figure-break"/><div class="figure"><a id="d0e28804"/><p class="title"><strong>Figure 23.36. Cave Screenshot</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/WumpusWorldExample/wumpus2.png" alt="Cave Screenshot"/></div></div></div><br class="figure-break"/><div class="figure"><a id="d0e28810"/><p class="title"><strong>Figure 23.37. Signals Screenshot</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/WumpusWorldExample/wumpus3.png" alt="Signals Screenshot"/></div></div></div><br class="figure-break"/><div class="figure"><a id="d0e28816"/><p class="title"><strong>Figure 23.38. Smell Stench</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/WumpusWorldExample/wumpus4.png" alt="Smell Stench"/></div></div></div><br class="figure-break"/><div class="figure"><a id="d0e28822"/><p class="title"><strong>Figure 23.39. Move Up, Wumpus Collision</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/WumpusWorldExample/wumpus5.png" alt="Move Up, Wumpus Collision"/></div></div></div><br class="figure-break"/></div><div class="section" title="23.16. Miss Manners and Benchmarking"><div class="titlepage"><div><div><h2 class="title"><a id="d0e28828"/>23.16. Miss Manners and Benchmarking</h2></div></div></div><pre><code class="no-highlight"><span class="bold"><strong>Name:</strong></span> Miss Manners
<span class="bold"><strong>Main class:</strong></span> org.drools.benchmark.manners.MannersBenchmark
<span class="bold"><strong>Module:</strong></span> drools-examples
<span class="bold"><strong>Type:</strong></span> Java application
<span class="bold"><strong>Rules file:</strong></span> manners.drl
<span class="bold"><strong>Objective:</strong></span> Advanced walkthrough on the Manners benchmark, covers Depth conflict resolution in depth.</code></pre><div class="section" title="23.16.1. Introduction"><div class="titlepage"><div><div><h3 class="title"><a id="d0e28850"/>23.16.1. Introduction</h3></div></div></div><p>Miss Manners is throwing a party and, being a good host, she wants
      to arrange good seating. Her initial design arranges everyone in 
      male-female pairs, but then she worries about people have things to talk
      about. What is a good host to do? She decides to note the hobby of
      each guest so she can then arrange guests not only pairing them according
      to alternating sex but also ensuring that a guest has someone with a
      common hobby, at least on one side.</p><div class="figure"><a id="d0e28855"/><p class="title"><strong>Figure 23.40. Miss Manners' Guests</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Examples/MannersExample/guests_at_table.png" align="middle" alt="Miss Manners' Guests"/></div></div></div><br class="figure-break"/><div class="section" title="23.16.1.1. BenchMarking"><div class="titlepage"><div><div><h4 class="title"><a id="d0e28861"/>23.16.1.1. BenchMarking</h4></div></div></div><p>Five benchmarks were established in the 1991 paper "Effects of
        Database Size on Rule System Performance: Five Case Studies" by 
        David Brant, Timothy Grose, Bernie Lofaso and Daniel P. Miranker:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="bold"><strong>Manners</strong></span> uses a 
            depth-first search approach to determine the
            seating arrangements alternating women and men and ensuring
            one common hobby for neighbors.</p></li><li class="listitem"><p><span class="bold"><strong>Waltz</strong></span> establishes
            a three-dimensional interpretation of a line drawing by
            line labeling by constraint propagation.</p></li><li class="listitem"><p><span class="bold"><strong>WaltzDB</strong></span> is a more
            general version of Waltz, supporting junctions of more
            than three lines and using a database.</p></li><li class="listitem"><p><span class="bold"><strong>ARP</strong></span> is a 
            route planner for a robotic air vehicle using the A*
            search algorithm to achieve minimal cost.</p></li><li class="listitem"><p><span class="bold"><strong>Weaver</strong></span> 
            VLSI router for channels and boxes using a black-board
            technique.</p></li></ul></div><p>Manners has become the de facto rule engine benchmark.
        Its behavior, however, is now well known and many engines
        optimize for this, thus negating its usefulness as a benchmark 
        which is why Waltz is becoming more favorable. These five
        benchmarks are also published at the University of Texas <a class="link" href="http://www.cs.utexas.edu/ftp/pub/ops5-benchmark-suite/">http://www.cs.utexas.edu/ftp/pub/ops5-benchmark-suite/</a>.</p></div><div class="section" title="23.16.1.2. Miss Manners Execution Flow"><div class="titlepage"><div><div><h4 class="title"><a id="d0e28897"/>23.16.1.2. Miss Manners Execution Flow</h4></div></div></div><p>After the first seating arrangement has been assigned, a
        depth-first recursion occurs which repeatedly assigns correct
        seating arrangements until the last seat is assigned. Manners
        uses a <code class="code">Context</code> instance to control execution flow.
        The activity diagram is partitioned to show the relation of the
        rule execution to the current <code class="code">Context</code> state.</p><div class="figure"><a id="d0e28908"/><p class="title"><strong>Figure 23.41. Manners Activity Diagram</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Examples/MannersExample/manners_activity_diagram.png" align="middle" alt="Manners Activity Diagram"/></div></div></div><br class="figure-break"/></div><div class="section" title="23.16.1.3. The Data and Results"><div class="titlepage"><div><div><h4 class="title"><a id="d0e28914"/>23.16.1.3. The Data and Results</h4></div></div></div><p>Before going deeper into the rules, let's first take a look
        at the asserted data and the resulting seating arrangement. The
        data is a simple set of five guests who should be arranged so
        that sexes alternate and neighbors have a common hobby.</p><p><span class="bold"><strong>The Data</strong></span></p><p>The data is given in OPS5 syntax, with a parenthesized
        list of name and value pairs for each attribute. Each
        person has only one hobby.</p><div class="literallayout"><p>(guest (name n1) (sex m) (hobby  h1)  )<br/>
(guest (name n2) (sex f) (hobby  h1)  )<br/>
(guest (name n2) (sex f) (hobby  h3)  )<br/>
(guest (name n3) (sex m) (hobby  h3)  )<br/>
(guest (name n4) (sex m) (hobby  h1)  )<br/>
(guest (name n4) (sex f) (hobby  h2)  )<br/>
(guest (name n4) (sex f) (hobby  h3)  )<br/>
(guest (name n5) (sex f) (hobby  h2)  )<br/>
(guest (name n5) (sex f) (hobby  h1)  )<br/>
(last_seat (seat 5)  )</p></div><p><span class="bold"><strong>The Results</strong></span></p><p>Each line of the results list is printed per execution of the
        "Assign Seat" rule. They key bit to notice is that each line has
        a "pid" value one greater than the last. (The significance of this
        will be explained in the discussion of the rule "Assign Seating".)
        The "ls", "rs", "ln" and "rn" refer to the left and right
        seat and neighbor's name, respectively. The actual implementation
        uses longer attribute names (e.g., <code class="code">leftGuestName</code>,
        but here we'll stick to the notation from the original
        implementation.</p><div class="literallayout"><p>[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5] <br/>
[Seating id=2, pid=1, done=false, ls=1, ln=n5, rs=2, rn=n4] <br/>
[Seating id=3, pid=2, done=false, ls=2, ln=n4, rs=3, rn=n3] <br/>
[Seating id=4, pid=3, done=false, ls=3, rn=n3, rs=4, rn=n2] <br/>
[Seating id=5, pid=4, done=false, ls=4, ln=n2, rs=5, rn=n1]</p></div></div></div><div class="section" title="23.16.2. In depth Discussion"><div class="titlepage"><div><div><h3 class="title"><a id="d0e28936"/>23.16.2. In depth Discussion</h3></div></div></div><div class="section" title="23.16.2.1. Cheating"><div class="titlepage"><div><div><h4 class="title"><a id="d0e28939"/>23.16.2.1. Cheating</h4></div></div></div><p>Manners has been designed to exercise cross product
        joins and Agenda activities. Many people not understanding this
        tweak the example to achieve better performance, making their
        port of the Manners benchmark pointless. Known cheats or
        porting errors for Miss Manners are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Using arrays for a guests hobbies, instead of asserting each
            one as a single fact massively reduces the cross products.</p></li><li class="listitem"><p>Altering the sequence of data can also reduce the
            amount of matching, increasing execution speed.</p></li><li class="listitem"><p>It's possible to change the <code class="literal">not</code> Conditional
            Element so that the test algorithm only uses the
            "first-best-match", which is, basically, transforming
            the test algorithm to backward chaining. The results are only
            comparable to other backward chaining rule engines or ports of
            Manners.</p></li><li class="listitem"><p>Removing the context so the rule engine matches the guests
            and seats prematurely. A proper port will prevent facts from
            matching using the context start.</p></li><li class="listitem"><p>It's possible to prevent the rule engine from performing
            combinatorial pattern matching.</p></li><li class="listitem"><p>If no facts are retracted in the reasoning cycle, as a
            result of the <code class="literal">not</code> CE, the port is incorrect.</p></li></ul></div></div><div class="section" title="23.16.2.2. Conflict Resolution"><div class="titlepage"><div><div><h4 class="title"><a id="d0e28969"/>23.16.2.2. Conflict Resolution</h4></div></div></div><p>The Manners benchmark was written for OPS5 which has two conflict
        resolution strategies, LEX and MEA. LEX is a chain of several
        strategies including salience, recency and complexity. The recency
        part of the strategy drives the depth first (LIFO) firing order.
        The CLIPS  manual documents the Recency strategy as follows:</p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>Every fact and instance is marked internally with a "time tag"
          to indicate its relative recency with respect to every other fact
          and instance in the system. The pattern entities associated with
          each rule activation are sorted in descending order for determining
          placement. An activation with a more recent pattern entity is
          placed before activations with less recent pattern entities. To
          determine the placement order of two activations, compare the sorted
          time tags of the two activations one by one starting with the
          largest time tags. The comparison should continue until one
          activation’s time tag is greater than the other activation’s
          corresponding time tag. The activation with the greater time tag is
          placed before the other activation on the agenda. If one activation
          has more pattern entities than the other activation and the compared
          time tags are all identical, then the activation with more time tags
          is placed before the other activation on the agenda.</p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution">CLIPS Reference Manual</span></td></tr></table></div><p>However Jess and CLIPS both use the Depth strategy, which is
        simpler and lighter, which Drools also adopted. The CLIPS manual
        documents the Depth strategy as:</p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>Newly activated rules are placed above all rules of the same
          salience. For example, given that fact-a activates rule-1 and rule-2
          and fact-b activates rule-3 and rule-4, then if fact-a is asserted
          before fact-b, rule-3 and rule-4 will be above rule-1 and rule-2 on
          the agenda. However, the position of rule-1 relative to rule-2 and
          rule-3 relative to rule-4 will be arbitrary.</p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution">CLIPS Reference Manual</span></td></tr></table></div><p>The initial Drools implementation for the Depth strategy would
        not work for Manners without the use of salience on the "make_path"
        rule. The CLIPS support team had this to say:</p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>The default conflict resolution strategy for CLIPS, Depth, is
          different than the default conflict resolution strategy used by
          OPS5. Therefore if you directly translate an OPS5 program to CLIPS,
          but use the default depth conflict resolution strategy, you're only
          likely to get the correct behavior by coincidence. The LEX and MEA
          conflict resolution strategies are provided in CLIPS to allow you to
          quickly convert and correctly run an OPS5 program in CLIPS.</p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution">Clips Support Forum</span></td></tr></table></div><p>Investigation into the CLIPS code reveals there is undocumented
        functionality in the Depth strategy. There is an accumulated time tag
        used in this strategy; it's not an extensively fact by fact comparison
        as in the recency strategy, it simply adds the total of all the time
        tags for each activation and compares.</p></div><div class="section" title="23.16.2.3. Rule &#34;assignFirstSeat&#34;"><div class="titlepage"><div><div><h4 class="title"><a id="d0e28995"/>23.16.2.3. Rule "assignFirstSeat"</h4></div></div></div><p>Once the context is changed to <code class="code">START_UP</code>,
        activations are created for all asserted guest. Because all
        activations are created as the result of a single Working Memory
        action, they all have the same Activation time tag. The last
        asserted <code class="code">Guest</code> object would have a higher fact
        time tag, and its Activation would fire because it has the highest
        accumulated fact time tag. The execution order in this rule has little
        importance, but has a big impact in the rule "Assign Seat". The
        activation fires and asserts the first <code class="code">Seating</code>
        arrangement and a <code class="code">Path</code>, and then sets the
        <code class="code">Context</code> attribute <code class="code">state</code> to create 
        an activation for rule <code class="code">findSeating</code>.</p><pre><code class="no-highlight">rule assignFirstSeat
    when
        context : Context( state == Context.START_UP )
        guest : Guest()
        count : Count()
    then
        String guestName = guest.getName();
        
        Seating seating =
          new Seating( count.getValue(), 1, true, 1, guestName, 1, guestName);
        insert( seating );
        
        Path path = new Path( count.getValue(), 1, guestName );
        insert( path );
        
        modify( count ) { setValue ( count.getValue() + 1 )  }

    System.out.println( "assign first seat :  " + seating + " : " + path );

        modify( context ) {
            setState( Context.ASSIGN_SEATS )
        } 
end</code></pre></div><div class="section" title="23.16.2.4. Rule &#34;findSeating&#34;"><div class="titlepage"><div><div><h4 class="title"><a id="d0e29023"/>23.16.2.4. Rule "findSeating"</h4></div></div></div><p>This rule determines each of the <code class="code">Seating</code>
        arrangements. The rule creates cross product solutions for
        <span class="emphasis"><em>all</em></span> asserted <code class="code">Seating</code> arrangements
        against <span class="emphasis"><em>all</em></span> the asserted guests except 
        against itself or any already assigned chosen solutions.</p><pre><code class="no-highlight">rule findSeating
   when 
       context : Context( state == Context.ASSIGN_SEATS )
       $s      : Seating( pathDone == true )
       $g1     : Guest( name == $s.rightGuestName )
       $g2     : Guest( sex != $g1.sex, hobby == $g1.hobby )

       count   : Count()

       not ( Path( id == $s.id, guestName == $g2.name) )
       not ( Chosen( id == $s.id, guestName == $g2.name, hobby == $g1.hobby) )
   then
       int rightSeat = $s.getRightSeat();
       int seatId = $s.getId();
       int countValue = count.getValue();
       
       Seating seating =
         new Seating( countValue, seatId, false, rightSeat,
                      $s.getRightGuestName(), rightSeat + 1, $g2.getName() );
       insert( seating );
                            
       Path path = new Path( countValue, rightSeat + 1, $g2.getName()  );
       insert( path );
       
       Chosen chosen = new Chosen( seatId, $g2.getName(), $g1.getHobby() );
       insert( chosen  );

       System.err.println( "find seating : " + seating + " : " + path +
                           " : " + chosen);

       modify( count ) {setValue(  countValue + 1 )}
       modify( context ) {setState( Context.MAKE_PATH )}
end</code></pre><p>However, as can be seen from the printed results shown earlier,
        it is essential that only the <code class="code">Seating</code> with the highest
        <code class="code">pid</code> cross product be chosen. How can this be possible
        if we have activations, of the same time tag, for nearly all
        existing <code class="code">Seating</code> and <code class="code">Guest</code> objects? For
        example, on the third iteration of <code class="code">findSeating</code> the
        produced activations will be as shown below. Remember, this is from
        a very small data set, and with larger data sets there would be many
        more possible activated <code class="code">Seating</code> solutions, with multiple
        solutions per <code class="code">pid</code>:</p><div class="literallayout"><p>=&gt;[ActivationCreated(35): rule=findSeating <br/>
[fid:19:33]:[Seating id=3, pid=2, done=true, ls=2, ln=n4, rs=3, rn=n3] <br/>
[fid:4:4]:[Guest name=n3, sex=m, hobbies=h3] <br/>
[fid:3:3]:[Guest name=n2, sex=f, hobbies=h3]<br/>
<br/>
=&gt;[ActivationCreated(35): rule=findSeating <br/>
[fid:15:23]:[Seating id=2, pid=1, done=true, ls=1, ln=n5, rs=2, rn=n4] <br/>
[fid:5:5]:[Guest name=n4, sex=m, hobbies=h1] <br/>
[fid:2:2]:[Guest name=n2, sex=f, hobbies=h1] <br/>
<br/>
=&gt;[ActivationCreated(35): rule=findSeating <br/>
[fid:13:13]:[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5] <br/>
[fid:9:9]:[Guest name=n5, sex=f, hobbies=h1] <br/>
[fid:1:1]:[Guest name=n1, sex=m, hobbies=h1]</p></div><p>The creation of all these redundant activations might seem
        pointless, but it must be remembered that Manners is not about good
        rule design; it's purposefully designed as a bad ruleset to fully
        stress-test the cross product matching process and the Agenda, which
        this clearly does. Notice that each activation has the same time tag
        of 35, as they were all activated by the change in the
        <code class="code">Context</code> object to <code class="code">ASSIGN_SEATS</code>. With OPS5
        and LEX it would correctly fire the activation with the
        <code class="code">Seating</code> asserted last. With Depth, the accumulated fact
        time tag ensures that the activation with the last asserted
        <code class="code">Seating</code> fires.</p></div><div class="section" title="23.16.2.5. Rules &#34;makePath&#34; and &#34;pathDone&#34;"><div class="titlepage"><div><div><h4 class="title"><a id="d0e29081"/>23.16.2.5. Rules "makePath" and "pathDone"</h4></div></div></div><p>Rule <code class="code">makePath</code> must always fire before
        <code class="code">pathDone</code>. A <code class="code">Path</code> object is asserted for
        each <code class="code">Seating</code> arrangement, up to the last asserted 
        <code class="code">Seating</code>. Notice that the conditions in
        <code class="code">pathDone</code> are a subset of those in
        <code class="code">makePath</code> - so how do we ensure that <code class="code">makePath</code>
        fires first?</p><pre><code class="no-highlight">rule makePath
    when 
        Context( state == Context.MAKE_PATH )
        Seating( seatingId:id, seatingPid:pid, pathDone == false )
        Path( id == seatingPid, pathGuestName:guestName, pathSeat:seat )
        not Path( id == seatingId, guestName == pathGuestName )
    then
        insert( new Path( seatingId, pathSeat, pathGuestName ) );
end</code></pre><pre><code class="no-highlight">rule pathDone
    when
        context : Context( state == Context.MAKE_PATH ) 
        seating : Seating( pathDone == false ) 
    then
        modify( seating ) {setPathDone( true )} 
        
    modify( context ) {setState( Context.CHECK_DONE)}
end</code></pre><div class="figure"><a id="d0e29114"/><p class="title"><strong>Figure 23.42. Rete Diagram</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/Examples/MannersExample/make_path.png" align="middle" alt="Rete Diagram"/></div></div></div><br class="figure-break"/><p>Both rules end up on the Agenda in conflict and with identical
        activation time tags. However, the accumulate fact time tag is greater
        for "Make Path" so it gets priority.</p></div><div class="section" title="23.16.2.6. Rules &#34;continue&#34; and &#34;areWeDone&#34;"><div class="titlepage"><div><div><h4 class="title"><a id="d0e29122"/>23.16.2.6. Rules "continue" and "areWeDone"</h4></div></div></div><p>Rule <code class="code">areWeDone</code> only activates when the last seat
        is assigned, at which point both rules will be activated. For the
        same reason that <code class="code">makePath</code> always wins over
        <code class="code">path Done</code>, <code class="code">areWeDone</code> will take
        priority over rule <code class="code">continue</code>.</p><pre><code class="no-highlight">rule areWeDone
    when
        context : Context( state == Context.CHECK_DONE ) 
        LastSeat( lastSeat: seat )
        Seating( rightSeat == lastSeat ) 
    then
        modify( context ) {setState(Context.PRINT_RESULTS )}
end
</code></pre><pre><code class="no-highlight">rule continue
    when
        context : Context( state == Context.CHECK_DONE ) 
    then
        modify( context ) {setState( Context.ASSIGN_SEATS )}
end
</code></pre></div></div><div class="section" title="23.16.3. Output Summary"><div class="titlepage"><div><div><h3 class="title"><a id="d0e29146"/>23.16.3. Output Summary</h3></div></div></div><div class="literallayout"><p><span class="bold"><strong>Assign First seat</strong></span><br/>
=&gt;[fid:13:13]:[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5]<br/>
=&gt;[fid:14:14]:[Path id=1, seat=1, guest=n5]<br/>
<br/>
==&gt;[ActivationCreated(16): rule=findSeating<br/>
[fid:13:13]:[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5]<br/>
[fid:9:9]:[Guest name=n5, sex=f, hobbies=h1]<br/>
[fid:1:1]:[Guest name=n1, sex=m, hobbies=h1]<br/>
<br/>
==&gt;[ActivationCreated(16): rule=findSeating<br/>
[fid:13:13]:[Seating id=1 , pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5]<br/>
[fid:9:9]:[Guest name=n5, sex=f, hobbies=h1]<br/>
[fid:5:5]:[Guest name=n4, sex=m, hobbies=h1]*<br/>
<br/>
<span class="bold"><strong>Assign Seating</strong></span><br/>
=&gt;[fid:15:17] :[Seating id=2 , pid=1 , done=false, ls=1, lg=n5, rs=2, rn=n4]<br/>
=&gt;[fid:16:18]:[Path id=2, seat=2, guest=n4]<br/>
=&gt;[fid:17:19]:[Chosen id=1, name=n4, hobbies=h1]<br/>
<br/>
=&gt;[ActivationCreated(21): rule=makePath <br/>
[fid:15:17] : [Seating id=2, pid=1, done=false, ls=1, ln=n5, rs=2, rn=n4]<br/>
[fid:14:14] : [Path id=1, seat=1, guest=n5]*<br/>
<br/>
==&gt;[ActivationCreated(21): rule=pathDone<br/>
[Seating id=2, pid=1, done=false, ls=1, ln=n5, rs=2, rn=n4]*<br/>
<br/>
<span class="bold"><strong>Make Path</strong></span><br/>
=&gt;[fid:18:22:[Path id=2, seat=1, guest=n5]]<br/>
<br/>
<span class="bold"><strong>Path Done</strong></span><br/>
<br/>
<span class="bold"><strong>Continue Process</strong></span><br/>
=&gt;[ActivationCreated(25): rule=findSeating<br/>
[fid:15:23]:[Seating id=2, pid=1, done=true, ls=1, ln=n5, rs=2, rn=n4]<br/>
[fid:7:7]:[Guest name=n4, sex=f, hobbies=h3]<br/>
[fid:4:4] : [Guest name=n3, sex=m, hobbies=h3]*<br/>
<br/>
=&gt;[ActivationCreated(25): rule=findSeating<br/>
[fid:15:23]:[Seating id=2, pid=1, done=true, ls=1, ln=n5, rs=2, rn=n4]<br/>
[fid:5:5]:[Guest name=n4, sex=m, hobbies=h1]<br/>
[fid:2:2]:[Guest name=n2, sex=f, hobbies=h1], [fid:12:20] : [Count value=3]<br/>
<br/>
=&gt;[ActivationCreated(25): rule=findSeating<br/>
[fid:13:13]:[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5]<br/>
[fid:9:9]:[Guest name=n5, sex=f, hobbies=h1]<br/>
[fid:1:1]:[Guest name=n1, sex=m, hobbies=h1]<br/>
<br/>
<span class="bold"><strong>Assign Seating</strong></span><br/>
=&gt;[fid:19:26]:[Seating id=3, pid=2, done=false, ls=2, lnn4, rs=3, rn=n3]]<br/>
=&gt;[fid:20:27]:[Path id=3, seat=3, guest=n3]]<br/>
=&gt;[fid:21:28]:[Chosen id=2, name=n3, hobbies=h3}]<br/>
<br/>
=&gt;[ActivationCreated(30): rule=makePath<br/>
[fid:19:26]:[Seating id=3, pid=2, done=false, ls=2, ln=n4, rs=3, rn=n3]<br/>
[fid:18:22]:[Path id=2, seat=1, guest=n5]*<br/>
<br/>
=&gt;[ActivationCreated(30): rule=makePath <br/>
[fid:19:26]:[Seating id=3, pid=2, done=false, ls=2, ln=n4, rs=3, rn=n3]<br/>
[fid:16:18]:[Path id=2, seat=2, guest=n4]*<br/>
<br/>
=&gt;[ActivationCreated(30): rule=done <br/>
[fid:19:26]:[Seating id=3, pid=2, done=false, ls=2, ln=n4, rs=3, rn=n3]*<br/>
<br/>
<span class="bold"><strong>Make Path</strong></span><br/>
=&gt;[fid:22:31]:[Path id=3, seat=1, guest=n5]<br/>
<br/>
<span class="bold"><strong>Make Path </strong></span><br/>
=&gt;[fid:23:32] [Path id=3, seat=2, guest=n4]<br/>
<br/>
<span class="bold"><strong>Path Done</strong></span><br/>
<br/>
<span class="bold"><strong>Continue Processing</strong></span><br/>
=&gt;[ActivationCreated(35): rule=findSeating<br/>
[fid:19:33]:[Seating id=3, pid=2, done=true, ls=2, ln=n4, rs=3, rn=n3]<br/>
[fid:4:4]:[Guest name=n3, sex=m, hobbies=h3]<br/>
[fid:3:3]:[Guest name=n2, sex=f, hobbies=h3], [fid:12:29]*<br/>
<br/>
=&gt;[ActivationCreated(35): rule=findSeating <br/>
[fid:15:23]:[Seating id=2, pid=1, done=true, ls=1, ln=n5, rs=2, rn=n4] <br/>
[fid:5:5]:[Guest name=n4, sex=m, hobbies=h1]<br/>
[fid:2:2]:[Guest name=n2, sex=f, hobbies=h1]<br/>
<br/>
=&gt;[ActivationCreated(35): rule=findSeating <br/>
[fid:13:13]:[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5] <br/>
[fid:9:9]:[Guest name=n5, sex=f, hobbies=h1], [fid:1:1] : [Guest name=n1, sex=m, hobbies=h1]<br/>
<br/>
<span class="bold"><strong>Assign Seating</strong></span><br/>
=&gt;[fid:24:36]:[Seating id=4, pid=3, done=false, ls=3, ln=n3, rs=4, rn=n2]]<br/>
=&gt;[fid:25:37]:[Path id=4, seat=4, guest=n2]]<br/>
=&gt;[fid:26:38]:[Chosen id=3, name=n2, hobbies=h3]<br/>
<br/>
==&gt;[ActivationCreated(40): rule=makePath <br/>
[fid:24:36]:[Seating id=4, pid=3, done=false, ls=3, ln=n3, rs=4, rn=n2]<br/>
[fid:23:32]:[Path id=3, seat=2, guest=n4]*<br/>
<br/>
==&gt;[ActivationCreated(40): rule=makePath <br/>
[fid:24:36]:[Seating id=4, pid=3, done=false, ls=3, ln=n3, rs=4, rn=n2] <br/>
[fid:20:27]:[Path id=3, seat=3, guest=n3]*<br/>
<br/>
=&gt;[ActivationCreated(40): rule=makePath <br/>
[fid:24:36]:[Seating id=4, pid=3, done=false, ls=3, ln=n3, rs=4, rn=n2]<br/>
[fid:22:31]:[Path id=3, seat=1, guest=n5]*<br/>
<br/>
=&gt;[ActivationCreated(40): rule=done <br/>
[fid:24:36]:[Seating id=4, pid=3, done=false, ls=3, ln=n3, rs=4, rn=n2]*<br/>
<br/>
<span class="bold"><strong>Make Path </strong></span><br/>
=&gt;fid:27:41:[Path id=4, seat=2, guest=n4]<br/>
<br/>
<span class="bold"><strong>Make Path</strong></span><br/>
=&gt;fid:28:42]:[Path id=4, seat=1, guest=n5]]<br/>
<br/>
<span class="bold"><strong>Make Path</strong></span><br/>
=&gt;fid:29:43]:[Path id=4, seat=3, guest=n3]]<br/>
<br/>
<span class="bold"><strong>Path Done</strong></span><br/>
<br/>
<span class="bold"><strong>Continue  Processing</strong></span><br/>
=&gt;[ActivationCreated(46): rule=findSeating <br/>
[fid:15:23]:[Seating id=2, pid=1, done=true, ls=1, ln=n5, rs=2, rn=n4] <br/>
[fid:5:5]:[Guest name=n4, sex=m, hobbies=h1], [fid:2:2]<br/>
[Guest name=n2, sex=f, hobbies=h1]<br/>
<br/>
=&gt;[ActivationCreated(46): rule=findSeating <br/>
[fid:24:44]:[Seating id=4, pid=3, done=true, ls=3, ln=n3, rs=4, rn=n2]<br/>
[fid:2:2]:[Guest name=n2, sex=f, hobbies=h1]<br/>
[fid:1:1]:[Guest name=n1, sex=m, hobbies=h1]*<br/>
<br/>
=&gt;[ActivationCreated(46): rule=findSeating <br/>
[fid:13:13]:[Seating id=1, pid=0, done=true, ls=1, ln=n5, rs=1, rn=n5]<br/>
[fid:9:9]:[Guest name=n5, sex=f, hobbies=h1]<br/>
[fid:1:1]:[Guest name=n1, sex=m, hobbies=h1]<br/>
<br/>
<span class="bold"><strong>Assign Seating</strong></span><br/>
=&gt;[fid:30:47]:[Seating id=5, pid=4, done=false, ls=4, ln=n2, rs=5, rn=n1]<br/>
=&gt;[fid:31:48]:[Path id=5, seat=5, guest=n1]<br/>
=&gt;[fid:32:49]:[Chosen id=4, name=n1, hobbies=h1]<br/>
</p></div></div></div><div class="section" title="23.17. Backward-Chaining"><div class="titlepage"><div><div><h2 class="title"><a id="d0e29201"/>23.17. Backward-Chaining</h2></div></div></div><p>A backward-chaining rule system is goal-driven. This means the system starts with a
    conclusion which the engine tries to satisfy. If it cannot do so it searches for sub-goals,
    that is, conclusions that will complete part of the current goal. It continues this process
    until either the initial conclusion is satisfied or there are no more unsatisfied sub-goals.
    <span class="bold"><strong>Prolog</strong></span> is an example of a backward-chaining engine. </p><div class="figure"><a id="d0e29209"/><p class="title"><strong>Figure 23.43. Backward Chaining Chart</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/BackwardChaining/BackwardChainingChart.png" alt="Backward Chaining Chart"/></div></div></div><br class="figure-break"/><div class="section" title="23.17.1. Backward-Chaining Systems"><div class="titlepage"><div><div><h3 class="title"><a id="d0e29215"/>23.17.1. Backward-Chaining Systems</h3></div></div></div><p>Backward-Chaining is a feature recently added to the JBoss Rules Engine.
      This process is often referred to as derivation queries, and it is not as common
      compared to reactive systems since JBoss Rules is primarily reactive forward chaining.
      That is, it responds to changes in your data. The backward-chaining added to the engine
      is for product-like derivations. </p></div><div class="section" title="23.17.2. Cloning Transitive Closures"><div class="titlepage"><div><div><h3 class="title"><a id="d0e29220"/>23.17.2. Cloning Transitive Closures</h3></div></div></div><div class="figure"><a id="d0e29223"/><p class="title"><strong>Figure 23.44. Reasoning Graph</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/BackwardChaining/ReasoningGraph.png" alt="Reasoning Graph"/></div></div></div><br class="figure-break"/><p>The previous chart demonstrates a House example of transitive items.
      A similar reasoning chart can be created by implementing the following rules: </p><p>1. First, create some java rules to develop reasoning for transitive items.
      It inserts each of the locations.</p><p>2. Next, create the <span class="bold"><strong>Location</strong></span> class; it has the
      item and where it is located. </p><p>3. Type the rules for the House example as depicted below: </p><pre><code class="language-java">ksession.insert( new Location("office", "house") );
ksession.insert( new Location("kitchen", "house") );
ksession.insert( new Location("knife", "kitchen") );
ksession.insert( new Location("cheese", "kitchen") );
ksession.insert( new Location("desk", "office") );
ksession.insert( new Location("chair", "office") );
ksession.insert( new Location("computer", "desk") );
ksession.insert( new Location("drawer", "desk") );</code></pre><p>4. A transitive design is created in which the item is in its designated location
      such as a "desk" located in an "office." </p><div class="figure"><a id="d0e29244"/><p class="title"><strong>Figure 23.45. Transitive Reasoning Graph of a House</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/BackwardChaining/TransitiveReasoningGraph.png" alt="Transitive Reasoning Graph of a House"/></div></div></div><br class="figure-break"/></div><div class="section" title="23.17.3. Defining a Query"><div class="titlepage"><div><div><h3 class="title"><a id="d0e29250"/>23.17.3. Defining a Query</h3></div></div></div><p>1. Create a query to look at the data inserted into the rules engine: </p><pre><code class="no-highlight">query isContainedIn( String x, String y )
  Location( x, y; )
  or
  ( Location( z, y; ) and isContainedIn( x, z; ) )
end</code></pre><p>Notice how the query is recursive and is calling "isContainedIn." </p><p>2. Create a rule to print out every string inserted into the system to see how
      things are implemented. The rule should resemble the following format: </p><pre><code class="no-highlight">rule "go" salience 10
when
  $s : String( )
then
  System.out.println( $s );
end</code></pre><p>3. Using Step 2 as a model, create a rule that calls upon the Step 1 query "isContainedIn." </p><pre><code class="no-highlight">rule "go1"
when
  String( this == "go1" )
  isContainedIn("office", "house"; )
then
  System.out.println( "office is in the house" );
end</code></pre><p>The "go1" rule will fire when the first string is inserted into the engine.
      That is, it asks if the item "office" is in the location "house." Therefore, the
      Step 1 query is evoked by the previous rule when the "go1" String is inserted.  </p><p>4. Create the "go1," insert it into the engine, and call the fireAllRules.  </p><pre><code class="no-highlight">         ksession.insert( "go1" );
ksession.fireAllRules();
---
go1
office is in the house</code></pre><p>The --- line indicates the separation of the output of the engine from
      the firing of the "go" rule and the "go1" rule.  </p></div><div class="section" title="23.17.4. Transitive Closure Example"><div class="titlepage"><div><div><h3 class="title"><a id="d0e29275"/>23.17.4. Transitive Closure Example</h3></div></div></div><p>1. Create a Transitive Closure by implementing the following rule:  </p><pre><code class="no-highlight">rule "go2"
when
  String( this == "go2" )
  isContainedIn("drawer", "house"; )
then
  System.out.println( "Drawer in the House" );
end</code></pre><p>2. Recall from the Cloning Transitive Closure's topic, there was no instance of "drawer"
      in "house." "drawer" was located in "desk."   </p><div class="figure"><a id="d0e29284"/><p class="title"><strong>Figure 23.46. Transitive Reasoning Graph of a Drawer</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Examples/BackwardChaining/TransitiveReasoningGraph2.png" alt="Transitive Reasoning Graph of a Drawer"/></div></div></div><br class="figure-break"/><p>3. Use the previous query for this recursive information.   </p><pre><code class="no-highlight">query isContainedIn( String x, String y )
  Location( x, y; )
  or
  ( Location( z, y; ) and isContainedIn( x, z; ) )
end</code></pre><p>4. Create the "go2," insert it into the engine, and call the fireAllRules.    </p><pre><code class="no-highlight">ksession.insert( "go2" );
ksession.fireAllRules();
---
go2
Drawer in the House</code></pre><p>When the rule is fired, it correctly tells you "go2" has been inserted and
      that the "drawer" is in the "house."  </p><p>5. Check how the engine determined this outcome  </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The query has to recurse down several levels to determine this.</p></li><li class="listitem"><p>Instead of using <span class="bold"><strong>Location( x, y; )</strong></span>,
          The query uses the value of <span class="bold"><strong>(z, y; )</strong></span>
          since "drawer" is not in "house." </p></li><li class="listitem"><p>The <span class="bold"><strong>z</strong></span> is currently unbound which means it
          has no value and will return everything that is in the argument. </p></li><li class="listitem"><p><span class="bold"><strong>y</strong></span> is currently bound to "house," so
          <span class="bold"><strong>z</strong></span> will return "office" and "kitchen." </p></li><li class="listitem"><p>Information is gathered from "office" and checks recursively if the "drawer"
          is in the "office." The following query line is being called for these parameters:
          <span class="bold"><strong>isContainedIn (x ,z; )</strong></span></p></li></ul></div><p>There is no instance of "drawer" in "office;" therefore, it does not match.
      With z being unbound, it will return data that is within the "office," and it will
      gather that <span class="bold"><strong>z == desk</strong></span>. </p><pre><code class="no-highlight">isContainedIn(x==drawer, z==desk)</code></pre><p>isContainedIn recurses three times. On the final recurse, an instance triggers of
      "drawer" in the "desk."  </p><pre><code class="no-highlight"> Location(x==drawer, y==desk)</code></pre><p>This matches on the first location and recurses back up, so we know that "drawer"
      is in the "desk," the "desk" is in the "office," and the "office" is in the "house;"
      therefore, the "drawer" is in the "house" and returns true.  </p></div><div class="section" title="23.17.5. Reactive Transitive Queries"><div class="titlepage"><div><div><h3 class="title"><a id="d0e29347"/>23.17.5. Reactive Transitive Queries</h3></div></div></div><p>1. Create a Reactive Transitive Query by implementing the following rule:  </p><pre><code class="no-highlight">rule "go3"
when
  String( this == "go3" )
  isContainedIn("key", "office"; )
then
  System.out.println( "Key in the Office" );
end</code></pre><p>Reactive Transitive Queries can ask a question even if the answer can not be
      satisfied. Later, if it is satisfied, it will return an answer. </p><p>2. Use the same query for this reactive information. </p><pre><code class="no-highlight">query isContainedIn( String x, String y )
  Location( x, y; )
  or
  ( Location( z, y; ) and isContainedIn( x, z; ) )
end</code></pre><p>3. Create the "go3," insert it into the engine, and call the fireAllRules.  </p><pre><code class="no-highlight">ksession.insert( "go3" );
ksession.fireAllRules();
---
go3</code></pre><p>The first rule that matches any String returns "go3" but nothing else is
      returned because there is no answer; however, while "go3" is inserted in the
      system, it will continuously wait until it is satisfied.  </p><p>4. Insert a new location of "key" in the "drawer":  </p><pre><code class="no-highlight">ksession.insert( new Location("key", "drawer") );
ksession.fireAllRules();
---
Key in the Office</code></pre><p>This new location satisfies the transitive closure because it is monitoring the
      entire graph. In addition, this process now has four recursive levels in which it
      goes through to match and fire the rule. </p></div><div class="section" title="23.17.6. Queries with Unbound Arguments"><div class="titlepage"><div><div><h3 class="title"><a id="d0e29372"/>23.17.6. Queries with Unbound Arguments</h3></div></div></div><p>1. Create a Query with Unbound Arguments by implementing the following rule:</p><pre><code class="no-highlight">rule "go4"
when
  String( this == "go4" )
  isContainedIn(thing, "office"; )
then
  System.out.println( "thing" + thing + "is in the Office" );
end</code></pre><p>This rule is asking for everything in the "office," and it will tell everything
      in all the rows below. The unbound argument (out variable thing) in this example will
      return every possible value; accordingly, it is very similar to the z value used in
      the Reactive Transitive Query example. </p><p>2. Use the query for the unbound arguments. </p><pre><code class="no-highlight">query isContainedIn( String x, String y )
  Location( x, y; )
  or
  ( Location( z, y; ) and isContainedIn( x, z; ) )
end</code></pre><p>3. Create the "go4," insert it into the engine, and call the fireAllRules. </p><pre><code class="no-highlight">ksession.insert( "go4" );
ksession.fireAllRules();
---
go4
thing Key is in the Office
thing Computer is in the Office
thing Drawer is in the Office
thing Desk is in the Office
thing Chair is in the Office</code></pre><p>When "go4" is inserted, it returns all the previous information that is
      transitively below "Office." </p></div><div class="section" title="23.17.7. Multiple Unbound Arguments"><div class="titlepage"><div><div><h3 class="title"><a id="d0e29391"/>23.17.7. Multiple Unbound Arguments</h3></div></div></div><p>1. Create a query with Mulitple Unbound Arguments by implementing the following rule:</p><pre><code class="no-highlight">rule "go5"
when
  String( this == "go5" )
  isContainedIn(thing, location; )
then
  System.out.println( "thing" + thing + "is in" + location );
end</code></pre><p>This rule is asking for everything in the "office," and it will tell everything
      in all the rows below. The unbound argument (out variable thing) in this example will
      return every possible value; accordingly, it is very similar to the z value used in
      the Reactive Transitive Query example. </p><p>Both <span class="bold"><strong>thing</strong></span> and <span class="bold"><strong>location</strong></span>
      are unbound out variables, and without bound arguments, everything is called upon. </p><p>2. Use the query for multiple unbound arguments. </p><pre><code class="no-highlight">query isContainedIn( String x, String y )
  Location( x, y; )
  or
  ( Location( z, y; ) and isContainedIn( x, z; ) )
end</code></pre><p>3. Create the "go5," insert it into the engine, and call the fireAllRules. </p><pre><code class="no-highlight">ksession.insert( "go5" );
ksession.fireAllRules();
---
go5
thing Knife is in House
thing Cheese is in House
thing Key is in House
thing Computer is in House
thing Drawer is in House
thing Desk is in House
thing Chair is in House
thing Key is in Office
thing Computer is in Office
thing Drawer is in Office
thing Key is in Desk
thing Office is in House
thing Computer is in Desk
thing Knife is in Kitchen
thing Cheese is in Kitchen
thing Kitchen is in House
thing Key is in Drawer
thing Drawer is in Desk
thing Desk is in Office
thing Chair is in Office</code></pre><p>When "go5" is called, it returns everything within everything. </p><p/></div></div></div><script type="text/javascript" src="highlight.js/highlight.pack.js"> </script><script type="text/javascript">hljs.initHighlightingOnLoad();</script><ul class="docnav"><li class="previous"><a accesskey="p" href="pt07.html"><strong>Prev</strong>Part VII. Drools Examples</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li></ul></body></html>