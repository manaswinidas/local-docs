<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 14. Android Integration</title><link rel="stylesheet" type="text/css" href="css/jbossorg.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"/><link rel="home" href="index.html" title="Drools Documentation"/><link rel="up" href="pt04.html" title="Part IV. Drools Integration"/><link rel="prev" href="ch13.html" title="Chapter 13. Integration with Spring"/><link rel="next" href="ch15.html" title="Chapter 15. Apache Camel Integration"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><p id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="ch13.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="ch15.html"><strong>Next</strong></a></li></ul><div class="chapter" title="Chapter 14. Android Integration"><div class="titlepage"><div><div><h2 class="title"><a id="ch.kie.android"/>Chapter 14. Android Integration</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ch14.html#d0e16206">14.1. Integration with Drools Expert</a></span></dt><dd><dl><dt><span class="section"><a href="ch14.html#d0e16214">14.1.1. Pre-serialized Rules</a></span></dt><dt><span class="section"><a href="ch14.html#d0e16242">14.1.2. KieContainer API with drools-compiler dependency</a></span></dt></dl></dd><dt><span class="section"><a href="ch14.html#d0e16257">14.2. Integration with Roboguice</a></span></dt><dd><dl><dt><span class="section"><a href="ch14.html#d0e16260">14.2.1. Pre-serialized Rules with Roboguice</a></span></dt><dt><span class="section"><a href="ch14.html#d0e16290">14.2.2. KieContainer with drools-compiler dependency and Roboguice</a></span></dt></dl></dd></dl></div><div class="section" title="14.1. Integration with Drools Expert"><div class="titlepage"><div><div><h2 class="title"><a id="d0e16206"/>14.1. Integration with Drools Expert</h2></div></div></div><p>
        Drools Android integration comes in two flavors, with or without the <span class="emphasis"><em>drools-compiler</em></span> dependency.
        Without the drools-compiler dependency the knowledge bases are pre-serialized at buildtime using the
        kie-maven-plugin. They can be then deserialized using the API, or directly injected using Roboguice.
        When using the drools-compiler dependency there are two options: (1) standard KieContainer API or
        (2) CDI-like injection with Roboguice.
    </p><div class="section" title="14.1.1. Pre-serialized Rules"><div class="titlepage"><div><div><h3 class="title"><a id="d0e16214"/>14.1.1. Pre-serialized Rules</h3></div></div></div><p>
            It is possible to use Drools without the drools-compiler dependency, which results in a smaller apk, by
            pre-serializing the compiled knowledge bases during build-time and then de-serializing them at runtime.
        </p><div class="section" title="14.1.1.1. Maven Configuration"><div class="titlepage"><div><div><h4 class="title"><a id="d0e16219"/>14.1.1.1. Maven Configuration</h4></div></div></div><p>The KieBase must be serialized during build time using <span class="emphasis"><em>kie-maven-plugin</em></span>.</p><div class="example"><a id="d0e16227"/><p class="title"><strong>Example 14.1. Pre-serialized KieBase Maven pom.xml</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.drools&lt;/groupId&gt;
      &lt;artifactId&gt;drools-bom&lt;/artifactId&gt;
      &lt;version&gt;6.5.0.Final&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.drools&lt;/groupId&gt;
    &lt;artifactId&gt;drools-android&lt;/artifactId&gt;
    &lt;exclusions&gt;
     &lt;exclusion&gt;
       &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
       &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
    &lt;/exclusions&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.drools&lt;/groupId&gt;
    &lt;artifactId&gt;drools-core&lt;/artifactId&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;
&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.kie&lt;/groupId&gt;
      &lt;artifactId&gt;kie-maven-plugin&lt;/artifactId&gt;
      &lt;version&gt;6.5.0.Final&lt;/version&gt;
      &lt;configuration&gt;
        &lt;kiebases&gt;
        &lt;kiebase&gt;HelloKB&lt;/kiebase&gt;
        &lt;/kiebases&gt;
        &lt;resDirectory&gt;${basedir}/src/main/res/raw&lt;/resDirectory&gt;
      &lt;/configuration&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;id&gt;touch&lt;/id&gt;
            &lt;goals&gt;
              &lt;goal&gt;touch&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;phase&gt;initialize&lt;/phase&gt;
          &lt;/execution&gt;
          &lt;execution&gt;
            &lt;id&gt;compile-kbase&lt;/id&gt;
              &lt;goals&gt;
                &lt;goal&gt;build&lt;/goal&gt;
              &lt;/goals&gt;
              &lt;phase&gt;compile&lt;/phase&gt;
          &lt;/execution&gt;
          &lt;execution&gt;
            &lt;id&gt;serialize&lt;/id&gt;
            &lt;goals&gt;
              &lt;goal&gt;serialize&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;phase&gt;compile&lt;/phase&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
     &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;
                  </code></pre></div></div><br class="example-break"/></div><div class="section" title="14.1.1.2. Loading the KieBase"><div class="titlepage"><div><div><h4 class="title"><a id="d0e16232"/>14.1.1.2. Loading the KieBase</h4></div></div></div><p>The KieBase must be de-serialized before creating the sessions.</p><div class="figure"><a id="d0e16237"/><p class="title"><strong>Figure 14.1. Loading serialized KieBase</strong></p><div class="figure-contents"><pre><code class="language-java">private class LoadKieBaseTask extends AsyncTask&lt;InputStream, Void, KieBase&gt; {
   @Override
   protected KieBase doInBackground(InputStream... params) {
      try {
         logger.debug("Loading knowledge base");
         final KnowledgeBase kbase = KnowledgeBaseFactory.newKnowledgeBase();
         kbase.addKnowledgePackages((List&lt;KnowledgePackage&gt;) DroolsStreamUtils.streamIn(params[0]));
         return kbase;
      }catch(Exception e) {
         logger.error("Drools exception", e);
         return null;
      }
   }
}
                  </code></pre></div></div><br class="figure-break"/></div></div><div class="section" title="14.1.2. KieContainer API with drools-compiler dependency"><div class="titlepage"><div><div><h3 class="title"><a id="d0e16242"/>14.1.2. KieContainer API with drools-compiler dependency</h3></div></div></div><p>
            With the drools-compiler dependency standard KieContainer API can be used. This comes at a cost of a larger
            apk. To avoid the 65K limit, multidex (or proguard) can be used.
        </p><div class="section" title="14.1.2.1. Maven Configuration with drools-compiler and multidex"><div class="titlepage"><div><div><h4 class="title"><a id="d0e16247"/>14.1.2.1. Maven Configuration with drools-compiler and multidex</h4></div></div></div><p>
                  The kie-maven-plugin must be configured to build the kiebase. Multidex must be used to allow for the
                  increased dependencies. There are also some settings for merging various Drools XML files within the
                  apk.
              </p><div class="example"><a id="d0e16252"/><p class="title"><strong>Example 14.2. pom.xml with drools-compiler and multidex</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.drools&lt;/groupId&gt;
      &lt;artifactId&gt;drools-bom&lt;/artifactId&gt;
      &lt;version&gt;6.5.0.Final&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.drools&lt;/groupId&gt;
    &lt;artifactId&gt;drools-android&lt;/artifactId&gt;
    &lt;exclusions&gt;
      &lt;exclusion&gt;
        &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
        &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
      &lt;/exclusion&gt;
    &lt;/exclusions&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.drools&lt;/groupId&gt;
    &lt;artifactId&gt;drools-compiler&lt;/artifactId&gt;
    &lt;exclusions&gt;
      &lt;exclusion&gt;
         &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
         &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
      &lt;/exclusion&gt;
      &lt;exclusion&gt;
         &lt;groupId&gt;xmlpull&lt;/groupId&gt;
         &lt;artifactId&gt;xmlpull&lt;/artifactId&gt;
      &lt;/exclusion&gt;
      &lt;exclusion&gt;
         &lt;groupId&gt;xpp3&lt;/groupId&gt;
         &lt;artifactId&gt;xpp3_min&lt;/artifactId&gt;
      &lt;/exclusion&gt;
      &lt;exclusion&gt;
         &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
         &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
      &lt;/exclusion&gt;
      &lt;exclusion&gt;
         &lt;groupId&gt;org.eclipse.jdt.core.compiler&lt;/groupId&gt;
         &lt;artifactId&gt;ecj&lt;/artifactId&gt;
      &lt;/exclusion&gt;
    &lt;/exclusions&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;
&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.kie&lt;/groupId&gt;
      &lt;artifactId&gt;kie-maven-plugin&lt;/artifactId&gt;
      &lt;version&gt;6.5.0.Final&lt;/version&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;id&gt;compile-kbase&lt;/id&gt;
          &lt;goals&gt;
            &lt;goal&gt;build&lt;/goal&gt;
          &lt;/goals&gt;
          &lt;phase&gt;compile&lt;/phase&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;com.simpligility.maven.plugins&lt;/groupId&gt;
      &lt;artifactId&gt;android-maven-plugin&lt;/artifactId&gt;
      &lt;version&gt;4.2.1&lt;/version&gt;
      &lt;extensions&gt;true&lt;/extensions&gt;
      &lt;configuration&gt;
        &lt;sdk&gt;
          &lt;platform&gt;21&lt;/platform&gt;
        &lt;/sdk&gt;
        &lt;dex&gt;
          &lt;coreLibrary&gt;true&lt;/coreLibrary&gt;
          &lt;jvmArguments&gt;&lt;jvmArgument&gt;-Xmx2048m&lt;/jvmArgument&gt;&lt;/jvmArguments&gt;
          &lt;multiDex&gt;true&lt;/multiDex&gt;
          &lt;mainDexList&gt;maindex.txt&lt;/mainDexList&gt;
        &lt;/dex&gt;
        &lt;extractDuplicates&gt;true&lt;/extractDuplicates&gt;
        &lt;apk&gt;
          &lt;metaInf&gt;
            &lt;includes&gt;
              &lt;include&gt;services/**&lt;/include&gt;
              &lt;include&gt;kmodule.*&lt;/include&gt;
              &lt;include&gt;HelloKB/**&lt;/include&gt;
              &lt;include&gt;drools**&lt;/include&gt;
              &lt;include&gt;maven/${project.groupId}/${project.artifactId}/**&lt;/include&gt;
            &lt;/includes&gt;
          &lt;/metaInf&gt;
        &lt;/apk&gt;
      &lt;/configuration&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;
                  </code></pre></div></div><br class="example-break"/></div></div></div><div class="section" title="14.2. Integration with Roboguice"><div class="titlepage"><div><div><h2 class="title"><a id="d0e16257"/>14.2. Integration with Roboguice</h2></div></div></div><div class="section" title="14.2.1. Pre-serialized Rules with Roboguice"><div class="titlepage"><div><div><h3 class="title"><a id="d0e16260"/>14.2.1. Pre-serialized Rules with Roboguice</h3></div></div></div><p>With Roboguice pre-serialized knowledge bases can be injected using the @KBase annotation.</p><div class="section" title="14.2.1.1. Annotations"><div class="titlepage"><div><div><h4 class="title"><a id="d0e16265"/>14.2.1.1. Annotations</h4></div></div></div><p>
                  @KBase supports an optional 'name' attribute. CDI typically
                  does "getOrCreate" when it injects, all injections receive the same instance for the same set
                  of annotations. the 'name' annotation forces a unique instance for each name, although all
                  instances for that name will be identity equals.
              </p><div class="section" title="14.2.1.1.1. @KBase"><div class="titlepage"><div><div><h5 class="title"><a id="d0e16270"/>14.2.1.1.1. @KBase</h5></div></div></div><p>The default argument maps to the value attribute and specifies the name of the KieBase from the
                      kmodule.xml file.</p><div class="figure"><a id="d0e16275"/><p class="title"><strong>Figure 14.2. Injects KieBase by name from pre-serialized resource</strong></p><div class="figure-contents"><pre><code class="language-java">@KBase("kbase1")
private KieBase kbase;</code></pre></div></div><br class="figure-break"/></div></div><div class="section" title="14.2.1.2. AndroidManifest.xml configuration"><div class="titlepage"><div><div><h4 class="title"><a id="d0e16280"/>14.2.1.2. AndroidManifest.xml configuration</h4></div></div></div><p>The Roboguice module needs to be specified in the manifest.</p><div class="example"><a id="d0e16285"/><p class="title"><strong>Example 14.3. Roboguice manifest with pre-serialized knowledge base </strong></p><div class="example-contents"><pre><code class="language-xml">&lt;application
   android:largeHeap="true"
   android:allowBackup="true"
   android:icon="@drawable/ic_launcher"
   android:label="@string/app_name"
   android:theme="@style/AppTheme"&gt;
      &lt;meta-data
         android:name="roboguice.modules"
         android:value="org.drools.android.roboguice.DroolsModule"/&gt;
      &lt;activity
         android:label="@string/app_name"
         android:name="org.drools.examples.android.SplashActivity"&gt;
      &lt;intent-filter&gt;
         &lt;action android:name="android.intent.action.MAIN"/&gt;
         &lt;category android:name="android.intent.category.LAUNCHER"/&gt;
      &lt;/intent-filter&gt;
   &lt;/activity&gt;
&lt;/application&gt;
                  </code></pre></div></div><br class="example-break"/></div></div><div class="section" title="14.2.2. KieContainer with drools-compiler dependency and Roboguice"><div class="titlepage"><div><div><h3 class="title"><a id="d0e16290"/>14.2.2. KieContainer with drools-compiler dependency and Roboguice</h3></div></div></div><p>With Roboguice and drools-compiler almost the full CDI syntax can be used to inject KieContainers, KieBases, and KieSessions.</p><div class="section" title="14.2.2.1. Annotations"><div class="titlepage"><div><div><h4 class="title"><a id="d0e16295"/>14.2.2.1. Annotations</h4></div></div></div><p>@KContainer, @KBase and @KSession all support an optional 'name' attribute. CDI typically
                  does "getOrCreate" when it injects, all injections receive the same instance for the same set
                  of annotations. the 'name' annotation forces a unique instance for each name, although all
                  instance for that name will be identity equals.</p><div class="section" title="14.2.2.1.1. @KContainer"><div class="titlepage"><div><div><h5 class="title"><a id="d0e16300"/>14.2.2.1.1. @KContainer</h5></div></div></div><div class="figure"><a id="d0e16303"/><p class="title"><strong>Figure 14.3. Injects Classpath KieContainer</strong></p><div class="figure-contents"><pre><code class="language-java">@Inject
private KieContainer kContainer;</code></pre></div></div><br class="figure-break"/></div><div class="section" title="14.2.2.1.2. @KBase"><div class="titlepage"><div><div><h5 class="title"><a id="d0e16308"/>14.2.2.1.2. @KBase</h5></div></div></div><p>The default argument, if given, maps to the value attribute and specifies the name of the KieBase from the
                      kmodule.xml file.</p><div class="figure"><a id="d0e16313"/><p class="title"><strong>Figure 14.4. Injects the Default KieBase from the Classpath KieContainer</strong></p><div class="figure-contents"><pre><code class="language-java">@Inject
private KieBase kbase;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e16318"/><p class="title"><strong>Figure 14.5. Injects KieBase by name from the Classpath KieContainer</strong></p><div class="figure-contents"><pre><code class="language-java">@Inject
@KBase("kbase1")
private KieBase kbase;</code></pre></div></div><br class="figure-break"/></div><div class="section" title="14.2.2.1.3. @KSession for KieSession"><div class="titlepage"><div><div><h5 class="title"><a id="d0e16323"/>14.2.2.1.3. @KSession for KieSession</h5></div></div></div><p>@KSession is optional as it can be detected and added by the use of @Inject and variable
                      type inference.</p><p>The default argument, if given, maps to the value attribute and specifies the name of the KieSession from the
                      kmodule.xml file</p><div class="figure"><a id="d0e16330"/><p class="title"><strong>Figure 14.6. Injects the Default KieSession from the Classpath KieContainer</strong></p><div class="figure-contents"><pre><code class="language-java">@Inject
private KieSession ksession;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e16335"/><p class="title"><strong>Figure 14.7. Injects StatelessKieSession by name from the Classpath KieContainer</strong></p><div class="figure-contents"><pre><code class="language-java">@Inject
@KSession("ksession1")
private KieSession ksession;</code></pre></div></div><br class="figure-break"/></div><div class="section" title="14.2.2.1.4. @KSession for StatelessKieSession"><div class="titlepage"><div><div><h5 class="title"><a id="d0e16340"/>14.2.2.1.4. @KSession for StatelessKieSession</h5></div></div></div><p>@KSession is optional as it can be detected and added by the use of @Inject and variable
                      type inference.</p><p>The default argument, if given, maps to the value attribute and specifies the name of the KieSession from the
                      kmodule.xml file.</p><div class="figure"><a id="d0e16347"/><p class="title"><strong>Figure 14.8. Injects the Default StatelessKieSession from the Classpath KieContainer</strong></p><div class="figure-contents"><pre><code class="language-java">@Inject
private StatelessKieSession ksession;</code></pre></div></div><br class="figure-break"/><div class="figure"><a id="d0e16352"/><p class="title"><strong>Figure 14.9. Injects StatelessKieSession by name from the Classpath KieContainer</strong></p><div class="figure-contents"><pre><code class="language-java">@Inject
@KSession("ksession1")
private StatelessKieSession ksession;</code></pre></div></div><br class="figure-break"/></div></div><div class="section" title="14.2.2.2. AndroidManifest.xml configuration"><div class="titlepage"><div><div><h4 class="title"><a id="d0e16357"/>14.2.2.2. AndroidManifest.xml configuration</h4></div></div></div><p>The Roboguice module needs to be specified in the manifest.</p><div class="example"><a id="d0e16362"/><p class="title"><strong>Example 14.4. Roboguice manifest configuration</strong></p><div class="example-contents"><pre><code class="language-xml">&lt;application
   android:largeHeap="true"
   android:allowBackup="true"
   android:icon="@drawable/ic_launcher"
   android:label="@string/app_name"
   android:theme="@style/AppTheme"&gt;
   &lt;meta-data
      android:name="roboguice.modules"
      android:value="org.drools.android.roboguice.DroolsContainerModule"/&gt;
   &lt;activity
      android:label="@string/app_name"
      android:name="org.drools.examples.android.SplashActivity"&gt;
      &lt;intent-filter&gt;
         &lt;action android:name="android.intent.action.MAIN"/&gt;
         &lt;category android:name="android.intent.category.LAUNCHER"/&gt;
      &lt;/intent-filter&gt;
   &lt;/activity&gt;
&lt;/application&gt;
                  </code></pre></div></div><br class="example-break"/></div></div></div></div><script type="text/javascript" src="highlight.js/highlight.pack.js"> </script><script type="text/javascript">hljs.initHighlightingOnLoad();</script><ul class="docnav"><li class="previous"><a accesskey="p" href="ch13.html"><strong>Prev</strong>Chapter 13. Integration with Spring</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="ch15.html"><strong>Next</strong>Chapter 15. Apache Camel Integration</a></li></ul></body></html>