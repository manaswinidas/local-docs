<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 20. Workbench Integration</title><link rel="stylesheet" type="text/css" href="css/jbossorg.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"/><link rel="home" href="index.html" title="Drools Documentation"/><link rel="up" href="pt05.html" title="Part V. Drools Workbench"/><link rel="prev" href="ch19.html" title="Chapter 19. Authoring Rule Assets"/><link rel="next" href="ch21.html" title="Chapter 21. Workbench High Availability"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><p id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="ch19.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="ch21.html"><strong>Next</strong></a></li></ul><div class="chapter" title="Chapter 20. Workbench Integration"><div class="titlepage"><div><div><h2 class="title"><a id="wb.WorkbenchIntegration"/>Chapter 20. Workbench Integration</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ch20.html#drools.WorkbenchRemoteAPI">20.1. REST</a></span></dt><dd><dl><dt><span class="section"><a href="ch20.html#d0e22427">20.1.1. Job calls</a></span></dt><dt><span class="section"><a href="ch20.html#d0e22531">20.1.2. Repository calls</a></span></dt><dt><span class="section"><a href="ch20.html#d0e22706">20.1.3. Organizational unit calls</a></span></dt><dt><span class="section"><a href="ch20.html#d0e22837">20.1.4. Maven calls</a></span></dt><dt><span class="section"><a href="ch20.html#d0e22953">20.1.5. REST summary</a></span></dt></dl></dd><dt><span class="section"><a href="ch20.html#kie.KeycloakSSOIntegration">20.2. Keycloak SSO integration</a></span></dt><dd><dl><dt><span class="section"><a href="ch20.html#d0e23153">20.2.1. Scenario</a></span></dt><dt><span class="section"><a href="ch20.html#d0e23178">20.2.2. Install and setup a Keycloak server</a></span></dt><dt><span class="section"><a href="ch20.html#d0e23222">20.2.3. Create and setup the demo realm</a></span></dt><dt><span class="section"><a href="ch20.html#d0e23351">20.2.4. Install and setup jBPM Workbench</a></span></dt><dt><span class="section"><a href="ch20.html#d0e23519">20.2.5. Securing workbench remote services via Keycloak</a></span></dt><dt><span class="section"><a href="ch20.html#d0e23565">20.2.6. Securing workbench's file system services via Keycloak</a></span></dt><dt><span class="section"><a href="ch20.html#d0e23668">20.2.7. Execution server</a></span></dt><dt><span class="section"><a href="ch20.html#d0e23850">20.2.8. Consuming remote services</a></span></dt></dl></dd></dl></div><div class="section" title="20.1. REST"><div class="titlepage"><div><div><h2 class="title"><a id="drools.WorkbenchRemoteAPI"/>20.1. REST</h2></div></div></div><p>REST API calls to Knowledge Store allow you to manage the Knowledge Store content and manipulate the static data in the repositories of 
          the Knowledge Store. The calls are asynchronous, that is, they continue their execution after the call was performed as a job. The job ID 
          is returned by every calls to allow after the REST API call was performed to request the job status and verify whether the job finished 
          successfully. Parameters of these calls are provided in the form of JSON entities. </p><p>When using Java code to interface with the REST API, the classes used in POST operations
          or otherwise returned by various operations can be found in the <code class="code">(org.kie.workbench.services:)kie-wb-common-services</code> JAR. All 
          of the classes mentioned below can be found in the <code class="code">org.kie.workbench.common.services.shared.rest</code> package in that JAR.</p><div class="section" title="20.1.1. Job calls"><div class="titlepage"><div><div><h3 class="title"><a id="d0e22427"/>20.1.1. Job calls</h3></div></div></div><p>Every Knowledge Store REST call returns its job ID after it was sent. This is necessary as the calls are asynchronous and you need 
               to be able to reference the job to check its status as it goes through its lifecycle. During its lifecycle, a job can have the 
               following statuses:
          </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="code">ACCEPTED</code>: the job was accepted and is being processed</p></li><li class="listitem"><p><code class="code">BAD_REQUEST</code>: the request was not accepted as it contained incorrect content</p></li><li class="listitem"><p><code class="code">RESOURCE_NOT_EXIST</code>: the requested resource (path) does not exist</p></li><li class="listitem"><p><code class="code">DUPLICATE_RESOURCE</code>: the resource already exists</p></li><li class="listitem"><p><code class="code">SERVER_ERROR</code>: an error on the server occurred</p></li><li class="listitem"><p><code class="code">SUCCESS</code>: the job finished successfully</p></li><li class="listitem"><p><code class="code">FAIL</code>: the job failed</p></li><li class="listitem"><p><code class="code">DENIED</code>: the job was denied</p></li><li class="listitem"><p><code class="code">GONE</code>: the job ID could not be found</p><p>A job can be GONE in the following cases:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The job was explicitly removed</p></li><li class="listitem"><p>The job finished and has been deleted from the status cache (the job is removed from status cache after the cache 
                              has reached its maximum capacity)</p></li><li class="listitem"><p>The job never existed</p></li></ul></div></li></ul></div><p>The following <code class="code">job</code> calls are provided:</p><div class="variablelist"><dl><dt><a id="url-get-job"/><span class="term">[GET] <span class="command"><strong>/jobs/<span class="emphasis"><em>{jobID}</em></span></strong></span></span></dt><dd><p>Returns the job status</p><p>Returns a <code class="code">JobResult</code> instance</p><div class="example"><a id="d0e22511"/><p class="title"><strong>Example 20.1. An example (formatted) response body to the get job call on a
                                   repository clone request</strong></p><div class="example-contents"><pre><code class="no-highlight">"{
  "status":"SUCCESS",
  "jodId":"1377770574783-27",
  "result":"Alias: testInstallAndDeployProject, Scheme: git, Uri: git://testInstallAndDeployProject",
  "lastModified":1377770578194,"detailedResult":null
}"</code></pre></div></div><br class="example-break"/></dd><dt><a id="url-delete-job"/><span class="term">[DELETE] <span class="command"><strong>/jobs/<span class="emphasis"><em>{jobID}</em></span></strong></span></span></dt><dd><p>Removes the job: If the job is not yet being processed, this will
                              remove the job from the job queue. However, this will not cancel or
                              stop an ongoing job</p><p>Returns a <code class="code">JobResult</code> instance</p></dd></dl></div></div><div class="section" title="20.1.2. Repository calls"><div class="titlepage"><div><div><h3 class="title"><a id="d0e22531"/>20.1.2. Repository calls</h3></div></div></div><p>Repository calls are calls to the Knowledge Store that allow you to manage its Git repositories and their projects.</p><p>The following <code class="code">repositories</code> calls are provided:</p><div class="variablelist"><dl><dt><a id="url-get-repositories"/><span class="term">[GET] <span class="command"><strong>/repositories</strong></span></span></dt><dd><p>Gets information about the repositories in the Knowledge Store</p><p>Returns a <code class="code">Collection&lt;Map&lt;String, String&gt;&gt;</code> or <code class="code">Collection&lt;RepositoryRequest&gt;</code> instance,  
                               depending on the JSON serialization library being used. The keys used in the <code class="code">Map&lt;String, String&gt;</code> instance match
                               the fields in the <code class="code">RepositoryRequest</code> class</p><div class="example"><a id="d0e22564"/><p class="title"><strong>Example 20.2. An example (formatted) response body to the get repositories
                                   call</strong></p><div class="example-contents"><pre><code class="no-highlight">[
  {
    "name":"wb-assets",
    "description":"generic assets",
    "userName":null,
    "password":null,
    "requestType":null,
    "gitURL":"git://bpms-assets"
 },
 {
   "name":"loanProject",
   "description":"Loan processes and rules",
   "userName":null,
   "password":null,
   "requestType":null,
   "gitURL":"git://loansProject"
 }
]</code></pre></div></div><br class="example-break"/></dd><dt><a id="url-get-repository"/><span class="term">[GET] <span class="command"><strong>/repositories/{repositoryName}</strong></span></span></dt><dd><p>Gets information about a repository</p><p>Returns a <code class="code">Map&lt;String, String&gt;</code> or <code class="code">RepositoryRequest</code> instance, depending on the JSON serialization library being used. The keys used in the <code class="code">Map&lt;String, String&gt;</code> instance match the fields in the <code class="code">RepositoryRequest</code> class</p><div class="example"><a id="d0e22591"/><p class="title"><strong>Example 20.3. An example (formatted) response body to the get repository call</strong></p><div class="example-contents"><pre><code class="no-highlight">{
  "name":"wb-assets",
  "description":"generic assets",
  "userName":null,
  "password":null,
  "requestType":null,
  "gitURL":"git://bpms-assets"
}</code></pre></div></div><br class="example-break"/></dd><dt><a id="url-create-repository"/><span class="term">[POST] <span class="command"><strong>/repositories</strong></span></span></dt><dd><p>Creates a new empty repository or a new repository cloned from an existing (git) repository</p><p>Consumes a <code class="code">RepositoryRequest</code> instance</p><p>Returns a <code class="code">CreateOrCloneRepositoryRequest</code> instance</p><div class="example"><a id="d0e22614"/><p class="title"><strong>Example 20.4. An example (formatted) response body to the create repositories
                                   call</strong></p><div class="example-contents"><pre><code class="no-highlight">{
  "name":"new-project-repo",
  "description":"repo for my new project",
  "userName":null,"password":null,
  "requestType":"new",
  "gitURL":null
}</code></pre></div></div><br class="example-break"/></dd><dt><a id="url-delete-repository"/><span class="term">[DELETE] <span class="command"><strong>/repositories/<span class="emphasis"><em>{repositoryName}</em></span></strong></span></span></dt><dd><p>Removes the repository from the Knowledge Store</p><p>Returns a <code class="code">RemoveRepositoryRequest</code> instance</p></dd><dt><a id="url-create-project"/><span class="term">[POST] <span class="command"><strong>/repositories/<span class="emphasis"><em>{repositoryName}</em></span>/projects/</strong></span></span></dt><dd><p>Creates a project in the repository</p><p>Consumes an <code class="code">Entity</code> instance</p><p>Returns a <code class="code">CreateProjectRequest</code> instance</p><div class="example"><a id="d0e22655"/><p class="title"><strong>Example 20.5. An example (formatted) request body that defines the project to be created</strong></p><div class="example-contents"><pre><code class="no-highlight">{
  "name":"myProject",
  "description": "my project"
}</code></pre></div></div><br class="example-break"/></dd><dt><a id="url-delete-project"/><span class="term">[DELETE] <span class="command"><strong>/repositories/<span class="emphasis"><em>{repositoryName}</em></span>/projects/</strong></span></span></dt><dd><p>Deletes the project in the repository</p><p>Returns a <code class="code">DeleteProjectRequest</code> instance</p></dd><dt><a id="url-get-projects"/><span class="term">[GET] <span class="command"><strong>/repositories/<span class="emphasis"><em>{repositoryName}</em></span>/projects/</strong></span></span></dt><dd><p>Gets information about the projects</p><p>Returns a <code class="code">Collection&lt;Map&lt;String, String&gt;&gt;</code> or <code class="code">Collection&lt;ProjectResponse&gt;</code> instance, depending on the JSON serialization library being used. The keys used in the <code class="code">Map&lt;String, String&gt;</code> instance match the fields in the <code class="code">ProjectResponse</code> class</p><div class="example"><a id="d0e22701"/><p class="title"><strong>Example 20.6. An example (formatted) response body to the get projects call</strong></p><div class="example-contents"><pre><code class="no-highlight">[
  {
    "name":"wb-assets",
    "description":"generic assets",
    "groupId":"org.test",
    "version":"1.0"
 },
 {
   "name":"loanProject",
   "description":"Loan processes and rules",
    "groupId":"com.bank",
    "version":"3.7"
 }
]</code></pre></div></div><br class="example-break"/></dd></dl></div></div><div class="section" title="20.1.3. Organizational unit calls"><div class="titlepage"><div><div><h3 class="title"><a id="d0e22706"/>20.1.3. Organizational unit calls</h3></div></div></div><p>Organizational unit calls are calls to the Knowledge Store that allow you to manage its organizational units, so as to organize the 
                connected Git repositories.
          </p><p>The following <code class="code">organizationalUnits</code> calls are provided:</p><div class="variablelist"><dl><dt><a id="url-create-org-unit"/><span class="term">[POST] <span class="command"><strong>/organizationalunits</strong></span></span></dt><dd><p>Creates an organizational unit in the Knowledge Store</p><p>Consumes an <code class="code">OrganizationalUnit</code> instance</p><p>Returns a <code class="code">CreateOrganizationalUnitRequest</code> instance</p><div class="example"><a id="d0e22735"/><p class="title"><strong>Example 20.7. An example (formatted) request body defining a new organizational unit to be created</strong></p><div class="example-contents"><pre><code class="no-highlight">{
  "name":"testgroup",
  "description":"",
  "owner":"tester",
  "repositories":["testGroupRepository"]
}</code></pre></div></div><br class="example-break"/></dd><dt><a id="url-get-org-unit"/><span class="term">[GET] <span class="command"><strong>/organizationalunits/{orgUnitName}</strong></span></span></dt><dd><p>Creates an organizational unit</p><p>Consumes an <code class="code">OrganizationalUnit</code> instance</p><p>Returns a <code class="code">CreateOrganizationalUnitRequest</code> instance</p><div class="example"><a id="d0e22758"/><p class="title"><strong>Example 20.8. An example (formatted) request body defining a new organizational unit to be created</strong></p><div class="example-contents"><pre><code class="no-highlight">{
  "name":"testgroup",
  "description":"",
  "owner":"tester",
  "repositories":["testGroupRepository"]
}</code></pre></div></div><br class="example-break"/></dd><dt><a id="url-update-org-unit"/><span class="term">[POST] <span class="command"><strong>/organizationalunits/{orgUnitName}</strong></span></span></dt><dd><p>Creates an organizational unit in the Knowledge Store</p><p>Consumes an <code class="code">UpdateOrganizationalUnit</code> instance</p><p>Returns a <code class="code">UpdateOrganizationalUnitRequest</code> instance</p><div class="example"><a id="d0e22781"/><p class="title"><strong>Example 20.9. An example (formatted) request body defining a new organizational unit to be created</strong></p><div class="example-contents"><pre><code class="no-highlight">{
  "name":"testgroup",
  "description":"",
  "owner":"tester",
  "repositories":["testGroupRepository"]
}</code></pre></div></div><br class="example-break"/></dd><dt><a id="url-remove-org-unit"/><span class="term">[DELETE] <span class="command"><strong>/organizationalunits/<span class="emphasis"><em>{organizationalUnitName}</em></span></strong></span></span></dt><dd><p>Deletes a organizational unit</p><p>Returns a <code class="code">RemoveOrganizationalUnitRequest</code> instance</p></dd><dt><a id="url-add-repo-to-org-unit"/><span class="term">[POST] <span class="command"><strong>/organizationalunits/<span class="emphasis"><em>{organizationalUnitName}</em></span>/repositories/<span class="emphasis"><em>{repositoryName}</em></span></strong></span></span></dt><dd><p>Adds the repository to the organizational unit</p><p>Returns a <code class="code">AddRepositoryToOrganizationalUnitRequest</code> instance</p></dd><dt><a id="url-remove-repo-to-org-unit"/><span class="term">[DELETE] <span class="command"><strong>/organizationalunits/<span class="emphasis"><em>{organizationalUnitName}</em></span>/repositories/<span class="emphasis"><em>{repositoryName}</em></span></strong></span></span></dt><dd><p>Removes the repository from the organizational unit</p><p>Returns a <code class="code">RemoveRepositoryFromOrganizationalUnitRequest</code> instance</p></dd></dl></div></div><div class="section" title="20.1.4. Maven calls"><div class="titlepage"><div><div><h3 class="title"><a id="d0e22837"/>20.1.4. Maven calls</h3></div></div></div><p>Maven calls are calls to a Project in the Knowledge Store that allow you compile and deploy the Project resources.</p><p>The following <code class="code">maven</code> calls are provided:</p><div class="variablelist"><dl><dt><a id="url-compile-project"/><span class="term"> [POST] <span class="command"><strong>/repositories/<span class="emphasis"><em>{repositoryName}</em></span>/projects/<span class="emphasis"><em>{projectName}</em></span>/maven/compile</strong></span></span></dt><dd><p>Compiles the project (equivalent to <code class="code">mvn compile</code>)</p><p>Consumes a <code class="code">BuildConfig</code> instance. While this must be supplied, it's not needed for the operation and may be left blank.</p><p>Returns a <code class="code">CompileProjectRequest</code> instance</p></dd><dt><a id="url-install-project"/><span class="term">[POST] <span class="command"><strong>/repositories/<span class="emphasis"><em>{repositoryName}</em></span>/projects/<span class="emphasis"><em>{projectName}</em></span>/maven/install</strong></span></span></dt><dd><p>Installs the project (equivalent to <code class="code">mvn install</code>)</p><p>Consumes a <code class="code">BuildConfig</code> instance. While this must be supplied, it's not needed for the operation and may be left blank.</p><p>Returns a <code class="code">InstallProjectRequest</code> instance</p></dd><dt><a id="url-test-project"/><span class="term">[POST] <span class="command"><strong>/repositories/<span class="emphasis"><em>{repositoryName}</em></span>/projects/<span class="emphasis"><em>{projectName}</em></span>/maven/test</strong></span></span></dt><dd><p>Compiles the project runs a test as part of compilation</p><p>Consumes a <code class="code">BuildConfig</code> instance</p><p>Returns a <code class="code">TestProjectRequest</code> instance</p></dd><dt><a id="url-deploy-project"/><span class="term">[POST] <span class="command"><strong>/repositories/<span class="emphasis"><em>{repositoryName}</em></span>/projects/<span class="emphasis"><em>{projectName}</em></span>/maven/deploy</strong></span></span></dt><dd><p>Deploys the project (equivalent to  <code class="code">mvn deploy</code>)</p><p>Consumes a <code class="code">BuildConfig</code> instance. While this must be supplied, it's not needed for the operation and may be left blank.</p><p>Returns a <code class="code">DeployProjectRequest</code> instance</p></dd></dl></div></div><div class="section" title="20.1.5. REST summary"><div class="titlepage"><div><div><h3 class="title"><a id="d0e22953"/>20.1.5. REST summary</h3></div></div></div><p>
        The URL templates in the table below are relative the following URL: 
        </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p> 
              <code class="code">http://server:port/business-central/rest</code>
            </p></li></ul></div><p>
      </p><div class="table"><a id="kstore_rest_api_calls"/><p class="title"><strong>Table 20.1. Knowledge Store REST calls</strong></p><div class="table-contents"><table summary="Knowledge Store REST calls" border="1"><colgroup><col width="62*" align="left" class="c1"/><col width="8*" align="left" class="c2"/><col width="30*" align="left" class="c3"/></colgroup><thead><tr><th align="left">URL Template</th><th align="left">Type</th><th align="left">Description</th></tr></thead><tbody><tr valign="top"><td align="left" valign="top">/jobs/{jobID}</td><td align="left" valign="top">GET</td><td align="left" valign="top">return the job status</td></tr><tr valign="top"><td align="left" valign="top">/jobs/{jobID}</td><td align="left" valign="top">DELETE</td><td align="left" valign="top">remove the job</td></tr><tr valign="top"><td align="left" valign="top">/organizationalunits</td><td align="left" valign="top">GET</td><td align="left" valign="top">return a list of organizational units</td></tr><tr valign="top"><td align="left" valign="top">/organizationalunits</td><td align="left" valign="top">POST</td><td align="left" valign="top">
              <p>create an organizational unit in the Knowledge Store described by the JSON <code class="code">OrganizationalUnit</code> entity</p>
            </td></tr><tr valign="top"><td align="left" valign="top">/organizationalunits/{organizationalUnitName}/repositories/{repositoryName}</td><td align="left" valign="top">POST</td><td align="left" valign="top">add a repository to an organizational unit</td></tr><tr valign="top"><td align="left" valign="top">/organizationalunits/{organizationalUnitName}/repositories/{repositoryName}</td><td align="left" valign="top">DELETE</td><td align="left" valign="top">remove a repository from an organizational unit</td></tr><tr valign="top"><td align="left" valign="top">/repositories/</td><td align="left" valign="top">POST</td><td align="left" valign="top">
              <p>add the repository to the organizational unit described by the JSON <code class="code">RepositoryReqest</code> entity</p>
            </td></tr><tr valign="top"><td align="left" valign="top">/repositories</td><td align="left" valign="top">GET</td><td align="left" valign="top">return the repositories in the Knowledge Store</td></tr><tr valign="top"><td align="left" valign="top">/repositories/{repositoryName}</td><td align="left" valign="top">DELETE</td><td align="left" valign="top">remove the repository from the Knowledge Store</td></tr><tr valign="top"><td align="left" valign="top">/repositories/</td><td align="left" valign="top">POST</td><td align="left" valign="top">create or clone the repository defined by the JSON <code class="code">RepositoryRequest</code> entity</td></tr><tr valign="top"><td align="left" valign="top">/repositories/{repositoryName}/projects/</td><td align="left" valign="top">POST</td><td align="left" valign="top">create the project defined by the JSON entity in the repository</td></tr><tr valign="top"><td align="left" valign="top">/repositories/{repositoryName}/projects/{projectName}/maven/compile/</td><td align="left" valign="top">POST</td><td align="left" valign="top">compile the project</td></tr><tr valign="top"><td align="left" valign="top">/repositories/{repositoryName}/projects/{projectName}/maven/install</td><td align="left" valign="top">POST</td><td align="left" valign="top">install the project</td></tr><tr valign="top"><td align="left" valign="top">/repositories/{repositoryName}/projects/{projectName}/maven/test/</td><td align="left" valign="top">POST</td><td align="left" valign="top">
              <p>compile the project and run tests as part of compilation</p>
            </td></tr><tr valign="top"><td align="left" valign="top">/repositories/{repositoryName}/projects/{projectName}/maven/deploy/</td><td align="left" valign="top">POST</td><td align="left" valign="top">deploy the project</td></tr></tbody></table></div></div><br class="table-break"/></div></div><div class="section" title="20.2. Keycloak SSO integration"><div class="titlepage"><div><div><h2 class="title"><a id="kie.KeycloakSSOIntegration"/>20.2. Keycloak SSO integration</h2></div></div></div><p>Single Sign On (SSO) and related token exchange mechanisms are becoming the most common
    scenario for the authentication and authorization in different environments on the web,
    specially when moving into the cloud. </p><p>This section talks about the integration of Keycloak with jBPM or Drools applications in
    order to use all the features provided on Keycloak. Keycloak is an integrated SSO and IDM for
    browser applications and RESTful web services. Lean more about it in the <a class="link" href="http://keycloak.jboss.org/">Keycloak's home page</a>.</p><p>The result of the integration with Keycloak has lots of advantages such as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Provide an integrated SSO and IDM environment for different clients, including jBPM
          and Drools workbenches</p></li><li class="listitem"><p>Social logins - use your Facebook, Google, Linkedin, etc accounts</p></li><li class="listitem"><p>User session management</p></li><li class="listitem"><p>And much more...</p></li></ul></div><p>Next sections cover the following integration points with Keycloak:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="bold"><strong>Workbench authentication through a Keycloak
          server</strong></span></p><p>It basically consists of securing both web client and remote service clients through
          the Keycloak SSO. So either web interface or remote service consumers ( whether a user or
          a service ) will authenticate into trough KC.</p></li><li class="listitem"><p><span class="bold"><strong>Execution server authentication through a Keycloak
            server</strong></span></p><p>Consists of securing the remote services provided by the execution server (as it does
          not provides web interface). Any remote service consumer ( whether a user or a service )
          will authenticate trough KC.</p></li><li class="listitem"><p><span class="bold"><strong>Consuming remote services</strong></span></p><p>This section describes how a third party clients can consume the remote service
          endpoints provided by both Workbench and Execution Server, such as the REST API or remote file system services.</p></li></ul></div><div class="section" title="20.2.1. Scenario"><div class="titlepage"><div><div><h3 class="title"><a id="d0e23153"/>20.2.1. Scenario</h3></div></div></div><p>Consider the following diagram as the environment for this document's example:</p><p>Keycloak is a standalone process that provides remote authentication, authorization and
      administration services that can be potentially consumed by one or more jBPM applications over
      the network.</p><div class="figure"><a id="d0e23160"/><p class="title"><strong>Figure 20.1. </strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Workbench/KeycloakSSOIntegration/KeyCloak_sso_scenario.png"/></div></div></div><br class="figure-break"/><p>Consider these main steps for building this environment:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Install and setup a Keycloak server</p></li><li class="listitem"><p>Create and setup a Realm for this example - Configure realm's clients, users and
            roles</p></li><li class="listitem"><p>Install and setup the SSO client adapter &amp; jBPM application</p></li></ul></div><p>Note: The resulting environment and the different configurations for this document are
      based on the jBPM (KIE) Workbench, but same ones can also be applied for the KIE Drools
      Workbench as well.</p></div><div class="section" title="20.2.2. Install and setup a Keycloak server"><div class="titlepage"><div><div><h3 class="title"><a id="d0e23178"/>20.2.2. Install and setup a Keycloak server</h3></div></div></div><p>Keycloak provides an extensive documentation and several articles about the installation
      on different environments. This section describes the minimal setup for being able to build
      the integrated environment for the example. Please refer to the <a class="link" href="http://keycloak.jboss.org/docs">Keycloak documentation</a> if you need more
      information.</p><p>Here are the steps for a minimal Keycloak installation and setup:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Download latest version of Keycloak from the <a class="link" href="http://keycloak.jboss.org/downloads">Downloads</a> section. This
            example is based on Keycloak 1.9.0.Final</p></li><li class="listitem"><p>Unzip the downloaded distribution of Keycloak into a folder, let's refer it as
            </p><pre><code class="no-highlight">$KC_HOME</code></pre></li><li class="listitem"><p>Run the KC server - This example is based on running both Keycloak and jBPM on same
            host. In order to avoid port conflicts you can use a port offset for the Keycloak's
            server as:</p><p>
            </p><pre><code class="no-highlight">$KC_HOME/bin/standalone.sh -Djboss.socket.binding.port-offset=100</code></pre><p>
          </p></li></ul></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Create a Keycloak's administration user - Execute the following command to create an
            admin user for this example:</p><p>
            </p><pre><code class="no-highlight">$KC_HOME/bin/add-user.sh -r master -u 'admin' -p 'admin'</code></pre><p>
          </p></li></ul></div><p>The Keycloak administration console will be available at <a class="link" href="http://localhost:8180/auth/admin">http://localhost:8180/auth/admin</a> (use
      the admin/admin for login credentials).</p></div><div class="section" title="20.2.3. Create and setup the demo realm"><div class="titlepage"><div><div><h3 class="title"><a id="d0e23222"/>20.2.3. Create and setup the demo realm</h3></div></div></div><p>Security realms are used to restrict the access for the different application's
      resources.</p><p>Once the Keycloak server is running next step is about creating a realm. This realm will
      provide the different users, roles, sessions, etc for the jBPM application/s.</p><p>Keycloak provides several examples for the realm creation and management, from the <a class="link" href="https://github.com/keycloak/keycloak/tree/master/examples">official
        examples</a> to different articles with more examples.</p><p>Follow these steps in order to create the <span class="italic">demo</span> realm
      used later in this document:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Go to the Keycloak <a class="link" href="http://localhost:8180/auth/admin">administration console</a> and click on <span class="italic">Add
              realm</span> button. Give it the name <span class="italic">demo</span>.</p></li><li class="listitem"><p>Go to the Clients section (from the main admin console menu) and create a new client
            for the <span class="italic">demo</span> realm:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Client ID:  <span class="emphasis"><em>kie</em></span></p></li><li class="listitem"><p>Client protocol: <span class="emphasis"><em>openid-connect</em></span></p></li><li class="listitem"><p>Acces type: <span class="emphasis"><em>confidential</em></span></p></li><li class="listitem"><p>Root URL: <span class="emphasis"><em>http://localhost:8080</em></span></p></li><li class="listitem"><p>Base URL:  <span class="italic">/kie-wb-6.4.0.Final</span></p></li><li class="listitem"><p>Redirect URIs: <span class="italic">/kie-wb-6.4.0.Final/*</span></p></li></ul></div></li></ul></div><p>The resulting <span class="italic">kie</span> client settings screen:</p><div class="figure"><a id="d0e23294"/><p class="title"><strong>Figure 20.2. </strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Workbench/KeycloakSSOIntegration/kie_client_settings.png"/></div></div></div><br class="figure-break"/><p><span class="underline">Note</span>: As you can see in the above settings it's
      being considered the value <span class="italic">kie-wb-6.4.0.Final</span> for the
      application's context path. If your jbpm application will be deployed on a different context
      path, host or port, just use your concrete settings here.</p><p>Last step for being able to use the <span class="italic">demo </span>realm from the
      jBPM workbench is create the application's user and roles:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Go to the Roles section and create the roles <span class="italic">admin,</span>
            <span class="italic">kiemgmt </span>and <span class="italic">rest-all</span></p></li><li class="listitem"><p>Go to the Users section and create the <span class="italic">admin
            </span>user. Set the password with value "password" in the credentials tab, unset
            the temporary switch.</p></li><li class="listitem"><p>In  the Users section navigate to the <span class="italic">Role
              Mappings</span> tab and assign the <span class="italic">admin,
              </span><span class="italic">kiemgmt </span>and <span class="italic">rest-all</span> roles to the <span class="italic">admin</span> user</p><div class="figure"><a id="d0e23345"/><p class="title"><strong>Figure 20.3. </strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Workbench/KeycloakSSOIntegration/admin_user_roles.png"/></div></div></div><br class="figure-break"/></li></ul></div><p>At this point a Keycloak server is running on the host, setup with a minimal configuration
      set. Let's move to the jBPM workbench setup.</p></div><div class="section" title="20.2.4. Install and setup jBPM Workbench"><div class="titlepage"><div><div><h3 class="title"><a id="d0e23351"/>20.2.4. Install and setup jBPM Workbench</h3></div></div></div><p>For this tutorial let's use a Wildfly as the application server for the jBPM workbench, as
      the jBPM installer does by default.</p><p>Let's assume, after running the jBPM installer, the <span class="italic">$JBPM_HOME</span> as the root path for the Wildfly server where the application has
      been deployed.</p><div class="section" title="20.2.4.1. Install the KC adapter"><div class="titlepage"><div><div><h4 class="title"><a id="d0e23361"/>20.2.4.1. Install the KC adapter</h4></div></div></div><p>In order to use the Keycloak's authentication and authorization modules from the jBPM
        application, the <a class="link" href="https://keycloak.github.io/docs/userguide/keycloak-server/html/ch08.html">Keycloak adapter</a> for Wildfly must be installed on our server at <span class="italic">$JBPM_HOME</span>. Keycloak provides multiple adapters for different
        containers out of the box, if you are using another container or need to use another
        adapter, please take a look at the <a class="link" href="https://keycloak.github.io/docs/userguide/keycloak-server/html/ch08.html">adapters configuration </a>from Keycloak docs. Here are the steps to install and setup
        the adapter for Wildfly 8.2.x:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Download the adapter from <a class="link" href="https://repository.jboss.org/nexus/service/local/repositories/central/content/org/keycloak/keycloak-wf8-adapter-dist/1.9.0.Final/keycloak-wf8-adapter-dist-1.9.0.Final.zip">here</a></p></li><li class="listitem"><p>Execute the following commands on your shell:</p><p>
              </p><pre><code class="no-highlight">cd $JBPM_HOME/unzip keycloak-wf8-adapter-dist.zip // Install the KC client adapter

cd $JBPM_HOME/bin
./standalone.sh -c standalone-full.xml // Setup the KC client adapter.

// ** Once server is up, open a new command line terminal and run:
cd $JBPM_HOME/bin
./jboss-cli.sh -c --file=adapter-install.cli</code></pre><p>
            </p></li></ul></div></div><div class="section" title="20.2.4.2. Configure the KC adapter"><div class="titlepage"><div><div><h4 class="title"><a id="d0e23389"/>20.2.4.2. Configure the KC adapter</h4></div></div></div><p>Once installed the KC adapter into Wildfly, next step is to configure the adapter in
        order to specify different settings such as the location for the authentication server, the
        realm to use and so on.</p><p>Keycloak provides two ways of configuring the adapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Per WAR configuration</p></li><li class="listitem"><p>Via Keycloak subsystem</p></li></ul></div><p>In this example let's use the second option, use the Keycloak subsystem, so our WAR is
        free from this kind of settings. If you want to use the per WAR approach, please take a look
          <a class="link" href="https://keycloak.github.io/docs/userguide/keycloak-server/html/ch08.html#d4e932">here</a>.</p><p>Edit the configuration file <span class="italic">$JBPM_HOME/standalone/configuration/standalone-full.xml</span> and locate the
        subsystem configuration section. Add the following content:</p><p>
        </p><pre><code class="no-highlight">&lt;subsystem xmlns="urn:jboss:domain:keycloak:1.1"&gt;
  &lt;secure-deployment name="kie-wb-6.4.0-Final.war"&gt;
    &lt;realm&gt;demo&lt;/realm&gt;
    &lt;realm-public-key&gt;MIIBIjANBgkqhkiG9w0BAQEFAAOCA...&lt;/realm-public-key&gt;
    &lt;auth-server-url&gt;http://localhost:8180/auth&lt;/auth-server-url&gt;
    &lt;ssl-required&gt;external&lt;/ssl-required&gt;
    &lt;resource&gt;kie&lt;/resource&gt;
    &lt;enable-basic-auth&gt;true&lt;/enable-basic-auth&gt;
    &lt;credential name="secret"&gt;925f9190-a7c1-4cfd-8a3c-004f9c73dae6&lt;/credential&gt;
    &lt;principal-attribute&gt;preferred_username&lt;/principal-attribute&gt;
  &lt;/secure-deployment&gt;
&lt;/subsystem&gt;</code></pre><p>
      </p><p>If you have imported the example json files from this document in <span class="italic">step 2</span>, you can just use same configuration as above by using
        your concrete deployment name . Otherwise please use your values for these configurations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="underline">Name for the secure deployment</span> - Use your
              concrete application's WAR file name</p></li><li class="listitem"><p><span class="underline">Realm</span> - Is the realm that the applications
              will use, in our example, the <span class="italic">demo </span>realm created
              the previous step.</p></li><li class="listitem"><p><span class="underline">Realm Public Key</span> - Provide here the public
              key for the <span class="italic">demo </span>realm. It's not mandatory, if it's
              not specified, it will be retrieved from the server. Otherwise, you can find it in the
              Keycloak admin console -&gt; Realm settings ( for <span class="italic">demo</span>
              realm ) -&gt; Keys</p></li><li class="listitem"><p><span class="underline">Authentication server URL</span> - The URL for the
              Keycloak's authentication server</p></li><li class="listitem"><p><span class="underline">Resource</span> - The name for the client created
              on step 2. In our example, use the value <span class="italic">kie</span>.</p></li><li class="listitem"><p><span class="underline">Enable basic auth </span>- For this example let's
              enable Basic authentication mechanism as well, so clients can use both Token (Baerer)
              and Basic approaches to perform the requests.</p></li><li class="listitem"><p><span class="underline">Credential</span> - Use the password value for the
                <span class="italic">kie </span>client. You can find it in the Keycloak admin
              console -&gt; Clients -&gt; kie -&gt; Credentials tab -&gt; Copy the value for the <span class="italic">secret</span>.</p></li></ul></div><p>For this example you have to take care about using your concrete values for <span class="italic">secure-deployment name</span>, <span class="italic">realm-public-key
        </span>and <span class="italic">credential </span>password. You can find detailed
        information about the KC adapter configurations <a class="link" href="https://keycloak.github.io/docs/userguide/keycloak-server/html/ch08.html#adapter-config">here</a>.</p></div><div class="section" title="20.2.4.3. Run the environment"><div class="titlepage"><div><div><h4 class="title"><a id="d0e23491"/>20.2.4.3. Run the environment</h4></div></div></div><p>At this point a Keycloak server is up and running on the host, and the KC adapter is
        installed and configured for the jBPM application server. You can run the application
        using:</p><p>
        </p><pre><code class="no-highlight">$JBPM_HOME/bin/standalone.sh -c standalone-full.xml</code></pre><p>
      </p><p>You can navigate into the application once the server is up at:</p><p>
        </p><pre><code class="no-highlight"> <a class="link" href="http://localhost:8080/kie-wb-6.4.0.Final">http://localhost:8080/kie-wb-6.4.0.Final</a></code></pre><p>
      </p><div class="figure"><a id="d0e23510"/><p class="title"><strong>Figure 20.4. </strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Workbench/KeycloakSSOIntegration/jbpm_login_screen.png"/></div></div></div><br class="figure-break"/><p>Use your Keycloak's admin user credentials to login: <span class="italic">admin/password</span>.</p></div></div><div class="section" title="20.2.5. Securing workbench remote services via Keycloak"><div class="titlepage"><div><div><h3 class="title"><a id="d0e23519"/>20.2.5. Securing workbench remote services via Keycloak</h3></div></div></div><p>Both jBPM and Drools workbenches provides different remote service endpoints that can be
      consumed by third party clients using the <a class="link" href="http://docs.jboss.org/jbpm/v6.3/userguide/ch17.html">remote API</a>.</p><p>In order to authenticate those services thorough Keycloak the <span class="italic">BasicAuthSecurityFilter</span> must be disabled, apply those modifications for the the
        <span class="italic">WEB-INF/web.xml</span> file (app deployment descriptor) from
      jBPM's WAR file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Remove the following filter from the deployment descriptor:</p><p>
            </p><pre><code class="no-highlight">&lt;filter&gt;  
  &lt;filter-name&gt;HTTP Basic Auth Filter&lt;/filter-name&gt;
  &lt;filter-class&gt;org.uberfire.ext.security.server.BasicAuthSecurityFilter&lt;/filter-class&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;realmName&lt;/param-name&gt;
    &lt;param-value&gt;KIE Workbench Realm&lt;/param-value&gt;
  &lt;/init-param&gt;
&lt;/filter&gt;

&lt;filter-mapping&gt;
  &lt;filter-name&gt;HTTP Basic Auth Filter&lt;/filter-name&gt;
  &lt;url-pattern&gt;/rest/*&lt;/url-pattern&gt;
  &lt;url-pattern&gt;/maven2/*&lt;/url-pattern&gt;
  &lt;url-pattern&gt;/ws/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;</code></pre><p>
          </p></li><li class="listitem"><p>Constraint the remote services URL patterns as:</p><p>
            </p><pre><code class="no-highlight">&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
    &lt;web-resource-name&gt;remote-services&lt;/web-resource-name&gt;
    &lt;url-pattern&gt;/rest/*&lt;/url-pattern&gt;
    &lt;url-pattern&gt;/maven2/*&lt;/url-pattern&gt;
    &lt;url-pattern&gt;/ws/*&lt;/url-pattern&gt;
  &lt;/web-resource-collection&gt;
  &lt;auth-constraint&gt;
    &lt;role-name&gt;rest-all&lt;/role-name&gt;
  &lt;/auth-constraint&gt;
&lt;/security-constraint&gt;</code></pre><p>
          </p></li></ul></div><p><span class="underline">Important note</span>: The user that consumes the remote
      services must be member of role <span class="italic">rest-all</span>. As on described
      previous steps, the <span class="italic">admin</span> user in this example it's already
      a member of the <span class="italic">rest-all </span>role.</p></div><div class="section" title="20.2.6. Securing workbench's file system services via Keycloak"><div class="titlepage"><div><div><h3 class="title"><a id="d0e23565"/>20.2.6. Securing workbench's file system services via Keycloak</h3></div></div></div><p>In order to consume other remote services such as the file system ones (e.g. remote GIT), a specific <span class="bold"><strong>Keycloak login module must be used</strong></span>
      for the application's security domain in the <span class="italic">$JBPM_HOME/standalone/configuration/standalone-full.xml</span>
      file. By default the workbench uses the <span class="italic">other</span> security domain, so
      the resulting  configuration on the <span class="italic">$JBPM_HOME/standalone/configuration/standalone-full.xml</span> should be such as:</p><pre><code class="no-highlight">
      &lt;security-domain name="other" cache-type="default"&gt;
        &lt;authentication&gt;
          &lt;login-module code="org.keycloak.adapters.jaas.DirectAccessGrantsLoginModule" flag="required"&gt;
            &lt;!-- Parameter value can be a file system absolute path or a classpath (e.g. "classpath:/some-path/kie-git.json")--&gt;
            &lt;module-option name="keycloak-config-file" value="$JBPM_HOME/kie-git.json"/&gt;
          &lt;/login-module&gt;
        &lt;/authentication&gt;
      &lt;/security-domain&gt;
    </code></pre><p>Note that:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The login modules on the <span class="italic">other</span> security domain in the
          <span class="italic">$JBPM_HOME/standalone/configuration/standalone-full.xml</span> file must be REPLACED by the above given one.</p></li><li class="listitem"><p>Replace <span class="italic">$JBPM_HOME/kie-git.json</span> by the path (on file system) or the classpath (e.g.
           <span class="italic">classpath:/some-path/kie-git.json</span>) for the json configuration file used for the
        remote services client. Please continue reading in order to create this Keycloak client and how to obtain this json file.</p></li></ul></div><p>At this point, remote services that use JAAS for the authentication process, such as the file system ones ( e.g. GIT ), are
      secured by Keycloak using the client specified in the above json configuration file. So let's create this client on Keycloak and
      generate the required JSON file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Navigate to the <a class="link" href="http://localhost:8180/auth/admin">KC administration console</a> and create a new
          client for the <span class="italic">demo</span> realm using <span class="italic">kie-git</span> as name.</p></li><li class="listitem"><p>Enable
          <span class="italic">Direct Access Grants Enabled</span> option, disable
          <span class="italic">Standard Flow Enabled</span> and use a
          <span class="italic">confidential</span> access type for this client. See below image as example:</p><div class="figure"><a id="d0e23632"/><p class="title"><strong>Figure 20.5. </strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Workbench/KeycloakSSOIntegration/kie_git_client_settings.png"/></div></div></div><br class="figure-break"/></li><li class="listitem"><p>Go to the <span class="italic">Installation</span> tab in same <span class="italic">kie-git</span> client
        configuration screen and export using the <span class="italic">Keycloak OIDC JSON</span> type.</p></li><li class="listitem"><p>Finally copy this generated JSON file into an accessible directory on the server's file system or add it in the application's
        classpath. Use this path value as the <span class="italic">keycloak-config-file</span> argument for the
          above configuration of the <span class="italic">org.keycloak.adapters.jaas.DirectAccessGrantsLoginModule</span> login
          module.
        </p></li><li class="listitem"><p>More information about Keycloak JAAS Login modules can be found <a class="link" href="https://keycloak.gitbooks.io/securing-client-applications-guide/content/v/2.2/topics/oidc/java/jaas.html">here</a>.</p></li></ul></div><p>At this point, the internal Git repositories can be cloned by all users authenticated via the Keycloak server.
      Command example: </p><pre><code class="no-highlight">git clone ssh://admin@localhost:8001/system</code></pre><p>
    </p></div><div class="section" title="20.2.7. Execution server"><div class="titlepage"><div><div><h3 class="title"><a id="d0e23668"/>20.2.7. Execution server</h3></div></div></div><p>The KIE Execution Server provides a <a class="link" href="https://docs.jboss.org/drools/release/latest/drools-docs/html/ch22.html">REST
        API</a> than can be consumed for any third party clients,. This this section is about how
      to integration the KIE Execution Server with the Keycloak SSO in order to delegate the third
      party clients identity management to the SSO server.</p><p>Consider the above environment running, so consider having:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>A Keycloak server running and listening on http://localhost:8180/auth</p></li><li class="listitem"><p>A realm named <span class="italic">demo</span> with a client named <span class="italic">kie</span> for the jBPM Workbench</p></li><li class="listitem"><p>A  jBPM Workbench running at http://localhost:8080/kie-wb-6.4.0-Final</p></li></ul></div><p>Follow these steps in order to add an execution server into this environment:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Create the client for the execution server on Keycloak</p></li><li class="listitem"><p>Install setup and the Execution server ( with the KC client adapter )</p></li></ul></div><div class="section" title="20.2.7.1. Create the execution server's client on Keycloak"><div class="titlepage"><div><div><h4 class="title"><a id="d0e23703"/>20.2.7.1. Create the execution server's client on Keycloak</h4></div></div></div><p>As per each execution server is going to be deployed, you have to create a new client on
        the <span class="italic">demo</span> realm in Keycloak.:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Go to the <a class="link" href="https://mojo.redhat.com/external-link.jspa?url=http%3A%2F%2Flocalhost%3A8180%2Fauth%2Fadmin">KC admin console</a> -&gt; Clients -&gt; New client</p></li><li class="listitem"><p>Name: <span class="italic">kie-execution-server</span></p></li><li class="listitem"><p>Root URL: <span class="emphasis"><em>http://localhost:8280/</em></span></p></li><li class="listitem"><p>Client protocol: <span class="emphasis"><em>openid-connect</em></span></p></li><li class="listitem"><p>Access type: <span class="emphasis"><em>confidential</em></span> ( or <span class="emphasis"><em>public</em></span> if
              you want so, but not recommended for production environments)</p></li><li class="listitem"><p>Valid redirect URIs: <span class="emphasis"><em>/kie-server-6.4.0.Final/*</em></span></p></li><li class="listitem"><p>Base URL: <span class="emphasis"><em>/kie-server-6.4.0.Final</em></span></p></li></ul></div><p>In this example the <span class="italic">admin</span> user already created on
        previous steps is the one used for the client requests. So ensure that the <span class="italic">admin</span> user is member of the role <span class="italic">kie-server</span> in order to use the execution server's remote services. If the role
        does not exist, create it.</p><p>Note: This example considers that the execution server will be configured to run using a
        port offset of 200, so the HTTP port will be available at localhost:8280.</p></div><div class="section" title="20.2.7.2. Install and setup the KC adapter on the execution server"><div class="titlepage"><div><div><h4 class="title"><a id="d0e23765"/>20.2.7.2. Install and setup the KC adapter on the execution server</h4></div></div></div><p>At this point, a client named <span class="italic">kie-execution-server</span> is
        ready on the KC server to use from the execution server. </p><p>Let's install, setup and deploy the execution server:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Install another Wildfly server to use for the execution server and the KC client
              adapter as well. You can follow above instructions for the Workbench or follow the
                <a class="link" href="https://keycloak.github.io/docs/userguide/keycloak-server/html/ch08.html">official adapters documentation</a></p></li><li class="listitem"><p>Edit the <span class="italic">standalone-full.xml</span> file from the
              Wildfly server's configuration path and configure the KC subsystem adapter as:</p><p>
              </p><pre><code class="no-highlight">&lt;secure-deployment name="kie-server-6.4.0.Final.war"&gt;
    &lt;realm&gt;demo&lt;/realm&gt;
    &lt;realm-public-key&gt;MIGfMA0GCSqGSIb...&lt;/realm-public-key&gt;
    &lt;auth-server-url&gt;http://localhost:8180/auth&lt;/auth-server-url&gt;
    &lt;ssl-required&gt;external&lt;/ssl-required&gt;
    &lt;resource&gt;kie-execution-server&lt;/resource&gt;
    &lt;enable-basic-auth&gt;true&lt;/enable-basic-auth&gt;
    &lt;credential name="secret"&gt;e92ec68d-6177-4239-be05-28ef2f3460ff&lt;/credential&gt;
    &lt;principal-attribute&gt;preferred_username&lt;/principal-attribute&gt;
&lt;/secure-deployment&gt;</code></pre><p>
            </p></li></ul></div><p>Consider your concrete environment settings if different from this example:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Secure deployment name -&gt; use the name of the execution server war file being
              deployed</p></li><li class="listitem"><p>Public key -&gt; Use the demo realm public key or leave it blank, the server will
              provide one if so</p></li><li class="listitem"><p>Resource -&gt; This time, instead of the kie client used in the WB configuration, use
              the <span class="italic">kie-execution-server</span> client</p></li><li class="listitem"><p>Enable basic auth -&gt; Up to you. You can enable Basic auth for third party service
              consumers</p></li><li class="listitem"><p>Credential -&gt; Use the secret key for the <span class="italic">kie-execution-server</span> client. You can find it in the <span class="italic">Credentials</span>tab of the KC admin console</p></li></ul></div></div><div class="section" title="20.2.7.3. Deploy and run the execution server"><div class="titlepage"><div><div><h4 class="title"><a id="d0e23819"/>20.2.7.3. Deploy and run the execution server</h4></div></div></div><p>Just deploy the execution server in Wildfly using any of the available mechanisms. Run
        the execution server using this command:</p><p>
        </p><pre><code class="no-highlight">$EXEC_SERVER_HOME/bin/standalone.sh -c standalone-full.xml -Djboss.socket.binding.port-offset=200 -Dorg.kie.server.id=&lt;ID&gt; -Dorg.kie.server.user=&lt;USER&gt; -Dorg.kie.server.pwd=&lt;PWD&gt; -Dorg.kie.server.location=&lt;LOCATION_URL&gt;  -Dorg.kie.server.controller=&lt;CONTROLLER_URL&gt; -Dorg.kie.server.controller.user=&lt;CONTROLLER_USER&gt; -Dorg.kie.server.controller.pwd=&lt;CONTOLLER_PASSWORD&gt;</code></pre><p>
      </p><p>Example:</p><p>
        </p><pre><code class="no-highlight">$EXEC_SERVER_HOME/bin/standalone.sh -c standalone-full.xml -Djboss.socket.binding.port-offset=200 -Dorg.kie.server.id=kieserver1 -Dorg.kie.server.user=admin -Dorg.kie.server.pwd=password -Dorg.kie.server.location=http://localhost:8280/kie-server-6.4.0.Final/services/rest/server -Dorg.kie.server.controller=http://localhost:8080/kie-wb-6.4.0.Final/rest/controller -Dorg.kie.server.controller.user=admin -Dorg.kie.server.controller.pwd=password</code></pre><p>
      </p><p><span class="underline">mportant note</span>: The users that will consume the
        execution server remote service endpoints must have the role kie-server assigned. So create
        and assign this role in the KC admin console for the users that will consume the execution
        server remote services.</p><p>Once up, you can check the server status as (considered using Basic authentication for
        this request, see next<span class="italic">Consuming remote services</span> for more
        information):</p><p>
        </p><pre><code class="no-highlight">curl http://admin:password@localhost:8280/kie-server-6.4.0.Final/services/rest/server/</code></pre><p>
      </p></div></div><div class="section" title="20.2.8. Consuming remote services"><div class="titlepage"><div><div><h3 class="title"><a id="d0e23850"/>20.2.8. Consuming remote services</h3></div></div></div><p>In order to use the different remote services provided by the Workbench or by an Execution
      Server, your client must be authenticated on the KC server and have a valid token to perform
      the requests.</p><p>Remember that in order to use the remote services, the authenticated user must have assigned:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The role <span class="italic">rest-all</span> for using the WB remote
            services</p></li><li class="listitem"><p>The role <span class="italic">kie-server</span> for using the Execution
            Server remote services</p></li></ul></div><p>Please ensure necessary roles are created and assigned to the users that will consume the
      remote services on the Keycloak admin console.</p><p>You have two options to consume the different remove service endpoints:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Using basic authentication, if the application's client supports it</p></li><li class="listitem"><p>Using Bearer ( token) based authentication</p></li></ul></div><div class="section" title="20.2.8.1. Using basic authentication"><div class="titlepage"><div><div><h4 class="title"><a id="d0e23881"/>20.2.8.1. Using basic authentication</h4></div></div></div><p>If the KC client adapter configuration has the Basic authentication enabled, as proposed
        in this guide for both WB (<span class="italic">step 3.2</span>) and Execution
        Server, you can avoid the token grant/refresh calls and just call the services as the
        following examples.</p><p>Example for a WB remote repositories endpoint:</p><p>
        </p><pre><code class="no-highlight">curl http://admin:password@localhost:8080/kie-wb-6.4.0.Final/rest/repositories</code></pre><p>
      </p><p>Example to check the status for the Execution Server:</p><p>
        </p><pre><code class="no-highlight">curl http://admin:password@localhost:8280/kie-server-6.4.0.Final/services/rest/server/</code></pre><p>
      </p></div><div class="section" title="20.2.8.2. Using token based authentication"><div class="titlepage"><div><div><h4 class="title"><a id="d0e23903"/>20.2.8.2. Using token based authentication</h4></div></div></div><p>First step is to create a new client on Keycloak that allows the third party remote
        service clients to obtain a token. It can be done as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Go to the KC admin console and create a <span class="underline">new
                client</span> using this configuration:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Client id: <span class="italic">kie-remote</span></p></li><li class="listitem"><p>Client protocol: <span class="italic">openid-connect</span></p></li><li class="listitem"><p>Access type: <span class="italic">public</span></p></li><li class="listitem"><p>Valid redirect URIs: <span class="italic">http://localhost/</span></p></li></ul></div></li><li class="listitem"><p>As we are going to manually obtain a token and invoke the service let's increase
              the lifespan of tokens slightly. In production access tokens should have a relatively
              low timeout, ideally less than 5 minutes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Go to the KC admin console</p></li><li class="listitem"><p>Click on your Realm Settings</p></li><li class="listitem"><p>Click on Tokens tab</p></li><li class="listitem"><p>Change the value for Access Token Lifespan to 15 minutes ( That should give
                    us plenty of time to obtain a token and invoke the service before it expires
                    )</p></li></ul></div></li></ul></div><p>Once a public client for our remote clients has been created, you can now obtain the
        token by performing an HTTP request to the KC server's tokens endpoint. Here is an example
        for command line:</p><p>
        </p><pre><code class="no-highlight">RESULT=`curl --data "grant_type=password&amp;client_id=kie-remote&amp;username=admin&amp;passwordpassword=&lt;the_client_secret&gt;" http://localhost:8180/auth/realms/demo/protocol/openid-connect/token`</code></pre><p>
        </p><pre><code class="no-highlight">TOKEN=`echo $RESULT | sed 's/.*access_token":"//g' | sed 's/".*//g'`</code></pre><p>
      </p><p>At this point, if you echo the <span class="italic">$TOKEN</span> it will output
        the token string obtained from the KC server, that can be now used to authorize further
        calls to the remote endpoints. For exmple, if you want to check the internal jBPM
        repositories:</p><p>
        </p><pre><code class="no-highlight">curl -H "Authorization: bearer $TOKEN" http://localhost:8080/kie-wb-6.4.0.Final/rest/repositories</code></pre><p>
      </p></div></div></div></div><script type="text/javascript" src="highlight.js/highlight.pack.js"> </script><script type="text/javascript">hljs.initHighlightingOnLoad();</script><ul class="docnav"><li class="previous"><a accesskey="p" href="ch19.html"><strong>Prev</strong>Chapter 19. Authoring Rule Assets</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="ch21.html"><strong>Next</strong>Chapter 21. Workbench High Availability</a></li></ul></body></html>