<html lang="en-US"  xmlns="http://www.w3.org/1999/xhtml"><head></head><body  onload="load()">﻿
        <title>使用事务（Java™教程> JDBC（TM）数据库访问> JDBC基础）</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
     <meta name="description" content="This JDBC Java tutorial describes how to use JDBC API to create, insert into, update, and query tables. You will also learn how to use simple and prepared statements, stored procedures and perform transactions">
     <meta name="keywords" content="java programming, learn java, java sample code, jdbc, prepared statement, result set">
        
<style type="text/css">
    body {
        margin-left:10px;
        margin-right:10px;
        line-height: 1.5;
        FONT-FAMILY: Arial, Helvetica, sans-serif; 
        font-size: 0.8em;
    }
    
    a:link{text-decoration:none; color:#09569d;}
    a:visited{text-decoration:none; color: #3a87cf;}
    a:hover{text-decoration:underline; }
        
    code{
        font-family:Monaco,Courier,"Courier New";
    }
    
    .header-container {
        background-color: #fff;
        border-bottom: 1px solid #C1CFDA;
        -webkit-box-shadow: 0 2px 2px rgba(117, 163, 231, 0.1);
        box-shadow: 0 2px 2px rgba(117, 163, 231, 0.1);
    }
    
    .bookwrapper {
        width: auto;
        margin: auto;
    }
    
    .clearfix {
    }
    
    .clearfloat {
        clear: both;
        overflow: auto;
        height: 0px;
        font-size: 1px;
        line-height: 0px;
    }
    
    #brandProdName {
        width: auto;
        height: auto;
    }
    
    #logocover {
        display: block;
        background: transparent url(../../images/oracle-java-logo.png) 0px 0px no-repeat;
        height: 50px;
        width: 229px;
        float: left;
    }
    
    #productName {
        font-size: 16px;
        position: relative;
        top: 19px;
        padding-left: 3px;
        color: #457798;
        white-space: nowrap;
        width: 340px;
    }


    .FigureCaption   { 
        font-family: sans-serif; 
        text-align: center;
    }
    
    #TopBar_bl {        
        width: 100%;
        height: 60px;
    }
    #TopBar_br {
        width: 100%;
        height: 60px;
    }
    #TopBar_tl {
        margin-left: -110px;
        margin-right: -100px;       
		align: left;
        height: 60px;
    }
    #TopBar_tr {
        width: 100%;
        height: 60px;
    }
    
    #TopBar {
        min-width:700px;
        padding:25px 100px 10px;
        margin-bottom:25px;
        clear:both;
        
        border-bottom:1px solid #d2dde5;
        border-radius: 3px;
    
        background:#efefef; /* Old browsers */
        /* IE9 SVG, needs conditional override of 'filter' to 'none' */
        background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmZmZmZiIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNlMmVmZjkiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
        background: -moz-linear-gradient(top,  #ffffff 0%, #e2eff9 100%); /* FF3.6+ */
        background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffffff), color-stop(100%,#e2eff9)); /* Chrome,Safari4+ */
        background: -webkit-linear-gradient(top,  #ffffff 0%,#e2eff9 100%); /* Chrome10+,Safari5.1+ */
        background: -o-linear-gradient(top,  #ffffff 0%,#e2eff9 100%); /* Opera 11.10+ */
        background: -ms-linear-gradient(top,  #ffffff 0%,#e2eff9 100%); /* IE10+ */
        background: linear-gradient(to bottom,  #ffffff 0%,#e2eff9 100%); /* W3C */
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#e2eff9',GradientType=0 ); /* IE6-8 */
        
    }
    
    #TopBar_left {
        line-height: 14px;
        position: absolute;
        padding-top: 30px;
        padding-right: 30px;
        padding-left: 30px;
        text-align: left;
        font: 13px/20px Arial, Helvetica, sans-serif;
        font-weight: bold;
        font-size: 20px;
        color: #333;
    }
    
    #TopBar_right {
        line-height: 12px;
        float: right;
        padding-top: 10px;
        padding-right: 30px;
        text-align: left;
    }
    

    @media print {
        #BreadCrumbs, #Download {
            display: none;
        }
    }
    
     
    @media print {
        #TopBar_right {
            display: none;
        }
    }
    #TopBar_right a {
        font-size: 10px;
        margin: 3px;
        padding: 0;
    }
 
    #BreadCrumbs {
        padding: 15px 5px 0.5em 0;
        font-family: sans-serif; 
        float: right;
    }
    
    #BreadCrumbs a {
        color:#09569d;
    }
    
    #BreadCrumbs a:visited, #BreadCrumbs a:link {
        text-decoration: none;
    }
    
    #BreadCrumbs a:hover, #BreadCrumbs a:active {
        text-decoration: underline;
    }
    
    #PageTitle {
        margin: 0 5px 0.5em 0;
        color: #F90000;
    }
    
    #PageContent{
        margin: 0 5px 0 20px;
    }
    
    .LeftBar_shown {
        width: 13em;
        float: left;
    }
    
    @media print {
        .LeftBar_shown {
            display: none;
        }
    }
    
    .LeftBar_hidden {
        display: none;
    }
    
    #Footer {
        padding-top: 10px;
        padding-left: 10px;
        margin-right: 10px;       
    }
    
    .footertext {
        font-size: 10px;
        font-family: sans-serif; 
        margin-top: 1px;
    }

    .NavBit  {
        padding: 15px 5px 0.5em 0;
        font-family: sans-serif; 
    }
    
    @media print {
        .NavBit {
            display: none;
        }
    }
    
    #TagNotes {
        text-align: right;        
    }
    
    @media print {
        #TagNotes a:visited, #TagNotes a:link {
            color: #35556B;
            text-decoration: none;
        }
    }
    
    #Contents a, .NavBit a, #TagNotes a {
        color:#09569d;
    }
    
    #TagNotes a:visited, #TagNotes a:link,
    #Contents a:visited, #Contents a:link,
    .NavBit a:visited, .NavBit a:link {
        text-decoration: none;
    }
    
    #TagNotes a:hover, #TagNotes a:active,   
    #Contents a:hover, #Contents a:active,   
    .NavBit a:hover, .NavBit a:active {  
        text-decoration: underline;
    }
    
    #Contents {
        float: left;
        font-family: sans-serif; 
    }
    @media print {
        #Contents {
            display: none;
        }
    }
    @media screen {
        div.PrintHeaders {
            display: none;
        }
    }
    .linkLESSON, .nolinkLESSON {
        margin-left: 0.5em;
        text-indent: -0.5em;
    }
    .linkAHEAD, .nolinkAHEAD, .linkQUESTIONS, .nolinkQUESTIONS   {
        margin-left: 1.5em; 
        text-indent: -0.5em
    }
    .linkBHEAD, .nolinkBHEAD   {
        margin-left: 2.5em;
        text-indent: -0.5em
    }
    .linkCHEAD, .nolinkCHEAD   {
        margin-left: 3.5em;
        text-indent: -0.5em
    }
    .nolinkLESSON, .nolinkAHEAD, .nolinkBHEAD, .nolinkCHEAD,
    .nolinkQUESTIONS {
        font-weight: bold;
        color: #333;
		
		
    }
    .MainFlow_indented {
        margin-right: 10px;
        margin-left: 15em;
        margin-bottom: 2em;

    }
    .MainFlow_wide {
	
        margin-right: 10px;
        margin-left: 10px;
        margin-bottom: 2em;

    }
    @media print {
        .MainFlow_indented, .MainFlow_wide {
            padding-top: 0;
            margin-top: 10px;
            margin-right: 10px;
            margin-left: 0;
        }
    }
    h1, h2, h3, h4, h5 {
        color: #333;
        
    }

    h1 {
        font-weight: bold;
        font-size: 20px;
    }

    h2 {
        font-weight: bold;
        font-size: 17px;
    }

    h3 {
        font-weight: bold;
        font-size: 14px;
    }

    h4 {
        font-size: 15px;
    }

    h5 {
        font-size: 12px;
    }


    #ToggleLeft {
        display: none;
    }
    
    .note {
        margin: 0 30px 0px 30px;
    }
    
    .codeblock {
        margin: 0 30px 0px 30px;
		font-size:12px;
		font-family:Monaco,Courier,"Courier New";
    }
    
    .tocli {
        list-style-type:none;
    }

    .betadraft {
        color: red;
    }

</style>
<script type="text/javascript">
/* <![CDATA[ */
    function leftBar() {
        var nameq = 'tutorial_showLeftBar='
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookieString = cookies[i];
            while (cookieString.charAt(0) == ' ') {
                cookieString = cookieString.substring(1, cookieString.length);
            }
            if (cookieString.indexOf(nameq) == 0) {
                cookieValue =  cookieString.substring(nameq.length,
                        cookieString.length);
                return cookieValue == 'yes';
            }
        }
        return true;
    }

    function showLeft(b) {
        var contents = document.getElementById("LeftBar");
        var main = document.getElementById("MainFlow");
        var toggle = document.getElementById("ToggleLeft");
        if (b) {
            contents.className = "LeftBar_shown";
            main.className = "MainFlow_indented";
            toggle.innerHTML = "Hide TOC";
            document.cookie = 'tutorial_showLeftBar=yes; path=/';
        } else {
            contents.className = "LeftBar_hidden";
            main.className = "MainFlow_wide";
            toggle.innerHTML = "Show the TOC";
            document.cookie = 'tutorial_showLeftBar=no; path=/';
        }
    }

    function toggleLeft() {
        showLeft(document.getElementById("LeftBar").className ==
                "LeftBar_hidden");
        document.getElementById("ToggleLeft").blur();
    }

    function load() {
        showLeft(leftBar());
        document.getElementById("ToggleLeft").style.display="inline";
    }

    function showCode(displayCodePage, codePath) {
        var codePathEls = codePath.split("/");
        var currDocPathEls = location.href.split("/");
        //alert ("codePathEls = " + codePathEls + "\n" + "currDocPathEls = " + currDocPathEls);
        currDocPathEls.pop(); // remove file name at the end
        while (codePathEls.length > 0) {
            if (codePathEls[0] == "..") {
                codePathEls.shift();
                currDocPathEls.pop();
            } else {
                break;
            }
        }
        var fullCodePath = currDocPathEls.join("/") + "/" + codePathEls.join("/");
        //alert ("fullCodePath = " + fullCodePath );
        if (codePath.indexOf(".java") != -1 || codePath.indexOf(".jnlp") != -1) {
            window.location.href = displayCodePage + "?code=" + encodeURI(fullCodePath);
        } else {
            window.location.href = fullCodePath;
        }
    }
/* ]]> */    
</script>


    <script>window.ohcglobal || document.write('<script src="/en/dcommon/js/global.js">\x3C/script>')</script>

    <noscript>要使此页面正常运行，需要启用JavaScript的浏览器。
    </noscript>
        <!-- header -->
    <div class="header-container">
        <div class="bookwrapper  clearfix">       
            <div id="brandProdName">
                <div id="logocover"></div>
                <div id="productName">文献资料</div>
            </div> 
            <br class="clearfloat">
        </div>
    </div>
    
    <div id="TopBar">
        <div id="TopBar_tr">
            <div id="TopBar_tl">
                <div id="TopBar_br"> <div id="TopBar_bl"> 
                    <div id="TopBar_left">Java™教程</div>
                        <div id="TopBar_right"> 
                            <!--
                            <a href="URL" target="_blank">External Link</a><br/>
                            --> <a href="javascript:void(0);" id="ToggleLeft">隐藏目录</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="LeftBar" class="LeftBar_shown">
        <div id="Contents">
            <div class="linkLESSON"><a href="index.html">JDBC基础</a></div>
<div class="linkAHEAD"><a href="gettingstarted.html">入门</a></div>
<div class="linkAHEAD"><a href="processingsqlstatements.html">使用JDBC处理SQL语句</a></div>
<div class="linkAHEAD"><a href="connecting.html">建立连接</a></div>
<div class="linkAHEAD"><a href="sqldatasources.html">连接数据源对象</a></div>
<div class="linkAHEAD"><a href="sqlexception.html">处理SQLException</a></div>
<div class="linkAHEAD"><a href="tables.html">设置表格</a></div>
<div class="linkAHEAD"><a href="retrieving.html">从结果集中检索和修改值</a></div>
<div class="linkAHEAD"><a href="prepared.html">使用准备好的语句</a></div>
<div class="nolinkAHEAD">使用交易</div>
<div class="linkAHEAD"><a href="rowset.html">使用行集对象</a></div>
<div class="linkAHEAD"><a href="jdbcrowset.html">使用JdbcRowSet对象</a></div>
<div class="linkAHEAD"><a href="cachedrowset.html">使用CachedRowSetObjects</a></div>
<div class="linkAHEAD"><a href="joinrowset.html">使用JoinRowSet对象</a></div>
<div class="linkAHEAD"><a href="filteredrowset.html">使用FilteredRowSet对象</a></div>
<div class="linkAHEAD"><a href="webrowset.html">使用WebRowSet对象</a></div>
<div class="linkAHEAD"><a href="sqltypes.html">使用高级数据类型</a></div>
<div class="linkAHEAD"><a href="blob.html">使用大对象</a></div>
<div class="linkAHEAD"><a href="sqlxml.html">使用SQLXML对象</a></div>
<div class="linkAHEAD"><a href="array.html">使用数组对象</a></div>
<div class="linkAHEAD"><a href="distinct.html">使用DISTINCT数据类型</a></div>
<div class="linkAHEAD"><a href="sqlstructured.html">使用结构化对象</a></div>
<div class="linkAHEAD"><a href="sqlcustommapping.html">使用自定义类型映射</a></div>
<div class="linkAHEAD"><a href="sqldatalink.html">使用数据链接对象</a></div>
<div class="linkAHEAD"><a href="sqlrowid.html">使用RowId对象</a></div>
<div class="linkAHEAD"><a href="storedprocedures.html">使用存储过程</a></div>
<div class="linkAHEAD"><a href="jdbcswing.html">结合使用JDBC和GUI API</a></div>
</div>
    </div>
    <div id="MainFlow" class="MainFlow_indented">
    <div class="PrintHeaders">
        <b>Trail：</b> JDBC（TM）数据库访问<br><b>课程：</b> JDBC基础</div>
            <div id="BreadCrumbs">
                <a href="../../index.html" target="_top">主页</a> > <a href="../index.html" target="_top">JDBC（TM）数据库访问</a> > <a href="index.html" target="_top">JDBC基础</a>
            </div>
            <div class="NavBit">
                <a href="prepared.html" target="_top">«上一个</a> • <a href="../TOC.html" target="_top">追踪</a> • <a href="rowset.html" target="_top">下一个»</a>
            </div>
            <div class="Banner"><p style="background-color:rgb(247,248,249);border-width:1px;padding:10px;font-style:italic;border-style:solid;border-color:rgb(64,74,91)">Java教程是为JDK 8编写的。此页面中描述的示例和实践没有利用更高版本中引入的改进。</p></div>
            <div id="PageTitle"><h1>使用交易</h1></div>
            <div id="PageContent">

<p>有时您不希望一个语句生效，除非另一个语句完成。例如，当“茶歇”的所有者更新每周出售的咖啡量时，所有者也将希望更新迄今为止的销售总量。但是，每周的销售量和总销售量应同时更新；否则，数据将不一致。确保两个动作都发生或者两个动作都没有发生的方法是使用事务。事务是作为一个单元执行的一组一个或多个语句的集合，因此要么执行所有语句，要么不执行任何语句。</p>
<p>本页面涵盖以下主题</p>
<ul>
<li><a href="#disable_auto_commit">禁用自动提交模式</a></li>
<li><a href="#commit_transactions">提交交易</a></li>
<li><a href="#transactions_data_integrity">使用事务来维护数据完整性</a></li>
<li><a href="#set_roll_back_savepoints">设置并回滚到保存点</a></li>
<li><a href="#release_savepoints">释放保存点</a></li>
<li><a href="#call_rollback">何时调用方法回滚</a></li>
</ul>
<!-- ************************************** -->
<h2><a name="disable_auto_commit" id="disable_auto_commit">禁用自动提交模式</a></h2>
<p>创建连接后，它处于自动提交模式。这意味着每个单独的SQL语句都被视为事务，并在执行后立即自动提交。（更确切地说，默认是在完成时而不是在执行时提交SQL语句。检索到其所有结果集和更新计数后，该语句即完成。但是，在几乎所有情况下，语句都是在执行后立即完成并因此提交的。）</p>
<p>允许将两个或多个语句组合到一个事务中的方法是禁用自动提交模式。下面的代码对此进行了演示，其中<code>con</code>是活动的连接：</p>
<div class="codeblock"><pre>
con.setAutoCommit(false);
</pre></div>
<!-- ************************************** -->
<h2><a name="commit_transactions" id="commit_transactions">提交交易</a></h2>
<p>禁用自动提交模式后，在调用该方法之前，不会提交任何SQL语句<code>commit</code>明确地。在上一次调用该方法之后执行的所有语句<code>commit</code>包含在当前事务中，并作为一个单元一起提交。以下方法， <code><a href="gettingstarted.html">CoffeesTable.updateCoffeeSales</a></code> ，其中<code>con</code>是活动连接，说明了一个事务：</p>
<div class="codeblock"><pre>
public void updateCoffeeSales(HashMap&lt;String, Integer> salesForWeek)
    throws SQLException {

    PreparedStatement updateSales = null;
    PreparedStatement updateTotal = null;

    String updateString =
        "update " + dbName + ".COFFEES " +
        "set SALES = ? where COF_NAME = ?";

    String updateStatement =
        "update " + dbName + ".COFFEES " +
        "set TOTAL = TOTAL + ? " +
        "where COF_NAME = ?";

    try {
        con.setAutoCommit(false);
        updateSales = con.prepareStatement(updateString);
        updateTotal = con.prepareStatement(updateStatement);

        for (Map.Entry&lt;String, Integer> e : salesForWeek.entrySet()) {
            updateSales.setInt(1, e.getValue().intValue());
            updateSales.setString(2, e.getKey());
            updateSales.executeUpdate();
            updateTotal.setInt(1, e.getValue().intValue());
            updateTotal.setString(2, e.getKey());
            updateTotal.executeUpdate();
            con.commit();
        }
    } catch (SQLException e ) {
        JDBCTutorialUtilities.printSQLException(e);
        if (con != null) {
            try {
                System.err.print("Transaction is being rolled back");
                con.rollback();
            } catch(SQLException excep) {
                JDBCTutorialUtilities.printSQLException(excep);
            }
        }
    } finally {
        if (updateSales != null) {
            updateSales.close();
        }
        if (updateTotal != null) {
            updateTotal.close();
        }
        con.setAutoCommit(true);
    }
}
</pre></div>
<p>在这种方法中，连接的自动提交模式被禁用<code>con</code> ，这意味着两个准备好的语句<code>updateSales</code>和<code>updateTotal</code>一起提交时的方法<code>commit</code>叫做。每当<code>commit</code>方法被调用（启用自动提交模式时自动启用或禁用时明确启用），使事务中的语句引起的所有更改都变为永久性。在这种情况下，这意味着<code>SALES</code>和<code>TOTAL</code>哥伦比亚咖啡的列已更改为<code>50</code> （如果<code>TOTAL</code>曾经<code>0</code>之前），并将保留此值，直到使用另一个更新语句对其进行更改为止。</p>
<p>该声明<code>con.setAutoCommit(true);</code>启用自动提交模式，这意味着每个语句在完成时都会再次自动提交。然后，您返回到默认状态，无需调用该方法<code>commit</code>你自己建议仅在事务处理模式期间禁用自动提交模式。这样，您可以避免为多个语句持有数据库锁，这会增加与其他用户发生冲突的可能性。</p>
<!-- ************************************** -->
<h2><a name="transactions_data_integrity" id="transactions_data_integrity">使用事务来维护数据完整性</a></h2>
<p>除了将语句分组在一起以作为一个单元执行之外，事务还可以帮助保持表中数据的完整性。例如，假设某个员工应该在表格中输入新的咖啡价格<code>COFFEES</code>但延迟了几天。同时，价格上涨，如今所有者正在进入更高价格的过程。员工最终在所有者尝试更新表格的同时四处输入现在过时的价格。插入过时的价格后，员工意识到它们不再有效，并致电<code>Connection</code>方法<code>rollback</code>以消除其影响。（方法<code>rollback</code>中止事务并将值恢复为尝试更新之前的值。）同时，所有者正在执行<code>SELECT</code>声明并打印新价格。在这种情况下，所有者可能会打印已经回滚到其先前值的价格，从而使打印的价格不正确。</p>
<p>可以通过使用事务来避免这种情况，事务提供了一定程度的保护，以防止两个用户同时访问数据时发生的冲突。</p>
<p>为了避免事务期间的冲突，DBMS使用锁，这是一种机制，用于阻止其他人对事务正在访问的数据的访问。（请注意，在自动提交模式下，其中每个语句都是一个事务，仅对一个语句持有锁。）设置锁定后，它将一直有效，直到提交或回滚该事务为止。例如，DBMS可以锁定表的一行，直到提交对它的更新为止。此锁定的作用是防止用户获取脏读，即在将值设为永久值之前读取该值。（访问尚未提交的更新值被视为<em>脏读，</em>因为该值有可能回滚到其先前的值。如果您读取了一个稍后回滚的值，那么您将读取一个无效的值。）</p>
<p>锁的设置方式取决于所谓的事务隔离级别，该级别可以从根本不支持事务到支持强制执行非常严格的访问规则的事务。</p>
<p>事务隔离级别的一个示例是<code>TRANSACTION_READ_COMMITTED</code> ，直到提交值之后才允许访问值。换句话说，如果事务隔离级别设置为<code>TRANSACTION_READ_COMMITTED</code> ，DBMS不允许进行脏读。介面<code>Connection</code>包括五个值，这些值代表您可以在JDBC中使用的事务隔离级别：</p>
<table border="1" summary="Transaction isolation levels">
<tbody><tr>
<th>隔离度</th>
<th>交易次数</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻影读</th>
</tr>
<tr>
<td><code>TRANSACTION_NONE</code></td>
<td>不支持</td>
<td><em>不适用</em></td>
<td><em>不适用</em></td>
<td><em>不适用</em></td>
</tr>
<tr>
<td><code>TRANSACTION_READ_COMMITTED</code></td>
<td>支持的</td>
<td>预防的</td>
<td>允许的</td>
<td>允许的</td>
</tr>
<tr>
<td><code>TRANSACTION_READ_UNCOMMITTED</code></td>
<td>支持的</td>
<td>允许的</td>
<td>允许的</td>
<td>允许的</td>
</tr>
<tr>
<td><code>TRANSACTION_REPEATABLE_READ</code></td>
<td>支持的</td>
<td>预防的</td>
<td>预防的</td>
<td>允许的</td>
</tr>
<tr>
<td><code>TRANSACTION_SERIALIZABLE</code></td>
<td>支持的</td>
<td>预防的</td>
<td>预防的</td>
<td>预防的</td>
</tr>
</tbody></table>
<p>当事务A检索行，事务B随后更新该行，事务A随后再次检索同一行时，将发生<em>不可重复的读取</em> 。事务A两次检索同一行，但看到不同的数据。</p>
<p>当事务A检索满足给定条件的一组行时发生<em>幻像读取</em> ，事务B随后插入或更新一行，以使该行现在满足事务A中的条件，而事务A以后重复条件检索。事务A现在会看到另一行。该行称为幻像。</p>
<p>通常，您不需要对事务隔离级别做任何事情。您可以只将默认的DBMS用作DBMS。默认事务隔离级别取决于您的DBMS。例如，对于Java DB，它是<code>TRANSACTION_READ_COMMITTED</code> 。JDBC允许您找出DBMS设置为什么事务隔离级别（使用<code>Connection</code>方法<code>getTransactionIsolation</code> ），还可以将其设置为其他级别（使用<code>Connection</code>方法<code>setTransactionIsolation</code> ）。</p>
<p><strong>注意</strong> ：JDBC驱动程序可能不支持所有事务隔离级别。如果驱动程序不支持在调用中指定的隔离级别<code>setTransactionIsolation</code> ，驱动程序可以替代更高，更严格的事务隔离级别。如果驱动程序无法替代更高的事务级别，则会抛出一个<code>SQLException</code> 。使用方法<code>DatabaseMetaData.supportsTransactionIsolationLevel</code>确定驱动程序是否支持给定级别。</p>
<!-- ************************************** -->
<h2><a name="set_roll_back_savepoints" id="set_roll_back_savepoints">设置并回滚到保存点</a></h2>
<p>方法<code>Connection.setSavepoint</code> ，设置一个<code>Savepoint</code>当前交易中的对象。的<code>Connection.rollback</code>方法被重载以采取<code>Savepoint</code>论点。</p>
<p>以下方法， <code><a href="gettingstarted.html">CoffeesTable.modifyPricesByPercentage</a></code> ，将特定咖啡的价格提高一定百分比， <code>priceModifier</code> 。但是，如果新价格大于指定价格， <code>maximumPrice</code> ，那么价格将恢复为原始价格：</p>
<div class="codeblock"><pre>
public void modifyPricesByPercentage(
    String coffeeName,
    float priceModifier,
    float maximumPrice)
    throws SQLException {
    
    con.setAutoCommit(false);

    Statement getPrice = null;
    Statement updatePrice = null;
    ResultSet rs = null;
    String query =
        "SELECT COF_NAME, PRICE FROM COFFEES " +
        "WHERE COF_NAME = '" + coffeeName + "'";

    try {
        Savepoint save1 = con.setSavepoint();
        getPrice = con.createStatement(
                       ResultSet.TYPE_SCROLL_INSENSITIVE,
                       ResultSet.CONCUR_READ_ONLY);
        updatePrice = con.createStatement();

        if (!getPrice.execute(query)) {
            System.out.println(
                "Could not find entry " +
                "for coffee named " +
                coffeeName);
        } else {
            rs = getPrice.getResultSet();
            rs.first();
            float oldPrice = rs.getFloat("PRICE");
            float newPrice = oldPrice + (oldPrice * priceModifier);
            System.out.println(
                "Old price of " + coffeeName +
                " is " + oldPrice);

            System.out.println(
                "New price of " + coffeeName +
                " is " + newPrice);

            System.out.println(
                "Performing update...");

            updatePrice.executeUpdate(
                "UPDATE COFFEES SET PRICE = " +
                newPrice +
                " WHERE COF_NAME = '" +
                coffeeName + "'");

            System.out.println(
                "\nCOFFEES table after " +
                "update:");

            CoffeesTable.viewTable(con);

            if (newPrice > maximumPrice) {
                System.out.println(
                    "\nThe new price, " +
                    newPrice +
                    ", is greater than the " +
                    "maximum price, " +
                    maximumPrice +
                    ". Rolling back the " +
                    "transaction...");

                con.rollback(save1);

                System.out.println(
                    "\nCOFFEES table " +
                    "after rollback:");

                CoffeesTable.viewTable(con);
            }
            con.commit();
        }
    } catch (SQLException e) {
        JDBCTutorialUtilities.printSQLException(e);
    } finally {
        if (getPrice != null) { getPrice.close(); }
        if (updatePrice != null) {
            updatePrice.close();
        }
        con.setAutoCommit(true);
    }
}
</pre></div>
<p>以下语句指定了<code>ResultSet</code>从产生的对象<code>getPrice</code>当查询关闭<code>commit</code>方法被调用。请注意，如果您的DBM不支持<code>ResultSet.CLOSE_CURSORS_AT_COMMIT</code> ，则此常量将被忽略：</p>
<div class="codeblock"><pre>
getPrice = con.prepareStatement(query, ResultSet.CLOSE_CURSORS_AT_COMMIT);
</pre></div>
<p>该方法首先创建一个<code>Savepoint</code>带有以下语句：</p>
<div class="codeblock"><pre>
Savepoint save1 = con.setSavepoint();
</pre></div>
<p>该方法检查新价格是否大于<code>maximumPrice</code>值。如果是这样，该方法将使用以下语句回滚事务：</p>
<div class="codeblock"><pre>
con.rollback(save1);
</pre></div>
<p>因此，当该方法通过调用<code>Connection.commit</code>方法，它将不提交与其关联的任何行<code>Savepoint</code>已回滚；它将提交所有其他更新的行。</p>
<!-- ************************************** -->
<h2><a name="release_savepoints" id="release_savepoints">释放保存点</a></h2>
<p>方法<code>Connection.releaseSavepoint</code>需要一个<code>Savepoint</code>对象作为参数并将其从当前事务中删除。</p>
<p>释放保存点后，尝试在回滚操作中引用它会导致<code>SQLException</code>被抛出。在提交事务或回滚整个事务时，将自动释放在事务中创建的所有保存点，并使其无效。将事务回滚到保存点会自动释放，并使在该保存点之后创建的其他任何保存点无效。</p>
<!-- ************************************** -->
<h2><a name="call_rollback" id="call_rollback">何时调用方法回滚</a></h2>
<p>如前所述，调用方法<code>rollback</code>终止事务并返回任何已修改为其先前值的值。如果您试图在一个事务中执行一个或多个语句并获得一个<code>SQLException</code> ，调用方法<code>rollback</code>结束交易并重新开始交易。这是知道已落实和未落实的唯一方法。赶上<code>SQLException</code>告诉您出了什么问题，但是并没有告诉您什么是或没有提交的。因为您不能指望没有任何承诺的事实，所以调用方法<code>rollback</code>是唯一可以确定的方法。</p>
<p>方法<code><a href="gettingstarted.html">CoffeesTable.updateCoffeeSales</a></code>演示交易并包括<code>catch</code>调用方法的块<code>rollback</code> 。如果应用程序继续运行并使用交易结果，则此调用将<code>rollback</code>中的方法<code>catch</code>阻止阻止使用可能不正确的数据。</p>


        </div>
        <div class="NavBit">
            <a href="prepared.html" target="_top">«上一个</a> • <a href="../TOC.html" target="_top">追踪</a> • <a href="rowset.html" target="_top">下一个»</a>
        </div>
    </div>
    
<hr class="clearfloat">

<div id="Footer">

<p class="footertext">
<a href="http://www.oracle.com/corporate/index.html">关于Oracle</a> | <a href="http://www.oracle.com/us/corporate/contact/index.html">联系我们</a> | <a href="http://www.oracle.com/us/legal/index.html">法律声明</a> | <a href="http://www.oracle.com/us/legal/terms/index.html">使用条款</a> | <a href="http://www.oracle.com/us/legal/privacy/index.html">您的隐私权</a></p>

<p class="footertext"><a href="http://www.oracle.com/pls/topic/lookup?ctx=cpyr&id=en-US">版权所有©1995、2017 Oracle和/或其分支机构。版权所有。</a></p>
       
</div>    
    <div class="PrintHeaders">
        <b>上一页：</b>使用准备好的语句<br><b>下一页：</b>使用行集对象</div>
<!-- Start SiteCatalyst code -->
<script type="application/javascript" src="https://www.oracleimg.com/us/assets/metrics/ora_docs.js"></script>
<!-- End SiteCatalyst code --> 

 
</body></html>