<html lang="en-us"  xml:lang="en-us"><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="abstract" content="">
      <meta name="description" content="">
      <title>第六部分：HTTP / SPNEGO身份验证</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="Security Developer’s Guide">
      <meta property="og:description" content="">
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="Security Developer’s Guide">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2">
      <link rel="alternate" href="security-developer-guide.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2018-09-21T08:42:26-07:00">
      
      <meta name="dcterms.dateCopyrighted" content="1993, 2018">
      <meta name="dcterms.category" content="java">
      <meta name="dcterms.identifier" content="E94828-01">
      
      <meta name="dcterms.product" content="en/java/javase/11">
      <meta name="dcterms.release" content="11">
      <link rel="prev" href="part-v-secure-authentication-using-spnego-java-gss-mechanism.html" title="Previous" type="text/html">
      <link rel="next" href="source-code-advanced-security-programming-java-se-authentication-secure-communication-and-single-sig.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"java","element_name":"Java","display_in_url":true},"suite":{"short_name":"not-applicable","element_name":"Not Applicable","display_in_url":false},"product_group":{"short_name":"not-applicable","element_name":"Not Applicable","display_in_url":false},"product":{"short_name":"javase","element_name":"Java SE","display_in_url":true},"release":{"short_name":"11","element_name":"11","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="Security Developer Guide">
    <meta name="dcterms.isVersionOf" content="SECURITY">
  <script>window.ohcglobal || document.write('<script src="/en/dcommon/js/global.js">\x3C/script>')</script></head>
   <body >
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="part-v-secure-authentication-using-spnego-java-gss-mechanism.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一个</a> <a href="source-code-advanced-security-programming-java-se-authentication-secure-communication-and-single-sig.html" class="pull-right">下一个<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">安全开发人员指南</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="java-generic-security-services-java-gss-api1.html" property="item" typeof="WebPage"><span property="name">Java通用安全服务（Java GSS-API）</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="advanced-security-programming-java-se-authentication-secure-communication-and-single-sign1.html" property="item" typeof="WebPage"><span property="name">Java SE身份验证，安全通信和单点登录中的高级安全性编程</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">第六部分：HTTP / SPNEGO身份验证</li>
            </ol>
            <a id="GUID-996F729E-5FEA-4E29-A32A-78FB510B2D80" name="GUID-996F729E-5FEA-4E29-A32A-78FB510B2D80"></a>
            
            <h2 id="JSSEC-GUID-996F729E-5FEA-4E29-A32A-78FB510B2D80" class="sect2">第六部分：HTTP / SPNEGO身份验证</h2>
         </header>
         <div class="ind">
            <div>
               <p></p>
            </div>
            <div class="sect2"><a id="GUID-2978DB58-6217-4E29-95EF-2C1F25F7C37F" name="GUID-2978DB58-6217-4E29-95EF-2C1F25F7C37F"></a><h3 id="JSSEC-GUID-2978DB58-6217-4E29-95EF-2C1F25F7C37F" class="sect3">练习9：使用HTTP / SPNEGO身份验证</h3>
               <div>
                  <p></p>
               </div>
               <div class="sect3"><a id="GUID-89457AC9-89FE-4934-A6F3-B03D72D95AA7" name="GUID-89457AC9-89FE-4934-A6F3-B03D72D95AA7"></a><h4 id="JSSEC-GUID-89457AC9-89FE-4934-A6F3-B03D72D95AA7" class="sect4">什么是HTTP SPNEGO</h4>
                  <div>
                     <p></p>
                     <p>HTTP SPNEGO在HTTP通信中支持协商身份验证方案。SPNEGO支持身份验证类型：</p>
                     <div class="section">
                        <p class="subhead3" id="GUID-89457AC9-89FE-4934-A6F3-B03D72D95AA7__GUID-0F7894F6-6711-4DA0-8A0F-A6F31F0E4578">网络认证</p>
                        <p>Web服务器响应</p>
                     </div>
                     <!-- class="section" --><pre class="pre codeblock"><code>HTTP/1.1 401 Unauthorized
WWW-Authenticate: Negotiate</code></pre><p>客户端将需要发送标题</p><pre class="pre codeblock"><code>Authorization: Negotiate YY.....</code></pre><p>向服务器验证自己的身份</p>
                     <div class="section">
                        <p class="subhead3" id="GUID-89457AC9-89FE-4934-A6F3-B03D72D95AA7__GUID-17197326-9AA4-4D89-8082-C3C71B2F9E4A">代理验证</p>
                        <p>Web服务器的响应</p>
                     </div>
                     <!-- class="section" --><pre class="pre codeblock"><code>HTTP/1.1 407 Proxy Authentication Required
Proxy-Authenticate: Negotiate</code></pre><p>客户端将需要发送标题</p><pre class="pre codeblock"><code>Proxy-Authorization: Negotiate YY.....</code></pre><p>向代理服务器进行身份验证。</p>
                     <p>此功能支持两种身份验证。</p>
                  </div>
               </div>
               <div class="sect3"><a id="GUID-1101592C-854C-4CB2-B46C-CE3EE8652FB0" name="GUID-1101592C-854C-4CB2-B46C-CE3EE8652FB0"></a><h4 id="JSSEC-GUID-1101592C-854C-4CB2-B46C-CE3EE8652FB0" class="sect4">如何使用HTTP / SPNEGO身份验证</h4>
                  <div>
                     <p></p>
                     <p>新功能不涉及新的公共API功能，但需要几种配置才能成功进行通信：</p>
                     <div class="section">
                        <p class="subhead3" id="GUID-1101592C-854C-4CB2-B46C-CE3EE8652FB0__GUID-2FFAE967-D924-447B-9E8E-C2C01FFD9263">Kerberos 5配置</p>
                        <p>由于SPNEGO机制将调用JGSS，而后者又将调用Kerberos V5登录模块来完成实际工作。需要Kerberos 5配置。这包括以下内容：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>提供Kerberos配置的某种方式。这可以通过Java系统属性来实现<code class="codeph">java.security.krb5.conf</code> 。例如：</p><pre class="pre codeblock"><code>java -Djava.security.krb5.conf=krb5.conf \
     -Djavax.security.auth.useSubjectCredsOnly=false \
     ClassName</code></pre><p>一个JAAS配置文件，指示要使用的登录模块。HTTP SPNEGO代码将查找名为<code class="codeph">com.sun.security.jgss.krb5.initiate</code> 。
                              </p>
                              <p>例如，您可以提供一个文件<code class="codeph">spnegoLogin.conf</code> ：</p><pre class="pre codeblock"><code>com.sun.security.jgss.krb5.initiate {
    com.sun.security.auth.module.Krb5LoginModule
        required useTicketCache=true;
};</code></pre><p>并使用以下命令运行java：</p><pre class="pre codeblock"><code>java -Djava.security.krb5.conf=krb5.conf \
     -Djava.security.auth.login.config=spnegoLogin.conf \
     -Djavax.security.auth.useSubjectCredsOnly=false \
     ClassName</code></pre></li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-1101592C-854C-4CB2-B46C-CE3EE8652FB0__GUID-F55F1914-BD4B-42C7-AFFB-9064872FBB30">用户名和密码找回</p>
                        <p>就像任何其他HTTP身份验证方案一样，客户端可以提供自定义的<span class="apiname">java.net。身份验证</span>器， <span class="bold">如果</span>需要，可将用户名和密码提供给HTTP SPNEGO模块（即，没有凭据缓存可用）。身份验证器中唯一需要检查的<span class="apiname">身份验证信息</span>是可以使用<span class="apiname">getRequestingScheme（）</span>检索的方案。该值应为“协商”。
                        </p>
                        <p>这意味着您的<span class="apiname">Authenticator</span>实现将如下所示：</p><pre class="pre codeblock"><code>class MyAuthenticator extends Authenticator {

        public PasswordAuthentication getPasswordAuthentication () {
            if (getRequestingScheme().equalsIgnoreCase("negotiate")) {
                String krb5user;
                char[] krb5pass;
                // get krb5user and krb5pass in your own way
                ....
                return (new PasswordAuthentication (krb5user,
                            krb5pass));
            } else {
                ....
            }
        }
    }</code></pre><div class="infoboxnote" id="GUID-1101592C-854C-4CB2-B46C-CE3EE8652FB0__GUID-EE01F3DE-A2B0-4137-8EBD-EADFE95AB71E">
                           <p class="notep1">注意：</p>根据<span class="apiname">java.net的规范<span class="apiname">。Authenticator</span> ，旨在同时获取用户名和密码，因此请勿指定<code class="codeph">principal=<span class="variable" translate="no">xxx</span></code>在JAAS配置文件中。
                        </span></div>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-1101592C-854C-4CB2-B46C-CE3EE8652FB0__GUID-6CAB2466-6336-4739-84E4-2988B64A58EB">方案偏好</p>
                        <p>客户端仍然可以提供系统属性<span class="apiname">http.auth.preference，</span>以表示只要服务器请求，就应始终使用某种方案。您可以将“ SPNEGO”或“ Kerberos”用于此系统属性。 “ SPNEGO”表示您希望使用GSS / SPNEGO机制来响应协商方案； “ Kerberos”表示您希望使用GSS / Kerberos机制来响应协商方案。通常，在针对Microsoft产品进行身份验证时，您可以使用“ SPNEGO”。值“ Kerberos”也适用于Microsoft服务器。仅当您遇到知道协商但不了解SPNEGO的服务器时才需要它。</p>
                        <p>如果<code class="codeph">http.auth.preference</code>未设置，选择的内部顺序为：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>GSS / SPNEGO->摘要-> NTLM->基本</p>
                           </li>
                        </ul>
                        <p>请注意，Kerberos没有出现在此列表中，因为只要支持“协商”，就始终选择GSS / SPNEGO。</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-1101592C-854C-4CB2-B46C-CE3EE8652FB0__GUID-31F7A408-AB62-4452-AC04-043AC7F56006">倒退</p>
                        <p>如果服务器提供了多个身份验证方案（包括Negotiate），则根据上一节中提到的处理顺序，Java将尝试挑战Negotiate方案。但是，如果无法成功建立协议（例如，Kerberos配置不正确，或者服务器的主机名未记录在KDC主体DB中，或者<span class="apiname">Authenticator</span>提供的用户名和密码错误），则第二强方案将被自动使用。
                        </p>
                        <div class="infoboxnote" id="GUID-1101592C-854C-4CB2-B46C-CE3EE8652FB0__GUID-2FE4CFC7-2814-49D2-AE82-53932203725E">
                           <p class="notep1">注意：</p>
                           <p>如果<code class="codeph">http.auth.preference</code>设置为SPNEGO或Kerberos，则SPNEGO假定即使失败，您也只想尝试协商方案。SPNEGO不会回退到任何其他方案，并且您的程序将抛出<span class="apiname">IOException，</span>表示它从HTTP响应接收到401或407错误。
                           </p>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
               <div class="sect3"><a id="GUID-05B34286-D0B6-4C35-B0BF-C98CD9F7E1D2" name="GUID-05B34286-D0B6-4C35-B0BF-C98CD9F7E1D2"></a><h4 id="JSSEC-GUID-05B34286-D0B6-4C35-B0BF-C98CD9F7E1D2" class="sect4">HTTP / SPNEGO身份验证示例</h4>
                  <div>
                     <p></p>
                     <p>假设您有一个IIS服务器在Active Directory中的Windows服务器上运行。该服务器上的网页配置为受“集成Windows身份验证”保护。这意味着服务器将提示您进行协商和NTLM身份验证。</p>
                     <p>您需要准备以下文件以获得受保护的文件：</p>
                     <div class="section">
                        <p class="subhead3" id="GUID-05B34286-D0B6-4C35-B0BF-C98CD9F7E1D2__GUID-1F8A969B-335B-404A-A027-8437A965AB72">运行HttpSpnego.java</p><pre class="pre codeblock"><code>import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.Authenticator;
import java.net.PasswordAuthentication;
import java.net.URL;

public class RunHttpSpnego {

    static final String kuser = "username"; // your account name
    static final String kpass = "password"; // your password for the account

    static class MyAuthenticator extends Authenticator {
        public PasswordAuthentication getPasswordAuthentication() {
            // I haven't checked getRequestingScheme() here, since for NTLM
            // and Negotiate, the usrname and password are all the same.
            System.err.println("Feeding username and password for " + getRequestingScheme());
            return (new PasswordAuthentication(kuser, kpass.toCharArray()));
        }
    }

    public static void main(String[] args) throws Exception {
        Authenticator.setDefault(new MyAuthenticator());
        URL url = new URL(args[0]);
        InputStream ins = url.openConnection().getInputStream();
        BufferedReader reader = new BufferedReader(new InputStreamReader(ins));
        String str;
        while((str = reader.readLine()) != null)
            System.out.println(str);
    }
}</code></pre></div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-05B34286-D0B6-4C35-B0BF-C98CD9F7E1D2__GUID-A565728D-01B8-4DC6-B6E8-86046880DE7E">krb.conf</p><pre class="pre codeblock"><code>[libdefaults]
    default_realm = AD.LOCAL
[realms]
    AD.LOCAL = {
        kdc = kdc.ad.local
    }</code></pre></div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-05B34286-D0B6-4C35-B0BF-C98CD9F7E1D2__GUID-57D089C9-20F3-4718-900B-C795FDCF27EE">login.conf</p><pre class="pre codeblock"><code>com.sun.security.jgss.krb5.initiate {
  com.sun.security.auth.module.Krb5LoginModule required  doNotPrompt=false useTicketCache=true;
};</code></pre></div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-05B34286-D0B6-4C35-B0BF-C98CD9F7E1D2__GUID-056677D8-6CC0-4390-9EAB-66667CDFA246">编译并运行示例</p>
                        <ol>
                           <li>
                              <p>编译<code>RunHttpSpnego.java</code> 。
                              </p>
                           </li>
                           <li>
                              <p>跑<code>RunHttpSpnego.java</code> ：</p><pre class="pre codeblock"><code>java -Djava.security.krb5.conf=krb5.conf \
    -Djava.security.auth.login.config=login.conf \
    -Djavax.security.auth.useSubjectCredsOnly=false \
    RunHttpSpnego \
    http://www.ad.local/hello/hello.html</code></pre><p>您将看到以下内容：</p><pre class="pre codeblock"><code>Feeding username and password for Negotiate 
&lt;h1&gt;Hello, You got me!&lt;/h1&gt;</code></pre><p>实际上，如果您以域用户身份在Windows机器上运行，或者您已经在Linux或Solaris机器上运行，该机器已经发出了kinit命令并获得了凭据缓存。班级<code class="codeph">MyAuthenticator</code>将被完全忽略，并且输出将简单地是：</p><pre class="pre codeblock"><code>&lt;h1&gt;Hello, You got me!&lt;/h1&gt;</code></pre><p>表示未查询用户名和密码。这就是所谓的单点登录。</p>
                              <p>此外，您可以运行</p><pre class="pre codeblock"><code>java RunHttpSpnego http://www.ad.local/hello/hello.html</code></pre><p>看看回退是如何完成的，在这种情况下，您将看到</p><pre class="pre codeblock"><code>Feeding username and password for ntlm
&lt;h1&gt;Hello, You got me!&lt;/h1&gt;</code></pre></li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div>
         </div>
      </article>
   

</body></html>