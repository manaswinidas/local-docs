<html  xmlns="http://www.w3.org/1999/xhtml"><head>
    <meta http-equiv="content-type" content="text/html; charset=iso-8859-1">

    <link rel="stylesheet" type="text/css" href="../css/common.css">
    <link rel="stylesheet" type="text/css" href="../css/screen.css" media="screen">
    <link rel="stylesheet" type="text/css" href="../css/_print.css" media="print">
    <link rel="stylesheet" type="text/css" href="../css/prettify.css" media="screen">

    <title>第10章：JMX配置</title>
  </head>
  <body  onload="prettyPrint(); decorate();">
    <script type="text/javascript">prefix='../';</script>
    <script type="text/javascript" src="../js/prettify.js"></script>
    <script type="text/javascript" src="../templates/header.js"></script>
    <script type="text/javascript" src="../js/jquery-min.js"></script>
    <script type="text/javascript" src="../js/decorator.js"></script>
    
    <div id="left">
      <noscript>请打开Javascript查看此菜单</noscript>
      <script src="../templates/left.js" type="text/javascript"></script>
    </div>
    <div id="right">
      <script src="menu.js" type="text/javascript"></script>
    </div>
    <div id="content">
	
    <h1>第10章：JMX Configurator</h1>

    <a href="jmxConfig_ja.html">和訳（日语翻译）</a>
    
		<p>顾名思义， <code>JMXConfigurator</code>允许通过JMX配置回发。简而言之，它使您可以从默认配置文件，指定文件或URL重新配置登录，列出记录器并修改记录器级别。
		</p>
		
		<h3>使用JMX Configurator</h3>
    
    
		<p>如果您的服务器在JDK 1.6或更高版本上运行，则只需调用<code>jconsole</code>命令行中的应用程序，然后连接到服务器的MBeanServer。如果运行的是较早的JVM，则应阅读有关<a href="#jmxEnablingServer">启用服务器的JMX</a>的部分。
    </p>

    <p><code>JMXConfigurator</code>通过您的登录配置文件中的一行启用，如下所示：</p>

    <pre class="prettyprint source">&lt;configuration>
  <b>&lt;jmxConfigurator /></b>
  
  &lt;appender name="console" class="ch.qos.logback.core.ConsoleAppender">
    &lt;layout class="ch.qos.logback.classic.PatternLayout">
      &lt;Pattern>%date [%thread] %-5level %logger{25} - %msg%n&lt;/Pattern>
    &lt;/layout>
  &lt;/appender>

  &lt;root level="debug">
    &lt;appender-ref ref="console" />
  &lt;/root>  
&lt;/configuration></pre>
		
    <p>使用<em>jconsole</em>连接到服务器后，在MBeans面板上的“ ch.qos.logback.classic.jmx”下。Configurator”文件夹中，您应该看到几个操作可供选择，如下图所示：</p>
    
    <h3 class="doAnchor" name="jmxConfigurator">屏幕截图<code>JMXConfigurator</code>看过<code>jconsole</code></h3>

    <img src="images/chapters/jmxConfigurator/jmxConfigurator.gif" alt="jmxConfigurator">   

		<p>因此，您可以</p>
		
		<ul>
      <li>使用默认配置文件重新加载回发配置。</li>

      <li>使用指定的URL重新加载配置。</li>
      <li>用指定的文件重新加载配置。</li>

			<li>设置指定记录器的级别。要设置为null，请将字符串“ null”作为值传递。</li>
      <li>获取指定记录器的级别。返回的值可以为null。</li>
			<li>获取指定记录器的<a href="architecture.html#effectiveLevel">有效级别</a> 。</li>
		</ul>
		
    <p><code>JMXConfigurator</code>将现有记录器的列表和状态列表公开为属性。</p>
    
    <p>状态列表可以帮助您诊断回发的内部状态。</p>

    <img src="images/chapters/jmxConfigurator/statusList.gif" alt="statusList.gif">   

    <h3 class="doAnchor" name="leak">避免内存泄漏</h3>

    <p>如果您的应用程序部署在Web服务器或应用程序服务器中，则注册<code>JMXConfigurator</code>实例从系统类加载器创建对您的应用程序的引用，这将防止在停止或重新部署该引用时对其进行垃圾回收，从而导致严重的内存泄漏。</p>

    <p>因此，除非您的应用程序是独立的Java应用程序，否则您必须取消注册<code>JMXConfigurator</code> JVM的Mbeans服务器中的实例。调用<code>reset</code> （）适当的方法<code>LoggerContext</code>将自动注销任何JMXConfigurator实例。重置记录器上下文的一个好地方是<code>contextDestroyed</code> （）方法<code>javax.servlet.ServletContextListener</code> 。这是示例代码：</p>

    <pre class="prettyprint source">import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;

import org.slf4j.LoggerFactory;
import ch.qos.logback.classic.LoggerContext;

public class MyContextListener implements ServletContextListener {

  public void contextDestroyed(ServletContextEvent sce) {
    <b>LoggerContext lc = (LoggerContext) LoggerFactory.getILoggerFactory();</b>
    <b>lc.stop();</b>
  }

  public void contextInitialized(ServletContextEvent sce) {
  }
} </pre>


    <!-- ============ Multiple web-applications  ================== -->

    
    <h2 class="doAnchor" name="multiple"><code>JMXConfigurator</code>具有多个Web应用程序</h2>

    <p>如果您在同一服务器上部署多个Web应用程序，并且尚未覆盖默认的<a href="contextSelector.html">上下文选择器</a> ，并且已将<em>logback-*。jar</em>和<em>slf4j-api.jar</em>的副本放在<em>WEB-INF / lib</em>文件夹下每个Web应用程序，然后默认情况下每个<code>JMXConfigurator</code>实例将以相同名称注册，即“ ch.qos.logback.classic：Name = default，Type = ch.qos.logback.classic.jmx”。JMXConfigurator”。换句话说，默认情况下<code>JMXConfigurator</code>与每个Web应用程序中的记录器上下文相关联的实例将发生冲突。
    </p>
    
    <p>为避免此类意外冲突，您只需<a href="configuration.html#contextName">设置应用程序的日志上下文的名称，</a>然后<code>JMXConfigurator</code>将自动使用您设置的名称。
    </p>

    <p>例如，如果您部署两个名为“ Koala”和“ Wombat”的Web应用程序，那么您将使用Koala的logback配置进行编写</p>
    
    <pre class="prettyprint source">&lt;configuration>
  <b>&lt;contextName>Koala&lt;/contextName></b>
  &lt;jmxConfigurator/>
  ...
&lt;configuration></pre>

    <p>在Wombat logback配置文件中，您将编写：</p>

    <pre class="prettyprint source">&lt;configuration>
  <b>&lt;contextName>Wombat&lt;/contextName></b>x
  &lt;jmxConfigurator/>
  ...
&lt;configuration></pre>

    <p>在jconsole的MBeans面板中，您将看到两个不同的<code>JMXConfigurator</code>实例：</p>

    <img src="images/chapters/jmxConfigurator/multiple.gif" alt="multiple.gif">   

    <p>您可以借助MBeans服务器的“ objectName”属性完全控制JMXConfigurator在MBeans服务器上注册的名称。 <code><jmxConfigurator></code>元件。</p>
    
    <!-- ============ JMX enabling your  server ================== -->

    <h3 class="doAnchor" name="jmxEnablingServer">JMX启用服务器</h3>

    <p>如果您的服务器运行JDK 1.6或更高版本，则默认情况下应启用JMX。</p>

		<p>对于较早的JVM，建议您参考Web服务器的JMX相关文档。<a href="http://tomcat.apache.org/tomcat-6.0-doc/monitoring.html">Tomcat</a>和<a href="http://docs.codehaus.org/display/JETTY/JMX">Jetty</a>均可使用此类文档。在本文档中，我们简要描述了Tomcat和Jetty所需的配置步骤。
		</p>

    <!-- ================ Configuring Jetty ================== -->

		<h4>在Jetty中启用JMX（在JDK 1.5和JDK 1.6下测试）</h4>
		
		<p>以下已在JDK 1.5和1.6下进行了测试。在JDK 1.6及更高版本中，默认情况下，服务器启用了JMX，您可以但不必执行以下步骤。在JDK 1.5下，在Jetty中添加JMX支持需要在<em>$ JETTY_HOME / etc / jetty.xml</em>配置文件中添加许多内容。以下是需要添加的元素：</p>

    <pre class="prettyprint source">&lt;Call id="MBeanServer" class="java.lang.management.ManagementFactory" 
      name="getPlatformMBeanServer"/>

&lt;Get id="Container" name="container">
  &lt;Call name="addEventListener">
    &lt;Arg>
      &lt;New class="org.mortbay.management.MBeanContainer">
        &lt;Arg>&lt;Ref id="MBeanServer"/>&lt;/Arg>
        &lt;Call name="start" />
      &lt;/New>
    &lt;/Arg>
  &lt;/Call>
&lt;/Get> </pre>

    <p>如果您希望通过以下方式访问Jetty公开的MBean： <code>jconsole</code>应用程序，则需要在设置“ com.sun.management.jmxremote” Java系统属性后启动Jetty。
    </p>

    <p>对于Jetty的独立版本，它转换为：</p>

    
    <p class="source">java <b>-Dcom.sun.management.jmxremote</b> -jar start.jar [配置文件]</p>

    <p>并且，如果您希望将Jetty作为Maven插件启动，则需要通过以下方式设置“ com.sun.management.jmxremote”系统属性<code>MAVEN_OPTS</code>外壳变量：</p>

    <p class="source"><b>MAVEN_OPTS =“-Dcom.sun.management.jmxremote</b> ” mvn jetty：run</p>

    <p>然后，您可以访问Jetty公开的MBean以及登录的<code>JMXConfigurator</code>通过<code>jconsole</code> 。</p>

    <img src="images/chapters/jmxConfigurator/jconsole15_jetty.gif" alt="jconsole15_jetty.gif">   

    <p>连接后，您应该可以访问<code>JMXXConfigurator</code>如上面的<a href="#jmxConfigurator">屏幕截图</a>所示。</p>

    <h4>带有Jetty的MX4J（在JDK 1.5和1.6下测试）</h4>

    <p>如果您想访问<code>JMXConfigurator</code>通过MX4J的HTTP接口并假设您已经下载了<a href="http://mx4j.sourceforge.net/">MX4J</a> ，则需要通过添加设置管理端口的指令来修改前面讨论的Jetty配置文件。
    </p>
    
    <pre class="prettyprint source">&lt;Call id="MBeanServer"
    class="java.lang.management.ManagementFactory"
    name="getPlatformMBeanServer"/>

&lt;Get id="Container" name="container">
  &lt;Call name="addEventListener">
    &lt;Arg>
      &lt;New class="org.mortbay.management.MBeanContainer">
        &lt;Arg>&lt;Ref id="MBeanServer"/>&lt;/Arg>
        <b>&lt;Set name="managementPort">8082&lt;/Set></b>
        &lt;Call name="start" />
      &lt;/New>
    &lt;/Arg>
  &lt;/Call>
&lt;/Get> 
    </pre>
    
    <p>此外，需要将<em>mx4j-tools.jar</em>添加到Jetty的类路径中。
    </p>

    <p>如果将Jetty作为Maven插件运行，则需要添加<em>mx4j-tools</em>作为依赖项。</p>

    <pre class="prettyprint source">&lt;plugin>
  &lt;groupId>org.mortbay.jetty&lt;/groupId>
  &lt;artifactId>maven-jetty-plugin&lt;/artifactId>
  &lt;configuration>
    &lt;jettyConfig>path/to/jetty.xml&lt;/jettyConfig>
    ...
  &lt;/configuration>
  <b>&lt;dependencies>
    &lt;dependency>
      &lt;groupId>mx4j&lt;/groupId>
      &lt;artifactId>mx4j-tools&lt;/artifactId>
      &lt;version>3.0.1&lt;/version>
    &lt;/dependency>
  &lt;/dependencies></b>
&lt;/plugin></pre>

		<p>使用以上配置启动Jetty后， <code>JMXConfigurator</code>将在以下URL上可用（搜索“ ch.qos.logback.classic”）：</p>

    <p class="source"><a href="http://localhost:8082/">http：// localhost：8082 /</a></p>

    <p>下面是MX4J界面的屏幕截图。</p>

    <img src="images/chapters/jmxConfigurator/mx4j_jetty.gif" alt="mx4j_jetty.gif">   


    <!-- ================ Tomcat ================== -->
		
		<h4>为Tomcat配置JMX（在JDK 1.5和1.6下测试）</h4>
    
    <p>如果您使用的是JDK 1.6及更高版本，则默认情况下您的服务器已启用JMX，您可以但不必遵循以下步骤。在JDK 1.5下，Tomcat需要在<em>$ TOMCAT_HOME / bin / catalina.bat / sh</em> Shell脚本中添加以下几行：</p>
		
    <p class="source">CATALINA_OPTS =“-Dcom.sun.management.jmxremote”</p>

		<p>使用这些选项启动后，Tomcat公开的MBean以及注销的<code>JMXConfigurator</code>可以使用<code>jconsole</code>通过在shell中发出以下命令：</p>
    
    <p class="source">控制台</p>

    <img src="images/chapters/jmxConfigurator/jconsole15_tomcat.gif" alt="jconsole15_tomcat.gif">   

    <p>连接后，您应该可以访问<code>JMXXConfigurator</code>如上面的<a href="#jmxConfigurator">屏幕截图</a>所示。</p>


    <h4>带有Tomcat的MX4J（在JDK 1.5和1.6下测试）</h4>
    
		<p>您可能希望通过MX4J提供的基于Web的界面访问JMX组件。在这种情况下，以下是必需的步骤：</p>
		
    <p>假设您已经下载了<a href="http://mx4j.sourceforge.net/">MX4J</a> ，请将<em>mx4j-tools.jar</em>文件放在<em>$ TOMCAT_HOME / bin /</em>目录下。然后， <em>将以下行</em>添加到<em>$ TOMCAT_HOME / bin / catalina.sh</em>配置文件中：</p>

    <p class="source"><!-- at the beginning of the file --> CATALINA_OPTS =“-Dcom.sun.management.jmxremote” <!-- in the "Add on extra jar files to CLASSPATH" section --> CLASSPATH =“ $ CLASSPATH”：“ $ CATALINA_HOME” /bin/mx4j-tools.jar</p>

		<p>最后，声明一个新<code>Connector</code>在<em>$ TOMCAT_HOME / conf / server.xml</em>文件中：</p>

		
    <pre class="prettyprint source">&lt;Connector port="0" 
  handler.list="mx"
  mx.enabled="true" 
  mx.httpHost="localhost" 
  mx.httpPort="8082" 
  protocol="AJP/1.3" /></pre>
  
  	<p>Tomcat启动后，您应该能够通过将浏览器指向以下URL（搜索“ ch.qos.logback.classic”）来找到JMXConfigurator：</p>

    <p class="source"><a href="http://localhost:8082">http：// localhost：8082 /</a></p>

    <p>下面是MX4J界面的屏幕截图。</p>

    <img src="images/chapters/jmxConfigurator/mx4j_tomcat.gif" alt="mx4j_tomcat.gif">   

		
	
	
    <script src="../templates/footer.js" type="text/javascript"></script>
  </div>


</body></html>