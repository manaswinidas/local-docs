<html dir="ltr" xmlns="http://www.w3.org/1999/xhtml"><head></head><body dir="ltr" onload="prettyPrint(); decorate();"></ s> </ s> </ s> <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>第10章JMXコンフィギュレーター</title>
    <link rel="stylesheet" type="text/css" href="../css/common.css">
    <link rel="stylesheet" type="text/css" href="../css/screen.css" media="screen">
    <link rel="stylesheet" type="text/css" href="../css/_print.css" media="print">
    <link rel="stylesheet" type="text/css" href="../css/prettify.css" media="screen">
  
  
    <script type="text/javascript">prefix='../';</script>
    <script type="text/javascript" src="../js/prettify.js"></script>
    <script src="../templates/header.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/dsl.js"></script>
    <script type="text/javascript" src="../js/jquery-min.js"></script>
    <script type="text/javascript" src="../js/decorator.js"></script>
    <div id="left">
      <noscript>请打开Javascript查看此菜单</noscript>
      <script src="../templates/left.js" type="text/javascript"></script>
    </div>
    <div id="right">
      <script src="menu_ja.js" type="text/javascript"></script>
    </div>
    <div id="content">
	
    <h1>第10章JMXコンフィギュレーター</h1>
    
		<p>名前のとおり， <code>JMXConfigurator</code>を使うとJMX経由でlogbackを设定することができます。， 。
		</p>
		
		<h3>JMXコンフィギュレーターを使用する</h3>
    
    
		<p>るーバーを実行しているJVMがJDK1.6以降なら，コマンドラインから<code>jconsole</code> Beanンドを実行するだけで，実行中のサーバーのMBeanServerにアクセスすることができます。古いJVMで実行している场合は<a href="./10-jmxConfig.html#jmxEnablingServer">サーバーでJMXを有效化する</a>のセクションを読んでおいてください。
    </p>

    <p>次のように设定ファイルに1行追加するだけで<code>JMXConfigurator</code>が有效になります。</p>

    <pre class="prettyprint source">&lt;configuration&gt;
  <b>&lt;jmxConfigurator /&gt;</b>
  
  &lt;appender name="console" class="ch.qos.logback.core.ConsoleAppender"&gt;
    &lt;layout class="ch.qos.logback.classic.PatternLayout"&gt;
      &lt;Pattern&gt;%date [%thread] %-5level %logger{25} - %msg%n&lt;/Pattern&gt;
    &lt;/layout&gt;
  &lt;/appender&gt;

  &lt;root level="debug"&gt;
    &lt;appender-ref ref="console" /&gt;
  &lt;/root&gt;  
&lt;/configuration&gt;</pre>
		
    <p><em>jconsole</em>でサーバーに接続すれば，MBeansタブに表示される“ ch.qos.logback.classic.jmx。配置器”フルダの下にいろいろなコマンドがぶら下ドがぶらいるのが确认できます。スクリーンショットを见てください。</p>
    
    <h3 class="doAnchor" name="jmxConfigurator"><code>jconsole</code>で<code>JMXConfigurator</code>を表示している様子</h3>

    <img src="images/chapters/jmxConfigurator/jmxConfigurator.gif" alt="jmxConfigurator">   

		<p>次のような操作を実行することができます。</p>
		
		<ul>
      <li>デフォルトの设定ファイルを使用してlogbackを再设定します。</li>

      <li>URLに配置された设定ファイルを使用して再设定します。</li>
      <li>ファイルパスに配置された设定ファイルを使用して再设定します。</li>

			<li>指定したロガーのレベルを设定します。nullを设定するには文字列“ null”を指定します。</li>
      <li>指定したロガーのレベルを取得します。nullになることがあります。</li>
			<li>指定したロガーの<a href="./01-architecture.html#effectiveLevel">有效レベル</a>を取得します。</li>
		</ul>
		
    <p><code>JMXConfigurator</code>して属性として存在しているロガーの一覧と，ステータスの一覧を公开します。</p>
    
    <p>ステータスの一覧は，logbackの内部状态を诊断するのに役立ちます。</p>

    <img src="images/chapters/jmxConfigurator/statusList.gif" alt="statusList.gif">   

    <h3 class="doAnchor" name="leak">メモリリークを避ける</h3>

    <p>アサリケーションがWebサーバーやアプリケーションサーバにデプロイされているときは， <code>JMXConfigurator</code>のインスタンスをJVMのMBeanサーバーに登录すると，システムクラスローダーの参照をアプリケーションが持つようになってしまいます。がアプリがガベーションショ停止したり再デプロイされたときにJMXConfiguratorがガベージコレクションされてしまうのを防ぐためですが，そのせいで深刻なメモリリーククが生じてしまいます。</p>

    <p>したがって，スタンドアローンなJavaアプリケーションではないときは，必ず<code>JMXConfigurator</code>のインスタンスの登录をJVMのMBeanサーバーから解除しなければなりません。适切な<code>LoggerContetext</code>の<code>reset()</code> MXッドを呼べば，すべてのJMXConfiguratorのインスタンスは自动的に解除されるはずです。ロガーコンテキストを初期化するなら， <code>javax.servlet.ServletContextListener</code>の<code>contextDestroyed()</code>メソッドがちょうど良い场所です。サンプルコードを见てみましょう。</p>

    <pre class="prettyprint source">import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;

import org.slf4j.LoggerFactory;
import ch.qos.logback.classic.LoggerContext;

public class MyContextListener implements ServletContextListener {

  public void contextDestroyed(ServletContextEvent sce) {
    <b>LoggerContext lc = (LoggerContext) LoggerFactory.getILoggerFactory();</b>
    <b>lc.stop();</b>
  }

  public void contextInitialized(ServletContextEvent sce) {
  }
} </pre>


    <!-- ============ Multiple web-applications  ================== -->

    
    <h2 class="doAnchor" name="multiple">复数のWebアプリケーションで<code>JMXConfigurator</code>を使用する</h2>

    <p><em>WEB-INF / lib</em>フォルダに<em>logback-*。jar</em>と<em>slf4j-api.jar</em>を置いて，数<a href="./09-loggingSeparation.html#contextSelectors">ンテキストセレクタ</a>をーいる，これらが全て当てはまるなら，それぞれのアプリケーションの<code>JMXConfigurator</code>のインスタンスは同じ名前（“ ch.qos.logback.classic：名称=默认，类型= ch.qos.logback.classic.jmx。JMXConfigurator“）で登录されてしまうでしょう。言い换えると，何もしなければそれぞれのアプリケーションのロガーコンテキストに关连付けられた<code>JMXConfigurator</code>のインスタンスは冲突してしまうのです。
    </p>
    
    <p>冲突を避けるには，単に<a href="./03-configuration.html#contextName">アプリケーションのロガーコンテキストに名前を付ける</a>だけでよいのです。そうすれば， <code>JMXConfigurator</code>には自动的にその名前が设定されます。
    </p>

    <p>たとえば，それぞれ“コアラ”と“コウモリ”という名前のアプリケーションをデプロイしているものとします。そして，コアラのlogback.xmlには次のような设定がされているとしましょう。</p>
    
    <pre class="prettyprint source">&lt;configuration&gt;
  <b>&lt;contextName&gt;Koala&lt;/contextName&gt;</b>
  &lt;jmxConfigurator/&gt;
  ...
&lt;configuration&gt;</pre>

    <p>log，コウモリのlogback.xmlには次のように设定がされていることにします。</p>

    <pre class="prettyprint source">&lt;configuration&gt;
  <b>&lt;contextName&gt;Wombat&lt;/contextName&gt;</b>x
  &lt;jmxConfigurator/&gt;
  ...
&lt;configuration&gt;</pre>

    <p>と，jconsoleのMBeanタブには，次のように二つの独立した<code>JMXConfigurator</code>のインスタンスが表示されるはずです。</p>

    <img src="images/chapters/jmxConfigurator/multiple.gif" alt="multiple.gif">   

    <p>MBeanサーバーに登录されるJMXConfiguratorの名前は， <code>jmxConfigurator要素</code>成为“ objectName”属性で指定することができます。</p>
    
    <!-- ============ JMX enabling your  server ================== -->

    <h3 class="doAnchor" name="jmxEnablingServer">JMXを有效化する</h3>

    <p>JDK1.6以降级JVMでサーバーバーを実行している偶尔はデフォルトでJMXが有效になっています。</p>

		<p>JDK1.6以前の古いJVMを使っている场合は，サーバーのJMX关连のドキュメントを确认することをおすすめします。えばとえば<a href="http://tomcat.apache.org/tomcat-6.0-doc/monitoring.html">Tomcat</a>や<a href="http://docs.codehaus.org/display/JETTY/JMX">Jetty</a>にはドキュメントがあります。ではき，このドキュメントではTomcatとJettyの设定方法を简単に说明していきます。
		</p>

    <!-- ================ Configuring Jetty ================== -->

		<h4>JettyでJMXを有效にする（JDK 1.5およびJDK 1.6で动作确认済み）</h4>
		
		<p>以降の设定はJDK1.5とJDK1.6で动作确认しています。JDK1.6以降のJVMでは，デフォルトでJMXが有效になっています。以降の设定をしてもよいですが，特に何も変わりません。JDK1.5のJVMで実行するJettyでJMXを有效にするには，设定ファイル<em>$ JETTY_HOME / etc / jetty.xml</em>にいくつか设定を追加する必要があります。追加するのは次の设定です。</p>

    <pre class="prettyprint source">&lt;Call id="MBeanServer" class="java.lang.management.ManagementFactory" 
      name="getPlatformMBeanServer"/&gt;

&lt;Get id="Container" name="container"&gt;
  &lt;Call name="addEventListener"&gt;
    &lt;Arg&gt;
      &lt;New class="org.mortbay.management.MBeanContainer"&gt;
        &lt;Arg&gt;&lt;Ref id="MBeanServer"/&gt;&lt;/Arg&gt;
        &lt;Call name="start" /&gt;
      &lt;/New&gt;
    &lt;/Arg&gt;
  &lt;/Call&gt;
&lt;/Get&gt; </pre>

    <p>码头の公开するMBeanに<code>jconsole</code>はアクセスしたいときは，Jettyを実行するJVMにシステムプロパティ“ com.sun.management.jmxremote”を指定しておかなければなりません。
    </p>

    <p>スタンドアローン版のJettyなら次のように実行します。</p>

    
    <p class="source">java <b>-Dcom.sun.management.jmxremote</b> -jar start.jar [配置文件]</p>

    <p>MavenのプラグインからJettyを実行する场合は，システムプロパティ“ com.sun.management.jmxremote”をシェル変数<code>MAVEN_OPTS</code>で指定しなければなりません。</p>

    <p class="source"><b>MAVEN_OPTS =“-Dcom.sun.management.jmxremote</b> ” mvn jetty：run</p>

    <p>そうすれば， <code>jconsole</code>でJettyの公开するMBeanとして<code>JMXConfigurator</code>にアクセスすることができます。</p>

    <img src="images/chapters/jmxConfigurator/jconsole15_jetty.gif" alt="jconsole15_jetty.gif">   

    <p>接続したら， <a href="./10-jmxConfig.html#jmxConfigurator">前のスクリーンショット</a>のように<code>JMXConfigurator</code>るはずですアクセスできるはずです。</p>

    <h4>JettyにMX4Jを入れる（JDK 1.5およびJDK 1.6で动作确认済み）</h4>

    <p>MX4JのHTTPインターフェイスを経由して<code>JMXConfigurator</code>はアクセスしたいときは，前に说明した设定ファイルに管理ポート番号の设定を追加します。<a href="http://mx4j.sourceforge.net/">MX4J</a>はすでにダウンロード済みであることにします。
    </p>
    
    <pre class="prettyprint source">&lt;Call id="MBeanServer"
    class="java.lang.management.ManagementFactory"
    name="getPlatformMBeanServer"/&gt;

&lt;Get id="Container" name="container"&gt;
  &lt;Call name="addEventListener"&gt;
    &lt;Arg&gt;
      &lt;New class="org.mortbay.management.MBeanContainer"&gt;
        &lt;Arg&gt;&lt;Ref id="MBeanServer"/&gt;&lt;/Arg&gt;
        <b>&lt;Set name="managementPort"&gt;8082&lt;/Set&gt;</b>
        &lt;Call name="start" /&gt;
      &lt;/New&gt;
    &lt;/Arg&gt;
  &lt;/Call&gt;
&lt;/Get&gt; 
    </pre>
    
    <p>なお， <em>mx4j-tools.jar</em>はJettyのクラスパス上に配置しておいてください。
    </p>

    <p>MavenのプラグインからJettyを実行する场合は，依存关系に<em>mx4j-tools</em>を追加してください。</p>

    <pre class="prettyprint source">&lt;plugin&gt;
  &lt;groupId&gt;org.mortbay.jetty&lt;/groupId&gt;
  &lt;artifactId&gt;maven-jetty-plugin&lt;/artifactId&gt;
  &lt;configuration&gt;
    &lt;jettyConfig&gt;path/to/jetty.xml&lt;/jettyConfig&gt;
    ...
  &lt;/configuration&gt;
  <b>&lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;mx4j&lt;/groupId&gt;
      &lt;artifactId&gt;mx4j-tools&lt;/artifactId&gt;
      &lt;version&gt;3.0.1&lt;/version&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;</b>
&lt;/plugin&gt;</pre>

		<p>この设定でJettyを起动すると，ブラウザで次のURLから<code>JMXConfigurator</code>にアクセスできるようになります。アクセスした后は“ ch.qos.logback.classic”を探してください。</p>

    <p class="source"><a href="http://localhost:8082/">http：// localhost：8082 /</a></p>

    <p>MX4Jにアクセスしているところのスクリーンショットです。</p>

    <img src="images/chapters/jmxConfigurator/mx4j_jetty.gif" alt="mx4j_jetty.gif">   


    <!-- ================ Tomcat ================== -->
		
		<h4>Tomcat用のJMXの设定（JDK 1.5およびJDK 1.6で动作确认済み）</h4>
    
    <p>JDK1.6以降级JVMを使用しているならJMXはデフォルトで有效になっているので以降级设定をする必要はありません。JDK1.5の场合は<em>$ TOMCAT_HOME / bin / catalina.sh（Windowsの场合はcatalina.bat）</em>の适切な场所に次の设定を追加する必要があります。</p>
		
    <p class="source">CATALINA_OPTS =“-Dcom.sun.management.jmxremote”</p>

		<p>そうすれば， <code>jconsole</code>を使ってTomcatの公开するMBeanとして<code>JMXConfigurator</code>にアクセスできるようになります。</p>
    
    <p class="source"></p>

    <img src="images/chapters/jmxConfigurator/jconsole15_tomcat.gif" alt="jconsole15_tomcat.gif">   

    <p>接続したら， <a href="./10-jmxConfig.html#jmxConfigurator">前のスクリーンショット</a>のように<code>JMXConfigurator</code>るはずですアクセスできるはずです。
</p>


    <h4>TomcatにMX4Jを入れる（JDK 1.5およびJDK 1.6で动作确认済み）</h4>
    
		<p>MX4JのWebインターフェイスを使ってJMXのコンポーネントにアクセスしたくなるかもしれません。必要な设定方法を说明します。</p>
		
    <p><a href="http://mx4j.sourceforge.net/">MX4J</a>はすでにダウンロードしてあることにしましょう。<em>mx4j-tools.jar</em>を<em>$ TOMCAT_HOME / bin</em>フォルダーにおいてください。それから， <em>$ TOMCAT_HOME / bin / catalina.sh（Windowsの场合はcatalina.bat）</em>の适切な场所に次の设定を追加します。</p>

    <p class="source"><!-- at the beginning of the file --> CATALINA_OPTS =“-Dcom.sun.management.jmxremote” <!-- in the "Add on extra jar files to CLASSPATH" section --> CLASSPATH =“ $ CLASSPATH”：“ $ CATALINA_HOME” /bin/mx4j-tools.jar</p>

		<p>最后に， <em>$ TOMCAT_HOME / conf / server.xmlで新しい<code>Connector要素</code>を宣言します。</em></p>

		
    <pre class="prettyprint source">&lt;Connector port="0" 
  handler.list="mx"
  mx.enabled="true" 
  mx.httpHost="localhost" 
  mx.httpPort="8082" 
  protocol="AJP/1.3" /&gt;</pre>
  
  	<p>Tomcatを启动したら，ブラウザで次のURLからJMXConfiguratorにアクセスできるようになります。アクセスした后は“ ch.qos.logback.classic”を探してください。</p>

    <p class="source"><a href="http://localhost:8082">http：// localhost：8082 /</a></p>

    <p>MX4Jにアクセスしているところのスクリーンショットです。
</p>

    <img src="images/chapters/jmxConfigurator/mx4j_tomcat.gif" alt="mx4j_tomcat.gif">   

		
	
	
    <script src="../templates/footer.js" type="text/javascript"></script>
   
  </div>

</body></html>