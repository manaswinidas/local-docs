<html ><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>章28。延续</title><link rel="stylesheet" type="text/css" href="css/docbook.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><meta name="keywords" content="jetty, servlet, servlet-api, cometd, http, websocket, eclipse, maven, java, server, software"><link rel="home" href="index.html" title="Jetty"><link rel="up" href="jetty-dev-guide.html" title="Part IV. Jetty Development Guide"><link rel="prev" href="jetty-websocket-client-api.html" title="Jetty WebSocket Client API"><link rel="next" href="continuations-using.html" title="Using Continuations"><link rel="shortcut icon" href="images/favicon.ico" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><link rel="stylesheet" href="css/highlighter/foundation.css"><script src="js/highlight.pack.js"></script><script>
      hljs.initHighlightingOnLoad();
    </script><link type="text/css" rel="stylesheet" href="css/font-awesome/font-awesome.min.css"></head><body bgcolor="white"  text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><table xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><tbody><tr><td style="width:25%"><a href="http://www.eclipse.org/jetty"><img src="images/jetty-header-logo.png" alt="码头标志"></a><br><span style="font-size:small">版本：9.4.24.v20191120</span></td><td style="width:50%"></td></tr></tbody></table><div class="navheader" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><table width="100%" summary="Navigation header"><tbody><tr><th colspan="3" align="center">章28。延续</th></tr><tr><td width="20%" align="left"><a href="jetty-websocket-client-api.html" accesskey="p"><i class="fa fa-chevron-left" aria-hidden="true"></i>以前</a> </td><th width="60%" align="center">第四部分码头发展指南<br><a href="index.html" accesskey="p"><i class="fa fa-home" aria-hidden="true"></i>家</a></th><td width="20%" align="right"> <a href="continuations-using.html" accesskey="n">下一个<i class="fa fa-chevron-right" aria-hidden="true"></i></a></td></tr></tbody></table><hr></div><div class="jetty-callout" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><h5 class="callout"><a href="http://www.webtide.com/">通过<span class="website">www.webtide.com</span>与Jetty核心开发人员联系。</a></h5><p>内部/客户项目的私人支持...自定义扩展和发行版...无限期支持的版本快照...您的应用程序和Ajax / Comet项目的可伸缩性指南...赞助功能开发的开发服务</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="continuations"></a>章28。延续</h2></div></div></div><div class="toc"><p><b>目录</b></p><dl class="toc"><dt><span class="section"><a href="continuations.html#continuations-intro">介绍</a></span></dt><dt><span class="section"><a href="continuations-using.html">使用延续</a></span></dt><dt><span class="section"><a href="continuations-patterns.html">常见的延续模式</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear:both"><a name="continuations-intro"></a>介绍</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="continuations.html#_why_asynchronous_servlets">为什么选择异步Servlet？</a></span></dt><dt><span class="section"><a href="continuations.html#_asynchronous_servlet_examples">异步Servlet示例</a></span></dt><dt><span class="section"><a href="continuations.html#_servlet_threading_model">Servlet线程模型</a></span></dt></dl></div><p>延续是一种实现异步Servlet的机制，类似于Servlet 3.0中的异步功能，但提供了更简单且可移植的接口。</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_why_asynchronous_servlets"></a>为什么选择异步Servlet？</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_not_asynchronous_io"></a>不是异步IO</h4></div></div></div><p>异步Servlet的概念通常与异步IO或NIO的使用相混淆。但是，异步Servlet并不是主要由异步IO驱动，因为：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type:disc"><li class="listitem">HTTP请求通常很小，并且以单个数据包的形式到达。Servlet很少会阻塞请求。</li><li class="listitem">许多响应很小并且适合于服务器缓冲区，因此Servlet通常不会阻止写响应。</li><li class="listitem">即使我们可以在Servlet中公开异步IO，也很难进行编程。例如，如果应用程序读取3字节UTF-8字符中的2字节，该怎么办？它必须缓冲并等待更多字节。最好由容器而不是应用程序完成。</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_asynchronous_waiting"></a>异步等待</h4></div></div></div><p>异步servlet的主要用例是等待非IO事件或资源。许多Web应用程序需要在处理HTTP请求期间的某个阶段等待，例如：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type:disc"><li class="listitem">在处理请求之前等待资源可用（例如，线程，JDBC连接）。</li><li class="listitem">等待AJAX Comet应用程序中的应用程序事件（例如，聊天消息，价格变动）。</li><li class="listitem">等待来自远程服务的响应（例如，对Web服务的RESTful或SOAP调用）。</li></ul></div><p>Servlet API（2.5版之前）仅支持同步调用样式，因此，Servlet需要做的任何等待都必须带有阻塞。不幸的是，这意味着必须在等待期间保留分配给请求的线程及其所有资源：内核线程，堆栈内存和通常的缓冲池，字符转换器，EE身份验证上下文等。浪费这些资源浪费系统资源等待中的资源。如果等待是异步进行的，则可以实现更好的可伸缩性和服务质量。</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_asynchronous_servlet_examples"></a>异步Servlet示例</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_ajax_comet_server_push"></a> AJAX Comet服务器推送</h4></div></div></div><p>Web 2.0应用程序可以使用<a class="link" href="http://en.wikipedia.org/wiki/Comet_(programming)" target="_top">彗星</a>技术（又名AJAX推送，服务器推送，长轮询）来动态更新网页，而无需刷新整个页面。</p><p>考虑一个股票投资组合Web应用程序。每个浏览器都会向服务器发送长轮询请求，以询问用户的任何股价已发生变化。服务器将从其所有客户端接收长轮询请求，但不会立即响应。取而代之的是，服务器会等到股票价格发生变化时，服务器才会将响应发送给投资组合中有该股票的每个客户。收到长期轮询响应的客户将立即发送另一个长期轮询请求，以便他们可能获得将来的价格变化。</p><p>因此，服务器通常会为每个连接的用户保留一个较长的轮询请求，因此，如果Servlet不是异步的，则将需要超过1000个线程来处理1000个并发用户。1000个线程可以消耗256MB以上的内存；最好将其用于应用程序，而不是闲置等待价格变动。</p><p>如果Servlet是异步的，则所需的线程数由生成每个响应的时间和价格变化的频率控制。如果每个用户每10秒收到一个价格，并且生成响应需要10毫秒，则仅用1个线程即可为1000个用户提供服务，并释放256MB的堆栈用于其他目的。</p><p>有关彗星的更多信息，请参见与Jetty异步工作的<a class="link" href="http://cometd.org/" target="_top">cometd</a>项目。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_asynchronous_restful_web_service"></a>异步RESTful Web服务</h4></div></div></div><p>考虑访问远程Web服务（例如SOAP服务或RESTful服务）的Web应用程序。通常，远程Web服务可能需要数百毫秒才能产生响应-eBay的RESTful Web服务通常需要350ms才能做出与给定关键字匹配的拍卖列表的响应-而本地处理请求仅需要几十毫秒的CPU时间。请求并生成响应。</p><p>要处理每秒1000个请求（每个请求执行200毫秒的Web服务调用），Web应用程序将需要1000 *（200 + 20）/ 1000 = 220个线程和110MB的堆栈内存。如果发生突发或Web服务变慢，它也很容易出现线程不足的情况。如果以异步方式处理，则Web应用程序在等待Web服务响应时将不需要保留线程。即使异步机制花费10毫秒（不是这样），该Web应用程序仍需要1000 *（20 + 10）/ 1000 = 30个线程和15MB的堆栈内存。这将减少86％的所需资源，并且该应用程序可以使用95MB以上的内存。此外，如果需要多个Web服务请求，则异步方法允许并行而不是串行地进行这些操作，而无需分配其他线程。</p><p>有关Jetty解决方案的示例，请参见“ <a class="link" href="https://webtide.com/async-rest-jetty-9/" target="_top">异步REST”示例</a></p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_quality_of_service_e_g_jdbc_connection_pool"></a>服务质量（例如，JDBC连接池）</h4></div></div></div><p>考虑一个Web应用程序平均每秒处理400个请求，每个请求与数据库交互50毫秒。要处理此负载，平均需要400 * 50/1000 = 20个JDBC连接。但是，请求的发送速度并不均匀，并且经常会出现突发和暂停。为了保护数据库免受突发攻击，通常会应用JDBC连接池来限制对数据库的同时请求。因此，对于此应用程序，应用30个连接的JDBC池以提供50％的余量是合理的。</p><p>如果暂时将请求速率提高一倍，则30个连接每秒只能处理600个请求，而每秒200个请求将加入那些在JDBC连接池中等待的请求。然后，如果Servlet容器具有一个包含200个线程的线程池，则在此请求速率的1秒钟内等待JDBC连接的线程将完全消耗该线程池。1s之后，Web应用程序将根本无法处理任何请求，因为没有线程可用。由于线程饥饿，即使不使用数据库的请求也会被阻止。要使线程池增加一倍，将需要额外的100MB堆栈内存，并且在负载下只能为应用程序提供1s宽限期！</p><p>如果数据库运行缓慢或暂时不可用，也可能发生线程不足的情况。线程不足是一个经常报告的问题，它导致整个Web服务锁定并变得无响应。如果Web容器能够在没有线程的情况下挂起等待JDBC连接的请求，则不会发生线程匮乏，因为访问数据库的请求只会占用30个线程，而其他470个线程可用于处理该请求。不要访问数据库。</p><p>有关Jetty解决方案的示例，请参见服务质量过滤器。</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_servlet_threading_model"></a> Servlet线程模型</h3></div></div></div><p>Java servlet的可伸缩性问题主要是由服务器线程模型引起的：</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_thread_per_connection"></a>每个连接线程</h4></div></div></div><p>Java的传统IO模型将线程与每个TCP / IP连接相关联。如果您有几个非常活跃的线程，则此模型可以扩展到每秒大量的请求。</p><p>但是，许多Web应用程序的典型流量配置文件是许多持久HTTP连接，当用户阅读页面或搜索要单击的下一个链接时，这些HTTP连接大多处于空闲状态。使用这样的配置文件，每个连接线程模型可能难以扩展到支持大规模部署中成千上万个用户所需的成千上万个线程。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_thread_per_request"></a>每个请求的线程</h4></div></div></div><p>Java NIO库支持异步IO，因此不再需要将线程分配给每个连接。当连接处于空闲状态（在请求之间）时，会将连接添加到NIO选择集，该选择集允许一个线程扫描许多连接以进行活动。仅当在连接上检测到IO时，才会为其分配线程。但是，servlet 2.5 API模型仍然需要在请求处理期间分配一个线程。</p><p>每个请求线程模型允许更大的连接（用户）扩展规模，但由于额外的调度延迟而导致每秒最大请求量的减少很小。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_asynchronous_request_handling"></a>异步请求处理</h4></div></div></div><p>Jetty Continuation（和Servlet 3.0异步）API引入了Servlet API的更改，该更改允许将请求多次分派到Servlet。如果Servlet没有调度程序所需的资源，则该请求将被挂起（或置于异步模式下），以便Servlet可以从调度程序中返回而不发送响应。当等待的资源变为可用时，该请求将使用新线程重新分派到Servlet，并生成响应。</p></div></div></div></div><script type="text/javascript">
      SyntaxHighlighter.all()
    </script><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tbody><tr><td width="40%" align="left"><a href="jetty-websocket-client-api.html" accesskey="p"><i class="fa fa-chevron-left" aria-hidden="true"></i>以前</a> </td><td width="20%" align="center"><a href="jetty-dev-guide.html" accesskey="u"><i class="fa fa-chevron-up" aria-hidden="true"></i>最佳</a></td><td width="40%" align="right"> <a href="continuations-using.html" accesskey="n">下一个<i class="fa fa-chevron-right" aria-hidden="true"></i></a></td></tr><tr><td width="40%" align="left" valign="top">Jetty WebSocket客户端API</td><td width="20%" align="center"><a href="index.html" accesskey="h"><i class="fa fa-home" aria-hidden="true"></i>家</a></td><td width="40%" align="right" valign="top">使用延续</td></tr></tbody></table></div><p xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"></p><div class="jetty-callout">看到错误或缺少的东西？
            <span class="callout"><a href="http://github.com/eclipse/jetty.project">在以下位置对此文档做出贡献<span class="website"><i class="fa fa-github" aria-hidden="true"></i> Github！</span></a></span> <span style="float:right"><i>（产生：2019-11-20）</i></span></div><p></p></body></html>