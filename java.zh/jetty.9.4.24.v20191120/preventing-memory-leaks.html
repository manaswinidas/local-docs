<html ><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>防止内存泄漏</title><link rel="stylesheet" type="text/css" href="css/docbook.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><meta name="keywords" content="jetty, servlet, servlet-api, cometd, http, websocket, eclipse, maven, java, server, software"><link rel="home" href="index.html" title="Jetty"><link rel="up" href="troubleshooting.html" title="Chapter 33. Troubleshooting"><link rel="prev" href="troubleshooting-locked-files-on-windows.html" title="Troubleshooting Locked Files on Windows"><link rel="next" href="troubleshooting-slow-deployment.html" title="Troubleshooting Slow Deployment"><link rel="shortcut icon" href="images/favicon.ico" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><link rel="stylesheet" href="css/highlighter/foundation.css"><script src="js/highlight.pack.js"></script><script>
      hljs.initHighlightingOnLoad();
    </script><link type="text/css" rel="stylesheet" href="css/font-awesome/font-awesome.min.css"></head><body bgcolor="white"  text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><table xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><tbody><tr><td style="width:25%"><a href="http://www.eclipse.org/jetty"><img src="images/jetty-header-logo.png" alt="Jetty标志"></a><br><span style="font-size:small">版本：9.4.24.v20191120</span></td><td style="width:50%"></td></tr></tbody></table><div class="navheader" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><table width="100%" summary="Navigation header"><tbody><tr><th colspan="3" align="center">防止内存泄漏</th></tr><tr><td width="20%" align="left"><a href="troubleshooting-locked-files-on-windows.html" accesskey="p"><i class="fa fa-chevron-left" aria-hidden="true"></i>以前</a> </td><th width="60%" align="center">章33。故障排除<br><a href="index.html" accesskey="p"><i class="fa fa-home" aria-hidden="true"></i>家</a></th><td width="20%" align="right"> <a href="troubleshooting-slow-deployment.html" accesskey="n">下一个<i class="fa fa-chevron-right" aria-hidden="true"></i></a></td></tr></tbody></table><hr></div><div class="jetty-callout" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><h5 class="callout"><a href="http://www.webtide.com/">通过<span class="website">www.webtide.com</span>与Jetty核心开发人员联系。</a></h5><p>内部/客户项目的私人支持...自定义扩展和发行版...无限期支持的版本快照...您的应用程序和Ajax / Comet项目的可伸缩性指南...赞助功能开发的开发服务</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear:both"><a name="preventing-memory-leaks"></a>防止内存泄漏</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="preventing-memory-leaks.html#preventing-webapp-classloader-pinning">防止WebApp Classloader固定</a></span></dt><dt><span class="section"><a href="preventing-memory-leaks.html#jsp-bugs">JSP错误：Permgen问题</a></span></dt><dt><span class="section"><a href="preventing-memory-leaks.html#jvm-bugs">JVM错误</a></span></dt></dl></div><p>如果存在内存泄漏，并且已经彻底研究了诸如jconsole，yourkit，jprofiler，jvisualvm或其他任何分析和分析工具之类的工具，并且可以消除作为问题根源的代码，请阅读以下有关如何防止应用程序中的内存泄漏。</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="preventing-webapp-classloader-pinning"></a>防止WebApp Classloader固定</h3></div></div></div><div class="blockquote"><blockquote class="blockquote"><div class="note" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title"><i class="fa fa-asterisk" aria-hidden="true"></i>注意</h3><p>Jetty 7.6.6及更高版本可使用此功能。</p></div></blockquote></div><p>保留对webapp类加载器的引用的代码可能会导致内存泄漏。这些泄漏通常分为两类：静态字段和守护程序线程。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type:disc"><li class="listitem">用classloader的值初始化一个静态字段，该值恰好是一个webapp classloader；当Jetty取消部署和重新部署该Web应用程序时，静态引用仍然存在，这意味着该Webapp类加载器不会发生垃圾收集。</li><li class="listitem">当Jetty作为守护程序线程启动并且在webapp的生命周期之外时，线程将引用创建它们的上下文类加载器，如果该类加载器属于webapp，则会导致内存泄漏。有关此问题的详细讨论，请参见<a class="link" href="http://cdivilly.wordpress.com/tag/sun-awt-appcontext/" target="_top">PermGen内存泄漏剖析。</a></li></ul></div><p>我们提供了许多<a class="link" href="http://www.eclipse.org/jetty/javadoc/9.4.24.v20191120//org/eclipse/jetty/util/preventers/package-summary.html" target="_top">解决方法类</a> ，这些<a class="link" href="http://www.eclipse.org/jetty/javadoc/9.4.24.v20191120//org/eclipse/jetty/util/preventers/package-summary.html" target="_top">类</a>可通过Jetty类加载器抢先调用有问题的代码，从而确保未固定webapp类加载器。请注意，由于某些有问题的代码会创建线程，因此您应该选择启用哪些阻止程序，并仅使用特定于您的应用程序的阻止程序。</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="preventers-table"></a>预防者</h4></div></div></div><p>Jetty包括以下预防措施。</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th align="left" valign="top">预防者名称</th><th align="left" valign="top">解决的问题</th></tr></thead><tbody><tr><td align="left" valign="top"><p>AppContextLeakPreventer</p></td><td align="left" valign="top"><p>致电<code class="literal">AppContext.getAppContext()</code>保持对上下文类加载器的静态引用。JRE可以在许多不同的地方调用AppContext。</p></td></tr><tr><td align="left" valign="top"><p>AWTLeakPreventer</p></td><td align="left" valign="top"><p>的<code class="literal">java.awt.Toolkit</code>类具有作为默认工具箱的静态字段。创建默认工具包会导致创建一个<code class="literal">EventQueue</code> ，该类具有使用线程上下文类加载器初始化的classloader字段。参见<a class="link" href="https://issues.jboss.org/browse/AS7-3733" target="_top">JBoss错误AS7-3733。</a></p></td></tr><tr><td align="left" valign="top"><p>DOMLeakPreventer</p></td><td align="left" valign="top"><p>DOM解析会导致固定Webapp类加载器，这是由于静态字段“ RuntimeException”的<code class="literal">com.sun.org.apache.xerces.internal.parsers.AbstractDOMParser.</code> <a class="link" href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6916498" target="_top">Oracle错误6916498</a>特别提到堆转储可能不会将GCRoot标识为未收集的加载器，从而难以确定泄漏的原因。</p></td></tr><tr><td align="left" valign="top"><p>DriverManagerLeakPreventer</p></td><td align="left" valign="top"><p>专用于接受传入连接的线程数。</p></td></tr><tr><td align="left" valign="top"><p>GCThreadLeakPreventer</p></td><td align="left" valign="top"><p>致电<code class="literal">sun.misc.GC.requestLatency</code>创建一个守护程序线程，该线程保留对上下文类加载器的引用。该方法的已知调用者是RMI impl。请参见<a class="link" href="http://stackoverflow.com/questions/6626680/does-java-garbage-collection-log-entry-full-gc-system-mean-some-class-called" target="_top">Stackoverflow：Java垃圾回收日志条目<span class="emphasis"><em>Full GC系统是否</em></span>意味着某个名为System.gc（）的类？</a></p></td></tr><tr><td align="left" valign="top"><p>Java2DLeakPreventer</p></td><td align="left" valign="top"><p><code class="literal">sun.java2d.Disposer</code>保留对类加载器的引用。请参阅<a class="link" href="https://issues.apache.org/bugzilla/show_bug.cgi?id=51687" target="_top">ASF错误51687。</a></p></td></tr><tr><td align="left" valign="top"><p>LDAPLeakPreventer</p></td><td align="left" valign="top"><p>如果<code class="literal">com.sun.jndi.LdapPoolManager</code>加载类，并将系统属性com.sun.jndi.ldap.connect.pool.timeout设置为非零值，守护程序线程启动并保留对上下文类加载器的引用。</p></td></tr><tr><td align="left" valign="top"><p>LoginConfigurationLeakPreventer</p></td><td align="left" valign="top"><p>的<code class="literal">javax.security.auth.login.Configuration</code>类保留对线程上下文类加载器的静态引用。</p></td></tr><tr><td align="left" valign="top"><p>SecurityProviderLeakPreventer</p></td><td align="left" valign="top"><p>一些安全提供程序，例如<code class="literal">sun.security.pkcs11.SunPKCS11</code>启动一个捕获线程上下文类加载器的守护进程线程。</p></td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="configuring-preventers"></a>配置防护器</h4></div></div></div><p>您可以通过使用addBean（Object）调用将实例添加到服务器来分别启用每个阻止程序。这是一个如何使用<code class="literal">org.eclipse.jetty.util.preventers.AppContextLeakPreventer</code> ：</p><pre xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><code>Server server = new Server();
server.addBean(new AppContextLeakPreventer());</code></pre><p>您可以将等效的代码添加到<code class="literal">$JETTY_HOME/etc/jetty.xml</code>文件或配置服务器实例的任何jetty xml文件。请注意，如果您的JVM中有多个服务器实例，则应仅在<span class="emphasis"><em>其中一个</em></span>上配置这些阻止程序。这是xml中的代码示例：</p><pre xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><code>&lt;Configure id="Server" class="org.eclipse.jetty.server.Server"&gt;

   &lt;Call name="addBean"&gt;
    &lt;Arg&gt;
      &lt;New class="org.eclipse.jetty.util.preventers.AppContextLeakPreventer"/&gt;
    &lt;/Arg&gt;
   &lt;/Call&gt;

&lt;/Configure&gt;</code></pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jsp-bugs"></a> JSP错误：Permgen问题</h3></div></div></div><p>Jetty中的JSP引擎是Jasper。它最初是在Apache Tomcat项目下开发的，但随着时间的流逝，许多不同的项目将其分叉。直到6的所有Jetty版本都仅使用基于Apache的Jasper，而Jetty 6仅使用Apache Jasper来用于JSP 2.0。随着JSP 2.1的出现，Jetty 6切换到使用Sun的<a class="link" href="https://glassfish.java.net/" target="_top">Glassfish</a>项目中的Jasper，该项目现在是参考实现。</p><p>Jasper的所有fork都存在一个问题，即使用JSP标记文件会使permgen空间承受压力。这是因为JSP实现的类加载体系结构。有效地编译了每个JSP文件，并将其类加载到其自己的类加载器中，以允许热替换。每个包含对标记文件的引用的JSP都会在必要时编译标记，然后使用其自己的类加载器将其加载。如果您有许多JSP引用同一个标记文件，则将标记的类一遍又一遍地加载到permgen空间中，每个JSP一次。请参阅<a class="link" href="http://java.net/jira/browse/GLASSFISH-3963" target="_top">Glassfish错误3963</a>和<a class="link" href="https://issues.apache.org/bugzilla/show_bug.cgi?id=43878" target="_top">Apache错误43878。</a>Apache Tomcat项目已经关闭了状态为WO N'T FIX的错误，但是Glassfish人士仍然可以打开该错误，并已计划对其进行修复。当修复程序可用时，Jetty项目将对其进行修复并将其合并到我们的发布程序中。</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jvm-bugs"></a> JVM错误</h3></div></div></div><p>本节描述垃圾回收和直接ByteBuffer问题。</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jvm-garbage-collection-problems"></a>垃圾收集问题</h4></div></div></div><p>与JVM相关的内存问题群集的一个症状是OOM异常伴随着诸如以下消息<code class="literal">java.lang.OutOfMemoryError: requested xxxx bytes for xxx. Out of swap space?</code></p><p><a class="link" href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4697804" target="_top">Oracle错误4697804</a>描述了在垃圾收集器在运行期间需要分配更多空间并尝试调整堆大小但由于计算机空间不足而失败的情况下如何发生这种情况。建议的解决方法是通过将最小堆大小设置为最大堆大小来确保JVM永远不会尝试调整堆大小：</p><pre xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><code>java -Xmx1024m -Xms1024m</code></pre><p>另一个解决方法是，确保您在设备上配置了足够的交换空间，以容纳同时运行的所有程序。</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="direct-byte-buffers"></a>直接字节缓冲区</h4></div></div></div><p>耗尽本机内存是与JVM错误相关的另一个问题。要寻找的症状是进程大小不断增长，但是堆使用保持相对恒定。JIT编译器和nio ByteBuffers都可以消耗本机内存。
<a class="link" href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6210541" target="_top">Oracle错误6210541</a>讨论了一个仍未解决的问题，即在某些情况下JVM本身分配直接的ByteBuffer，而系统从不进行垃圾回收，从而实际上占用了本机内存。Guy Korland的博客在<a class="link" href="http://www.jroller.com/gkorland/entry/java_s_memory_isn_t" target="_top">这里</a>和<a class="link" href="http://www.jroller.com/gkorland/entry/java_s_memory_managment_is" target="_top">这里</a>讨论了这个问题<a class="link" href="http://www.jroller.com/gkorland/entry/java_s_memory_managment_is" target="_top">。</a>由于JIT编译器消耗本机内存，因此缺少可用内存可能会在JIT中表现为OutOfMemory异常，例如<code class="literal">Exception in thread "CompilerThread0" java.lang.OutOfMemoryError: requested xxx bytes for ChunkPool::allocate. Out of swap space?</code></p><p>默认情况下，如果您配置nio SelectChannelConnector，Jetty将为io分配和管理自己的直接ByteBuffers池。它还通过DefaultServlet设置将MappedByteBuffers分配给内存映射静态文件。但是，如果禁用了这两个选项之一，则可能会遇到此JVM ByteBuffer分配问题。例如，如果您使用的是Windows，则可能已为DefaultServlet上的静态文件缓存禁用了内存映射缓冲区，以避免文件锁定问题。</p></div></div></div><script type="text/javascript">
      SyntaxHighlighter.all()
    </script><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tbody><tr><td width="40%" align="left"><a href="troubleshooting-locked-files-on-windows.html" accesskey="p"><i class="fa fa-chevron-left" aria-hidden="true"></i>以前</a> </td><td width="20%" align="center"><a href="troubleshooting.html" accesskey="u"><i class="fa fa-chevron-up" aria-hidden="true"></i>最佳</a></td><td width="40%" align="right"> <a href="troubleshooting-slow-deployment.html" accesskey="n">下一个<i class="fa fa-chevron-right" aria-hidden="true"></i></a></td></tr><tr><td width="40%" align="left" valign="top">对Windows上的锁定文件进行故障排除</td><td width="20%" align="center"><a href="index.html" accesskey="h"><i class="fa fa-home" aria-hidden="true"></i>家</a></td><td width="40%" align="right" valign="top">解决慢速部署问题</td></tr></tbody></table></div><p xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"></p><div class="jetty-callout">看到错误或缺少的东西？
            <span class="callout"><a href="http://github.com/eclipse/jetty.project">在以下位置对此文档做出贡献<span class="website"><i class="fa fa-github" aria-hidden="true"></i> Github！</span></a></span> <span style="float:right"><i>（产生：2019-11-20）</i></span></div><p></p></body></html>