<html ><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>高负荷</title><link rel="stylesheet" type="text/css" href="css/docbook.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><meta name="keywords" content="jetty, servlet, servlet-api, cometd, http, websocket, eclipse, maven, java, server, software"><link rel="home" href="index.html" title="Jetty"><link rel="up" href="optimizing.html" title="Chapter 20. Optimizing Jetty"><link rel="prev" href="optimizing.html" title="Chapter 20. Optimizing Jetty"><link rel="next" href="limit-load.html" title="Limiting Load"><link rel="shortcut icon" href="images/favicon.ico" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><link rel="stylesheet" href="css/highlighter/foundation.css"><script src="js/highlight.pack.js"></script><script>
      hljs.initHighlightingOnLoad();
    </script><link type="text/css" rel="stylesheet" href="css/font-awesome/font-awesome.min.css"></head><body bgcolor="white"  text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><table xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><tbody><tr><td style="width:25%"><a href="http://www.eclipse.org/jetty"><img src="images/jetty-header-logo.png" alt="Jetty标志"></a><br><span style="font-size:small">版本：9.4.24.v20191120</span></td><td style="width:50%"></td></tr></tbody></table><div class="navheader" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><table width="100%" summary="Navigation header"><tbody><tr><th colspan="3" align="center">高负荷</th></tr><tr><td width="20%" align="left"><a href="optimizing.html" accesskey="p"><i class="fa fa-chevron-left" aria-hidden="true"></i>以前</a> </td><th width="60%" align="center">第20章优化Jetty<br><a href="index.html" accesskey="p"><i class="fa fa-home" aria-hidden="true"></i>家</a></th><td width="20%" align="right"> <a href="limit-load.html" accesskey="n">下一个<i class="fa fa-chevron-right" aria-hidden="true"></i></a></td></tr></tbody></table><hr></div><div class="jetty-callout" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><h5 class="callout"><a href="http://www.webtide.com/">通过<span class="website">www.webtide.com</span>与Jetty核心开发人员联系。</a></h5><p>内部/客户项目的私人支持...自定义扩展和发行版...无限期支持的版本快照...您的应用程序和Ajax / Comet项目的可伸缩性指南...赞助功能开发的开发服务</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear:both"><a name="high-load"></a>高负荷</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="high-load.html#_load_generation_for_load_testing">负载生成以进行负载测试</a></span></dt><dt><span class="section"><a href="high-load.html#_operating_system_tuning">操作系统调优</a></span></dt></dl></div><p>将Jetty配置为高负载，无论是用于负载测试还是用于生产，都需要对操作系统，JVM，Jetty，应用程序，网络和负载生成进行全部调整。</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_load_generation_for_load_testing"></a>负载生成以进行负载测试</h3></div></div></div><p>处理负载生成的计算机必须对其OS，JVM等进行调整，使其与服务器计算机一样好。</p><p>负载生成不应通过服务器计算机上的本地网络进行，因为这具有不切实际的性能和延迟以及不同的数据包大小和传输特性。</p><p>负载生成器应生成实际负载。避免以下陷阱：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type:disc"><li class="listitem">一个常见的错误是负载生成器经常打开相对较少的连接，而这些连接非常忙于通过每个连接发送尽可能多的请求。这导致所测得的吞吐量受到请求延迟的限制（有关此类问题的分析，请参见<a class="link" href="http://blogs.webtide.com/gregw/entry/lies_damned_lies_and_benchmarks" target="_top">“谎言”，“该死的谎言和基准</a> ”）。</li><li class="listitem">另一个常见的错误是对单个请求使用TCP / IP，并打开许多短暂的连接。由于文件描述符和/或端口不足，这通常会导致接受队列填充和限制。</li><li class="listitem">负载生成器应该对来自服务器普通客户端的流量配置文件进行建模。对于浏览器，这通常在两个到六个连接之间，这些连接通常是空闲的，并且偶尔会使用突发时间，读取时间介于两者之间。这些连接通常是长期保持的HTTP / 1.1连接。</li><li class="listitem">负载生成器应以异步方式编写，以便有限数量的线程不会限制可以模拟的最大用户数量。如果生成器不是异步的，则线程池2000只能模拟500个或更少的用户。Jetty<code class="literal">HttpClient</code>是构建负载生成器的理想选择，因为它是异步的并且可以模拟成千上万个连接（有关实际负载生成器的一个很好的示例，请参见CometD负载测试器）。</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_operating_system_tuning"></a>操作系统调优</h3></div></div></div><p>服务器计算机和任何负载生成计算机都需要进行调整，以支持许多TCP / IP连接和高吞吐量。</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_linux"></a>的Linux</h4></div></div></div><p>Linux在自我配置TCP / IP方面做得很合理，但是您应该增加一些限制和默认值。您可以在其中配置大多数<code class="literal">/etc/security/limits.conf</code>或通过<code class="literal">sysctl</code> 。</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_tcp_buffer_sizes"></a> TCP缓冲区大小</h5></div></div></div><p>对于10G路径，应将TCP缓冲区大小增加到至少16MB，并调整自动调整（请记住，您需要考虑缓冲区膨胀）。</p><div class="screenexample"><pre class="screen">$ sysctl -w net.core.rmem_max=16777216
$ sysctl -w net.core.wmem_max=16777216
$ sysctl -w net.ipv4.tcp_rmem="4096 87380 16777216"
$ sysctl -w net.ipv4.tcp_wmem="4096 16384 16777216"</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_queue_sizes"></a>队列大小</h5></div></div></div><p><code class="literal">net.core.somaxconn</code>控制连接侦听队列的大小。默认值为128。如果您正在运行大容量服务器，并且在TCP级别上拒绝连接，则需要增加此值。此设置可能需要一些技巧才能正确：如果设置得太高，则会在尝试通知服务器大量连接时发生资源问题，并且许多连接仍处于挂起状态，但是如果设置得太低，则被拒绝连接发生。</p><div class="screenexample"><pre class="screen"> $ sysctl -w net.core.somaxconn=4096</pre></div><p>的<code class="literal">net.core.netdev_max_backlog</code>控制上层（Java）处理的传入数据包队列的大小。可以增加默认值（2048），并通过以下方式调整其他相关参数：</p><div class="screenexample"><pre class="screen">$ sysctl -w net.core.netdev_max_backlog=16384
$ sysctl -w net.ipv4.tcp_max_syn_backlog=8192
$ sysctl -w net.ipv4.tcp_syncookies=1</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_ports"></a>港口</h5></div></div></div><p>如果建立了许多传出连接（例如，在负载生成器上），则操作系统的端口可能不足。因此，最好增加端口范围，并允许在<code class="literal">TIME_WAIT</code> ：</p><div class="screenexample"><pre class="screen">$ sysctl -w net.ipv4.ip_local_port_range="1024 65535"
$ sysctl -w net.ipv4.tcp_tw_recycle=1</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_file_descriptors"></a>文件描述符</h5></div></div></div><p>繁忙的服务器和负载生成器可能会用尽文件描述符，因为系统默认值通常较低。可以为特定用户增加<code class="literal">/etc/security/limits.conf</code> ：</p><pre class="literallayout">theusername            hard nofile     40000
theusername            soft nofile     40000</pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_congestion_control"></a>拥塞控制</h5></div></div></div><p>Linux支持可插拔的拥塞控制算法。要获取内核运行中可用的拥塞控制算法列表：</p><div class="screenexample"><pre class="screen">$ sysctl net.ipv4.tcp_available_congestion_control</pre></div><p>如果没有列出三次和/或htcp，则需要研究内核的控制算法。您可以尝试通过以下方式将控件设置为立方：</p><div class="screenexample"><pre class="screen">$ sysctl -w net.ipv4.tcp_congestion_control=cubic</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_mac_os"></a>苹果系统</h5></div></div></div><p>提示欢迎。</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_windows"></a>视窗</h5></div></div></div><p>提示欢迎。</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_network_tuning"></a>网络调优</h5></div></div></div><p>诸如nginx之类的中介可以使用非持久HTTP / 1.0连接。确保使用持久性HTTP / 1.1连接。</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_jvm_tuning"></a> JVM调整</h5></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type:disc"><li class="listitem">调整垃圾收集</li><li class="listitem">分配足够的内存</li><li class="listitem">使用-server选项</li><li class="listitem">Jetty调整</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_acceptors"></a>接受者</h5></div></div></div><p>根据经验，配置给定机器的标准数量是每个CPU一个。</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_low_resource_limits"></a>低资源限制</h5></div></div></div><p>不得将其配置为少于预期的连接数。</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_thread_pool"></a>线程池</h5></div></div></div><p>配置目标是限制最大可用内存使用量。通常是> 50且<500</p></div></div></div></div><script type="text/javascript">
      SyntaxHighlighter.all()
    </script><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tbody><tr><td width="40%" align="left"><a href="optimizing.html" accesskey="p"><i class="fa fa-chevron-left" aria-hidden="true"></i>以前</a> </td><td width="20%" align="center"><a href="optimizing.html" accesskey="u"><i class="fa fa-chevron-up" aria-hidden="true"></i>最佳</a></td><td width="40%" align="right"> <a href="limit-load.html" accesskey="n">下一个<i class="fa fa-chevron-right" aria-hidden="true"></i></a></td></tr><tr><td width="40%" align="left" valign="top">第20章优化Jetty</td><td width="20%" align="center"><a href="index.html" accesskey="h"><i class="fa fa-home" aria-hidden="true"></i>家</a></td><td width="40%" align="right" valign="top">极限负荷</td></tr></tbody></table></div><p xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"></p><div class="jetty-callout">看到错误或缺少的东西？
            <span class="callout"><a href="http://github.com/eclipse/jetty.project">在以下位置对此文档做出贡献<span class="website"><i class="fa fa-github" aria-hidden="true"></i> Github！</span></a></span> <span style="float:right"><i>（产生：2019-11-20）</i></span></div><p></p></body></html>