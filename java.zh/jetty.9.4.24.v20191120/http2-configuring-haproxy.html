<html ><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>配置HAProxy和Jetty</title><link rel="stylesheet" type="text/css" href="css/docbook.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><meta name="keywords" content="jetty, servlet, servlet-api, cometd, http, websocket, eclipse, maven, java, server, software"><link rel="home" href="index.html" title="Jetty"><link rel="up" href="http2.html" title="Chapter 16. HTTP/2"><link rel="prev" href="http2-configuring-push.html" title="Configuring HTTP/2 Push"><link rel="next" href="fastcgi.html" title="Chapter 17. FastCGI Support"><link rel="shortcut icon" href="images/favicon.ico" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><link rel="stylesheet" href="css/highlighter/foundation.css"><script src="js/highlight.pack.js"></script><script>
      hljs.initHighlightingOnLoad();
    </script><link type="text/css" rel="stylesheet" href="css/font-awesome/font-awesome.min.css"></head><body bgcolor="white"  text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><table xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><tbody><tr><td style="width:25%"><a href="http://www.eclipse.org/jetty"><img src="images/jetty-header-logo.png" alt="Jetty标志"></a><br><span style="font-size:small">版本：9.4.24.v20191120</span></td><td style="width:50%"></td></tr></tbody></table><div class="navheader" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><table width="100%" summary="Navigation header"><tbody><tr><th colspan="3" align="center">配置HAProxy和Jetty</th></tr><tr><td width="20%" align="left"><a href="http2-configuring-push.html" accesskey="p"><i class="fa fa-chevron-left" aria-hidden="true"></i>以前</a> </td><th width="60%" align="center">第十六章HTTP / 2<br><a href="index.html" accesskey="p"><i class="fa fa-home" aria-hidden="true"></i>家</a></th><td width="20%" align="right"> <a href="fastcgi.html" accesskey="n">下一个<i class="fa fa-chevron-right" aria-hidden="true"></i></a></td></tr></tbody></table><hr></div><div class="jetty-callout" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"><h5 class="callout"><a href="http://www.webtide.com/">通过<span class="website">www.webtide.com</span>与Jetty核心开发人员联系。</a></h5><p>内部/客户项目的私人支持...自定义扩展和发行版...无限期支持的版本快照...您的应用程序和Ajax / Comet项目的可伸缩性指南...赞助功能开发的开发服务</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear:both"><a name="http2-configuring-haproxy"></a>配置HAProxy和Jetty</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="http2-configuring-haproxy.html#http2-haproxy-install">安装HAProxy</a></span></dt><dt><span class="section"><a href="http2-configuring-haproxy.html#http2-haproxy-ssl">为HAProxy设置SSL</a></span></dt><dt><span class="section"><a href="http2-configuring-haproxy.html#http2-haproxy-cfg">HAProxy配置文件</a></span></dt><dt><span class="section"><a href="http2-configuring-haproxy.html#http2-haproxy-jetty">为HTTP / 2和HTTP / 1.1设置Jetty</a></span></dt></dl></div><p>典型的网站部署将Apache（或Nginx）配置为反向代理，以与一个或多个后端Jetty实例进行通信。此配置不能用于HTTP / 2，因为Apache尚不支持HTTP / 2（Nginx也不支持）。</p><p><a class="link" href="http://haproxy.org" target="_top">HAProxy</a>是一个开源解决方案，可为基于TCP和HTTP的应用程序提供负载平衡和代理，当用作反向代理时，可以替代Apache或Nginx，并具有支持HTTP / 2的主要优点。它还提供了负载平衡和其他一些功能，可以将其完全替代Apache或Nginx。</p><p>此处建议的部署将使HAProxy扮演Apache和Nginx通常执行的角色：执行TLS卸载（即解密和加密TLS），然后将当前的纯文本流量转发到后端Jetty服务器，使用HTTP / 1.1或HTTP / 2。</p><p>以下说明适用于Linux。</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="http2-haproxy-install"></a>安装HAProxy</h3></div></div></div><p>您将需要HAProxy 1.5或更高版本，因为它提供了HTTP / 2所需的SSL和ALPN支持。大多数Linux发行版都提供开箱即用的HAProxy软件包。例如在Ubuntu 15.04上：</p><div class="screenexample"><pre class="screen">$ sudo apt-get install haproxy</pre></div><p>或者，您可以按照HAProxy源代码tarball随附的自述文件下载HAProxy源代码并在您的环境中构建它。</p><div class="blockquote"><blockquote class="blockquote"><div class="note" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title"><i class="fa fa-asterisk" aria-hidden="true"></i>注意</h3><p>HAProxy仅在使用OpenSSL 1.0.2或更高版本构建时才支持ALPN。使用<code class="literal">haproxy -vv</code>了解使用哪个OpenSSL版本HAProxy构建。</p></div></blockquote></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="http2-haproxy-ssl"></a>为HAProxy设置SSL</h3></div></div></div><p>HAProxy将比Java实现更有效地执行TLS解密和加密。</p><p>HAProxy将需要一个包含X509证书和私钥的文件，所有文件均为<a class="link" href="https://en.wikipedia.org/wiki/X.509" target="_top">PEM格式</a> ，并且顺序如下：</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">现场证书；此证书的公用名指站点域（例如：CN = *。webtide.com），并由1号证书颁发机构签名。</li><li class="listitem">证书颁发机构＃1证书；该证书可以由2号证书颁发机构签名。</li><li class="listitem">证书颁发机构＃2证书；该证书可以由3号证书颁发机构签名；直到根证书颁发机构。</li><li class="listitem">根证书颁发机构证书。</li><li class="listitem">与站点证书相对应的私钥。</li></ol></div><p>让我们用<code class="literal">keytool</code>生成自签名证书：</p><div class="screenexample"><pre class="screen">$ keytool -genkeypair -keyalg RSA -keystore keystore.p12 -storetype pkcs12 -storepass storepwd -ext SAN=DNS:domain.com
What is your first and last name?
[Unknown]:  *.domain.com
What is the name of your organizational unit?
[Unknown]:  Unit
What is the name of your organization?
[Unknown]:  Domain
What is the name of your City or Locality?
[Unknown]:  Torino
What is the name of your State or Province?
[Unknown]:  TO
What is the two-letter country code for this unit?
[Unknown]:  IT
Is CN=*.domain.com, OU=Unit, O=Domain, L=Torino, ST=TO, C=IT correct?
[no]:  yes</pre></div><p>上面的命令将生成一个自签名证书和私钥，用于<code class="literal">domain.com</code>和子域，存储在<code class="literal">keystore.p12</code> PKCS＃12格式的文件。我们需要以PEM格式提取证书和私钥。</p><p>将证书提取到<code class="literal">certificate.pem</code> ：</p><div class="screenexample"><pre class="screen">$ keytool -exportcert -keystore keystore.p12 -storetype pkcs12 -storepass storepwd -rfc -file certificate.pem</pre></div><p>要将私钥导出到<code class="literal">private_key.pem</code> ：</p><div class="screenexample"><pre class="screen">$ openssl pkcs12 -in keystore.p12 -nodes -nocerts -out private_key.pem -passin pass:storepwd</pre></div><p>此时，您只需要按照正确的顺序将两个文件连接为一个即可：</p><div class="screenexample"><pre class="screen">$ cat certificate.pem private_key.pem &gt; domain.pem</pre></div><p>的<code class="literal">domain.pem</code>该文件将稍后由HAProxy使用。</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="http2-haproxy-cfg"></a> HAProxy配置文件</h3></div></div></div><p>现在我们可以设置<code class="literal">haproxy.cfg</code>配置HAProxy。这是最小配置：</p><pre class="screen">global
tune.ssl.default-dh-param 1024

defaults
timeout connect 10000ms
timeout client 60000ms
timeout server 60000ms

frontend fe_http
mode http
bind *:80
# Redirect to https
redirect scheme https code 301

frontend fe_https
mode tcp
bind *:443 ssl no-sslv3 crt domain.pem ciphers TLSv1.2 alpn h2,http/1.1
default_backend be_http

backend be_http
mode tcp
server domain 127.0.0.1:8282</pre><p>HAProxy配置文件以以下方式工作。的<code class="literal">fe_http</code>前端接受端口80上的连接，并将其重定向以使用<code class="literal">https</code>方案。</p><p>的<code class="literal">fe_https</code>前端接受端口443上的连接，这是TLS解密/加密的地方。您必须指定包含TLS密钥材料的PEM文件的路径（ <code class="literal">crt domain.pem</code>部分），适用于HTTP / 2的密码（ <code class="literal">ciphers TLSv1.2</code> ），并支持ALPN协议（ <code class="literal">alpn h2,http/1.1</code> ）。然后，该前端将当前解密的字节转发到后端<code class="literal">mode tcp</code> 。的<code class="literal">mode tcp</code>表示HAProxy不会尝试将字节解释为HTTP / 1.1，而是不透明地将其转发到后端。</p><p>的<code class="literal">be_http</code>后端将转发（再次<code class="literal">mode tcp</code> ）到Jetty连接器的纯文本字节，该连接器在端口8282上讨论纯文本HTTP / 2和HTTP / 1.1。</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="http2-haproxy-jetty"></a>为HTTP / 2和HTTP / 1.1设置Jetty</h3></div></div></div><p>Jetty设置遵循将Jetty安装在<code class="literal">JETTY_HOME</code>目录，创建一个<code class="literal">JETTY_BASE</code>目录并使用Jetty的命令行工具对其进行初始化。您必须启用<code class="literal">http2c</code>模块，即讲明文HTTP / 2的模块。自从<code class="literal">http2c</code>模块取决于<code class="literal">http</code>模块， <code class="literal">http</code>模块将暂时启用，因此最终设置将以明文形式支持HTTP / 2和HTTP / 1.1。</p><p>此外，您还将启用<code class="literal">deploy</code>能够部署示例Web应用程序的模块：</p><div class="screenexample"><pre class="screen">$ JETTY_BASE=haproxy-jetty-http2
$ mkdir $JETTY_BASE
$ cd $JETTY_BASE
$ java -jar $JETTY_HOME/start.jar --add-to-start=http2c,deploy</pre></div><p>现在，让我们部署一个演示Web应用程序并启动Jetty：</p><div class="screenexample"><pre class="screen">$ cd $JETTY_BASE
$ cp $JETTY_HOME/demo-base/webapps/async-rest.war $JETTY_BASE/webapps/
$ java -jar $JETTY_HOME/start.jar jetty.http.host=127.0.0.1 jetty.http.port=8282</pre></div><p>现在您可以浏览<a class="link" href="https://domain.com/async-rest" target="_top">https://domain.com/async-rest</a> （替换<code class="literal">domain.com</code>与您自己的域，或与<code class="literal">localhost</code> ，以使该示例正常工作）。</p><div class="blockquote"><blockquote class="blockquote"><div class="note" xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title"><i class="fa fa-asterisk" aria-hidden="true"></i>注意</h3><p>您希望在端口8282上侦听的Jetty连接器仅对HAProxy可用，而对远程客户端不可用。因此，您要指定<code class="literal">jetty.http.host</code>命令行上的属性（或在<code class="literal">start.ini</code> / <code class="literal">start.d/http.ini</code> （使该设置保持不变）仅在环回接口（127.0.0.1）上绑定Jetty连接器，使其对HAProxy可用，但对远程客户端不可用。如果您的Jetty实例在其他计算机和/或其他（子）网络上运行，则可能需要同时调整HAProxy配置文件的后端部分和<code class="literal">jetty.http.host</code>属性以进行相应匹配。</p></div></blockquote></div><p>支持HTTP / 2的浏览器将连接到HAProxy，后者将解密流量并将其发送到Jetty。同样，HTTP / 1.1客户端将连接到HAProxy，后者将解密流量并将其发送到Jetty。</p><p>Jetty连接器，配置有<code class="literal">http2c</code>模块（因此与<code class="literal">http</code>模块）能够区分传入的字节是HTTP / 2还是HTTP / 1.1，并将相应地处理请求。</p><p>响应被中继回HAProxy，HAProxy将对其进行加密并将其发送回远程客户端。</p><p>此配置为不支持HTTP / 1.1的客户端提供了有效的TLS卸载，HTTP / 2支持以及对HTTP / 1.1的透明回退。</p></div></div><script type="text/javascript">
      SyntaxHighlighter.all()
    </script><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tbody><tr><td width="40%" align="left"><a href="http2-configuring-push.html" accesskey="p"><i class="fa fa-chevron-left" aria-hidden="true"></i>以前</a> </td><td width="20%" align="center"><a href="http2.html" accesskey="u"><i class="fa fa-chevron-up" aria-hidden="true"></i>最佳</a></td><td width="40%" align="right"> <a href="fastcgi.html" accesskey="n">下一个<i class="fa fa-chevron-right" aria-hidden="true"></i></a></td></tr><tr><td width="40%" align="left" valign="top">配置HTTP / 2推送</td><td width="20%" align="center"><a href="index.html" accesskey="h"><i class="fa fa-home" aria-hidden="true"></i>家</a></td><td width="40%" align="right" valign="top">第十七章FastCGI支持</td></tr></tbody></table></div><p xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times"></p><div class="jetty-callout">看到错误或缺少的东西？
            <span class="callout"><a href="http://github.com/eclipse/jetty.project">在以下位置对此文档做出贡献<span class="website"><i class="fa fa-github" aria-hidden="true"></i> Github！</span></a></span> <span style="float:right"><i>（产生：2019-11-20）</i></span></div><p></p></body></html>