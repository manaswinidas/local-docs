<html ><!-- 
Copyright (C) 1989, 1991, 1992, 1993, 1996-2005, 2007, 2009-2019 

Free Software Foundation, Inc.



This is Edition 5.0 of GAWK: Effective AWK Programming: A User's Guide for GNU Awk,
for the 5.0.0 (or later) version of the GNU
implementation of AWK.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "GNU General Public License", with the
Front-Cover Texts being "A GNU Manual", and with the Back-Cover Texts
as in (a) below.
A copy of the license is included in the section entitled
"GNU Free Documentation License".

a. The FSF's Back-Cover Text is: "You have the freedom to
copy and modify this GNU manual." --><!-- Created by GNU Texinfo 6.5, http://www.gnu.org/software/texinfo/ --><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>提取程序（《 GNU Awk用户指南》）</title>

<meta name="description" content="Extract Program (The GNU Awk User’s Guide)">
<meta name="keywords" content="Extract Program (The GNU Awk User’s Guide)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html#Top" rel="start" title="Top">
<link href="Index.html#Index" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Miscellaneous-Programs.html#Miscellaneous-Programs" rel="up" title="Miscellaneous Programs">
<link href="Simple-Sed.html#Simple-Sed" rel="next" title="Simple Sed">
<link href="History-Sorting.html#History-Sorting" rel="prev" title="History Sorting">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
blockquote.smallindentedblock {margin-right: 0em; font-size: smaller}
blockquote.smallquotation {font-size: smaller}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
div.smalldisplay {margin-left: 3.2em}
div.smallexample {margin-left: 3.2em}
div.smalllisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
pre.smalldisplay {font-family: inherit; font-size: smaller}
pre.smallexample {font-size: smaller}
pre.smallformat {font-family: inherit; font-size: smaller}
pre.smalllisp {font-size: smaller}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="/software/gnulib/manual.css">


</head>

<body lang="zh-Hans" >
<a name="Extract-Program"></a>
<div class="header">
<p>下一篇： <a href="Simple-Sed.html#Simple-Sed" rel="next" accesskey="n">Simple Sed</a> ，上一篇： <a href="History-Sorting.html#History-Sorting" rel="prev" accesskey="p">历史排序</a> ，上一篇： <a href="Miscellaneous-Programs.html#Miscellaneous-Programs" rel="up" accesskey="u">其他程序</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Index.html#Index" title="指数" rel="index">索引</a> ]</p>
</div>
<hr>
<a name="Extracting-Programs-from-Texinfo-Source-Files"></a>
<h4 class="subsection">11.3.7从Texinfo源文件中提取程序</h4>

<a name="index-Texinfo_002c-extracting-programs-from-source-files"></a>
<a name="index-files_002c-Texinfo_002c-extracting-programs-from"></a>
<p>无论本章和上一章（ <a href="Library-Functions.html#Library-Functions">库<code>awk</code>函数</a> ）呈现大量<code>awk</code>程式。如果您想试验这些程序，那么手工输入它们是很麻烦的。在这里，我们提供了一个程序，该程序可以将Texinfo输入文件的一部分提取到单独的文件中。
</p>
<a name="index-Texinfo-3"></a>
<p>该网页使用<a href="https://www.gnu.org/software/texinfo/">Gex</a> Project的文档格式语言<a href="https://www.gnu.org/software/texinfo/">Texinfo</a>编写。单个Texinfo源文件可用于生成带有TeX的印刷文档和在线文档。（Texinfo在《 <cite>Texinfo-GNU文档格式</cite> 》一书中有完整记录，可从Free Software Foundation获得，也可以<a href="https://www.gnu.org/software/texinfo/manual/texinfo/">在线获得</a> 。）
</p>
<p>就我们的目的而言，足够了解有关Texinfo输入文件的三件事：</p>
<ul>
<li>“ at”符号（“ <samp>@</samp> '）在Texinfo中很特殊，就像反斜杠（' <samp>\</samp> '）在C或<code>awk</code> 。文字' <samp>@</samp> '符号在Texinfo源文件中表示为' <samp>@@</samp> '。

</li><li>注释以“ <samp>@c</samp> ' 要么 ' <samp>@comment</samp> '。文件提取程序通过使用从行首开始的特殊注释来工作。

</li><li>包含“ <samp>@group</samp> '和' <samp>@end group</samp> '命令将示例文本括在括号内，这些文本不应跨页面边界分割。（不幸的是，TeX并不总是足够聪明来做正确的事情，因此我们必须提供一些帮助。）
</li></ul>

<p>以下程序， <samp>extract.awk</samp>会根据特殊注释读取Texinfo源文件并执行两项操作。看到“ <samp>@c system …
<!-- /@w --></samp> '，它通过从控制行提取命令文本并将其传递到<code>system()</code>功能（请参见<a href="I_002fO-Functions.html#I_002fO-Functions">输入/输出功能部分</a> ）。看到“ <samp>@c file <var>filename</var></samp> '，随后的每一行都发送到文件<var>filename</var> ， 直到 ' <samp>@c endfile</samp>遇到了。中的规则<samp>extract.awk</samp>匹配任一<samp>@c</samp> ' 要么 ' <samp>@comment</samp>通过让“ <samp>omment</samp>部分是可选的。包含“ <samp>@group</samp> '和' <samp>@end group</samp>只需删除即可。
<samp>extract.awk</samp>使用<code>join()</code>库函数（请参见<a href="Join-Function.html#Join-Function">将数组合并为String一节</a> ）。
</p>
<p>在线Texinfo源中的<cite>GAWK</cite>示例程序<cite>：有效的AWK编程</cite> （ <samp>gawktexi.in</samp> ）都放在方括号内' <samp>file</samp> '和' <samp>endfile</samp> '行。的<code>gawk</code>发行版使用的副本<samp>extract.awk</samp>提取示例程序并将它们中的许多安装在标准目录中<code>gawk</code>可以找到他们。Texinfo文件看起来像这样：</p>
<div class="example">
<pre class="example">&hellip;
This program has a @code{BEGIN} rule
that prints a nice message:

@example
@c file examples/messages.awk
BEGIN @{ print &quot;Don't panic!&quot; @}
@c endfile
@end example

It also prints some final advice:

@example
@c file examples/messages.awk
END @{ print &quot;Always avoid bored archaeologists!&quot; @}
@c endfile
@end example
&hellip;
</pre></div>

<p><samp>extract.awk</samp>从设置开始<code>IGNORECASE</code>到1，这样指令中混合使用大小写字母就没有关系了。
</p>
<p>第一条规则处理呼叫<code>system()</code> ，检查是否已给出命令（ <code>NF</code>至少为3），并检查退出状态是否为零（表示OK）：</p>
<a name="index-extract_002eawk-program"></a>
<div class="example">
<pre class="example"># extract.awk --- extract files and run programs from Texinfo files

BEGIN    { IGNORECASE = 1 }

/^@c(omment)?[ \t]+system/ {
    if (NF &lt; 3) {
        e = (&quot;extract: &quot; FILENAME &quot;:&quot; FNR)
        e = (e  &quot;: badly formed `system' line&quot;)
        print e &gt; &quot;/dev/stderr&quot;
        next
    }
    $1 = &quot;&quot;
    $2 = &quot;&quot;
    stat = system($0)
    if (stat != 0) {
        e = (&quot;extract: &quot; FILENAME &quot;:&quot; FNR)
        e = (e &quot;: warning: system returned &quot; stat)
        print e &gt; &quot;/dev/stderr&quot;
    }
}
</pre></div>

<p>变量<code>e</code>用于使规则很好地适合屏幕。
</p>
<p>第二条规则处理将数据移入文件。它验证指令中是否提供了文件名。如果命名的文件不是当前文件，则关闭当前文件。在遇到新文件之前，保持当前文件打开状态，可以使用“ <samp>></samp>重定向以打印内容，使打开文件的管理变得简单。
</p>
<p>的<code>for</code>循环工作。它使用读取行<code>getline</code> （请参阅<a href="Getline.html#Getline">使用<code>getline</code></a> ）。对于意外的文件结尾，它将调用<code><span class="nolinebreak">unexpected_eof()</span>
<!-- /@w --></code>功能。如果该行是“ endfile”行，则它将退出循环。如果该行是“ <samp>@group</samp> ' 要么 ' <samp>@end group</samp> '，则忽略它并继续下一行。同样，示例中的注释也将被忽略。
</p>
<p>大部分工作在以下几行中。如果该行没有' <samp>@</samp> '符号，程序可以直接打印。否则，每个前导' <samp>@</samp> '必须脱掉。删除“ <samp>@</samp> '符号，将行拆分为数组的单独元素<code>a</code> ， 使用<code>split()</code>函数（请参阅“ <a href="String-Functions.html#String-Functions">字符串操作函数”</a>一节）。' <samp>@</samp> '符号用作分隔符。每个元素<code>a</code>为空表示连续两个' <samp>@</samp>原始行中的符号。对于每两个空元素（' <samp>@@</samp> '（在原始文件中），我们必须添加一个' <samp>@</samp> '符号重新插入。
</p>
<p>数组处理完成后， <code>join()</code>的值称为<code>SUBSEP</code> （请参阅“ <a href="Multidimensional.html#Multidimensional">多维数组”</a>一节），以将片段重新合并为一行。然后将该行打印到输出文件：</p>
<div class="example">
<pre class="example">/^@c(omment)?[ \t]+file/ {
    if (NF != 3) {
        e = (&quot;extract: &quot; FILENAME &quot;:&quot; FNR &quot;: badly formed `file' line&quot;)
        print e &gt; &quot;/dev/stderr&quot;
        next
    }
    if ($3 != curfile) {
        if (curfile != &quot;&quot;)
            filelist[curfile] = 1   # save to close later
        curfile = $3
    }

    for (;;) {
        if ((getline line) &lt;= 0)
            unexpected_eof()
        if (line ~ /^@c(omment)?[ \t]+endfile/)
            break
        else if (line ~ /^@(end[ \t]+)?group/)
            continue
        else if (line ~ /^@c(omment+)?[ \t]+/)
            continue
        if (index(line, &quot;@&quot;) == 0) {
            print line &gt; curfile
            continue
        }
        n = split(line, a, &quot;@&quot;)
        # if a[1] == &quot;&quot;, means leading @,
        # don't add one back in.
        for (i = 2; i &lt;= n; i++) {
            if (a[i] == &quot;&quot;) { # was an @@
                a[i] = &quot;@&quot;
                if (a[i+1] == &quot;&quot;)
                    i++
            }
        }
</pre><pre class="example">        print join(a, 1, n, SUBSEP) &gt; curfile
    }
}
</pre></div>

<p>需要注意的重要一件事是使用“ <samp>></samp>重定向。输出用' <samp>></samp> '只打开一次文件；它保持打开状态，随后的输出将附加到文件中（请参阅<a href="Redirection.html#Redirection">重定向输出<code>print</code>和<code>printf</code></a> ）。这样可以很容易地将程序文本和解释性散文混合到同一示例源文件中（如此处所述！）。没有任何麻烦。仅当遇到新的数据文件名或在输入文件的末尾时才关闭文件。
</p>
<p>遇到新文件名时，程序将关闭当前文件的名称，而不是关闭文件。 <code>filelist</code> 。这样就可以在Texinfo输入文件中交错多个文件的代码。（此程序的先前版本<em>确实</em>关闭了文件。但是由于“ <samp>></samp>重定向，该文件的各个部分之间的关系并没有完全解决。）一个<code>END</code>规则然后在处理完成后关闭所有打开的文件：</p>
<div class="example">
<pre class="example">END {
    close(curfile)          # close the last one
    for (f in filelist)     # close all the rest
        close(f)
}
</pre></div>

<p>最后，功能<code><span class="nolinebreak">unexpected_eof()</span>
<!-- /@w --></code>显示适当的错误消息，然后退出：</p>
<div class="example">
<pre class="example">function unexpected_eof()
{
    printf(&quot;extract: %s:%d: unexpected EOF or error\n&quot;,
                     FILENAME, FNR) &gt; &quot;/dev/stderr&quot;
    exit 1
}
</pre></div>

<hr>
<div class="header">
<p>下一篇： <a href="Simple-Sed.html#Simple-Sed" rel="next" accesskey="n">Simple Sed</a> ，上一篇： <a href="History-Sorting.html#History-Sorting" rel="prev" accesskey="p">历史排序</a> ，上一篇： <a href="Miscellaneous-Programs.html#Miscellaneous-Programs" rel="up" accesskey="u">其他程序</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Index.html#Index" title="指数" rel="index">索引</a> ]</p>
</div>





</body></html>