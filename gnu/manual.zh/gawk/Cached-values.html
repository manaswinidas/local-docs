<html ><!-- 
Copyright (C) 1989, 1991, 1992, 1993, 1996-2005, 2007, 2009-2019 

Free Software Foundation, Inc.



This is Edition 5.0 of GAWK: Effective AWK Programming: A User's Guide for GNU Awk,
for the 5.0.0 (or later) version of the GNU
implementation of AWK.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "GNU General Public License", with the
Front-Cover Texts being "A GNU Manual", and with the Back-Cover Texts
as in (a) below.
A copy of the license is included in the section entitled
"GNU Free Documentation License".

a. The FSF's Back-Cover Text is: "You have the freedom to
copy and modify this GNU manual." --><!-- Created by GNU Texinfo 6.5, http://www.gnu.org/software/texinfo/ --><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>缓存的值（《 GNU Awk用户指南》）</title>

<meta name="description" content="Cached values (The GNU Awk User’s Guide)">
<meta name="keywords" content="Cached values (The GNU Awk User’s Guide)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html#Top" rel="start" title="Top">
<link href="Index.html#Index" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Symbol-Table-Access.html#Symbol-Table-Access" rel="up" title="Symbol Table Access">
<link href="Array-Manipulation.html#Array-Manipulation" rel="next" title="Array Manipulation">
<link href="Symbol-table-by-cookie.html#Symbol-table-by-cookie" rel="prev" title="Symbol table by cookie">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
blockquote.smallindentedblock {margin-right: 0em; font-size: smaller}
blockquote.smallquotation {font-size: smaller}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
div.smalldisplay {margin-left: 3.2em}
div.smallexample {margin-left: 3.2em}
div.smalllisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
pre.smalldisplay {font-family: inherit; font-size: smaller}
pre.smallexample {font-size: smaller}
pre.smallformat {font-family: inherit; font-size: smaller}
pre.smalllisp {font-size: smaller}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="manual.css">


</head>

<body lang="zh-Hans" >
<a name="Cached-values"></a>
<div class="header">
<p>上一页： <a href="Symbol-table-by-cookie.html#Symbol-table-by-cookie" rel="prev" accesskey="p">通过cookie建立符号表</a> ，向上： <a href="Symbol-Table-Access.html#Symbol-Table-Access" rel="up" accesskey="u">访问符号表</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Index.html#Index" title="指数" rel="index">索引</a> ]</p>
</div>
<hr>
<a name="Creating-and-Using-Cached-Values"></a>
<h4 class="subsubsection">17.4.10.3创建和使用缓存的值</h4>

<p>本节中的例程允许您创建和释放缓存的值。与标量cookie一样，从理论上讲，不需要缓存值。您可以使用<a href="Constructor-Functions.html#Constructor-Functions">构造函数中</a>的函数创建数字和字符串。然后，您可以使用以下方式将这些值分配给变量<code>sym_update()</code>要么<code>sym_update_scalar()</code> ， 随你便。
</p>
<p>但是，如果您记得<em>每个</em>字符串值的存储都<em>必须</em>来自以下位置，则可以理解缓存值的含义： <code>gawk_malloc()</code> ， <code>gawk_calloc()</code> ， 要么<code>gawk_realloc()</code> 。如果您有20个变量，所有变量都具有相同的字符串值，则必须创建20个相同的字符串副本。 <a name="DOCF108" href="#FOOT108"><sup>108</sup></a>
</p>
<p>如果可能的话，一次创建一个值然后告诉您显然更有效<code>gawk</code>将值重复用于多个变量。这就是本节中的例程允许您执行的操作。功能如下：</p>
<dl compact>
<dt><code>awk_bool_t create_value(awk_value_t *value, awk_value_cookie_t *result);</code></dt>
<dd><p>从中创建缓存的字符串或数值<code>value</code>以便以后进行高效分配。仅类型的值<code>AWK_NUMBER</code> ， <code>AWK_REGEX</code> ， <code>AWK_STRNUM</code>和<code>AWK_STRING</code>被允许。任何其他类型均被拒绝。
<code>AWK_UNDEFINED</code>可以允许，但这样做会导致性能降低。
</p>
</dd>
<dt><code>awk_bool_t release_value(awk_value_cookie_t vc);</code></dt>
<dd><p>释放与从中获取的值cookie相关联的内存<code>create_value()</code> 。
</p></dd>
</dl>

<p>您使用价值Cookie的方式类似于使用标量Cookie的方式。在扩展初始化例程中，创建值cookie：</p>
<div class="example">
<pre class="example">static awk_value_cookie_t answer_cookie;  /* static value cookie */

static void
my_extension_init()
{
    awk_value_t value;
    char *long_string;
    size_t long_string_len;

    /* code from earlier */
    &hellip;
    /* &hellip; fill in long_string and long_string_len &hellip; */
    make_malloced_string(long_string, long_string_len, &amp; value);
    create_value(&amp; value, &amp; answer_cookie);    /* create cookie */
    &hellip;
}
</pre></div>

<p>一旦创建了值，就可以将其用作任意数量的变量的值：</p>
<div class="example">
<pre class="example">static awk_value_t *
do_magic(int nargs, awk_value_t *result)
{
    awk_value_t new_value;

    &hellip;    /* as earlier */

    value.val_type = AWK_VALUE_COOKIE;
    value.value_cookie = answer_cookie;
    sym_update(&quot;VAR1&quot;, &amp; value);
    sym_update(&quot;VAR2&quot;, &amp; value);
    &hellip;
    sym_update(&quot;VAR100&quot;, &amp; value);
    &hellip;
}
</pre></div>

<p>以这种方式使用有价Cookie可以节省大量存储空间，因为所有<code>VAR1</code>通过<code>VAR100</code>分享相同的价值。
</p>
<p>您可能想知道，“共享是否有问题？如果发生什么情况<code>awk</code>代码为分配一个新值<code>VAR1</code> ;其他所有人也都改变了吗？”
</p>
<p>这是一个很好的问题。答案是不，这不是问题。在内部， <code>gawk</code>使用<em>引用计数的字符串</em> 。这意味着许多变量可以共享相同的字符串值，并且<code>gawk</code>跟踪使用情况。当变量的值改变时， <code>gawk</code>只需减少对旧值的引用计数，并更新变量以使用新值。
</p>
<p>最后，作为清理操作的一部分（请参阅<a href="Exit-Callback-Functions.html#Exit-Callback-Functions">注册退出回调函数部分</a> ），您应该使用以下方法释放您创建的所有缓存值： <code>release_value()</code> 。
</p>
<div class="footnote">
<hr>
<h4 class="footnotes-heading">脚注</h4>

<h3><a name="FOOT108" href="#DOCF108">（108）</a></h3>
<p>数值显然没有问题，只需要C <code>double</code>储藏。但是，当然，GMP和MPFR值<em>确实</em>会占用更多内存。</p>
</div>
<hr>
<div class="header">
<p>上一页： <a href="Symbol-table-by-cookie.html#Symbol-table-by-cookie" rel="prev" accesskey="p">通过cookie建立符号表</a> ，向上： <a href="Symbol-Table-Access.html#Symbol-Table-Access" rel="up" accesskey="u">访问符号表</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Index.html#Index" title="指数" rel="index">索引</a> ]</p>
</div>





</body></html>