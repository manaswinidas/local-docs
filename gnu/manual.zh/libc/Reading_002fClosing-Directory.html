<html ><!-- This file documents the GNU C Library.

This is
The GNU C Library Reference Manual, for version
2.30.

Copyright (C) 1993-2019 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version
1.3 or any later version published by the Free
Software Foundation; with the Invariant Sections being "Free Software
Needs Free Documentation" and "GNU Lesser General Public License",
the Front-Cover texts being "A GNU Manual", and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License".

(a) The FSF's Back-Cover Text is: "You have the freedom to
copy and modify this GNU manual.  Buying copies from the FSF
supports it in developing GNU and promoting software freedom." --><!-- Created by GNU Texinfo 6.6, http://www.gnu.org/software/texinfo/ --><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>读取/关闭目录（GNU C库）</title>

<meta name="description" content="Reading/Closing Directory (The GNU C Library)">
<meta name="keywords" content="Reading/Closing Directory (The GNU C Library)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html#Top" rel="start" title="Top">
<link href="Concept-Index.html#Concept-Index" rel="index" title="Concept Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Accessing-Directories.html#Accessing-Directories" rel="up" title="Accessing Directories">
<link href="Simple-Directory-Lister.html#Simple-Directory-Lister" rel="next" title="Simple Directory Lister">
<link href="Opening-a-Directory.html#Opening-a-Directory" rel="prev" title="Opening a Directory">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>


</head>

<body lang="zh-Hans" >
<span id="Reading_002fClosing-Directory"></span><div class="header">
<p>下一页： <a href="Simple-Directory-Lister.html#Simple-Directory-Lister" rel="next" accesskey="n">简单目录列表器</a> ，上一页： <a href="Opening-a-Directory.html#Opening-a-Directory" rel="prev" accesskey="p">打开目录</a> ，向上： <a href="Accessing-Directories.html#Accessing-Directories" rel="up" accesskey="u">访问目录</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>
<hr>
<span id="Reading-and-Closing-a-Directory-Stream"></span><h4 class="subsection">14.2.3读取和关闭目录流</h4>

<span id="index-dirent_002eh-3"></span>
<p>本节介绍如何从目录流中读取目录条目，以及完成后如何关闭流。所有符号都在头文件中声明<samp>dirent.h</samp> 。
</p>
<dl>
<dt id="index-readdir">功能： <em>struct dirent *</em> <strong>readdir</strong> <em>（DIR * <var>dirstream</var> ）</em></dt>
<dd>
<p>初步： MT安全| AS不安全锁| AC不安全锁|请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>

<p>此函数从目录中读取下一个条目。它通常返回一个指向包含有关文件信息的结构的指针。此结构与<var>dirstream</var>句柄，并且可以通过后续调用重写。
</p>
<p><strong>可移植性注意：</strong>在某些系统上<code>readdir</code>可能不会返回的条目<samp>.</samp>和<samp>..</samp> ，即使这些在任何目录中始终都是有效的文件名。请参阅<a href="File-Name-Resolution.html#File-Name-Resolution">文件名解析</a> 。
</p>
<p>如果目录中没有更多条目或检测到错误， <code>readdir</code>返回一个空指针。下列<code>errno</code>为此功能定义了错误条件：</p>
<dl compact>
<dt><code>EBADF</code></dt>
<dd><p>的<var>dirstream</var>参数无效。
</p></dd>
</dl>

<p>要区分目录结束条件还是错误，必须设置<code>errno</code>调用前为零<code>readdir</code> 。为了避免进入无限循环，应该在出现第一个错误后停止从目录中读取。
</p>
<p><strong>注意：</strong>指针返回<code>readdir</code>指向<code>DIR</code>宾语。下次调用该缓冲区时，该缓冲区中的数据将被覆盖。 <code>readdir</code> 。例如，您必须注意复制<code>d_name</code>字符串，如果以后需要的话。
</p>
<p>因此，共享一个<code>DIR</code>多个线程中的对象，除非您使用自己的锁定来确保没有线程调用<code>readdir</code>而另一个线程仍在使用上一次调用中的数据。在GNU C库中，可以安全地调用<code>readdir</code>只要每个线程都使用自己的线程<code>DIR</code>宾语。POSIX.1-2008并不要求这样做是安全的，但是我们不知道任何无法正常运行的操作系统。
</p>
<p><code>readdir_r</code>允许您为<code>struct dirent</code> ，但是它不如<code>readdir</code> ，并且文件名过长存在问题（请参见下文）。我们建议您使用<code>readdir</code> ，但不分享<code>DIR</code>对象。
</p></dd></dl>

<dl>
<dt id="index-readdir_005fr">函数： <em>int</em> <strong>readdir_r</strong> <em>（DIR * <var>dirstream</var> ，结构差异* <var>entry</var> ，结构差异** <var>result</var> ）</em></dt>
<dd>
<p>初步： MT安全| AS不安全锁| AC不安全锁|请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>

<p>此功能是<code>readdir</code>执行内部锁定。喜欢<code>readdir</code>它返回目录中的下一个条目。为了防止同时运行的线程之间发生冲突，结果存储在<var>entry</var>宾语。
</p>
<p><strong>便携性注意事项：</strong> <code>readdir_r</code>不推荐使用。建议使用<code>readdir</code>代替<code>readdir_r</code>出于以下原因：</p>
<ul>
<li>在未定义的系统上<code>NAME_MAX</code> ，可能无法使用<code>readdir_r</code>安全，因为调用方未指定目录条目的缓冲区长度。

</li><li>在某些系统上<code>readdir_r</code>无法读取名称很长的目录条目。如果遇到这样的名称，则GNU C库实现<code>readdir_r</code>返回错误代码为<code>ENAMETOOLONG</code>在读取最终目录条目之后。在其他系统上， <code>readdir_r</code>可能会成功返回，但是<code>d_name</code>成员可能没有NUL终止或被截断。

</li><li>POSIX-1.2008不保证<code>readdir</code>是线程安全的，即使访问相同<var>dirstream</var>被序列化。但是在当前的实现中（包括GNU C库），可以安全地调用<code>readdir</code>同时在不同<var>dirstream</var> s，因此无需使用<code>readdir_r</code>在大多数多线程程序中。在极少数情况下，多个线程需要从同一线程读取<var>dirstream</var> ，还是更好用<code>readdir</code>和外部同步。

</li><li>预计将来的POSIX版本将过时<code>readdir_r</code>并规定了线程的安全级别<code>readdir</code>由GNU C库和当今的其他实现提供。
</li></ul>

<p>一般<code>readdir_r</code>返回零并设置<code>*<var>result</var></code>至<var>entry</var> 。如果目录中没有更多条目或检测到错误， <code>readdir_r</code>套<code>*<var>result</var></code>返回空指针并返回非零错误代码，该代码也存储在<code>errno</code> ，如针对<code>readdir</code> 。
</p>
<p>同样重要的是要看一下<code>struct dirent</code>类型。只需将指针传递给此类对象的第二个参数<code>readdir_r</code>可能还不够。一些系统没有定义<code>d_name</code>元素足够长。在这种情况下，用户必须提供额外的空间。必须至少有空间<code>NAME_MAX + 1</code>中的字符<code>d_name</code>数组。调用代码<code>readdir_r</code>可能看起来像这样：</p>
<div class="example">
<pre class="example">  union
  {
    struct dirent d;
    char b[offsetof (struct dirent, d_name) + NAME_MAX + 1];
  } u;

  if (readdir_r (dir, &amp;u.d, &amp;res) == 0)
    &hellip;
</pre></div>
</dd></dl>

<p>为了在32位计算机上支持大型文件系统，有最后两个功能的LFS变体。
</p>
<dl>
<dt id="index-readdir64">功能： <em>struct dirent64 *</em> <strong>readdir64</strong> <em>（DIR * <var>dirstream</var> ）</em></dt>
<dd>
<p>初步： MT安全| AS不安全锁| AC不安全锁|请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>

<p>的<code>readdir64</code>功能就像<code>readdir</code>函数，除了它返回指向记录类型的指针<code>struct dirent64</code> 。此数据类型的某些成员（特别是<code>d_ino</code> ）的大小可能会有所不同，以允许使用大型文件系统。
</p>
<p>在所有其他方面，此功能等效于<code>readdir</code> 。
</p></dd></dl>

<dl>
<dt id="index-readdir64_005fr">函数： <em>int</em> <strong>readdir64_r</strong> <em>（DIR * <var>dirstream</var> ，struct dirent64 * <var>entry</var> ，struct dirent64 ** <var>result</var> ）</em></dt>
<dd>
<p>初步： MT安全| AS不安全锁| AC不安全锁|请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>

<p>已弃用<code>readdir64_r</code>功能相当于<code>readdir_r</code>功能，除了它采用基本类型的参数<code>struct dirent64</code>代替<code>struct dirent</code>在第二和第三位置。文档中提到的相同预防措施<code>readdir_r</code>也可以在这里申请。
</p></dd></dl>

<dl>
<dt id="index-closedir">函数： <em>int</em> <strong>closeirir</strong> <em>（DIR * <var>dirstream</var> ）</em></dt>
<dd>
<p>初步： MT安全| AS不安全堆锁定/堆| AC不安全的内存fd锁/锁|请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>

<p>此功能关闭目录流<var>dirstream</var> 。它返回<code>0</code>成功与<code>-1</code>失败。
</p>
<p>下列<code>errno</code>为此功能定义了错误条件：</p>
<dl compact>
<dt><code>EBADF</code></dt>
<dd><p>的<var>dirstream</var>参数无效。
</p></dd>
</dl>
</dd></dl>

<hr>
<div class="header">
<p>下一页： <a href="Simple-Directory-Lister.html#Simple-Directory-Lister" rel="next" accesskey="n">简单目录列表器</a> ，上一页： <a href="Opening-a-Directory.html#Opening-a-Directory" rel="prev" accesskey="p">打开目录</a> ，向上： <a href="Accessing-Directories.html#Accessing-Directories" rel="up" accesskey="u">访问目录</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>





</body></html>