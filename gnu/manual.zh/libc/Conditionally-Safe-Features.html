<html ><!-- This file documents the GNU C Library.

This is
The GNU C Library Reference Manual, for version
2.30.

Copyright (C) 1993-2019 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version
1.3 or any later version published by the Free
Software Foundation; with the Invariant Sections being "Free Software
Needs Free Documentation" and "GNU Lesser General Public License",
the Front-Cover texts being "A GNU Manual", and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License".

(a) The FSF's Back-Cover Text is: "You have the freedom to
copy and modify this GNU manual.  Buying copies from the FSF
supports it in developing GNU and promoting software freedom." --><!-- Created by GNU Texinfo 6.6, http://www.gnu.org/software/texinfo/ --><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>有条件的安全功能（GNU C库）</title>

<meta name="description" content="Conditionally Safe Features (The GNU C Library)">
<meta name="keywords" content="Conditionally Safe Features (The GNU C Library)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html#Top" rel="start" title="Top">
<link href="Concept-Index.html#Concept-Index" rel="index" title="Concept Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="POSIX.html#POSIX" rel="up" title="POSIX">
<link href="Other-Safety-Remarks.html#Other-Safety-Remarks" rel="next" title="Other Safety Remarks">
<link href="Unsafe-Features.html#Unsafe-Features" rel="prev" title="Unsafe Features">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>


</head>

<body lang="zh-Hans" >
<span id="Conditionally-Safe-Features"></span><div class="header">
<p>下一篇： <a href="Other-Safety-Remarks.html#Other-Safety-Remarks" rel="next" accesskey="n">其他安全说明</a> ，上一篇： <a href="Unsafe-Features.html#Unsafe-Features" rel="prev" accesskey="p">不安全功能</a> ，上一篇： <a href="POSIX.html#POSIX" rel="up" accesskey="u">POSIX</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>
<hr>
<span id="Conditionally-Safe-Features-1"></span><h4 class="subsubsection">1.2.2.3有条件的安全功能</h4>
<span id="index-Conditionally-Safe-Features"></span>

<p>对于某些使函数在某些情况下不安全调用的功能，除了避免完全调用函数外，还有其他避免安全问题的方法。后面的关键字指的是这样的功能，它们的每个定义都指示如何限制整个程序，以消除关键字所指示的安全问题。仅当通过应用记录的约束观察到和解决了使函数不安全的所有原因后，该函数才可以在上下文中安全调用。
</p>
<ul>
<li> <code>init</code>
<span id="index-init"></span>

<p>标有功能<code>init</code>作为MT-Unsafe功能，在首次调用它们时执行MT-Unsafe初始化。
</p>
<p>在单线程模式下至少调用一次此函数可以消除导致该函数被视为MT不安全的特定原因。如果没有其他原因，可以在启动其他线程之后安全地调用该函数。
</p>
<p>标有功能<code>init</code>作为AS或AC不安全功能，请使用内部<code>libc_once</code>机械或类似的初始化内部数据结构的方法。
</p>
<p>如果信号处理程序中断了此类初始化程序，并调用了也执行任何功能的任何函数<code>libc_once</code>初始化，如果线程库已加载，它将死锁。
</p>
<p>此外，如果初始化程序在被其处理程序需要相同初始化的信号取消或中断之前已部分完成，则部分或全部初始化可能会执行多次，从而浪费资源，甚至导致内部数据损坏。
</p>
<p>需要调用标有的函数的应用程序<code>init</code>作为AS或AC不安全功能，应确保在配置信号处理程序或启用取消功能之前执行初始化，以便AS和AC安全问题与<code>libc_once</code>不会出现。
</p>


</li><li> <code>race</code>
<span id="index-race"></span>

<p>带注释的功能<code>race</code>因为MT安全问题在对象上的运行方式可能会导致并发执行中出现数据争用或类似形式的破坏性干扰。在某些情况下，对象由用户传递给功能；在其他情况下，函数会使用它们将值返回给用户；在其他情况下，它们甚至不会暴露给用户。
</p>
<p>我们认为对作为（间接）参数传递给函数的对象的访问不受数据竞争的影响。保证没有数据争用的对象是调用者的责任。如果用户未能采取POSIX所要求的措施来避免在处理此类对象时发生数据争用，则该函数的行为异常时，我们不会将其标记为MT-不安全或AS-不安全。通常，如果将功能记录为读取（通过引用）传递给该对象的对象，或者对其进行了修改，则用户应使用内存同步原语来避免数据争用，就像他们应该自己执行访问一样，而不是通过调用库函数。 <code>FILE</code>流是一般规则的例外，因为POSIX要求库在许多操作此特定不透明类型对象的函数中防止数据竞争。我们认为这是为用户提供的便利，而不是一般要求，其期望应扩展到其他类型。
</p>
<p>为了提醒用户保护某些参数是他们的责任，我们将对将某些类型的对象作为参数的函数进行注释。我们为用户传递的对象画了一条线，如下所示：对象的类型向用户公开，并且希望用户直接访问的对象，例如内存缓冲区，字符串和各种用户可见的对象<code>struct</code>类型， <em>不</em>给理由要与批注功能<code>race</code> 。对于一般需求而言，这将是嘈杂的和多余的，并且当访问可直接由用户访问的对象时，图书馆缺乏内部保护措施不会令很多人感到惊讶。
</p>
<p>对于不透明或类似不透明的对象，只能通过将其传递给库函数（例如， <code>FILE</code> ， <code>DIR</code> ， <code>obstack</code> ， <code>iconv_t</code> ），对于图书馆内部访问的协调可能会有其他期望。我们将用<code>race</code>后面跟一个冒号和参数名称，这些函数接受此类对象，但默认情况下并不负责同步对其的访问。例如， <code>FILE</code>流<code>unlocked</code>函数将被注释，但是那些在函数上执行隐式锁定的函数<code>FILE</code>即使可以在每个流的基础上禁用隐式锁定，默认情况下流也不会。
</p>
<p>无论哪种情况，我们都不会将MT-Unsafe功能视为如果用户未能确保对访问的定义正确，则可能以不安全的方式访问用户提供的对象。人们普遍认为，应该期望用户防止库代表他们访问的任何用户提供的对象发生数据争用。
</p>

<p>但是，此用户责任不适用于由库本身控制的对象，例如用于从某些调用返回值的内部对象和静态缓冲区。如果图书馆未禁止它们同时使用，则将这些情况视为MT不安全和AS不安全（尽管<code>race</code> AS-Unsafe下的标记将被省略，因为与MT-Unsafe下的标记是多余的）。与用户暴露的对象一样，标记后面可能带有冒号和标识符。标识符将在某个不受保护的对象上运行的所有功能分组；用户可以通过创建与标识符相关的非递归互斥体，并在调用该标识符上标记为“惯性”的任何函数时始终保持互斥体来避免与无保护地并发访问此类内部对象有关的MT安全问题，因为他们必须这样做标识符应为用户控制下的对象。非递归互斥锁避免了MT安全问题，但是它将一个AS安全问题换成了另一个，因此在异步信号中的使用仍然不确定。
</p>
<p>当标识符与用于保存返回值的静态缓冲区相关时，互斥体必须保留一段时间，只要该缓冲区仍被调用方使用。许多将指针返回静态缓冲区的函数都提供了可重入变量，这些变量将返回值存储在调用者提供的缓冲区中。在某些情况下，例如<code>tmpname</code> ，则不通过调用替代入口点来选择变体，而是通过传递非<code>NULL</code>指向要在其中存储返回值的缓冲区的指针。这些变体通常在多线程程序中更可取，尽管其中某些变体由于其他内部缓冲区而不是MT-Safe，因此也记录在文档中。 <code>race</code>笔记。
</p>

</li><li> <code>const</code>
<span id="index-const"></span>

<p>标有功能<code>const</code>作为MT安全问题，非原子地修改内部对象最好将其视为常量，因为GNU C库的很大一部分无需同步即可访问它们。不像<code>race</code> ，导致内部对象的读取者和写入者都被视为MT-不安全和AS-不安全，因此该标记仅适用于写入者。编写者可以同时保持MT和AS不安全的呼叫，但是他们修改的对象当时强制性的常数性使读者可以被视为MT安全和AS安全（只要不存在其他导致他们不安全的原因），因为当对象有效地恒定时，缺少同步不是问题。
</p>
<p>后面的标识符<code>const</code>标记本身将作为安全提示出现在读者中。希望解决此安全问题的程序，以便调用编写程序，可以使用非递归<code>rwlock</code>与标识符相关联，并保护<em>所有</em>标<em>有的</em>函数调用<code>const</code>然后是带有写锁的标识符， <em>所有</em>对带有该标识符标记的函数的调用本身都带有读锁。非递归锁定消除了MT安全问题，但将一个AS安全问题换成了另一个，因此在异步信号中的使用仍然不确定。
</p>


</li><li> <code>sig</code>
<span id="index-sig"></span>

<p>标有功能<code>sig</code>因为MT安全问题（意味着相同的AS安全问题，为简便起见而省略）可能会出于内部目的临时安装信号处理程序，这可能会干扰以冒号标识的其他信号使用。
</p>
<p>通过确保在通话过程中不会发生信号的其他使用，可以解决此安全问题。在调用使用同一临时信号的所有函数时，持有非递归互斥体；建议在调用之前阻塞该信号，然后再重置其处理程序。
</p>
<p>没有安全的方法可以确保在异步取消的情况下恢复原始信号处理程序，因此标记的功能也是AC不安全的。
</p>

<p>除了为避免MT和AS安全问题而建议采取的措施之外，为了避免取消问题，建议禁用异步取消<em>并</em>安装清理程序以将信号恢复到所需状态并释放互斥锁。
</p>

</li><li> <code>term</code>
<span id="index-term"></span>

<p>标有功能<code>term</code>因为MT安全问题可能会以建议的方式更改终端设置，即： <code>tcgetattr</code> ，修改一些标志，然后调用<code>tcsetattr</code> ;这将创建一个窗口，其他线程所做的更改将丢失。因此，标有<code>term</code>是MT不安全的。同一窗口使异步信号所做的更改丢失。这些功能也是AS-Unsafe的，但由于多余而省略了相应的标记。
</p>
<p>因此，建议使用终端的应用程序避免与它进行并发和可重入的交互，方法是不在信号处理程序中使用它或阻止可能使用它的信号，并在调用这些函数并与终端进行交互时保持锁定。此锁还应与带有标记的功能一起用于互斥<code>race:tcattr(fd)</code> ，在哪里<var>fd</var>是控制终端的文件描述符。为了简单起见，调用者可以使用单个互斥锁，或者即使每个终端使用不同的文件描述符引用，每个终端也可以使用一个互斥锁。
</p>
<p>标有功能<code>term</code>作为AC安全问题，应该在临时更改终端设置后将其恢复为原始状态，但是如果取消，则可能无法这样做。
</p>

<p>除了为避免MT和AS安全问题而建议采取的措施之外，为了避免取消问题，建议禁用异步取消<em>并</em>安装清理处理程序以将终端设置恢复为原始状态并释放互斥锁。
</p>

</li></ul>


<hr>
<div class="header">
<p>下一篇： <a href="Other-Safety-Remarks.html#Other-Safety-Remarks" rel="next" accesskey="n">其他安全说明</a> ，上一篇： <a href="Unsafe-Features.html#Unsafe-Features" rel="prev" accesskey="p">不安全功能</a> ，上一篇： <a href="POSIX.html#POSIX" rel="up" accesskey="u">POSIX</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>





</body></html>