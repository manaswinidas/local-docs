<html ><!-- This file documents the GNU C Library.

This is
The GNU C Library Reference Manual, for version
2.30.

Copyright (C) 1993-2019 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version
1.3 or any later version published by the Free
Software Foundation; with the Invariant Sections being "Free Software
Needs Free Documentation" and "GNU Lesser General Public License",
the Front-Cover texts being "A GNU Manual", and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License".

(a) The FSF's Back-Cover Text is: "You have the freedom to
copy and modify this GNU manual.  Buying copies from the FSF
supports it in developing GNU and promoting software freedom." --><!-- Created by GNU Texinfo 6.6, http://www.gnu.org/software/texinfo/ --><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>存储分配（GNU C库）</title>

<meta name="description" content="Storage Allocation (The GNU C Library)">
<meta name="keywords" content="Storage Allocation (The GNU C Library)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html#Top" rel="start" title="Top">
<link href="Concept-Index.html#Concept-Index" rel="index" title="Concept Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="File-Attributes.html#File-Attributes" rel="up" title="File Attributes">
<link href="Making-Special-Files.html#Making-Special-Files" rel="next" title="Making Special Files">
<link href="File-Size.html#File-Size" rel="prev" title="File Size">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>


</head>

<body lang="zh-Hans" >
<span id="Storage-Allocation"></span><div class="header">
<p>上一页： <a href="File-Size.html#File-Size" rel="prev" accesskey="p">文件大小</a> ，向上： <a href="File-Attributes.html#File-Attributes" rel="up" accesskey="u">文件属性</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>
<hr>
<span id="Storage-Allocation-1"></span><h4 class="subsection">14.9.11存储分配</h4>
<span id="index-allocating-file-storage"></span>
<span id="index-file-allocation"></span>
<span id="index-storage-allocating"></span>

<span id="index-file-fragmentation"></span>
<span id="index-fragmentation-of-files"></span>
<span id="index-sparse-files-1"></span>
<span id="index-files_002c-sparse"></span>
<p>大多数文件系统支持以非连续方式分配大文件：文件被拆分为<em>片段</em> ，这些<em>片段</em>按顺序分配，但是片段本身可以分散在整个磁盘上。文件系统通常会尝试避免这种碎片化，因为这会降低性能，但是，如果文件大小逐渐增加，则除了碎片化之外，别无选择。另外，许多文件系统支持<em>带孔的</em> <em>稀疏文件</em> ：空字节区域，文件系统未为其分配后备存储。当孔最终被数据覆盖时，也会发生碎片。
</p>
<p>为文件中尚未写入的部分明确分配存储空间可以帮助系统避免碎片。此外，如果存储预分配失败，则可以提早报告磁盘外错误，通常不会填满整个磁盘。但是，由于重复数据删除，写时复制语义和文件压缩，这种预分配可能无法可靠地防止磁盘空间不足错误在以后发生。仍然需要检查写入错误，并且写入使用以下命令创建的内存映射区域<code>mmap</code>仍然可以导致<code>SIGBUS</code> 。
</p>
<dl>
<dt id="index-posix_005ffallocate">函数： <em>int</em> <strong>posix_fallocate</strong> <em>（int <var>fd</var> ，off_t <var>offset</var> ，off_t <var>length</var> ）</em></dt>
<dd><p>初步： MT安全| AS安全交流安全请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>


<p>为以下地区分配后备存储<var>length</var>从字节开始的字节<var>offset</var>在描述符文件中<var>fd</var> 。文件长度增加到“ <samp><var>length</var> + <var>offset</var></samp> '如有必要。
</p>
<p><var>fd</var>必须是打开以供写入的常规文件，或者<code>EBADF</code>返回。如果没有足够的磁盘空间来满足分配请求， <code>ENOSPC</code>返回。
</p>
<p><strong>注意：</strong>如果<code>fallocate</code>不可用（因为文件系统不支持）， <code>posix_fallocate</code>被模拟，具有以下缺点：</p>
<ul>
<li>这是非常低效的，因为需要检查请求范围内的所有文件系统块（即使它们以前已经分配过），并且有可能被重写。相反，适当的<code>fallocate</code>支持（请参阅下文），文件系统可以检查内部文件分配数据结构并直接消除漏洞，甚至可以使用未写的扩展数据块（已预先分配但未在磁盘上初始化）。

</li><li>如果另一个线程或进程修改了要分配区域中的基础文件，则存在争用条件。非空字节可以用空字节覆盖。

</li><li>如果<var>fd</var>已与<code>O_WRONLY</code>标志，函数将失败并显示<code>errno</code>的价值<code>EBADF</code> 。

</li><li>如果<var>fd</var>已与<code>O_APPEND</code>标志，函数将失败并显示<code>errno</code>的价值<code>EBADF</code> 。

</li><li>如果<var>length</var>是零<code>ftruncate</code>用于根据请求增加文件大小，而无需分配文件系统块。存在种族状况，这意味着<code>ftruncate</code>如果文件已同时扩展，则可能会意外截断该文件。
</li></ul>

<p>在Linux上，如果应用程序无法从仿真中受益或由于其固有的竞争条件而使仿真有害，则该应用程序可以使用特定于Linux的<code>fallocate</code>函数，带有零标志参数。为了<code>fallocate</code>函数，如果文件系统不支持分配，则GNU C库不执行分配仿真。相反， <code>EOPNOTSUPP</code>返回给呼叫者。
</p>
</dd></dl>

<dl>
<dt id="index-posix_005ffallocate64">函数： <em>int</em> <strong>posix_fallocate64</strong> <em>（int <var>fd</var> ，off64_t <var>offset</var> ，off64_t <var>length</var> ）</em></dt>
<dd><p>初步： MT安全| AS安全交流安全请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>


<p>此功能是<code>posix_fallocate64</code>在所有平台上均接受64位文件偏移。
</p>
</dd></dl>

<hr>
<div class="header">
<p>上一页： <a href="File-Size.html#File-Size" rel="prev" accesskey="p">文件大小</a> ，向上： <a href="File-Attributes.html#File-Attributes" rel="up" accesskey="u">文件属性</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>





</body></html>