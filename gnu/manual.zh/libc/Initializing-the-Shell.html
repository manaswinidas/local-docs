<html ><!-- This file documents the GNU C Library.

This is
The GNU C Library Reference Manual, for version
2.30.

Copyright (C) 1993-2019 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version
1.3 or any later version published by the Free
Software Foundation; with the Invariant Sections being "Free Software
Needs Free Documentation" and "GNU Lesser General Public License",
the Front-Cover texts being "A GNU Manual", and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License".

(a) The FSF's Back-Cover Text is: "You have the freedom to
copy and modify this GNU manual.  Buying copies from the FSF
supports it in developing GNU and promoting software freedom." --><!-- Created by GNU Texinfo 6.6, http://www.gnu.org/software/texinfo/ --><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>初始化Shell（GNU C库）</title>

<meta name="description" content="Initializing the Shell (The GNU C Library)">
<meta name="keywords" content="Initializing the Shell (The GNU C Library)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html#Top" rel="start" title="Top">
<link href="Concept-Index.html#Concept-Index" rel="index" title="Concept Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Implementing-a-Shell.html#Implementing-a-Shell" rel="up" title="Implementing a Shell">
<link href="Launching-Jobs.html#Launching-Jobs" rel="next" title="Launching Jobs">
<link href="Data-Structures.html#Data-Structures" rel="prev" title="Data Structures">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>


</head>

<body lang="zh-Hans" >
<span id="Initializing-the-Shell"></span><div class="header">
<p>下一页： <a href="Launching-Jobs.html#Launching-Jobs" rel="next" accesskey="n">启动作业</a> ，上一篇： <a href="Data-Structures.html#Data-Structures" rel="prev" accesskey="p">数据结构</a> ，上<a href="Implementing-a-Shell.html#Implementing-a-Shell" rel="up" accesskey="u">一篇</a> ： <a href="Implementing-a-Shell.html#Implementing-a-Shell" rel="up" accesskey="u">实现一个Shell</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>
<hr>
<span id="Initializing-the-Shell-1"></span><h4 class="subsection">28.5.2初始化外壳</h4>
<span id="index-job-control_002c-enabling"></span>
<span id="index-subshell"></span>

<p>当启动通常执行作业控制的Shell程序时，必须小心，以防已从已经执行其作业控制的另一个Shell调用该程序。
</p>
<p>交互式运行的子外壳程序必须确保其父外壳程序已将其置于前台，然后才能启用作业控制本身。它通过获取其初始流程组ID和<code>getpgrp</code>功能，并将其与与其控制终端相关联的当前前台作业的进程组ID（可以使用<code>tcgetpgrp</code>功能）。
</p>
<p>如果子外壳程序没有作为前台作业运行，则必须通过发送一个<code>SIGTTIN</code>向自己的过程组发出信号。它可能不会任意摆在前台；它必须等待用户告诉父外壳程序执行此操作。如果子外壳程序再次继续，它应该重复检查，如果仍然不在前台，则再次停止自身。
</p>
<span id="index-job-control_002c-enabling-1"></span>
<p>子外壳程序通过其父外壳程序放置到前台后，就可以启用自己的作业控制。它通过调用来实现<code>setpgid</code>将自己置于自己的流程组中，然后调用<code>tcsetpgrp</code>将此流程组置于前台。
</p>
<p>当外壳程序启用作业控制时，它应该将自己设置为忽略所有作业控制停止信号，以免意外地自行停止。您可以通过将所有停止信号的动作设置为<code>SIG_IGN</code> 。
</p>
<p>非交互式运行的子外壳不能也不应该支持作业控制。它必须将其创建的所有进程与外壳本身放在同一个进程组中。这允许非交互式外壳程序及其子进程被父外壳程序视为单个作业。这很容易做到-只是不使用任何作业控制原语-但您必须记住要让Shell做到这一点。
</p>

<p>这是示例外壳程序的初始化代码，显示了如何执行所有这些操作。
</p>
<div class="example">
<pre class="example">/* <span class="roman">Keep track of attributes of the shell.</span>  */

#include &lt;sys/types.h&gt;
#include &lt;termios.h&gt;
#include &lt;unistd.h&gt;

pid_t shell_pgid;
struct termios shell_tmodes;
int shell_terminal;
int shell_is_interactive;


/* <span class="roman">Make sure the shell is running interactively as the foreground job</span>
   <span class="roman">before proceeding.</span> */

void
init_shell ()
{

  /* <span class="roman">See if we are running interactively.</span>  */
  shell_terminal = STDIN_FILENO;
  shell_is_interactive = isatty (shell_terminal);

  if (shell_is_interactive)
    {
      /* <span class="roman">Loop until we are in the foreground.</span>  */
      while (tcgetpgrp (shell_terminal) != (shell_pgid = getpgrp ()))
        kill (- shell_pgid, SIGTTIN);

      /* <span class="roman">Ignore interactive and job-control signals.</span>  */
      signal (SIGINT, SIG_IGN);
      signal (SIGQUIT, SIG_IGN);
      signal (SIGTSTP, SIG_IGN);
      signal (SIGTTIN, SIG_IGN);
      signal (SIGTTOU, SIG_IGN);
      signal (SIGCHLD, SIG_IGN);

      /* <span class="roman">Put ourselves in our own process group.</span>  */
      shell_pgid = getpid ();
      if (setpgid (shell_pgid, shell_pgid) &lt; 0)
        {
          perror (&quot;Couldn't put the shell in its own process group&quot;);
          exit (1);
        }

      /* <span class="roman">Grab control of the terminal.</span>  */
      tcsetpgrp (shell_terminal, shell_pgid);

      /* <span class="roman">Save default terminal attributes for shell.</span>  */
      tcgetattr (shell_terminal, &amp;shell_tmodes);
    }
}
</pre></div>


<hr>
<div class="header">
<p>下一页： <a href="Launching-Jobs.html#Launching-Jobs" rel="next" accesskey="n">启动作业</a> ，上一篇： <a href="Data-Structures.html#Data-Structures" rel="prev" accesskey="p">数据结构</a> ，上<a href="Implementing-a-Shell.html#Implementing-a-Shell" rel="up" accesskey="u">一篇</a> ： <a href="Implementing-a-Shell.html#Implementing-a-Shell" rel="up" accesskey="u">实现一个Shell</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>





</body></html>