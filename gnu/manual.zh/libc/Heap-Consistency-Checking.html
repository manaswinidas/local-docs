<html ><!-- This file documents the GNU C Library.

This is
The GNU C Library Reference Manual, for version
2.30.

Copyright (C) 1993-2019 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version
1.3 or any later version published by the Free
Software Foundation; with the Invariant Sections being "Free Software
Needs Free Documentation" and "GNU Lesser General Public License",
the Front-Cover texts being "A GNU Manual", and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License".

(a) The FSF's Back-Cover Text is: "You have the freedom to
copy and modify this GNU manual.  Buying copies from the FSF
supports it in developing GNU and promoting software freedom." --><!-- Created by GNU Texinfo 6.6, http://www.gnu.org/software/texinfo/ --><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>堆一致性检查（GNU C库）</title>

<meta name="description" content="Heap Consistency Checking (The GNU C Library)">
<meta name="keywords" content="Heap Consistency Checking (The GNU C Library)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html#Top" rel="start" title="Top">
<link href="Concept-Index.html#Concept-Index" rel="index" title="Concept Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Unconstrained-Allocation.html#Unconstrained-Allocation" rel="up" title="Unconstrained Allocation">
<link href="Hooks-for-Malloc.html#Hooks-for-Malloc" rel="next" title="Hooks for Malloc">
<link href="Malloc-Tunable-Parameters.html#Malloc-Tunable-Parameters" rel="prev" title="Malloc Tunable Parameters">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>


</head>

<body lang="zh-Hans" >
<span id="Heap-Consistency-Checking"></span><div class="header">
<p>下一篇： <a href="Hooks-for-Malloc.html#Hooks-for-Malloc" rel="next" accesskey="n">Malloc的挂钩</a> ，上一篇： <a href="Malloc-Tunable-Parameters.html#Malloc-Tunable-Parameters" rel="prev" accesskey="p">Malloc可调参数</a> ，上一篇： <a href="Unconstrained-Allocation.html#Unconstrained-Allocation" rel="up" accesskey="u">不受约束的分配</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>
<hr>
<span id="Heap-Consistency-Checking-1"></span><h4 class="subsubsection">3.2.3.8堆一致性检查</h4>

<span id="index-heap-consistency-checking"></span>
<span id="index-consistency-checking_002c-of-heap"></span>

<p>你可以问<code>malloc</code>使用以下命令检查动态内存的一致性<code>mcheck</code>功能。此函数是GNU扩展，在<samp>mcheck.h</samp> 。
<span id="index-mcheck_002eh"></span>
</p>
<dl>
<dt id="index-mcheck">功能： <em>int</em> <strong>mcheck</strong> <em>（void（* <var>abortfn</var> ）（枚举mcheck_status <var>status</var> ））</em></dt>
<dd>
<p>初步： MT不安全种族：mcheck const：malloc_hooks |不安全AS损坏| AC不安全的腐败|请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>


<p>呼唤<code>mcheck</code>告诉<code>malloc</code>执行偶尔的一致性检查。这些将捕获诸如在已分配的块的末尾写入内容之类的内容<code>malloc</code> 。
</p>
<p>的<var>abortfn</var>参数是发现不一致时要调用的函数。如果提供空指针，则<code>mcheck</code>使用默认功能，可打印一条消息并进行呼叫<code>abort</code> （请参阅<a href="Aborting-a-Program.html#Aborting-a-Program">中止程序</a> ）。您提供的函数仅用一个参数调用，该参数说明检测到了哪种不一致；其类型如下所述。
</p>
<p>一旦分配了任何内容，现在就开始分配检查为时已晚。 <code>malloc</code> 。所以<code>mcheck</code>在那种情况下什么也不做。函数返回<code>-1</code>如果您称呼为时已晚，并且<code>0</code>否则（成功时）。
</p>
<p>拨打电话最简单的方法<code>mcheck</code>尽早使用选项“ <samp>-lmcheck</samp> '当您链接程序时；那么您根本不需要修改程序源。或者，您可以使用调试器插入对<code>mcheck</code>每当程序启动时，例如，这些gdb命令将自动调用<code>mcheck</code>每当程序启动时：</p>
<div class="example">
<pre class="example">(gdb) break main
Breakpoint 1, main (argc=2, argv=0xbffff964) at whatever.c:10
(gdb) command 1
Type commands for when breakpoint 1 is hit, one per line.
End with a line saying just &quot;end&quot;.
&gt;call mcheck(0)
&gt;continue
&gt;end
(gdb) &hellip;
</pre></div>

<p>但是，只有在涉及的任何对象的初始化函数都没有调用任何<code>malloc</code>自<code>mcheck</code>必须在第一个此类函数之前调用。
</p>
</dd></dl>

<dl>
<dt id="index-mprobe">函数： <em>枚举mcheck_status</em> <strong>mprobe</strong> <em>（无效* <var>pointer</var> ）</em></dt>
<dd><p>初步： MT不安全种族：mcheck const：malloc_hooks |不安全AS损坏| AC不安全的腐败|请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>


<p>的<code>mprobe</code>函数使您可以显式检查特定分配块中的不一致。您必须已经打电话<code>mcheck</code>在程序开始时，偶尔进行检查；呼唤<code>mprobe</code>请求在通话时进行其他一致性检查。
</p>
<p>争论<var>pointer</var>必须是由返回的指针<code>malloc</code>要么<code>realloc</code> 。 <code>mprobe</code>返回一个值，该值说明发现了什么不一致（如果有）。值说明如下。
</p></dd></dl>

<dl>
<dt id="index-enum-mcheck_005fstatus">数据类型： <strong>枚举mcheck_status</strong></dt>
<dd><p>此枚举类型描述了在分配的块中检测到哪种不一致（如果有）。以下是可能的值：</p>
<dl compact>
<dt><code>MCHECK_DISABLED</code></dt>
<dd><p><code>mcheck</code>在第一次分配之前未被调用。无法执行一致性检查。
</p></dd>
<dt><code>MCHECK_OK</code></dt>
<dd><p>未检测到不一致。
</p></dd>
<dt><code>MCHECK_HEAD</code></dt>
<dd><p>紧接块修改之前的数据。当数组索引或指针减小太多时，通常会发生这种情况。
</p></dd>
<dt><code>MCHECK_TAIL</code></dt>
<dd><p>块修改后的数据。当数组索引或指针增加得太远时，通常会发生这种情况。
</p></dd>
<dt><code>MCHECK_FREE</code></dt>
<dd><p>该块已被释放。
</p></dd>
</dl>
</dd></dl>

<p>检查并防范使用中的错误的另一种可能性<code>malloc</code> ， <code>realloc</code>和<code>free</code>是设置环境变量<code>MALLOC_CHECK_</code> 。什么时候<code>MALLOC_CHECK_</code>如果将设置为非零值，则使用特殊的（效率较低）实现，该实现旨在容忍简单错误，例如两次调用<code>free</code>具有相同的参数，或超出一个字节的字节数（一个错误的bug）。但是，并非所有此类错误都可以防止，并且可能导致内存泄漏。
</p>
<p>任何检测到的堆损坏都会导致该进程立即终止。
</p>
<p>有一个问题<code>MALLOC_CHECK_</code>注意：在SUID或SGID二进制文件中，由于它偏离了常规程序的行为，因此现在可以将某些内容写入标准错误描述符中，因此有可能被利用。因此使用<code>MALLOC_CHECK_</code>默认情况下，SUID和SGID二进制文件禁用。系统管理员可以通过添加文件来再次启用它<samp>/etc/suid-debug</samp> （内容并不重要，可以为空）。
</p>
<p>那么，使用之间有什么区别<code>MALLOC_CHECK_</code>并与“ <samp>-lmcheck</samp> '？ <code>MALLOC_CHECK_</code> 相对于'是正交的<samp>-lmcheck</samp> '。 ' <samp>-lmcheck</samp>添加了'以向后兼容。都<code>MALLOC_CHECK_</code>和' <samp>-lmcheck</samp> '应该发现相同的错误-但使用<code>MALLOC_CHECK_</code>您无需重新编译应用程序。
</p>
<hr>
<div class="header">
<p>下一篇： <a href="Hooks-for-Malloc.html#Hooks-for-Malloc" rel="next" accesskey="n">Malloc的挂钩</a> ，上一篇： <a href="Malloc-Tunable-Parameters.html#Malloc-Tunable-Parameters" rel="prev" accesskey="p">Malloc可调参数</a> ，上一篇： <a href="Unconstrained-Allocation.html#Unconstrained-Allocation" rel="up" accesskey="u">不受约束的分配</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>





</body></html>