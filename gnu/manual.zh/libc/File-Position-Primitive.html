<html ><!-- This file documents the GNU C Library.

This is
The GNU C Library Reference Manual, for version
2.30.

Copyright (C) 1993-2019 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version
1.3 or any later version published by the Free
Software Foundation; with the Invariant Sections being "Free Software
Needs Free Documentation" and "GNU Lesser General Public License",
the Front-Cover texts being "A GNU Manual", and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License".

(a) The FSF's Back-Cover Text is: "You have the freedom to
copy and modify this GNU manual.  Buying copies from the FSF
supports it in developing GNU and promoting software freedom." --><!-- Created by GNU Texinfo 6.6, http://www.gnu.org/software/texinfo/ --><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>文件位置基元（GNU C库）</title>

<meta name="description" content="File Position Primitive (The GNU C Library)">
<meta name="keywords" content="File Position Primitive (The GNU C Library)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html#Top" rel="start" title="Top">
<link href="Concept-Index.html#Concept-Index" rel="index" title="Concept Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Low_002dLevel-I_002fO.html#Low_002dLevel-I_002fO" rel="up" title="Low-Level I/O">
<link href="Descriptors-and-Streams.html#Descriptors-and-Streams" rel="next" title="Descriptors and Streams">
<link href="I_002fO-Primitives.html#I_002fO-Primitives" rel="prev" title="I/O Primitives">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>


</head>

<body lang="zh-Hans" >
<span id="File-Position-Primitive"></span><div class="header">
<p>下一篇： <a href="Descriptors-and-Streams.html#Descriptors-and-Streams" rel="next" accesskey="n">描述符和流</a> ，上一篇： <a href="I_002fO-Primitives.html#I_002fO-Primitives" rel="prev" accesskey="p">I / O基元</a> ，上一篇： <a href="Low_002dLevel-I_002fO.html#Low_002dLevel-I_002fO" rel="up" accesskey="u">低级I / O</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>
<hr>
<span id="Setting-the-File-Position-of-a-Descriptor"></span><h3 class="section">13.3设置描述符的文件位置</h3>

<p>就像您可以使用设置流的文件位置一样<code>fseek</code> ，您可以使用设置描述符的文件位置<code>lseek</code> 。这指定下一个在文件中的位置<code>read</code>要么<code>write</code>操作。有关文件位置及其含义的更多信息，请参见<a href="File-Positioning.html#File-Positioning">文件位置</a> 。
</p>
<p>要从描述符读取当前文件位置值，请使用<code>lseek (<var>desc</var>, 0, SEEK_CUR)</code> 。
</p>
<span id="index-file-positioning-on-a-file-descriptor"></span>
<span id="index-positioning-a-file-descriptor"></span>
<span id="index-seeking-on-a-file-descriptor"></span>
<dl>
<dt id="index-lseek">函数： <em>off_t</em> <strong>lseek</strong> <em>（int <var>filedes</var> ，off_t <var>offset</var> ，int <var>whence</var> ）</em></dt>
<dd>
<p>初步： MT安全| AS安全交流安全请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>

<p>的<code>lseek</code>函数用于通过描述符更改文件的文件位置<var>filedes</var> 。
</p>
<p>的<var>whence</var>参数指定<var>offset</var>应该以与<code>fseek</code>函数，并且必须是符号常量之一<code>SEEK_SET</code> ， <code>SEEK_CUR</code> ， 要么<code>SEEK_END</code> 。
</p>
<dl compact>
<dt><code>SEEK_SET</code>
<span id="index-SEEK_005fSET-1"></span>
</dt>
<dd><p>指定<var>offset</var>是从文件开头算起的字符数。
</p>
</dd>
<dt><code>SEEK_CUR</code>
<span id="index-SEEK_005fCUR-1"></span>
</dt>
<dd><p>指定<var>offset</var>是从当前文件位置开始的字符计数。此计数可以是正数或负数。
</p>
</dd>
<dt><code>SEEK_END</code>
<span id="index-SEEK_005fEND-1"></span>
</dt>
<dd><p>指定<var>offset</var>是从文件末尾算起的字符数。负数指定文件当前范围内的位置；正计数指定当前位置之后的位置。如果将位置设置为超出当前末端，并实际写入数据，则将文件扩展为零，直到该位置。
</p></dd>
</dl>

<p>的返回值<code>lseek</code>通常是结果文件的位置，从文件开头算起以字节为单位。您可以将此功能与<code>SEEK_CUR</code>读取当前文件位置。
</p>
<p>如果要附加到文件，请使用以下命令将文件位置设置为文件的当前结尾<code>SEEK_END</code>还不够。在您寻找之后但在写入之前，另一个过程可能会写入更多数据，从而扩展文件，以便您将其写入数据的位置。而是使用<code>O_APPEND</code>操作模式;请参阅<a href="Operating-Modes.html#Operating-Modes">操作模式</a> 。
</p>
<p>您可以将文件位置设置为超出文件的当前末尾。这本身并不能使文件更长。 <code>lseek</code>从不更改文件。但是该位置的后续输出将扩展文件。文件的上一个结尾和新位置之间的字符用零填充。以这种方式扩展文件会产生一个“空洞”：零块实际上并没有分配在磁盘上，因此文件占用的空间少于看上去的空间。然后将其称为“稀疏文件”。
<span id="index-sparse-files"></span>
<span id="index-holes-in-files"></span>
</p>
<p>如果无法更改文件位置，或者操作在某种程度上无效， <code>lseek</code>返回值<em>-1</em> 。下列<code>errno</code>为此功能定义了错误条件：</p>
<dl compact>
<dt><code>EBADF</code></dt>
<dd><p>的<var>filedes</var>不是有效的文件描述符。
</p>
</dd>
<dt><code>EINVAL</code></dt>
<dd><p>的<var>whence</var>参数值无效，或生成的文件偏移量无效。文件偏移量无效。
</p>
</dd>
<dt><code>ESPIPE</code></dt>
<dd><p>的<var>filedes</var>对应于无法定位的对象，例如管道，FIFO或终端设备。（POSIX.1仅针对管道和FIFO指定此错误，但是在GNU系统上，您总是<code>ESPIPE</code>如果该对象不可搜索。）
</p></dd>
</dl>

<p>使用以下命令编译源文件时<code>_FILE_OFFSET_BITS == 64</code>的<code>lseek</code>功能其实<code>lseek64</code>和类型<code>off_t</code>具有64位，这使得可以处理最大2 ^ 63字节的文件。
</p>
<p>此功能是多线程程序中的取消点。如果线程当时分配了一些资源（例如内存，文件描述符，信号量或其他内容），这将是一个问题<code>lseek</code>叫做。如果线程被取消，这些资源将保持分配状态，直到程序结束。为了避免这种情况<code>lseek</code>应该使用取消处理程序进行保护。
</p>
<p>的<code>lseek</code>函数是<code>fseek</code> ， <code>fseeko</code> ， <code>ftell</code> ， <code>ftello</code>和<code>rewind</code>函数，对流而不是文件描述符进行操作。
</p></dd></dl>

<dl>
<dt id="index-lseek64">函数： <em>off64_t</em> <strong>lseek64</strong> <em>（int <var>filedes</var> ，off64_t <var>offset</var> ，int <var>whence</var> ）</em></dt>
<dd>
<p>初步： MT安全| AS安全交流安全请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>

<p>此功能类似于<code>lseek</code>功能。区别在于<var>offset</var>参数的类型<code>off64_t</code>代替<code>off_t</code>这样就可以在32位计算机上寻址大于2 ^ 31字节且最大为2 ^ 63字节的文件。文件描述符<code>filedes</code>必须使用<code>open64</code>因为否则可能会产生较大的偏移量<code>off64_t</code>在小文件模式下将导致描述符错误。
</p>
<p>使用以下命令编译源文件时<code>_FILE_OFFSET_BITS == 64</code>在32位计算机上，此功能实际上在名称下可用<code>lseek</code>因此透明地替换了32位接口。
</p></dd></dl>

<p>如果您多次打开文件，或者使用以下命令复制了一个描述符，则您可以为同一个文件使用多个描述符<code>dup</code> 。来自单独调用的描述符<code>open</code>有独立的文件位置；使用<code>lseek</code>在一个描述符上没有影响。例如，</p>
<div class="example">
<pre class="example">{
  int d1, d2;
  char buf[4];
  d1 = open (&quot;foo&quot;, O_RDONLY);
  d2 = open (&quot;foo&quot;, O_RDONLY);
  lseek (d1, 1024, SEEK_SET);
  read (d2, buf, 4);
}
</pre></div>

<p>将读取文件的前四个字符<samp>foo</samp> 。（为简洁起见，这里省略了实际程序所需的错误检查代码。）
</p>
<p>相反，通过复制创建的描述符与被复制的原始描述符共享一个公共文件位置。任何更改重复项之一的文件位置（包括读取或写入数据）的操作均会影响所有重复项。因此，例如</p>
<div class="example">
<pre class="example">{
  int d1, d2, d3;
  char buf1[4], buf2[4];
  d1 = open (&quot;foo&quot;, O_RDONLY);
  d2 = dup (d1);
  d3 = dup (d2);
  lseek (d3, 1024, SEEK_SET);
  read (d1, buf1, 4);
  read (d2, buf2, 4);
}
</pre></div>

<p>将从第1024个字符开始读取四个字符<samp>foo</samp> ，然后再从第1028个字符开始再添加四个字符。
</p>
<dl>
<dt id="index-off_005ft">数据类型： <strong>off_t</strong></dt>
<dd>
<p>这是一种带符号的整数类型，用于表示文件大小。在GNU C库中，这种类型的范围不小于<code>int</code> 。
</p>
<p>如果源使用<code>_FILE_OFFSET_BITS == 64</code>这种类型被透明地替换为<code>off64_t</code> 。
</p></dd></dl>

<dl>
<dt id="index-off64_005ft">数据类型： <strong>off64_t</strong></dt>
<dd>
<p>该类型的用法类似于<code>off_t</code> 。区别在于，即使在32位计算机上， <code>off_t</code>类型将有32位， <code>off64_t</code>具有64位，因此能够寻址最大2 ^ 63字节的文件。
</p>
<p>使用时<code>_FILE_OFFSET_BITS == 64</code>此类型可在名称下使用<code>off_t</code> 。
</p></dd></dl>

<p>这些别名为“ <samp>SEEK_…</samp>存在常量是为了与较早的BSD系统兼容。它们在两个不同的头文件中定义： <samp>fcntl.h</samp>和<samp>sys/file.h</samp> 。
</p>
<dl compact>
<dt><code>L_SET</code>
<span id="index-L_005fSET-1"></span>
</dt>
<dd><p>的别名<code>SEEK_SET</code> 。
</p>
</dd>
<dt><code>L_INCR</code>
<span id="index-L_005fINCR-1"></span>
</dt>
<dd><p>的别名<code>SEEK_CUR</code> 。
</p>
</dd>
<dt><code>L_XTND</code>
<span id="index-L_005fXTND-1"></span>
</dt>
<dd><p>的别名<code>SEEK_END</code> 。
</p></dd>
</dl>

<hr>
<div class="header">
<p>下一篇： <a href="Descriptors-and-Streams.html#Descriptors-and-Streams" rel="next" accesskey="n">描述符和流</a> ，上一篇： <a href="I_002fO-Primitives.html#I_002fO-Primitives" rel="prev" accesskey="p">I / O基元</a> ，上一篇： <a href="Low_002dLevel-I_002fO.html#Low_002dLevel-I_002fO" rel="up" accesskey="u">低级I / O</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>





</body></html>