<html ><!-- This file documents the GNU C Library.

This is
The GNU C Library Reference Manual, for version
2.30.

Copyright (C) 1993-2019 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version
1.3 or any later version published by the Free
Software Foundation; with the Invariant Sections being "Free Software
Needs Free Documentation" and "GNU Lesser General Public License",
the Front-Cover texts being "A GNU Manual", and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License".

(a) The FSF's Back-Cover Text is: "You have the freedom to
copy and modify this GNU manual.  Buying copies from the FSF
supports it in developing GNU and promoting software freedom." --><!-- Created by GNU Texinfo 6.6, http://www.gnu.org/software/texinfo/ --><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>回溯（GNU C库）</title>

<meta name="description" content="Backtraces (The GNU C Library)">
<meta name="keywords" content="Backtraces (The GNU C Library)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html#Top" rel="start" title="Top">
<link href="Concept-Index.html#Concept-Index" rel="index" title="Concept Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Debugging-Support.html#Debugging-Support" rel="up" title="Debugging Support">
<link href="Threads.html#Threads" rel="next" title="Threads">
<link href="Debugging-Support.html#Debugging-Support" rel="prev" title="Debugging Support">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>


</head>

<body lang="zh-Hans" >
<span id="Backtraces"></span><div class="header">
<p>上一篇： <a href="Debugging-Support.html#Debugging-Support" rel="up" accesskey="u">调试支持</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>
<hr>
<span id="Backtraces-1"></span><h3 class="section">34.1回溯</h3>

<span id="index-backtrace"></span>
<span id="index-backtrace_005fsymbols"></span>
<span id="index-backtrace_005ffd"></span>
<p><em>回溯</em>是线程中当前活动的函数调用的列表。检查程序回溯的通常方法是使用外部调试器，例如gdb。但是，有时从程序内部以编程方式获取回溯很有用，例如，出于记录或诊断的目的。
</p>
<p>头文件<samp>execinfo.h</samp>声明三个函数，这些函数获取和操纵当前线程的回溯。
<span id="index-execinfo_002eh"></span>
</p>
<dl>
<dt id="index-backtrace-1">函数： <em>int</em> <strong>backtrace</strong> <em>（void ** <var>buffer</var> ，int <var>size</var> ）</em></dt>
<dd>
<p>初步： MT安全| AS不安全初始化堆dlopen插件锁| AC不安全初始化内存锁fd |请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>

<p>的<code>backtrace</code>函数获取当前线程的回溯（作为指针列表），并将信息放入<var>buffer</var> 。争论<var>size</var>应该是<code>void *</code>适合的<!-- /@w -->元素<var>buffer</var> 。返回值是的实际条目数<var>buffer</var>获得的，最多是<var>size</var> 。
</p>
<p>指针放在<var>buffer</var>实际上是通过检查堆栈获得的返回地址，每个堆栈帧一个返回地址。
</p>
<p>请注意，某些编译器优化可能会干扰获取有效回溯。函数内联导致内联函数没有堆栈框架；尾部调用优化将一个堆栈框架替换为另一个；帧指针消除将停止<code>backtrace</code>正确解释堆栈内容。
</p></dd></dl>

<dl>
<dt id="index-backtrace_005fsymbols-1">功能： <em>char **</em> <strong>backtrace_symbols</strong> <em>（void * const * <var>buffer</var> ，int <var>size</var> ）</em></dt>
<dd>
<p>初步： MT安全| AS不安全堆| AC不安全的内存锁|请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>

<p>的<code>backtrace_symbols</code>函数转换从<code>backtrace</code>函数转换为字符串数组。争论<var>buffer</var>应该是指向通过<code>backtrace</code>功能，以及<var>size</var>是该数组中的条目数（ <code>backtrace</code> ）。
</p>
<p>返回值是一个指向字符串数组的指针，该数组具有<var>size</var>条目就像数组<var>buffer</var> 。每个字符串均包含以下内容的可打印表示形式： <var>buffer</var> 。它包括函数名称（如果可以确定），函数的偏移量和实际返回地址（十六进制）。
</p>
<p>当前，只能在使用ELF二进制格式用于程序和库的系统上获得函数名称和偏移量。在其他系统上，仅存在十六进制返回地址。另外，您可能需要将其他标志传递给链接器，以使函数名称可用于程序。（例如，在使用GNU ld的系统上，您必须<code>-rdynamic</code> ）
</p>
<p>的返回值<code>backtrace_symbols</code>是通过获取的指针<code>malloc</code>功能，这是调用方的责任<code>free</code>那个指针。请注意，只需要释放返回值，而不是单个字符串。
</p>
<p>返回值为<code>NULL</code>如果无法获得足够的字符串存储空间。
</p></dd></dl>

<dl>
<dt id="index-backtrace_005fsymbols_005ffd">函数： <em>void</em> <strong>backtrace_symbols_fd</strong> <em>（void * const * <var>buffer</var> ，int <var>size</var> ，int <var>fd</var> ）</em></dt>
<dd>
<p>初步： MT安全| AS安全AC不安全锁|请参阅<a href="POSIX-Safety-Concepts.html#POSIX-Safety-Concepts">POSIX安全概念</a> 。
</p>

<p>的<code>backtrace_symbols_fd</code>函数执行与函数相同的翻译<code>backtrace_symbols</code>功能。而不是将字符串返回给调用者，而是将字符串写入文件描述符<var>fd</var> ，每行一个。它不使用<code>malloc</code>功能，因此可以在该功能可能失败的情况下使用。
</p></dd></dl>

<p>以下程序说明了这些功能的用法。请注意，包含要返回的返回地址的数组<code>backtrace</code>在堆栈上分配。因此，可以在通过以下方式处理内存的情况下使用此类代码<code>malloc</code>不再起作用（在这种情况下， <code>backtrace_symbols</code>必须替换为<code>backtrace_symbols_fd</code>致电）。返回地址的数量通常不是很大。即使是非常复杂的程序，其嵌套级别也很少超过50个，如果有200个可能的条目，则可能应该涵盖所有程序。
</p>
<div class="example">
<pre class="example">

#include &lt;execinfo.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

/* <span class="roman">Obtain a backtrace and print it to <code>stdout</code>.</span> */
void
print_trace (void)
{
  void *array[10];
  size_t size;
  char **strings;
  size_t i;

  size = backtrace (array, 10);
  strings = backtrace_symbols (array, size);

  printf (&quot;Obtained %zd stack frames.\n&quot;, size);

  for (i = 0; i &lt; size; i++)
     printf (&quot;%s\n&quot;, strings[i]);

  free (strings);
}

/* <span class="roman">A dummy function to make the backtrace more interesting.</span> */
void
dummy_function (void)
{
  print_trace ();
}

int
main (void)
{
  dummy_function ();
  return 0;
}
</pre></div>
<hr>
<div class="header">
<p>上一篇： <a href="Debugging-Support.html#Debugging-Support" rel="up" accesskey="u">调试支持</a> [ <a href="index.html#SEC_Contents" title="目录" rel="contents">目录</a> ] [ <a href="Concept-Index.html#Concept-Index" title="指数" rel="index">索引</a> ]</p>
</div>





</body></html>