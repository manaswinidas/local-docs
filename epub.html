<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>epub read</title>

    <style>
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 20%;
            height: 98vh;
            overflow-y: scroll;
            padding-bottom: 10em;
        }

        iframe {
            width: 79%;
            float: right;
            height: 98vh;
        }

        nav a {
            display: block;
            text-decoration: none;
            color: #000;
        }

        nav ul {
            padding-left: 1em;
        }

        #fDiv {
            position: fixed;
            bottom: 0;
            right: 81%;
            padding: 0.5em;
            margin: 0.5em;
            background: rgba(192, 192, 192, 0.3);

        }

        #fDiv div {
            margin: 0.5em auto;
            font-size: large;
            cursor: pointer;
        }

        .unicode {
            font-size: xx-large;
        }
    </style>

    <script>

        let windowsUrl = new URL(window.location.href);;//当前路径url
        //获取当前地址父路径 /code/local/local-docs
        let basePath = location.pathname.substring(0, location.pathname.lastIndexOf("/"));
        let context = window.origin + basePath + "/";// "http://localhost/code/local/local-docs"

        //[使用 EPUB 制作数字图书](https://www.ibm.com/developerworks/cn/xml/tutorials/x-epubtut/index.html)
        let path;//epub文件夹路径 
        let contentOpf, tocNcx;//  content.opf   toc.ncx 电子书元数据

        const domParser = new DOMParser();//文档解析器

        let navA = [];//当前导航栏所有超链接

        const load = async () => {

            path = windowsUrl.searchParams.get("path") || "jboss/red_hat_jboss/7.2/getting_started_guide";//默认路径 测试用
            path += path.endsWith("/") ? "" : "/";//如果没有 斜杠结尾 补全斜杠

            contentOpf = await fetch(path + "content.opf").then(response => response.status == 200 ? response.text() : '');
            tocNcx = await fetch(path + "toc.ncx").then(response => response.status == 200 ? response.text() : '');

            contentOpf || console.log("content.opf is empty");
            tocNcx || console.log("toc.ncx is empty");

            if (contentOpf) {
                contentOpf = domParser.parseFromString(contentOpf, "application/xml");
                let metadata = contentOpf.querySelector("metadata");
                //[11. Accessing Page Elements - JavaScript Cookbook [Book]](https://www.oreilly.com/library/view/javascript-cookbook/9781449390211/ch11.html) 
                //使用 contentOpf.querySelector('[dc\\:title]') 无效
                //使用 getElementsByTagName 获取元素 
                let tags, innerHTML;
                innerHTML = "";
                if ((tags = metadata.getElementsByTagName('dc:date')).length > 0) {
                    innerHTML += tags[0].textContent + " ";
                }
                if ((tags = metadata.getElementsByTagName('dc:title')).length > 0) {
                    innerHTML += tags[0].textContent + " ";
                }
                document.getElementById("metadataS").innerHTML = innerHTML;
                if ((tags = metadata.getElementsByTagName('dc:description')).length > 0) {
                    document.getElementById("metadataP").innerHTML += tags[0].textContent + " ";
                }

            }

            //不为空 渲染页面
            if (tocNcx) {
                let tocText = "";
                // txt文本转换为 dom 结构
                tocNcx = domParser.parseFromString(tocNcx, "application/xml");
                document.getElementById("toc").innerHTML = navPoint2Html(tocNcx.querySelectorAll("navMap>navPoint"));
            }
            navA = [...document.querySelectorAll("nav a")];

            console.log("window.location.hash" + window.location.hash);
            if (window.location.hash && window.location.hash.length > 0) {
                document.getElementById('contentF').src = window.location.hash.substring(1);
            }



            // let hash = window.location.hash;
            // if (hash) {
            //     let contentF = document.getElementById('contentF');
            //     console.log("load to contentF:" + context + hash.substring(1));
            //     contentF.contentWindow.document.location.href = context + hash.substring(1);
            // }
        }
        window.onload = load;//初始化


        /***
        <navPoint id="idm140147838654208" playOrder="1">
            <navLabel><text>Getting Started Guide</text></navLabel>
            <content src="index.html"/>
            <navPoint id="idm140147837239616" playOrder="2">
            </navPoint>
        **/
        //navPoint 节点转换为html
        function navPoint2Html(navPoints) {
            let navPointHTML = "";
            navPoints.forEach((navPoint) => {// onclick="window.location.hash = this.getAttribute('href');
                navPointHTML += "<li>";
                navPointHTML += `<a  target="contentF" " 
                                     href="${path}${navPoint.querySelector(":scope>content").getAttribute("src")}">
                                  ${navPoint.querySelector(":scope>navLabel>text").textContent}
                                </a>`;
                //获取子元素
                let subnavPoints = navPoint.querySelectorAll(":scope>navPoint");
                if (subnavPoints.length > 0) {
                    navPointHTML += `<ul>${navPoint2Html(subnavPoints)}</ul>`;
                }
                navPointHTML += "</li>";
            });
            return navPointHTML;
        }

        //iframe 内容变化或者更新时
        function contentFChange() {
            let contentF = document.getElementById('contentF');
            let contentHref = contentF.contentWindow.document.location.href;
            //一开始会默认进入  about:blank
            if (contentHref != 'about:blank') {
                document.title = contentF.contentWindow.document.title;
                contentF.contentWindow.onhashchange = contentFChange;
                console.log("contentF change:" + contentF.contentWindow.document.location.href);
                window.location.hash = contentF.contentWindow.document.location.href.replace(context, "");

                updateBookmark();
            }
        }

        //更新书签所在位置
        function updateBookmark() {
            let cHref = window.location.hash.substr(1);//当前链接
            let cIndex = navA.findIndex(a => a.getAttribute('href')
                && a.getAttribute('href').endsWith(cHref));//href有值 并且有当前地址的后缀 并且 当前 a为空 或者 当前不是此
            if (navA[cIndex]) {
                //在可视窗口的上面或者下面时候滚动
                if (navA[cIndex].getBoundingClientRect().top < 0
                    || navA[cIndex].getBoundingClientRect().bottom > document.documentElement.clientHeight) {
                    navA[cIndex].scrollIntoView();
                }
                //书签紧跟菜单标签
                bookmark.style.top = navA[cIndex].getBoundingClientRect().top + "px";
            }
        }

        function goPage(offset) {
            let contentF = document.getElementById('contentF');
            if (window.location.hash && window.location.hash.length > 0) {
                let cHref = window.location.hash.substr(1);//当前链接
                let cIndex = navA.findIndex(a => a.getAttribute('href')
                    && a.getAttribute('href').endsWith(cHref));
                cIndex = cIndex + offset;
                if (cIndex < 0) {
                    cIndex = 0;//最小是头
                    console.log("超过最小 设置为0");
                } else if (cIndex >= navA.length) {
                    cIndex = navA.length - 1;//最大是尾
                    console.log("超过最末设置为最末");
                }

                contentF.src = navA[cIndex].getAttribute('href');
            }
        }

        //多语言没有统一设置这里使用正则表达式匹配判断
        function goBook() {

            const epubConfig = {
                translationPath: [
                    ['(redhat/8)(/)(.*)', '$1.zh-Hans$2$3'],
                    ['(redhat/8)(\\.zh-Hans)(/)(.*)', "$1$3$4"]
                ]
            };

            let newPath = '';
            for (let i = 0; i < epubConfig.translationPath.length; i++) {
                // var newstr = "John Smith".replace(/(\w+)\s(\w+)/, "$2, $1");// "Smith, John"
                let regExp = new RegExp(epubConfig.translationPath[i][0]);
                let substr = epubConfig.translationPath[i][1];
                let replaceStr = path.replace(regExp, substr);

                console.log("regExp:" + regExp);
                console.log("substr:" + substr);
                console.log("replaceStr:" + replaceStr);

                if (path != replaceStr) {//说明替换成功
                    newPath = replaceStr;
                    break;
                }
            }
            if (newPath != '' && newPath != path) {
                window.open(window.location.href.replace(path, newPath));
            } else {
                alert('没有找到其他版本');
            }
        }

        //目录显示控制
        function displayToc() {
            if (navigation.style.display == '') {
                navigation.style.display = 'none';//隐藏
                document.getElementById('contentF').style.width = "100%";
                fDiv.style.right = '0%';//隐藏
            } else {
                navigation.style.display = '';//还原
                document.getElementById('contentF').style.width = "79%";

                fDiv.style.right = '81%';//还原  
            }
        }

    </script>

</head>

<body>

    <!-- 导航栏 -->
    <nav id="navigation">
        <!-- 書簽 -->
        <span id="bookmark" style="position: fixed;">🔖</span>
        <h1>metadata</h1>
        <details>
            <summary id="metadataS"></summary>
            <p id="metadataP"></p>
        </details>
        <h1> Table of contents </h1>
        <ul id="toc">
        </ul>
    </nav>

    <!-- 功能区域 -->
    <div id="fDiv">

        <div onclick="displayToc()" title="折叠/展开目录">折叠<span class="unicode">⬷</span> </div>
        <!-- onclick="tocfragmentTFlag && window.open(`${tocfragmentTURL}${window.location.hash}`);" -->
        <div onclick="goBook()" title="打开 EN/中文"> 中英<span class="unicode">⇄</span></div>
        <div onclick="goPage(-1)" title="跳转上一页">上页 <span class="unicode">⎗</span></div>
        <div onclick="goPage(1)" title="跳转下一页">下页 <span class="unicode">⎘</span></div>

    </div>

    <!--内容页-->
    <iframe frameborder=0 id="contentF" name="contentF" onload="contentFChange()">

    </iframe>


</body>

</html>