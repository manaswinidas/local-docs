<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="http://geronimo.apache.org/style/default.css">
    <LINK rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <LINK rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <META name="Description" content="JACC Guide" />
    <META name="Keywords" content="Apache Geronimo development documentation JACC Guide" />
    <META name="Owner" content="dev@geronimo.apache.org" />
    <META name="Robots" content="index, follow" />
    <META name="Security" content="Public" />
    <META name="Source" content="wiki template" />
    <META name="DC.Date" scheme="iso8601" content="2009-01-06" />
    <META name="DC.Language" scheme="rfc1766" content="en" />
    <META name="DC.Rights" content="Copyright Â© 2003-2011, The Apache Software Foundation" />
    <META http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html" l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html" l gen true r (n 0 s 0 v 0 l 0) "http://www.classify.org/safesurf/" l gen true r (SS~~000 1))'/>

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>


    <title>Apache Geronimo Development : JACC Guide</title>

  </head>

  <body onload="init()">

    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tr>
        <td valing="top" align="left">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </table>

    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" align="left" nowrap>
          <a href="/geronimo"> Home</a> >&nbsp;<a href="index.html">Index</a>&nbsp;&gt;&nbsp;<a href="jacc-guide.html">JACC Guide</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
        </td>
      </tr> 
    </table>

    <div id="PageContent">
      <div class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div style="margin: 0px 10px 0px 10px" class="smalltext">Apache Geronimo Development</div>
        <div style="margin: 0px 10px 8px 10px"  class="pagetitle">JACC Guide</div>

        <div class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
<!-- -->         
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=31854">
            <img src="http://geronimo.apache.org/images/icons/notep_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Edit Page"></a>
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=31854">Edit Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDEV">
            <img src="http://geronimo.apache.org/images/icons/browse_space.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Browse Space"></a>
            <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDEV">Browse Space</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDEV&fromPageId=31854">
            <img src="http://geronimo.apache.org/images/icons/add_page_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add Page"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDEV&fromPageId=31854">Add Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDEV&fromPageId=31854">
            <img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add News"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDEV&fromPageId=31854">Add News</a>
<!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent"><h1 id="JACCGuide-GuidetoJACCProviders">Guide to JACC Providers</h1>

<p>JACC (Java Authorization Contract for Containers) is a spec that allows plugging in providers to handle the security decisions for a j2ee app server. You can have simple self-contained systems all the way to rule engines or delegating to external security servers.  This is an outline of what a JACC provider needs to implement, what deployment time info is provided, and what run time info is provided, and how to get Geronimo to use your JACC provider, including how to get geronimo to supply extra info to your provider.</p>

<p>Before we get started on the provider, notice that there are a bunch of new Permission classes for web and ejb that basically encapsulate the permissions you can specify in the spec deployment descriptors in classes.  Geronimo implements these, and the Geronimo provider doesn't need to know anything specific about them, but you still might want to review them.</p>

<p>So far this is a brief first draft, so there are probably lots of errors and omissions.</p>

<h1 id="JACCGuide-ClassesaProviderneedstoimplement.">Classes a Provider needs to implement.</h1>

<p>JACC splits up the security decision making apparatus into bits per policyContextID, which basically corresponds to web or ejb module.  For each policyContextID there's a PolicyConfiguration that makes the decisions for that module. The PolicyConfigurationFactory provides access to the PolicyConfigurations, both for configuration purposes and in geronimo for runtime decision delegation.</p>

<h3 id="JACCGuide-PolicyConfigurationFactory">PolicyConfigurationFactory</h3>

<p>This supplies the PolicyConfigurations and to some extent manages their lifecycles.  You specify your implementation class with the system property javax.security.jacc.PolicyConfigurationFactory.provider and get your implementation with the static getPolicyConfigurationFactory method.  The getPolicyConfiguration(String policyContextId, boolean replace) method gives you the PolicyConfiguration for the policyContextId, where the replace parameter indicates if you want all the content erased before you get it (so you can configure it).  You can tell if a policyContextId is in available for runtime use with the inService(String policyContextId) method.</p>

<h3 id="JACCGuide-PolicyConfiguration">PolicyConfiguration</h3>

<p>This provides a lot of methods for pushing the role to permissions mappings specified in the spec deployment descriptors into the PolicyConfigurations.  In geronimo, this is done when the application is being started.  There's also a link method that must be called by the container (geronimo) for every pair of modules in a j2ee application.  The standard geronimo jacc implementation doesn't need to do anything to link, but other implementations might.</p>

<h3 id="JACCGuide-Policy">Policy</h3>

<p>You also have to supply a Policy implementation that somehow uses the info supplied to the PolicyConfigurations to help with the security decisions.  Geronimo extends PolicyConfiguration to GeronimoPolicyConfiguration and supplies a GeronimoPolicy that delegates the </p>

<p>    public boolean implies(ProtectionDomain domain, Permission permission)</p>

<p>decision to the appropriate PolicyConfiguration.  If you want to write a geronimo-specific JACC provider (or one that drags in bits of geronimo to work) you can resuse GeronimoPolicy and have your PolicyConfiguration implement GeronimoPolicyConfiguration, or you can copy GeronimoPolicy, or you can come up with an entirely different scheme.</p>


<h1 id="JACCGuide-Configurationtimeaccess">Configuration time access</h1>

<p>Before the app is started up and "commit" called on each PolicyConfiguration for the app, the container (geronimo) has to get the PolicyConfiguration for each policyContextId and stuff in the role-permission mapping defined in the spec deployment descriptors, using the methods</p>

<p>    void addToRole(java.lang.String string, java.security.PermissionCollection permissionCollection) throws javax.security.jacc.PolicyContextException;</p>

<p>    void addToRole(java.lang.String string, java.security.Permission permission) throws javax.security.jacc.PolicyContextException;</p>

<p>    void addToUncheckedPolicy(java.security.PermissionCollection permissionCollection) throws javax.security.jacc.PolicyContextException;</p>

<p>    void addToUncheckedPolicy(java.security.Permission permission) throws javax.security.jacc.PolicyContextException;</p>

<p>    void addToExcludedPolicy(java.security.PermissionCollection permissionCollection) throws javax.security.jacc.PolicyContextException;</p>

<p>    void addToExcludedPolicy(java.security.Permission permission) throws javax.security.jacc.PolicyContextException;</p>

<p>    void removeRole(java.lang.String string) throws javax.security.jacc.PolicyContextException;</p>

<p>    void removeUncheckedPolicy() throws javax.security.jacc.PolicyContextException;</p>

<p>    void removeExcludedPolicy() throws javax.security.jacc.PolicyContextException;</p>

<p>(I don't know why there are 2 versions of each add method).  After the app is deployed the spec seems to indicate that you can get a PolicyConfiguration from the PolicyConfigurationFactory (thus taking it out of service and blocking access to the app) and reconfigure these permissions, but it isn't clear to me from the spec when this could be called and what you can actually do with it, since the spec appears to require that exactly what is in the spec dd is fed into the PolicyConfigurations.  Theoretically one could write a generic admin interface to change the role-permission mappings at runtime, but then they would get reset when the app is restarted (at least in geronimo) unless the dd was changed identically.</p>

<p>Geronimo also provides a way to stuff more info into your JACC implementation as the app starts up.  The Geronimo JACC provider uses this to install an app-wide principal-role mapping specified somewhere in the geronimo application plan: this is combined with the spec role-permission mapping to provide a principal-permission mapping actually used for "implies" calculations.</p>

<p>To implement such a JACC-provider specific info-stuffer, you need to define a schema for the info you want to add, and register a NamespaceDrivenBuilder GBean for that namespace and change the references to SecurityBuilder so they point to your security builder.  Typically your builder should install a gbean in the application configuration that holds the extra info and supplies it to your JACC provider (using a proprietary interface) when it starts.  Look at the geronimo implementation for more details:</p>

<p>builder:  GeronimoSecurityBuilderImpl</p>

<p>runtime gbean holding the extra info:  ApplicationPolicyConfigurationManager</p>

<p>If you don't have any such extra info, you can leave these out.</p>

<p>TODO: need to discuss extra methods in SecurityBuilder. These don't belong there, but for now you can probably continue to use the built-in GeronimoSecurityBuilderImpl or copy it.  Basically we should be getting default Subjects from logging in to the app's login configuration, not constructing them by hand.</p>

<h1 id="JACCGuide-Runtimepermissionsdecisions">Runtime permissions decisions</h1>

<p>So now your JACC provider is installed and configured and your app is running and geronimo needs to make a security decision, so it calls implies on your policy.  You might follow Geronimo's idea of delegating the decision to the PolicyConfiguration.  In any case, lets look at the information available to your provider to make this decision. Some of this is available directly and some is available through PolicyContextHandlers that consult ThreadLocals that are filled in by geronimo as the request traverses the containers.  You get this info from PolicyContext.getContext(String key) passing in a key for the info you want.</p>

<h3 id="JACCGuide-role-permissionmappingfromthespeccdd">role-permission mapping from the specc dd</h3>
<p>This is the unchecked and excluded permissions together with the role to permissions mapping installed into the PolicyConfiguration as the app was starting up.</p>

<h3 id="JACCGuide-ThePrincipalsintheSubject">The Principals in the Subject</h3>
<p>Implies supplies you with the current ProtectionDomain, and you can get the Subject's principals using<br clear="none">
        Principal[] principals = domain.getPrincipals();<br clear="none">
If you have a principal to role mapping you can use this to figure out the roles you are in and use the role permission mapping to decide on the permissions.  This is what the default geronimo JACC provider does.</p>

<h3 id="JACCGuide-TheSubjectitself">The Subject itself</h3>
<p>This is available through the Subject PolicyContextHandler PolicyContextHandlerContainerSubject.  You get this by calling </p>

<p>PolicyContext.getContext("javax.security.auth.Subject.container");</p>

<h3 id="JACCGuide-EJBobject">EJB object</h3>

<p>PolicyContext.getContext("javax.ejb.EnterpriseBean");</p>

<p>returns the actual object instance of the ejb bean that the request is going to.</p>

<h3 id="JACCGuide-EJBmethodcallarguments">EJB method call arguments</h3>

<p>PolicyContext.getContext("javax.ejb.arguments");</p>

<p>returns an Object[] containing the ejb method arguments.  This is not available for ejb web service requests.  The ejb method name is available from the permission you are checking against.</p>

<h3 id="JACCGuide-ServletRequest">ServletRequest</h3>

<p>PolicyContext.getContext("javax.servlet.http.HttpServletRequest");</p>

<p>returns the current HttpServletRequest.</p>

<h3 id="JACCGuide-SOAPrequest">SOAP request</h3>

<p>PolicyContext.getContext("javax.xml.soap.SOAPMessage");</p>

<p>returns the current SOAP message.  This is not yet implemented in geronimo! See GERONIMO-2622.</p>



</div>
        </div>

        
      </div>
    </div>

    <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="middle" class="footer">
            &nbsp;&nbsp;
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Delicious" />
            <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">Bookmark this on Delicious</a>
            &nbsp;&nbsp;
            <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="Digg!" />
            <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title)+'&amp;topic=programming');">Digg this</a>
            <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo Development : JACC Guide';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
            &nbsp;&nbsp;
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">Privacy Policy</a>&nbsp;&nbsp;-&nbsp;&nbsp;
            Copyright &#169; 2003-2011, The Apache Software Foundation, Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0.</a>&nbsp;&nbsp;
          </td>
        </tr>
    </table> 

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-4380560-1");
pageTracker._initData();
pageTracker._trackPageview();
</script>
  </body>
</html>
