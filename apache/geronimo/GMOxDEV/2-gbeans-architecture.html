<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="http://geronimo.apache.org/style/default.css">
    <LINK rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <LINK rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <META name="Description" content="2 - GBeans Architecture" />
    <META name="Keywords" content="Apache Geronimo development documentation 2 - GBeans Architecture" />
    <META name="Owner" content="dev@geronimo.apache.org" />
    <META name="Robots" content="index, follow" />
    <META name="Security" content="Public" />
    <META name="Source" content="wiki template" />
    <META name="DC.Date" scheme="iso8601" content="2009-01-06" />
    <META name="DC.Language" scheme="rfc1766" content="en" />
    <META name="DC.Rights" content="Copyright Â© 2003-2011, The Apache Software Foundation" />
    <META http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html" l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html" l gen true r (n 0 s 0 v 0 l 0) "http://www.classify.org/safesurf/" l gen true r (SS~~000 1))'/>

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>


    <title>Apache Geronimo Development : 2 - GBeans Architecture</title>

  </head>

  <body onload="init()">

    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tr>
        <td valing="top" align="left">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </table>

    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" align="left" nowrap>
          <a href="/geronimo"> Home</a> >&nbsp;<a href="index.html">Index</a>&nbsp;&gt;&nbsp;<a href="geronimo-architecture.html">Geronimo Architecture</a>&nbsp;&gt;&nbsp;<a href="2-gbeans-architecture.html">2 - GBeans Architecture</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
        </td>
      </tr> 
    </table>

    <div id="PageContent">
      <div class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div style="margin: 0px 10px 0px 10px" class="smalltext">Apache Geronimo Development</div>
        <div style="margin: 0px 10px 8px 10px"  class="pagetitle">2 - GBeans Architecture</div>

        <div class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
<!-- -->         
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=32189">
            <img src="http://geronimo.apache.org/images/icons/notep_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Edit Page"></a>
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=32189">Edit Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDEV">
            <img src="http://geronimo.apache.org/images/icons/browse_space.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Browse Space"></a>
            <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDEV">Browse Space</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDEV&fromPageId=32189">
            <img src="http://geronimo.apache.org/images/icons/add_page_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add Page"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDEV&fromPageId=32189">Add Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDEV&fromPageId=32189">
            <img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add News"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDEV&fromPageId=32189">Add News</a>
<!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent"><plain-text-body>{scrollbar}</plain-text-body>

<h1 id="id-2-GBeansArchitecture-Introduction">Introduction</h1>
<p>Geronimo Beans or GBeans are entities in the Geronimo Application Server that are available for use within the Geronimo system (through the Geronimo Kernel).  GBeans allow loosely coupled interactions with other entities in the system and dependency injection between modules and subsystems.  GBeans are interoperable with JMX tools but are implemented separately from JMX MBeans.  GBeans are able to be accessed via JMX technology through adapter classes in the geronimo-system module.</p>

<h3 id="id-2-GBeansArchitecture-GBeansvs.MBeans">GBeans vs. MBeans</h3>
<p>JMX has very similar concepts to GBeans.  In JMX, the equivalent to GBeans is MBeans, and the equivalent to the MBeanServer is the Geronimo Kernel.  The Geronimo developers created GBeans so that each part of the application server wouldn't need to rely on a full JMX stack.  By separating the two, the internals of Geronimo can rely on the lighter-weight GBeans.  When external applications need access to the Geronimo modules, the JMX calls get delegated to the appropriate GBean or GBean Kernel methods.</p>

<h3 id="id-2-GBeansArchitecture-WhatisaGBean?">What is a GBean?</h3>
<p>A GBean is a Java object that has a method called getGBeanInfo() that returns an instance of the GBeanInfo class.  GBeanInfo has three main purposes.  One is to define the methods that should be exposed to the other subsystems, the second is to define attributes and references so that they can injected at runtime and the third is to define information about the GBean so that it can be located later.  Each of these will be discussed in detail below.   When defining the instance of the GBeanInfo object for the GBean, GBeanInfo shouldn't be constructed directly.  Instead there is a GBeanInfoBuilder class that will simplify the process (see //1 below).  Below is an example of creating a GBeanInfo from the Log4jService class and then returning it in the getGBeanInfo() method:</p>

<parameter ac:name="title">Log4jService.java</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
//...
static {
        GBeanInfoBuilder infoFactory = GBeanInfoBuilder.createStatic(Log4jService.class, "SystemLog"); //1

        infoFactory.addAttribute("configFileName", String.class, true);//2
        infoFactory.addAttribute("refreshPeriodSeconds", int.class, true);
        infoFactory.addAttribute("configuration", String.class, false);
        infoFactory.addAttribute("rootLoggerLevel", String.class, false);

        infoFactory.addReference("ServerInfo", ServerInfo.class, "GBean");//3

        infoFactory.addOperation("reconfigure");//4
        infoFactory.addOperation("setLoggerLevel", new Class[]{String.class, String.class});
        infoFactory.addOperation("getLoggerLevel", new Class[]{String.class});
        infoFactory.addOperation("getLoggerEffectiveLevel", new Class[]{String.class});
        infoFactory.addInterface(SystemLog.class);//5

        infoFactory.setConstructor(new String[]{"configFileName", "refreshPeriodSeconds", "ServerInfo"});//6

        GBEAN_INFO = infoFactory.getBeanInfo();
}

public static GBeanInfo getGBeanInfo() {
       return GBEAN_INFO;
}
//...
</plain-text-body>

<p>There are a few important things to note from above.  By convention, the GBeanInfo object is constructed in a static initializer.  Also by convention, the GBeanInfo object is named GBEAN_INFO.  Below is the portion of a deployment plan that is relevant to the Log4jService (found in $GERONIMO_HOME/configs/j2ee-system/src/plan/plan.xml). </p>

<parameter ac:name="">xml</parameter><plain-text-body>
&lt;gbean name="Logger" class="org.apache.geronimo.system.logging.log4j.Log4jService"&gt;
        &lt;attribute name="configFileName"&gt;var/log/server-log4j.properties&lt;/attribute&gt; &lt;!--1--&gt;
        &lt;attribute name="refreshPeriodSeconds"&gt;60&lt;/attribute&gt;
        &lt;reference name="ServerInfo"&gt;
            &lt;name&gt;ServerInfo&lt;/name&gt;
        &lt;/reference&gt;
&lt;/gbean&gt;
</plain-text-body>

<p>The deployment plan allows the injection of dependencies, attributes etc and maintains a loose coupling between the systems.  The Geronimo Kernel will (using the deployment plan) inject these dependencies automatically when the GBean is loaded.  Below the code samples are explained in more detail.</p>

<h5 id="id-2-GBeansArchitecture-Attributes">Attributes</h5>
<p>In the above snippet of code //2 points to an adding of an attribute to a GBean.  It defines the name of the attribute (in this case "configFileName"), it's type (String) and whether or not it's persistent (true).  Now that the attribute is defined in the GBeanInfo, that attribute can be injected via the Geronimo Kernel.  To inject a value into this GBean, it needs to be specified in the deployment plan.  In comment one in the XML above, it says to assign the string "var/log/server-log4j.properties" to the attribute configFileName.  When the kernel reads this in, it will call the setConfigFileName() method and pass in the string as the parameter.</p>

<h5 id="id-2-GBeansArchitecture-References">References</h5>
<p>In comment 3 in the Java code above, a reference is being added to the GBeanInfo object.  A reference is like an attribute in that it is injected at runtime, however a reference is another GBean rather than a String or an integer.  At runtime the Geronimo kernel will locate (in this case) the ServerInfo GBean and inject it into the Log4jService GBean.</p>

<h5 id="id-2-GBeansArchitecture-ExecutingMethods">Executing Methods</h5>
<p>GBean Methods can be executed two ways.  One way is the one listed above by comment 4.  This defines an "operation" in the GBean.  Through the kernel, that method can be reflectively invoked.  Another way to invoke a method is to retrieve the GBean out of the kernel and then just execute it directly.  One important point about invoking methods reflectively, is that it can be slower.  The internals of Geronimo use this reflective method invocation, so performance is critical.  To help improve performance the Geronimo developers created the <em>Raw Invoker</em>.  The <em>Raw Invoker</em> essentially uses a cached copy of the CGLib (a higher performance reflection library) reflective invocations.  When the method is invoked, the <em>Raw Invoker</em> containing the cached CGLib method call is used, saving some execution time.</p>

<h5 id="id-2-GBeansArchitecture-AddingInterfaces">Adding Interfaces</h5>
<p>Comment number 5 above adds the interface SystemLog.class to the GBeanInfo object.  Adding an interface like above is basically a shorter way of adding everything in the interface individually.  All of the variables in the interface will be added as attributes and all of the methods will be added as operations.</p>

<h5 id="id-2-GBeansArchitecture-Constructors">Constructors</h5>
<p>Comment 6 above adds a constructor to the GBeanInfo object.  Since the Log4jService GBean does not have a default (no argument) constructor, the constructor must be defined.  When the kernel creates an instance of the GBean, comment 6 lets it know what to pass to the constructor.  Note that each of the elements in the array are attributes/references that are defined in the GBeanInfo.</p>

<h3 id="id-2-GBeansArchitecture-GBeanLifecycle">GBeanLifecycle</h3>
<p>Although implementing any interfaces for a GBean is not required it is often useful to be able to execute code when a GBean starts up, or shuts down.  Implementing the GBeanLifecycle interface will allow the GBean to be notified on startup, shutdown and failure.  The required methods to implement in the GBeanLifecycle interface are: doStart(), doStop() and doFail().  Below is some example code from the same Log4jService GBean:</p>

<parameter ac:name="title">Log4jService.java</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
public void doStart() {
        LogFactory logFactory = LogFactory.getFactory();
        if (logFactory instanceof GeronimoLogFactory) {
            synchronized (this) {
                timer = new Timer(true);

                // Periodically check the configuration file
                schedule();

                // Make sure the root Logger has loaded
                Logger logger = LogManager.getRootLogger();

                reconfigure();

                File file = resolveConfigurationFile();
                if (file != null) {
                    lastChanged = file.lastModified();
                }
                logEnvInfo(logger);
            }

            // Change all of the loggers over to use log4j
            GeronimoLogFactory geronimoLogFactory = (GeronimoLogFactory) logFactory;
            synchronized (geronimoLogFactory) {
                if (!(geronimoLogFactory.getLogFactory() instanceof CachingLog4jLogFactory)) {
                    geronimoLogFactory.setLogFactory(new CachingLog4jLogFactory());
                }
            }
        }

        synchronized (this) {
            running = true;
        }
    }

    public synchronized void doStop() {
        running = false;
        if (monitor != null) {
            monitor.cancel();
            monitor = null;
        }
        if (timer != null) {
            timer.cancel();
            timer = null;
        }
    }

    public void doFail() {
        doStop();
    }
</plain-text-body>

<p>Understanding all of the details around the above code is not necessary, it's sufficient to just understand that a Timer, or what could be thought of as a sleeping thread, is created in doStart().  The person writing the code wanted to ensure that the thread would be stopped when the GBean was stopped.  When the GBean is stopped, the doStop() method will be called and then the Timer can be stopped safely.  Note also that in the event of a failure, the doStop() method is also called, safely stopping the Timer.</p></div>
        </div>

        
      </div>
    </div>

    <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="middle" class="footer">
            &nbsp;&nbsp;
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Delicious" />
            <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">Bookmark this on Delicious</a>
            &nbsp;&nbsp;
            <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="Digg!" />
            <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title)+'&amp;topic=programming');">Digg this</a>
            <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo Development : 2 - GBeans Architecture';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
            &nbsp;&nbsp;
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">Privacy Policy</a>&nbsp;&nbsp;-&nbsp;&nbsp;
            Copyright &#169; 2003-2011, The Apache Software Foundation, Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0.</a>&nbsp;&nbsp;
          </td>
        </tr>
    </table> 

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-4380560-1");
pageTracker._initData();
pageTracker._trackPageview();
</script>
  </body>
</html>
