<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="http://geronimo.apache.org/style/default.css">
    <LINK rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <LINK rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <META name="Description" content="Clustering Configuration for Jetty" />
    <META name="Keywords" content="Apache Geronimo development documentation Clustering Configuration for Jetty" />
    <META name="Owner" content="dev@geronimo.apache.org" />
    <META name="Robots" content="index, follow" />
    <META name="Security" content="Public" />
    <META name="Source" content="wiki template" />
    <META name="DC.Date" scheme="iso8601" content="2009-01-06" />
    <META name="DC.Language" scheme="rfc1766" content="en" />
    <META name="DC.Rights" content="Copyright Â© 2003-2011, The Apache Software Foundation" />
    <META http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html" l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html" l gen true r (n 0 s 0 v 0 l 0) "http://www.classify.org/safesurf/" l gen true r (SS~~000 1))'/>

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>


    <title>Apache Geronimo Development : Clustering Configuration for Jetty</title>

  </head>

  <body onload="init()">

    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tr>
        <td valing="top" align="left">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </table>

    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" align="left" nowrap>
          <a href="/geronimo"> Home</a> >&nbsp;<a href="index.html">Index</a>&nbsp;&gt;&nbsp;<a href="clustering.html">Clustering</a>&nbsp;&gt;&nbsp;<a href="clustering-configuration-for-jetty.html">Clustering Configuration for Jetty</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
        </td>
      </tr> 
    </table>

    <div id="PageContent">
      <div class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div style="margin: 0px 10px 0px 10px" class="smalltext">Apache Geronimo Development</div>
        <div style="margin: 0px 10px 8px 10px"  class="pagetitle">Clustering Configuration for Jetty</div>

        <div class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
<!-- -->         
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=34920">
            <img src="http://geronimo.apache.org/images/icons/notep_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Edit Page"></a>
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=34920">Edit Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDEV">
            <img src="http://geronimo.apache.org/images/icons/browse_space.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Browse Space"></a>
            <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDEV">Browse Space</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDEV&fromPageId=34920">
            <img src="http://geronimo.apache.org/images/icons/add_page_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add Page"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDEV&fromPageId=34920">Add Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDEV&fromPageId=34920">
            <img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add News"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDEV&fromPageId=34920">Add News</a>
<!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent"><plain-text-body>{scrollbar}</plain-text-body>
<h1 id="ClusteringConfigurationforJetty-StandardandGeronimoSpecificDeploymentDescriptorUpdates">Standard and Geronimo Specific Deployment Descriptor Updates</h1>

<p>In order to cluster a Web application, standard and Geronimo specific deployment descriptors must be updated as follows:</p>
<ul><li>standard deployment descriptor, i.e. web.xml:  the Web application must be marked as distributable. In other words, the optional "distributable" element must be defined.</li><li>Geronimo specific deployment descriptor, i.e. geronimo-web.xml: the "clustering-wadi" substitution group must be defined. This element provides a Web application specific clustering configuration, which overrides the default clustering configuration. The default clusering configuration is defined by the GBean WADIJettyClusteringBuilder declared by the org.apache.geronimo.configs/jetty6-clustering-builder-wadi//car module.</li></ul>


<h1 id="ClusteringConfigurationforJetty-ClusteringConfigurationOverview">Clustering Configuration Overview</h1>
<p>Four configurations are of interest to us:</p>
<ul><li><em>org.apache.geronimo.configs/clustering//car</em>: it defines the runtime dependencies that a clustered Web application must have. For instance, it imports the geronimo-clustering JAR into the classpath of such Web applications. Also, it defines a BasicNode GBean, which defines an unique name for this Geronimo instance in a cluster.<br clear="none">
In order to give a specific name to a Geronimo instance, this module can be reconfigured by updating the clusterNodeName property defined within var/config/config-substitutions.properties:
<plain-text-body>
clusterNodeName=MyOwnNodeName
</plain-text-body></li></ul>


<ul><li><em>org.apache.geronimo.configs/jetty6-clustering-wadi//car</em>: it defines the runtime dependencies of WADI, which is the actual clustering provider. Also, it defines a WADI implementation of the Jetty6 clustering contracts.</li><li><em>org.apache.geronimo.configs/jetty6-clustering-builder-wadi//car</em>: it defines the build time dependencies along with a WADIJettyClusteringBuilder GBean, which declares the default clustering configuration and knows how to process the "clustering-wadi" element.</li></ul>


<ul><li><em>org.apache.geronimo.configs/wadi-clustering//car</em>: it defines WADI specific GBeans used to further configure the behavior of a clustered application. This is in this module, by overriding the DefaultBackingStrategyFactory GBean, that the default number of replicas (set to 2 out-of-the-box) to be maintained across the cluster for a given session is configured.</li></ul>


<h1 id="ClusteringConfigurationforJetty-CreatinganewGeronimoInstance">Creating a new Geronimo Instance</h1>
<p>The simplest way to create a new Geronimo instance is to:</p>
<ul><li>create a new directory, say node2, under the Geronimo installation dir;</li><li>copy the var directory into it; and</li><li>change the PortOffset property within node2/var/config/config-substitutions.properties. For instance, the creation of a new instance named node2 could be achieved like this:
<plain-text-body>
cd $GERONIMO_HOME
mkdir node2
cp -r var node2
perl -pi -e 's/PortOffset=0/PortOffset=1/' node2/var/config/config-substitutions.properties
</plain-text-body></li></ul>


<ul><li>give to this instance a unique name by updating the clusterNodeName property within node2/var/config/config-substitutions.properties:
<plain-text-body>
clusterNodeName=NODE2
</plain-text-body>
In order to start this new instance, you need to set the org.apache.geronimo.server.name system property to the name of the new instance. In the case of the above example, node2 can be started like this from the gshell prompt:
<plain-text-body>
geronimo/start-server -G server.name=node2 -b
</plain-text-body></li></ul>


<ul><li>ensure that the system property java.net.preferIPv4Stack is set to true when a Geronimo instance is started. Uncomment the following line within etc/rc.d/start-server,default.groovy:
<plain-text-body>
// Uncomment this property so that Tribes work on Mac OS X
command.properties['java.net.preferIPv4Stack'] = true
</plain-text-body>
<parameter ac:name="title">System Property java.net.preferIPv4Stack</parameter><rich-text-body>
<p>The system property java.net.preferIPv4Stack must be set to true otherwise Tribes, the group communication used by WADI, fails (at least on MAC OS X).</p></rich-text-body></li></ul>


<h1 id="ClusteringConfigurationforJetty-DeployingaDemonstrationWebApplicationandTestingClustering">Deploying a Demonstration Web Application and Testing Clustering</h1>

<h2 id="ClusteringConfigurationforJetty-DeployingaDemonstrationWebapplication">Deploying a Demonstration Web application</h2>
<ul><li>Start an instance, e.g. the out-of-the-box one:
<plain-text-body>
geronimo/start-server -D node.name=red -b
</plain-text-body>
<parameter ac:name="title">System Property node.name</parameter><rich-text-body>
<p>The system property node.name is only required by a WADI Web application, which will be deployed later to verify the installation.</p></rich-text-body></li></ul>


<ul><li>Start the org.apache.geronimo.configs/jetty6-clustering-builder-wadi//car module if need be:
<plain-text-body>
deploy/start org.apache.geronimo.configs/jetty6-clustering-builder-wadi/2.0-SNAPSHOT/car
</plain-text-body>
<parameter ac:name="title">Why should this module be started</parameter><rich-text-body>
<p>If this module is not started, then the "clustering-wadi" element is not recognized and the deployment fails.</p></rich-text-body></li></ul>


<ul><li>Deploy the Demonstration Web application and start it.<br clear="none">
WADI provides a demonstration Web application, which can be downloaded from this link:
<a shape="rect" class="external-link" href="http://snapshots.repository.codehaus.org/org/codehaus/wadi/wadi-webapp/2.0-SNAPSHOT/wadi-webapp-2.0-20080318.132141-11.war" rel="nofollow">http://snapshots.repository.codehaus.org/org/codehaus/wadi/wadi-webapp/2.0-SNAPSHOT/wadi-webapp-2.0-20080318.132141-11.war</a>
<plain-text-body>
curl -o wadi-webapp-2.0-SNAPSHOT.war http://snapshots.repository.codehaus.org/org/codehaus/wadi/wadi-webapp/2.0-SNAPSHOT/wadi-webapp-2.0-20080318.132141-11.war

// and from gshell
deploy/distribute /&lt;full path&gt;/wadi-webapp-2.0-SNAPSHOT.war
deploy/start org.codehaus.wadi/wadi-webapp/2.0-SNAPSHOT/war
</plain-text-body></li></ul>


<ul><li>Start a second instance, e.g. the node2 instance previously created:
<plain-text-body>
geronimo/start-server -D node.name=yellow -G server.name=node2 -b
</plain-text-body></li></ul>


<ul><li>Start the Web application deployed at step 2.
<plain-text-body>
deploy/start --port 1100 org.codehaus.wadi/wadi-webapp/2.0-SNAPSHOT/war
</plain-text-body></li></ul>


<h2 id="ClusteringConfigurationforJetty-TestingClustering">Testing Clustering</h2>
<p>These two above instances are now running a clustered version of the demonstration Web application.  This application implements a visual way to observe where a session is updated and where it is accessed.</p>

<ul><li>Let's create a session on the out-of-the-box instance, the red node, by accessing this URL: <a shape="rect" class="external-link" href="http://127.0.0.1:8080/wadi-webapp/index.jsp" rel="nofollow">http://127.0.0.1:8080/wadi-webapp/index.jsp</a><br clear="none">
You should see:<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="clustering-configuration-for-jetty.data/Session%20Creation.png"></span>
	<ul><li>The 1 in red means that the session has been updated on the red node. The red background of each frame indicates that the session has been accessed by the red node.</li><li>In your browser, you can verify that the JSESSIONID cookie ends with NODE. This information can be leveraged by load-balancers to provide sticky load-balancing.</li></ul>
	</li></ul>


<ul><li>Let's now request the same session from node2, the yellow node: <a shape="rect" class="external-link" href="http://127.0.0.1:8081/wadi-webapp/index.jsp" rel="nofollow">http://127.0.0.1:8081/wadi-webapp/index.jsp</a><br clear="none">
You should see:<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="clustering-configuration-for-jetty.data/Session%20Relocation.png"></span>
	<ul><li>The 2 in yellow means that the session has been updated on the yellow node. The session state, i.e. the 1 in red, has been migrated from the red to the yellow node. The yellow background of each frame indicates that the session has been accessed by the yellow node.</li><li>In your browser, you can verify that the JSESSIONID cookie for the /wadi path ends with NODE2. As expected, the session cookie has been updated to reflect the new location of the session.
<parameter ac:name="title">This is not working as expected</parameter><rich-text-body>
<p>If you see a 1 instead of a 2, then the nodes do not see each other. The first thing to verify is that the system property java.net.preferIPv4Stack is indeed set to true. If it is set to true, then it is likely that multicasting is not properly working on the boxes running the nodes. Look at your firewall and network configurations to ensure that multicasting is allowed.</p></rich-text-body></li></ul>
	</li></ul>


<ul><li>If you put these two instances behind Apache mod_proxy and access the same URL: <a shape="rect" class="external-link" href="http://127.0.0.1:8100/wadi-webapp/index.jsp" rel="nofollow">http://127.0.0.1:8100/wadi-webapp/index.jsp</a><br clear="none">
You should see something like:<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="clustering-configuration-for-jetty.data/Behind%20mod_proxy.png"></span>
	<ul><li>The 3 may be in yellow or red and the background color of each frame is a mix of yellow and red. This mix of colors indicates that the session has been migrated between the red and yellow instances depending on the target instance selected by mod_proxy for each frame.</li></ul>
	</li></ul>


<ul><li>You can access repetitively the reverse proxy URL to confirm the robustness of the session migration implementation. All the requests are successful, i.e. without any state lost. For instance, you should see something like that:<br clear="none">
<span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="clustering-configuration-for-jetty.data/Migraiton%20Robustness.png"></span></li></ul>


<ul><li>To confirm that replication is working fine, you can kill -9 a node and access the URL of the remaining node and observe that the state is properly restored.</li></ul></div>
        </div>

        
      </div>
    </div>

    <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="middle" class="footer">
            &nbsp;&nbsp;
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Delicious" />
            <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">Bookmark this on Delicious</a>
            &nbsp;&nbsp;
            <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="Digg!" />
            <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title)+'&amp;topic=programming');">Digg this</a>
            <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo Development : Clustering Configuration for Jetty';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
            &nbsp;&nbsp;
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">Privacy Policy</a>&nbsp;&nbsp;-&nbsp;&nbsp;
            Copyright &#169; 2003-2011, The Apache Software Foundation, Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0.</a>&nbsp;&nbsp;
          </td>
        </tr>
    </table> 

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-4380560-1");
pageTracker._initData();
pageTracker._trackPageview();
</script>
  </body>
</html>
