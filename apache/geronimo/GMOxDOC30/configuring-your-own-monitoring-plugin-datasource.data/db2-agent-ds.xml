<connector xmlns="http://geronimo.apache.org/xml/ns/j2ee/connector-1.2">
  <dep:environment xmlns:dep="http://geronimo.apache.org/xml/ns/deployment-1.2">
    <dep:moduleId>
      <dep:groupId>org.apache.geronimo.plugins.monitoring</dep:groupId>
      <dep:artifactId>db2-agent-ds</dep:artifactId>
      <dep:version>2.2-SNAPSHOT</dep:version>
      <dep:type>car</dep:type>
    </dep:moduleId>

    <dep:dependencies>
      <dep:dependency>
        <dep:groupId>org.apache.geronimo.plugins.monitoring</dep:groupId>
        <dep:artifactId>agent-sql</dep:artifactId>
        <dep:version>2.2-SNAPSHOT</dep:version>
        <dep:type>jar</dep:type>
      </dep:dependency>
      <dep:dependency>
        <dep:groupId>com.ibm.db2</dep:groupId>
        <dep:artifactId>db2jcc</dep:artifactId>
        <dep:version>9.5.0</dep:version>
        <dep:type>jar</dep:type>
      </dep:dependency>
      <dep:dependency>
        <dep:groupId>com.ibm.db2</dep:groupId>
        <dep:artifactId>db2jcc_license_cu</dep:artifactId>
        <dep:version>9.5.0</dep:version>
        <dep:type>jar</dep:type>
      </dep:dependency>
    </dep:dependencies>

    <dep:hidden-classes/>
    <dep:non-overridable-classes/>
    <dep:private-classes/>
  </dep:environment>
 
 <resourceadapter>
    <outbound-resourceadapter>
      <!--Pool for Active Statistics-->
      <connection-definition>
        <connectionfactory-interface>javax.sql.DataSource</connectionfactory-interface>
        <connectiondefinition-instance>
          <name>jdbc/ActiveDS</name>
	   <config-property-setting name="UserName">db2admin</config-property-setting>
          <config-property-setting name="Password">db2manager</config-property-setting>
          <config-property-setting name="PortNumber">50000</config-property-setting>
          <config-property-setting name="ServerName">localhost</config-property-setting>
          <config-property-setting name="DatabaseName">activedb</config-property-setting>
          <config-property-setting name="DriverType">4</config-property-setting>          
          <connectionmanager>
            <xa-transaction>
                     <transaction-caching/>
            </xa-transaction>

            <single-pool>
              <max-size>10</max-size>
              <min-size>0</min-size>
              <match-one/>
            </single-pool>
          </connectionmanager>
        </connectiondefinition-instance>
      </connection-definition>
      <!--Pool for Archived Statistics-->
      <connection-definition>
        <connectionfactory-interface>javax.sql.DataSource</connectionfactory-interface>
        <connectiondefinition-instance>
          <name>jdbc/ArchiveDS</name>
          <config-property-setting name="UserName">db2admin</config-property-setting>
          <config-property-setting name="Password">db2manager</config-property-setting>
          <config-property-setting name="PortNumber">50000</config-property-setting>
          <config-property-setting name="ServerName">localhost</config-property-setting>
          <config-property-setting name="DatabaseName">archdb</config-property-setting>
          <config-property-setting name="DriverType">4</config-property-setting>          
          <connectionmanager>
            <xa-transaction>
                     <transaction-caching/>
            </xa-transaction>

            <single-pool>
              <max-size>10</max-size>
              <min-size>0</min-size>
              <match-one/>
            </single-pool>
          </connectionmanager>
        </connectiondefinition-instance>
      </connection-definition>
    </outbound-resourceadapter>
  </resourceadapter>
  <!--These two GBeans will create the tables for the database automatically-->
  <gbean name="ActiveDSGBean" class="org.apache.geronimo.connector.DatabaseInitializationGBean">
    <attribute name="testSQL">SELECT t.tablename FROM SYS.SYSTABLES t WHERE lower(t.tablename)='statistics'</attribute>
    <attribute name="path">META-INF/database/derby/createTables.sql</attribute>
    <reference name="DataSource">
      <name>jdbc/ActiveDS</name>
    </reference>
  </gbean>
  <gbean name="ArchiveDSGBean" class="org.apache.geronimo.connector.DatabaseInitializationGBean">
    <attribute name="testSQL">SELECT t.tablename FROM SYS.SYSTABLES t WHERE lower(t.tablename)='statistics'</attribute>
    <attribute name="path">META-INF/database/derby/createTables.sql</attribute>
    <reference name="DataSource">
      <name>jdbc/ArchiveDS</name>
    </reference>
  </gbean>
  <!--this ought to be in the agent plan but this realm is not always started before the credential-store, even with the dependency-->
  <gbean name="monitoring-runas-realm" class="org.apache.geronimo.security.realm.GenericSecurityRealm">
    <attribute name="realmName">monitoring-runas-realm</attribute>
    <attribute name="global">false</attribute>
    <xml-reference name="LoginModuleConfiguration">
      <lc:login-config xmlns:lc="http://geronimo.apache.org/xml/ns/loginconfig-1.2">
        <lc:login-module control-flag="REQUIRED">
          <lc:login-domain-name>monitoring-runas-domain</lc:login-domain-name>
          <lc:login-module-class>org.apache.geronimo.security.credentialstore.RunAsLoginModule</lc:login-module-class>
          <lc:option name="principalClass">org.apache.geronimo.security.realm.providers.GeronimoGroupPrincipal</lc:option>
          <lc:option name="principalNames">admin</lc:option>
        </lc:login-module>
      </lc:login-config>
    </xml-reference>
    <!--<reference name="ServerInfo">-->
    <!--<name>ServerInfo</name>-->
    <!--</reference>-->
  </gbean>
</connector>
