<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="http://geronimo.apache.org/style/default.css">
    <LINK rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <LINK rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <META name="Description" content="ldap-sample-app - LDAP Sample Application" />
    <META name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi ldap-sample-app - LDAP Sample Application" />
    <META name="Owner" content="dev@geronimo.apache.org" />
    <META name="Robots" content="index, follow" />
    <META name="Security" content="Public" />
    <META name="Source" content="wiki template" />
    <META name="DC.Date" scheme="iso8601" content="2010-05-11" />
    <META name="DC.Language" scheme="rfc1766" content="en" />
    <META name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation" />
    <META http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html" l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html" l gen true r (n 0 s 0 v 0 l 0) "http://www.classify.org/safesurf/" l gen true r (SS~~000 1))'/>

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>


    <title>Apache Geronimo v3.0 Documentation: ldap-sample-app - LDAP Sample Application</title>
  </head>

  <body onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tr>
        <td valing="top" align="left">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" align="left" nowrap>
          <a href="/geronimo"> Home</a> >&nbsp;<a href="documentation.html">Documentation</a>&nbsp;&gt;&nbsp;<a href="reference.html">Reference</a>&nbsp;&gt;&nbsp;<a href="samples.html">Samples</a>&nbsp;&gt;&nbsp;<a href="java-ee-sample-applications.html">Java EE sample applications</a>&nbsp;&gt;&nbsp;<a href="ldap-sample-app-ldap-sample-application.html">ldap-sample-app - LDAP Sample Application</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
        </td>
      </tr> 
    </table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div style="margin: 0px 10px 0px 10px" class="smalltext">Apache Geronimo v3.0</div>
        <div style="margin: 0px 10px 8px 10px"  class="pagetitle">ldap-sample-app - LDAP Sample Application</div>

        <div class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
<!-- -->         
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645372">
            <img src="http://geronimo.apache.org/images/icons/notep_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Edit Page"></a>
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645372">Edit Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">
            <img src="http://geronimo.apache.org/images/icons/browse_space.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Browse Space"></a>
            <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">Browse Space</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645372">
            <img src="http://geronimo.apache.org/images/icons/add_page_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add Page"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645372">Add Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645372">
            <img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add News"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645372">Add News</a>
<!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent"><plain-text-body>{scrollbar}</plain-text-body>
<p><parameter ac:name="">top</parameter></p>

<p>This sample shows how you can use a Lightweight Directory Access Protocol (LDAP) server to configure and control access to resources on your Geronimo server.</p>

<p>There are two routes to running this sample. You can either use the Apache Geronimo plugin (version 1.0) for the Apache Directory Service 1.5.1 or you can use an external LDAP server.</p>

<p>One way to install the Apache Geronimo-Apache Directory Server Plugin is by navigating in the Geronimo Administration Console to <strong>Applications</strong> -&gt; <strong>Plugins</strong>.  Once in the view, updating the repository list (which should add a repository for your installed Geronimo version if not already included), selecting the referenced repository, and then select <strong>Show Plugins in selected repository</strong> to display the list of all possible plugins in this directory.  Locate the <strong>Apache Geronimo-Apache Directory Server Plugin</strong> and then install it.  Source for this plugin can be found at <a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/geronimo/plugins/directory/branches/1.0/">Geromino Directory Plugin Source</a>. </p>
<rich-text-body>
<p>NOTE:  The Apache Geronimo-Apache Directory plugin can not be installed in Geronimo 2.1.2.  If you are using Geronimo 2.1.2 with this sample you must use an external LDAP server.  However, the Apache Geronimo-Apache Directory plugin can be installed in Geronimo 2.1.3 and this sample works equally well with the Geronimo 2.1.3.</p></rich-text-body>


<p>Geronimo uses the Apache Directory Server for its directory service, this is part of the <a shape="rect" class="external-link" href="http://directory.apache.org">Apache Directory Project</a>. Geronimo implements the following two projects from the ApacheDS project.</p>

<ul><li><strong>ApacheDS Core</strong><br clear="none">
Server's core contains all backend subsystems. It depends on protocol and uses it with seda to service Lightweight Directory Access Protocol (LDAP) requests. The core contains the JNDI provider, interceptor framework, interceptor services, the schema subsystem and the database subsystem. Hence the core is the heart of the server.</li></ul>


<ul><li><strong>ApacheDS Shared</strong><br clear="none">
Created to eliminate cyclic project dependencies between the core and the maven plug-in. Any code shared across modules in general can go here so long as it does not depend on other modules.</li></ul>


<p>More information about these two projects can be found at the ApacheDS project URL:<br clear="none">
<a shape="rect" class="external-link" href="http://directory.apache.org/subprojects/apacheds/projects/index.html">http://directory.apache.org/subprojects/apacheds/projects/index.html</a></p>

<p>At this point in time, the Geronimo plugin only provides LDAP viewing capabilities, editing is not there yet but adding this feature is in plan for the next releases of Geronimo. You will have to use an external LDAP client such as ldapbrowser/editor, jxplorer or gq for editing the configurations of the Directory Server in Geronimo.</p>

<p>The other alternative is to use Geronimo with an external LDAP server. For example, you may download Apache Directory Service binary, start the ldap server and load it up with the ldap-sample.ldif givenand follow the rest of the sample instructions.</p>


<p>This article is organized in the following sections:</p>
<parameter ac:name="maxLevel">3</parameter>

<h1 id="ldap-sample-app-LDAPSampleApplication-StartingtheLDAPserver">Starting the LDAP server</h1>
<p>If you installed the Apache Geronimo-Apache Directory Plugin it should have been started as part of the installation.  You can verify that it is started from command line using the deployer tool or via the Geronimo Administration Console.</p>

<p>Using the Administration Console click on <strong>System Modules</strong> on the navigation menu from the left and look for the component name <strong>org.apache.geronimo.plugins/directory</strong> in the <strong>Installed System Modules</strong> portlet. You will see the current status and available commands for this particular component.</p>

<p>Alternatively, if you are using an external LDAP server, start that server in the normal manner and follow the remaining instructions here.</p>

<p><a shape="rect" href="ldap-sample-app-ldap-sample-application.html">Back to Top</a></p>

<h1 id="ldap-sample-app-LDAPSampleApplication-SourceCodeforSample">Source Code for Sample</h1>

<p>Please reference <a shape="rect" href="../GMOxDOC21/sample-applications.html">Samples General Information</a> for information on obtaining and building the source for this and other samples.</p>


<p>At this point you can choose to install an LDAP client and import/export an <strong><code>.ldif</code></strong> file to a directory server.  However, this is not required.  Directions are provided if you choose to not install an LDAP client.</p>

<p><a shape="rect" href="ldap-sample-app-ldap-sample-application.html">Back to Top</a></p>

<h1 id="ldap-sample-app-LDAPSampleApplication-AddLDAPentries">Add LDAP entries</h1>
<p>Ensure that Geronimo is up and running and the Directory service is started. </p>

<h2 id="ldap-sample-app-LDAPSampleApplication-Toaddentriesmanually">To add entries manually</h2>
<p>When you installed the <strong>Apache Geronimo-Apache Directory plugin</strong> you may have noticed a message on the console similar to the following:</p>

<parameter ac:name="borderStyle">solid</parameter><plain-text-body>
WARN  [ServerContextFactory] LDIF load directory '/Users/user1/geronimo-tomcat6-javaee5-2.1/var/ldif' does not exist.  No LDIF files will be loaded.
</plain-text-body>

<p>This is because the directory server does not yet have any content.  You can manually add the content necessary for the sample by including the <strong>ldap-sample.ldif</strong> from the sample source in the location specified in the message (&lt;geronimo-home&gt;/var/ldif/) and restarting the Geronimo server or optionally just the directory configuration in the server. </p>

<h2 id="ldap-sample-app-LDAPSampleApplication-ToaddentriesusinganLDAPclient">To add entries using an LDAP client</h2>
<p>Start your LDAP client and create a new connection profile with the following values:</p>

<div class="table-wrap"><table class="confluenceTable"><tbody><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> Host: </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> &lt;localhost&gt; </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> Port: </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> 10389 </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> Base DN: </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> ou=system </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> User DN: </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> uid=admin,ou=system </p></td></tr><tr><td colspan="1" rowspan="1" class="confluenceTd"><p> Password: </p></td><td colspan="1" rowspan="1" class="confluenceTd"><p> secret </p></td></tr></tbody></table></div>


<p>Once you connect to the Geronimo Directory server you will see the initial configuration, this configuration can be exported as a backup in a ldif file. Depending the LDAP client you are using the export/import steps will be different. For example, to export the initial configuration using the <strong>ldapsearch</strong> tool execute the following command:</p>

<p><code><strong>ldapsearch -h localhost -p 10389 -b "ou=system" -D "uid=admin,ou=system" -w secret -x "(objectclass=*)"</strong></code></p>

<p>When you export the initial configuration you get an ldif file with a content similar as the one shown in the following example.</p>
<parameter ac:name="title">export.ldif</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
dn: ou=system
ou: system
objectClass: organizationalUnit
objectClass: top

dn: uid=admin, ou=system
displayName: Directory Superuser
uid: admin
userPassword:: c2VjcmV0
objectClass: inetOrgPerson
objectClass: organizationalPerson
objectClass: person
objectClass: top
sn: administrator
cn: system administrator

dn: ou=users, ou=system
ou: users
objectClass: organizationalUnit
objectClass: top

dn: ou=groups, ou=system
ou: groups
objectClass: organizationalUnit
objectClass: top

dn: ou=configuration, ou=system
ou: configuration
objectClass: organizationalUnit
objectClass: top

dn: ou=partitions, ou=configuration, ou=system
ou: partitions
objectClass: organizationalUnit
objectClass: top

dn: ou=services, ou=configuration, ou=system
ou: services
objectClass: organizationalUnit
objectClass: top

dn: ou=interceptors, ou=configuration, ou=system
ou: interceptors
objectClass: organizationalUnit
objectClass: top

dn: prefNodeName=sysPrefRoot, ou=system
objectClass: extensibleObject
prefNodeName: sysPrefRoot
</plain-text-body>

<p>Now you need to import the entries needed to run the sample application. Packaged with the sample application is a sample <strong><code>.ldif</code></strong> file with all the entries necessary to run the LDAP sample application, this file is located in <strong>&lt;ldap_home&gt;/ldap-sample.ldif</strong>. To import the data with <strong>ldapmodify</strong> tool execute the following command:</p>

<p><code><strong>ldapmodify -h localhost -p 10389 -D "uid=admin,ou=system" -w secret -x -a -f &lt;ldap_home&gt;/ldap-sample.ldif</strong></code></p>

<p>The following example shows the content of the <strong><code>ldap-sample.ldif</code></strong> file.</p>
<parameter ac:name="title">ldap-sample.ldif</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
# User: system

dn: uid=system,ou=users,ou=system
cn: John Doe
sn: Doe
givenname: John
objectclass: top
objectclass: person
objectclass: organizationalPerson
objectclass: inetOrgPerson
ou: Human Resources
ou: People
l: Las Vegas
uid: system
mail: system@apachecon.comm
telephonenumber: +1 408 555 5555
facsimiletelephonenumber: +1 408 555 5556
roomnumber: 4613
userPassword: manager

# User: user1

dn: uid=user1,ou=users,ou=system
cn: User
sn: One
givenname: User1
objectclass: top
objectclass: person
objectclass: organizationalPerson
objectclass: inetOrgPerson
ou: Human Resources

ou: People
l: Las Vegas
uid: user1
mail: user1@apachecon.comm
telephonenumber: +1 408 555 5555
facsimiletelephonenumber: +1 408 555 5556
roomnumber: 4613
userPassword: p1

# User: user2

dn: uid=user2,ou=users,ou=system
cn: User
sn: Two
givenname: User2
objectclass: top
objectclass: person
objectclass: organizationalPerson
objectclass: inetOrgPerson
ou: Human Resources
ou: People
l: Las Vegas
uid: user2
mail: user2@apachecon.comm
telephonenumber: +1 408 555 5555
facsimiletelephonenumber: +1 408 555 5556
roomnumber: 4613
userPassword: p2

# Group: admin

dn: cn=admin,ou=groups,ou=system
objectClass: groupOfUniqueNames
uniqueMember: uid=system,ou=users,ou=system
uniqueMember: uid=user2,ou=users,ou=system
cn: admin

# Group: guest

dn: cn=guest,ou=groups,ou=system
objectClass: groupOfUniqueNames
uniqueMember: uid=user1,ou=users,ou=system
cn: guest
</plain-text-body>

<p>Once the file is imported you should get a confirmation that five entries were successfully imported.</p>

<p><a shape="rect" href="ldap-sample-app-ldap-sample-application.html">Back to Top</a></p>

<h1 id="ldap-sample-app-LDAPSampleApplication-DeploytheLDAPrealm">Deploy the LDAP realm</h1>

<p>One way to install the LDAP realm for the sample is by installing a Geronimo plugin created for this purpose.  You can do this by navigating in the Geronimo Administration Console to <strong>Applications</strong> -&gt; <strong>Plugins</strong>.  Once in the view, updating the repository list (which should add <a shape="rect" class="external-link" href="http://geronimo.apache.org/plugins/geronimo-2.1/">http://geronimo.apache.org/plugins/geronimo-2.1/</a> if not already included), selecting the referenced repository, and then select <strong>Show Plugins in selected repository</strong> to display the list of all possible plugins in this directory.  Locate the <strong>Geronimo Samples :: ldap-sample-app :: security realm</strong> and then install it.  However, this process hides many of the details of creating and installing the realm.  For those details refer to the next section.</p>

<h2 id="ldap-sample-app-LDAPSampleApplication-LDAPrealmdeploymentdetails">LDAP realm deployment details</h2>

<p>The LDAP sample application provides a security realm that needs to be deployed before the deployment of the application itself. This realm is located in <strong>&lt;ldap_home&gt;/ldap-realm.xml</strong> and the content is illustrated in the following example.</p>

<parameter ac:name="">xml</parameter><parameter ac:name="title">ldap-realm.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;module xmlns="http://geronimo.apache.org/xml/ns/deployment-1.2"&gt;
    &lt;environment&gt;
        &lt;moduleId&gt;
            &lt;groupId&gt;console.realm&lt;/groupId&gt;
            &lt;artifactId&gt;LDAP_Sample_Realm&lt;/artifactId&gt;
            &lt;version&gt;1.0&lt;/version&gt;
            &lt;type&gt;car&lt;/type&gt;
        &lt;/moduleId&gt;
    &lt;/environment&gt;
    &lt;gbean name="LDAP_Sample_Realm" class="org.apache.geronimo.security.realm.GenericSecurityRealm"
           xsi:type="dep:gbeanType" xmlns:dep="http://geronimo.apache.org/xml/ns/deployment-1.2"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;
        &lt;attribute name="realmName"&gt;LDAP_Sample_Realm&lt;/attribute&gt;
        &lt;reference name="ServerInfo"&gt;
            &lt;name&gt;ServerInfo&lt;/name&gt;
        &lt;/reference&gt;
        &lt;xml-reference name="LoginModuleConfiguration"&gt;
            &lt;log:login-config xmlns:log="http://geronimo.apache.org/xml/ns/loginconfig-1.2"&gt;
                &lt;log:login-module control-flag="REQUIRED" wrap-principals="false"&gt;
                    &lt;log:login-domain-name&gt;LDAP_Sample_Realm&lt;/log:login-domain-name&gt;
                    &lt;log:login-module-class&gt;org.apache.geronimo.security.realm.providers.LDAPLoginModule&lt;/log:login-module-class&gt;
                    &lt;log:option name="initialContextFactory"&gt;com.sun.jndi.ldap.LdapCtxFactory&lt;/log:option&gt;
                    &lt;log:option name="connectionURL"&gt;ldap://localhost:10389&lt;/log:option&gt;
                    &lt;log:option name="connectionUsername"&gt;uid=admin,ou=system&lt;/log:option&gt;
                    &lt;log:option name="connectionPassword"&gt;secret&lt;/log:option&gt;
                    &lt;log:option name="authentication"&gt;simple&lt;/log:option&gt;
                    &lt;log:option name="userBase"&gt;ou=users,ou=system&lt;/log:option&gt;
                    &lt;log:option name="userSearchMatching"&gt;uid={0}&lt;/log:option&gt;
                    &lt;log:option name="userSearchSubtree"&gt;false&lt;/log:option&gt;
                    &lt;log:option name="roleBase"&gt;ou=groups,ou=system&lt;/log:option&gt;
                    &lt;log:option name="roleName"&gt;cn&lt;/log:option&gt;
                    &lt;log:option name="roleSearchMatching"&gt;(uniqueMember={0})&lt;/log:option&gt;
                    &lt;log:option name="roleSearchSubtree"&gt;false&lt;/log:option&gt;
                &lt;/log:login-module&gt;
                &lt;log:login-module control-flag="OPTIONAL" wrap-principals="false"&gt;
                    &lt;log:login-domain-name&gt;LDAP_Sample_Realm-Audit&lt;/log:login-domain-name&gt;
                    &lt;log:login-module-class&gt;org.apache.geronimo.security.realm.providers.FileAuditLoginModule&lt;/log:login-module-class&gt;
                    &lt;log:option name="file"&gt;var/log/login-attempts.log&lt;/log:option&gt;
                &lt;/log:login-module&gt;
            &lt;/log:login-config&gt;
        &lt;/xml-reference&gt;
    &lt;/gbean&gt;
&lt;/module&gt;
</plain-text-body>

<p>This deployment plan tell Geronimo all the connection and search parameters against the LDAP database. This plan also specifies to record each login attempt into the <code>login-attempts.log</code> log file.</p>

<p>To deploy the ldap-realm.xml run the following command from the &lt;geronimo_home&gt;/bin directory:</p>

<p><code><strong>java -jar deployer.jar --user system --password manager deploy &lt;ldap_home&gt;/ldap-realm.xml</strong></code></p>

<p>Once deployed you should see a confirmation message similar to the following example:</p>
<parameter ac:name="borderStyle">solid</parameter><plain-text-body>
D:\geronimo-tomcat6-jee5-2.0\bin&gt;deploy deploy \samples\2.0\ldap-sample-app\ldap-realm.xml
Using GERONIMO_BASE:   D:\geronimo-tomcat6-javaee5-2.1.2
Using GERONIMO_HOME:   D:\geronimo-tomcat6-javaee5-2.1.2
Using GERONIMO_TMPDIR: D:\geronimo-tomcat6-javaee5-2.1.2\var\temp
Using JRE_HOME:        C:\Java\jdk1.5.0_06\\jre
    Deployed console.realm/LDAP_Sample_Realm/1.0/car
</plain-text-body>
<p><a shape="rect" href="ldap-sample-app-ldap-sample-application.html">Back to Top</a></p>

<p>For further details refer to the <a shape="rect" href="ldap-realm.html">LDAP Realm</a> section.</p>

<h1 id="ldap-sample-app-LDAPSampleApplication-CreatingandInstallingtheLDAPSampleApplication">Creating and Installing the LDAP Sample Application</h1>
<p>One way to install the LDAP sample application is by installing a Geronimo plugin created for this purpose.  You can do this by navigating in the Geronimo Administration Console to <strong>Applications</strong> -&gt; <strong>Plugins</strong>.  Once in the view, updating the repository list (which should add <a shape="rect" class="external-link" href="http://geronimo.apache.org/plugins/geronimo-2.1.2/">http://geronimo.apache.org/plugins/geronimo-2.1.2/</a> if not already included), selecting the referenced repository, and then select <strong>Show Plugins in selected repository</strong> to display the list of all possible plugins in this directory.  Locate the <strong>Geronimo Configs :: LDAP Sample for Tomcat</strong> or <strong>Geronimo Configs :: LDAP Sample for Jetty</strong> (depending upon you Geronimo service choice) and then install it.  However, this process hides many of the details of creating and installing the sample.  For those details refer to the next section.</p>

<h2 id="ldap-sample-app-LDAPSampleApplication-Deploymentplans">Deployment plans</h2>

<p>There is a common deployment plan that is used for the sample.  The unprocessed version of this plan is at ldap-sample-app/ldap-sample-app-jetty/src/main/plan/plan.xml. The processed version shown here with plugin name and all dependencies filled in can be found at ldap-sample-app/ldap-sample-app-jetty/target/resources/META-INF/plan.xml after building the project.</p>

<parameter ac:name="">xml</parameter><parameter ac:name="title">plan.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns="http://geronimo.apache.org/xml/ns/j2ee/web-1.2"&gt;
  &lt;dep:environment xmlns:dep="http://geronimo.apache.org/xml/ns/deployment-1.2"&gt;
    &lt;dep:moduleId&gt;
      &lt;dep:groupId&gt;org.apache.geronimo.samples&lt;/dep:groupId&gt;
      &lt;dep:artifactId&gt;ldap-sample-app-jetty&lt;/dep:artifactId&gt;
      &lt;dep:version&gt;2.1.2&lt;/dep:version&gt;
      &lt;dep:type&gt;car&lt;/dep:type&gt;
    &lt;/dep:moduleId&gt;
    &lt;dep:dependencies&gt;
      &lt;dep:dependency&gt;
        &lt;dep:groupId&gt;org.apache.geronimo.samples&lt;/dep:groupId&gt;
        &lt;dep:artifactId&gt;ldap-sample-app-realm&lt;/dep:artifactId&gt;
        &lt;dep:version&gt;2.1.2&lt;/dep:version&gt;
        &lt;dep:type&gt;car&lt;/dep:type&gt;
      &lt;/dep:dependency&gt;
      &lt;dep:dependency&gt;
        &lt;dep:groupId&gt;org.apache.geronimo.configs&lt;/dep:groupId&gt;
        &lt;dep:artifactId&gt;jasper&lt;/dep:artifactId&gt;
        &lt;dep:version&gt;2.1.2&lt;/dep:version&gt;
        &lt;dep:type&gt;car&lt;/dep:type&gt;
      &lt;/dep:dependency&gt;
      &lt;dep:dependency&gt;
        &lt;dep:groupId&gt;org.apache.geronimo.configs&lt;/dep:groupId&gt;
        &lt;dep:artifactId&gt;jetty6&lt;/dep:artifactId&gt;
        &lt;dep:version&gt;2.1.2&lt;/dep:version&gt;
        &lt;dep:type&gt;car&lt;/dep:type&gt;
      &lt;/dep:dependency&gt;
    &lt;/dep:dependencies&gt;
    &lt;dep:hidden-classes/&gt;
    &lt;dep:non-overridable-classes/&gt;
  &lt;/dep:environment&gt;
  &lt;context-root&gt;/LDAP_Sample&lt;/context-root&gt;
  &lt;security-realm-name&gt;LDAP_Sample_Realm&lt;/security-realm-name&gt;
  &lt;security&gt;
    &lt;default-principal realm-name="LDAP_Sample_Realm"&gt;
      &lt;principal class="org.apache.geronimo.security.realm.providers.GeronimoUserPrincipal" name="system"/&gt;
    &lt;/default-principal&gt;
    &lt;role-mappings&gt;
      &lt;role role-name="content-administrator"&gt;
        &lt;realm realm-name="LDAP_Sample_Realm"&gt;
          &lt;principal class="org.apache.geronimo.security.realm.providers.GeronimoGroupPrincipal" name="admin" designated-run-as="true"/&gt;
          &lt;principal class="org.apache.geronimo.security.realm.providers.GeronimoUserPrincipal" name="system"/&gt;
        &lt;/realm&gt;
      &lt;/role&gt;
      &lt;role role-name="guest"&gt;
        &lt;realm realm-name="LDAP_Sample_Realm"&gt;
          &lt;principal class="org.apache.geronimo.security.realm.providers.GeronimoGroupPrincipal" name="guest" designated-run-as="true"/&gt;
          &lt;principal class="org.apache.geronimo.security.realm.providers.GeronimoUserPrincipal" name="user1"/&gt;
        &lt;/realm&gt;
      &lt;/role&gt;
    &lt;/role-mappings&gt;
  &lt;/security&gt;
&lt;/web-app&gt;
</plain-text-body>

<p>Most of the deployment plan is straight forward. However, the security configuration is tricky. The &lt;security-realm-name&gt; is described in the &lt;security&gt; element through a sequence of declarations in each &lt;realm&gt; element.</p>

<p>While the web.xml specifies the security roles, the plan.xml maps to which specific users or groups in the Geronimo security realms they belong to. If there is a user that is not logged in, it defaults to what is defined in the &lt;default-principal&gt; element.</p>

<p>There are two roles that are issued in this project: content-administrator and guest. And they each hold two principals: a GeronimoGroupPrincipal and a GeronimoUserPrincipal. Since the 'designated-run-as' flag is turned on for some principals, they will be the ones used if the deployable has a run-as role set in the web.xml.</p>

<p>Note that these role mappings will be overridden by the actual roles (what users pertaining to what groups) defined in the LDAP server. Ultimately it is the realm defined in the application deployment plan who determines the validation method. Nevertheless, for this particular example, you still need to define principals and role mappings as determined in the <a shape="rect" class="external-link" href="http://geronimo.apache.org/xml-schemas.html">XML schemas</a></p>

<p><a shape="rect" href="ldap-sample-app-ldap-sample-application.html">Back to Top</a></p>

<p>The <strong>web.xml</strong> deployment descriptor shown in the following example (also located in the <strong>&lt;ldap_home&gt;/WEB-INF</strong> diretory) adds security constraints based on the location of the files.</p>

<parameter ac:name="">xml</parameter><parameter ac:name="title">web.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;web-app xmlns="http://java.sun.com/xml/ns/j2ee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"
         version="2.4"&gt;

    &lt;welcome-file-list&gt;
        &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;
    &lt;/welcome-file-list&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Admin Role&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/protect/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;content-administrator&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;No Access&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/forbidden/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint/&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;FORM&lt;/auth-method&gt;
        &lt;realm-name&gt;ldap-realm-1&lt;/realm-name&gt;
        &lt;form-login-config&gt;
            &lt;form-login-page&gt;/auth/logon.html?param=test&lt;/form-login-page&gt;
            &lt;form-error-page&gt;/auth/logonError.html?param=test&lt;/form-error-page&gt;
        &lt;/form-login-config&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;content-administrator&lt;/role-name&gt;
    &lt;/security-role&gt;

&lt;/web-app&gt;
</plain-text-body>
<p><a shape="rect" href="ldap-sample-app-ldap-sample-application.html">Back to Top</a></p>

<h2 id="ldap-sample-app-LDAPSampleApplication-Packagethesampleapplication">Package the sample application</h2>

<p>You can build the war alone from within the ldap-sample-app-war directory and issuing the following command:</p>

<p><strong><code>mvn clean install</code></strong></p>

<p>This command will package all the existing files and directories inside <strong>&lt;ldap_home&gt;</strong>. Although not needed inside the .war file, the ldap-realm.xml and ldap-sample.ldif files will also be included.</p>

<p><a shape="rect" href="ldap-sample-app-ldap-sample-application.html">Back to Top</a></p>

<h2 id="ldap-sample-app-LDAPSampleApplication-Deploythesampleapplication">Deploy the sample application</h2>

<p>It's easiest to deploy the appropriate Geronimo plugin for your specific server image (either tomcat or jetty).  This will deploy the sample application with the Geronimo deployment plan specified earier.  However, you can optionally choose to deploy the war with the appropriate deployment plan.  To deploy the LDAP sample application in this fashion, make sure the Geronimo server is up and running. Open a command line window, change directory to &lt;geronimo_home&gt;/bin and run the following command:</p>

<p><code><strong>java -jar deployer.jar --user system --password manager deploy &lt;ldap_home&gt;/ldap-demo.war</strong> &lt;deployment_plan_home&gt;/plan.xml</code></p>


<h1 id="ldap-sample-app-LDAPSampleApplication-Testingthesampleapplication">Testing the sample application</h1>

<p>Once the Web application is successfully deployed you should see a confirmation message similar as the one shown in the following example:</p>

<parameter ac:name="borderStyle">solid</parameter><plain-text-body>
D:\geronimo-tomcat6-jee5-2.0\bin&gt;deploy deploy \samples\2.0\ldap-sample-app\ldap-demo.war
Using GERONIMO_BASE:   D:\geronimo-tomcat6-javaee5-2.1.2
Using GERONIMO_HOME:   D:\geronimo-tomcat6-javaee5-2.1.2
Using GERONIMO_TMPDIR: D:\geronimo-tomcat6-javaee5-2.1.2\var\temp
Using JRE_HOME:        C:\Java\jdk1.5.0_06\\jre
    Deployed samples/LDAP_Sample/1.2/war @
    http://localhost:8080/LDAP_Sample
    </plain-text-body>

<p>To test the LDAP application open a Web browser and access the following URL:</p>

<p><a shape="rect" class="external-link" href="http://localhost:8080/LDAP_Sample" rel="nofollow">http://localhost:8080/LDAP_Sample</a></p>

<p>The following figure shows the welcome page for the LDAP sample application.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="ldap-sample-app-ldap-sample-application.data/ldap_1.jpg"></span></p>

<p>Click on <a shape="rect" class="external-link" href="http://localhost:8080/LDAP_Sample/protect/" rel="nofollow">Protect</a> to validate against the LDAP Directory Server.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="ldap-sample-app-ldap-sample-application.data/ldap_2.jpg"></span></p>

<p>Enter <strong>system</strong> as the username and <strong>manager</strong> as the password and click <strong>Login</strong>. The username and password you provide here is the same you use to access the Geronimo Web console and it is stored in the Directory Server database. Once you are logged in you should see the following screen.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="ldap-sample-app-ldap-sample-application.data/ldap_3.jpg"></span></p>

<p>At this point you have an application that is validating username and passwords against an LDAP Directory Server database based on the security configuration you provided earlier in the LDAP realm. Now, if you go back to the welcome page and click on <a shape="rect" class="external-link" href="http://localhost:8080/LDAP_Sample/forbidden/" rel="nofollow">Forbidden</a> you should receive a 403 - Forbidden HTTP error similar to the one shown in the following figure.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="ldap-sample-app-ldap-sample-application.data/ldap_4.jpg"></span></p>

<p>Depending on the web container you are using (that is Jetty or Tomcat) the presentation of that screen may be slightly different.</p>

<p>To further test this example you could now try the different users provided in the <strong><code>ldap-sample.ldif</code></strong>, use your LDAP client and add/remove users from the different groups. You will notice the changes immediatly (you may need to close your web browser).</p>

<p><a shape="rect" href="ldap-sample-app-ldap-sample-application.html">Back to Top</a></p></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="middle" class="footer">
            &nbsp;&nbsp;
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Delicious" />
            <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">Bookmark this on Delicious</a>
            &nbsp;&nbsp;
            <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="Digg!" />
            <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title)+'&amp;topic=programming');">Digg this</a>
            <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : ldap-sample-app - LDAP Sample Application';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
            &nbsp;&nbsp;
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">Privacy Policy</a>&nbsp;&nbsp;-&nbsp;&nbsp;
            Copyright &#169; 2003-2013, The Apache Software Foundation, Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0.</a>&nbsp;&nbsp;
          </td>
        </tr>
    </table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  </body>
</html>
