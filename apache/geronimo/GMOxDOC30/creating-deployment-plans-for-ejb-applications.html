<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="http://geronimo.apache.org/style/default.css">
    <LINK rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <LINK rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <META name="Description" content="Creating deployment plans for EJB applications" />
    <META name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi Creating deployment plans for EJB applications" />
    <META name="Owner" content="dev@geronimo.apache.org" />
    <META name="Robots" content="index, follow" />
    <META name="Security" content="Public" />
    <META name="Source" content="wiki template" />
    <META name="DC.Date" scheme="iso8601" content="2010-05-11" />
    <META name="DC.Language" scheme="rfc1766" content="en" />
    <META name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation" />
    <META http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html" l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html" l gen true r (n 0 s 0 v 0 l 0) "http://www.classify.org/safesurf/" l gen true r (SS~~000 1))'/>

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>


    <title>Apache Geronimo v3.0 Documentation: Creating deployment plans for EJB applications</title>
  </head>

  <body onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tr>
        <td valing="top" align="left">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" align="left" nowrap>
          <a href="/geronimo"> Home</a> >&nbsp;<a href="documentation.html">Documentation</a>&nbsp;&gt;&nbsp;<a href="creating-deployment-plans.html">Creating deployment plans</a>&nbsp;&gt;&nbsp;<a href="creating-deployment-plans-for-applications.html">Creating deployment plans for applications</a>&nbsp;&gt;&nbsp;<a href="creating-deployment-plans-for-ejb-applications.html">Creating deployment plans for EJB applications</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
        </td>
      </tr> 
    </table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div style="margin: 0px 10px 0px 10px" class="smalltext">Apache Geronimo v3.0</div>
        <div style="margin: 0px 10px 8px 10px"  class="pagetitle">Creating deployment plans for EJB applications</div>

        <div class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
<!-- -->         
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645421">
            <img src="http://geronimo.apache.org/images/icons/notep_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Edit Page"></a>
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645421">Edit Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">
            <img src="http://geronimo.apache.org/images/icons/browse_space.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Browse Space"></a>
            <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">Browse Space</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645421">
            <img src="http://geronimo.apache.org/images/icons/add_page_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add Page"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645421">Add Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645421">
            <img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add News"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645421">Add News</a>
<!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent"><plain-text-body>{scrollbar}</plain-text-body>

<p><parameter ac:name="atlassian-macro-output-type">INLINE</parameter><rich-text-body><p>Geronimo uses OpenEJB container for providing ejb services. An EJB application requires <code>ejb-jar.xml</code> as deployment descriptor and <code>openejb-jar.xml</code> as deployment plan. </p></rich-text-body> With the advent of Java EE 5, the ejb container services such as transaction management, security, life cycle management can be declared in the ejb class itself using annotations. However, the ejb deployment descriptor can still be provided through <code>ejb-jar.xml</code> file. When both annotations and <code>ejb-jar.xml</code> file are provided, the <code>ejb-jar.xml</code> file takes precedence over the annotations. </p>

<p>The <code>openejb-jar.xml</code> file contains deployment plan for ejb modules. In the <code>openejb-jar.xml</code> file, the application deployer maps the security roles, ejb names, database resources, JMS resources, etc. declared in <code>ejb-jar.xml</code> file to corresponding entities deployed in the server. In addition to that, if there are any ejb container specific configurations to be done, the required settings are configured as well here. If the ejb module depends on any third party libraries or other services running in the server, all these third party libraries and the services are specified in the <code>openejb-jar.xml</code> file. Some ejb applications require class loading requirements different from the default class loading behavior. The <code>openejb-jar.xml</code> file allows application deployer to configure this as well. There are many more configurations that could be done through <code>openejb-jar.xml</code> file depending on the needs of the ejb application. The following sections briefly explain how <code>openejb-jar.xml</code> file can be used to configure the ejb container and ejb applications.</p>


<h1 id="CreatingdeploymentplansforEJBapplications-SampleplanforaSSBapplication">Sample plan for a SSB application</h1>
<p>For example, the below XML content is the deployment descriptor (<code>ejb-jar.xml</code>) of a stateless session bean that connects to a back end DB2 database.</p>

<parameter ac:name="borderStyle">solid</parameter><parameter ac:name="title">ejb-jar.xml</parameter><plain-text-body>
&lt;?xml version="1.0" encoding="UTF-8" ?&gt; 
&lt;ejb-jar xmlns="http://java.sun.com/xml/ns/javaee" version="3.0" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
         xsi:schemaLocation="http://java.sun.com/xml/ns/javaee 
         http://java.sun.com/xml/ns/javaee/ejb-jar_3_0.xsd"&gt;
  
    &lt;description&gt;Stateless Session Bean Example&lt;/description&gt; 
    &lt;display-name&gt;Stateless Session Bean Example&lt;/display-name&gt; 
    
    &lt;enterprise-beans&gt;
        &lt;session&gt;
            &lt;ejb-name&gt;RetrieveEmployeeInfoBean&lt;/ejb-name&gt;
            &lt;business-remote&gt;examples.session.stateless_dd.RetrieveEmployeeInfo&lt;/business-remote&gt;
            &lt;ejb-class&gt;examples.session.stateless_dd.RetrieveEmployeeInfoBean&lt;/ejb-class&gt; 
            &lt;session-type&gt;Stateless&lt;/session-type&gt; 
            &lt;transaction-type&gt;Container&lt;/transaction-type&gt; 
            
            &lt;resource-ref&gt;
                &lt;res-ref-name&gt;jdbc/DataSource&lt;/res-ref-name&gt;
                &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
                &lt;res-auth&gt;Container&lt;/res-auth&gt;
                &lt;res-sharing-scope&gt;Shareable&lt;/res-sharing-scope&gt;
            &lt;/resource-ref&gt;
        &lt;/session&gt;
    &lt;/enterprise-beans&gt;
    
    &lt;interceptors&gt;
        &lt;interceptor&gt;
            &lt;interceptor-class&gt;
                examples.session.stateless_dd.RetrieveEmployeeInfoCallbacks
            &lt;/interceptor-class&gt;

            &lt;post-construct&gt;
                &lt;lifecycle-callback-method&gt;construct&lt;/lifecycle-callback-method&gt;
            &lt;/post-construct&gt;
            
            &lt;post-activate&gt;
                &lt;lifecycle-callback-method&gt;activate&lt;/lifecycle-callback-method&gt;
            &lt;/post-activate&gt;
            
            &lt;pre-passivate&gt;
                &lt;lifecycle-callback-method&gt;passivate&lt;/lifecycle-callback-method&gt;
            &lt;/pre-passivate&gt;
        &lt;/interceptor&gt;
    &lt;/interceptors&gt;
    
    &lt;assembly-descriptor&gt;
        &lt;interceptor-binding&gt;
            &lt;ejb-name&gt;RetrieveEmployeeInfoBean&lt;/ejb-name&gt;

            &lt;interceptor-class&gt;
                examples.session.stateless_dd.RetrieveEmployeeInfoCallbacks
            &lt;/interceptor-class&gt;
        
        &lt;/interceptor-binding&gt;
    &lt;/assembly-descriptor&gt;

&lt;/ejb-jar&gt;
</plain-text-body>

<rich-text-body>
<p>The default namespace of the above XML document is <code><a shape="rect" class="external-link" href="http://java.sun.com/xml/ns/javaee" rel="nofollow">http://java.sun.com/xml/ns/javaee</a></code>. The XML elements that do not have a namespace prefix belong to the default namespace.</p>

<p>In EJB3.0, most of the deployment descriptor declarations can be done through the corresponding annotations in the bean class. However, if a deployment descriptor is supplied (<code>ejb-jar.xml</code>), the declarations in the deployment descriptor will override the annotations.</p></rich-text-body>

<p>The ejb module connects to back end datasource using its JNDI name <code>jdbc/DataSource</code> as declared in the <code>ejb-jar.xml</code>. It also declares that the ejb is a stateless session bean and provides an interceptor class for the bean. The interceptor class will have callback methods which container calls when the corresponding events occur in the bean's life cycle.</p>

<p>For the above deployment descriptor, we will have to provide a corresponding deployment plan file (<code>openejb-jar.xml</code>) that maps the declared datasource to actual datasource deployed in the server. The following is the deployment plan.</p>

<parameter ac:name="borderStyle">solid</parameter><parameter ac:name="title">openejb-jar.xml</parameter><plain-text-body>
&lt;openejb-jar xmlns="http://openejb.apache.org/xml/ns/openejb-jar-2.2" 
         xmlns:naming="http://geronimo.apache.org/xml/ns/naming-1.2" 
         xmlns:sec="http://geronimo.apache.org/xml/ns/security-2.0" 
         xmlns:sys="http://geronimo.apache.org/xml/ns/deployment-1.2"&gt;

    &lt;sys:environment&gt;
        &lt;sys:moduleId&gt;
            &lt;sys:groupId&gt;samples&lt;/sys:groupId&gt;
            &lt;sys:artifactId&gt;EmployeeDemo-ejb-dd&lt;/sys:artifactId&gt;
            &lt;sys:version&gt;3.0&lt;/sys:version&gt;
            &lt;sys:type&gt;jar&lt;/sys:type&gt;
        &lt;/sys:moduleId&gt;
        
        &lt;sys:dependencies&gt;
            &lt;sys:dependency&gt;
                &lt;sys:groupId&gt;console.dbpool&lt;/sys:groupId&gt;
                &lt;sys:artifactId&gt;jdbc/FEmployeeDatasource&lt;/sys:artifactId&gt;
                &lt;sys:version&gt;1.0&lt;/sys:version&gt;
                &lt;sys:type&gt;rar&lt;/sys:type&gt;
           &lt;/sys:dependency&gt;
        &lt;/sys:dependencies&gt;
    &lt;/sys:environment&gt;
    
    &lt;enterprise-beans&gt;
        &lt;session&gt;
            &lt;ejb-name&gt;RetrieveEmployeeInfoBean&lt;/ejb-name&gt;
            &lt;naming:resource-ref&gt;
                &lt;naming:ref-name&gt;jdbc/DataSource&lt;/naming:ref-name&gt;
                &lt;naming:resource-link&gt;jdbc/EmployeeDatasource&lt;/naming:resource-link&gt;
            &lt;/naming:resource-ref&gt;
        &lt;/session&gt;
    &lt;/enterprise-beans&gt;
&lt;/openejb-jar&gt;  
</plain-text-body>  
<rich-text-body><p>The default namespace of the above XML document is <code><a shape="rect" class="external-link" href="http://openejb.apache.org/xml/ns/openejb-jar-2.2">http://openejb.apache.org/xml/ns/openejb-jar-2.2</a></code>. The XML elements that do not have a namespace prefix belong to the default namespace.</p></rich-text-body>
<p>Observe the various XML tags and corresponding namespaces used in the deployment plan for various purposes.</p>

<p><strong><code>&lt;sys:environment&gt; .. &lt;/sys:environment&gt;</code></strong> : These elements provide the moduleId configuration and the dependencies. The moduleId elements provide the configuration name for the ejb module. So, when the ejb module is deployed, it is given the configuration name <code>samples/EmployeeDemo-ejb-dd/3.0/jar</code>. The dependencies elements provide the configurations and third party libraries on which the ejb module is dependent on. These configurations and libraries will be available to the ejb module via a classloader hierarchy. In this case, the ejb module is dependent on <code>console.dbpool/jdbc/FEmployeeDatasource/1.0/jar</code> which is the configuration of the deployed Datasource that connects to a back end DB2 database. The Datasource deploys a database connection pool (<code>javax.sql.Datasource</code>) with name <code>jdbc/EmployeeDatasource</code>.</p>

<p><strong><code>&lt;enterprise-beans&gt; .. &lt;/enterprise-beans&gt;</code></strong> : These elements help us to configure the enterprise beans. In this case, the datasource reference <code>jdbc/DataSource</code> is mapped to <code>jdbc/EmployeeDatasource</code>. </p>

<p>In the ejb bean class, the following java code is used to obtain a connection from the datasource.</p>

<parameter ac:name="borderStyle">solid</parameter><parameter ac:name="title">examples.session.stateless_dd.RetrieveEmployeeInfoBean.java</parameter><plain-text-body>
....
....
Context initContext = new InitialContext();
Context envContext  = (Context)initContext.lookup("java:comp/env");
DataSource ds = (DataSource)envContext.lookup("jdbc/DataSource");
Connection con = ds.getConnection();
....
....
</plain-text-body>

<p>The above descriptor and plan are the simple illustrations that explain how ejb modules are developed and assembled for Apache Geronimo. Similarly, many other configurations can be performed in the <code>openejb-jar.xml</code>. The schema for the plan is <a shape="rect" class="external-link" href="http://svn.apache.org/repos/asf/geronimo/site/tags/pre-confluence/docs/schemas-1.1/openejb-jar-2.1.xsd">openejb-jar-2.1.xsd </a></p>

<h1 id="CreatingdeploymentplansforEJBapplications-SampleplanforaMDBapplication">Sample plan for a MDB application</h1>
<p>Apache geronimo ships with <a shape="rect" class="external-link" href="http://activemq.apache.org">ActiveMQ</a> message broker and an inbound and outbound JMS resource adapter for the ActiveMQ broker. This sample illustrates deploying and running two MDBs that listen to a jms topic <code>TextTopic</code>. When the web client publishes a message to this topic,  the two MDBs receive the message and process it. Because the message is published to the topic, all the configured listeners, in this case the two MDBs, receive a copy of the message. In addition to that, we will also illustrate how to deploy a JMS resource adapter within the application scope. Usually, the resource adapters are deployed at the server scope and can be used by all other applications as well. In this example, a JMS resource plan is embedded in the application deployment plan <code>geronimo-application.xml</code> and deployed while deploying the application archive. </p>


<parameter ac:name="title">ejb-jar.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;?xml version="1.0" encoding="UTF-8" ?&gt; 
&lt;ejb-jar&gt;
 &lt;enterprise-beans&gt;

  &lt;message-driven&gt;
  &lt;ejb-name&gt;TextMessageBean1&lt;/ejb-name&gt;
  &lt;ejb-class&gt;
   sample.mdb.TextMessageBean1
  &lt;/ejb-class&gt; 
  &lt;messaging-type&gt;
   javax.jms.MessageListener
  &lt;/messaging-type&gt;
  &lt;transaction-type&gt;Bean&lt;/transaction-type&gt;
  &lt;message-destination-type&gt;
   javax.jms.Topic
  &lt;/message-destination-type&gt;
  
  &lt;activation-config&gt;
   &lt;activation-config-property&gt;
    &lt;activation-config-property-name&gt;
     destinationType
    &lt;/activation-config-property-name&gt;
    &lt;activation-config-property-value&gt;
     javax.jms.Topic
    &lt;/activation-config-property-value&gt;
    &lt;/activation-config-property&gt;
  &lt;/activation-config&gt;
 &lt;/message-driven&gt;
        
 &lt;message-driven&gt;
  &lt;ejb-name&gt;TextMessageBean2&lt;/ejb-name&gt;
  &lt;ejb-class&gt;
   sample.mdb.TextMessageBean2
  &lt;/ejb-class&gt; 
  &lt;messaging-type&gt;
   javax.jms.MessageListener
  &lt;/messaging-type&gt;
  &lt;transaction-type&gt;Bean&lt;/transaction-type&gt;
  &lt;message-destination-type&gt;
   javax.jms.Topic
  &lt;/message-destination-type&gt;
  
  &lt;activation-config&gt;
   &lt;activation-config-property&gt;
   &lt;activation-config-property-name&gt;
    destinationType
   &lt;/activation-config-property-name&gt;
   &lt;activation-config-property-value&gt;
    javax.jms.Topic
   &lt;/activation-config-property-value&gt;
   &lt;/activation-config-property&gt;
  &lt;/activation-config&gt;
 &lt;/message-driven&gt;

&lt;/enterprise-beans&gt;
&lt;/ejb-jar&gt;
</plain-text-body>

<p>The <code>ejb-jar.xml</code> declares the two MDBs <code>sample.mdb.TextMessageBean1</code> and <code>sample.mdb.TextMessageBean2</code> both listen to a javax.jms.Topic destination. </p>

<parameter ac:name="title">openejb-jar.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;openejb-jar xmlns="http://openejb.apache.org/xml/ns/openejb-jar-2.2" 
  xmlns:nam="http://geronimo.apache.org/xml/ns/naming-1.2" 
  xmlns:sec="http://geronimo.apache.org/xml/ns/security-2.0" 
  xmlns:sys="http://geronimo.apache.org/xml/ns/deployment-1.2"&gt;
  
  &lt;sys:environment&gt;
    &lt;sys:moduleId&gt;
      &lt;sys:groupId&gt;Sample&lt;/sys:groupId&gt;
      &lt;sys:artifactId&gt;MDB-EJB&lt;/sys:artifactId&gt;
      &lt;sys:version&gt;1.0&lt;/sys:version&gt;
      &lt;sys:type&gt;car&lt;/sys:type&gt;
    &lt;/sys:moduleId&gt;
  &lt;/sys:environment&gt;
  
  &lt;enterprise-beans&gt;

   &lt;message-driven&gt;
    &lt;ejb-name&gt;
     TextMessageBean1
    &lt;/ejb-name&gt;
    &lt;nam:resource-adapter&gt;
     &lt;nam:resource-link&gt;
      TradeJMSResources
     &lt;/nam:resource-link&gt;
    &lt;/nam:resource-adapter&gt;

    &lt;activation-config&gt;

     &lt;activation-config-property&gt;
      &lt;activation-config-property-name&gt;
       destination
      &lt;/activation-config-property-name&gt;
      &lt;activation-config-property-value&gt;
       TextMessageTopic
      &lt;/activation-config-property-value&gt;
     &lt;/activation-config-property&gt;
      &lt;activation-config-property&gt;
       &lt;activation-config-property-name&gt;
        destinationType
       &lt;/activation-config-property-name&gt;
       &lt;activation-config-property-value&gt;
        javax.jms.Topic&lt;/activation-config-property-value&gt;
       &lt;/activation-config-property&gt;

      &lt;/activation-config&gt;
     &lt;/message-driven&gt;    
    
    &lt;message-driven&gt;
     &lt;ejb-name&gt;TextMessageBean2&lt;/ejb-name&gt;
      &lt;nam:resource-adapter&gt;
       &lt;nam:resource-link&gt;
        TradeJMSResources
       &lt;/nam:resource-link&gt;
       &lt;/nam:resource-adapter&gt;

       &lt;activation-config&gt;

        &lt;activation-config-property&gt;
         &lt;activation-config-property-name&gt;
          destination
         &lt;/activation-config-property-name&gt;
          &lt;activation-config-property-value&gt;
           TextMessageTopic
          &lt;/activation-config-property-value&gt;
        &lt;/activation-config-property&gt;

        &lt;activation-config-property&gt;
          &lt;activation-config-property-name&gt;
           destinationType
         &lt;/activation-config-property-name&gt;
          &lt;activation-config-property-value&gt;
           javax.jms.Topic
          &lt;/activation-config-property-value&gt;
        &lt;/activation-config-property&gt;

      &lt;/activation-config&gt;
    &lt;/message-driven&gt; 
 
  &lt;/enterprise-beans&gt;
&lt;/openejb-jar&gt;
</plain-text-body>

<p>In the deployment plan <code>openejb-jar.xml</code>, the two MDBs are configured as end point listeners for the jms topic <code>TextMessageTopic</code>. </p>

<p>The code for the two MDBs are as follows.</p>

<parameter ac:name="">JAVA</parameter><parameter ac:name="title">TextMessageBean1.java</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
package sample.mdb;
import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.TextMessage;

public class TextMessageBean1 {
 
 public TextMessageBean1() {
 }
 
 public void onMessage(Message msg) {
  if (msg instanceof TextMessage) {
   TextMessage tm = (TextMessage) msg;
   try {
    String text = tm.getText();
    System.out.println("Received new message 
                        in TextMessageBean1 : " 
                        + text);
    System.out.println("CustomerId : " + 
                   tm.getIntProperty("CustomerId"));
    System.out.println("CustomerName : " +
                   tm.getStringProperty("CustomerName"));
   } catch (JMSException e) {
      e.printStackTrace();
   }
  }
 }
}
</plain-text-body>
<parameter ac:name="">JAVA</parameter><parameter ac:name="title">TextMessageBean2.java</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
package sample.mdb;
import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.TextMessage;

public class TextMessageBean2 {
 
 public TextMessageBean2() {
 }
 
 public void onMessage(Message msg) {
  if (msg instanceof TextMessage) {
   TextMessage tm = (TextMessage) msg;
   try {
    String text = tm.getText();
    System.out.println("Received new message 
                        in TextMessageBean2 : " 
                        + text);
    System.out.println("CustomerId : " + 
                   tm.getIntProperty("CustomerId"));
    System.out.println("CustomerName : " +
                   tm.getStringProperty("CustomerName"));
   } catch (JMSException e) {
      e.printStackTrace();
   }
  }
 }
}
</plain-text-body>

<p>After receiving the message, the MDBs just print the contents of the message.</p>

<p>The web client for the application is as follows.</p>
<parameter ac:name="title">web.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app 
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
 xmlns="http://java.sun.com/xml/ns/javaee" 
 xmlns:web="http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
 xsi:schemaLocation="http://java.sun.com/xml/ns/javaee 
 http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd" 
 id="WebApp_ID" version="2.5"&gt;

 &lt;display-name&gt;MDBSampleWEB&lt;/display-name&gt;
  &lt;welcome-file-list&gt;
    &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;
    &lt;welcome-file&gt;index.htm&lt;/welcome-file&gt;
    &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;
  &lt;/welcome-file-list&gt;
  &lt;servlet&gt;
    &lt;description&gt;&lt;/description&gt;
    &lt;display-name&gt;Test&lt;/display-name&gt;
    &lt;servlet-name&gt;Test&lt;/servlet-name&gt;
    &lt;servlet-class&gt;sample.mdb.Test&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  
  &lt;resource-ref&gt;
   &lt;description&gt;jms broker&lt;/description&gt;
   &lt;res-ref-name&gt;jms/broker&lt;/res-ref-name&gt;
   &lt;res-type&gt;
     javax.jms.TopicConnectionFactory
    &lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
   &lt;/resource-ref&gt;
   
   &lt;resource-env-ref&gt;
    &lt;description&gt;Predefined Topic&lt;/description&gt;
    &lt;resource-env-ref-name&gt;
     jms/Topic/TextTopic
    &lt;/resource-env-ref-name&gt;
    &lt;resource-env-ref-type&gt;
     javax.jms.Topic&lt;/resource-env-ref-type&gt;
    &lt;/resource-env-ref&gt;
   
    &lt;servlet-mapping&gt;
     &lt;servlet-name&gt;Test&lt;/servlet-name&gt;
     &lt;url-pattern&gt;/Test&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
  &lt;/web-app&gt;
</plain-text-body>

<p>The web client declares the <code>javax.jms.TopicConnectionFactory</code> and the topic to which the servlet has to publish the message. The names declared here are mapped to actual resources in the <code>geronimo-web.xml</code> as follows.</p>

<parameter ac:name="title">geronimo-web.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app 
  xmlns="http://geronimo.apache.org/xml/ns/j2ee/web-2.0.1" 
  xmlns:nam="http://geronimo.apache.org/xml/ns/naming-1.2" 
  xmlns:sec="http://geronimo.apache.org/xml/ns/security-2.0" 
  xmlns:sys="http://geronimo.apache.org/xml/ns/deployment-1.2"&gt;
  
 &lt;sys:environment&gt;
  &lt;sys:moduleId&gt;
   &lt;sys:groupId&gt;sample&lt;/sys:groupId&gt;
   &lt;sys:artifactId&gt;MDB-Web&lt;/sys:artifactId&gt;
   &lt;sys:version&gt;1.0&lt;/sys:version&gt;
   &lt;sys:type&gt;car&lt;/sys:type&gt;
  &lt;/sys:moduleId&gt;
 &lt;/sys:environment&gt;

 &lt;context-root&gt;/MDBSampleWEB&lt;/context-root&gt;

 &lt;nam:resource-ref&gt;
  &lt;nam:ref-name&gt;
   jms/broker&lt;/nam:ref-name&gt;
  &lt;nam:resource-link&gt;
   jms/TopicConnectionFactory
  &lt;/nam:resource-link&gt;
  &lt;/nam:resource-ref&gt;
  &lt;nam:resource-env-ref&gt;
   &lt;nam:ref-name&gt;
    jms/Topic/TextTopic
   &lt;/nam:ref-name&gt;
  &lt;nam:message-destination-link&gt;
   TextMessageTopic
  &lt;/nam:message-destination-link&gt;
  &lt;/nam:resource-env-ref&gt;
&lt;/web-app&gt;
</plain-text-body>



<p>Please note that the <code>jms/TopicConnectionFactory</code> and <code>jms/Topic/TextTopic</code> are the names of the actual connection factory and jms topic. These are deployed by a jms resource plan embedded in the EAR's deployment plan as follows.</p>

<parameter ac:name="title">application.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>

&lt;?xml version="1.0" encoding="ASCII"?&gt;
&lt;application 
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
 xmlns=http://java.sun.com/xml/ns/javaee
 xmlns:app="http://java.sun.com/xml/ns/javaee/application_5.xsd" 
 xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
  http://java.sun.com/xml/ns/javaee/application_5.xsd" 
 version="5"&gt;
 
 &lt;display-name&gt;MDBSampleEAR&lt;/display-name&gt;
  &lt;module&gt;
    &lt;ejb&gt;MDBSampleEJB.jar&lt;/ejb&gt;
  &lt;/module&gt;
  &lt;module&gt;
    &lt;web&gt;
      &lt;web-uri&gt;MDBSampleWEB.war&lt;/web-uri&gt;
      &lt;context-root&gt;MDBSampleWEB&lt;/context-root&gt;
    &lt;/web&gt;
  &lt;/module&gt;
&lt;/application&gt;
</plain-text-body>
<parameter ac:name="">XML</parameter><parameter ac:name="title">geronimo-application.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;application 
  xmlns="http://geronimo.apache.org/xml/ns/j2ee/application-2.0" 
  xmlns:sys="http://geronimo.apache.org/xml/ns/deployment-1.2" 
  application-name="MDBSampleEAR"&gt;

  &lt;sys:environment&gt;
    &lt;sys:moduleId&gt;
      &lt;sys:groupId&gt;default&lt;/sys:groupId&gt;
      &lt;sys:artifactId&gt;MDBSampleEAR&lt;/sys:artifactId&gt;
      &lt;sys:version&gt;1.0&lt;/sys:version&gt;
      &lt;sys:type&gt;car&lt;/sys:type&gt;
    &lt;/sys:moduleId&gt;
  &lt;/sys:environment&gt;
  
  &lt;ext-module&gt;
    &lt;connector&gt;TopicJMSSample&lt;/connector&gt;
    &lt;external-path&gt;
     &lt;sys:groupId&gt;
      org.apache.geronimo.modules
     &lt;/sys:groupId&gt;
       &lt;sys:artifactId&gt;
        geronimo-activemq-ra
       &lt;/sys:artifactId&gt;
       &lt;sys:version&gt;2.1&lt;/sys:version&gt;
    &lt;/external-path&gt;
    &lt;connector 
     xmlns="http://geronimo.apache.org/xml/ns/j2ee/connector-1.2"&gt;
     &lt;resourceadapter&gt;
      &lt;!--how to connect to the JMS Server--&gt;
      &lt;resourceadapter-instance&gt;
       &lt;resourceadapter-name&gt;
         TradeJMSResources
       &lt;/resourceadapter-name&gt;
       &lt;config-property-setting name="ServerUrl"&gt;
         tcp://localhost:61616
       &lt;/config-property-setting&gt;
       &lt;config-property-setting name="UserName"&gt;
        not needed
       &lt;/config-property-setting&gt;
       &lt;config-property-setting name="Password"&gt;
        not needed
       &lt;/config-property-setting&gt;
       &lt;workmanager&gt;
        &lt;gbean-link&gt;DefaultWorkManager&lt;/gbean-link&gt;
        &lt;/workmanager&gt;
      &lt;/resourceadapter-instance&gt;
        
      &lt;!--defines a ConnectionFactory--&gt;
      &lt;outbound-resourceadapter&gt;
       &lt;connection-definition&gt;
        &lt;connectionfactory-interface&gt;
         javax.jms.ConnectionFactory
        &lt;/connectionfactory-interface&gt;
        &lt;connectiondefinition-instance&gt;
         &lt;name&gt;jms/TopicConnectionFactory&lt;/name&gt;
         &lt;implemented-interface&gt;
          javax.jms.TopicConnectionFactory
         &lt;/implemented-interface&gt;
         &lt;connectionmanager&gt;
          &lt;xa-transaction&gt;
           &lt;transaction-caching/&gt;
          &lt;/xa-transaction&gt;
          &lt;single-pool&gt;
           &lt;max-size&gt;10&lt;/max-size&gt;
           &lt;min-size&gt;0&lt;/min-size&gt;
           &lt;blocking-timeout-milliseconds&gt;
            5000
           &lt;/blocking-timeout-milliseconds&gt;
           &lt;idle-timeout-minutes&gt;0&lt;/idle-timeout-minutes&gt;
           &lt;match-one/&gt;
          &lt;/single-pool&gt;
         &lt;/connectionmanager&gt;
        &lt;/connectiondefinition-instance&gt;
       &lt;/connection-definition&gt;
      &lt;/outbound-resourceadapter&gt;
        
      
     &lt;/resourceadapter&gt;
      &lt;adminobject&gt;
       &lt;adminobject-interface&gt;
         javax.jms.Topic&lt;/adminobject-interface&gt;
       &lt;adminobject-class&gt;
         org.activemq.message.ActiveMQTopic
       &lt;/adminobject-class&gt;
       &lt;adminobject-instance&gt;
        &lt;message-destination-name&gt;
         TextMessageTopic
        &lt;/message-destination-name&gt;
        &lt;config-property-setting name="PhysicalName"&gt;
         TextMessageTopic
        &lt;/config-property-setting&gt;
       &lt;/adminobject-instance&gt;
      &lt;/adminobject&gt;
     &lt;/connector&gt;
    &lt;/ext-module&gt;
&lt;/application&gt;
</plain-text-body>

<p>The plan for resource adapter is provided under <code>&lt;ext-module&gt;</code> xml elements. Also, the resource adapter archive <code>(rar)</code> file to be used to deploy the plan is mentioned using <code>external-path</code> xml element; the resource adapter plan follows these elements. The plan deploys{{ jms/TopicConnectionFactory}} and <code>TextTopic</code>.</p>

<rich-text-body>
<p>The reference to resource archive file is provided using the following xml elements in the above plan.</p>
<parameter ac:name="">JAVA</parameter><parameter ac:name="title">Referencing Libraries</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
   &lt;external-path&gt;
     &lt;sys:groupId&gt;
      org.apache.geronimo.modules
     &lt;/sys:groupId&gt;
       &lt;sys:artifactId&gt;
        geronimo-activemq-ra
       &lt;/sys:artifactId&gt;
       &lt;sys:version&gt;2.1&lt;/sys:version&gt;
    &lt;/external-path&gt;
</plain-text-body>
<p>The above pattern is the way how geronimo references various libraries available in the server repository. Any external libraries can also be uploaded to server repository using admin console portlet. After starting the server, click on <code>Console Navigation =&gt; Services =&gt; Repository</code> to display <code>Repository Viewer</code> portlet. In this portlet, users can upload required third party libraries by providing proper <code>groupId, artifactId and version</code> values for the libraries being uploaded. The activeMQ rar file is also available in the repository as <code>org.apache.geronimo.modules/geronimo-activemq-ra/2.1/rar</code>. Click on this link to get the usage instructions on how to reference this library in other modules.</p></rich-text-body>

<p>The web client that look up the connection factory and topic and sends messages is as follows.</p>
<parameter ac:name="">JAVA</parameter><parameter ac:name="title">Test.java</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
package sample.mdb;

import java.io.IOException;
import java.io.PrintWriter;

import javax.jms.DeliveryMode;
import javax.jms.Session;
import javax.jms.TextMessage;
import javax.jms.Topic;
import javax.jms.TopicConnection;
import javax.jms.TopicConnectionFactory;
import javax.jms.TopicPublisher;
import javax.jms.TopicSession;
import javax.naming.InitialContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.jms.Connection;

public class Test extends 
 javax.servlet.http.HttpServlet 
  implements javax.servlet.Servlet {
   
 static final long serialVersionUID = 1L;
 private TopicConnection connection;
 private Topic topic;
 
 public Test() {
  super();
 }   	
	
 public void init() 
     throws ServletException {
  String connectionFactoryName = "java:comp/env/jms/broker";
  String topicName = "java:comp/env/jms/Topic/TextTopic";
  try {
   InitialContext naming = new InitialContext();
   TopicConnectionFactory connectionFactory =
	         (TopicConnectionFactory)
               naming.lookup(connectionFactoryName);

   connection = 
     connectionFactory.createTopicConnection();
   topic = (Topic) naming.lookup(topicName);
  }catch(Exception e) {
   e.printStackTrace();
   throw new ServletException(e);
  }
}
	   
public void doGet(HttpServletRequest request, 
                  HttpServletResponse response)
         throws ServletException, IOException {

 TopicSession publishSession = null;
 PrintWriter out = response.getWriter();
 try {
  boolean transacted = false;
  publishSession = 
    connection.createTopicSession(transacted,
     Session.AUTO_ACKNOWLEDGE);

  TopicPublisher sender = 
    publishSession.createPublisher(topic);
  sender.setDeliveryMode(DeliveryMode.PERSISTENT);

  TextMessage message = 
   publishSession.createTextMessage("Customer Info");
  message.setIntProperty("CustomerId",
   Integer.parseInt(request.getParameter("CustomerId")));
  message.setStringProperty("CustomerName",
   request.getParameter("CustomerName"));

  sender.send(message);
  out.println("Message is successfully sent...!!");
  
 }
 catch(Exception e) {
  throw new ServletException(e);
 }
   finally {
    try {
     if (publishSession != null) {
       publishSession.close();
     }
    }
    catch (Exception e) {}
   }
}

protected void doPost(HttpServletRequest request,
                      HttpServletResponse response) 
              throws ServletException, IOException {
}   	
	
public void destroy() {
 if (connection != null) {
  try {
   if (connection != null) {
       connection.close();
   }
 }
 catch (Exception e) {          }
 }
 }

}
</plain-text-body>

<p>When the above servlet is accessed on a browser window as <code><a shape="rect" class="external-link" href="http://localhost:8080/MDBSampleWEB/Test?CustomerId=10&amp;CustomerName=Phani" rel="nofollow">http://localhost:8080/MDBSampleWEB/Test?CustomerId=10&amp;CustomerName=Phani</a></code>, the following output is displayed in the server console.<br clear="none">
<span style="color: white;">
<parameter ac:name="borderStyle">solid</parameter><plain-text-body>
-------------------------------------------
Received new message in TextMessageBean1 : Customer Info
CustomerId : 10
CustomerName : Phani
-------------------------------------------
-------------------------------------------
Received new message in TextMessageBean2 : Customer Info
CustomerId : 10
CustomerName : Phani
-------------------------------------------
</plain-text-body></span></p></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="middle" class="footer">
            &nbsp;&nbsp;
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Delicious" />
            <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">Bookmark this on Delicious</a>
            &nbsp;&nbsp;
            <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="Digg!" />
            <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title)+'&amp;topic=programming');">Digg this</a>
            <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : Creating deployment plans for EJB applications';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
            &nbsp;&nbsp;
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">Privacy Policy</a>&nbsp;&nbsp;-&nbsp;&nbsp;
            Copyright &#169; 2003-2013, The Apache Software Foundation, Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0.</a>&nbsp;&nbsp;
          </td>
        </tr>
    </table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  </body>
</html>
