<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="http://geronimo.apache.org/style/default.css">
    <LINK rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <LINK rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <META name="Description" content="dbtester - DB Pool Testing sample application" />
    <META name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi dbtester - DB Pool Testing sample application" />
    <META name="Owner" content="dev@geronimo.apache.org" />
    <META name="Robots" content="index, follow" />
    <META name="Security" content="Public" />
    <META name="Source" content="wiki template" />
    <META name="DC.Date" scheme="iso8601" content="2010-05-11" />
    <META name="DC.Language" scheme="rfc1766" content="en" />
    <META name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation" />
    <META http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html" l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html" l gen true r (n 0 s 0 v 0 l 0) "http://www.classify.org/safesurf/" l gen true r (SS~~000 1))'/>

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>


    <title>Apache Geronimo v3.0 Documentation: dbtester - DB Pool Testing sample application</title>
  </head>

  <body onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tr>
        <td valing="top" align="left">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" align="left" nowrap>
          <a href="/geronimo"> Home</a> >&nbsp;<a href="documentation.html">Documentation</a>&nbsp;&gt;&nbsp;<a href="reference.html">Reference</a>&nbsp;&gt;&nbsp;<a href="samples.html">Samples</a>&nbsp;&gt;&nbsp;<a href="java-ee-sample-applications.html">Java EE sample applications</a>&nbsp;&gt;&nbsp;<a href="dbtester-db-pool-testing-sample-application.html">dbtester - DB Pool Testing sample application</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
        </td>
      </tr> 
    </table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div style="margin: 0px 10px 0px 10px" class="smalltext">Apache Geronimo v3.0</div>
        <div style="margin: 0px 10px 8px 10px"  class="pagetitle">dbtester - DB Pool Testing sample application</div>

        <div class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
<!-- -->         
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645371">
            <img src="http://geronimo.apache.org/images/icons/notep_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Edit Page"></a>
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645371">Edit Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">
            <img src="http://geronimo.apache.org/images/icons/browse_space.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Browse Space"></a>
            <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">Browse Space</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645371">
            <img src="http://geronimo.apache.org/images/icons/add_page_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add Page"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645371">Add Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645371">
            <img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add News"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645371">Add News</a>
<!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent"><plain-text-body>{scrollbar}</plain-text-body>

<p>Accessing application server specific features and using them in your J2EE application would make it more powerful than accessing only the J2EE features from them. It gives you the ability to write extensions to your application server. </p>

<p>This sample application lists all the database connection pools defined in Geronimo. You can select any of these connection pools and test the connectivity against the database as well as listing existing schemas and tables. In addition, the user can view the records of the each of the listed tables. </p>

<p>After reading this article you should be able to access Geronimo specific resources from your applications and use them in an effective manner.</p>

<p>This article is organized into the following sections :</p>


<h1 id="dbtester-DBPoolTestingsampleapplication-Applicationoverview">Application overview</h1>
<p>The sample application covered in this article will help you to test the Database connection pools deployed in your Geronimo server. One can consider this as an extension to the Geronimo console because the current version does not contain the ability to test connections to database pools after they have been deployed.</p>

<p>The following figure illustrates the application flow.<br clear="none">
<span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" src="dbtester-db-pool-testing-sample-application.data/dbtester_flow.gif"></span></p>

<p>Welcome page of the application acts as a notice board which displays list of Database connection pools deployed in the Geronimo application server. Users can directly test those connection pools from the first page. If that particular connection pool requires a username and a password to get a connection, enter those details in the pop up window that appears. The list of database schemas and the tables associated with the connection pool will be displayed in the Schemas and Tables page. The contents of each table can be accessed from there on.  </p>

<h2 id="dbtester-DBPoolTestingsampleapplication-Applicationcontents">Application contents</h2>
<p>The Inventory application consists of following list of packages.</p>
<ul><li>org.apache.geronimo.samples.dbtester.beans
	<ul><li>DBManagerBean - Heart of the application which handles most of the application logic (including access of Geronimo Kernel).</li></ul>
	</li><li>org.apache.geronimo.samples.dbtester.web
	<ul><li>ContentTableServlet - Gets the content of a Database table and passes them to the presentation<br clear="none">
   layer.</li><li>ListTablesServlet - Gets the list of schemas and tables associated with a database pool.</li></ul>
	</li></ul>


<p>The list of web application files in the application is depicted by the following diagram.</p>

<parameter ac:name="borderColor">#FFFFFF</parameter><parameter ac:name="bgColor">#FFFFFF</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
|- jsp
    +- common_error.jsp
    +- popup.jsp
    +- table_content.jsp
    +- table_list.jsp
|- WEB-INF
    +- geronimo-web.xml
    +- web.xml
|- index.jsp
</plain-text-body>

<p><strong>geronimo-web.xml</strong> defines the list of dependencies that have to be loaded into the web application class loader. In this case, there are no dependencies. Information about the project (e.g. module's unique identification, any dependencies) is described inside the &lt;environment&gt; tag. It is a good idea to give this module some sort of unique identification, so that it can later be referenced by some other deployable application. This module is in the group org.apache.geronimo.samples.dbtester. The path specified in the &lt;context-root&gt; tag will be the first segment of the URL used to access this web application. So to access this web application the url will be http://&lt;hostname&gt;:&lt;port&gt;/dbtester.</p>

<parameter ac:name="">xml</parameter><parameter ac:name="title">geronimo-web.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns="http://geronimo.apache.org/xml/ns/j2ee/web-2.0.1"&gt;
        
    &lt;environment&gt;
        &lt;moduleId&gt;
            &lt;groupId&gt;org.apache.geronimo.samples&lt;/groupId&gt;
            &lt;artifactId&gt;dbtester-war&lt;/artifactId&gt;
            &lt;version&gt;2.1&lt;/version&gt;
            &lt;type&gt;war&lt;/type&gt;
        &lt;/moduleId&gt;
    &lt;/environment&gt;
                
    &lt;context-root&gt;/dbtester&lt;/context-root&gt;

&lt;/web-app&gt;
</plain-text-body>

<p>The structure of the final WAR should look like the following:</p>
<parameter ac:name="borderColor">#FFFFFF</parameter><parameter ac:name="bgColor">#FFFFFF</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
|- WEB-INF
  +- classes
    +- org
      +- apache
        +- geronimo
          +- samples
            +- dbtester
  |- web.xml
  |- geronimo-web.xml
</plain-text-body>

<p><strong>web.xml</strong> defines two servlets that will act as the control layer between presentation and service layers.</p>

<parameter ac:name="">xml</parameter><parameter ac:name="title">web.xml</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app version="2.5" xmlns="http://java.sun.com/xml/ns/javaee" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt;

    &lt;description&gt;dbtester Servlet Sample&lt;/description&gt;
    &lt;servlet&gt;
        &lt;display-name&gt;ContentTableServlet&lt;/display-name&gt;
        &lt;servlet-name&gt;ContentTableServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.apache.geronimo.samples.dbtester.web.ContentTableServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet&gt;
        &lt;display-name&gt;ListTablesServlet&lt;/display-name&gt;
        &lt;servlet-name&gt;ListTablesServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.apache.geronimo.samples.dbtester.web.ListTablesServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ContentTableServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/listContent&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ListTablesServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/listTables&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;welcome-file-list&gt;
        &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;
    &lt;/welcome-file-list&gt;

&lt;/web-app&gt;
</plain-text-body>

<p>The most important part of this application is how to access Geronimo kernel and retrieve the list of database pools deployed there. This task is handled by the DBManagerBean class. </p>

<parameter ac:name="">java</parameter><parameter ac:name="title">Excerpt from DBManagerBean.java</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
    public DBManagerBean() {
        Kernel kernel = KernelRegistry.getSingleKernel();
        Set&lt;AbstractName&gt; cfList = kernel.listGBeans(new AbstractNameQuery(ResourceSource.class.getName()));

        for (AbstractName name : cfList) {

            try {
                Object rs = kernel.invoke(name, "$getResource", new Object[]{}, new String[]{});

                if (rs instanceof DataSource) {
                    DataSource ds = (DataSource) rs;
                    poolMap.put(name.getArtifact().getArtifactId(), ds);
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
</plain-text-body>

<p>To retrieve the list of schemas and their tables, the application uses database metadata provided in a JDBC driver. ResultSet meta data has been used to get record related data and to display database contents. The following code snippet depicts how the application retrieves the schemas and their tables in a DataSource.</p>

<parameter ac:name="">java</parameter><parameter ac:name="title">Excerpt from DBManagerBean.java</parameter><parameter ac:name="borderStyle">solid</parameter><plain-text-body>
    public Map getTableList(String poolName) throws SQLException {

        Map&lt;String, List&lt;String&gt;&gt; tableMap = new HashMap&lt;String, List&lt;String&gt;&gt;();

        if (poolMap.containsKey(poolName)) {
            DataSource ds = poolMap.get(poolName);
            Connection con = null;
            try {

                con = ds.getConnection();

                DatabaseMetaData metaData = con.getMetaData();
                String[] tableTypes = {"TABLE"};
                ResultSet rs = metaData.getTables(null, null, null, tableTypes);

                while (rs.next()) {
                    String schemaName = rs.getString("TABLE_SCHEM");
                    String tableName = rs.getString("TABLE_NAME");
                    List&lt;String&gt; tableList;

                    if (tableMap.containsKey(schemaName)) {
                        tableList = tableMap.get(schemaName);
                        tableList.add(tableName);
                    } else {
                        tableList = new ArrayList&lt;String&gt;();
                        tableList.add(tableName);
                    }
                    tableMap.put(schemaName, tableList);
                }
            } finally {
                if (con != null) {
                    try {
                        con.close();
                    } catch (SQLException e) {
                        e.printStackTrace();
                    }
                }
            }
        }

        return tableMap;
    }
</plain-text-body>

<h1 id="dbtester-DBPoolTestingsampleapplication-Usage">Usage</h1>

<p>The app is available at <a shape="rect" class="external-link" href="http://localhost:8080/dbtester" rel="nofollow">http://localhost:8080/dbtester</a>.  Note that the sample servers you get if you run maven with -Pit will not show any data since they dont include any database pools.  A more realistic view comes from installing the plugin or app on a full geronimo server.</p>

<h1 id="dbtester-DBPoolTestingsampleapplication-Summary">Summary</h1>

<p>This article has shown you how to access Geronimo related features from a J2EE application. You followed step-by-step instructions to build, deploy and test a sample application to elaborate these features. This sample application can be used as tester for database connection pools deployed in Geronimo.</p></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="middle" class="footer">
            &nbsp;&nbsp;
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Delicious" />
            <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">Bookmark this on Delicious</a>
            &nbsp;&nbsp;
            <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="Digg!" />
            <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title)+'&amp;topic=programming');">Digg this</a>
            <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : dbtester - DB Pool Testing sample application';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
            &nbsp;&nbsp;
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">Privacy Policy</a>&nbsp;&nbsp;-&nbsp;&nbsp;
            Copyright &#169; 2003-2013, The Apache Software Foundation, Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0.</a>&nbsp;&nbsp;
          </td>
        </tr>
    </table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  </body>
</html>
