<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="http://geronimo.apache.org/style/default.css">
    <LINK rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <LINK rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <META name="Description" content="Developing container managed persistence with JPA" />
    <META name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi Developing container managed persistence with JPA" />
    <META name="Owner" content="dev@geronimo.apache.org" />
    <META name="Robots" content="index, follow" />
    <META name="Security" content="Public" />
    <META name="Source" content="wiki template" />
    <META name="DC.Date" scheme="iso8601" content="2010-05-11" />
    <META name="DC.Language" scheme="rfc1766" content="en" />
    <META name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation" />
    <META http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html" l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html" l gen true r (n 0 s 0 v 0 l 0) "http://www.classify.org/safesurf/" l gen true r (SS~~000 1))'/>

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>

  <link href='http://geronimo.apache.org/resources/highlighter/styles/shCoreGeronimo.css' rel='stylesheet' type='text/css' />
  <link href='http://geronimo.apache.org/resources/highlighter/styles/shThemeGeronimo.css' rel='stylesheet' type='text/css' />
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shCore.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushJava.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushXml.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushPlain.js' type='text/javascript'></script>
  <script src='http://geronimo.apache.org/resources/highlighter/scripts/shBrushBash.js' type='text/javascript'></script>
  
  <script type="text/javascript">
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all();
  </script>

    <title>Apache Geronimo v3.0 Documentation: Developing container managed persistence with JPA</title>
  </head>

  <body onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tr>
        <td valing="top" align="left">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" align="left" nowrap>
          <a href="/geronimo"> Home</a> >&nbsp;<a href="documentation.html">Documentation</a>&nbsp;&gt;&nbsp;<a href="developing.html">Developing</a>&nbsp;&gt;&nbsp;<a href="tutorials.html">Tutorials</a>&nbsp;&gt;&nbsp;<a href="developing-jpa-applications.html">Developing JPA applications</a>&nbsp;&gt;&nbsp;<a href="developing-container-managed-persistence-with-jpa.html">Developing container managed persistence with JPA</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
        </td>
      </tr> 
    </table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div style="margin: 0px 10px 0px 10px" class="smalltext">Apache Geronimo v3.0</div>
        <div style="margin: 0px 10px 8px 10px"  class="pagetitle">Developing container managed persistence with JPA</div>

        <div class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
<!-- -->         
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645262">
            <img src="http://geronimo.apache.org/images/icons/notep_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Edit Page"></a>
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645262">Edit Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">
            <img src="http://geronimo.apache.org/images/icons/browse_space.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Browse Space"></a>
            <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">Browse Space</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645262">
            <img src="http://geronimo.apache.org/images/icons/add_page_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add Page"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645262">Add Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645262">
            <img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add News"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645262">Add News</a>
<!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent">
<p>The Java Persistence API is a new programming model under EJB3.0 specification (JSR220) for the management of persistence and object/relational mapping with Java EE and Java SE. With JPA, developers can easily develop java applications that perform operations on relational database management systems using java objects and mapping. In that way, java applications developed using JPA are not only portable across different platforms, but also applications can be easily developed using simple yet powerful programming model provided by JPA. This greatly improves application maintainability against ever changing database world. JPA insulates applications from all the complexity and non-portable boilerplate code involved in database connectivity and operations.</p>

<p>Apache geronimo uses <a shape="rect" class="external-link" href="http://openjpa.apache.org/">OpenJPA</a> for providing Java Persistence API to Java EE applications deployed in the server. Even though JPA is a part of EJB3.0 spec, it is independent of it. Hence, JPA can be used in JavaSE, web and ejb applications in the same uniform way. </p>

<p>Below tutorial illustrates the use of container managed entity manager object. When @PersistenceContext annotation is used, container injects <code>EntityManager</code> object to the reference. The persistence context of the entity manager is propagated along with any transaction that is currently active. If the transaction spans across components, all the entity manager object references that point to same persistence unit will have the same persistence context through out the transaction. Thus, any changes made to the entities through any entity manager reference, are seen through other entity manager references. The persistence scope of the container managed entity manager is <code>Transaction</code> by default. The <code>transaction-type</code> is always <code>JTA</code>. That is,  entity manager object is always registered with the transaction which is active when entity manager is invoked. In summary, the life cycle of the entity manager and the associated persistence context is managed automatically by the container. </p>

<p>The tutorial creates an enterprise application that has an ejb module and a web module. The ejb module uses <code>Account</code> entity with <code>AccountNumber</code> as primary key along with <code>OwnerName</code> and <code>Balance</code> attributes to create accounts in the <code>AccountDB</code> database. The <code>AccountDB</code> is created in the embedded derby database. The <code>AccountBean</code> in the ejb module has the methods to create the Account entities, deposit amount into an account, withdraw amount from an account and retrieve the available balance in a account. The wed module has a servlet that retrieves source account number, destination account number and the amount from user, and performs transfer of the amount from source account to destination account. </p>

<p>The web module uses container injected <code>EntityManager</code> object to check whether the source account has enough available balance to perform the transfer. If yes, it invokes ejb to withdraw the amount from the source account and deposits the same amount in the destination account. Finally, the servlet uses the injected <code>EntityManager</code> object to print the balances in the source and destination accounts. All the above mentioned operations are performed within a JTA transaction. So, persistence context of the entity manager is propagated across web and ejb modules. Hence, any changes made to the entities in ejb module are seen in the web modules when the available balance values are printed.</p>

<p>In order to develop, deploy and run the application, the following environment is required.</p>

<ul><li>Sun JDK 5.0+ (J2SE 1.5)</li><li>Eclipse 3.3.1.1 (Eclipse Classic package of Europa distribution), which is platform specific</li><li>Web Tools Platform (WTP) 2.0.1</li><li>Data Tools Platform (DTP) 1.5.1</li><li>Eclipse Modeling Framework (EMF) 2.3.1</li><li>Graphical Editing Framework (GEF) 3.3.1</li></ul>


<p>The tutorial is divided into the following sections.</p>
<style type="text/css">/*<![CDATA[*/
div.rbtoc1572612938584 {padding: 0px;}
div.rbtoc1572612938584 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1572612938584 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class="toc-macro rbtoc1572612938584">
<ul class="toc-indentation"><li><a shape="rect" href="#DevelopingcontainermanagedpersistencewithJPA-SettingtheEclipseenvironment">Setting the Eclipse environment</a></li><li><a shape="rect" href="#DevelopingcontainermanagedpersistencewithJPA-Creatingejbapplicationwithentities">Creating ejb application with entities</a></li><li><a shape="rect" href="#DevelopingcontainermanagedpersistencewithJPA-Creatingwebapplication">Creating web application</a></li><li><a shape="rect" href="#DevelopingcontainermanagedpersistencewithJPA-SettingupthedatabasetablesandtheDatasource">Setting up the database tables and the Datasource</a></li><li><a shape="rect" href="#DevelopingcontainermanagedpersistencewithJPA-Deployingthe(ear)application">Deploying the (ear) application</a></li></ul>
</div>

<p>The entire application can be downloaded from this <a shape="rect" href="developing-container-managed-persistence-with-jpa.data/ContainerManagedJPA-EAR.ear?version=1&amp;modificationDate=1213308862000&amp;api=v2" data-linked-resource-id="20873760" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="ContainerManagedJPA-EAR.ear" data-nice-type="Java Archive" data-linked-resource-content-type="application/octet-stream" data-linked-resource-container-id="20645262" data-linked-resource-container-version="47">link</a>.</p>

<h2 id="DevelopingcontainermanagedpersistencewithJPA-SettingtheEclipseenvironment">Setting the Eclipse environment</h2>

<p>1. Download Apache Geronimo2.1 and install it on the server. Look into the geronimo documentation for   <br clear="none">
   instructions.</p>

<p>2. Install the eclipse IDE and download geronimo eclipse plugin and install it on top of eclipse. Look into the<br clear="none">
   geronimo eclipse plugin documentation for instructions.</p>

<p>3. Create a runtime environment for Apache Geronimo2.1 in the eclipse. Look into the geronimo eclipse plugin <br clear="none">
   documentation for instructions to install a runtime for Apache Geronimo2.1.</p>

<h2 id="DevelopingcontainermanagedpersistencewithJPA-Creatingejbapplicationwithentities">Creating ejb application with entities</h2>

<p>1. Open the eclipse tool and change the perspective to <em>Java EE</em> by clicking on <br clear="none">
   <em>Windows =&gt; Open Perspective =&gt; Other</em>. It will open up <em>Open Perspective</em> wizard. <br clear="none">
   Select <em>Java EE</em> from the list and click <em>OK</em> button.</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/1.jpg"></span></p>

<p>2. Right click on the <em>Package Explorer</em> and select <em>EJB Project</em>. </p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/2.jpg"></span></p>

<p>3. This will open up the <em>New EJB Project</em> wizard. Provide the values for <em>Project Name</em>, <em>Target Runtime</em> as given in the screen shot below. Click on <em>Next</em> button.</p>
<div class="confluence-information-macro confluence-information-macro-note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"></span><div class="confluence-information-macro-body">
<p>If target runtime is not setup, create a new target runtime pointing to geronimo installation directory. For more information, look at the geronimo documentation that explains setting up eclipse plugin for geronimo and setting up runtime environment. This setup is required to resolve class dependencies during compilation.</p></div></div>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/3.jpg"></span></p>

<p>4. Select the check boxes as given in the screen shot below and click on the <em>Next</em> button.</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/4.jpg"></span></p>

<p>5. Select the checkboxes as given in the below screen shot and click on the <em>Next</em> button.</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/5.jpg"></span></p>


<p>6. Provide the following values in textboxes and click on the <em>Finish</em> button.</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/6.jpg"></span></p>

<p>7. Right click on the <em>ContainerManagedJPA-EJB</em> project and navigate to <em>New =&gt; Class</em> option. Provide the <br clear="none">
   following values in the <em>New Java Class</em> wizard and click on <em>Finish</em> button.</p>

<p>   <span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/7.jpg"></span></p>


<p>8. Copy the following contents into <code>Account.java</code>.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>sample.jpa.Account.java</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
package sample.jpa;

import java.io.Serializable;
import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.PostLoad;
import javax.persistence.PostUpdate;
import javax.persistence.PrePersist;
import javax.persistence.PreUpdate;
import javax.persistence.Table;


@Entity
@Table(name = "ACCOUNTCME")
public class Account implements Serializable {

 @Id
 public int accountNumber;
 public String ownerName;
 public double balance;


 public Account() {
  accountNumber = (int) System.nanoTime();
 }

 public String toString() {
 return "Acc.# " + accountNumber + ", owner" + ownerName 
        + ", balance: " + balance
        + " $";
 }

 @PrePersist
 public void prepersist() {
  System.out.println("pre persist!!");
 }

 @PreUpdate
 public void preupdate() {
  System.out.println("pre update!!");
 }

 @PostUpdate
 public void postupdate() {
  System.out.println("post update!!");
 }

 @PostLoad
 public void postload() {
  System.out.println("post load!!");
 }

 public int getAccountNumber() {
  return accountNumber;
 }

 public void setAccountNumber(int accountNumber) {
  this.accountNumber = accountNumber;
 }

 public String getOwnerName() {
  return ownerName;
 }

 public void setOwnerName(String ownerName) {
  this.ownerName = ownerName;
 }

 public void setBalance(double balance) {
  this.balance = balance;
 }

 public double getBalance() {
 return balance;
 }
}
</pre>
</div></div>

<p>9. Similarly, create <code>AccountInterface.java</code> and copy the following contents.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>sample.jpa.AccountInterface.java</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
package sample.jpa;

public interface AccountInterface {

 public Account open(int accountNumber) ;
 public double getBalance(int accountNumber);
 public void deposit(int accountNumber,double amount) ;
 public double withdraw(int accountNumber,double amount) ;
}
</pre>
</div></div>
<p>10. Similarly, create <code>AccountBean.java.java</code> and copy the following contents.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>sample.jpa.AccountBean.java</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
package sample.jpa;


import javax.ejb.EJBException;
import javax.ejb.Remote;
import javax.ejb.Stateless;
import javax.ejb.TransactionAttribute;
import javax.ejb.TransactionAttributeType;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.PersistenceContextType;


@Stateless
@Remote(AccountInterface.class)
public class AccountBean implements AccountInterface { 

 @PersistenceContext(type=PersistenceContextType.TRANSACTION)    
 private EntityManager manager;


 @TransactionAttribute(TransactionAttributeType.REQUIRED)    
 public Account open(int accountNumber) {
  Account account = manager.find(Account.class, accountNumber);
  if(account == null){
   account = new Account();
   account.ownerName = "anonymous";
   account.accountNumber = accountNumber;
   manager.persist(account);
   return account;
  }else{
   throw new EJBException("Account already exists..!!. Account Number = "+accountNumber);
  }
 }    

 @TransactionAttribute(TransactionAttributeType.REQUIRED)    
 public double getBalance(int accountNumber) {
  Account account = manager.find(Account.class, accountNumber);
  if(account==null)
   throw new EJBException("Account not found..!!. Account Number = "+accountNumber);
  return account.balance;
 }

 @TransactionAttribute(TransactionAttributeType.REQUIRED)
 public void deposit(int accountNumber, double amount) {
  Account account = manager.find(Account.class, accountNumber);
  if(account==null)
   throw new EJBException("Account not found..!!. Account Number = "+accountNumber);
  double new_balance = account.getBalance() + amount;
  account.setBalance(new_balance);
 }

 @TransactionAttribute(TransactionAttributeType.REQUIRED)    
 public double withdraw(int accountNumber, double  amount) { 
  Account account = manager.find(Account.class, accountNumber);
  if(account==null)
   throw new EJBException("Account not found..!!. Account Number = "+accountNumber);
  if (amount &gt; account.getBalance()) {
   return 0;
  }else {
   double new_balance = account.getBalance() - amount;
   account.setBalance(new_balance);
   return amount;
  }
 }
}
</pre>
</div></div>

<p>11. As outlined above, right click on the <code>META_INF</code> directory of <code>ContainerManagedJPA-EJB</code> project and  <br clear="none">
    create <code>persistence.xml</code>. Copy the following contents into <code>persistence.xml</code>.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>persistence.xml</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence"
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.0"
 xsi:schemaLocation="http://java.sun.com/xml/ns/persistence  
 http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd"&gt;

 &lt;persistence-unit name="AccountUnit" transaction-type="JTA"&gt;
  &lt;description&gt;ContainerManagedJPA&lt;/description&gt;
  &lt;provider&gt;org.apache.openjpa.persistence.PersistenceProviderImpl&lt;/provider&gt;
  &lt;jta-data-source&gt;AccountDS&lt;/jta-data-source&gt;
  &lt;class&gt;sample.jpa.Account&lt;/class&gt;
 &lt;/persistence-unit&gt;
&lt;/persistence&gt;
</pre>
</div></div>

<p>12. Since we are going to use EJB annotations, the <code>META-INF/ejb-jar.xml</code> will not have any declarations. The contents of the <code>META-INF/openejb-jar.xml</code> file should be as below. Otherwise, modify it accordingly.</p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>openejb-jar.xml</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;openejb-jar xmlns="http://openejb.apache.org/xml/ns/openejb-jar-2.2" 
 xmlns:naming="http://geronimo.apache.org/xml/ns/naming-1.2" 
 xmlns:sec="http://geronimo.apache.org/xml/ns/security-2.0" 
 xmlns:sys="http://geronimo.apache.org/xml/ns/deployment-1.2"&gt;
 
 &lt;sys:environment&gt;
  &lt;sys:moduleId&gt;
   &lt;sys:groupId&gt;ContainerManagedJPA&lt;/sys:groupId&gt;
   &lt;sys:artifactId&gt;EJB&lt;/sys:artifactId&gt;
   &lt;sys:version&gt;1.0&lt;/sys:version&gt;
   &lt;sys:type&gt;car&lt;/sys:type&gt;
  &lt;/sys:moduleId&gt;

  &lt;dependencies&gt;
   &lt;dependency&gt;
    &lt;groupId&gt;console.dbpool&lt;/groupId&gt;
    &lt;artifactId&gt;AccountDS&lt;/artifactId&gt;
   &lt;/dependency&gt;
  &lt;/dependencies&gt;

 &lt;/sys:environment&gt;
 &lt;enterprise-beans/&gt;
 &lt;/openejb-jar&gt;
</pre>
</div></div>

<p>13. Finally the project <code>ContainerManagedJPA-EJB</code> should like as below.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/8.jpg"></span></p>


<h2 id="DevelopingcontainermanagedpersistencewithJPA-Creatingwebapplication">Creating web application </h2>

<p>1. Right click on the <em>Project Explorer</em> and select <em>New =&gt; Project</em>. This will popup <em>New Project</em> wizard.  <br clear="none">
   Select <em>Dynamic Web Project</em> under option <em>Web</em>. Click on the <em>Next</em> button.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/9.jpg"></span></p>

<p>2. Provide the values as given in the screen shot below on the <em>New Dynamic Web Project</em> wizard. Please note that <em>Add project to an EAR</em> checkbox is check to add this web project to <em>ContainerManagedJPA-EAR</em> created during the creation of <em>ContainerManagedJPA-EJB</em> project.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/10.jpg"></span></p>

<p>3. In the next screen, select the <em>Version</em> values as given in the below figure and click on the <em>Next</em> button. </p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/11.jpg"></span></p>

<p>4. Check on the <em>Generate Deployment Descriptor</em> checkbox and click on the <em>Next</em> button. On the next screen, configure the deployment plan as follows. After this, click on the <em>Finish</em> button to complete creating web project</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/12.jpg"></span></p>


<p>5. Right click on the <em>WebContent</em> folder of the web project and navigate to <em>New =&gt; HTML</em> to create the index.html file as given in the screen shot. Click on the <em>Next</em> button and on the next screen click on the <em>Finish</em> button. The content of the index.html is provided below the screen shot.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/13.jpg"></span></p>

<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>index.html</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
&lt;title&gt;Input Account Numbers and Amount&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;form name="input" action="/ContainerManagedJPA-WEB/Test"method="get"&gt;
&lt;table border="0"&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="5"&gt; Debit Account Number&lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" name="account1"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="5"&gt; Credit Account Number&lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" name="account2"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;font color="black" size="5"&gt; Amount to be Transfered &lt;/font&gt;&lt;/td&gt;
&lt;td align="left"&gt;&lt;input type="text" name="amount"&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align="right"&gt;&lt;input type="submit" value="Submit"&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
</div></div>


<p>6. Right click on the web project and navigate to <em>New =&gt; Servlet</em> and click on it.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/14.jpg"></span></p>


<p>7. On the <em>Create Servlet</em> wizard, provide the values as given in the below screen shot and click on the <em>Next</em> button.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/15.jpg"></span></p>

<p>8. Select the defaults in the next screens and finally click on the <em>Finish</em> button.</p>


<p>9. Copy the below content into the servlet <code>Test.java</code></p>
<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;border-bottom-style: solid;"><b>Test.java</b></div><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
package sample.jpa;

import java.io.IOException;
import java.io.PrintWriter;

import javax.ejb.EJB;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.transaction.UserTransaction;

public class Test extends javax.servlet.http.HttpServlet 
 implements javax.servlet.Servlet {

 static final long serialVersionUID = 1L;

 @PersistenceContext(unitName="AccountUnit")
 private EntityManager em;

 @EJB AccountInterface accountBean;

 public Test() {
  super();
 }   	

 protected void doGet(HttpServletRequest request, 
                      HttpServletResponse response) 
                      throws ServletException, 
                      IOException {


 PrintWriter out = response.getWriter();

 int accNo1 = Integer.parseInt(
              request.getParameter("account1"));
 int  accNo2 = Integer.parseInt(
              request.getParameter("account2"));
 double amount = Double.parseDouble(
                 request.getParameter("amount"));

 try{
  Context ctx = new InitialContext();
  UserTransaction ut = (UserTransaction)
                        ctx.lookup("java:comp/UserTransaction");
  ut.begin();

  Account account = em.find(Account.class, accNo1);
  if(account.getBalance() &lt; amount){
   throw new Exception("&lt;font size=5&gt;Account "+accNo1+
         " does not have enough balance "+amount+"&lt;/font&gt;");
  }else{
   outputText(out, "2", "green", 
              "Message : Getting the balance amount available in Account Number "
              +accNo1+" in the Test Servlet");

   outputText(out, "5", "black","Account ="+
              accNo1+" : Current balance "+account.getBalance());
   out.println("&lt;br/&gt;");

   outputText(out, "2", "green","Message : Withdrawing amount ("+
              amount+") using AccountBean from the Account Number "+accNo1);

   accountBean.withdraw(accNo1, amount);

   outputText(out, "2", "green",
     "Message : Getting the balance amount available in Account Number "+accNo1+
     " in the Test Servlet after withdrawing");

   double balance = account.getBalance();
   outputText(out, "5", "black","Account ="+accNo1+
   " : After withdrawing the balance is "+balance);
   out.println("&lt;br/&gt;");

   outputText(out, "2", "green",
    "Message : Getting the balance amount available in Account Number "+
    accNo2+" in the Test Servlet");

   Account account2 = em.find(Account.class, accNo2);
   outputText(out, "5", "black","Account ="+
    accNo2+" : Current balance "+account2.getBalance());
   
   out.println("&lt;br/&gt;");

   outputText(out, "2", "green",
    "Message : depositing amount ("+amount+
    ") using AccountBean to the Account Number "+accNo2);

   accountBean.deposit(accNo2, amount);
   outputText(out, "2", "green",
   "Message : Getting the balance amount available in Account Number "+
   accNo2+" in the Test Servlet after depositing");

   outputText(out, "5", "black","Account ="+
              accNo2+" : After depositing the balance is "+
              account2.getBalance());

   out.println("&lt;br/&gt;");
   }
  ut.commit();
  }catch(Exception e){
  throw new ServletException(e);
 }
}  	

 protected void doPost(HttpServletRequest request, 
                       HttpServletResponse response) 
                       throws ServletException, IOException {
 }   	

 private void outputText(PrintWriter out, 
                         String fontsize, 
                         String color,
                         String text){
  out.println("&lt;font size="+fontsize+" color="+
                color+"&gt;"+text+"&lt;/font&gt;"+"&lt;br/&gt;");
 }
}
</pre>
</div></div>

<p>10. Right click on the <code>ContainerManagedJPA-WEB</code> project and click on <em>Properties</em> to open <em>Properties for ContainerManagedJPA-WEB</em> wizard. Click on the <em>Java Build Path</em> and <em>Projects</em> tab. Click on the <em>Add</em> button and add <code>ContainerManagedJPA-EJB</code> project. Finally, click on the <em>OK</em> button on <em>Properties for ContainerManagedJPA-WEB</em> wizard. This is required because, <code>ContainerManagedJPA-WEB</code> projects looks up <code>AccountInterface</code> ejb in the <code>ContainerManagedJPA-EJB</code> project. To resolve the dependency during compilation, the EJB project has to be added to the build path of the WEB project.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/16.jpg"></span></p>


<h2 id="DevelopingcontainermanagedpersistencewithJPA-SettingupthedatabasetablesandtheDatasource">Setting up the database tables and the Datasource</h2>

<p>1. Start the geronimo server and open the admin console on a browser window with the url  <br clear="none">
   <a shape="rect" class="external-link" href="http://localhost:8080/console" rel="nofollow">http://localhost:8080/console</a>.</p>

<p>2. Click on the <em>Embedded DB =&gt; DB Manager</em> on the <em>Console Navigation</em> portlet. </p>

<p>3. On the <em>Run SQL</em> portlet on the right side, enter <em>AccountDB</em> in the <em>Create DB</em> textbox and click on the <br clear="none">
  <em>Create</em> button.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/17.jpg"></span></p>

<p>4. The above step will create <code>AccountDB</code> database. On the same screen, enter the below SQL command on the <em>SQL Command/s</em> textarea and select <em>AccountDB</em> in the <em>Use DB</em> combo box and click on the <em>Run SQL</em> button. This will create <em>ACCOUNTCME</em> table in the <em>AccountDB</em> database.</p>

<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
create table ACCOUNTCME (ACCOUNTNUMBER integer, OWNERNAME varchar(100), BALANCE decimal(15,2));
</pre>
</div></div>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/18.jpg"></span></p>

<p>5. Also insert two rows using the below SQL command. </p>

<div class="code panel pdl" style="border-style: solid;border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="brush: java; gutter: false; theme: Default">
insert into ACCOUNTCME values (1, 'Phani',2000);
insert into ACCOUNTCME values (2, 'Nag',2000);
</pre>
</div></div>

<p>After inserting the rows, table will look like the below screen shot.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/19.jpg"></span></p>


<p>6. We need to deploy datasource over AccountDB database for JPA. This datasource will be used by JPA to connect to database and perform DML operations. Admin console can be used to deploy a datasource over AccountDB. Click on the <em>services =&gt; Database Pools</em> in the <em>Console =&gt; Navigation</em> portlet. This will display the list of database pools currently running in the server.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/20.jpg"></span></p>


<p>7. Click on the <em>Using the Geronimo database pool wizard</em> link. This will open up the <em>Database pools</em> portlet as follows. Provide  the value for <em>Name of the Database pool</em> as <em>AccountDS</em> and select <em>Derby embedded</em> as below and click on the <em>Next</em> button.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/21.jpg"></span></p>


<p>8. On the next screen, select the JAR file listed in the <em>Driver JAR</em> select box and provide <em>AccountDB</em> as the value for Database Name and click on the <em>Deploy</em> button at the bottom. This will deploy the data source and display the list of datasources currently deployed on the server.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/22.jpg"></span></p>

<p>9. In the eclipse, open the <code>openejb-jar.xml</code> and provide the dependency to the <code>AccountDS</code>. Finally, the <code>openejb-jar.xml</code> should be as below. This configuration is already done in the step-12 of <em>Creating ejb application with entities</em> above</p>

<h2 id="DevelopingcontainermanagedpersistencewithJPA-Deployingthe(ear)application">Deploying the (ear) application</h2>

<p>1. Deploy the EAR file as follows</p>
<div class="preformatted panel" style="border-style: solid;border-width: 1px;"><div class="preformattedContent panelContent">
<pre>C:\Geronimo-2.1\bin&gt;deploy.bat --user system --password manager deploy c:\temp\ContainerManagedJPA-EAR.ear
Using GERONIMO_BASE:   C:\Geronimo-2.1
Using GERONIMO_HOME:   C:\Geronimo-2.1
Using GERONIMO_TMPDIR: var\temp
Using JRE_HOME:        C:\SDK-May-31-2007\jre
    Deployed default/ContainerManagedJPA-EAR/1.0/car
      `-&gt; ContainerManagedJPA-WEB.war @ /ContainerManagedJPA-WEB
      `-&gt; ContainerManagedJPA-EJB.jar</pre>
</div></div>


<p>22. Running the application</p>

<p>1. Open a browser window and hit the URL as <a shape="rect" class="external-link" href="http://localhost:8080/ContainerManagedJPA-WEB/" rel="nofollow">http://localhost:8080/ContainerManagedJPA-WEB/</a> <br clear="none">
This page displays a html form with input fields for <em>Debit Account Number</em>, <em>Credit Account Number</em> and <em>Amount to be Transferred</em>. Enter the values as given in the below screen shot and click on the <em>Submit</em> button.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/23.jpg"></span></p>

<p>2. On the next page, several messages are displayed as below. From the messages, it can seen that the persistence context is propagated along with the transaction and hence the changes made to Account balance in the ejb is observed in the servlet when <code>account.getBalance(accountNumber)</code> is called.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/24.jpg"></span></p>

<p>3. The values of the balance fields in the <code>ACCOUNTCME</code> table after the transaction are as follows.</p>

<p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="developing-container-managed-persistence-with-jpa.data/25.jpg"></span></p></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="middle" class="footer">
            &nbsp;&nbsp;
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Delicious" />
            <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">Bookmark this on Delicious</a>
            &nbsp;&nbsp;
            <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="Digg!" />
            <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title)+'&amp;topic=programming');">Digg this</a>
            <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : Developing container managed persistence with JPA';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
            &nbsp;&nbsp;
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">Privacy Policy</a>&nbsp;&nbsp;-&nbsp;&nbsp;
            Copyright &#169; 2003-2013, The Apache Software Foundation, Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0.</a>&nbsp;&nbsp;
          </td>
        </tr>
    </table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  </body>
</html>
