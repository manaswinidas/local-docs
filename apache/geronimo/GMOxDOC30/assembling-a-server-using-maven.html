<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="http://geronimo.apache.org/style/default.css">
    <LINK rel="SHORTCUT ICON" href="http://geronimo.apache.org/images/favicon.ico">
    <LINK rel="schema.DC" href="http://purl.org/DC/elements/1.0/">
    <META name="Description" content="Assembling a server using Maven" />
    <META name="Keywords" content="Apache Geronimo 3.0 Documentation JavaEE6 OSGi Assembling a server using Maven" />
    <META name="Owner" content="dev@geronimo.apache.org" />
    <META name="Robots" content="index, follow" />
    <META name="Security" content="Public" />
    <META name="Source" content="wiki template" />
    <META name="DC.Date" scheme="iso8601" content="2010-05-11" />
    <META name="DC.Language" scheme="rfc1766" content="en" />
    <META name="DC.Rights" content="Copyright Â© 2003-2013, The Apache Software Foundation" />
    <META http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html" l gen true r (cz 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html" l gen true r (n 0 s 0 v 0 l 0) "http://www.classify.org/safesurf/" l gen true r (SS~~000 1))'/>

    <script src="http://geronimo.apache.org/functions.js" type="text/javascript"></script>


    <title>Apache Geronimo v3.0 Documentation: Assembling a server using Maven</title>
  </head>

  <body onload="init()">

        <!-- banner -->
    <table valign="top" border="0" cellspacing="0" cellpadding="0" width="100%" background="http://geronimo.apache.org/images/top_bgstretch_1x64.gif">
      <tr>
        <td valing="top" align="left">
          <img src="http://geronimo.apache.org/images/topleft_logo_437x64.gif" border="0">
        </td>
      </tr>
    </table>

        <!-- topNav -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr class="topBar">
        <td align="left" valign="middle" class="topBarDiv" align="left" nowrap>
          <a href="/geronimo"> Home</a> >&nbsp;<a href="documentation.html">Documentation</a>&nbsp;&gt;&nbsp;<a href="configuring-and-administering.html">Configuring and administering</a>&nbsp;&gt;&nbsp;<a href="configuring-and-administering-the-apache-geronimo-server.html">Configuring and administering the Apache Geronimo Server</a>&nbsp;&gt;&nbsp;<a href="customizing-server-assemblies.html">Customizing server assemblies</a>&nbsp;&gt;&nbsp;<a href="assembling-a-server-using-maven.html">Assembling a server using Maven</a>
        </td>
        <td align="right" valign="middle" nowrap>
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
        </td>
      </tr> 
    </table>

        <!-- pageContent -->
    <div id="PageContent">
      <div class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="http://geronimo.apache.org/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <div style="margin: 0px 10px 0px 10px" class="smalltext">Apache Geronimo v3.0</div>
        <div style="margin: 0px 10px 8px 10px"  class="pagetitle">Assembling a server using Maven</div>

        <div class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
<!-- -->         
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645311">
            <img src="http://geronimo.apache.org/images/icons/notep_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Edit Page"></a>
            <a href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=20645311">Edit Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">
            <img src="http://geronimo.apache.org/images/icons/browse_space.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Browse Space"></a>
            <a href="https://cwiki.apache.org/confluence/pages/listpages.action?key=GMOxDOC30">Browse Space</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645311">
            <img src="http://geronimo.apache.org/images/icons/add_page_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add Page"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=GMOxDOC30&fromPageId=20645311">Add Page</a>
          &nbsp;
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645311">
            <img src="http://geronimo.apache.org/images/icons/add_blogentry_16.gif"
                 height="16" width="16" border="0" align="absmiddle" title="Add News"></a>
          <a href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=GMOxDOC30&fromPageId=20645311">Add News</a>
<!-- -->	 
        </div>
      </div>

      <div class="pagecontent">
        <div class="wiki-content">
          <div class="wiki-content maincontent"><p>Deploying applications with the command line deployer or through the administration console is fine for experiments but does not fit well into an automated development workflow.  With the Geronimo plugin system, you can set up a workflow by using maven that builds your applications, pre-deploys them as Geronimo plugins, and assembles a server containing the plugins needed to run your applications.  Further workflow steps could include automated testing by starting the custom server and running, for example, selenium tests against it.</p>

<p>To simplify setting up such an automated workflow, you can use maven archetypes, which can help with setting up maven projects to build plugins and assemble servers.  As an example, this topic describes setting up such a workflow for the liferay 4.4.1 portal.   Note that this is two steps removed from a description of how to deploy liferay on geronimo, and one step removed from a description of how to build plugins for the liferay portal. For a completed example of such a workflow, see the roller plugins at <a shape="rect" class="external-link" href="https://svn.apache.org/repos/asf/geronimo/plugins/roller/trunk">https://svn.apache.org/repos/asf/geronimo/plugins/roller/trunk</a></p>

<p>Notes:</p>
<ol><li>Because of maven lifecycle improvements in the car-maven-plugin, the assembly artifact only generates poms that work with Geronimo 2.1.1-SNAPSHOT or later.  The archetypes are currently available only as snapshots from branches/2.1 and trunk.</li><li>Maven tends to strip out all comments from the new pom.xml. Therefore, a pom.sample.xml that has more comments on how to set up the pom.xml for common situations is included.</li><li>Archetypes use some attributes (groupId, version) of parent projects when they exist.  The instructions use this: for standalone use you may need to supply more command line options.</li><li>Some of this would not be necessary given a project built with maven in the first place</li><li>As of writing, the server starts (given enough memory) but the liferay portal doesn't show up.  Hopefully we'll figure out why soon.</li></ol>


<h1 id="AssemblingaserverusingMaven-Processoverview.">Process overview.</h1>
<ol><li>Get the necessary artifacts into the local maven repo if they are not already available</li><li>Construct the base maven project</li><li>Use the maven war archetype to build a project to modify the artifacts as necessary using for instance the maven-war-plugin overlay to remove dependencies from WEB-INF/lib so copies in geronimo's repository can be used</li><li>Use the geronimo-plugin-archetype to build projects to build plugins for the components</li><li>Use the geronimo-assembly-archetype to build a project to assemble the server.</li></ol>


<h2 id="AssemblingaserverusingMaven-Preparation&#8211;findtheartifacts">Preparation &#8211; find the artifacts</h2>

<p>Liferay does not publish its code to any maven repo. Start by downloading:</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
wget http://downloads.sourceforge.net/lportal/liferay-portal-4.4.1.war?modtime=1202491348&amp;big_mirror=1

wget http://downloads.sourceforge.net/lportal/liferay-portal-dependencies-4.4.1.zip?modtime=1202491352&amp;big_mirror=1
]]></script>
</div></div>

<p>unpacking:</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
unzip liferay-portal-dependencies-4.4.1.zip
]]></script>
</div></div>

<p>and installing to your local repo:</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
mvn install:install-file \
  -Dfile=liferay-portal-4.4.1.war \
  -DgroupId=com.liferay \
  -DartifactId=liferay-portal \
  -Dversion=4.4.1 \
  -Dpackaging=war

mvn install:install-file \
  -Dfile=liferay-portal-dependencies-4.4.1/portal-kernel.jar \
  -DgroupId=com.liferay \
  -DartifactId=portal-kernel \
  -Dversion=4.4.1 \
  -Dpackaging=jar

mvn install:install-file \
  -Dfile=liferay-portal-dependencies-4.4.1/portal-service.jar \
  -DgroupId=com.liferay \
  -DartifactId=portal-service \
  -Dversion=4.4.1 \
  -Dpackaging=jar
]]></script>
</div></div>

<h2 id="AssemblingaserverusingMaven-Setupaparentmavenproject">Set up a parent maven project</h2>


<p>I can't find an archetype to create an empty "parent" project.  So...<br clear="none">
Find a suitable location and run</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
mvn archetype:create \
  -DarchetypeGroupId=org.apache.maven.archetypes \
  -DarchetypeArtifactId=maven-archetype-quickstart \
  -DarchetypeVersion=1.0 \
  -DgroupId=org.apache.geronimo.plugins \
  -DartifactId=liferay-parent \
  -Dversion=1.0-SNAPSHOT

cd liferay-parent
rm -rf src

]]></script>
</div></div>
<p>Edit the pom.xml to change the packaging to pom and remove the dependency.</p>

<p>Also, until we publish a non-snapshot version of the archetypes, include this so the archetypes can be downloaded automatically:</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
    &lt;pluginRepositories&gt;
        &lt;pluginRepository&gt;
            &lt;id&gt;apache-snapshots&lt;/id&gt;
            &lt;name&gt;Apache Snapshots Repository&lt;/name&gt;
            &lt;url&gt;http://people.apache.org/repo/m2-snapshot-repository&lt;/url&gt;
            &lt;layout&gt;default&lt;/layout&gt;
            &lt;snapshots&gt;
                &lt;enabled&gt;true&lt;/enabled&gt;
                &lt;updatePolicy&gt;daily&lt;/updatePolicy&gt;
                &lt;checksumPolicy&gt;ignore&lt;/checksumPolicy&gt;
            &lt;/snapshots&gt;
            &lt;releases&gt;
                &lt;enabled&gt;false&lt;/enabled&gt;
            &lt;/releases&gt;
        &lt;/pluginRepository&gt;
    &lt;/pluginRepositories &gt;
]]></script>
</div></div>

<div class="confluence-information-macro confluence-information-macro-note"><p class="title">Note on Geronimo Versions</p><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"></span><div class="confluence-information-macro-body">
<p>Unless you are using a published archetype that goes with the version of geronimo you are using, you will have to update the &lt;geronimoVersion&gt; property in the generated poms to whatever the correct version is.  For instance as of writing the generated poms have &lt;geronimoVersion&gt;2.2-SNAPSHOT&lt;/geronimoVersion&gt; and for use with geronimo 2.1 you would update this to &lt;geronimoVersion&gt;2.1&lt;/geronimoVersion&gt;</p></div></div>

<h2 id="AssemblingaserverusingMaven-Repackagetheliferaywar">Repackage the liferay war</h2>
<p>The JEE spec tells us to package jars used by an application in with the application in WEB-INF/lib or lib directories.  This may appear to make the application more self contained but it can produce a tracking nightmare as it becomes more difficult to determine exactly what is in these directories, what version is being used, etc etc, not to mention promoting duplication of code used by several projects.  Geronimo instead lets you put your jars in the maven-structured geronimo repository and specify the classloader structure for your apps to include these jars where necessary.  If you want to convert an existing war project to this repository-based classloader solution you probably need to remove some of the jars from the existing war.  You can do this easily with maven war overlays.  For each jar you want to use from the geronimo repository, you specify an exclude in the overlay configuration and add the jar as a dependency in the maven project that builds the geronimo plugin.  This example only excludes a few jars, most of which are already present in the parent classloader.</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
mvn archetype:create \
  -DarchetypeGroupId=org.apache.maven.archetypes \
  -DarchetypeArtifactId=maven-archetype-webapp \
  -DarchetypeVersion=1.0 \
  -DgroupId=com.liferay \
  -DartifactId=liferay-portal-lesslibs \
  -Dversion=4.4.1-SNAPSHOT
cd liferay-portal-lesslibs
rm -rf src
]]></script>
</div></div>

<p>Modify the pom.xml to include the liferay war dependency</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
        &lt;dependency&gt;
            &lt;groupId&gt;com.liferay&lt;/groupId&gt;
            &lt;artifactId&gt;liferay-portal&lt;/artifactId&gt;
            &lt;version&gt;4.4.1&lt;/version&gt;
            &lt;type&gt;war&lt;/type&gt;
	&lt;/dependency&gt;
]]></script>
</div></div>

<p>and configure the war plugin with an overlay descriptor:</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
                &lt;version&gt;2.1-alpha-1&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;overlays&gt;
                        &lt;overlay&gt;
                            &lt;id&gt;liferay&lt;/id&gt;
                            &lt;groupId&gt;com.liferay&lt;/groupId&gt;
                            &lt;artifactId&gt;liferay-portal&lt;/artifactId&gt;
                            &lt;excludes&gt;
                                &lt;exclude&gt;WEB-INF/classes/log4j.properties&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/geronimo-web.xml&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/jboss-web.xml&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/jonas-web.xml&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/jrun-web.xml&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/resin-web.xml&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/sun-web.xml&lt;/exclude&gt;

                                &lt;!-- use geronimo dependencies rather than inclusion for published artifacts --&gt;
                                &lt;exclude&gt;WEB-INF/lib/activemq.jar&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/lib/commons-digester.jar&lt;/exclude&gt;
                                &lt;!-- other excludes are supplied by geronimo anyway --&gt;
                                &lt;exclude&gt;WEB-INF/lib/cglib.jar&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/lib/commons-logging..jar&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/lib/j2ee-management.jar&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/lib/jmx-remote.jar&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/lib/jmx-ri.jar&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/lib/log4j.jar&lt;/exclude&gt;
                                &lt;exclude&gt;WEB-INF/lib/mx4j.jar&lt;/exclude&gt;
                            &lt;/excludes&gt;
                        &lt;/overlay&gt;
                    &lt;/overlays&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;

    &lt;/build&gt;
]]></script>
</div></div>

<h2 id="AssemblingaserverusingMaven-Buildadatabaseplugin">Build a database plugin</h2>

<p>in liferay-parent run</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
mvn archetype:create \
  -DarchetypeGroupId=org.apache.geronimo.buildsupport \
  -DarchetypeArtifactId=geronimo-plugin-archetype \
  -DarchetypeVersion=2.2-SNAPSHOT \
  -DartifactId=liferay-derby
]]></script>
</div></div>

<p>Change the plan so it looks like this:</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;connector xmlns=&quot;http://geronimo.apache.org/xml/ns/j2ee/connector-1.2&quot;&gt;
    &lt;resourceadapter&gt;
        &lt;outbound-resourceadapter&gt;
            &lt;connection-definition&gt;
                &lt;connectionfactory-interface&gt;javax.sql.DataSource&lt;/connectionfactory-interface&gt;
                &lt;connectiondefinition-instance&gt;
                    &lt;name&gt;jdbc/LiferayPool&lt;/name&gt;
                    &lt;config-property-setting name=&quot;Password&quot;&gt;liferay&lt;/config-property-setting&gt;
                    &lt;config-property-setting name=&quot;UserName&quot;&gt;liferay&lt;/config-property-setting&gt;
                    &lt;config-property-setting name=&quot;DatabaseName&quot;&gt;liferay&lt;/config-property-setting&gt;
                    &lt;connectionmanager&gt;
                        &lt;local-transaction/&gt;
                        &lt;single-pool&gt;
                            &lt;max-size&gt;10&lt;/max-size&gt;
                            &lt;min-size&gt;0&lt;/min-size&gt;
                            &lt;match-one/&gt;
                        &lt;/single-pool&gt;
                    &lt;/connectionmanager&gt;
                &lt;/connectiondefinition-instance&gt;
&lt;!-- Leave until we figure out if non-jta datasource is needed --&gt;
&lt;!--
                &lt;connectiondefinition-instance&gt;
                    &lt;name&gt;jdbc/NoTxrollerdb&lt;/name&gt;
                    &lt;config-property-setting name=&quot;Password&quot;&gt;roller&lt;/config-property-setting&gt;
                    &lt;config-property-setting name=&quot;UserName&quot;&gt;roller&lt;/config-property-setting&gt;
                    &lt;config-property-setting name=&quot;DatabaseName&quot;&gt;roller&lt;/config-property-setting&gt;
                    &lt;connectionmanager&gt;
                        &lt;no-transaction/&gt;
                        &lt;single-pool&gt;
                            &lt;max-size&gt;10&lt;/max-size&gt;
                            &lt;min-size&gt;0&lt;/min-size&gt;
                            &lt;match-one/&gt;
                        &lt;/single-pool&gt;
                    &lt;/connectionmanager&gt;
                &lt;/connectiondefinition-instance&gt;
--&gt;
            &lt;/connection-definition&gt;
        &lt;/outbound-resourceadapter&gt;
    &lt;/resourceadapter&gt;

&lt;/connector&gt;

]]></script>
</div></div>

<p>and modify the pom setting the geronimoVersion to 2.1 and with</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
    &lt;dependencies&gt;
        &lt;!-- if you are deploying a jee application, use scope provided --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.tranql&lt;/groupId&gt;
            &lt;artifactId&gt;tranql-connector-derby-embed-local&lt;/artifactId&gt;
            &lt;version&gt;1.4&lt;/version&gt;
            &lt;type&gt;rar&lt;/type&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;!-- other dependencies will normally end up as dependencies in the plan and geronimo-plugin.xml --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.geronimo.configs&lt;/groupId&gt;
            &lt;artifactId&gt;system-database&lt;/artifactId&gt;
            &lt;type&gt;car&lt;/type&gt;
            &lt;version&gt;${geronimoVersion}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- include dependencies on all deployer modules needed, with scope provided --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.geronimo.configs&lt;/groupId&gt;
            &lt;artifactId&gt;connector-deployer&lt;/artifactId&gt;
            &lt;type&gt;car&lt;/type&gt;
            &lt;version&gt;${geronimoVersion}&lt;/version&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;
]]></script>
</div></div>

<p>and</p>
<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.geronimo.buildsupport&lt;/groupId&gt;
                &lt;artifactId&gt;car-maven-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;deploymentConfigs&gt;
                        &lt;!-- gbean deployer is default.  For jee apps include all deployers your app needs, see properties --&gt;
                        &lt;deploymentConfig&gt;${gbeanDeployer}&lt;/deploymentConfig&gt;
                        &lt;deploymentConfig&gt;${connectorDeployer}&lt;/deploymentConfig&gt;
                    &lt;/deploymentConfigs&gt;
                    &lt;!-- if you are deploying a jee app specify it here --&gt;
                    &lt;module&gt;
                        &lt;groupId&gt;org.tranql&lt;/groupId&gt;
                        &lt;artifactId&gt;tranql-connector-derby-embed-local&lt;/artifactId&gt;
                        &lt;type&gt;rar&lt;/type&gt;
                    &lt;/module&gt;
                    &lt;!-- Normally you can use the maven dependencies unaltered.  If you need to specify import scope
                     you can list the dependencies here as you want them in the plan.xml --&gt;
                    &lt;useMavenDependencies&gt;
                        &lt;value&gt;true&lt;/value&gt;
                        &lt;includeVersion&gt;true&lt;/includeVersion&gt;
                    &lt;/useMavenDependencies&gt;
                    &lt;!-- the instance sets up most of the optional geronimo-plugin.xml content --&gt;
                    &lt;instance&gt;
                        &lt;plugin-artifact&gt;
                        &lt;/plugin-artifact&gt;
                    &lt;/instance&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;

]]></script>
</div></div>


<h2 id="AssemblingaserverusingMaven-Buildtheliferaywarplugin">Build the liferay war plugin</h2>

<p>run</p>
<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
mvn archetype:create \
  -DarchetypeGroupId=org.apache.geronimo.buildsupport \
  -DarchetypeArtifactId=geronimo-plugin-archetype \
  -DarchetypeVersion=2.2-SNAPSHOT \
  -DartifactId=liferay-jetty
]]></script>
</div></div>

<p>Edit the plan so it looks like:<br clear="none">
NOTE: this is derived from the liferay plan at and is under the liferay (MIT) license</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
&lt;?xml version=&quot;1.0&quot;?&gt;

&lt;web-app xmlns=&quot;http://geronimo.apache.org/xml/ns/j2ee/web-2.0.1&quot;&gt;

    &lt;environment&gt;
        &lt;inverse-classloading/&gt;
    &lt;/environment&gt;

	&lt;context-root&gt;${LiferayContextPath}&lt;/context-root&gt;
	&lt;security-realm-name&gt;PortalRealm&lt;/security-realm-name&gt;
      &lt;security use-context-handler=&quot;false&quot; xmlns=&quot;http://geronimo.apache.org/xml/ns/security-2.0&quot;&gt;
&lt;!-- requires security to be set up for default subject
        &lt;default-subject&gt;
          &lt;realm&gt;PortalRealm&lt;/realm&gt;
          &lt;id&gt;default&lt;/id&gt;
        &lt;/default-subject&gt;
--&gt;
        &lt;role-mappings&gt;
          &lt;role role-name=&quot;users&quot;&gt;
              &lt;principal class=&quot;com.liferay.portal.security.jaas.PortalRole&quot; name=&quot;users&quot; /&gt;
          &lt;/role&gt;
        &lt;/role-mappings&gt;
      &lt;/security&gt;

    &lt;gbean name=&quot;CredentialStore&quot; class=&quot;org.apache.geronimo.security.credentialstore.SimpleCredentialStoreImpl&quot;&gt;
        &lt;xml-attribute name=&quot;credentialStore&quot;&gt;
            &lt;credential-store xmlns=&quot;http://geronimo.apache.org/xml/ns/credentialstore-1.0&quot;&gt;
                &lt;realm name=&quot;PortalRealm&quot;&gt;
                    &lt;subject&gt;
                        &lt;id&gt;default&lt;/id&gt;
&lt;!-- you will have so set up the backing store appropriately --&gt;
                        &lt;credential&gt;
                            &lt;type&gt;org.apache.geronimo.security.credentialstore.NameCallbackHandler&lt;/type&gt;
                            &lt;value&gt;anonymous&lt;/value&gt;
                        &lt;/credential&gt;
                        &lt;credential&gt;
                            &lt;type&gt;org.apache.geronimo.security.credentialstore.PasswordCallbackHandler&lt;/type&gt;
                            &lt;value&gt;anonymous&lt;/value&gt;
                        &lt;/credential&gt;
                    &lt;/subject&gt;
                &lt;/realm&gt;
            &lt;/credential-store&gt;
        &lt;/xml-attribute&gt;
        &lt;dependency&gt;
            &lt;name&gt;PortalRealm&lt;/name&gt;
        &lt;/dependency&gt;
    &lt;/gbean&gt;



	&lt;gbean name=&quot;PortalRealm&quot; class=&quot;org.apache.geronimo.security.realm.GenericSecurityRealm&quot;&gt;
		&lt;attribute name=&quot;realmName&quot;&gt;PortalRealm&lt;/attribute&gt;
		&lt;reference name=&quot;ServerInfo&quot;&gt;
			&lt;name&gt;ServerInfo&lt;/name&gt;
		&lt;/reference&gt;
		&lt;xml-reference name=&quot;LoginModuleConfiguration&quot;&gt;
			&lt;log:login-config xmlns:log=&quot;http://geronimo.apache.org/xml/ns/loginconfig-2.0&quot;&gt;
				&lt;log:login-module control-flag=&quot;REQUIRED&quot; wrap-principals=&quot;false&quot;&gt;
					&lt;log:login-domain-name&gt;PortalDomain&lt;/log:login-domain-name&gt;
					&lt;log:login-module-class&gt;com.liferay.portal.security.jaas.ext.tomcat.PortalLoginModule&lt;/log:login-module-class&gt;
				&lt;/log:login-module&gt;
			&lt;/log:login-config&gt;
		&lt;/xml-reference&gt;
	&lt;/gbean&gt;
&lt;/web-app&gt;
]]></script>
</div></div>

<p>and the pom to have geronimoVersion 2.1, liferayVersion 4.4.1 and include</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
    &lt;dependencies&gt;
        &lt;!-- if you are deploying a jee application, use scope provided --&gt;
        &lt;!-- other dependencies will normally end up as dependencies in the plan and geronimo-plugin.xml --&gt;
        &lt;!-- include dependencies on all deployer modules needed, with scope provided --&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.liferay&lt;/groupId&gt;
            &lt;artifactId&gt;liferay-portal-lesslibs&lt;/artifactId&gt;
            &lt;version&gt;${liferayVersion}-SNAPSHOT&lt;/version&gt;
            &lt;type&gt;war&lt;/type&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
	&lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.geronimo.configs&lt;/groupId&gt;
            &lt;artifactId&gt;javamail&lt;/artifactId&gt;
            &lt;type&gt;car&lt;/type&gt;
            &lt;version&gt;${geronimoVersion}&lt;/version&gt;
        &lt;/dependency&gt;
&lt;!-- replaces activemq jar in lib dir --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;
            &lt;artifactId&gt;activemq-core&lt;/artifactId&gt;
            &lt;type&gt;jar&lt;/type&gt;
            &lt;version&gt;4.1.1&lt;/version&gt;
        &lt;/dependency&gt;
&lt;!-- activemq car does not work because liferay wants to use spring to configure activemq. If we can eliminate the spring 
files in portal-impl.jar perhaps this would work.
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.geronimo.configs&lt;/groupId&gt;
            &lt;artifactId&gt;activemq-ra&lt;/artifactId&gt;
            &lt;type&gt;car&lt;/type&gt;
            &lt;version&gt;${geronimoVersion}&lt;/version&gt;
        &lt;/dependency&gt;
--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.geronimo.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;liferay-derby&lt;/artifactId&gt;
            &lt;type&gt;car&lt;/type&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;portlet-api&lt;/groupId&gt;
            &lt;artifactId&gt;portlet-api&lt;/artifactId&gt;
            &lt;version&gt;1.0&lt;/version&gt;
	&lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.liferay&lt;/groupId&gt;
            &lt;artifactId&gt;portal-kernel&lt;/artifactId&gt;
            &lt;version&gt;${liferayVersion}&lt;/version&gt;
	&lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.liferay&lt;/groupId&gt;
            &lt;artifactId&gt;portal-service&lt;/artifactId&gt;
            &lt;version&gt;${liferayVersion}&lt;/version&gt;
	&lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;xerces&lt;/groupId&gt;
            &lt;artifactId&gt;xercesImpl&lt;/artifactId&gt;
            &lt;version&gt;2.8.1&lt;/version&gt;
	&lt;/dependency&gt;

       &lt;dependency&gt;
            &lt;groupId&gt;saxpath&lt;/groupId&gt;
            &lt;artifactId&gt;saxpath&lt;/artifactId&gt;
            &lt;version&gt;1.0-FCS&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;commons-digester&lt;/groupId&gt;
            &lt;artifactId&gt;commons-digester&lt;/artifactId&gt;
            &lt;version&gt;1.8&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.geronimo.framework&lt;/groupId&gt;
            &lt;artifactId&gt;geronimo-gbean-deployer&lt;/artifactId&gt;
            &lt;type&gt;car&lt;/type&gt;
            &lt;version&gt;${geronimoVersion}&lt;/version&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.geronimo.configs&lt;/groupId&gt;
            &lt;artifactId&gt;jetty6-deployer&lt;/artifactId&gt;
            &lt;type&gt;car&lt;/type&gt;
            &lt;version&gt;${geronimoVersion}&lt;/version&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.geronimo.configs&lt;/groupId&gt;
            &lt;artifactId&gt;jasper-deployer&lt;/artifactId&gt;
            &lt;type&gt;car&lt;/type&gt;
            &lt;version&gt;${geronimoVersion}&lt;/version&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.geronimo.configs&lt;/groupId&gt;
            &lt;artifactId&gt;persistence-jpa10-deployer&lt;/artifactId&gt;
            &lt;type&gt;car&lt;/type&gt;
            &lt;version&gt;${geronimoVersion}&lt;/version&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;
]]></script>
</div></div>

<p>and </p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.geronimo.buildsupport&lt;/groupId&gt;
                &lt;artifactId&gt;car-maven-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;deploymentConfigs&gt;
                        &lt;!-- gbean deployer is default.  For jee apps include all deployers your app needs, see properties --&gt;
                        &lt;deploymentConfig&gt;${gbeanDeployer}&lt;/deploymentConfig&gt;
                        &lt;deploymentConfig&gt;${j2eeDeployer}&lt;/deploymentConfig&gt;
                        &lt;deploymentConfig&gt;${jetty6Deployer}&lt;/deploymentConfig&gt;
                        &lt;deploymentConfig&gt;${jasperDeployer}&lt;/deploymentConfig&gt;
                        &lt;!--&lt;deploymentConfig&gt;${jpaDeployer}&lt;/deploymentConfig&gt;--&gt;
                    &lt;/deploymentConfigs&gt;
                    &lt;!-- if you are deploying a jee app specify it here --&gt;

                                        &lt;module&gt;
            &lt;groupId&gt;com.liferay&lt;/groupId&gt;
            &lt;artifactId&gt;liferay-portal-lesslibs&lt;/artifactId&gt;
            &lt;version&gt;${liferayVersion}&lt;/version&gt;
            &lt;type&gt;war&lt;/type&gt;
                                        &lt;/module&gt;

                    &lt;!-- Normally you can use the maven dependencies unaltered. If you need to specify import scope
                     you can list the dependencies here as you want them in the plan.xml --&gt;
                    &lt;useMavenDependencies&gt;
                        &lt;value&gt;true&lt;/value&gt;
                        &lt;includeVersion&gt;true&lt;/includeVersion&gt;
                    &lt;/useMavenDependencies&gt;
                    &lt;!-- the instance sets up most of the optional geronimo-plugin.xml content --&gt;
                    &lt;instance&gt;
                        &lt;plugin-artifact&gt;
                            &lt;!-- extract stuff from the car to the specified location (good for config info --&gt;
                            &lt;!--&lt;copy-file relative-to=&quot;server&quot; dest-dir=&quot;var/roller-data&quot;&gt;themes&lt;/copy-file&gt;--&gt;
                            &lt;!-- content that should go into var/config/config.xml for module customization --&gt;
                            &lt;!-- note the variable ${LiferayContextPath} which is further specified in var/config/config-substitutions.properties --&gt;

                                                        &lt;config-xml-content server=&quot;default&quot;&gt;
                                                            &lt;gbean name=&quot;org.apache.geronimo.plugins/liferay-jetty/${liferayPluginVersion}/car&quot;&gt;
                                                                &lt;attribute name=&quot;contextPath&quot;&gt;${LiferayContextPath}&lt;/attribute&gt;
                                                            &lt;/gbean&gt;
                                                        &lt;/config-xml-content&gt;

                            &lt;!-- a user-tweakable variable to go into var/config/config-substitutions.properties --&gt;
                            &lt;config-substitution key=&quot;LiferayContextPath&quot;&gt;/liferay&lt;/config-substitution&gt;
                        &lt;/plugin-artifact&gt;
                    &lt;/instance&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;

]]></script>
</div></div>

<h2 id="AssemblingaserverusingMaven-Buildanassembly">Build an assembly</h2>
<p>In liferay-parent run</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
mvn archetype:create \
  -DarchetypeGroupId=org.apache.geronimo.buildsupport \
  -DarchetypeArtifactId=geronimo-assembly-archetype \
  -DarchetypeVersion=2.2-SNAPSHOT \
  -DgroupId=org.apache.geronimo.plugins \
  -DartifactId=geronimo-jetty-liferay \
  -Dversion=1.0-SNAPSHOT
]]></script>
</div></div>

<p>Edit the geronimo-jetty-liferay pom to set geronimoVersion to 2.1 and include the top level modules you want in your server (console-jetty is optional)</p>

<p>NOTE: do not remove the boilerplate!</p>

<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
        &lt;!-- List the plugins you want in your server --&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.geronimo.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;liferay-jetty&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
            &lt;type&gt;car&lt;/type&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.geronimo.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;console-jetty&lt;/artifactId&gt;
            &lt;version&gt;${geronimoVersion}&lt;/version&gt;
            &lt;type&gt;car&lt;/type&gt;
        &lt;/dependency&gt;

]]></script>
</div></div>

<h2 id="AssemblingaserverusingMaven-Runtheproject!">Run the project!</h2>
<p>The maven project is now complete. Run it and try out the resulting server!</p>

<p>in liferay-parent run</p>
<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
mvn clean install
]]></script>
</div></div>

<p>To try out the resulting server you can find it in your local maven repo under .m2/repository/org/apache/geronimo/plugins/geronimo-jetty-liferay/1.0-SNAPSHOT/geronimo-jetty-liferay-1.0-SNAPSHOT-bin.tar.gz or in the build in geronimo-jetty-liferay/target.</p>

<p>Untar and run with </p>
<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script class="brush: java; gutter: false; theme: Default" type="syntaxhighlighter"><![CDATA[
cd geronimo-jetty-liferay/target
tar xzf geronimo-jetty-liferay-1.0-SNAPSHOT-bin.tar.gz
cd geronimo-jetty-liferay-1.0-SNAPSHOT
#edit etc/rc.d/start-server,default.groovy
#insert line 
#command.javaFlags &lt;&lt; &#39;-XX:MaxPermSize=1024m&#39;
#and update -Xmx1024m
./bin/gsh geronimo/start-server
]]></script>
</div></div>

<p>As of writing the server will start but accessing <a shape="rect" class="external-link" href="http://localhost:8080/liferay" rel="nofollow">http://localhost:8080/liferay</a> redirects to <a shape="rect" class="external-link" href="http://localhost:8080/c" rel="nofollow">http://localhost:8080/c</a> and gives a 404 error.</p></div>
        </div>

              </div>
    </div>

        <!-- footer -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="middle" class="footer">
            &nbsp;&nbsp;
            <img src="http://static.delicious.com/img/delicious.small.gif" height="10" width="10" alt="Delicious" />
            <a href="http://delicious.com/save" onclick="window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title),'delicious','toolbar=no,width=550,height=550'); return false;">Bookmark this on Delicious</a>
            &nbsp;&nbsp;
            <img src="http://digg.com/img/badges/16x16-digg-guy.gif" width="16" height="16" alt="Digg!" />
            <a href="" onclick="window.open('http://digg.com/submit?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title)+'&amp;topic=programming');">Digg this</a>
            <!-- Slicker, but no text
            <script type="text/javascript">
              digg_skin = 'icon';
              digg_window = 'new';
              digg_title = 'Apache Geronimo v3.0 Documentation : Assembling a server using Maven';
              digg_topic = 'programming';
            </script>
            <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>
            -->
            &nbsp;&nbsp;
          </td>
          <td align="right" valign="middle" class="footer">
            <a href="http://cwiki.apache.org/GMOxPMGT/geronimo-privacy-policy.html">Privacy Policy</a>&nbsp;&nbsp;-&nbsp;&nbsp;
            Copyright &#169; 2003-2013, The Apache Software Foundation, Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">ASL 2.0.</a>&nbsp;&nbsp;
          </td>
        </tr>
    </table> 

        <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-4380560-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>

  </body>
</html>
