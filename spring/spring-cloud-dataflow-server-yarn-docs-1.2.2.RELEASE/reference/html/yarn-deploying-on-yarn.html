<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>15.&nbsp;Deploying on YARN</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Cloud Data Flow for Apache YARN"><link rel="up" href="_spring_cloud_data_flow_runtime.html" title="Part&nbsp;IV.&nbsp;Spring Cloud Data Flow Runtime"><link rel="prev" href="_spring_cloud_data_flow_runtime.html" title="Part&nbsp;IV.&nbsp;Spring Cloud Data Flow Runtime"><link rel="next" href="yarn-deploying-on-ambari.html" title="16.&nbsp;Deploying on AMBARI"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">15.&nbsp;Deploying on YARN</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="_spring_cloud_data_flow_runtime.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;IV.&nbsp;Spring Cloud Data Flow Runtime</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="yarn-deploying-on-ambari.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="yarn-deploying-on-yarn" href="#yarn-deploying-on-yarn"></a>15.&nbsp;Deploying on YARN</h2></div></div></div><p>The server application is run as a standalone application. All
applications used for streams and tasks will be deployed on the YARN
cluster that is targeted by the server.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_prerequisites" href="#_prerequisites"></a>15.1&nbsp;Prerequisites</h2></div></div></div><p>These requirements are not something yarn runtime needs but generally
what dataflow core needs.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Rabbit - If dataflow apps using rabbit bindings are used.</li><li class="listitem">Kafka - If dataflow apps using kafka bindings are used.</li><li class="listitem">DB - we currently use embedded H2 database, though any supported
DB can be configured.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_download_and_extract_distribution" href="#_download_and_extract_distribution"></a>15.2&nbsp;Download and Extract Distribution</h2></div></div></div><p>Download the Spring Cloud Data Flow YARN distribution ZIP file which
includes the Server and the Shell apps:</p><pre class="programlisting">$ wget http://repo.spring.io/release/org/springframework/cloud/dist/spring-cloud-dataflow-server-yarn-dist/1.2.2.RELEASE/spring-cloud-dataflow-server-yarn-dist-1.2.2.RELEASE.zip</pre><p>Unzip the distribution ZIP file and change to the directory containing the deployment files.</p><pre class="programlisting">$ cd spring-cloud-dataflow-server-yarn-1.2.2.RELEASE</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_configure_settings" href="#_configure_settings"></a>15.3&nbsp;Configure Settings</h2></div></div></div><p>Generic runtime settings can changed in <code class="literal">config/servers.yml</code>.
Dedicated section <a class="xref" href="yarn-configure-settings.html" title="17.&nbsp;Configuring Runtime Settings and Environment">Chapter&nbsp;17, <i>Configuring Runtime Settings and Environment</i></a> contains detailed
information about configuration.</p><p><code class="literal">servers.yml</code> file is a central place to share common configuration as
it is added to Boot based jvm processes via option
<code class="literal">-Dspring.config.location=servers.yml</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_start_server" href="#_start_server"></a>15.4&nbsp;Start Server</h2></div></div></div><p>If this is the first time deploying make sure the user that runs
the <span class="emphasis"><em>Server</em></span> app has rights to create and write to <span class="emphasis"><em>/dataflow</em></span>
directory in <code class="literal">hdfs</code>. If there is an existing deployment on <code class="literal">hdfs</code>
remove it using:</p><pre class="programlisting">$ hdfs dfs -rm -R /dataflow</pre><p>Start the Spring Cloud Data Flow Server app for YARN</p><pre class="programlisting">$ ./bin/dataflow-server-yarn</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_connect_shell" href="#_connect_shell"></a>15.5&nbsp;Connect Shell</h2></div></div></div><p>start <code class="literal">spring-cloud-dataflow-shell</code></p><pre class="programlisting">$ ./bin/dataflow-shell</pre><p>Shell in a distribution package contains extension commands for a
<code class="literal">hdfs</code> file system.</p><pre class="programlisting">dataflow:&gt;hadoop fs
hadoop fs cat              hadoop fs copyFromLocal    hadoop fs copyToLocal      hadoop fs expunge
hadoop fs ls               hadoop fs mkdir            hadoop fs mv               hadoop fs rm
dataflow:&gt;hadoop fs ls /
rwxrwxrwx root         supergroup 0 2016-07-25 06:54:15 /
rwxrwxrwx jvalkealahti supergroup 0 2016-07-25 06:58:38 /dataflow
rwxr-xr-x jvalkealahti supergroup 0 2016-07-25 07:31:32 /repo
rwxrwxrwx root         supergroup 0 2016-07-20 16:25:31 /tmp
rwxrwxrwx jvalkealahti supergroup 0 2015-10-29 10:59:24 /user</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can configure server address automatically by placing it in
a configuration using key <code class="literal">dataflow.uri</code>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_register_applications" href="#_register_applications"></a>15.6&nbsp;Register Applications</h2></div></div></div><p>By default, the application registry will be empty. If you would like
to register all out-of-the-box stream applications built with the RabbitMQ
binder in bulk, you can with the following command. For more details,
review how to <a class="link" href="spring-cloud-dataflow-register-apps.html" title="23.&nbsp;Register a Stream App">register applications</a>.</p><pre class="programlisting">dataflow:&gt;app import --uri http://bit.ly/stream-applications-rabbit-maven</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_sourcing_applications_from_hdfs" href="#_sourcing_applications_from_hdfs"></a>15.6.1&nbsp;Sourcing Applications from HDFS</h3></div></div></div><p>YARN integration also allows you to store registered applications
directly in HDFS instead of relying on <code class="literal">maven</code> or any other
resolution. Only thing to change during a registration is to use
<code class="literal">hdfs</code> address as shown below.</p><pre class="programlisting">dataflow:&gt;app register --name ftp --type sink --uri hdfs:/dataflow/artifacts/repo/ftp-sink-kafka-1.0.0.RC1.jar</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_create_stream" href="#_create_stream"></a>15.7&nbsp;Create Stream</h2></div></div></div><p>Create a stream:</p><pre class="programlisting">dataflow:&gt;stream create --name foostream --definition "time|log" --deploy</pre><p>List streams:</p><pre class="programlisting">dataflow:&gt;stream list
&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9572;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9572;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
&#9553;Stream Name&#9474;Stream Definition&#9474; Status &#9553;
&#9568;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9578;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9578;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9571;
&#9553;foostream  &#9474;time|log         &#9474;deployed&#9553;
&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9575;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9575;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;</pre><p>After some time, destroy the stream:</p><pre class="programlisting">dataflow:&gt;stream destroy --name foostream</pre><p>The YARN application is pushed and started automatically during a stream
deployment process. Once all streams are destroyed the YARN application
will exit.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_create_task" href="#_create_task"></a>15.8&nbsp;Create Task</h2></div></div></div><p>Create and launch task:</p><pre class="programlisting">dataflow:&gt;task create --name footask --definition "timestamp"
Created new task 'footask'
dataflow:&gt;task launch --name footask
Launched task 'footask'</pre><p>Launch tasks from streams:</p><p><code class="literal">task-launcher-yarn-sink</code> itself bundles a <span class="emphasis"><em>YARN Deployer</em></span> but doesn&#8217;t
push any apps into hdfs, thus pushed app needs to exist and match a
deployer version <code class="literal">task-launcher-yarn-sink</code> uses.</p><p>In below sample we use <code class="literal">tasklaunchrequest</code> processor to pass needed
properties into <code class="literal">task-launcher-yarn</code> sink. We explicitely defined
<code class="literal">appVersion</code> as <code class="literal">appv1</code> which you would have pushed into hdfs prior
running this stream. With this processor you also need to define a
<code class="literal">uri</code> for a task application itself.</p><pre class="programlisting">stream create --name launchertest --definition "http
--server.port=9000|tasklaunchrequest
--deployment-properties=spring.cloud.deployer.yarn.app.appVersion=appv1
--uri=hdfs:/dataflow/repo/timestamp-task.jar|task-launcher-yarn"
--deploy</pre><p>To fire up a task just post a dummy message into <code class="literal">http</code> source.</p><pre class="programlisting">http post --target http://localhost:9000 --data empty</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Using <code class="literal">http</code> source in YARN difficult as you don&#8217;t immediately know on
which cluster node that source app is running.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_using_yarn_cli" href="#_using_yarn_cli"></a>15.9&nbsp;Using YARN Cli</h2></div></div></div><p>Overall app status can be seen from <span class="emphasis"><em>YARN Resource Manager UI</em></span> or
using <span class="emphasis"><em>Spring YARN CLI</em></span> which gives more info about running containers
within an app itself.</p><pre class="programlisting">$ ./bin/dataflow-server-yarn-cli shell</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_check_yarn_app_statuses" href="#_check_yarn_app_statuses"></a>15.9.1&nbsp;Check YARN App Statuses</h3></div></div></div><p>When stream has been submitted YARN shows it as <code class="literal">ACCEPTED</code> before its
turned to <code class="literal">RUNNING</code> state.</p><pre class="programlisting">$ submitted
  APPLICATION ID                  USER          NAME                     QUEUE    TYPE      STARTTIME       FINISHTIME  STATE     FINALSTATUS  ORIGINAL TRACKING URL
  ------------------------------  ------------  -----------------------  -------  --------  --------------  ----------  --------  -----------  ---------------------
  application_1461658614481_0001  jvalkealahti  scdstream:app:foostream  default  DATAFLOW  26/04/16 16:27  N/A         ACCEPTED  UNDEFINED

$ submitted
  APPLICATION ID                  USER          NAME                     QUEUE    TYPE      STARTTIME       FINISHTIME  STATE    FINALSTATUS  ORIGINAL TRACKING URL
  ------------------------------  ------------  -----------------------  -------  --------  --------------  ----------  -------  -----------  -------------------------
  application_1461658614481_0001  jvalkealahti  scdstream:app:foostream  default  DATAFLOW  26/04/16 16:27  N/A         RUNNING  UNDEFINED    http://192.168.1.96:58580</pre><p>More info about internals for stream apps can be queried by
<code class="literal">clustersinfo</code> and <code class="literal">clusterinfo</code> commands:</p><pre class="programlisting">$ clustersinfo -a application_1461658614481_0001
  CLUSTER ID
  --------------
  foostream:log
  foostream:time

$ clusterinfo -a application_1461658614481_0001 -c foostream:time
  CLUSTER STATE  MEMBER COUNT
  -------------  ------------
  RUNNING        1</pre><p>After stream is undeployed YARN app should close itself automatically:</p><pre class="programlisting">$ submitted -v
  APPLICATION ID                  USER          NAME                     QUEUE    TYPE      STARTTIME       FINISHTIME      STATE     FINALSTATUS  ORIGINAL TRACKING URL
  ------------------------------  ------------  -----------------------  -------  --------  --------------  --------------  --------  -----------  ---------------------
  application_1461658614481_0001  jvalkealahti  scdstream:app:foostream  default  DATAFLOW  26/04/16 16:27  26/04/16 16:28  FINISHED  SUCCEEDED</pre><p>Launching a task will be shown in <code class="literal">RUNNING</code> state while app is
executing its batch jobs:</p><pre class="programlisting">$ submitted -v
  APPLICATION ID                  USER          NAME                     QUEUE    TYPE      STARTTIME       FINISHTIME      STATE     FINALSTATUS  ORIGINAL TRACKING URL
  ------------------------------  ------------  -----------------------  -------  --------  --------------  --------------  --------  -----------  -------------------------
  application_1461658614481_0002  jvalkealahti  scdtask:timestamp        default  DATAFLOW  26/04/16 16:29  N/A             RUNNING   UNDEFINED    http://192.168.1.96:39561
  application_1461658614481_0001  jvalkealahti  scdstream:app:foostream  default  DATAFLOW  26/04/16 16:27  26/04/16 16:28  FINISHED  SUCCEEDED

$ submitted -v
  APPLICATION ID                  USER          NAME                     QUEUE    TYPE      STARTTIME       FINISHTIME      STATE     FINALSTATUS  ORIGINAL TRACKING URL
  ------------------------------  ------------  -----------------------  -------  --------  --------------  --------------  --------  -----------  ---------------------
  application_1461658614481_0002  jvalkealahti  scdtask:timestamp        default  DATAFLOW  26/04/16 16:29  26/04/16 16:29  FINISHED  SUCCEEDED
  application_1461658614481_0001  jvalkealahti  scdstream:app:foostream  default  DATAFLOW  26/04/16 16:27  26/04/16 16:28  FINISHED  SUCCEEDED</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_push_apps" href="#_push_apps"></a>15.9.2&nbsp;Push Apps</h3></div></div></div><p>Yarn applications needed for a dataflow can be pushed manually
into hdfs with a given version which default to <code class="literal">app</code>.</p><pre class="programlisting">Spring YARN Cli (v2.4.0.RELEASE)
Hit TAB to complete. Type 'help' and hit RETURN for help, and 'exit' to quit.
$ push -t STREAM
New version installed
$ push -t TASK
New version installed
$ push -t TASK -v appv1
New version installed</pre><p>After above commands base directories for different app versions would
look like as shown below. Streams and tasks can then use different
versions which allows to use alternate configurations.</p><pre class="programlisting">/dataflow/apps/stream/app
/dataflow/apps/task/app
/dataflow/apps/task/appv1</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Push happens automatically when stream is deployer or task
launched.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_using_metric_collectors" href="#_using_metric_collectors"></a>15.10&nbsp;Using Metric Collectors</h2></div></div></div><p>We package three different metrics collector implementations, one for
<span class="emphasis"><em>RabbitMQ</em></span> and two for different <span class="emphasis"><em>Kafka</em></span> versions. There can be
started using shell scripts,
<code class="literal">dataflow-server-metrics-collector-kafka-09</code>,
<code class="literal">dataflow-server-metrics-collector-kafka-10</code> and
<code class="literal">dataflow-server-metrics-collector-rabbit</code> respectively. These
applications are not using <code class="literal">servers.yml</code> file for config, instead
<code class="literal">collectors.yml</code> is used where custom settings can be placed.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>With <code class="literal">Kafka 0.10.1</code> and later, <code class="literal">kafka-10</code> should be used. With <code class="literal">Kafka
0.10.0</code> and earlier, <code class="literal">kafka-09</code> should be used.</p></td></tr></table></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="_spring_cloud_data_flow_runtime.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="_spring_cloud_data_flow_runtime.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="yarn-deploying-on-ambari.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Part&nbsp;IV.&nbsp;Spring Cloud Data Flow Runtime&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;16.&nbsp;Deploying on AMBARI</td></tr></table></div></body></html>