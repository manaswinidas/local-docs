<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>52.&nbsp;Frequently asked questions</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Cloud Data Flow for Apache YARN"><link rel="up" href="howto.html" title="Part&nbsp;VIII.&nbsp;&#8216;How-to&#8217; guides"><link rel="prev" href="_logging.html" title="51.&nbsp;Logging"><link rel="next" href="appendix.html" title="Part&nbsp;IX.&nbsp;Appendices"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">52.&nbsp;Frequently asked questions</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="_logging.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;VIII.&nbsp;&#8216;How-to&#8217; guides</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="appendix.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="faqs" href="#faqs"></a>52.&nbsp;Frequently asked questions</h2></div></div></div><p>In this section, we will review the frequently discussed questions in Spring Cloud Data Flow.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_advanced_spel_expressions" href="#_advanced_spel_expressions"></a>52.1&nbsp;Advanced SpEL expressions</h2></div></div></div><p>One of the powerful features of SpEL expressions is <a class="link" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-ref-functions" target="_top">functions</a>.
Spring Integration provides <code class="literal">jsonPath()</code> and <code class="literal">xpath()</code> out-of-the-box <a class="link" href="http://docs.spring.io/spring-integration/reference/html/spel.html#spel-functions" target="_top">SpEL-functions</a>, if appropriate libraries are in the classpath.
All the provided Spring Cloud Stream application starters are supplied with the <code class="literal">json-path</code> and <code class="literal">spring-integration-xml</code> jars, thus we can use those SpEL-functions in Spring Cloud Data Flow streams whenever expressions are possible.
For example we can transform JSON-aware <code class="literal">payload</code> from the HTTP request using some <code class="literal">jsonPath()</code> expression:</p><pre class="programlisting">dataflow:&gt;stream create jsonPathTransform --definition <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http | transform --expression=#jsonPath(payload,'$.price') | log"</span> --deploy
...
dataflow:&gt; http post --target http://localhost:<span class="hl-number">8080</span> --data {<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"symbol"</span>:<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"SCDF"</span>,<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"price"</span>:<span class="hl-number">72.04</span>}
dataflow:&gt; http post --target http://localhost:<span class="hl-number">8080</span> --data {<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"symbol"</span>:<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"SCDF"</span>,<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"price"</span>:<span class="hl-number">72.06</span>}
dataflow:&gt; http post --target http://localhost:<span class="hl-number">8080</span> --data {<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"symbol"</span>:<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"SCDF"</span>,<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"price"</span>:<span class="hl-number">72.08</span>}</pre><p>In this sample we apply jsonPath for the incoming payload to extract just only the <code class="literal">price</code> field value.
Similar syntax can be used with <code class="literal">splitter</code> or <code class="literal">filter</code> <code class="literal">expression</code> options.
Actually any available SpEL-based option has access to the built-in SpEL-functions.
For example we can extract some value from JSON data to calculate the <code class="literal">partitionKey</code> before sending output to the Binder:</p><pre class="programlisting">dataflow:&gt;stream deploy foo --properties <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"deployer.transform.count=2,app.transform.producer.partitionKeyExpression=#jsonPath(payload,'$.symbol')"</span></pre><p>The same syntax can be applied for <code class="literal">xpath()</code> SpEL-function when you deal with XML data.
Any other custom SpEL-function can also be used, but for this purpose you should build a library with the <code class="literal">@Configuration</code> class containing an appropriate <code class="literal">SpelFunctionFactoryBean</code> <code class="literal">@Bean</code> definition.
The target Spring Cloud Stream application starter should be re-packaged to supply such a custom extension via built-in Spring Boot <code class="literal">@ComponentScan</code> mechanism or auto-configuration hook.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dataflow-jdbc-sink" href="#dataflow-jdbc-sink"></a>52.2&nbsp;How to use JDBC-sink?</h2></div></div></div><p>The JDBC-sink can be used to insert message payload data into a relational database table. By default,
it inserts the entire payload into a table named after the <code class="literal">jdbc.table-name</code> property, and if it is not set,
by default the application expects to use a table with the name <code class="literal">messages</code>. To alter this behavior, the
JDBC sink accepts <a class="link" href="http://docs.spring.io/spring-cloud-stream-app-starters/docs/current/reference/html/spring-cloud-stream-modules-sinks.html#spring-cloud-stream-modules-jdbc-sink" target="_top">several options</a> that you can pass using the --foo=bar notation in the stream, or change globally.
The JDBC sink has a <code class="literal">jdbc.initialize</code> property that if set to <code class="literal">true</code> will result in the sink creating a table based on the specified configuration when the it starts up. If that initialize property is <code class="literal">false</code>, which is the default, you will have to make sure that the table to use is already available.</p><p>A stream definition using <code class="literal">jdbc</code> sink relying on all defaults with MySQL as the backing database looks
like the following. In this example, the system time is persisted in MySQL for every second.</p><pre class="programlisting">dataflow:&gt;stream create --name mydata --definition <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"time | jdbc --spring.datasource.url=jdbc:mysql://localhost:3306/test --spring.datasource.username=root --spring.datasource.password=root --spring.datasource.driver-class-name=org.mariadb.jdbc.Driver"</span> --deploy</pre><p>For this to work, you&#8217;d have to have the following table in the MySQL database.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">CREATE</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">TABLE</span> test.messages
(
  payload <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">varchar</span>(<span class="hl-number">255</span>)
);</pre><pre class="programlisting">mysql&gt; desc <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.messages;
+---------+--------------+------+-----+---------+-------+
| Field   | Type         | Null | Key | Default | Extra |
+---------+--------------+------+-----+---------+-------+
| payload | varchar(<span class="hl-number">255</span>) | YES  |     | NULL    |       |
+---------+--------------+------+-----+---------+-------+
<span class="hl-number">1</span> row in <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span> (<span class="hl-number">0.00</span> sec)</pre><pre class="programlisting">mysql&gt; select * from <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.messages;
+-------------------+
| payload           |
+-------------------+
| <span class="hl-number">04</span>/<span class="hl-number">25</span>/<span class="hl-number">17</span> <span class="hl-number">09</span>:<span class="hl-number">10</span>:<span class="hl-number">04</span> |
| <span class="hl-number">04</span>/<span class="hl-number">25</span>/<span class="hl-number">17</span> <span class="hl-number">09</span>:<span class="hl-number">10</span>:<span class="hl-number">06</span> |
| <span class="hl-number">04</span>/<span class="hl-number">25</span>/<span class="hl-number">17</span> <span class="hl-number">09</span>:<span class="hl-number">10</span>:<span class="hl-number">07</span> |
| <span class="hl-number">04</span>/<span class="hl-number">25</span>/<span class="hl-number">17</span> <span class="hl-number">09</span>:<span class="hl-number">10</span>:<span class="hl-number">08</span> |
| <span class="hl-number">04</span>/<span class="hl-number">25</span>/<span class="hl-number">17</span> <span class="hl-number">09</span>:<span class="hl-number">10</span>:<span class="hl-number">09</span> |
.............
.............
.............</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dataflow-multiple-brokers" href="#dataflow-multiple-brokers"></a>52.3&nbsp;How to use multiple message-binders?</h2></div></div></div><p>For situations where the data is consumed and processed between two different message brokers, Spring
Cloud Data Flow provides easy to override global configurations, out-of-the-box <a class="link" href="https://github.com/spring-cloud-stream-app-starters/bridge" target="_top"><code class="literal">bridge-processor</code></a>,
and DSL primitives to build these type of topologies.</p><p>Let&#8217;s assume we have data queueing up in RabbitMQ <span class="emphasis"><em>(e.g., queue = <code class="literal">fooRabbit</code>)</em></span> and the requirement
is to consume all the payloads and publish them to Apache Kafka <span class="emphasis"><em>(e.g., topic = <code class="literal">barKafka</code>)</em></span>, as the
destination for downstream processing.</p><p>Follow the global application of <a class="link" href="spring-cloud-dataflow-create-stream.html#spring-cloud-dataflow-global-properties" title="25.3&nbsp;Common application properties">configurations</a>
to define multiple binder configurations.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Apache Kafka Global Configurations (i.e., identified by "kafka1")</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">spring.cloud.dataflow.applicationProperties.stream.spring.cloud.stream.binders.kafka1.type</span>=kafka
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">spring.cloud.dataflow.applicationProperties.stream.spring.cloud.stream.binders.kafka1.environment.spring.cloud.stream.kafka.binder.brokers</span>=localhost:9092
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">spring.cloud.dataflow.applicationProperties.stream.spring.cloud.stream.binders.kafka1.environment.spring.cloud.stream.kafka.binder.zkNodes</span>=localhost:2181

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># RabbitMQ Global Configurations (i.e., identified by "rabbit1")</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">spring.cloud.dataflow.applicationProperties.stream.spring.cloud.stream.binders.rabbit1.type</span>=rabbit
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">spring.cloud.dataflow.applicationProperties.stream.spring.cloud.stream.binders.rabbit1.environment.spring.rabbitmq.host</span>=localhost
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">spring.cloud.dataflow.applicationProperties.stream.spring.cloud.stream.binders.rabbit1.environment.spring.rabbitmq.port</span>=5672</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>In this example, both the message brokers are running locally and reachable at <code class="literal">localhost</code>
with respective ports.</p></td></tr></table></div><p>These properties can be supplied in a ".properties" file that is accessible to the server directly or via
<code class="literal">config-server</code>.</p><pre class="programlisting">java -jar spring-cloud-dataflow-server-local/target/spring-cloud-dataflow-server-local-<span class="hl-number">1.1</span>.<span class="hl-number">4.</span>RELEASE.jar --spring.config.location=&lt;PATH-TO-FILE&gt;/foo.properties</pre><p>Spring Cloud Data Flow internally uses <code class="literal">bridge-processor</code> to directly connect different named channel
destinations. Since we are publishing and subscribing from two different messaging systems, you&#8217;d have
to build the <code class="literal">bridge-processor</code> with both RabbitMQ and Apache Kafka binders in the classpath. To do that,
head over to <a class="link" href="http://start-scs.cfapps.io/" target="_top">start-scs.cfapps.io/</a> and select <code class="literal">Bridge Processor</code>, <code class="literal">Kafka binder starter</code>, and
<code class="literal">Rabbit binder starter</code> as the dependencies and follow the patching procedure described in the
<a class="link" href="http://docs.spring.io/spring-cloud-stream-app-starters/docs/Bacon.RELEASE/reference/html/_introduction.html#customizing-binder" target="_top">reference guide</a>.
Specifically, for the <code class="literal">bridge-processor</code>, you&#8217;d have to import the <code class="literal">BridgeProcessorConfiguration</code>
provided by the starter.</p><p>Once you have the necessary adjustments, you can build the application. Let&#8217;s register the name of the
application as <code class="literal">multiBinderBridge</code>.</p><pre class="programlisting">dataflow:&gt;app register --<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">type</span> processor --name multiBinderBridge --uri file:///&lt;PATH-TO-FILE&gt;/multipleBinderBridge-<span class="hl-number">0.0</span>.<span class="hl-number">1</span>-SNAPSHOT.jar</pre><p>It is time to create a stream definition with the newly registered processor application.</p><pre class="programlisting">dataflow:&gt;stream create fooRabbitToBarKafka --definition <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">":fooRabbit &gt; multiBinderBridge --spring.cloud.stream.bindings.input.binder=rabbit1 --spring.cloud.stream.bindings.output.binder=kafka1 &gt; :barKafka"</span> --deploy</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Since we are to consume messages from RabbitMQ <span class="emphasis"><em>(i.e., identified by <code class="literal">rabbit1</code>)</em></span> and then
publish the payload to Apache Kafka <span class="emphasis"><em>(i.e., identified by <code class="literal">kafka1</code>)</em></span>, we are supplying them as <code class="literal">input</code>
and <code class="literal">output</code> channel settings respectively.</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The queue <code class="literal">fooRabbit</code> in RabbitMQ is where the stream is consuming events from and the topic
<code class="literal">barKafka</code> in Apache Kafka is where the data is finally landing.</p></td></tr></table></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="_logging.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="howto.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="appendix.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">51.&nbsp;Logging&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Part&nbsp;IX.&nbsp;Appendices</td></tr></table></div></body></html>