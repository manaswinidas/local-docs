<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>23.&nbsp;Register a Stream App</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Cloud Data Flow for Apache YARN"><link rel="up" href="streams.html" title="Part&nbsp;V.&nbsp;Streams"><link rel="prev" href="_stream_dsl.html" title="22.&nbsp;Stream DSL"><link rel="next" href="custom-applications.html" title="24.&nbsp;Creating custom applications"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">23.&nbsp;Register a Stream App</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="_stream_dsl.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;V.&nbsp;Streams</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="custom-applications.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="spring-cloud-dataflow-register-apps" href="#spring-cloud-dataflow-register-apps"></a>23.&nbsp;Register a Stream App</h2></div></div></div><p>Register a Stream App with the App Registry using the Spring Cloud Data Flow Shell
<code class="literal">app register</code> command. You must provide a unique name, application type, and a URI that can be
resolved to the app artifact. For the type, specify "source", "processor", or "sink".
Here are a few examples:</p><pre class="screen">dataflow:&gt;app register --name mysource --type source --uri maven://com.example:mysource:0.0.1-SNAPSHOT

dataflow:&gt;app register --name myprocessor --type processor --uri file:///Users/example/myprocessor-1.2.3.jar

dataflow:&gt;app register --name mysink --type sink --uri http://example.com/mysink-2.0.1.jar</pre><p>When providing a URI with the <code class="literal">maven</code> scheme, the format should conform to the following:</p><pre class="screen">maven://&lt;groupId&gt;:&lt;artifactId&gt;[:&lt;extension&gt;[:&lt;classifier&gt;]]:&lt;version&gt;</pre><p>For example, if you would like to register the snapshot versions of the <code class="literal">http</code> and <code class="literal">log</code>
applications built with the RabbitMQ binder, you could do the following:</p><pre class="screen">dataflow:&gt;app register --name http --type source --uri maven://org.springframework.cloud.stream.app:http-source-rabbit:1.2.1.BUILD-SNAPSHOT
dataflow:&gt;app register --name log --type sink --uri maven://org.springframework.cloud.stream.app:log-sink-rabbit:1.2.1.BUILD-SNAPSHOT</pre><p>If you would like to register multiple apps at one time, you can store them in a properties file
where the keys are formatted as <code class="literal">&lt;type&gt;.&lt;name&gt;</code> and the values are the URIs.</p><p>For example, if you would like to register the snapshot versions of the <code class="literal">http</code> and <code class="literal">log</code>
applications built with the RabbitMQ binder, you could have the following in a properties file [<span class="emphasis"><em>eg: stream-apps.properties</em></span>]:</p><pre class="screen">source.http=maven://org.springframework.cloud.stream.app:http-source-rabbit:1.2.1.BUILD-SNAPSHOT
sink.log=maven://org.springframework.cloud.stream.app:log-sink-rabbit:1.2.1.BUILD-SNAPSHOT</pre><p>Then to import the apps in bulk, use the <code class="literal">app import</code> command and provide the location of the properties file via <code class="literal">--uri</code>:</p><pre class="screen">dataflow:&gt;app import --uri file:///&lt;YOUR_FILE_LOCATION&gt;/stream-apps.properties</pre><p>For convenience, we have the static files with application-URIs (for both maven and docker) available
for all the out-of-the-box stream and task/batch app-starters. You can point to this file and import
all the application-URIs in bulk. Otherwise, as explained in previous paragraphs, you can register them individually or have your own custom property file with only the required application-URIs in it. It is recommended, however, to have a "focused" list of desired application-URIs in a custom property file.</p><p>List of available Stream Application Starters:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; " width="100%"><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Artifact Type</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Stable Release</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">SNAPSHOT Release</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>RabbitMQ + Maven</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Bacon-RELEASE-stream-applications-rabbit-maven" target="_top">bit.ly/Bacon-RELEASE-stream-applications-rabbit-maven</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Bacon-BUILD-SNAPSHOT-stream-applications-rabbit-maven" target="_top">bit.ly/Bacon-BUILD-SNAPSHOT-stream-applications-rabbit-maven</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>RabbitMQ + Docker</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Bacon-RELEASE-stream-applications-rabbit-docker" target="_top">bit.ly/Bacon-RELEASE-stream-applications-rabbit-docker</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N/A</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Kafka 0.9 + Maven</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Bacon-RELEASE-stream-applications-kafka-09-maven" target="_top">bit.ly/Bacon-RELEASE-stream-applications-kafka-09-maven</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Bacon-BUILD-SNAPSHOT-stream-applications-kafka-09-maven" target="_top">bit.ly/Bacon-BUILD-SNAPSHOT-stream-applications-kafka-09-maven</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Kafka 0.9 + Docker</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Bacon-RELEASE-stream-applications-kafka-09-docker" target="_top">bit.ly/Bacon-RELEASE-stream-applications-kafka-09-docker</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N/A</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Kafka 0.10 + Maven</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Bacon-RELEASE-stream-applications-kafka-10-maven" target="_top">bit.ly/Bacon-RELEASE-stream-applications-kafka-10-maven</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Bacon-BUILD-SNAPSHOT-stream-applications-kafka-10-maven" target="_top">bit.ly/Bacon-BUILD-SNAPSHOT-stream-applications-kafka-10-maven</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Kafka 0.10 + Docker</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Bacon-RELEASE-stream-applications-kafka-10-docker" target="_top">bit.ly/Bacon-RELEASE-stream-applications-kafka-10-docker</a></p></td><td style="" align="left" valign="top"><p>N/A</p></td></tr></tbody></table></div><p>List of available Task Application Starters:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; " width="100%"><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Artifact Type</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Stable Release</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">SNAPSHOT Release</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Maven</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Belmont-GA-task-applications-maven" target="_top">bit.ly/Belmont-GA-task-applications-maven</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Belmont-BUILD-SNAPSHOT-task-applications-maven" target="_top">bit.ly/Belmont-BUILD-SNAPSHOT-task-applications-maven</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Docker</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Belmont-GA-task-applications-docker" target="_top">bit.ly/Belmont-GA-task-applications-docker</a></p></td><td style="" align="left" valign="top"><p>N/A</p></td></tr></tbody></table></div><p>You can find more information about the available task starters in the <a class="link" href="http://cloud.spring.io/spring-cloud-task-app-starters/" target="_top">Task App Starters Project Page</a> and
related reference documentation.  For more information about the available stream starters look at the <a class="link" href="http://cloud.spring.io/spring-cloud-stream-app-starters/" target="_top">Stream App Starters Project Page</a>
and related reference documentation.</p><p>As an example, if you would like to register all out-of-the-box stream applications built with the RabbitMQ binder in bulk, you can with
the following command.</p><pre class="screen">dataflow:&gt;app import --uri http://bit.ly/Bacon-RELEASE-stream-applications-rabbit-maven</pre><p>You can also pass the <code class="literal">--local</code> option (which is <code class="literal">true</code> by default) to indicate whether the
properties file location should be resolved within the shell process itself. If the location should
be resolved from the Data Flow Server process, specify <code class="literal">--local false</code>.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>When using either <code class="literal">app register</code> or <code class="literal">app import</code>, if an app is already registered with
the provided name and type, it will not be overridden by default. If you would like to override the
pre-existing app coordinates, then include the <code class="literal">--force</code> option.</p><p>Note however that once downloaded, applications may be cached locally on the Data Flow server, based on the resource
location. If the resource location doesn&#8217;t change (even though the actual resource <span class="emphasis"><em>bytes</em></span> may be different), then it
won&#8217;t be re-downloaded. When using <code class="literal">maven://</code> resources on the other hand, using a constant location still may circumvent
caching (if using <code class="literal">-SNAPSHOT</code> versions).</p><p>Moreover, if a stream is already deployed and using some version of a registered app, then (forcibly) re-registering a
different app will have no effect until the stream is deployed anew.</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>In some cases the Resource is resolved on the server side, whereas in others the
URI will be passed to a runtime container instance where it is resolved. Consult
the specific documentation of each Data Flow Server for more detail.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-cloud-dataflow-stream-app-whitelisting" href="#spring-cloud-dataflow-stream-app-whitelisting"></a>23.1&nbsp;Whitelisting application properties</h2></div></div></div><p>Stream and Task applications are Spring Boot applications which are aware of many <a class="xref" href="spring-cloud-dataflow-create-stream.html#spring-cloud-dataflow-global-properties" title="25.3&nbsp;Common application properties">Section&nbsp;25.3, &#8220;Common application properties&#8221;</a>, e.g. <code class="literal">server.port</code> but also families of properties such as those with the prefix <code class="literal">spring.jmx</code> and <code class="literal">logging</code>.  When creating your own application it is desirable to whitelist properties so that the shell and the UI can display them first as primary properties when presenting options via TAB completion or in drop-down boxes.</p><p>To whitelist application properties create a file named <code class="literal">spring-configuration-metadata-whitelist.properties</code> in the <code class="literal">META-INF</code> resource directory.  There are two property keys that can be used inside this file. The first key is named <code class="literal">configuration-properties.classes</code>.  The value is a comma separated list of fully qualified <code class="literal">@ConfigurationProperty</code> class names.  The second key is <code class="literal">configuration-properties.names</code> whose value is a comma separated list of property names.  This can contain the full name of property, such as <code class="literal">server.port</code> or a partial name to whitelist a category of property names, e.g. <code class="literal">spring.jmx</code>.</p><p>The <a class="link" href="https://github.com/spring-cloud-stream-app-starters" target="_top">Spring Cloud Stream application starters</a> are a good place to look for examples of usage.  Here is a simple example of the file sink&#8217;s <code class="literal">spring-configuration-metadata-whitelist.properties</code> file</p><pre class="screen">configuration-properties.classes=org.springframework.cloud.stream.app.file.sink.FileSinkProperties</pre><p>If we also wanted to add <code class="literal">server.port</code> to be white listed, then it would look like this:</p><pre class="screen">configuration-properties.classes=org.springframework.cloud.stream.app.file.sink.FileSinkProperties
configuration-properties.names=server.port</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Make sure to add 'spring-boot-configuration-processor' as an optional dependency to generate configuration metadata file for the properties.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.boot<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-boot-configuration-processor<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;optional&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/optional&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-cloud-dataflow-stream-app-metadata-artifact" href="#spring-cloud-dataflow-stream-app-metadata-artifact"></a>23.2&nbsp;Creating and using a dedicated metadata artifact</h2></div></div></div><p>You can go a step further in the process of describing the main properties that your stream or task app supports by
creating a so-called metadata companion artifact. This simple jar file contains only the Spring boot JSON file about
configuration properties metadata, as well as the whitelisting file described in the previous section.</p><p>Here is the contents of such an artifact, for the canonical <code class="literal">log</code> sink:</p><pre class="programlisting">$ jar tvf log-sink-rabbit-<span class="hl-number">1.2</span>.<span class="hl-number">1.</span>BUILD-SNAPSHOT-metadata.jar
<span class="hl-number">373848</span> META-INF/spring-configuration-metadata.json
   <span class="hl-number">174</span> META-INF/spring-configuration-metadata-whitelist.properties</pre><p>Note that the <code class="literal">spring-configuration-metadata.json</code> file is quite large. This is because it contains the concatenation of <span class="emphasis"><em>all</em></span> the properties that
are available at runtime to the <code class="literal">log</code> sink (some of them come from <code class="literal">spring-boot-actuator.jar</code>, some of them come from
<code class="literal">spring-boot-autoconfigure.jar</code>, even some more from <code class="literal">spring-cloud-starter-stream-sink-log.jar</code>, <span class="emphasis"><em>etc.</em></span>) Data Flow
always relies on all those properties, even when a companion artifact is not available, but here all have been merged
into a single file.</p><p>To help with that (as a matter of fact, you don&#8217;t want to try to craft this giant JSON file by hand), you can use the
following plugin in your build:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
 	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
 	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-app-starter-metadata-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
 	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;executions&gt;</span>
 		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;execution&gt;</span>
 			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>aggregate-metadata<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
 			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;phase&gt;</span>compile<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/phase&gt;</span>
 			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;goals&gt;</span>
 				<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;goal&gt;</span>aggregate-metadata<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/goal&gt;</span>
 			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/goals&gt;</span>
 		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/execution&gt;</span>
 	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/executions&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This plugin comes in <span class="emphasis"><em>addition</em></span> to the <code class="literal">spring-boot-configuration-processor</code> that creates the individual JSON files.
Be sure to configure the two!</p></td></tr></table></div><p>The benefits of a companion artifact are manifold:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">being way lighter (usually a few kilobytes, as opposed to megabytes for the actual app), they are quicker to download,
allowing quicker feedback when using <span class="emphasis"><em>e.g.</em></span> <code class="literal">app info</code> or the Dashboard UI</li><li class="listitem">as a consequence of the above, they can be used in resource constrained environments (such as PaaS) when metadata is
the only piece of information needed</li><li class="listitem">finally, for environments that don&#8217;t deal with boot uberjars directly (for example, Docker-based runtimes such as
Kubernetes or Mesos), this is the only way to provide metadata about the properties supported by the app.</li></ol></div><p>Remember though, that this is entirely optional when dealing with uberjars. The uberjar itself <span class="emphasis"><em>also</em></span> includes the
metadata in it already.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_companion_artifact" href="#_using_the_companion_artifact"></a>23.2.1&nbsp;Using the companion artifact</h3></div></div></div><p>Once you have a companion artifact at hand, you need to make the system aware of it so that it can be used.</p><p>When registering a single app <span class="emphasis"><em>via</em></span> <code class="literal">app register</code>, you can use the optional <code class="literal">--metadata-uri</code> option in the shell, like so:</p><pre class="screen">dataflow:&gt;app register --name log --type sink
    --uri maven://org.springframework.cloud.stream.app:log-sink-kafka-10:1.2.1.BUILD-SNAPSHOT
    --metadata-uri=maven://org.springframework.cloud.stream.app:log-sink-kafka-10:jar:metadata:1.2.1.BUILD-SNAPSHOT</pre><p>When registering several files using the <code class="literal">app import</code> command, the file should contain a <code class="literal">&lt;type&gt;.&lt;name&gt;.metadata</code> line
in addition to each <code class="literal">&lt;type&gt;.&lt;name&gt;</code> line. This is optional (<span class="emphasis"><em>i.e.</em></span> if some apps have it but some others don&#8217;t, that&#8217;s fine).</p><p>Here is an example for a Dockerized app, where the metadata artifact is being hosted in a Maven repository (but retrieving
it <span class="emphasis"><em>via</em></span> <code class="literal">http://</code> or <code class="literal">file://</code> would be equally possible).</p><pre class="programlisting">...
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">source.http</span>=docker:springcloudstream/http-source-rabbit:latest
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">source.http.metadata</span>=maven://org.springframework.cloud.stream.app:http-source-rabbit:jar:metadata:1.2.1.BUILD-SNAPSHOT
...</pre></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="_stream_dsl.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="streams.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="custom-applications.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">22.&nbsp;Stream DSL&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;24.&nbsp;Creating custom applications</td></tr></table></div></body></html>