<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>37.&nbsp;The Lifecycle of a task</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Cloud Data Flow for Apache YARN"><link rel="up" href="spring-cloud-task.html" title="Part&nbsp;VI.&nbsp;Tasks"><link rel="prev" href="spring-cloud-dataflow-task-intro.html" title="36.&nbsp;Introducing Spring Cloud Task"><link rel="next" href="spring-cloud-dataflow-task-repository.html" title="38.&nbsp;Task Repository"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">37.&nbsp;The Lifecycle of a task</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="spring-cloud-dataflow-task-intro.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;VI.&nbsp;Tasks</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="spring-cloud-dataflow-task-repository.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_the_lifecycle_of_a_task" href="#_the_lifecycle_of_a_task"></a>37.&nbsp;The Lifecycle of a task</h2></div></div></div><p>Before we dive deeper into the details of creating Tasks, we need to understand the
typical lifecycle for tasks in the context of Spring Cloud Data Flow:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Register a Task App</li><li class="listitem">Create a Task Definition</li><li class="listitem">Launch a Task</li><li class="listitem">Task Execution</li><li class="listitem">Destroy a Task Definition</li></ol></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_creating_a_custom_task_application" href="#_creating_a_custom_task_application"></a>37.1&nbsp;Creating a custom Task Application</h2></div></div></div><p>While Spring Cloud Task does provide a number of out of the box applications (via the
<a class="link" href="https://github.com/spring-cloud-task-app-starters" target="_top">spring-cloud-task-app-starters</a>),
most task applications will be custom developed.  In order to create a custom task application:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">Create a new project via <a class="link" href="http://start.spring.io" target="_top">Spring Initializer</a> via either the
website or your IDE making sure to select the following starters:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><code class="literal">Cloud Task</code> - This dependency is the <code class="literal">spring-cloud-starter-task</code>.</li><li class="listitem"><code class="literal">JDBC</code> - This is the dependency for the <code class="literal">spring-jdbc</code> starter.</li></ol></div></li><li class="listitem">Within your new project, create a new class that will serve as your main class:</li></ol></div><pre class="screen">@EnableTask
@SpringBootApplication
public class MyTask {

    public static void main(String[] args) {
		SpringApplication.run(MyTask.class, args);
	}
}</pre><div class="orderedlist"><ol class="orderedlist" start="3" type="1"><li class="listitem">With this, you&#8217;ll need one or more <code class="literal">CommandLineRunner</code> or <code class="literal">ApplicationRunner</code> within
your application.  You can either implement your own or use the ones provided by Spring
Boot (there is one for running batch jobs for example).</li><li class="listitem">Packaging your application up via Spring Boot into an &uuml;ber jar is done via the standard
Boot conventions.</li><li class="listitem">The packaged application can be registered and deployed as noted below.</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_registering_a_task_application" href="#_registering_a_task_application"></a>37.2&nbsp;Registering a Task Application</h2></div></div></div><p>Register a Task App with the App Registry using the Spring Cloud Data Flow Shell
<code class="literal">app register</code> command. You must provide a unique name and a URI that can be
resolved to the app artifact. For the type, specify "task". Here are a few examples:</p><pre class="screen">dataflow:&gt;app register --name task1 --type task --uri maven://com.example:mytask:1.0.2

dataflow:&gt;app register --name task2 --type task --uri file:///Users/example/mytask-1.0.2.jar

dataflow:&gt;app register --name task3 --type task --uri http://example.com/mytask-1.0.2.jar</pre><p>When providing a URI with the <code class="literal">maven</code> scheme, the format should conform to the following:</p><pre class="screen">maven://&lt;groupId&gt;:&lt;artifactId&gt;[:&lt;extension&gt;[:&lt;classifier&gt;]]:&lt;version&gt;</pre><p>If you would like to register multiple apps at one time, you can store them in a properties file
where the keys are formatted as <code class="literal">&lt;type&gt;.&lt;name&gt;</code> and the values are the URIs. For example, this
would be a valid properties file:</p><pre class="screen">task.foo=file:///tmp/foo.jar
task.bar=file:///tmp/bar.jar</pre><p>Then use the <code class="literal">app import</code> command and provide the location of the properties file via <code class="literal">--uri</code>:</p><pre class="screen">app import --uri file:///tmp/task-apps.properties</pre><p>For convenience, we have the static files with application-URIs (for both maven and docker) available for all the out-of-the-box
Task app-starters. You can point to this file and import all the application-URIs in bulk. Otherwise, as explained in
previous paragraphs, you can register them individually or have your own custom property file with only the required application-URIs
in it. It is recommended, however, to have a "focused" list of desired application-URIs in a custom property file.</p><p>List of available static property files:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; " width="100%"><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Artifact Type</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Stable Release</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">SNAPSHOT Release</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Maven</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Belmont-GA-task-applications-maven" target="_top">http://bit.ly/Belmont-GA-task-applications-maven</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Belmont-BUILD-SNAPSHOT-task-applications-maven" target="_top">http://bit.ly/Belmont-BUILD-SNAPSHOT-task-applications-maven</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Docker</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://bit.ly/Belmont-GA-task-applications-docker" target="_top">http://bit.ly/Belmont-GA-task-applications-docker</a></p></td><td style="" align="left" valign="top"><p><a class="link" href="http://bit.ly/Belmont-BUILD-SNAPSHOT-task-applications-docker" target="_top">http://bit.ly/Belmont-BUILD-SNAPSHOT-task-applications-docker</a></p></td></tr></tbody></table></div><p>For example, if you would like to register all out-of-the-box task applications in bulk, you can with
the following command.</p><pre class="screen">dataflow:&gt;app import --uri http://bit.ly/Belmont-GA-task-applications-maven</pre><p>You can also pass the <code class="literal">--local</code> option (which is TRUE by default) to indicate whether the
properties file location should be resolved within the shell process itself. If the location should
be resolved from the Data Flow Server process, specify <code class="literal">--local false</code>.</p><p>When using either <code class="literal">app register</code> or <code class="literal">app import</code>, if a task app is already registered with
the provided name, it will not be overridden by default. If you would like to override the
pre-existing task app, then include the <code class="literal">--force</code> option.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>In some cases the Resource is resolved on the server side, whereas in others the
URI will be passed to a runtime container instance where it is resolved. Consult
the specific documentation of each Data Flow Server for more detail.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_creating_a_task" href="#_creating_a_task"></a>37.3&nbsp;Creating a Task</h2></div></div></div><p>Create a Task Definition from a Task App by providing a definition name as well as
properties that apply to the task execution.  Creating a task definition can be done via
the restful API or the shell.  To create a task definition using the shell, use the
<code class="literal">task create</code> command to create the task definition.  For example:</p><pre class="screen">dataflow:&gt;task create mytask --definition "timestamp --format=\"yyyy\""
 Created new task 'mytask'</pre><p>A listing of the current task definitions can be obtained via the restful API or the
shell.  To get the task definition list using the shell, use the <code class="literal">task list</code> command.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_launching_a_task" href="#_launching_a_task"></a>37.4&nbsp;Launching a Task</h2></div></div></div><p>An adhoc task can be launched via the restful API or via the shell.  To launch an ad-hoc
task via the shell use the <code class="literal">task launch</code> command.  For example:</p><pre class="screen">dataflow:&gt;task launch mytask
 Launched task 'mytask'</pre><p>When a task is launched, any properties that need to be passed as the command line arguments
to the task application can be set when launching the task as follows:</p><pre class="screen">dataflow:&gt;task launch mytask --arguments "--server.port=8080,--foo=bar"</pre><p>Additional properties meant for a <code class="literal">TaskLauncher</code> itself can be passed
in using a <code class="literal">--properties</code> option. Format of this option is a comma
delimited string of properties prefixed with <code class="literal">app.&lt;task definition
name&gt;.&lt;property&gt;</code>. Properties are passed
to <code class="literal">TaskLauncher</code> as application properties and it is up to an
implementation to choose how those are passed into an actual task
application. If the property is prefixed with <code class="literal">deployer</code> instead of <code class="literal">app</code> it is
passed to <code class="literal">TaskLauncher</code> as a deployment property and its meaning may
be <code class="literal">TaskLauncher</code> implementation specific.</p><pre class="screen">dataflow:&gt;task launch mytask --properties "deployer.timestamp.foo1=bar1,app.timestamp.foo2=bar2"</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_common_application_properties" href="#_common_application_properties"></a>37.4.1&nbsp;Common application properties</h3></div></div></div><p>In addition to configuration via DSL, Spring Cloud Data Flow provides a mechanism for setting common properties to all
the task applications that are launched by it.
This can be done by adding properties prefixed with <code class="literal">spring.cloud.dataflow.applicationProperties.task</code> when starting the server.
When doing so, the server will pass all the properties, without the prefix, to the instances it launches.</p><p>For example, all the launched applications can be configured to use the properties <code class="literal">foo</code> and <code class="literal">fizz</code> by launching the Data Flow server
with the following options:</p><pre class="screen">--spring.cloud.dataflow.applicationProperties.task.foo=bar
--spring.cloud.dataflow.applicationProperties.task.fizz=bar2</pre><p>This will cause the properties <code class="literal">foo=bar</code> and <code class="literal">fizz=bar2</code> to be passed to all the launched applications.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Properties configured using this mechanism have lower precedence than task deployment properties.
They will be overridden if a property with the same key is specified at task launch time (e.g. <code class="literal">app.trigger.fizz</code>
will override the common property).</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_reviewing_task_executions" href="#_reviewing_task_executions"></a>37.5&nbsp;Reviewing Task Executions</h2></div></div></div><p>Once the task is launched the state of the task is stored in a relational DB.  The state
includes:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Task Name</li><li class="listitem">Start Time</li><li class="listitem">End Time</li><li class="listitem">Exit Code</li><li class="listitem">Exit Message</li><li class="listitem">Last Updated Time</li><li class="listitem">Parameters</li></ul></div><p>A user can check the status of their task executions via the restful API or by the shell.
To display the latest task executions via the shell use the <code class="literal">task execution list</code> command.</p><p>To get a list of task executions for just one task definition, add <code class="literal">--name</code> and
the task definition name, for example <code class="literal">task execution list --name foo</code>.  To retrieve full
details for a task execution use the <code class="literal">task display</code> command with the id of the task execution,
for example <code class="literal">task display --id 549</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_destroying_a_task" href="#_destroying_a_task"></a>37.6&nbsp;Destroying a Task</h2></div></div></div><p>Destroying a Task Definition will remove the definition from the definition repository.
This can be done via the restful API or via the shell.  To destroy a task via the shell
use the <code class="literal">task destroy</code> command. For example:</p><pre class="screen">dataflow:&gt;task destroy mytask
 Destroyed task 'mytask'</pre><p>The task execution information for previously launched tasks for the definition will
remain in the task repository.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This will not stop any currently executing tasks for this definition, instead it just
removes the task definition from the database.</p></td></tr></table></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="spring-cloud-dataflow-task-intro.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="spring-cloud-task.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="spring-cloud-dataflow-task-repository.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">36.&nbsp;Introducing Spring Cloud Task&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;38.&nbsp;Task Repository</td></tr></table></div></body></html>