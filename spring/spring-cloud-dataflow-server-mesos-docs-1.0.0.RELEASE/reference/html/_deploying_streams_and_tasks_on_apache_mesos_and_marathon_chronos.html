<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>13.&nbsp;Deploying Streams and Tasks on Apache Mesos and Marathon/Chronos</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Cloud Data Flow Server for Apache Mesos"><link rel="up" href="_getting_started.html" title="Part&nbsp;III.&nbsp;Getting Started"><link rel="prev" href="_getting_started.html" title="Part&nbsp;III.&nbsp;Getting Started"><link rel="next" href="streams.html" title="Part&nbsp;IV.&nbsp;Streams"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">13.&nbsp;Deploying Streams and Tasks on Apache Mesos and Marathon/Chronos</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="_getting_started.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;III.&nbsp;Getting Started</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="streams.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_deploying_streams_and_tasks_on_apache_mesos_and_marathon_chronos" href="#_deploying_streams_and_tasks_on_apache_mesos_and_marathon_chronos"></a>13.&nbsp;Deploying Streams and Tasks on Apache Mesos and Marathon/Chronos</h2></div></div></div><p>In this getting started the Data Flow Server is running as a Docker container in Marathon and so are all the dependent services like a relational database for stream and task repositories, a message bus for stream apps and the key value store for analytics.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">Deploy a Mesos and Marathon cluster.</p><p class="simpara">The <a class="link" href="https://open.mesosphere.com/getting-started/tools/" target="_top">Mesosphere getting started guide</a> provides a number of options for you to deploy a cluster. There is also a number of options listed on Mesosphere&#8217;s <a class="link" href="https://dcos.io/install/" target="_top">Install DC/OS</a> page. In <a class="xref" href="test-cluster.html" title="Appendix&nbsp;B.&nbsp;Test Cluster">Appendix&nbsp;B, <i>Test Cluster</i></a> we describe how we configured a local test cluster using the DC/OS Vagrant project.</p><p class="simpara">The rest of this getting started guide assumes that you have a working Mesos and Marathon cluster and know the Marathon endpoint URL.</p><p class="simpara">We are using the Marathon endpoint URL of <a class="link" href="http://m1.dcos/service/marathon" target="_top">http://m1.dcos/service/marathon</a> for this document.</p></li><li class="listitem"><p class="simpara">Create a MySQL service on the Mesos cluster.</p><p class="simpara">The <code class="literal">mysql</code> service will be used for storing stream and task definitions in the stream and task repositories.  There is a sample <a class="link" href="https://raw.githubusercontent.com/spring-cloud/spring-cloud-dataflow-server-mesos/v1.0.0.RELEASE/src/etc/marathon/mysql.json" target="_top">application JSON file for MySQL</a> in the <code class="literal">spring-cloud-dataflow-server-mesos</code> repository that you can use as a starting point.  The service discovery mechanism is currently disabled so you need to look up the host and port to use for the connection.  Depending on how large your cluster is, you may want to tweak the CPU and/or memory values.</p><p class="simpara">Using the above JSON file and an Mesos and Marathon cluster installed you can deploy a Rabbit MQ application instance by issuing the following command</p><pre class="screen">curl -X POST http://m1.dcos/service/marathon/v2/apps -d @mysql.json -H "Content-type: application/json"</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Note the <code class="literal">@</code> symbol to reference a file input for the <code class="literal">curl</code> command.</p></td></tr></table></div></li><li class="listitem"><p class="simpara">Create a Rabbit MQ service on the Mesos cluster.</p><p class="simpara">The <code class="literal">rabbitmq</code> service will be used for messaging between applications in the stream.  There is a sample <a class="link" href="https://raw.githubusercontent.com/spring-cloud/spring-cloud-dataflow-server-mesos/v1.0.0.RELEASE/src/etc/marathon/rabbitmq.json" target="_top">application JSON file for Rabbit MQ</a> in the <code class="literal">spring-cloud-dataflow-server-mesos</code> repository that you can use as a starting point.  The service discovery mechanism is currently disabled so you need to look up the host and port to use for the connection.  Depending on how large your cluster is, you may want to tweak the CPU and/or memory values.</p><p class="simpara">Using the above JSON file and an Mesos and Marathon cluster installed you can deploy a Rabbit MQ service instance by issuing the following command</p><pre class="screen">curl -X POST http://m1.dcos/service/marathon/v2/apps -d @rabbitmq.json -H "Content-type: application/json"</pre></li><li class="listitem"><p class="simpara">Create a Redis service on the Mesos cluster.</p><p class="simpara">The <code class="literal">redis</code> service will be used for counters as part of the analytics.  There is a sample <a class="link" href="https://raw.githubusercontent.com/spring-cloud/spring-cloud-dataflow-server-mesos/v1.0.0.RELEASE/src/etc/marathon/redis.json" target="_top">application JSON file for Redis</a> in the <code class="literal">spring-cloud-dataflow-server-mesos</code> repository that you can use as a starting point.  The service discovery mechanism is currently disabled so you need to look up the host and port to use for the connection.  Depending on how large your cluster is, you may want to tweak the CPU and/or memory values.</p><p class="simpara">Using the above JSON file and an Mesos and Marathon cluster installed you can deploy a Redis service instance by issuing the following command</p><pre class="screen">curl -X POST http://m1.dcos/service/marathon/v2/apps -d @redis.json -H "Content-type: application/json"</pre><p class="simpara">Using the Marathon and Mesos UIs you can verify that <code class="literal">mysql</code>, <code class="literal">rabbitmq</code> and <code class="literal">redis</code> services are running on the cluster.</p></li><li class="listitem"><p class="simpara">Install Chronos on the Mesos cluster.</p><p class="simpara">The <a class="link" href="https://mesos.github.io/chronos/" target="_top">Chronos</a> service will be used for running task. If you haven&#8217;t already installed Chronos, this is the time to do it. You can install Chronos using the DC/OS UI (under the Universe section) or from the <code class="literal">dcos</code> command line:</p><pre class="screen">dcos package install chronos</pre></li><li class="listitem"><p class="simpara">Download the Marathon application JSON for the Spring Cloud Data Flow Server.</p><p class="simpara">Use the following command to download the Marathon application JSON file used to deploy Spring CLoud Data Flow Server for Mesos.</p><pre class="screen">$ wget https://raw.githubusercontent.com/spring-cloud/spring-cloud-dataflow-server-mesos/v1.0.0.RELEASE/src/etc/marathon/scdf-server.json</pre><p class="simpara">We will need to modify the Docker image tag, API endpoints and host and port settings based on the current deployment environment. We hope to eliminiate most of this in future releases and instead rely on service discovery mechanisms. For now we do have to make the modifications manually. The downloaded file should look like this:</p><pre class="screen">{
  "id": "/spring-cloud-data-flow",
  "cpus": 0.5,
  "mem": 512.0,
  "instances": 1,
  "container": {
    "type": "DOCKER",
    "docker": {
      "image": "springcloud/spring-cloud-dataflow-server-mesos",
      "network": "BRIDGE",
      "portMappings": [
        { "containerPort": 9393 }
      ]
    }
  },
  "env": {
    "MESOS_MARATHON_URI": "http://m1.dcos/service/marathon",
    "MESOS_CHRONOS_URI": "http://m1.dcos/service/chronos",
    "JDBC_URL": "jdbc:mysql://192.168.65.111:5769/test",
    "JDBC_DRIVER": "org.mariadb.jdbc.Driver",
    "JDBC_USERNAME": "spring",
    "JDBC_PASSWORD": "secret",
    "RABBITMQ_HOST": "192.168.65.121",
    "RABBITMQ_PORT": "5261",
    "REDIS_HOST": "192.168.65.111",
    "REDIS_PORT": "19902",
    "SPRING_APPLICATION_JSON": "{\"spring.cloud.deployer.mesos.marathon.apiEndpoint\":\"${MESOS_MARATHON_URI}\",\"spring.cloud.deployer.mesos.chronos.apiEndpoint\":\"${MESOS_CHRONOS_URI}\",\"spring.datasource.url\":\"${JDBC_URL}\",\"spring.datasource.driverClassName\":\"${JDBC_DRIVER}\",\"spring.datasource.username\":\"${JDBC_USERNAME}\",\"spring.datasource.password\":\"${JDBC_PASSWORD}\",\"spring.datasource.testOnBorrow\":true,\"spring.datasource.validationQuery\":\"SELECT 1\",\"spring.redis.host\":\"${REDIS_HOST}\",\"spring.redis.port\":\"${REDIS_PORT}\",\"spring.cloud.deployer.mesos.marathon.environmentVariables\":\"SPRING_RABBITMQ_HOST=${RABBITMQ_HOST},SPRING_RABBITMQ_PORT=${RABBITMQ_PORT}\"}"
  },
  "healthChecks": [
    {
      "path": "/management/health",
      "portIndex": 0,
      "protocol": "HTTP",
      "ignoreHttp1xx": false,
      "gracePeriodSeconds": 120,
      "intervalSeconds": 60,
      "timeoutSeconds": 20,
      "maxConsecutiveFailures": 0
    }
  ]
}</pre><p class="simpara">First we need to modify the Docker image to use the tag <code class="literal">1.0.0.RELEASE</code>. It should be:</p><pre class="screen">    "image": "springcloud/spring-cloud-dataflow-server-mesos:1.0.0.RELEASE",</pre><p class="simpara">In the <code class="literal">env</code> section there are several environment variables that we need to adjust. We need to provide the following properties for accessing Marathon and Chronos APIs:</p><pre class="screen">    "MESOS_MARATHON_URI": "http://m1.dcos/service/marathon",
    "MESOS_CHRONOS_URI": "http://m1.dcos/service/chronos",</pre><p class="simpara">Here we did set them to the defaults for a local Vagrant DC/OS installation.</p><p class="simpara">&nbsp;</p><p class="simpara">We also need to provide the database configuration properties. Look up the database host and port from the Marathon UI. For the <code class="literal">mysql</code> service that we just installed, they were <code class="literal">192.168.65.111:5769</code>.</p><pre class="screen">    "JDBC_URL": "jdbc:mysql://192.168.65.111:5769/test",
    "JDBC_DRIVER": "org.mariadb.jdbc.Driver",
    "JDBC_USERNAME": "spring",
    "JDBC_PASSWORD": "secret",</pre><p class="simpara">Next, we need to provide the message bus configuration properties. Look up the host and port for the <code class="literal">rabbitmq</code> service. In our case they were <code class="literal">192.168.65.121:5261</code>.</p><pre class="screen">    "RABBITMQ_HOST": "192.168.65.121",
    "RABBITMQ_PORT": "5261",</pre><p class="simpara">Finally we need to do the same for the key value store properties. Look up the host and port for the <code class="literal">redis</code> service. In our case they were <code class="literal">192.168.65.111:19902</code>.</p><pre class="screen">    "REDIS_HOST": "192.168.65.111",
    "REDIS_PORT": "19902",</pre><p class="simpara">You can add properties to the <code class="literal">SPRING_APPLICATION_JSON</code> property as well. You might want to set default values for memory and cpu resource request.  For example <code class="literal">\"spring.cloud.deployer.mesos.marathon.memory\"=\"768\"</code> will by default allocate additional memory for the application vs. the default value of 512.  You can see all the available options in the <a class="link" href="https://raw.githubusercontent.com/spring-cloud/spring-cloud-deployer-mesos/v1.0.4.RELEASE/src/main/java/org/springframework/cloud/deployer/spi/mesos/marathon/MarathonAppDeployerProperties.java" target="_top">MarathonAppDeployerProperties.java</a> file.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>DC/OS in secured mode requires an Authorization header with a token when accessing the Marathon and Chronos REST end-points. To accommodate this you need to provide this token when deploying the Spring Cloud Data Flow server to a DC/OS secured cluster. See below for instructions.</p></td></tr></table></div><p class="simpara">If you are using a secured DC/OS cluster then you will need to add the authorization token to the above configuration. First, log in using <code class="literal">dcos auth login</code> command and enter the authentication token you get after authenticating with DC/OS web interface with the provided link. Next, run the <code class="literal">dcos config show core.dcos_acs_token</code> command to display the authorization token we need for our configuration. Copy and paste this token in the following environment variable that you add to the above application JSON:</p><pre class="screen">    "DCOS_TOKEN": "&lt;paste the token here&gt;",</pre><p class="simpara">We also need to add the <code class="literal">spring.cloud.deployer.mesos.dcos.authorizationToken</code> property to the <code class="literal">SPRING_APPLICATION_JSON</code> entry. Insert the following as another property entry:</p><pre class="screen">,\"spring.cloud.deployer.mesos.dcos.authorizationToken\":\"${DCOS_TOKEN}\"</pre></li><li class="listitem"><p class="simpara">Now, deploy the Spring Cloud Data Flow Server for Mesos and Marathon/Chronos using the above modified application JSON.</p><pre class="screen">curl -X POST http://m1.dcos/service/marathon/v2/apps -d @scdf-server.json -H "Content-type: application/json"</pre><p class="simpara">Verify that the <code class="literal">spring-cloud-data-flow</code> application is running before proceeding.</p></li><li class="listitem"><p class="simpara">Download and run the Spring Cloud Data Flow shell.</p><pre class="screen">$ wget http://repo.spring.io/release/org/springframework/cloud/spring-cloud-dataflow-shell/1.0.1.RELEASE/spring-cloud-dataflow-shell-1.0.1.RELEASE.jar

$ java -jar spring-cloud-dataflow-shell-1.0.1.RELEASE.jar</pre><p class="simpara">Lookup the host and port for the <code class="literal">spring-cloud-data-flow</code> application in the Marathon UI. Use those values to configure the server URI for the shell:</p><pre class="screen">dataflow:&gt;dataflow config server --uri http://192.168.65.111:20043</pre></li><li class="listitem"><p class="simpara">By default, the application registry will be empty. If you would like to register all out-of-the-box stream applications built with the RabbitMQ binder in bulk, you can with the following command. For more details, review how to <a class="link" href="http://docs.spring.io/spring-cloud-dataflow/docs/1.0.1.RELEASE/reference/html/spring-cloud-dataflow-register-apps.html" target="_top">register applications</a>.</p><pre class="screen">dataflow:&gt;app import --uri http://bit.ly/stream-applications-rabbit-docker</pre></li><li class="listitem"><p class="simpara">Deploy a simple stream in the shell</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If you need to specify any of the app specific configuration properties then you must use "long-form" of them including the app specific prefix like <code class="literal">--jdbc.tableName=TEST_DATA</code>. This is due to the server not being able to access the metadata for the Docker based starter apps. You will also not see the configuration properties listed when using the <code class="literal">app info</code> command or in the Dashboard GUI.</p></td></tr></table></div><pre class="screen">dataflow:&gt;stream create --name ticktock --definition "time | log" --deploy</pre><p class="simpara">In the Mesos UI you can then look at the logs for the log sink. Look for a Mesos task with the name <code class="literal">log-0.log.ticktock</code>.</p><pre class="screen">2016-04-26 18:13:03.001  INFO 1 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat started on port(s): 8080 (http)
2016-04-26 18:13:03.004  INFO 1 --- [           main] o.s.c.s.a.l.s.r.LogSinkRabbitApplication : Started LogSinkRabbitApplication in 7.766 seconds (JVM running for 8.24)
2016-04-26 18:13:54.443  INFO 1 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring FrameworkServlet 'dispatcherServlet'
2016-04-26 18:13:54.445  INFO 1 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : FrameworkServlet 'dispatcherServlet': initialization started
2016-04-26 18:13:54.459  INFO 1 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : FrameworkServlet 'dispatcherServlet': initialization completed in 14 ms
2016-04-26 18:14:09.088  INFO 1 --- [time.ticktock-1] log.sink                                 : 04/26/16 18:14:09
2016-04-26 18:14:10.077  INFO 1 --- [time.ticktock-1] log.sink                                 : 04/26/16 18:14:10
2016-04-26 18:14:11.080  INFO 1 --- [time.ticktock-1] log.sink                                 : 04/26/16 18:14:11
2016-04-26 18:14:12.083  INFO 1 --- [time.ticktock-1] log.sink                                 : 04/26/16 18:14:12
2016-04-26 18:14:13.090  INFO 1 --- [time.ticktock-1] log.sink                                 : 04/26/16 18:14:13
2016-04-26 18:14:14.091  INFO 1 --- [time.ticktock-1] log.sink                                 : 04/26/16 18:14:14
2016-04-26 18:14:15.093  INFO 1 --- [time.ticktock-1] log.sink                                 : 04/26/16 18:14:15
2016-04-26 18:14:16.095  INFO 1 --- [time.ticktock-1] log.sink                                 : 04/26/16 18:14:16</pre></li><li class="listitem"><p class="simpara">Destroy the stream</p><pre class="screen">dataflow:&gt;stream destroy --name ticktock</pre></li><li class="listitem"><p class="simpara">Register a task application using the shell</p><pre class="screen">dataflow:&gt;app register --name timestamp --type task --uri docker:springcloudtask/timestamp-task:latest</pre></li><li class="listitem"><p class="simpara">Create and launch the task using the shell</p><pre class="screen">dataflow:&gt;task create testtask --definition "timestamp"
dataflow:&gt;task launch testtask</pre><p class="simpara">In the Mesos UI you can then look at the logs for the <code class="literal">testtask</code> task. Look for a Mesos task with  the name <code class="literal">ChronosTask:testtask</code>.</p><pre class="screen">Starting task ct:1472062219364:0:testtask:

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::        (v1.3.5.RELEASE)

2016-08-24 18:10:45.957  INFO 1 --- [           main] o.s.c.t.a.t.TimestampTaskApplication     : Starting TimestampTaskApplication v1.0.2.BUILD-SNAPSHOT on a2.dcos with PID 1 (/maven/timestamp-task.jar started by root in /)
2016-08-24 18:10:45.960  INFO 1 --- [           main] o.s.c.t.a.t.TimestampTaskApplication     : No active profile set, falling back to default profiles: default
2016-08-24 18:10:46.003  INFO 1 --- [           main] s.c.a.AnnotationConfigApplicationContext : Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@788c6159: startup date [Wed Aug 24 18:10:46 GMT 2016]; root of context hierarchy
2016-08-24 18:10:47.051  INFO 1 --- [           main] o.s.jdbc.datasource.init.ScriptUtils     : Executing SQL script from class path resource [org/springframework/cloud/task/schema-mysql.sql]
2016-08-24 18:10:47.062  INFO 1 --- [           main] o.s.jdbc.datasource.init.ScriptUtils     : Executed SQL script from class path resource [org/springframework/cloud/task/schema-mysql.sql] in 11 ms.
2016-08-24 18:10:47.207  INFO 1 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup
2016-08-24 18:10:47.211  INFO 1 --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Starting beans in phase 0
2016-08-24 18:10:47.238  INFO 1 --- [           main] TimestampTaskConfiguration$TimestampTask : 2016-08-24 18:10:47.238
2016-08-24 18:10:47.249  INFO 1 --- [           main] s.c.a.AnnotationConfigApplicationContext : Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@788c6159: startup date [Wed Aug 24 18:10:46 GMT 2016]; root of context hierarchy
2016-08-24 18:10:47.250  INFO 1 --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Stopping beans in phase 0
2016-08-24 18:10:47.252  INFO 1 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Unregistering JMX-exposed beans on shutdown
2016-08-24 18:10:47.261  INFO 1 --- [           main] o.s.c.t.a.t.TimestampTaskApplication     : Started TimestampTaskApplication in 1.62 seconds (JVM running for 2.018)```</pre></li><li class="listitem"><p class="simpara">Destroy the task</p><pre class="screen">dataflow:&gt;task destroy --name testtask</pre></li></ol></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="_getting_started.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="_getting_started.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="streams.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Part&nbsp;III.&nbsp;Getting Started&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Part&nbsp;IV.&nbsp;Streams</td></tr></table></div></body></html>