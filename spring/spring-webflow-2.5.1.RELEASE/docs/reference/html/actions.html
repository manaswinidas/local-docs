<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>6.&nbsp;Executing actions</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Web Flow Reference Guide"><link rel="up" href="index.html" title="Spring Web Flow Reference Guide"><link rel="prev" href="views.html" title="5.&nbsp;Rendering views"><link rel="next" href="flow-managed-persistence.html" title="7.&nbsp;Flow Managed Persistence"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6.&nbsp;Executing actions</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="views.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="flow-managed-persistence.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="actions" href="#actions"></a>6.&nbsp;Executing actions</h1></div></div></div>
	
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="actions-introduction" href="#actions-introduction"></a>6.1.&nbsp;Introduction</h2></div></div></div>
		
		<p>
			This chapter shows you how to use the <code class="code">action-state</code> element to control the execution of an action at a point within a flow.
			It will also show how to use the <code class="code">decision-state</code> element to make a flow routing decision.
			Finally, several examples of invoking actions from the various points possible within a flow will be discussed.
		</p>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="action-state" href="#action-state"></a>6.2.&nbsp;Defining action states</h2></div></div></div>
		
		<p>
			Use the <code class="code">action-state</code> element when you wish to invoke an action, then transition to another state based on the action's outcome:
		</p>
		<pre class="programlisting">
<span class="hl-tag">&lt;action-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"moreAnswersNeeded"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"interview.moreAnswersNeeded()"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"yes"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"answerQuestions"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"no"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"finish"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/action-state&gt;</span>
		</pre>
		<p>
			The full example below illustrates a interview flow that uses the action-state above to determine if more answers are needed to complete the interview:
		</p>
		<pre class="programlisting">
<span class="hl-tag">&lt;flow</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/webflow"</span>
	  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
	  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/webflow
						  http://www.springframework.org/schema/webflow/spring-webflow.xsd"</span><span class="hl-tag">&gt;</span>

	<span class="hl-tag">&lt;on-start&gt;</span>
		<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"interviewFactory.createInterview()"</span> <span class="hl-attribute">result</span>=<span class="hl-value">"flowScope.interview"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/on-start&gt;</span>

	<span class="hl-tag">&lt;view-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"answerQuestions"</span> <span class="hl-attribute">model</span>=<span class="hl-value">"questionSet"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;on-entry&gt;</span>
			<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"interview.getNextQuestionSet()"</span> <span class="hl-attribute">result</span>=<span class="hl-value">"viewScope.questionSet"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;/on-entry&gt;</span>
		<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"submitAnswers"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"moreAnswersNeeded"</span><span class="hl-tag">&gt;</span>
			<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"interview.recordAnswers(questionSet)"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;/transition&gt;</span>
	<span class="hl-tag">&lt;/view-state&gt;</span>

	<span class="hl-tag">&lt;action-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"moreAnswersNeeded"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"interview.moreAnswersNeeded()"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"yes"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"answerQuestions"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"no"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"finish"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/action-state&gt;</span>

	<span class="hl-tag">&lt;end-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"finish"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;/flow&gt;</span>
			</pre>
		<p>
			After the execution of each action, the action-state checks the result to see if matches a declared
			transition to another state. That means if more than one action is configured they are executed in
			an ordered chain until one returns a result event that matches a state transition out of the
			action-state while the rest are ignored. This is a form of the Chain of Responsibility (CoR) pattern.
		</p>
		<p>
			The result of an action's execution is typically the criteria for a transition out of this state.
			Additional information in the current RequestContext may also be tested as part of custom
			transitional criteria allowing for sophisticated transition expressions that reason on contextual
			state.
		</p>
		<p>
			Note also that an action-state just like any other state can have one more on-entry actions
			that are executed as a list from start to end.
		</p>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="decision-state" href="#decision-state"></a>6.3.&nbsp;Defining decision states</h2></div></div></div>
		
		<p>
			Use the <code class="code">decision-state</code> element as an alternative to the action-state to make a routing decision using a convenient if/else syntax.
			The example below shows the <code class="code">moreAnswersNeeded</code> state above now implemented as a decision state instead of an action-state:
		</p>
		<pre class="programlisting">
<span class="hl-tag">&lt;decision-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"moreAnswersNeeded"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;if</span> <span class="hl-attribute">test</span>=<span class="hl-value">"interview.moreAnswersNeeded()"</span> <span class="hl-attribute">then</span>=<span class="hl-value">"answerQuestions"</span> <span class="hl-attribute">else</span>=<span class="hl-value">"finish"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/decision-state&gt;</span>
			</pre>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="action-outcome-events" href="#action-outcome-events"></a>6.4.&nbsp;Action outcome event mappings</h2></div></div></div>
		
		<p>
			Actions often invoke methods on plain Java objects.
			When called from action-states and decision-states, these method return values can be used to drive state transitions.
			Since transitions are triggered by events, a method return value must first be mapped to an Event object.
			The following table describes how common return value types are mapped to Event objects:
		</p>
		<div class="table"><a name="event-mapping-table" href="#event-mapping-table"></a><p class="title"><b>Table&nbsp;6.1.&nbsp;Action method return value to event id mappings</b></p><div class="table-contents">
			
			<table summary="Action method return value to event id mappings" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="Method return type"><col class="Event identifier"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Method return type</th><th style="border-bottom: 0.5pt solid ; ">Mapped Event identifier expression</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">java.lang.String</td><td style="border-bottom: 0.5pt solid ; ">the String value</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">java.lang.Boolean</td><td style="border-bottom: 0.5pt solid ; ">yes (for true), no (for false)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">java.lang.Enum</td><td style="border-bottom: 0.5pt solid ; ">the Enum name</td></tr><tr><td style="border-right: 0.5pt solid ; ">any other type</td><td style="">success</td></tr></tbody></table>
		</div></div><br class="table-break">
		<p>
			This is illustrated in the example action state below, which invokes a method that returns a boolean value:
		</p>
		<pre class="programlisting">
<span class="hl-tag">&lt;action-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"moreAnswersNeeded"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"interview.moreAnswersNeeded()"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"yes"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"answerQuestions"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"no"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"finish"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/action-state&gt;</span>
		</pre>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="action-implementations" href="#action-implementations"></a>6.5.&nbsp;Action implementations</h2></div></div></div>
		
		<p>
			While writing action code as POJO logic is the most common, there are several other action implementation options.
			Sometimes you need to write action code that needs access to the flow context.
			You can always invoke a POJO and pass it the flowRequestContext as an EL variable.
			Alternatively, you may implement the <code class="code">Action</code> interface or extend from the <code class="code">MultiAction</code> base class.
			These options provide stronger type safety when you have a natural coupling between your action code and Spring Web Flow APIs.
			Examples of each of these approaches are shown below.
		</p>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1045" href="#d5e1045"></a>6.5.1.&nbsp;Invoking a POJO action</h3></div></div></div>
			
			<pre class="programlisting">
<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"pojoAction.method(flowRequestContext)"</span><span class="hl-tag"> /&gt;</span>
			</pre>
			<pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoAction {
	<span class="hl-keyword">public</span> String method(RequestContext context) {
		...
	}
}
			</pre>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1049" href="#d5e1049"></a>6.5.2.&nbsp;Invoking a custom Action implementation</h3></div></div></div>
			
			<pre class="programlisting">
<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"customAction"</span><span class="hl-tag"> /&gt;</span>
			</pre>
			<pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomAction <span class="hl-keyword">implements</span> Action {
	<span class="hl-keyword">public</span> Event execute(RequestContext context) {
		...
	}
}
			</pre>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1053" href="#d5e1053"></a>6.5.3.&nbsp;Invoking a MultiAction implementation</h3></div></div></div>
			
			<pre class="programlisting">
<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"multiAction.actionMethod1"</span><span class="hl-tag"> /&gt;</span>

			</pre>
			<pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomMultiAction <span class="hl-keyword">extends</span> MultiAction {
	<span class="hl-keyword">public</span> Event actionMethod1(RequestContext context) {
		...
	}

	<span class="hl-keyword">public</span> Event actionMethod2(RequestContext context) {
		...
	}

	...
}
			</pre>
		</div>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="action-exceptions" href="#action-exceptions"></a>6.6.&nbsp;Action exceptions</h2></div></div></div>
		
		<p>
			Actions often invoke services that encapsulate complex business logic.
			These services may throw business exceptions that the action code should handle.
		</p>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1060" href="#d5e1060"></a>6.6.1.&nbsp;Handling a business exception with a POJO action</h3></div></div></div>
			
			<p>
				The following example invokes an action that catches a business exception, adds a error message to the context, and returns a result event identifier.
				The result is treated as a flow event which the calling flow can then respond to.
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"bookingAction.makeBooking(booking, flowRequestContext)"</span><span class="hl-tag"> /&gt;</span>
			</pre>
			<pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BookingAction {
<span class="hl-keyword">public</span> String makeBooking(Booking booking, RequestContext context) {
	   <span class="hl-keyword">try</span> {
		   BookingConfirmation confirmation = bookingService.make(booking);
		   context.getFlowScope().put(<span class="hl-string">"confirmation"</span>, confirmation);
		   <span class="hl-keyword">return</span> <span class="hl-string">"success"</span>;
	   } <span class="hl-keyword">catch</span> (RoomNotAvailableException e) {
		   context.addMessage(<span class="hl-keyword">new</span> MessageBuilder().error().
			   .defaultText(<span class="hl-string">"No room is available at this hotel"</span>).build());
		   <span class="hl-keyword">return</span> <span class="hl-string">"error"</span>;
	   }
}
}
			</pre>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1065" href="#d5e1065"></a>6.6.2.&nbsp;Handling a business exception with a MultiAction</h3></div></div></div>
			
			<p>
				The following example is functionally equivlant to the last, but implemented as a MultiAction instead of a POJO action.
				The MultiAction requires its action methods to be of the signature <code class="code">Event ${methodName}(RequestContext)</code>, providing stronger type safety, while a POJO action allows for more freedom.
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"bookingAction.makeBooking"</span><span class="hl-tag"> /&gt;</span>
			</pre>
			<pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BookingAction <span class="hl-keyword">extends</span> MultiAction {
<span class="hl-keyword">public</span> Event makeBooking(RequestContext context) {
	   <span class="hl-keyword">try</span> {
		   Booking booking = (Booking) context.getFlowScope().get(<span class="hl-string">"booking"</span>);
		   BookingConfirmation confirmation = bookingService.make(booking);
		   context.getFlowScope().put(<span class="hl-string">"confirmation"</span>, confirmation);
		   <span class="hl-keyword">return</span> success();
	   } <span class="hl-keyword">catch</span> (RoomNotAvailableException e) {
		   context.getMessageContext().addMessage(<span class="hl-keyword">new</span> MessageBuilder().error().
			   .defaultText(<span class="hl-string">"No room is available at this hotel"</span>).build());
		   <span class="hl-keyword">return</span> error();
	   }
}
}
			</pre>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1071" href="#d5e1071"></a>6.6.3.&nbsp;Using an exception-handler element</h3></div></div></div>
			
			<p>
				In general it is recommended to catch exceptions in actions and return result
				events that drive standard transitions, it is also possible to add an
				<code class="code">exception-handler</code> sub-element to any state type with a
				<code class="code">bean</code> attribute referencing a bean of type
				<code class="classname">FlowExecutionExceptionHandler</code>. This is an advanced
				option that if used incorrectly can leave the flow execution in an invalid state.
				Consider the build-in <code class="classname">TransitionExecutingFlowExecutionExceptionHandler</code>
				as example of a correct implementation. 
			</p>
		</div>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="action-examples" href="#action-examples"></a>6.7.&nbsp;Other Action execution examples</h2></div></div></div>
		
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="action-on-start" href="#action-on-start"></a>6.7.1.&nbsp;on-start</h3></div></div></div>
			
			<p>
				The following example shows an action that creates a new Booking object by invoking a method on a service:
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;flow</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/webflow"</span>
	  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
	  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/webflow
						  http://www.springframework.org/schema/webflow/spring-webflow.xsd"</span><span class="hl-tag">&gt;</span>

	<span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"hotelId"</span><span class="hl-tag"> /&gt;</span>

	<span class="hl-tag">&lt;on-start&gt;</span>
		<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"bookingService.createBooking(hotelId, currentUser.name)"</span>
				  <span class="hl-attribute">result</span>=<span class="hl-value">"flowScope.booking"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/on-start&gt;</span>

<span class="hl-tag">&lt;/flow&gt;</span>
			</pre>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="action-on-state-entry" href="#action-on-state-entry"></a>6.7.2.&nbsp;on-entry</h3></div></div></div>
			
			<p>
				The following example shows a state entry action that sets the special <code class="code">fragments</code> variable that causes the view-state to render a partial fragment of its view:
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;view-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"changeSearchCriteria"</span> <span class="hl-attribute">view</span>=<span class="hl-value">"enterSearchCriteria.xhtml"</span> <span class="hl-attribute">popup</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;on-entry&gt;</span>
		<span class="hl-tag">&lt;render</span> <span class="hl-attribute">fragments</span>=<span class="hl-value">"hotelSearchForm"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/on-entry&gt;</span>
<span class="hl-tag">&lt;/view-state&gt;</span>
			</pre>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="action-on-state-exit" href="#action-on-state-exit"></a>6.7.3.&nbsp;on-exit</h3></div></div></div>
			
			<p>
				The following example shows a state exit action that releases a lock on a record being edited:
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;view-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"editOrder"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;on-entry&gt;</span>
		<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"orderService.selectForUpdate(orderId, currentUser)"</span>
				  <span class="hl-attribute">result</span>=<span class="hl-value">"viewScope.order"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/on-entry&gt;</span>
	<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"save"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"finish"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"orderService.update(order, currentUser)"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/transition&gt;</span>
	<span class="hl-tag">&lt;on-exit&gt;</span>
		<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"orderService.releaseLock(order, currentUser)"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/on-exit&gt;</span>
<span class="hl-tag">&lt;/view-state&gt;</span>
			</pre>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="on-end" href="#on-end"></a>6.7.4.&nbsp;on-end</h3></div></div></div>
			
			<p>
				The following example shows the equivalent object locking behavior using flow start and end actions:
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;flow</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/webflow"</span>
	  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
	  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/webflow
						  http://www.springframework.org/schema/webflow/spring-webflow.xsd"</span><span class="hl-tag">&gt;</span>

	<span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"orderId"</span><span class="hl-tag"> /&gt;</span>

	<span class="hl-tag">&lt;on-start&gt;</span>
		<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"orderService.selectForUpdate(orderId, currentUser)"</span>
				  <span class="hl-attribute">result</span>=<span class="hl-value">"flowScope.order"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/on-start&gt;</span>

	<span class="hl-tag">&lt;view-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"editOrder"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"save"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"finish"</span><span class="hl-tag">&gt;</span>
			<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"orderService.update(order, currentUser)"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;/transition&gt;</span>
	<span class="hl-tag">&lt;/view-state&gt;</span>

	<span class="hl-tag">&lt;on-end&gt;</span>
		<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"orderService.releaseLock(order, currentUser)"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/on-end&gt;</span>

<span class="hl-tag">&lt;/flow&gt;</span>
			</pre>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="action-on-render" href="#action-on-render"></a>6.7.5.&nbsp;on-render</h3></div></div></div>
			
			<p>
				The following example shows a render action that loads a list of hotels to display before the view is rendered:
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;view-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"reviewHotels"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;on-render&gt;</span>
		<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"bookingService.findHotels(searchCriteria)"</span>
				  <span class="hl-attribute">result</span>=<span class="hl-value">"viewScope.hotels"</span> <span class="hl-attribute">result-type</span>=<span class="hl-value">"dataModel"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/on-render&gt;</span>
	<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"select"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"reviewHotel"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;set</span> <span class="hl-attribute">name</span>=<span class="hl-value">"flowScope.hotel"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"hotels.selectedRow"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/transition&gt;</span>
<span class="hl-tag">&lt;/view-state&gt;</span>
			</pre>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="action-on-transition" href="#action-on-transition"></a>6.7.6.&nbsp;on-transition</h3></div></div></div>
			
			<p>
				The following example shows a transition action adds a subflow outcome event attribute to a collection:
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;subflow-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"addGuest"</span> <span class="hl-attribute">subflow</span>=<span class="hl-value">"createGuest"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"guestCreated"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"reviewBooking"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"booking.guestList.add(currentEvent.attributes.newGuest)"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/transition&gt;</span>
<span class="hl-tag">&lt;/subfow-state&gt;</span>
			</pre>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="named-actions" href="#named-actions"></a>6.7.7.&nbsp;Named actions</h3></div></div></div>
			
			<p>
				The following example shows how to execute a chain of actions in an action-state.
				The name of each action becomes a qualifier for the action's result event.
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;action-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"doTwoThings"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"service.thingOne()"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;attribute</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"thingOne"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/evaluate&gt;</span>
	<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"service.thingTwo()"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;attribute</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"thingTwo"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/evaluate&gt;</span>
	<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"thingTwo.success"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"showResults"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/action-state&gt;</span>
			</pre>
			<p>
				In this example, the flow will transition to <code class="code">showResults</code> when <code class="code">thingTwo</code>
				completes successfully.
			</p>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="streaming-actions" href="#streaming-actions"></a>6.7.8.&nbsp;Streaming actions</h3></div></div></div>
			
			<p>
				Sometimes an Action needs to stream a custom response back to the client.
				An example might be a flow that renders a PDF document when handling a print event.
				This can be achieved by having the action stream the content then record "Response Complete" status on the ExternalContext.
				The responseComplete flag tells the pausing view-state not to render the response because another object has taken care of it.
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;view-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"reviewItinerary"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"print"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"printBoardingPassAction"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/transition&gt;</span>
<span class="hl-tag">&lt;/view-state&gt;</span>
			</pre>
			<pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PrintBoardingPassAction <span class="hl-keyword">extends</span> AbstractAction {
	<span class="hl-keyword">public</span> Event doExecute(RequestContext context) {
		<span class="hl-comment">// stream PDF content here...</span>
		<span class="hl-comment">// - Access HttpServletResponse by calling context.getExternalContext().getNativeResponse();</span>
		<span class="hl-comment">// - Mark response complete by calling context.getExternalContext().recordResponseComplete();</span>
		<span class="hl-keyword">return</span> success();
	}
}
			</pre>
			<p>
				In this example, when the print event is raised the flow will call the printBoardingPassAction.
				The action will render the PDF then mark the response as complete.
			</p>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="file-upload" href="#file-upload"></a>6.7.9.&nbsp;Handling File Uploads</h3></div></div></div>
			
			<p>
				Another common task is to use Web Flow to handle multipart file uploads in combination with Spring MVC's
				<code class="code">MultipartResolver</code>.  Once the resolver is set up correctly <a class="ulink" href="http://static.springsource.org/spring/docs/2.5.x/reference/mvc.html#mvc-multipart" target="_top">as described here</a> and the submitting
				HTML form is configured with <code class="code">enctype="multipart/form-data"</code>, you can easily handle the file upload in a
				transition action.
			</p>
			<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
				<p>
					The file upload example below below is not relevant when using Web Flow with JSF. See
					<a class="xref" href="spring-faces.html#spring-faces-file-upload" title="13.8.&nbsp;Handling File Uploads with JSF">Section&nbsp;13.8, &#8220;Handling File Uploads with JSF&#8221;</a> for details of how to upload files using JSF.
				</p>
			</td></tr></table></div>
			<p>
				Given a form such as:
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;form:form</span> <span class="hl-attribute">modelAttribute</span>=<span class="hl-value">"fileUploadHandler"</span> <span class="hl-attribute">enctype</span>=<span class="hl-value">"multipart/form-data"</span><span class="hl-tag">&gt;</span>
	Select file: <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"file"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"file"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"_eventId_upload"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Upload"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/form:form&gt;</span>
			</pre>
			<p>
				and a backing object for handling the upload such as:
			</p>
			<pre class="programlisting">
<span class="hl-keyword">package</span> org.springframework.webflow.samples.booking;

<span class="hl-keyword">import</span> org.springframework.web.multipart.MultipartFile;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileUploadHandler {

	<span class="hl-keyword">private</span> <span class="hl-keyword">transient</span> MultipartFile file;

	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> processFile() {
		<span class="hl-comment">//Do something with the MultipartFile here</span>
	}

	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setFile(MultipartFile file) {
		<span class="hl-keyword">this</span>.file = file;
	}
}
			</pre>
			<p>
				you can process the upload using a transition action as in the following example:
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;view-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"uploadFile"</span> <span class="hl-attribute">model</span>=<span class="hl-value">"uploadFileHandler"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;var</span> <span class="hl-attribute">name</span>=<span class="hl-value">"fileUploadHandler"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.webflow.samples.booking.FileUploadHandler"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"upload"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"finish"</span><span class="hl-tag"> &gt;</span>
		<span class="hl-tag">&lt;evaluate</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"fileUploadHandler.processFile()"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/transition&gt;</span>
	<span class="hl-tag">&lt;transition</span> <span class="hl-attribute">on</span>=<span class="hl-value">"cancel"</span> <span class="hl-attribute">to</span>=<span class="hl-value">"finish"</span> <span class="hl-attribute">bind</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/view-state&gt;</span>
			</pre>
			<p>
				The <code class="code">MultipartFile</code> will be bound to the <code class="code">FileUploadHandler</code> bean as
				part of the normal form binding process so that it will be available to process during the
				execution of the transition action.
			</p>
		</div>
	</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="views.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="flow-managed-persistence.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5.&nbsp;Rendering views&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;7.&nbsp;Flow Managed Persistence</td></tr></table></div></body></html>