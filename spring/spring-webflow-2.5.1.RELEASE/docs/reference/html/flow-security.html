<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>8.&nbsp;Securing Flows</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Web Flow Reference Guide"><link rel="up" href="index.html" title="Spring Web Flow Reference Guide"><link rel="prev" href="flow-managed-persistence.html" title="7.&nbsp;Flow Managed Persistence"><link rel="next" href="flow-inheritance.html" title="9.&nbsp;Flow Inheritance"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">8.&nbsp;Securing Flows</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="flow-managed-persistence.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="flow-inheritance.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="flow-security" href="#flow-security"></a>8.&nbsp;Securing Flows</h1></div></div></div>
	
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="flow-security-introduction" href="#flow-security-introduction"></a>8.1.&nbsp;Introduction</h2></div></div></div>
		
		<p>
			Security is an important concept for any application.
			End users should not be able to access any portion of a site simply by guessing the URL.
			Areas of a site that are sensitive must ensure that only authorized requests are processed.
			Spring Security is a proven security platform that can integrate with your application at multiple levels.
			This section will focus on securing flow execution.
		</p>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="flow-security-how-to" href="#flow-security-how-to"></a>8.2.&nbsp;How do I secure a flow?</h2></div></div></div>
		
		<p>
			Securing flow execution is a three step process:
			</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Configure Spring Security with authentication and authorization rules</p></li><li class="listitem"><p>Annotate the flow definition with the secured element to define the security rules</p></li><li class="listitem"><p>Add the SecurityFlowExecutionListener to process the security rules.</p></li></ul></div><p>
		</p>
		<p>
			Each of these steps must be completed or else flow security rules will not be applied.
		</p>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="flow-security-secured-element" href="#flow-security-secured-element"></a>8.3.&nbsp;The secured element</h2></div></div></div>
		
		<p>
			The secured element designates that its containing element should apply the authorization check before fully entering.
			This may not occur more then once per stage of the flow execution that is secured.
		</p>
		<p>
			Three phases of flow execution can be secured: flows, states and transitions.
			In each case the syntax for the secured element is identical.
			The secured element is located inside the element it is securing.
			For example, to secure a state the secured element occurs directly inside that state:
		</p>
		<pre class="programlisting">
<span class="hl-tag">&lt;view-state</span> <span class="hl-attribute">id</span>=<span class="hl-value">"secured-view"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;secured</span> <span class="hl-attribute">attributes</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
    ...
<span class="hl-tag">&lt;/view-state&gt;</span>
		</pre>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="flow-security-secured-element-attributes" href="#flow-security-secured-element-attributes"></a>8.3.1.&nbsp;Security attributes</h3></div></div></div>
			
			<p>
				The <code class="code">attributes</code> attribute is a comma separated list of Spring Security authorization attributes.
				Often, these are specific security roles.
				The attributes are compared against the user's granted attributes by a Spring Security access decision manager.
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;secured</span> <span class="hl-attribute">attributes</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
			</pre>
			<p>
				By default, a role based access decision manager is used to determine if the user is allowed access.
				This will need to be overridden if your application is not using authorization roles.
			</p>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="flow-security-secured-element-match" href="#flow-security-secured-element-match"></a>8.3.2.&nbsp;Matching type</h3></div></div></div>
			
			<p>
				There are two types of matching available: <code class="code">any</code> and <code class="code">all</code>.
				Any, allows access if at least one of the required security attributes is granted to the user.
				All, allows access only if each of the required security attributes are granted to the user.
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;secured</span> <span class="hl-attribute">attributes</span>=<span class="hl-value">"ROLE_USER, ROLE_ANONYMOUS"</span> <span class="hl-attribute">match</span>=<span class="hl-value">"any"</span><span class="hl-tag"> /&gt;</span>
			</pre>
			<p>
				This attribute is optional.
				If not defined, the default value is <code class="code">any</code>.
			</p>
			<p>
				The <code class="code">match</code> attribute will only be respected if the default access decision manager is used.
			</p>
		</div>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="flow-security-listener" href="#flow-security-listener"></a>8.4.&nbsp;The SecurityFlowExecutionListener</h2></div></div></div>
		
		<p>
			Defining security rules in the flow by themselves will not protect the flow execution.
			A <code class="code">SecurityFlowExecutionListener</code> must also be defined in the webflow configuration and applied to the flow executor.
		</p>
		<pre class="programlisting">
<span class="hl-tag">&lt;webflow:flow-executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"flowExecutor"</span> <span class="hl-attribute">flow-registry</span>=<span class="hl-value">"flowRegistry"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;webflow:flow-execution-listeners&gt;</span>
        <span class="hl-tag">&lt;webflow:listener</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"securityFlowExecutionListener"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/webflow:flow-execution-listeners&gt;</span>
<span class="hl-tag">&lt;/webflow:flow-executor&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"securityFlowExecutionListener"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.webflow.security.SecurityFlowExecutionListener"</span><span class="hl-tag"> /&gt;</span>
		</pre>
		<p>
			If access is denied to a portion of the application an <code class="code">AccessDeniedException</code> will be thrown.
			This exception will later be caught by Spring Security and used to prompt the user to authenticate.
			It is important that this exception be allowed to travel up the execution stack uninhibited, otherwise the end user may not be prompted to authenticate.
		</p>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="flow-security-listener-adm" href="#flow-security-listener-adm"></a>8.4.1.&nbsp;Custom Access Decision Managers</h3></div></div></div>
			
			<p>
				If your application is using authorities that are not role based, you will need to configure a custom <code class="code">AccessDecisionManager</code>.
				You can override the default decision manager by setting the <code class="code">accessDecisionManager</code> property on the security listener.
				Please consult the <a class="ulink" href="http://static.springframework.org/spring-security/site/reference.html" target="_top">Spring Security reference documentation</a> to learn more about decision managers.
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"securityFlowExecutionListener"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.webflow.security.SecurityFlowExecutionListener"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accessDecisionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myCustomAccessDecisionManager"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>
			</pre>
		</div>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="flow-security-configuration" href="#flow-security-configuration"></a>8.5.&nbsp;Configuring Spring Security</h2></div></div></div>
		
		<p>
			Spring Security has robust configuration options available.
			As every application and environment has its own security requirements, the <a class="ulink" href="http://static.springframework.org/spring-security/site/reference.html" target="_top">Spring Security reference documentation</a> is the best place to learn the available options.
		</p>
		<p>
			Both the <code class="code">booking-faces</code> and <code class="code">booking-mvc</code> sample applications are configured to use Spring Security.
			Configuration is needed at both the Spring and web.xml levels.
		</p>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="flow-security-configuration-spring" href="#flow-security-configuration-spring"></a>8.5.1.&nbsp;Spring configuration</h3></div></div></div>
			
			<p>
				The Spring configuration defines <code class="code">http</code> specifics (such as protected URLs and login/logout mechanics) and the <code class="code">authentication-provider</code>.
				For the sample applications, a local authentication provider is configured.
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;security:http</span> <span class="hl-attribute">auto-config</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;security:form-login</span> <span class="hl-attribute">login-page</span>=<span class="hl-value">"/spring/login"</span>
                         <span class="hl-attribute">login-processing-url</span>=<span class="hl-value">"/spring/loginProcess"</span>
                         <span class="hl-attribute">default-target-url</span>=<span class="hl-value">"/spring/main"</span>
                         <span class="hl-attribute">authentication-failure-url</span>=<span class="hl-value">"/spring/login?login_error=1"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;security:logout</span> <span class="hl-attribute">logout-url</span>=<span class="hl-value">"/spring/logout"</span> <span class="hl-attribute">logout-success-url</span>=<span class="hl-value">"/spring/logout-success"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/security:http&gt;</span>

<span class="hl-tag">&lt;security:authentication-provider&gt;</span>
    <span class="hl-tag">&lt;security:password-encoder</span> <span class="hl-attribute">hash</span>=<span class="hl-value">"md5"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;security:user-service&gt;</span>
        <span class="hl-tag">&lt;security:user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"keith"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"417c7382b16c395bc25b5da1398cf076"</span>
                       <span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER,ROLE_SUPERVISOR"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;security:user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"erwin"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"12430911a8af075c6f41c6976af22b09"</span>
                       <span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER,ROLE_SUPERVISOR"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;security:user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jeremy"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"57c6cbff0d421449be820763f03139eb"</span>
                       <span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;security:user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"scott"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"942f2339bf50796de535a384f0d1af3e"</span>
                       <span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/security:user-service&gt;</span>
<span class="hl-tag">&lt;/security:authentication-provider&gt;</span>
			</pre>
		</div>
		<div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="flow-security-configuration-web" href="#flow-security-configuration-web"></a>8.5.2.&nbsp;web.xml Configuration</h3></div></div></div>
			
			<p>
				In the <code class="code">web.xml</code> file, a <code class="code">filter</code> is defined to intercept all requests.
				This filter will listen for login/logout requests and process them accordingly.
				It will also catch <code class="code">AccesDeniedException</code>s and redirect the user to the login page.
			</p>
			<pre class="programlisting">
<span class="hl-tag">&lt;filter&gt;</span>
    <span class="hl-tag">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="hl-tag">&lt;/filter-name&gt;</span>
    <span class="hl-tag">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="hl-tag">&lt;/filter-class&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span>

<span class="hl-tag">&lt;filter-mapping&gt;</span>
    <span class="hl-tag">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="hl-tag">&lt;/filter-name&gt;</span>
    <span class="hl-tag">&lt;url-pattern&gt;</span>/*<span class="hl-tag">&lt;/url-pattern&gt;</span>
<span class="hl-tag">&lt;/filter-mapping&gt;</span>
			</pre>
		</div>
	</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="flow-managed-persistence.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="flow-inheritance.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">7.&nbsp;Flow Managed Persistence&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;9.&nbsp;Flow Inheritance</td></tr></table></div></body></html>