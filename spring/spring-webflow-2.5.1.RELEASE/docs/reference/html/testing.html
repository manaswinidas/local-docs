<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>14.&nbsp;Testing flows</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Web Flow Reference Guide"><link rel="up" href="index.html" title="Spring Web Flow Reference Guide"><link rel="prev" href="spring-faces.html" title="13.&nbsp;JSF Integration"><link rel="next" href="field-mappings.html" title="Appendix&nbsp;A.&nbsp;Flow Definition Language 1.0 to 2.0 Mappings"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">14.&nbsp;Testing flows</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="spring-faces.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="field-mappings.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="testing" href="#testing"></a>14.&nbsp;Testing flows</h1></div></div></div>
	
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing-introduction" href="#testing-introduction"></a>14.1.&nbsp;Introduction</h2></div></div></div>
		
		<p>
			This chapter shows you how to test flows.
		</p>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="extending-abstractflowexecutiontest" href="#extending-abstractflowexecutiontest"></a>14.2.&nbsp;Extending AbstractXmlFlowExecutionTests</h2></div></div></div>
		
		<p>
			To test the execution of a XML-based flow definition, extend <code class="code">AbstractXmlFlowExecutionTests</code>:
		</p>
		<pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BookingFlowExecutionTests <span class="hl-keyword">extends</span> AbstractXmlFlowExecutionTests {

}
		</pre>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="override-getResource" href="#override-getResource"></a>14.3.&nbsp;Specifying the path to the flow to test</h2></div></div></div>
		
		<p>
			At a minimum, you must override <code class="code">getResource(FlowDefinitionResourceFactory)</code> to return the path to the flow you wish to test:
		</p>
		<pre class="programlisting">
<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> FlowDefinitionResource getResource(FlowDefinitionResourceFactory resourceFactory) {
	<span class="hl-keyword">return</span> resourceFactory.createFileResource(<span class="hl-string">"src/main/webapp/WEB-INF/hotels/booking/booking.xml"</span>);
}
		</pre>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="override-configureFlowBuilderContext" href="#override-configureFlowBuilderContext"></a>14.4.&nbsp;Registering flow dependencies</h2></div></div></div>
		
		<p>
			If your flow has dependencies on externally managed services,
			also override <code class="code">configureFlowBuilderContext(MockFlowBuilderContext)</code> to register stubs or mocks of those services:
		</p>
		<pre class="programlisting">
<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configureFlowBuilderContext(MockFlowBuilderContext builderContext) {
	builderContext.registerBean(<span class="hl-string">"bookingService"</span>, <span class="hl-keyword">new</span> StubBookingService());
}
		</pre>
		<p>
			If your flow extends from another flow, or has states that extend other states,
			also override <code class="code">getModelResources(FlowDefinitionResourceFactory)</code> to return the path to the parent flows.
		</p>
		<pre class="programlisting">
<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> FlowDefinitionResource[] getModelResources(FlowDefinitionResourceFactory resourceFactory) {
<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> FlowDefinitionResource[] {
	   resourceFactory.createFileResource(<span class="hl-string">"src/main/webapp/WEB-INF/common/common.xml"</span>)
};
}
		</pre>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing-flowstartup" href="#testing-flowstartup"></a>14.5.&nbsp;Testing flow startup</h2></div></div></div>
		
		<p>
			Have your first test exercise the startup of your flow:
		</p>
		<pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testStartBookingFlow() {

	Booking booking = createTestBooking();

	MutableAttributeMap input = <span class="hl-keyword">new</span> LocalAttributeMap();
	input.put(<span class="hl-string">"hotelId"</span>, <span class="hl-string">"1"</span>);
	MockExternalContext context = <span class="hl-keyword">new</span> MockExternalContext();
	context.setCurrentUser(<span class="hl-string">"keith"</span>);
	startFlow(input, context);

	assertCurrentStateEquals(<span class="hl-string">"enterBookingDetails"</span>);
	assertTrue(getRequiredFlowAttribute(<span class="hl-string">"booking"</span>) <span class="hl-keyword">instanceof</span> Booking);
}
		</pre>
		<p>
			Assertions generally verify the flow is in the correct state you expect.
		</p>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing-flowevents" href="#testing-flowevents"></a>14.6.&nbsp;Testing flow event handling</h2></div></div></div>
		
		<p>
			Define additional tests to exercise flow event handling behavior.
			You goal should be to exercise all paths through the flow.
			You can use the convenient <code class="code">setCurrentState(String)</code> method to jump to the flow state where you wish to begin your test.
		</p>
		<pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testEnterBookingDetails_Proceed() {

	setCurrentState(<span class="hl-string">"enterBookingDetails"</span>);

	getFlowScope().put(<span class="hl-string">"booking"</span>, createTestBooking());

	MockExternalContext context = <span class="hl-keyword">new</span> MockExternalContext();
	context.setEventId(<span class="hl-string">"proceed"</span>);
	resumeFlow(context);

	assertCurrentStateEquals(<span class="hl-string">"reviewBooking"</span>);
}
		</pre>
	</div>
	<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing-mockingsubflows" href="#testing-mockingsubflows"></a>14.7.&nbsp;Mocking a subflow</h2></div></div></div>
		
		<p>
			To test calling a subflow, register a mock implementation of the subflow that asserts input was passed in correctly and
			returns the correct outcome for your test scenario.
		</p>
		<pre class="programlisting">
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testBookHotel() {

	setCurrentState(<span class="hl-string">"reviewHotel"</span>);

	Hotel hotel = <span class="hl-keyword">new</span> Hotel();
	hotel.setId(<span class="hl-number">1L</span>);
	hotel.setName(<span class="hl-string">"Jameson Inn"</span>);
	getFlowScope().put(<span class="hl-string">"hotel"</span>, hotel);

	getFlowDefinitionRegistry().registerFlowDefinition(createMockBookingSubflow());

	MockExternalContext context = <span class="hl-keyword">new</span> MockExternalContext();
	context.setEventId(<span class="hl-string">"book"</span>);
	resumeFlow(context);

	<span class="hl-comment">// verify flow ends on 'bookingConfirmed'</span>
	assertFlowExecutionEnded();
	assertFlowExecutionOutcomeEquals(<span class="hl-string">"finish"</span>);
}

<span class="hl-keyword">public</span> Flow createMockBookingSubflow() {
	Flow mockBookingFlow = <span class="hl-keyword">new</span> Flow(<span class="hl-string">"booking"</span>);
	mockBookingFlow.setInputMapper(<span class="hl-keyword">new</span> Mapper() {
		<span class="hl-keyword">public</span> MappingResults map(Object source, Object target) {
			<span class="hl-comment">// assert that 1L was passed in as input</span>
			assertEquals(<span class="hl-number">1L</span>, ((AttributeMap) source).get(<span class="hl-string">"hotelId"</span>));
			<span class="hl-keyword">return</span> null;
		}
	});
	<span class="hl-comment">// immediately return the bookingConfirmed outcome so the caller can respond</span>
	<span class="hl-keyword">new</span> EndState(mockBookingFlow, <span class="hl-string">"bookingConfirmed"</span>);
	<span class="hl-keyword">return</span> mockBookingFlow;
}
		</pre>
	</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="spring-faces.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="field-mappings.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">13.&nbsp;JSF Integration&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Appendix&nbsp;A.&nbsp;Flow Definition Language 1.0 to 2.0 Mappings</td></tr></table></div></body></html>