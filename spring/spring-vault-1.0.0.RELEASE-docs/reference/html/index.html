<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.3">
<meta name="author" content="Mark Paluch">
<title>Spring Vault - Reference Documentation</title>
<link rel="stylesheet" href="./spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
</head>
<body class="book">
<div id="header">
<h1>Spring Vault - Reference Documentation</h1>
<div class="details">
<span id="author" class="author">Mark Paluch</span><br>
<span id="revnumber">version 1.0.0.RELEASE,</span>
<span id="revdate">2017-04-10</span>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>&#169; 2016-2017 The original authors.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<em>Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically.</em>
</td>
</tr>
</table>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#preface">Preface</a>
<ul class="sectlevel1">
<li><a href="#_document_structure">1. Document Structure</a></li>
<li><a href="#get-started:first-steps:spring">2. Knowing Spring</a></li>
<li><a href="#get-started:first-steps:vault">3. Knowing Vault</a></li>
<li><a href="#requirements">4. Requirements</a></li>
<li><a href="#_additional_help_resources">5. Additional Help Resources</a>
<ul class="sectlevel2">
<li><a href="#get-started:help">5.1. Support</a>
<ul class="sectlevel3">
<li><a href="#get-started:help:community">5.1.1. Community Forum</a></li>
<li><a href="#get-started:help:professional">5.1.2. Professional Support</a></li>
</ul>
</li>
<li><a href="#get-started:up-to-date">5.2. Following Development</a></li>
</ul>
</li>
<li><a href="#new-features">6. New &amp; Noteworthy</a>
<ul class="sectlevel2">
<li><a href="#new-features.1-0-0">6.1. What&#8217;s new in Spring Vault 1.0</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#reference-documentation">Reference documentation</a>
<ul class="sectlevel1">
<li><a href="#vault.core">7. Vault support</a>
<ul class="sectlevel2">
<li><a href="#dependencies">7.1. Dependencies</a></li>
<li><a href="#dependencies.spring-framework">7.2. Spring Framework</a></li>
</ul>
</li>
<li><a href="#vault.core.getting-started">8. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#vault.core.template">8.1. Introduction to VaultTemplate</a>
<ul class="sectlevel3">
<li><a href="#vault.core.template.beans">8.1.1. Registering and configuring Spring Vault beans</a></li>
<li><a href="#vault.core.template.sessionmanagement">8.1.2. Session Management</a></li>
</ul>
</li>
<li><a href="#vault.client-ssl">8.2. Vault Client SSL configuration</a></li>
<li><a href="#vault.core.environment-vault-configuration">8.3. Using <code>EnvironmentVaultConfiguration</code></a></li>
<li><a href="#vault.core.propertysupport">8.4. Vault Property Source Support</a>
<ul class="sectlevel3">
<li><a href="#_registering_code_vaultpropertysource_code">8.4.1. Registering <code>VaultPropertySource</code></a></li>
<li><a href="#__vaultpropertysource">8.4.2. @VaultPropertySource</a></li>
</ul>
</li>
<li><a href="#vault.core.executioncallback">8.5. Execution callbacks</a></li>
</ul>
</li>
<li><a href="#vault.core.client.support">9. Client support</a>
<ul class="sectlevel2">
<li><a href="#_java_s_builtin_code_httpurlconnection_code">9.1. Java&#8217;s builtin <code>HttpURLConnection</code></a></li>
<li><a href="#_external_clients">9.2. External Clients</a></li>
</ul>
</li>
<li><a href="#vault.core.authentication">10. Authentication Methods</a>
<ul class="sectlevel2">
<li><a href="#_externalizing_login_credentials">10.1. Externalizing login credentials</a></li>
<li><a href="#vault.authentication.token">10.2. Token authentication</a></li>
<li><a href="#vault.authentication.appid">10.3. AppId authentication</a>
<ul class="sectlevel3">
<li><a href="#_custom_userid">10.3.1. Custom UserId</a></li>
</ul>
</li>
<li><a href="#vault.authentication.approle">10.4. AppRole authentication</a></li>
<li><a href="#vault.authentication.awsec2">10.5. AWS-EC2 authentication</a></li>
<li><a href="#vault.authentication.clientcert">10.6. TLS certificate authentication</a></li>
<li><a href="#vault.authentication.cubbyhole">10.7. Cubbyhole authentication</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<h1 id="preface" class="sect0"><a class="anchor" href="#preface"></a>Preface</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>The Spring Vault project applies core Spring concepts to the development of solutions using HashiCorp Vault. We provide a "template" as a high-level abstraction for storing and querying documents. You will notice similarities to the REST support in the Spring Framework.</p>
</div>
<div class="paragraph">
<p>This document is the reference guide for Spring Vault. It explains Vault concepts and semantics and the syntax.</p>
</div>
<div class="paragraph">
<p>This part of the reference documentation explains the core functionality offered by Spring Vault.</p>
</div>
<div class="paragraph">
<p><a href="#vault.core">Vault support</a> introduces the Vault module feature set.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_document_structure"><a class="anchor" href="#_document_structure"></a>1. Document Structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section provides basic introduction to Spring and Vault.
It contains details about following development and how to get support.</p>
</div>
<div class="paragraph">
<p>The rest of the document refers to Spring Vault features and assumes
the user is familiar with <a href="https://www.vaultproject.io">HashiCorp Vault</a>
as well as Spring concepts.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started:first-steps:spring"><a class="anchor" href="#get-started:first-steps:spring"></a>2. Knowing Spring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Vault uses Spring framework&#8217;s <a href="http://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/spring-core.html">core</a> functionality, such as the <a href="http://docs.spring.io/spring/docs/4.3.7.RELEASE/spring-framework-reference/html/beans.html">IoC</a> container. While it is not important to know the Spring APIs, understanding the concepts behind them is. At a minimum, the idea behind IoC should be familiar for whatever IoC container you choose to use.</p>
</div>
<div class="paragraph">
<p>The core functionality of the Vault support can be used directly, with no need to invoke the IoC services of the Spring Container. This is much like <code>RestTemplate</code> which can be used 'standalone' without any other services of the Spring container. To leverage all the features of Spring Vault document, such as the session support, you will need to configure some parts of the library using Spring.</p>
</div>
<div class="paragraph">
<p>To learn more about Spring, you can refer to the comprehensive (and sometimes disarming) documentation that explains in detail the Spring Framework. There are a lot of articles, blog entries and books on the matter - take a look at the Spring framework <a href="http://spring.io/docs">home page </a> for more information.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started:first-steps:vault"><a class="anchor" href="#get-started:first-steps:vault"></a>3. Knowing Vault</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Security and working with secrets is a concern of every developer working with databases, user credentials or API keys. Vault steps in by providing a secure storage combined with access control, revocation, key rolling and auditing. In short: Vault is a service for securely accessing and storing  secrets. A secret is anything that you want to tightly control access to, such as API keys, passwords, certificates, and more.</p>
</div>
<div class="paragraph">
<p>The jumping off ground for learning about Vault is <a href="https://www.vaultproject.io">www.vaultproject.io</a>. Here is a list of useful resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The manual introduces Vault and contains links to getting started guides, reference documentation and tutorials.</p>
</li>
<li>
<p>The online shell provides a convenient way to interact with a Vault instance in combination with the online tutorial.</p>
</li>
<li>
<p><a href="https://www.vaultproject.io/intro/index.html">HashiCorp Vault Introduction</a></p>
</li>
<li>
<p><a href="https://www.vaultproject.io/docs/index.html">HashiCorp Vault Documentation</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Vault provides client-side support for accessing, storing and revoking secrets.
With <a href="https://www.vaultproject.io">HashiCorp&#8217;s Vault</a> you have a central place to
manage external secret data for applications across all environments.
Vault can manage static and dynamic secrets such as application data,
username/password for remote applications/resources and provide credentials
for external services such as MySQL, PostgreSQL, Apache Cassandra, Consul, AWS and more.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="requirements"><a class="anchor" href="#requirements"></a>4. Requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Vault 1.x binaries requires JDK level 6.0 and above, and <a href="http://spring.io/docs">Spring Framework</a> 4.3.7.RELEASE and above. While we maintain Java 6 compatibility, new projects should consider using Java 8  .</p>
</div>
<div class="paragraph">
<p>In terms of Vault, <a href="https://www.vaultproject.io/">Vault</a> at least 0.5.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_additional_help_resources"><a class="anchor" href="#_additional_help_resources"></a>5. Additional Help Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Learning a new framework is not always straight forward. In this section, we try to provide what we think is an easy to follow guide for starting with Spring Vault module. However, if you encounter issues or you are just looking for advice, feel free to use one of the links below:</p>
</div>
<div class="sect2">
<h3 id="get-started:help"><a class="anchor" href="#get-started:help"></a>5.1. Support</h3>
<div class="paragraph">
<p>There are a few support options available:</p>
</div>
<div class="sect3">
<h4 id="get-started:help:community"><a class="anchor" href="#get-started:help:community"></a>5.1.1. Community Forum</h4>
<div class="paragraph">
<p>Post questions questions regarding Spring Vault on <a href="http://stackoverflow.com/questions/tagged/spring-vault">Stackoverflow</a> to share information and help each other. Note that registration is needed <strong>only</strong> for posting.</p>
</div>
</div>
<div class="sect3">
<h4 id="get-started:help:professional"><a class="anchor" href="#get-started:help:professional"></a>5.1.2. Professional Support</h4>
<div class="paragraph">
<p>Professional, from-the-source support, with guaranteed response time, is available from <a href="http://pivotal.io/">Pivotal Sofware, Inc.</a>, the company behind Spring Vault and Spring.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="get-started:up-to-date"><a class="anchor" href="#get-started:up-to-date"></a>5.2. Following Development</h3>
<div class="paragraph">
<p>For information on the Spring Vault source code repository, nightly builds and snapshot artifacts please see the <a href="http://projects.spring.io/spring-vault/">Spring Vault homepage</a>. You can help make Spring Vault best serve the needs of the Spring community by interacting with developers through the Community on <a href="http://stackoverflow.com/questions/tagged/spring-vault">Stackoverflow</a>. If you encounter a bug or want to suggest an improvement, please create a ticket on the Spring Vault issue <a href="https://github.com/spring-projects/spring-vault/issues">tracker</a>. To stay up to date with the latest news and announcements in the Spring ecosystem, subscribe to the Spring Community <a href="http://spring.io">Portal</a>. Lastly, you can follow the Spring <a href="http://spring.io/blog">blog </a>or the project team on Twitter (<a href="http://twitter.com/springcentral">SpringCentral</a>).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="new-features"><a class="anchor" href="#new-features"></a>6. New &amp; Noteworthy</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="new-features.1-0-0"><a class="anchor" href="#new-features.1-0-0"></a>6.1. What&#8217;s new in Spring Vault 1.0</h3>
<div class="ulist">
<ul>
<li>
<p>Initial Vault support.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<h1 id="reference-documentation" class="sect0"><a class="anchor" href="#reference-documentation"></a>Reference documentation</h1>
<div class="sect1">
<h2 id="vault.core"><a class="anchor" href="#vault.core"></a>7. Vault support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Vault support contains a wide range of features which are summarized below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring configuration support using Java based @Configuration classes</p>
</li>
<li>
<p><code>VaultTemplate</code> helper class that increases productivity performing common
Vault operations.  Includes integrated object mapping between Vault responses and POJOs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For most tasks, you will find yourself using <code>VaultTemplate</code> that leverages the
rich communication functionality. <code>VaultTemplate</code> is the place to look for
accessing functionality such as reading data from Vault or issuing
administrative commands. <code>VaultTemplate</code> also provides callback methods so that it is easy for you to
get a hold of the low-level API artifacts such as <code>RestTemplate</code> to communicate
directly with Vault.</p>
</div>
<div class="sect2">
<h3 id="dependencies"><a class="anchor" href="#dependencies"></a>7.1. Dependencies</h3>
<div class="paragraph">
<p>The easiest way to find compatible versions of Spring Vault dependencies
is by relying on the Spring Vault BOM we ship with the compatible versions
defined. In a Maven project you would declare this dependency in the
<code>&lt;dependencyManagement /&gt;</code> section of your <code>pom.xml</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Using the Spring Vault BOM</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.vault&lt;/groupId&gt;
            &lt;artifactId&gt;spring-vault-dependencies&lt;/artifactId&gt;
            &lt;version&gt;1.0.0.RELEASE&lt;/version&gt;
            &lt;scope&gt;import&lt;/scope&gt;
            &lt;type&gt;pom&lt;/type&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
</div>
</div>
<div id="dependencies.names" class="paragraph">
<p>The current version is <code>1.0.0.RELEASE</code>. The version name follows the following
pattern: <code>${version}-${release}</code> where release can be one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BUILD-SNAPSHOT</code> - current snapshots</p>
</li>
<li>
<p><code>M1</code>, <code>M2</code> etc. - milestones</p>
</li>
<li>
<p><code>RC1</code>, <code>RC2</code> etc. - release candidates</p>
</li>
<li>
<p><code>RELEASE</code> - GA release</p>
</li>
<li>
<p><code>SR1</code>, <code>SR2</code> etc. - service releases</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 2. Declaring a dependency to Spring Vault</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.vault&lt;/groupId&gt;
        &lt;artifactId&gt;spring-vault-core&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dependencies.spring-framework"><a class="anchor" href="#dependencies.spring-framework"></a>7.2. Spring Framework</h3>
<div class="paragraph">
<p>The current version of Spring Vault requires Spring Framework in version
4.3.7.RELEASE or better. The modules might also work with an older bugfix
version of that minor version. However, using the most recent version
within that generation is highly recommended.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vault.core.getting-started"><a class="anchor" href="#vault.core.getting-started"></a>8. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Vault support requires Vault 0.5 or higher and Java SE 6 or higher.
An easy way to bootstrap setting up a working environment is to create a
Spring based project in <a href="http://spring.io/tools/sts">STS</a>.</p>
</div>
<div class="paragraph">
<p>First you need to set up a running Vault server.
Refer to the <a href="https://www.vaultproject.io/intro/">Vault</a> for an explanation on how to startup a Vault instance.</p>
</div>
<div class="paragraph">
<p>To create a Spring project in STS go to File &#8594; New &#8594;
Spring Template Project &#8594; Simple Spring Utility Project &#8594;
press Yes when prompted. Then enter a project and a package name such as <code>org.spring.vault.example</code>.</p>
</div>
<div class="paragraph">
<p>Then add the following to <code>pom.xml</code> dependencies section.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Using the Spring Vault BOM</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;

    &lt;!-- other dependency elements omitted --&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.vault&lt;/groupId&gt;
        &lt;artifactId&gt;spring-vault-core&lt;/artifactId&gt;
        &lt;version&gt;1.0.0.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;

&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you are using a milestone or release candidate, you will also need to add the location of the Spring
Milestone repository to your maven <code>pom.xml</code> which is at the same level of your <code>&lt;dependencies/&gt;</code> element.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;repositories&gt;
    &lt;repository&gt;
        &lt;id&gt;spring-milestone&lt;/id&gt;
        &lt;name&gt;Spring Maven MILESTONE Repository&lt;/name&gt;
        &lt;url&gt;http://repo.spring.io/libs-milestone&lt;/url&gt;
    &lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The repository is also <a href="http://repo.spring.io/milestone/org/springframework/vault/">browseable here</a>.</p>
</div>
<div class="paragraph">
<p>If you are using a SNAPSHOT, you will also need to add the location of the Spring
Snapshot repository to your maven <code>pom.xml</code> which is at the same level of your <code>&lt;dependencies/&gt;</code> element.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;repositories&gt;
    &lt;repository&gt;
        &lt;id&gt;spring-snapshot&lt;/id&gt;
        &lt;name&gt;Spring Maven SNAPSHOT Repository&lt;/name&gt;
        &lt;url&gt;http://repo.spring.io/libs-snapshot&lt;/url&gt;
    &lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The repository is also <a href="http://repo.spring.io/snapshot/org/springframework/vault/">browseable here</a>.</p>
</div>
<div class="paragraph">
<p>Create a simple <code>Secrets</code> class to persist:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Mapped data object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package org.spring.vault.example;

public class Secrets {

    String username;
    String password;

    public String getUsername() {
        return username;
    }

    public String getPassword() {
        return password;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And a main application to run</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. Example application using Spring Vault</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package org.springframework.vault.example;

import org.springframework.vault.authentication.TokenAuthentication;
import org.springframework.vault.client.VaultEndpoint;
import org.springframework.vault.core.VaultTemplate;
import org.springframework.vault.support.VaultResponseSupport;

public class VaultApp {

    public static void main(String[] args) {

        VaultTemplate vaultTemplate = new VaultTemplate(new VaultEndpoint(),
                new TokenAuthentication("00000000-0000-0000-0000-000000000000"));

        Secrets secrets = new Secrets();
        secrets.username = "hello";
        secrets.password = "world";

        vaultTemplate.write("secret/myapp", secrets);

        VaultResponseSupport&lt;Secrets&gt; response = vaultTemplate.read("secret/myapp", Secrets.class);
        System.out.println(response.getData().getUsername());

        vaultTemplate.delete("secret/myapp");
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Even in this simple example, there are few things to take notice of</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can instantiate the central class of Spring Vault,
<a href="#vault-template"><code>VaultTemplate</code></a>, using the <code>org.springframework.vault.client.VaultEndpoint</code>
object and the <code>ClientAuthentication</code>.
You are not required to spin up a Spring Context to use Spring Vault.</p>
</li>
<li>
<p>Vault is expected to be configured with a root token of
<code>00000000-0000-0000-0000-000000000000</code> to run this application.</p>
</li>
<li>
<p>The mapper works against standard POJO objects without the need for any
additional metadata (though you can optionally provide that information).</p>
</li>
<li>
<p>Mapping conventions can use field access. Notice the <code>Secrets</code> class has only getters.</p>
</li>
<li>
<p>If the constructor argument names match the field names of the stored document,
they will be used to instantiate the object.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="vault.core.template"><a class="anchor" href="#vault.core.template"></a>8.1. Introduction to VaultTemplate</h3>
<div class="paragraph">
<p>The class <code>VaultTemplate</code>, located in the package <code>org.springframework.vault.core</code>,
is the central class of the Spring&#8217;s Vault support providing a rich feature set to
interact with Vault. The template offers convenience operations to read, write and
delete data in Vault and provides a mapping between your domain objects and Vault data.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Once configured, <code>VaultTemplate</code> is thread-safe and can be reused across
multiple instances.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The mapping between Vault documents and domain classes is done by delegating to
<code>RestTemplate</code>. Spring Web support provides the mapping infrastructure.</p>
</div>
<div class="paragraph">
<p>The <code>VaultTemplate</code> class implements the interface <code>VaultOperations</code>.
In as much as possible, the methods on <code>VaultOperations</code> are named after methods
available on the Vault API to make the API familiar to existing Vault developers
who are used to the API and CLI. For example, you will find methods such as
"write", "delete", "read", and "revoke".
The design goal was to make it as easy as possible to transition between
the use of the Vault API and <code>VaultOperations</code>. A major difference in between
the two APIs is that <code>VaultOperations</code> can be passed domain objects instead of
JSON Key-Value pairs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preferred way to reference the operations on <code>VaultTemplate</code> instance
is via its interface <code>VaultOperations</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>While there are many convenience methods on <code>VaultTemplate</code> to help you easily
perform common tasks if you should need to access the Vault API directly to access
functionality not explicitly exposed by the <code>VaultTemplate</code> you can use one of
several execute callback methods to access underlying APIs. The execute callbacks
will give you a reference to a <code>RestOperations</code> object.
Please see the section <a href="#vault.core.executioncallback">Execution Callbacks</a> for more information.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s look at a examples of how to work with Vault in the context of the Spring container.</p>
</div>
<div class="sect3">
<h4 id="vault.core.template.beans"><a class="anchor" href="#vault.core.template.beans"></a>8.1.1. Registering and configuring Spring Vault beans</h4>
<div class="paragraph">
<p>Using Spring Vault does not require a Spring Context. However, instances of <code>VaultTemplate</code> and <code>SessionManager</code> registered inside a managed context will participate
in <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#beans-factory-nature">lifecycle events</a>
provided by the Spring IoC container. This is useful to dispose active Vault sessions upon
application shutdown. You also benefit from reusing the same <code>VaultTemplate</code>
instance across your application.</p>
</div>
<div class="paragraph">
<p>Spring Vault comes with a supporting configuration class that provides bean definitions
for use inside a Spring context. Application configuration
classes typically extend from <code>AbstractVaultConfiguration</code> and are required to
provide additional details that are environment specific.</p>
</div>
<div class="paragraph">
<p>Extending from <code>AbstractVaultConfiguration</code> requires to implement
` VaultEndpoint vaultEndpoint()` and <code>ClientAuthentication clientAuthentication()</code>
methods.</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. Registering Spring Vault objects using Java based bean metadata</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class AppConfig extends AbstractVaultConfiguration {

    /**
     * Specify an endpoint for connecting to Vault.
     */
    @Override
    public VaultEndpoint vaultEndpoint() {
        return new VaultEndpoint();                            <i class="conum" data-value="1"></i><b>(1)</b>
    }

    /**
     * Configure a client authentication.
     * Please consider a more secure authentication method
     * for production use.
     */
    @Override
    public ClientAuthentication clientAuthentication() {
        return new TokenAuthentication("…");                   <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a new <code>VaultEndpoint</code> that points by default to <code><a href="https://localhost:8200" class="bare">https://localhost:8200</a></code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This sample uses <code>TokenAuthentication</code> to get started quickly.
See <a href="#vault.core.authentication">Authentication Methods</a> for details on supported authentication methods.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 7. Registering Spring Vault applying injected properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class AppConfig extends AbstractVaultConfiguration {

    @Value("${vault.uri}")
    URI vaultUri;

    /**
     * Specify an endpoint that was injected as URI.
     */
    @Override
    public VaultEndpoint vaultEndpoint() {
        return VaultEndpoint.from(vaultUri);                          <i class="conum" data-value="1"></i><b>(1)</b>
    }

    /**
     * Configure a Client Certificate authentication.
     * {@link RestOperations} can be obtained from {@link #restOperations()}.
     */
    @Override
    public ClientAuthentication clientAuthentication() {
        return new ClientCertificateAuthentication(restOperations()); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>VaultEndpoint</code> can be constructed using various factory methods such as
<code>from(URI uri)</code> or <code>VaultEndpoint.create(String host, int port)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Dependencies for <code>ClientAuthentication</code> methods can be obtained either from
<code>AbstractVaultConfiguration</code> or provided by your configuration.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Creating a custom configuration class might be cumbersome in some cases.
Take a look at <code>EnvironmentVaultConfiguration</code> that allows configuration by using
properties from existing property sources and Spring&#8217;s <code>Environment</code>. Read more
in <a href="#vault.core.environment-vault-configuration">Using <code>EnvironmentVaultConfiguration</code></a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="vault.core.template.sessionmanagement"><a class="anchor" href="#vault.core.template.sessionmanagement"></a>8.1.2. Session Management</h4>
<div class="paragraph">
<p>Spring Vault requires a <code>ClientAuthentication</code> to login and access Vault.
See <a href="#vault.core.authentication">Authentication Methods</a> on details regarding authentication.
Vault login should not occur on each authenticated Vault interaction but
must be reused throughout a session. This aspect is handled by a
<code>SessionManager</code> implementation. A <code>SessionManager</code> decides how often it
obtains a token, about revocation and renewal. Spring Vault comes with two implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SimpleSessionManager</code>: Just obtains tokens from the supplied
<code>ClientAuthentication</code> without refresh and revocation</p>
</li>
<li>
<p><code>LifecycleAwareSessionManager</code>: This <code>SessionManager</code> schedules token
renewal if a token is renewable and revoke a login token on disposal.
Renewal is scheduled with an <code>AsyncTaskExecutor</code>. <code>LifecycleAwareSessionManager</code>
is configured by default if using <code>AbstractVaultConfiguration</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vault.client-ssl"><a class="anchor" href="#vault.client-ssl"></a>8.2. Vault Client SSL configuration</h3>
<div class="paragraph">
<p>SSL can be configured using <code>SslConfiguration</code> by setting various properties.
You can set either <code>javax.net.ssl.trustStore</code> to configure
JVM-wide SSL settings or configure <code>SslConfiguration</code>
to set SSL settings only for Spring Vault.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">SslConfiguration sslConfiguration = new SslConfiguration(               <i class="conum" data-value="1"></i><b>(1)</b>
                new FileSystemResource("client-cert.jks"), "changeit",
                new FileSystemResource("truststore.jks"), "changeit");

SslConfiguration.forTrustStore(new FileSystemResource("keystore.jks"),  <i class="conum" data-value="2"></i><b>(2)</b>
                                      "changeit")

SslConfiguration.forKeyStore(new FileSystemResource("keystore.jks"),    <i class="conum" data-value="3"></i><b>(3)</b>
                                      "changeit")</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Full configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuring only trust store settings.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configuring only key store settings.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Please note that providing <code>SslConfiguration</code> can be only
applied when either Apache Http Components or the OkHttp client
is on your class-path.</p>
</div>
</div>
<div class="sect2">
<h3 id="vault.core.environment-vault-configuration"><a class="anchor" href="#vault.core.environment-vault-configuration"></a>8.3. Using <code>EnvironmentVaultConfiguration</code></h3>
<div class="paragraph">
<p>Spring Vault includes <code>EnvironmentVaultConfiguration</code> configure the Vault client from Spring&#8217;s <code>Environment</code> and a set of predefined
property keys. <code>EnvironmentVaultConfiguration</code> supports frequently applied configurations. Other configurations are supported by deriving from the most appropriate configuration class.  Include <code>EnvironmentVaultConfiguration</code> with <code>@Import(EnvironmentVaultConfiguration.class)</code> to existing
Java-based configuration classes and supply configuration properties through any of Spring&#8217;s <code>PropertySource</code>s.</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. Using EnvironmentVaultConfiguration with a property file</div>
<div class="content">
<div class="listingblock">
<div class="title">Java-based configuration class</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@PropertySource("vault.properties")
@Import(EnvironmentVaultConfiguration.class)
public class MyConfiguration{
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">vault.properties</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-properties" data-lang="properties">vault.uri=https://localhost:8200
vault.token=00000000-0000-0000-0000-000000000000</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>Property keys</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Vault URI: <code>vault.uri</code></p>
</li>
<li>
<p>SSL Configuration</p>
<div class="ulist">
<ul>
<li>
<p>Keystore resource: <code>vault.ssl.key-store</code> (optional)</p>
</li>
<li>
<p>Keystore password: <code>vault.ssl.key-store-password</code> (optional)</p>
</li>
<li>
<p>Truststore resource: <code>vault.ssl.trust-store</code> (optional)</p>
</li>
<li>
<p>Truststore password: <code>vault.ssl.trust-store-password</code> (optional)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Authentication method: <code>vault.authentication</code> (defaults to <code>TOKEN</code>, supported authentication methods are: <code>TOKEN</code>, <code>APPID</code>, <code>APPROLE</code>, <code>AWS_EC2</code>, <code>CERT</code>, <code>CUBBYHOLE</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Authentication-specific property keys</strong></p>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.token">Token authentication</a></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Vault Token: <code>vault.token</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.appid">AppId authentication</a></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>AppId: <code>vault.app-id.app-id</code></p>
</li>
<li>
<p>UserId: <code>vault.app-id.user-id</code>. <code>MAC_ADDRESS</code> and <code>IP_ADDRESS</code> use <code>MacAddressUserId</code>, respective <code>IpAddressUserId</code> user id mechanisms. Any other value is used with <code>StaticUserId</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.approle">AppRole authentication</a></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>RoleId: <code>vault.app-role.role-id</code></p>
</li>
<li>
<p>SecretId: <code>vault.app-role.secret-id</code> (optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.awsec2">AWS-EC2 authentication</a></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>RoleId: <code>vault.aws-ec2.role-id</code></p>
</li>
<li>
<p>Identity Document URL: <code>vault.aws-ec2.identity-document</code> (optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.clientcert">TLS certificate authentication</a></strong></p>
</div>
<div class="paragraph">
<p>No configuration options.</p>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.cubbyhole">Cubbyhole authentication</a></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Initial Vault Token: <code>vault.token</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="vault.core.propertysupport"><a class="anchor" href="#vault.core.propertysupport"></a>8.4. Vault Property Source Support</h3>
<div class="paragraph">
<p>Vault can be used in many different ways. One specific use-case is using
Vault to store encrypted properties. Spring Vault supports Vault as property
source to obtain configuration properties using Spring&#8217;s <a href="http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/html/beans.html#beans-property-source-abstraction">PropertySource abstraction</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can reference properties stored inside Vault in other property sources or use value injection with <code>@Value(…)</code>. Special attention is required when bootstrapping beans that require data stored inside of Vault. A <code>VaultPropertySource</code> must be initialized at that time to retrieve properties from Vault.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring Boot/Spring Cloud users can benefit from <a href="https://github.com/spring-cloud-incubator/spring-cloud-vault-config">Spring Cloud Vault</a>'s
configuration integration that initializes various property sources during application startup.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_registering_code_vaultpropertysource_code"><a class="anchor" href="#_registering_code_vaultpropertysource_code"></a>8.4.1. Registering <code>VaultPropertySource</code></h4>
<div class="paragraph">
<p>Spring Vault provides a <code>VaultPropertySource</code> to be used with Vault to obtain
properties. It uses the nested <code>data</code> element to expose properties stored and
encrypted in Vault.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">ConfigurableApplicationContext ctx = new GenericApplicationContext();
MutablePropertySources sources = ctx.getEnvironment().getPropertySources();
sources.addFirst(new VaultPropertySource(vaultTemplate, "secret/my-application"));</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the code above, <code>VaultPropertySource</code> has been added with highest precedence
in the search. If it contains a ´foo` property, it will be detected and returned
ahead of any <code>foo</code> property in any other <code>PropertySource</code>.
<code>MutablePropertySources</code> exposes a number of methods that allow for precise
manipulation of the set of property sources.</p>
</div>
</div>
<div class="sect3">
<h4 id="__vaultpropertysource"><a class="anchor" href="#__vaultpropertysource"></a>8.4.2. @VaultPropertySource</h4>
<div class="paragraph">
<p>The <code>@VaultPropertySource</code> annotation provides a convenient and declarative
mechanism for adding a <code>PropertySource</code> to Spring&#8217;s <code>Environment</code>
to be used in conjunction with <code>@Configuration</code> classes.</p>
</div>
<div class="paragraph">
<p><code>@VaultPropertySource</code> takes a Vault path such as <code>secret/my-application</code>
and exposes the data stored at the node in a <code>PropertySource</code>.
<code>@VaultPropertySource</code> supports lease renewal for secrets associated with a lease
(i. e. credentials from the <code>mysql</code> backend) and credential rotation upon terminal
lease expiration. Lease renewal is disabled by default.</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. Properties stored in Vault</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
  // …

  "data": {
    "database": {
      "password": ...
    },
    "user.name": ...,
  }

  // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 10. Declaring a <code>@VaultPropertySource</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@VaultPropertySource("secret/my-application")
public class AppConfig {

    @Autowired Environment env;

    @Bean
    public TestBean testBean() {
        TestBean testBean = new TestBean();
        testBean.setUser(env.getProperty("user.name"));
        testBean.setPassword(env.getProperty("database.password"));
        return testBean;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 11. Declaring a <code>@VaultPropertySource</code> with credential rotation and prefix</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@VaultPropertySource(value = "aws/creds/s3-access",
                     propertyNamePrefix = "aws.",
                     renewal = Renewal.ROTATE)
public class AppConfig {
  // provides aws.access_key and aws.secret_key properties
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Secrets obtained from <code>generic</code> secret backends are associated with a TTL (<code>refresh_interval</code>) but not a lease Id. Spring Vault&#8217;s <code>PropertySource</code> is not refreshing/flushing these secrets once the TTL expires despite the requested <code>Renewal</code> mode.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In certain situations, it may not be possible or practical to tightly control
property source ordering when using <code>@VaultPropertySource</code> annotations.
For example, if the <code>@Configuration</code> classes above were registered via
component-scanning, the ordering is difficult to predict.
In such cases - and if overriding is important - it is recommended that the
user fall back to using the programmatic PropertySource API.
See <a href="http://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/core/env/ConfigurableEnvironment.html"><code>ConfigurableEnvironment</code></a> and
<a href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/env/MutablePropertySources.html"><code>MutablePropertySources</code></a> for details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vault.core.executioncallback"><a class="anchor" href="#vault.core.executioncallback"></a>8.5. Execution callbacks</h3>
<div class="paragraph">
<p>One common design feature of all Spring template classes is that all functionality
is routed into one of the templates execute callback methods. This helps ensure
that exceptions and any resource management that maybe required are performed
consistency. While this was of much greater need in the case of JDBC and JMS
than with Vault, it still offers a single spot for access and logging to occur.
As such, using the execute callback is the preferred way to access the Vault API
to perform uncommon operations that we&#8217;ve not exposed as methods on <code>VaultTemplate</code>.</p>
</div>
<div class="paragraph">
<p>Here is a list of execute callback methods.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;T&gt; T</code> <strong>doWithVault</strong> <code>(RestOperationsCallback&lt;T&gt; callback)</code> Executes the given
<code>RestOperationsCallback</code>, allows to interact with Vault using  <code>RestOperations</code> without requiring a session.</p>
</li>
<li>
<p><code>&lt;T&gt; T</code> <strong>doWithSession</strong> <code>(RestOperationsCallback&lt;T&gt; callback)</code> Executes the given
<code>RestOperationsCallback</code>, allows to interact with Vault in an authenticated session.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example that uses the <code>ClientCallback</code> to initialize Vault:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">vaultOperations.doWithVault(new RestOperationsCallback&lt;VaultInitializationResponse&gt;() {

  @Override
  public VaultInitializationResponse doWithRestOperations(RestOperations restOperations) {

    ResponseEntity&lt;VaultInitializationResponse&gt; exchange = restOperations
                       .exchange("/sys/init", HttpMethod.PUT,
                                 new HttpEntity&lt;Object&gt;(request),
                                 VaultInitializationResponse.class);

    return exchange.getBody();
    }
});</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vault.core.client.support"><a class="anchor" href="#vault.core.client.support"></a>9. Client support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Vault supports a various HTTP clients to access Vault&#8217;s HTTP API. Spring Vault uses
<a href="http://docs.spring.io/spring/docs/4.3.7.RELEASE/spring-framework-reference/html/remoting.html#rest-resttemplate"><code>RestTemplate</code></a> as primary interface accessing Vault.
Dedicated client support originates from <a href="#vault.client-ssl">customized SSL configuration</a>
that is scoped only to Spring Vault&#8217;s client components.</p>
</div>
<div class="paragraph">
<p>Spring Vault supports following HTTP clients:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java&#8217;s builtin <code>HttpURLConnection</code> (default client)</p>
</li>
<li>
<p>Apache Http Components</p>
</li>
<li>
<p>Netty</p>
</li>
<li>
<p>OkHttp 2</p>
</li>
<li>
<p>OkHttp 3</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using a specific client requires the according dependency to be available on the classpath
so Spring Vault can use the available client for communicating with Vault.</p>
</div>
<div class="sect2">
<h3 id="_java_s_builtin_code_httpurlconnection_code"><a class="anchor" href="#_java_s_builtin_code_httpurlconnection_code"></a>9.1. Java&#8217;s builtin <code>HttpURLConnection</code></h3>
<div class="paragraph">
<p>Java&#8217;s builtin <code>HttpURLConnection</code> is available out-of-the-box without additional
configuration. Using <code>HttpURLConnection</code> comes with a limitation regarding SSL configuration.
Spring Vault won&#8217;t apply <a href="#vault.client-ssl">customized SSL configuration</a> as it would
require a deep reconfiguration of the JVM. This configuration would affect all
components relying on the default SSL context. Configuring SSL settings using
<code>HttpURLConnection</code> requires you providing these settings as System Properties. See
<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/JSSERefGuide.html#InstallationAndCustomization">Customizing JSSE</a> for further details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_external_clients"><a class="anchor" href="#_external_clients"></a>9.2. External Clients</h3>
<div class="paragraph">
<p>You can use external clients to access Vault&#8217;s API. Simply add one of the following
dependencies to your project. You can omit the version number if using
<a href="#dependencies">Spring Vault&#8217;s Dependency BOM</a></p>
</div>
<div class="exampleblock">
<div class="title">Example 12. Apache Http Components Dependency</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;
  &lt;artifactId&gt;httpclient&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 13. Netty Dependency</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.netty&lt;/groupId&gt;
  &lt;artifactId&gt;netty-all&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 14. Square OkHttp 2</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.squareup.okhttp&lt;/groupId&gt;
  &lt;artifactId&gt;okhttp&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 15. Square OkHttp 3</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt;
  &lt;artifactId&gt;okhttp&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vault.core.authentication"><a class="anchor" href="#vault.core.authentication"></a>10. Authentication Methods</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Different organizations have different requirements for security
and authentication. Vault reflects that need by shipping multiple authentication
methods. Spring Vault supports multiple authentications mechanisms.</p>
</div>
<div class="sect2">
<h3 id="_externalizing_login_credentials"><a class="anchor" href="#_externalizing_login_credentials"></a>10.1. Externalizing login credentials</h3>
<div class="paragraph">
<p>Obtaining first-time access to a secured system is known as secure introduction.
Any client requires ephemeral or permanent credentials to access Vault. Externalizing credentials
is a good pattern to keep code maintainability high but comes at a risk of increased disclosure.</p>
</div>
<div class="paragraph">
<p>Disclosure of login credentials to any party allows login to Vault and access secrets that
are permitted by the underlying role. Picking the appropriate client authentication and
injecting credentials into the application is subject to risk evaluation.</p>
</div>
<div class="paragraph">
<p>Spring&#8217;s <a href="http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/html/beans.html#beans-property-source-abstraction">PropertySource abstraction</a> is a natural fit
to keep configuration outside the application code. You can use system properties, environment
variables or property files to store login credentials. Each approach comes with its own properties.
Keep in mind that the command line and environment properties can be introspected with appropriate
OS access levels.</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. Externalizing <code>vault.token</code> to a properties file</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@PropertySource("configuration.properties"),
@Configuration
public class Config extends AbstractVaultConfiguration {

    @Override
    public ClientAuthentication clientAuthentication() {
        return new TokenAuthentication(getEnvironment().getProperty("vault.token"));
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring allows multiple ways to obtain <code>Environment</code>. When using <code>VaultPropertySource</code>, injection via <code>@Autowired Environment environment</code> will not provide the <code>Environment</code> as the environment bean is still in construction and autowiring comes at a later stage. Your configuration class should rather implement <code>ApplicationContextAware</code> and obtain the <code>Environment</code> from <code>ApplicationContext</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="https://github.com/spring-projects/spring-vault/blob/master/spring-vault-core/src/test/java/org/springframework/vault/demo/SecurePropertyUsage.java"><code>SecurePropertyUsage.java</code></a>
for a sample on referencing properties in components and other property sources.</p>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.token"><a class="anchor" href="#vault.authentication.token"></a>10.2. Token authentication</h3>
<div class="paragraph">
<p>Tokens are the core method for authentication within Vault.
Token authentication requires a static token to be provided.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Token authentication is the default authentication method.
If a token is disclosed an unintended party, it gains access to Vault and
can access secrets for the intended client.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {
        return new TokenAuthentication("…");
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.vaultproject.io/docs/concepts/tokens.html">Vault Documentation: Tokens</a></p>
</li>
<li>
<p><a href="https://www.vaultproject.io/docs/auth/token.html">Vault Documentation: Using the Token auth backend</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.appid"><a class="anchor" href="#vault.authentication.appid"></a>10.3. AppId authentication</h3>
<div class="paragraph">
<p>Vault supports <a href="https://www.vaultproject.io/docs/auth/app-id.html">AppId</a>
authentication that consists of two hard to guess tokens. The AppId
defaults to <code>spring.application.name</code> that is statically configured.
The second token is the UserId which is a part determined by the application,
usually related to the runtime environment. IP address, Mac address or a
Docker container name are good examples. Spring Vault supports
IP address, Mac address and static UserId&#8217;s (e.g. supplied via System properties).
The IP and Mac address are represented as Hex-encoded SHA256 hash.</p>
</div>
<div class="paragraph">
<p>IP address-based UserId&#8217;s use the local host&#8217;s IP address.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {
        AppIdAuthenticationOptions options = AppIdAuthenticationOptions.builder()
                .appId("myapp")
                .userIdMechanism(new IpAddressUserId())
                .build();

        return new AppIdAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The corresponding command to generate the IP address UserId from a command line is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ echo -n 192.168.99.1 | sha256sum</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Including the line break of <code>echo</code> leads to a different hash value
so make sure to include the <code>-n</code> flag.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mac address-based UserId&#8217;s obtain their network device from the
localhost-bound device. The configuration also allows specifying
a <code>network-interface</code> hint to pick the right device. The value of
<code>network-interface</code> is optional and can be either an interface
name or interface index (0-based).</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        AppIdAuthenticationOptions options = AppIdAuthenticationOptions.builder()
                .appId("myapp")
                .userIdMechanism(new MacAddressUserId())
                .build();

        return new AppIdAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The corresponding command to generate the Mac address UserId from a command line is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ echo -n 0AFEDE1234AC | sha256sum</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Mac address is specified uppercase and without colons.
Including the line break of <code>echo</code> leads to a different hash value
so make sure to include the <code>-n</code> flag.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_custom_userid"><a class="anchor" href="#_custom_userid"></a>10.3.1. Custom UserId</h4>
<div class="paragraph">
<p>A more advanced approach lets you implementing your own <code>AppIdUserIdMechanism</code>.
This class must be on your classpath and must implement
the <code>org.springframework.vault.authentication.AppIdUserIdMechanism</code> interface
and the <code>createUserId</code> method. Spring Vault will obtain the UserId
by calling <code>createUserId</code> each time it authenticates using AppId to
obtain a token.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">MyUserIdMechanism.java</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class MyUserIdMechanism implements AppIdUserIdMechanism {

  @Override
  public String createUserId() {

    String userId = ...
    return userId;
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See also: <a href="https://www.vaultproject.io/docs/auth/app-id.html">Vault Documentation: Using the App ID auth backend</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.approle"><a class="anchor" href="#vault.authentication.approle"></a>10.4. AppRole authentication</h3>
<div class="paragraph">
<p><a href="https://www.vaultproject.io/docs/auth/app-id.html">AppRole</a> allows machine
authentication, like the deprecated (since Vault 0.6.1) <a href="#vault.authentication.appid">AppId authentication</a>.
AppRole authentication consists of two hard to guess (secret) tokens: RoleId and SecretId.</p>
</div>
<div class="paragraph">
<p>Spring Vault supports AppRole authentication by providing either RoleId only
or together with a provided SecretId (push or pull mode).</p>
</div>
<div class="paragraph">
<p>RoleId and optionally SecretId must be provided to <code>AppRoleAuthenticationOptions</code>,
Spring Vault will not look up these or create a custom SecretId.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        AppRoleAuthenticationOptions options = AppRoleAuthenticationOptions.builder()
                .roleId("…")
                .secretId("…")
                .build();

        return new AppRoleAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See also: <a href="https://www.vaultproject.io/docs/auth/approle.html">Vault Documentation: Using the AppRole auth backend</a></p>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.awsec2"><a class="anchor" href="#vault.authentication.awsec2"></a>10.5. AWS-EC2 authentication</h3>
<div class="paragraph">
<p>The <a href="https://www.vaultproject.io/docs/auth/aws-ec2.html">aws-ec2</a>
auth backend provides a secure introduction mechanism
for AWS EC2 instances, allowing automated retrieval of a Vault
token. Unlike most Vault authentication backends, this backend
does not require first-deploying, or provisioning security-sensitive
credentials (tokens, username/password, client certificates, etc.).
Instead, it treats AWS as a Trusted Third Party and uses the
cryptographically signed dynamic metadata information that uniquely
represents each EC2 instance.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {
        return new AwsEc2Authentication(restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>AWS-EC2 authentication enables nonce by default to follow
the Trust On First Use (TOFU) principle. Any unintended party that
gains access to the PKCS#7 identity metadata can authenticate
against Vault.</p>
</div>
<div class="paragraph">
<p>During the first login, Spring Vault generates a nonce
that is stored in the auth backend aside the instance Id.
Re-authentication requires the same nonce to be sent. Any other
party does not have the nonce and can raise an alert in Vault for
further investigation.</p>
</div>
<div class="paragraph">
<p>The nonce is kept in memory and is lost during application restart.</p>
</div>
<div class="paragraph">
<p>AWS-EC2 authentication roles are optional and default to the AMI.
You can configure the authentication role by setting
it in <code>AwsEc2AuthenticationOptions</code>.</p>
</div>
<div class="paragraph">
<p>See also: <a href="https://www.vaultproject.io/docs/auth/aws-ec2.html">Vault Documentation: Using the AWS-EC2 auth backend</a></p>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.clientcert"><a class="anchor" href="#vault.authentication.clientcert"></a>10.6. TLS certificate authentication</h3>
<div class="paragraph">
<p>The <code>cert</code> auth backend allows authentication using SSL/TLS client
certificates that are either signed by a CA or self-signed.</p>
</div>
<div class="paragraph">
<p>To enable <code>cert</code> authentication you need to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use SSL, see <a href="#vault.client-ssl">Vault Client SSL configuration</a></p>
</li>
<li>
<p>Configure a Java <code>Keystore</code> that contains the client
certificate and the private key</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {
        return new ClientCertificateAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See also: <a href="https://www.vaultproject.io/docs/auth/cert.html">Vault Documentation: Using the Cert auth backend</a></p>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.cubbyhole"><a class="anchor" href="#vault.authentication.cubbyhole"></a>10.7. Cubbyhole authentication</h3>
<div class="paragraph">
<p>Cubbyhole authentication uses Vault primitives to provide a secured authentication
workflow. Cubbyhole authentication uses tokens as primary login method.
An ephemeral token is used to obtain a second, login VaultToken from Vault&#8217;s
Cubbyhole secret backend. The login token is usually longer-lived and used to
interact with Vault. The login token can be retrieved either from a wrapped
response or from the <code>data</code> section.</p>
</div>
<div class="paragraph">
<p><strong>Creating a wrapped token</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Response Wrapping for token creation requires Vault 0.6.0 or higher.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 17. Crating and storing tokens</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">$ vault token-create -wrap-ttl="10m"
Key                            Value
---                            -----
wrapping_token:                397ccb93-ff6c-b17b-9389-380b01ca2645
wrapping_token_ttl:            0h10m0s
wrapping_token_creation_time:  2016-09-18 20:29:48.652957077 +0200 CEST
wrapped_accessor:              46b6aebb-187f-932a-26d7-4f3d86a68319</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 18. Wrapped token response usage</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        CubbyholeAuthenticationOptions options = CubbyholeAuthenticationOptions
                .builder()
                .initialToken(VaultToken.of("…"))
                .wrapped()
                .build();

        return new CubbyholeAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>Using stored tokens</strong></p>
</div>
<div class="exampleblock">
<div class="title">Example 19. Crating and storing tokens</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">$ vault token-create
Key                    Value
---                    -----
token                  f9e30681-d46a-cdaf-aaa0-2ae0a9ad0819
token_accessor         4eee9bd9-81bb-06d6-af01-723c54a72148
token_duration         0s
token_renewable        false
token_policies         [root]

$ token-create -use-limit=2 -orphan -no-default-policy -policy=none
Key                    Value
---                    -----
token                  895cb88b-aef4-0e33-ba65-d50007290780
token_accessor         e84b661c-8aa8-2286-b788-f258f30c8325
token_duration         0s
token_renewable        false
token_policies         [none]

$ export VAULT_TOKEN=895cb88b-aef4-0e33-ba65-d50007290780
$ vault write cubbyhole/token token=f9e30681-d46a-cdaf-aaa0-2ae0a9ad0819</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 20. Stored token response usage</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        CubbyholeAuthenticationOptions options = CubbyholeAuthenticationOptions
                .builder()
                .initialToken(VaultToken.of("…"))
                .path("cubbyhole/token")
                .build();

        return new CubbyholeAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.vaultproject.io/docs/concepts/tokens.html">Vault Documentation: Tokens</a></p>
</li>
<li>
<p><a href="https://www.vaultproject.io/docs/secrets/cubbyhole/index.html">Vault Documentation: Cubbyhole Secret Backend</a></p>
</li>
<li>
<p><a href="https://www.vaultproject.io/docs/concepts/response-wrapping.html">Vault Documentation: Response Wrapping</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0.0.RELEASE<br>
Last updated 2017-02-16 14:18:57 MEZ
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
<script>prettyPrint()</script>
</body>
</html>