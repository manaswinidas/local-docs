<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Spring Cloud GCP Reference Documentation</title><link rel="stylesheet" type="text/css" href="css/manual-singlepage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="d0e3"></a>Spring Cloud GCP Reference Documentation</h1></div><div><div xmlns:d="http://docbook.org/ns/docbook" class="authorgroup"><h2>Authors</h2><span class="author"><span class="firstname">Jo&atilde;o</span> <span class="othername">Andr&eacute;</span> <span class="surname">Martins</span></span>, <span class="author"><span class="firstname">Jisha</span> <span class="surname">Abubaker</span></span>, <span class="author"><span class="firstname">Ray</span> <span class="surname">Tsang</span></span>, <span class="author"><span class="firstname">Mike</span> <span class="surname">Eltsufin</span></span>, <span class="author"><span class="firstname">Artem</span> <span class="surname">Bilan</span></span>, <span class="author"><span class="firstname">Andreas</span> <span class="surname">Berger</span></span>, <span class="author"><span class="firstname">Balint</span> <span class="surname">Pato</span></span>, <span class="author"><span class="firstname">Chengyuan</span> <span class="surname">Zhao</span></span></div></div><div><p class="releaseinfo">1.0.0.RELEASE</p></div><div><p class="copyright">Copyright &copy; 2017-2018 Pivotal Software, Inc.</p></div><div><div class="legalnotice"><a name="d0e94" href="#d0e94"></a><p>
		Copies of this document may be made for your own use and for distribution to
		others, provided that you do not charge any fee for such copies and further
		provided that each copy contains this Copyright Notice, whether distributed in
		print or electronically.
	</p></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="chapter"><a href="#_introduction">1. Introduction</a></span></dt><dt><span class="chapter"><a href="#_dependency_management">2. Dependency Management</a></span></dt><dt><span class="chapter"><a href="#_getting_started">3. Getting started</a></span></dt><dd><dl><dt><span class="section"><a href="#_spring_initializr">3.1. Spring Initializr</a></span></dt><dt><span class="section"><a href="#_code_samples">3.2. Code Samples</a></span></dt><dt><span class="section"><a href="#_code_challenges">3.3. Code Challenges</a></span></dt><dt><span class="section"><a href="#_getting_started_guides">3.4. Getting Started Guides</a></span></dt></dl></dd><dt><span class="chapter"><a href="#spring-cloud-gcp-core">4. Spring Cloud GCP Core</a></span></dt><dd><dl><dt><span class="section"><a href="#_project_id">4.1. Project ID</a></span></dt><dt><span class="section"><a href="#_credentials">4.2. Credentials</a></span></dt><dd><dl><dt><span class="section"><a href="#_scopes">4.2.1. Scopes</a></span></dt><dt><span class="section"><a href="#_spring_initializr_2">4.2.2. Spring Initializr</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_spring_cloud_gcp_for_pub_sub">5. Spring Cloud GCP for Pub/Sub</a></span></dt><dd><dl><dt><span class="section"><a href="#_pub_sub_operations_abstraction">5.1. Pub/Sub operations abstraction</a></span></dt><dd><dl><dt><span class="section"><a href="#_publishing_to_a_topic">5.1.1. Publishing to a topic</a></span></dt><dt><span class="section"><a href="#_subscribing_to_a_subscription">5.1.2. Subscribing to a subscription</a></span></dt><dt><span class="section"><a href="#_pulling_messages_from_a_subscription">5.1.3. Pulling messages from a subscription</a></span></dt></dl></dd><dt><span class="section"><a href="#_pub_sub_management">5.2. Pub/Sub management</a></span></dt><dd><dl><dt><span class="section"><a href="#_creating_a_topic">5.2.1. Creating a topic</a></span></dt><dt><span class="section"><a href="#_deleting_a_topic">5.2.2. Deleting a topic</a></span></dt><dt><span class="section"><a href="#_listing_topics">5.2.3. Listing topics</a></span></dt><dt><span class="section"><a href="#_creating_a_subscription">5.2.4. Creating a subscription</a></span></dt><dt><span class="section"><a href="#_deleting_a_subscription">5.2.5. Deleting a subscription</a></span></dt><dt><span class="section"><a href="#_listing_subscriptions">5.2.6. Listing subscriptions</a></span></dt></dl></dd><dt><span class="section"><a href="#pubsub-configuration">5.3. Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_spring_resources">6. Spring Resources</a></span></dt><dd><dl><dt><span class="section"><a href="#_google_cloud_storage">6.1. Google Cloud Storage</a></span></dt><dt><span class="section"><a href="#_configuration">6.2. Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_spring_jdbc">7. Spring JDBC</a></span></dt><dd><dl><dt><span class="section"><a href="#_prerequisites">7.1. Prerequisites</a></span></dt><dt><span class="section"><a href="#_spring_boot_starter_for_google_cloud_sql">7.2. Spring Boot Starter for Google Cloud SQL</a></span></dt><dd><dl><dt><span class="section"><a href="#_literal_datasource_literal_creation_flow">7.2.1. <code class="literal">DataSource</code> creation flow</a></span></dt><dt><span class="section"><a href="#_troubleshooting_tips">7.2.2. Troubleshooting tips</a></span></dt><dd><dl><dt><span class="section"><a href="#connection-issues">Connection issues</a></span></dt><dt><span class="section"><a href="#_errors_like_literal_c_g_cloud_sql_core_sslsocketfactory_re_throwing_cached_exception_due_to_attempt_to_refresh_instance_information_too_soon_after_error_literal">Errors like <code class="literal">c.g.cloud.sql.core.SslSocketFactory : Re-throwing cached exception due to attempt to refresh instance information too soon after error</code></a></span></dt><dt><span class="section"><a href="#_postgresql_literal_java_net_socketexception_already_connected_literal_issue">PostgreSQL: <code class="literal">java.net.SocketException: already connected</code> issue</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="chapter"><a href="#_spring_integration">8. Spring Integration</a></span></dt><dd><dl><dt><span class="section"><a href="#_channel_adapters_for_google_cloud_pub_sub">8.1. Channel Adapters for Google Cloud Pub/Sub</a></span></dt><dd><dl><dt><span class="section"><a href="#_inbound_channel_adapter">8.1.1. Inbound channel adapter</a></span></dt><dt><span class="section"><a href="#_outbound_channel_adapter">8.1.2. Outbound channel adapter</a></span></dt><dt><span class="section"><a href="#_header_mapping">8.1.3. Header mapping</a></span></dt></dl></dd><dt><span class="section"><a href="#_channel_adapters_for_google_cloud_storage">8.2. Channel Adapters for Google Cloud Storage</a></span></dt><dd><dl><dt><span class="section"><a href="#_inbound_channel_adapter_2">8.2.1. Inbound channel adapter</a></span></dt><dt><span class="section"><a href="#_inbound_streaming_channel_adapter">8.2.2. Inbound streaming channel adapter</a></span></dt><dt><span class="section"><a href="#_outbound_channel_adapter_2">8.2.3. Outbound channel adapter</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_spring_cloud_stream">9. Spring Cloud Stream</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview">9.1. Overview</a></span></dt><dt><span class="section"><a href="#_configuration_2">9.2. Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_spring_cloud_sleuth">10. Spring Cloud Sleuth</a></span></dt><dd><dl><dt><span class="section"><a href="#_tracing">10.1. Tracing</a></span></dt><dt><span class="section"><a href="#_spring_boot_starter_for_stackdriver_trace">10.2. Spring Boot Starter for Stackdriver Trace</a></span></dt><dt><span class="section"><a href="#_integration_with_logging">10.3. Integration with Logging</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_stackdriver_logging_support">11. Stackdriver Logging Support</a></span></dt><dd><dl><dt><span class="section"><a href="#_web_mvc_interceptor">11.1. Web MVC Interceptor</a></span></dt><dt><span class="section"><a href="#_logback_support">11.2. Logback Support</a></span></dt><dd><dl><dt><span class="section"><a href="#_log_via_api">11.2.1. Log via API</a></span></dt><dt><span class="section"><a href="#_log_via_console">11.2.2. Log via Console</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_cloud_foundry">12. Cloud Foundry</a></span></dt></dl></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_introduction" href="#_introduction"></a>1.&nbsp;Introduction</h1></div></div></div><p>The Spring Cloud GCP project aims at making the Spring Framework a first-class citizen of Google
Cloud Platform (GCP).</p><p>Currently, Spring Cloud GCP lets you leverage the power and simplicity of the Spring framework to:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Publish and subscribe from Google Cloud Pub/Sub topics</li><li class="listitem">Configure Spring JDBC with a few properties to use Google Cloud SQL</li><li class="listitem">Write and read from Spring Resources backed up by Google Cloud Storage</li><li class="listitem">Exchange messages with Spring Integration using Google Cloud Pub/Sub on the background</li><li class="listitem">Trace the execution of your app with Spring Cloud Sleuth and Google Stackdriver Trace</li><li class="listitem">Consume and produce Google Cloud Storage data via Spring Integration GCS Channel Adapters</li></ol></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_dependency_management" href="#_dependency_management"></a>2.&nbsp;Dependency Management</h1></div></div></div><p>The Spring Cloud GCP Bill of Materials (BOM) contains the versions of all the dependencies it uses.</p><p>If you&#8217;re a Maven user, adding the following to your pom.xml file will allow you to not specify any
Spring Cloud GCP dependency versions.
Instead, the version of the BOM you&#8217;re using determines the versions of the used dependencies.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependencyManagement&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependencies&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-dependencies<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>1.0.0.RELEASE<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;type&gt;</span>pom<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/type&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;scope&gt;</span>import<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/scope&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependencies&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependencyManagement&gt;</span></pre><p>In the following sections, it will be assumed you are using the Spring Cloud GCP BOM and the
dependency snippets will not contain versions.</p><p>Gradle users can achieve the same kind of BOM experience using Spring&#8217;s
<a class="link" href="https://github.com/spring-gradle-plugins/dependency-management-plugin" target="_top">dependency-management-plugin</a>
Gradle plugin.
For simplicity, the Gradle dependency snippets in the remainder of this document will also
omit their versions.</p></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_getting_started" href="#_getting_started"></a>3.&nbsp;Getting started</h1></div></div></div><p>There are many available resources to get you up to speed with our libraries as quickly as possible.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_spring_initializr" href="#_spring_initializr"></a>3.1&nbsp;Spring Initializr</h2></div></div></div><p>There are three entries in <a class="link" href="http://start.spring.io/" target="_top">Spring Initializr</a> for Spring Cloud GCP:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">GCP Support</li><li class="listitem">GCP Messaging</li><li class="listitem">GCP Storage</li></ul></div><p>The GCP Support entry contains auto-configuration support for every Spring Cloud GCP integration.
Most of the autoconfiguration code is only enabled if other dependencies are added to the classpath.</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Spring Cloud GCP Starter</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Required dependencies</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Logging</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>org.springframework.cloud:spring-cloud-gcp-starter-logging</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SQL - MySql</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>org.springframework.cloud:spring-cloud-gcp-starter-sql-mysql</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SQL - PostgreSQL</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>org.springframework.cloud:spring-cloud-gcp-starter-sql-postgres</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Trace</p></td><td style="" align="left" valign="top"><p>org.springframework.cloud:spring-cloud-gcp-starter-trace</p></td></tr></tbody></table></div><p>The GCP Messaging entry adds the GCP Support entry and all the required dependencies so that the Google Cloud Pub/Sub integrations work out of the box.</p><p>The GCP Storage entry adds the GCP Support entry and all the required dependencies so that the Google Cloud Storage integrations work out of the box.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_code_samples" href="#_code_samples"></a>3.2&nbsp;Code Samples</h2></div></div></div><p>There are <a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples" target="_top">code samples</a> available that demonstrate the usage of all our integrations.
<a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-vision-api-sample" target="_top">The Vision API sample</a> shows how to use <code class="literal">spring-cloud-gcp-starter</code> for authentication.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_code_challenges" href="#_code_challenges"></a>3.3&nbsp;Code Challenges</h2></div></div></div><p>In a code challenge, you perform a task step by step, using one integration.
There are a number of challenges available in the <a class="link" href="https://codelabs.developers.google.com/spring" target="_top">Google Developers Codelabs</a> page.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_getting_started_guides" href="#_getting_started_guides"></a>3.4&nbsp;Getting Started Guides</h2></div></div></div><p>A Spring Getting Started guide on messaging with Spring Integration Channel Adapters for Google Cloud Pub/Sub is available from <a class="link" href="https://spring.io/guides/gs/messaging-gcp-pubsub/" target="_top">Spring Guides</a>.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="spring-cloud-gcp-core" href="#spring-cloud-gcp-core"></a>4.&nbsp;Spring Cloud GCP Core</h1></div></div></div><p>At the center of every Spring Cloud GCP module are the concepts of <code class="literal">GcpProjectIdProvider</code> and <code class="literal">CredentialsProvider</code>.</p><p>Spring Cloud GCP provides a Spring Boot starter to auto-configure the core components.</p><p>Maven coordinates, using Spring Cloud GCP BOM:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-starter<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p>Gradle coordinates:</p><pre class="screen">dependencies {
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-starter'
}</pre><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_project_id" href="#_project_id"></a>4.1&nbsp;Project ID</h2></div></div></div><p><code class="literal">GcpProjectIdProvider</code> is a functional interface that returns a GCP project ID string.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">interface</span> GcpProjectIdProvider {
	String getProjectId();
}</pre><p>The Spring Cloud GCP starter auto-configures a <code class="literal">GcpProjectIdProvider</code>.
If a <code class="literal">spring.cloud.gcp.project-id</code> property is specified, the provided <code class="literal">GcpProjectIdProvider</code> returns that property value.</p><pre class="programlisting">spring.cloud.gcp.project-id=my-gcp-project-id</pre><p>Otherwise, the project ID is discovered based on a
<a class="link" href="https://googlecloudplatform.github.io/google-cloud-java/latest/apidocs/com/google/cloud/ServiceOptions.html#getDefaultProjectId-" target="_top">set of rules</a>:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">The project ID specified by the <code class="literal">GOOGLE_CLOUD_PROJECT</code> environment variable</li><li class="listitem">The Google App Engine project ID</li><li class="listitem">The project ID specified in the JSON credentials file pointed by the
<code class="literal">GOOGLE_APPLICATION_CREDENTIALS</code> environment variable</li><li class="listitem">The Google Cloud SDK project ID</li><li class="listitem">The Google Compute Engine project ID, from the Google Compute Engine Metadata Server</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_credentials" href="#_credentials"></a>4.2&nbsp;Credentials</h2></div></div></div><p><code class="literal">CredentialsProvider</code> is a functional interface that returns the credentials to authenticate and
authorize calls to Google Cloud Client Libraries.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">interface</span> CredentialsProvider {
  Credentials getCredentials() <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> IOException;
}</pre><p>The Spring Cloud GCP starter auto-configures a <code class="literal">CredentialsProvider</code>.
It uses the <code class="literal">spring.cloud.gcp.credentials.location</code> property to locate the OAuth2 private key of a Google service account.
Keep in mind this property is a Spring Resource, so the credentials file can be obtained from a number of <a class="link" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/resources.html#resources-implementations" target="_top">different locations</a> such as the file system, classpath, URL, etc.
The next example specifies the credentials location property in the file system.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">spring.cloud.gcp.credentials.location</span>=file:/usr/local/key.json</pre><p>Alternatively, you can set the credentials by directly specifying the <code class="literal">spring.cloud.gcp.credentials.encoded-key</code> property.
The value should be the base64-encoded account private key in JSON format.</p><p>If that credentials aren&#8217;t specified through properties, the starter tries to discover credentials from a <a class="link" href="https://github.com/GoogleCloudPlatform/google-cloud-java#authentication" target="_top">number of places</a>:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Credentials file pointed to by the <code class="literal">GOOGLE_APPLICATION_CREDENTIALS</code> environment variable</li><li class="listitem">Credentials provided by the Google Cloud SDK <code class="literal">gcloud auth application-default login</code> command</li><li class="listitem">Google App Engine built-in credentials</li><li class="listitem">Google Cloud Shell built-in credentials</li><li class="listitem">Google Compute Engine built-in credentials</li></ol></div><p>If your app is running on Google App Engine or Google Compute Engine, in most cases, you should omit
the <code class="literal">spring.cloud.gcp.credentials.location</code> property and, instead, let the Spring Cloud GCP
Starter get the correct credentials for those environments.
On App Engine Standard, the
<a class="link" href="https://cloud.google.com/appengine/docs/standard/java/appidentity/" target="_top">App Identity service account credentials</a>
are used, on App Engine Flexible, the
<a class="link" href="https://cloud.google.com/appengine/docs/flexible/java/service-account" target="_top">Flexible service account credential</a>
are used and on Google Compute Engine, the
<a class="link" href="https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances#using_the_compute_engine_default_service_account" target="_top">Compute Engine Default Service Account</a>
is used.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_scopes" href="#_scopes"></a>4.2.1&nbsp;Scopes</h3></div></div></div><p>By default, the credentials provided by the Spring Cloud GCP Starter contain scopes for every
service supported by Spring Cloud GCP.</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Service</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Scope</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Pub/Sub</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://www.googleapis.com/auth/pubsub" target="_top">https://www.googleapis.com/auth/pubsub</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Storage (Read Only)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://www.googleapis.com/auth/devstorage.read_only" target="_top">https://www.googleapis.com/auth/devstorage.read_only</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Storage (Write/Write)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://www.googleapis.com/auth/devstorage.read_write" target="_top">https://www.googleapis.com/auth/devstorage.read_write</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Runtime Config</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://www.googleapis.com/auth/cloudruntimeconfig" target="_top">https://www.googleapis.com/auth/cloudruntimeconfig</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Trace (Append)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://www.googleapis.com/auth/trace.append" target="_top">https://www.googleapis.com/auth/trace.append</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Cloud Platform</p></td><td style="" align="left" valign="top"><p><a class="link" href="https://www.googleapis.com/auth/cloud-platform" target="_top">https://www.googleapis.com/auth/cloud-platform</a></p></td></tr></tbody></table></div><p>The Spring Cloud GCP starter allows you to configure a custom scope list for the provided
credentials.
To do that, specify a comma-delimited list of <a class="link" href="https://developers.google.com/identity/protocols/googlescopes" target="_top">Google OAuth2 scopes</a>
in the <code class="literal">spring.cloud.gcp.credentials.scopes</code> property.</p><p><code class="literal">spring.cloud.gcp.credentials.scopes</code> is a comma-delimited list of
<a class="link" href="https://developers.google.com/identity/protocols/googlescopes" target="_top">Google OAuth2 scopes</a> for Google
Cloud Platform services that the credentials returned by the provided <code class="literal">CredentialsProvider</code> support.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">spring.cloud.gcp.credentials.scopes</span>=https://www.googleapis.com/auth/pubsub,https://www.googleapis.com/auth/sqlservice.admin</pre><p>You can also use <code class="literal">DEFAULT_SCOPES</code> placeholder as a scope to represent the starters default scopes,
and append the additional scopes you need to add.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">spring.cloud.gcp.credentials.scopes</span>=DEFAULT_SCOPES,https://www.googleapis.com/auth/cloud-vision</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_spring_initializr_2" href="#_spring_initializr_2"></a>4.2.2&nbsp;Spring Initializr</h3></div></div></div><p>This starter is available from <a class="link" href="http://start.spring.io/" target="_top">Spring Initializr</a> through the <code class="literal">GCP Support</code> entry.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_spring_cloud_gcp_for_pub_sub" href="#_spring_cloud_gcp_for_pub_sub"></a>5.&nbsp;Spring Cloud GCP for Pub/Sub</h1></div></div></div><p>Spring Cloud GCP provides an abstraction layer to publish to and subscribe from Google Cloud
Pub/Sub topics and to create, list or delete Google Cloud Pub/Sub topics and subscriptions.</p><p>A Spring Boot starter is provided to auto-configure the various required Pub/Sub components.</p><p>Maven coordinates, using Spring Cloud GCP BOM:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-starter-pubsub<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p>Gradle coordinates:</p><pre class="screen">dependencies {
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-starter-pubsub'
}</pre><p>This starter is also available from <a class="link" href="https://start.spring.io" target="_top">Spring Initializr</a> through the <code class="literal">GCP Messaging</code> entry.</p><p>A <a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-pubsub-sample" target="_top">sample application</a> is available.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_pub_sub_operations_abstraction" href="#_pub_sub_operations_abstraction"></a>5.1&nbsp;Pub/Sub operations abstraction</h2></div></div></div><p><code class="literal">PubSubOperations</code> is an abstraction that allows Spring users to use Google Cloud Pub/Sub without
depending on any Google Cloud Pub/Sub API semantics.
It provides the common set of operations needed to interact with Google Cloud Pub/Sub.
<code class="literal">PubSubTemplate</code> is the default implementation of <code class="literal">PubSubOperations</code> and it uses the
<a class="link" href="https://github.com/GoogleCloudPlatform/google-cloud-java/tree/master/google-cloud-pubsub" target="_top">Google Cloud Java Client for Pub/Sub</a>
to interact with Google Cloud Pub/Sub.</p><p><code class="literal">PubSubTemplate</code> depends on a <code class="literal">PublisherFactory</code> and a <code class="literal">SubscriberFactory</code>.
The <code class="literal">PublisherFactory</code> provides a Google Cloud Java Client for Pub/Sub <code class="literal">Publisher</code>.
The <code class="literal">SubscriberFactory</code> provides the <code class="literal">Subscriber</code> for asynchronous message pulling, as well as a <code class="literal">SubscriberStub</code> for synchronous pulling and an <code class="literal">Acknowledger</code>, for the cases where messages are automatically acknowledged.
The Spring Boot starter for GCP Pub/Sub auto-configures a <code class="literal">PublisherFactory</code> and <code class="literal">SubscriberFactory</code> with default settings and uses the <code class="literal">GcpProjectIdProvider</code> and <code class="literal">CredentialsProvider</code> auto-configured by the Spring Boot GCP starter.</p><p>The <code class="literal">PublisherFactory</code> implementation provided by Spring Cloud GCP Pub/Sub, <code class="literal">DefaultPublisherFactory</code>, caches <code class="literal">Publisher</code> instances by topic name, in order to optimize resource utilization.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_publishing_to_a_topic" href="#_publishing_to_a_topic"></a>5.1.1&nbsp;Publishing to a topic</h3></div></div></div><p><code class="literal">PubSubTemplate</code> provides asynchronous methods to publish messages to a Google Cloud Pub/Sub topic.
The <code class="literal">publish()</code> method takes in a topic name to post the message to, a payload of a generic type and, optionally, a map with the message headers.</p><p>Here is an example of how to publish a message to a Google Cloud Pub/Sub topic:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> publishMessage() {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.pubSubTemplate.publish(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"topic"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"your message payload"</span>, ImmutableMap.of(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"key1"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"val1"</span>));
}</pre><p>By default, the <code class="literal">SimplePubSubMessageConverter</code> is used to convert payloads of type <code class="literal">byte[]</code>, <code class="literal">ByteString</code>, <code class="literal">ByteBuffer</code>, and <code class="literal">String</code> to Pub/Sub messages.</p><p>For serialization and deserialization of POJOs using Jackson JSON, configure the <code class="literal">PubSubTemplate</code> to use the <code class="literal">JacksonPubSubMessageConverter</code> by calling the <code class="literal">setMessageConverter()</code> method.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_subscribing_to_a_subscription" href="#_subscribing_to_a_subscription"></a>5.1.2&nbsp;Subscribing to a subscription</h3></div></div></div><p>Google Cloud Pub/Sub allows many subscriptions to be associated to the same topic.
<code class="literal">PubSubTemplate</code> allows you to subscribe to subscriptions via the <code class="literal">subscribe()</code> method.
It relies on a <code class="literal">SubscriberFactory</code> object, whose only task is to generate Google Cloud Pub/Sub
<code class="literal">Subscriber</code> objects.
When subscribing to a subscription, messages will be pulled from Google Cloud Pub/Sub
asynchronously, on a certain interval.</p><p>The Spring Boot starter for Google Cloud Pub/Sub auto-configures a <code class="literal">SubscriberFactory</code>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_pulling_messages_from_a_subscription" href="#_pulling_messages_from_a_subscription"></a>5.1.3&nbsp;Pulling messages from a subscription</h3></div></div></div><p>Google Cloud Pub/Sub supports synchronous pulling of messages from a subscription.
This is different from subscribing to a subscription, in the sense that subscribing is an
asynchronous task which polls the subscription on a set interval.</p><p>The <code class="literal">pullNext()</code> method allows for a single message to be pulled and automatically acknowledged from a subscription.
The <code class="literal">pull()</code> method pulls a number of messages from a subscription, allowing for the retry settings to be configured.
Any messages received by <code class="literal">pull()</code> are not automatically acknowledged.
Instead, since they are of the kind <code class="literal">AcknowledgeablePubsubMessage</code>, you can acknowledge them by calling the <code class="literal">ack()</code> method, or negatively acknowledge them by calling the <code class="literal">nack()</code> method.
The <code class="literal">pullAndAck()</code> method does the same as the <code class="literal">pull()</code> method and, additionally, acknowledges all received messages.</p><p>To acknowledge multiple messages received from <code class="literal">pull()</code> at once, you can use the <code class="literal">PubSubTemplate.ack()</code> method.
You can also use the <code class="literal">PubSubTemplate.nack()</code> for negatively acknowledging messages.
Using these methods for acknowledging messages in batches is more efficient than acknowledging messages individually.</p><p><code class="literal">PubSubTemplate</code> uses a special subscriber generated by its <code class="literal">SubscriberFactory</code> to synchronously pull messages.</p><p>If the message payload contains a serialized POJO, it can be retrieved as a <code class="literal">Class</code> compatible with that serialized payload:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.pubSubTemplate.getMessageConverter().fromMessage(message, MyPojo.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_pub_sub_management" href="#_pub_sub_management"></a>5.2&nbsp;Pub/Sub management</h2></div></div></div><p><code class="literal">PubSubAdmin</code> is the abstraction provided by Spring Cloud GCP to manage Google Cloud Pub/Sub
resources.
It allows for the creation, deletion and listing of topics and subscriptions.</p><p><code class="literal">PubSubAdmin</code> depends on <code class="literal">GcpProjectIdProvider</code> and either a <code class="literal">CredentialsProvider</code> or a
<code class="literal">TopicAdminClient</code> and a <code class="literal">SubscriptionAdminClient</code>.
If given a <code class="literal">CredentialsProvider</code>, it creates a <code class="literal">TopicAdminClient</code> and a <code class="literal">SubscriptionAdminClient</code>
with the Google Cloud Java Library for Pub/Sub default settings.
The Spring Boot starter for GCP Pub/Sub auto-configures a <code class="literal">PubSubAdmin</code> object using the
<code class="literal">GcpProjectIdProvider</code> and the <code class="literal">CredentialsProvider</code> auto-configured by the Spring Boot GCP Core
starter.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_creating_a_topic" href="#_creating_a_topic"></a>5.2.1&nbsp;Creating a topic</h3></div></div></div><p><code class="literal">PubSubAdmin</code> implements a method to create topics:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> Topic createTopic(String topicName)</pre><p>Here is an example of how to create a Google Cloud Pub/Sub topic:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> newTopic() {
    pubSubAdmin.createTopic(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"topicName"</span>);
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_deleting_a_topic" href="#_deleting_a_topic"></a>5.2.2&nbsp;Deleting a topic</h3></div></div></div><p><code class="literal">PubSubAdmin</code> implements a method to delete topics:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> deleteTopic(String topicName)</pre><p>Here is an example of how to delete a Google Cloud Pub/Sub topic:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> deleteTopic() {
    pubSubAdmin.deleteTopic(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"topicName"</span>);
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_listing_topics" href="#_listing_topics"></a>5.2.3&nbsp;Listing topics</h3></div></div></div><p><code class="literal">PubSubAdmin</code> implements a method to list topics:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> List&lt;Topic&gt; listTopics</pre><p>Here is an example of how to list every Google Cloud Pub/Sub topic name in a project:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> List&lt;String&gt; listTopics() {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> pubSubAdmin
        .listTopics()
        .stream()
        .map(Topic::getNameAsTopicName)
        .map(TopicName::getTopic)
        .collect(Collectors.toList());
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_creating_a_subscription" href="#_creating_a_subscription"></a>5.2.4&nbsp;Creating a subscription</h3></div></div></div><p><code class="literal">PubSubAdmin</code> implements a method to create subscriptions to existing topics:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> Subscription createSubscription(String subscriptionName, String topicName, Integer ackDeadline, String pushEndpoint)</pre><p>Here is an example of how to create a Google Cloud Pub/Sub subscription:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> newSubscription() {
    pubSubAdmin.createSubscription(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"subscriptionName"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"topicName"</span>, <span class="hl-number">10</span>, &#8220;http:<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//my.endpoint/push&#8221;);</span>
}</pre><p>Alternative methods with default settings are provided for ease of use.
The default value for <code class="literal">ackDeadline</code> is 10 seconds.
If <code class="literal">pushEndpoint</code> isn&#8217;t specified, the subscription uses message pulling, instead.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> Subscription createSubscription(String subscriptionName, String topicName)</pre><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> Subscription createSubscription(String subscriptionName, String topicName, Integer ackDeadline)</pre><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> Subscription createSubscription(String subscriptionName, String topicName, String pushEndpoint)</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_deleting_a_subscription" href="#_deleting_a_subscription"></a>5.2.5&nbsp;Deleting a subscription</h3></div></div></div><p><code class="literal">PubSubAdmin</code> implements a method to delete subscriptions:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> deleteSubscription(String subscriptionName)</pre><p>Here is an example of how to delete a Google Cloud Pub/Sub subscription:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> deleteSubscription() {
    pubSubAdmin.deleteSubscription(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"subscriptionName"</span>);
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_listing_subscriptions" href="#_listing_subscriptions"></a>5.2.6&nbsp;Listing subscriptions</h3></div></div></div><p><code class="literal">PubSubAdmin</code> implements a method to list subscriptions:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> List&lt;Subscription&gt; listSubscriptions()</pre><p>Here is an example of how to list every subscription name in a project:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> List&lt;String&gt; listSubscriptions() {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> pubSubAdmin
        .listSubscriptions()
        .stream()
        .map(Subscription::getNameAsSubscriptionName)
        .map(SubscriptionName::getSubscription)
        .collect(Collectors.toList());
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pubsub-configuration" href="#pubsub-configuration"></a>5.3&nbsp;Configuration</h2></div></div></div><p>The Spring Boot starter for Google Cloud Pub/Sub provides the following configuration options:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Description</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Default value</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.enabled</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enables or disables Pub/Sub auto-configuration</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.subscriber.executor-threads</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Number of threads used by <code class="literal">Subscriber</code>
instances created by <code class="literal">SubscriberFactory</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.publisher.executor-threads</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Number of threads used by <code class="literal">Publisher</code>
instances created by <code class="literal">PublisherFactory</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.project-id</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GCP project ID where the Google Cloud Pub/Sub API
is hosted, if different from the one in the <a class="link" href="#spring-cloud-gcp-core" title="4.&nbsp;Spring Cloud GCP Core">Spring Cloud GCP Core Module</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.credentials.location</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>OAuth2 credentials for authenticating with the
Google Cloud Pub/Sub API, if different from the ones in the
<a class="link" href="#spring-cloud-gcp-core" title="4.&nbsp;Spring Cloud GCP Core">Spring Cloud GCP Core Module</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.credentials.encoded-key</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Base64-encoded contents of OAuth2 account private key for authenticating with the
Google Cloud Pub/Sub API, if different from the ones in the
<a class="link" href="#spring-cloud-gcp-core" title="4.&nbsp;Spring Cloud GCP Core">Spring Cloud GCP Core Module</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.credentials.scopes</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://developers.google.com/identity/protocols/googlescopes" target="_top">OAuth2 scope</a> for Spring Cloud GCP
Pub/Sub credentials</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://www.googleapis.com/auth/pubsub" target="_top">https://www.googleapis.com/auth/pubsub</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.subscriber.parallel-pull-count</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The number of pull workers</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The available number of processors</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.subscriber.max-ack-extension-period</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The maximum period a message ack deadline will be extended, in seconds</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.subscriber.pull-endpoint</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The endpoint for synchronous pulling messages</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pubsub.googleapis.com:443</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.[subscriber,publisher].retry.total-timeout-seconds</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>TotalTimeout has ultimate control over how long the logic should keep trying the remote call until it gives up completely. The higher the total timeout, the more retries can be
attempted.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.[subscriber,publisher].retry.initial-retry-delay-second</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>InitialRetryDelay controls the delay before the first retry. Subsequent retries will use this
value adjusted according to the RetryDelayMultiplier.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.[subscriber,publisher].retry.retry-delay-multiplier</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>RetryDelayMultiplier controls the change in retry delay. The retry delay of the previous call
is multiplied by the RetryDelayMultiplier to calculate the retry delay for the next call.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.[subscriber,publisher].retry.max-retry-delay-seconds</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MaxRetryDelay puts a limit on the value of the retry delay, so that the RetryDelayMultiplier
can&#8217;t increase the retry delay higher than this amount.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.[subscriber,publisher].retry.max-attempts</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MaxAttempts defines the maximum number of attempts to perform.
If this value is greater than 0, and the number of attempts reaches this limit, the logic will
give up retrying even if the total retry time is still lower than TotalTimeout.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.[subscriber,publisher].retry.jittered</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Jitter determines if the delay time should be randomized.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.[subscriber,publisher].retry.initial-rpc-timeout-seconds</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>InitialRpcTimeout controls the timeout for the initial RPC. Subsequent calls will use this
value adjusted according to the RpcTimeoutMultiplier.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.[subscriber,publisher].retry.rpc-timeout-multiplier</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>RpcTimeoutMultiplier controls the change in RPC timeout. The timeout of the previous call is
multiplied by the RpcTimeoutMultiplier to calculate the timeout for the next call.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.[subscriber,publisher].retry.max-rpc-timeout-seconds</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MaxRpcTimeout puts a limit on the value of the RPC timeout, so that the RpcTimeoutMultiplier
can&#8217;t increase the RPC timeout higher than this amount.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.[subscriber,publisher.batching].flow-control.max-outstanding-element-count</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Maximum number of outstanding elements to keep in memory before enforcing flow control.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>unlimited</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.[subscriber,publisher.batching].flow-control.max-outstanding-request-bytes</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Maximum number of outstanding bytes to keep in memory before enforcing flow control.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>unlimited</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.[subscriber,publisher.batching].flow-control.limit-exceeded-behavior</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The behavior when the specified limits are exceeded.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Block</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.publisher.batching.element-count-threshold</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The element count threshold to use for batching.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>unset (threshold does not apply)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.publisher.batching.request-byte-threshold</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The request byte threshold to use for batching.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>unset (threshold does not apply)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.publisher.batching.delay-threshold-seconds</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The delay threshold to use for batching. After this amount of time has elapsed (counting
from the first element added), the elements will be wrapped up in a batch and sent.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>unset (threshold does not apply)</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.pubsub.publisher.batching.enabled</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Enables batching.</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="" align="left" valign="top"><p>false</p></td></tr></tbody></table></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_spring_resources" href="#_spring_resources"></a>6.&nbsp;Spring Resources</h1></div></div></div><p><a class="link" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/resources.html" target="_top">Spring Resources</a>
are an abstraction for a number of low-level resources, such as file system files, classpath files,
servlet context-relative files, etc.
Spring Cloud GCP adds a new resource type: a Google Cloud Storage (GCS) object.</p><p>A Spring Boot starter is provided to auto-configure the various Storage components.</p><p>Maven coordinates, using Spring Cloud GCP BOM:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-starter-storage<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p>Gradle coordinates:</p><pre class="screen">dependencies {
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-starter-storage'
}</pre><p>This starter is also available from <a class="link" href="https://start.spring.io/" target="_top">Spring Initializr</a> through the <code class="literal">GCP Storage</code> entry.</p><p>A <a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-storage-resource-sample" target="_top">sample application</a> is available.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_google_cloud_storage" href="#_google_cloud_storage"></a>6.1&nbsp;Google Cloud Storage</h2></div></div></div><p>The Spring Resource Abstraction for Google Cloud Storage allows GCS objects to be accessed by their
GCS URL using the <code class="literal">@Value</code> annotation</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Value("gs://[YOUR_GCS_BUCKET]/[GCS_FILE_NAME]")</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">private</span> Resource gcsResource;</pre><p>or the Spring application context</p><pre class="programlisting">SpringApplication.run(...).getResource(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"gs://[YOUR_GCS_BUCKET]/[GCS_FILE_NAME]"</span>);</pre><p>This creates a <code class="literal">Resource</code> object that can be used to read the object, among
<a class="link" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/resources.html#resources-resource" target="_top">other possible operations</a>.</p><p>It is also possible to write to a <code class="literal">Resource</code>, although a <code class="literal">WriteableResource</code> is required.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Value("gs://[YOUR_GCS_BUCKET]/[GCS_FILE_NAME]")</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">private</span> Resource gcsResource;
...
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">try</span> (OutputStream os = ((WritableResource) gcsResource).getOutputStream()) {
  os.write(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"foo"</span>.getBytes());
}</pre><p>If the resource path refers to an object on Google Cloud Storage (as opposed to a bucket), then the resource
can be cast as a <code class="literal">GoogleStorageResourceObject</code> and the <code class="literal">getGoogleStorageObject</code> method can be called
to obtain a <a class="link" href="https://github.com/GoogleCloudPlatform/google-cloud-java/blob/master/google-cloud-storage/src/main/java/com/google/cloud/storage/Blob.java" target="_top"><code class="literal">Blob</code></a>.
This type represents a GCS file, which has associated <a class="link" href="https://cloud.google.com/storage/docs/gsutil/addlhelp/WorkingWithObjectMetadata" target="_top">metadata</a>, such as content-type, that can be set.
The <code class="literal">createSignedUrl</code> method can also be used to obtain <a class="link" href="https://cloud.google.com/storage/docs/access-control/signed-urls" target="_top">signed URLs</a> for GCS objects.
However, creating signed URLs requires that the resource was created using service account credentials.</p><p>The Spring Boot Starter for Google Cloud Storage auto-configures the <code class="literal">Storage</code> bean required by the
<code class="literal">spring-cloud-gcp-storage</code> module, based on the <code class="literal">CredentialsProvider</code> provided by the Spring Boot
GCP starter.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_configuration" href="#_configuration"></a>6.2&nbsp;Configuration</h2></div></div></div><p>The Spring Boot Starter for Google Cloud Storage provides the following configuration options:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Description</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Default value</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.storage.auto-create-files</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Creates files and buckets on Google Cloud Storage
when writes are made to non-existent files</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.storage.credentials.location</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>OAuth2 credentials for authenticating with the
Google Cloud Storage API, if different from the ones in the
<a class="link" href="#spring-cloud-gcp-core" title="4.&nbsp;Spring Cloud GCP Core">Spring Cloud GCP Core Module</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.storage.credentials.encoded-key</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Base64-encoded contents of OAuth2 account private key for authenticating with the
Google Cloud Storage API, if different from the ones in the
<a class="link" href="#spring-cloud-gcp-core" title="4.&nbsp;Spring Cloud GCP Core">Spring Cloud GCP Core Module</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.storage.credentials.scopes</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://developers.google.com/identity/protocols/googlescopes" target="_top">OAuth2 scope</a> for Spring Cloud GCP
Storage credentials</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="" align="left" valign="top"><p><a class="link" href="https://www.googleapis.com/auth/devstorage.read_write" target="_top">https://www.googleapis.com/auth/devstorage.read_write</a></p></td></tr></tbody></table></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_spring_jdbc" href="#_spring_jdbc"></a>7.&nbsp;Spring JDBC</h1></div></div></div><p>Spring Cloud GCP adds integrations with
<a class="link" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/jdbc.html" target="_top">Spring JDBC</a>
so you can run your MySQL or PostgreSQL databases in Google Cloud SQL using Spring JDBC, or other
libraries that depend on it like Spring Data JPA.</p><p>The Cloud SQL support is provided by Spring Cloud GCP in the form of two Spring Boot starters, one
for MySQL and another one for PostgreSQL.
The role of the starters is to read configuration from properties and assume default settings so
that user experience connecting to MySQL and PostgreSQL is as simple as possible.</p><p>Maven coordinates, using Spring Cloud GCP BOM:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-starter-sql-mysql<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-starter-sql-postgresql<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p>Gradle coordinates:</p><pre class="screen">dependencies {
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-starter-sql-mysql'
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-starter-sql-postgresql'
}</pre><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_prerequisites" href="#_prerequisites"></a>7.1&nbsp;Prerequisites</h2></div></div></div><p>In order to use the Spring Boot Starters for Google Cloud SQL, the Google Cloud SQL API must be
enabled in your GCP project.</p><p>To do that, go to the
<a class="link" href="https://console.cloud.google.com/apis/library" target="_top">API library page</a> of the Google Cloud Console, search
for "Cloud SQL API", click the first result and enable the API.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>There are several similar "Cloud SQL" results. You must access the "Google Cloud SQL API" one
and enable the API from there.</p></td></tr></table></div><p>Available sample applications:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-sql-sample" target="_top">Spring Cloud GCP SQL</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-data-jpa-sample" target="_top">Spring Data JPA with Spring Cloud GCP SQL</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_spring_boot_starter_for_google_cloud_sql" href="#_spring_boot_starter_for_google_cloud_sql"></a>7.2&nbsp;Spring Boot Starter for Google Cloud SQL</h2></div></div></div><p>The Spring Boot Starters for Google Cloud SQL provide an auto-configured
<a class="link" href="https://docs.oracle.com/javase/7/docs/api/javax/sql/DataSource.html" target="_top"><code class="literal">DataSource</code></a> object.
Coupled with Spring JDBC, it provides a
<a class="link" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/jdbc.html#jdbc-JdbcTemplate" target="_top"><code class="literal">JdbcTemplate</code></a>
object bean that allows for operations such as querying and modifying a database.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; listUsers() {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> jdbcTemplate.queryForList(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"SELECT * FROM user;"</span>);
}</pre><p>You can rely on
<a class="link" href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-sql.html#boot-features-connect-to-production-database" target="_top">Spring
Boot data source auto-configuration</a> to configure a <code class="literal">DataSource</code> bean.
In other words, properties like the SQL username, <code class="literal">spring.datasource.username</code>, and password,
<code class="literal">spring.datasource.password</code> can be used.
There is also some configuration specific to Google Cloud SQL:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Property name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Description</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Default value</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Unused if specified property(ies)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.sql.enabled</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enables or disables Cloud SQL auto configuration</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.sql.database-name</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the database to connect to.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.datasource.url</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.sql.instance-connection-name</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A string containing a Google Cloud SQL
instance&#8217;s project ID, region and name, each separated by a colon. For example,
<code class="literal">my-project-id:my-region:my-instance-name</code>.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.datasource.url</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.sql.credentials.location</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>File system path to the Google OAuth2 credentials
private key file. Used to authenticate and authorize new connections to a Google Cloud SQL instance.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Default credentials provided by the Spring GCP Boot starter</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.sql.credentials.encoded-key</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Base64-encoded contents of OAuth2 account private key in JSON format.
Used to authenticate and authorize new connections to a Google Cloud SQL instance.</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Default credentials provided by the Spring GCP Boot starter</p></td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_datasource_literal_creation_flow" href="#_literal_datasource_literal_creation_flow"></a>7.2.1&nbsp;<code class="literal">DataSource</code> creation flow</h3></div></div></div><p>Based on the previous properties, the Spring Boot starter for Google Cloud SQL creates a
<code class="literal">CloudSqlJdbcInfoProvider</code> object which is used to obtain an instance&#8217;s JDBC URL and driver class
name.
If you provide your own <code class="literal">CloudSqlJdbcInfoProvider</code> bean, it is used instead and the properties
related to building the JDBC URL or driver class are ignored.</p><p>The <code class="literal">DataSourceProperties</code> object provided by Spring Boot Autoconfigure is mutated in order to use
the JDBC URL and driver class names provided by <code class="literal">CloudSqlJdbcInfoProvider</code>, unless those values were
provided in the properties.
It is in the <code class="literal">DataSourceProperties</code> mutation step that the credentials factory is registered
in a system property to be <code class="literal">SqlCredentialFactory</code>.</p><p><code class="literal">DataSource</code> creation is delegated to
<a class="link" href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-sql.html" target="_top">Spring Boot</a>.
You can select the type of connection pool (e.g., Tomcat, HikariCP, etc.) by
<a class="link" href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-sql.html#boot-features-connect-to-production-database" target="_top">adding
their dependency to the classpath</a>.</p><p>Using the created <code class="literal">DataSource</code> in conjunction with Spring JDBC provides you with a fully configured
and operational <code class="literal">JdbcTemplate</code> object that you can use to interact with your SQL database.
You can connect to your database with as little as a database and instance names.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_troubleshooting_tips" href="#_troubleshooting_tips"></a>7.2.2&nbsp;Troubleshooting tips</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="connection-issues" href="#connection-issues"></a>Connection issues</h4></div></div></div><p>If you&#8217;re not able to connect to a database and see an endless loop of
<code class="literal">Connecting to Cloud SQL instance [&#8230;&#8203;] on IP [&#8230;&#8203;]</code>, it&#8217;s likely that exceptions are being thrown
and logged at a level lower than your logger&#8217;s level. This may be the case with HikariCP, if your
logger is set to INFO or higher level.</p><p>To see what&#8217;s going on in the background, you should add a <code class="literal">logback.xml</code> file to your application
resources folder, that looks like this:</p><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">resource</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"org/springframework/boot/logging/logback/base.xml"</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">/&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;logger</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">name</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"com.zaxxer.hikari.pool"</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">level</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"DEBUG"</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">/&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span></pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_errors_like_literal_c_g_cloud_sql_core_sslsocketfactory_re_throwing_cached_exception_due_to_attempt_to_refresh_instance_information_too_soon_after_error_literal" href="#_errors_like_literal_c_g_cloud_sql_core_sslsocketfactory_re_throwing_cached_exception_due_to_attempt_to_refresh_instance_information_too_soon_after_error_literal"></a>Errors like <code class="literal">c.g.cloud.sql.core.SslSocketFactory : Re-throwing cached exception due to attempt to refresh instance information too soon after error</code></h4></div></div></div><p>If you see a lot of errors like this in a loop and can&#8217;t connect to your database,
this is usually a symptom that something isn&#8217;t right with the permissions of your credentials or the Google Cloud SQL API is not enabled. Verify that the Google Cloud SQL API is enabled in the Cloud Console and that your service account has the
<a class="link" href="https://cloud.google.com/sql/docs/mysql/project-access-control#roles" target="_top">necessary IAM roles</a>.</p><p>To find out what&#8217;s causing the issue, you can enable DEBUG logging level as mentioned <a class="link" href="#connection-issues" title="Connection issues">above</a>.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_postgresql_literal_java_net_socketexception_already_connected_literal_issue" href="#_postgresql_literal_java_net_socketexception_already_connected_literal_issue"></a>PostgreSQL: <code class="literal">java.net.SocketException: already connected</code> issue</h4></div></div></div><p>We found this exception to be common if your Maven project&#8217;s parent is <code class="literal">spring-boot</code> version
<code class="literal">1.5.x</code>, or in any other circumstance that would cause the version of the
<code class="literal">org.postgresql:postgresql</code> dependency to be an older one (e.g., <code class="literal">9.4.1212.jre7</code>).</p><p>To fix this, re-declare the dependency in its correct version. For example, in Maven:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.postgresql<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>postgresql<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>42.1.1<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_spring_integration" href="#_spring_integration"></a>8.&nbsp;Spring Integration</h1></div></div></div><p>Spring Cloud GCP provides Spring Integration adapters that allow your applications to use
Enterprise Integration Patterns backed up by Google Cloud Platform services.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_channel_adapters_for_google_cloud_pub_sub" href="#_channel_adapters_for_google_cloud_pub_sub"></a>8.1&nbsp;Channel Adapters for Google Cloud Pub/Sub</h2></div></div></div><p>The channel adapters for Google Cloud Pub/Sub connect your Spring
<a class="link" href="https://docs.spring.io/spring-integration/reference/html/messaging-channels-section.html#channel" target="_top"><code class="literal">MessageChannels</code></a>
to Google Cloud Pub/Sub topics and subscriptions.
This enables messaging between different processes, applications or micro-services backed up by
Google Cloud Pub/Sub.</p><p>The Spring Integration Channel Adapters for Google Cloud Pub/Sub are included in the
<code class="literal">spring-cloud-gcp-pubsub</code> module.</p><p>Maven coordinates, using Spring Cloud GCP BOM:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-pubsub<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-integration-core<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p>Gradle coordinates:</p><pre class="screen">dependencies {
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-pubsub'
    compile group: 'org.springframework.integration', name: 'spring-integration-core'
}</pre><p>A <a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-integration-pubsub-sample" target="_top">sample application</a> is available.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound_channel_adapter" href="#_inbound_channel_adapter"></a>8.1.1&nbsp;Inbound channel adapter</h3></div></div></div><p><code class="literal">PubSubInboundChannelAdapter</code> is the inbound channel adapter for GCP Pub/Sub that listens to a GCP
Pub/Sub subscription for new messages.
It converts new messages to an internal Spring
<a class="link" href="https://docs.spring.io/spring-integration/reference/html/messaging-construction-chapter.html#message" target="_top"><code class="literal">Message</code></a>
and then sends it to the bound output channel.</p><p>Google Pub/Sub treats message payloads as byte arrays.
So, by default, the inbound channel adapter will construct the Spring <code class="literal">Message</code> with <code class="literal">byte[]</code> as the payload.
However, you can change the desired payload type by setting the <code class="literal">payloadType</code> property of the <code class="literal">PubSubInboundChannelAdapter</code>.
The <code class="literal">PubSubInboundChannelAdapter</code> delegates the conversion to the desired payload type to the <code class="literal">PubSubMessageConverter</code> configured in the <code class="literal">PubSubTemplate</code>.</p><p>To use the inbound channel adapter, a <code class="literal">PubSubInboundChannelAdapter</code> must be provided and configured
on the user application side.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageChannel pubsubInputChannel() {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> PublishSubscribeChannel();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> PubSubInboundChannelAdapter messageChannelAdapter(
    <em><span class="hl-annotation" style="color: gray">@Qualifier("pubsubInputChannel")</span></em> MessageChannel inputChannel,
    SubscriberFactory subscriberFactory) {
    PubSubInboundChannelAdapter adapter =
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> PubSubInboundChannelAdapter(subscriberFactory, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"subscriptionName"</span>);
    adapter.setOutputChannel(inputChannel);
    adapter.setAckMode(AckMode.MANUAL);

    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> adapter;
}</pre><p>In the example, we first specify the <code class="literal">MessageChannel</code> where the adapter is going to write incoming
messages to.
The <code class="literal">MessageChannel</code> implementation isn&#8217;t important here.
Depending on your use case, you might want to use a <code class="literal">MessageChannel</code> other than
<code class="literal">PublishSubscribeChannel</code>.</p><p>Then, we declare a <code class="literal">PubSubInboundChannelAdapter</code> bean.
It requires the channel we just created and a <code class="literal">SubscriberFactory</code>, which creates <code class="literal">Subscriber</code>
objects from the Google Cloud Java Client for Pub/Sub.
The Spring Boot starter for GCP Pub/Sub provides a configured <code class="literal">SubscriberFactory</code>.</p><p>It is also possible to set the message acknowledgement mode on the adapter, which is automatic by
default.
On automatic acking, a message is acked with GCP Pub/Sub if the adapter sent it to the channel and
no exceptions were thrown.
If a <code class="literal">RuntimeException</code> is thrown while the message is processed, then the message is nacked.
On manual acking, the adapter attaches an <code class="literal">AckReplyConsumer</code> object to the <code class="literal">Message</code> headers, which
users can extract using the <code class="literal">GcpPubSubHeaders.ACKNOWLEDGEMENT</code> key and use to (n)ack a message.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "pubsubInputChannel")</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageHandler messageReceiver() {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> message -&gt; {
        LOGGER.info(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Message arrived! Payload: "</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> String((<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">byte</span>[]) message.getPayload()));
        AckReplyConsumer consumer =
              message.getHeaders().get(GcpPubSubHeaders.ACKNOWLEDGEMENT, AckReplyConsumer.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);
        consumer.ack();
    };
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_outbound_channel_adapter" href="#_outbound_channel_adapter"></a>8.1.2&nbsp;Outbound channel adapter</h3></div></div></div><p><code class="literal">PubSubMessageHandler</code> is the outbound channel adapter for GCP Pub/Sub that listens for new messages
on a Spring <code class="literal">MessageChannel</code>.
It uses <code class="literal">PubSubTemplate</code> to post them to a GCP Pub/Sub topic.</p><p>To construct a Pub/Sub representation of the message, the outbound channel adapter needs to convert the Spring <code class="literal">Message</code> payload to a byte array representation expected by Pub/Sub.
It delegates this conversion to the <code class="literal">PubSubTemplate</code>.
To customize the conversion, you can specify a <code class="literal">PubSubMessageConverter</code> in the <code class="literal">PubSubTemplate</code> that should convert the <code class="literal">Object</code> payload and headers of the Spring <code class="literal">Message</code> to a <code class="literal">PubsubMessage</code>.</p><p>To use the outbound channel adapter, a <code class="literal">PubSubMessageHandler</code> bean must be provided and configured
on the user application side.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "pubsubOutputChannel")</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageHandler messageSender(PubSubTemplate pubsubTemplate) {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> PubSubMessageHandler(pubsubTemplate, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"topicName"</span>);
}</pre><p>The provided <code class="literal">PubSubTemplate</code> contains all the necessary configuration to publish messages to a
GCP Pub/Sub topic.</p><p><code class="literal">PubSubMessageHandler</code> publishes messages asynchronously by default.
A publish timeout can be configured for synchronous publishing. If none is provided, the adapter
waits indefinitely for a response.</p><p>It is possible to set user-defined callbacks for the <code class="literal">publish()</code> call in <code class="literal">PubSubMessageHandler</code>
through the <code class="literal">setPublishFutureCallback()</code> method.
These are useful to process the message ID, in case of success, or the error if any was thrown.</p><p>To override the default destination you can use the <code class="literal">GcpPubSubHeaders.DESTINATION</code> header.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">private</span> MessageChannel pubsubOutputChannel;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; msg) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> MessagingException {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">final</span> Message&lt;?&gt; message = MessageBuilder
        .withPayload(msg.getPayload())
        .setHeader(GcpPubSubHeaders.TOPIC, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"customTopic"</span>).build();
    pubsubOutputChannel.send(message);
}</pre><p>It is also possible to set an SpEL expression for the topic with the <code class="literal">setTopicExpression()</code> or <code class="literal">setTopicExpressionString()</code> methods.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_header_mapping" href="#_header_mapping"></a>8.1.3&nbsp;Header mapping</h3></div></div></div><p>These channel adapters contain header mappers that allow you to map, or filter out, headers from Spring to Google Cloud Pub/Sub messages, and vice-versa.
By default, the inbound channel adapter maps every header on the Google Cloud Pub/Sub messages to the Spring messages produced by the adapter.
The outbound channel adapter maps every header from Spring messages into Google Cloud Pub/Sub ones, except the ones added by Spring, like headers with key <code class="literal">"id"</code>, <code class="literal">"timestamp"</code> and <code class="literal">"gcp_pubsub_acknowledgement"</code>.
In the process, the outbound mapper also converts the value of the headers into string.</p><p>Each adapter declares a <code class="literal">setHeaderMapper()</code> method to let you further customize which headers you want to map from Spring to Google Cloud Pub/Sub, and vice-versa.</p><p>For example, to filter out headers <code class="literal">"foo"</code>, <code class="literal">"bar"</code> and all headers starting with the prefix "prefix_", you can use <code class="literal">setHeaderMapper()</code> along with the <code class="literal">PubSubHeaderMapper</code> implementation provided by this module.</p><pre class="programlisting">PubSubMessageHandler adapter = ...
...
PubSubHeaderMapper headerMapper = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> PubSubHeaderMapper();
headerMapper.setOutboundHeaderPatterns(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"!foo"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"!bar"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"!prefix_*"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"*"</span>);
adapter.setHeaderMapper(headerMapper);</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The order in which the patterns are declared in <code class="literal">PubSubHeaderMapper.setOutboundHeaderPatterns()</code> and <code class="literal">PubSubHeaderMapper.setInboundHeaderPatterns()</code> matters.
The first patterns have precedence over the following ones.</p></td></tr></table></div><p>In the previous example, the <code class="literal">"*"</code> pattern means every header is mapped.
However, because it comes last in the list, <a class="link" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/util/PatternMatchUtils.html#smartMatch-java.lang.String-java.lang.String%E2%80%A6%E2%80%8B-" target="_top">the previous patterns take precedence</a>.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_channel_adapters_for_google_cloud_storage" href="#_channel_adapters_for_google_cloud_storage"></a>8.2&nbsp;Channel Adapters for Google Cloud Storage</h2></div></div></div><p>The channel adapters for Google Cloud Storage allow you to read and write files to Google Cloud
Storage through <code class="literal">MessageChannels</code>.</p><p>Spring Cloud GCP provides two inbound adapters, <code class="literal">GcsInboundFileSynchronizingMessageSource</code> and
<code class="literal">GcsStreamingMessageSource</code>, and one outbound adapter, <code class="literal">GcsMessageHandler</code>.</p><p>The Spring Integration Channel Adapters for Google Cloud Storage are included in the
<code class="literal">spring-cloud-gcp-storage</code> module.</p><p>To use the Storage portion of Spring Integration for Spring Cloud GCP, you must also provide the
<code class="literal">spring-integration-file</code> dependency, since they aren&#8217;t pulled transitively.</p><p>Maven coordinates, using Spring Cloud GCP BOM:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-storage<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-integration-file<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p>Gradle coordinates:</p><pre class="screen">dependencies {
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-starter-storage'
    compile group: 'org.springframework.integration', name: 'spring-integration-file'
}</pre><p>A <a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-integration-storage-sample" target="_top">sample application</a> is available.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound_channel_adapter_2" href="#_inbound_channel_adapter_2"></a>8.2.1&nbsp;Inbound channel adapter</h3></div></div></div><p>The Google Cloud Storage inbound channel adapter polls a Google Cloud Storage bucket for new files
and sends each of them in a <code class="literal">Message</code> payload to the <code class="literal">MessageChannel</code> specified in the
<code class="literal">@InboundChannelAdapter</code> annotation.
The files are temporarily stored in a folder in the local file system.</p><p>Here is an example of how to configure a Google Cloud Storage inbound channel adapter.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "new-file-channel", poller = @Poller(fixedDelay = "5000"))</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageSource&lt;File&gt; synchronizerAdapter(Storage gcs) {
  GcsInboundFileSynchronizer synchronizer = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsInboundFileSynchronizer(gcs);
  synchronizer.setRemoteDirectory(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"your-gcs-bucket"</span>);

  GcsInboundFileSynchronizingMessageSource synchAdapter =
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsInboundFileSynchronizingMessageSource(synchronizer);
  synchAdapter.setLocalDirectory(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> File(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"local-directory"</span>));

  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> synchAdapter;
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound_streaming_channel_adapter" href="#_inbound_streaming_channel_adapter"></a>8.2.2&nbsp;Inbound streaming channel adapter</h3></div></div></div><p>The inbound streaming channel adapter is similar to the normal inbound channel adapter, except it
does not require files to be stored in the file system.</p><p>Here is an example of how to configure a Google Cloud Storage inbound streaming channel adapter.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "streaming-channel", poller = @Poller(fixedDelay = "5000"))</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageSource&lt;InputStream&gt; streamingAdapter(Storage gcs) {
  GcsStreamingMessageSource adapter =
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsStreamingMessageSource(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsRemoteFileTemplate(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsSessionFactory(gcs)));
  adapter.setRemoteDirectory(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"your-gcs-bucket"</span>);
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> adapter;
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_outbound_channel_adapter_2" href="#_outbound_channel_adapter_2"></a>8.2.3&nbsp;Outbound channel adapter</h3></div></div></div><p>The outbound channel adapter allows files to be written to Google Cloud Storage.
When it receives a <code class="literal">Message</code> containing a payload of type <code class="literal">File</code>, it writes that file to the Google
Cloud Storage bucket specified in the adapter.</p><p>Here is an example of how to configure a Google Cloud Storage outbound channel adapter.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "writeFiles")</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageHandler outboundChannelAdapter(Storage gcs) {
  GcsMessageHandler outboundChannelAdapter = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsMessageHandler(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsSessionFactory(gcs));
  outboundChannelAdapter.setRemoteDirectoryExpression(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> ValueExpression&lt;&gt;(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"your-gcs-bucket"</span>));

  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> outboundChannelAdapter;
}</pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_spring_cloud_stream" href="#_spring_cloud_stream"></a>9.&nbsp;Spring Cloud Stream</h1></div></div></div><p>Spring Cloud GCP provides a <a class="link" href="https://cloud.spring.io/spring-cloud-stream/" target="_top">Spring Cloud Stream</a> binder to Google Cloud Pub/Sub.</p><p>The provided binder relies on the <a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-pubsub/src/main/java/org/springframework/cloud/gcp/pubsub/integration" target="_top">Spring Integration Channel Adapters for Google Cloud Pub/Sub</a>.</p><p>Maven coordinates, using Spring Cloud GCP BOM:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-pubsub-stream-binder<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p>Gradle coordinates:</p><pre class="screen">dependencies {
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-pubsub-stream-binder'
}</pre><p>A <a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-pubsub-binder-sample" target="_top">sample application</a> is available.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_overview" href="#_overview"></a>9.1&nbsp;Overview</h2></div></div></div><p>This binder binds producers to Google Cloud Pub/Sub topics and consumers to subscriptions.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Partitioning and consumer groups are not currently supported by this binder.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_configuration_2" href="#_configuration_2"></a>9.2&nbsp;Configuration</h2></div></div></div><p>You can configure the Spring Cloud Stream Binder for Google Cloud Pub/Sub to automatically generate the underlying resources, like the Google Cloud Pub/Sub subscriptions for the consumers.
For that, you can use the <code class="literal">spring.cloud.stream.gcp.pubsub.bindings.[CHANNEL-NAME].consumer.auto-create-resources</code> property, which is turned ON by default.</p><p>If automatic resource creation is turned ON and the subscription and the topic do not exist for a consumer, a subscription and a topic will be created with the same name.
For example, for the following configuration, a topic and a subscription called <code class="literal">myConsumer</code> would be created.</p><p><b>application.properties.&nbsp;</b>
</p><pre class="screen">spring.cloud.stream.bindings.output.destination=myConsumer

spring.cloud.stream.gcp.pubsub.bindings.output.consumer.auto-create-resources=true</pre><p>
</p><p>If you are using Pub/Sub auto-configuration from the Spring Cloud GCP Pub/Sub Starter, you should refer to the <a class="link" href="#pubsub-configuration" title="5.3&nbsp;Configuration">configuration</a> section for other Pub/Sub parameters.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>To use this binder with a <a class="link" href="https://cloud.google.com/pubsub/docs/emulator" target="_top">running emulator</a>, configure its host and port via
<code class="literal">spring.cloud.gcp.pubsub.emulator-host</code>.</p></td></tr></table></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_spring_cloud_sleuth" href="#_spring_cloud_sleuth"></a>10.&nbsp;Spring Cloud Sleuth</h1></div></div></div><p><a class="link" href="https://cloud.spring.io/spring-cloud-sleuth/" target="_top">Spring Cloud Sleuth</a> is an instrumentation framework for Spring Boot applications. It captures trace informations and can forward traces to services like Zipkin for storage and analysis.</p><p>Google Cloud Platform provides its own managed distributed tracing service called <a class="link" href="https://cloud.google.com/trace/" target="_top">Stackdriver Trace</a>.
Instead of running and maintaining your own Zipkin instance and storage, you can use Stackdriver Trace to store traces, view trace details, generate latency distributions graphs, and generate performance regression reports.</p><p>This Spring Cloud GCP starter can forward Spring Cloud Sleuth traces to Stackdriver Trace without an intermediary Zipkin server.</p><p>Maven coordinates, using Spring Cloud GCP BOM:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-starter-trace<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p>Gradle coordinates:</p><pre class="screen">dependencies {
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-starter-trace'
}</pre><p>You must enable Stackdriver Trace API from the Google Cloud Console in order to capture traces.
Navigate to the <a class="link" href="https://console.cloud.google.com/apis/api/cloudtrace.googleapis.com/overview" target="_top">Stackdriver Trace API</a> for your project and make sure it&#8217;s enabled.</p><p>A <a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-trace-sample" target="_top">sample application</a> is available.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If you are already using a Zipkin server capturing trace information from multiple platform/frameworks, you also use a <a class="link" href="https://cloud.google.com/trace/docs/zipkin" target="_top">Stackdriver Zipkin proxy</a> to forward those traces to Stackdriver Trace without modifying existing applications.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tracing" href="#_tracing"></a>10.1&nbsp;Tracing</h2></div></div></div><p>Spring Cloud Sleuth uses the <a class="link" href="https://github.com/openzipkin/brave" target="_top">Brave tracer</a> to generate traces.
This integration enables Brave to use the <a class="link" href="https://github.com/openzipkin/zipkin-gcp/tree/master/propagation-stackdriver" target="_top"><code class="literal">StackdriverTracePropagation</code></a> propagation.</p><p>A propagation is responsible for extracting trace context from an entity (e.g., an HTTP servlet request) and for injecting trace context into an entity.
A canonical example of the propagation usage is a web server that receives an HTTP request, which triggers other HTTP requests from the server before returning an HTTP response to the original caller.
In the case of <code class="literal">StackdriverTracePropagation</code>, first it looks for trace context in the <code class="literal">x-cloud-trace-context</code> key (e.g., an HTTP request header).
The value of the <code class="literal">x-cloud-trace-context</code> key can be formatted in three different ways:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">x-cloud-trace-context: TRACE_ID</code></li><li class="listitem"><code class="literal">x-cloud-trace-context: TRACE_ID/SPAN_ID</code></li><li class="listitem"><code class="literal">x-cloud-trace-context: TRACE_ID/SPAN_ID;o=TRACE_TRUE</code></li></ul></div><p><code class="literal">TRACE_ID</code> is a 32-character hexadecimal value that encodes a 128-bit number.</p><p><code class="literal">SPAN_ID</code> is an unsigned long.
Since Stackdriver Trace doesn&#8217;t support span joins, a new span ID is always generated, regardless of the one specified in <code class="literal">x-cloud-trace-context</code>.</p><p><code class="literal">TRACE_TRUE</code> can either be <code class="literal">0</code> if the entity should be untraced, or <code class="literal">1</code> if it should be traced.
However, at the moment, if <code class="literal">TRACE_TRUE</code> is set to <code class="literal">1</code>, the entity isn&#8217;t necessarily traced.
Currently, to make sure a request is traced, the Sleuth property <code class="literal">spring.sleuth.sampler.probability=1</code> should be used, to trace every entity.</p><p>If a <code class="literal">x-cloud-trace-context</code> key isn&#8217;t found, <code class="literal">StackdriverTracePropagation</code> falls back to tracing with the <a class="link" href="https://github.com/openzipkin/b3-propagation" target="_top">X-B3 headers</a>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_spring_boot_starter_for_stackdriver_trace" href="#_spring_boot_starter_for_stackdriver_trace"></a>10.2&nbsp;Spring Boot Starter for Stackdriver Trace</h2></div></div></div><p>Spring Boot Starter for Stackdriver Trace uses Spring Cloud Sleuth and auto-configures a <a class="link" href="https://github.com/openzipkin/zipkin-gcp/blob/master/sender-stackdriver/src/main/java/zipkin2/reporter/stackdriver/StackdriverSender.java" target="_top">StackdriverSender</a> that sends the Sleuth&#8217;s trace information to Stackdriver Trace.</p><p>All configurations are optional:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Description</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Default value</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.trace.enabled</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Auto-configure Spring Cloud Sleuth to send traces to Stackdriver Trace.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.trace.project-id</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Overrides the project ID from the <a class="link" href="#spring-cloud-gcp-core" title="4.&nbsp;Spring Cloud GCP Core">Spring Cloud GCP Module</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.trace.credentials.location</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Overrides the credentials location from the <a class="link" href="#spring-cloud-gcp-core" title="4.&nbsp;Spring Cloud GCP Core">Spring Cloud GCP Module</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.trace.credentials.encoded-key</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Overrides the credentials encoded key from the <a class="link" href="#spring-cloud-gcp-core" title="4.&nbsp;Spring Cloud GCP Core">Spring Cloud GCP Module</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.trace.credentials.scopes</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Overrides the credentials scopes from the <a class="link" href="#spring-cloud-gcp-core" title="4.&nbsp;Spring Cloud GCP Core">Spring Cloud GCP Module</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.trace.num-executor-threads</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Number of threads used by the Trace executor</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.trace.authority</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTTP/2 authority the channel claims to be connecting to.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.trace.compression</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the compression to use in Trace calls</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.trace.deadline-ms</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Call deadline in milliseconds</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.trace.max-inbound-size</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Maximum size for inbound messages</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.trace.max-outbound-size</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Maximum size for outbound messages</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.trace.wait-for-ready</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://github.com/grpc/grpc/blob/master/doc/wait-for-ready.md" target="_top">Waits for the channel to be ready</a> in case of a transient failure</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="" align="left" valign="top"><p><code class="literal">false</code></p></td></tr></tbody></table></div><p>You can use core Spring Cloud Sleuth properties to control Sleuth&#8217;s sampling rate, etc.
Read <a class="link" href="https://cloud.spring.io/spring-cloud-sleuth/" target="_top">Sleuth documentation</a> for more information on Sleuth configurations.</p><p>For example, when you are testing to see the traces are going through, you can set the sampling rate to 100%.</p><pre class="screen">spring.sleuth.sampler.probability=1                     # Send 100% of the request traces to Stackdriver.
spring.sleuth.web.skipPattern=(^cleanup.*|.+favicon.*)  # Ignore some URL paths.</pre><p>Spring Cloud GCP Trace does override some Sleuth configurations:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Always uses 128-bit Trace IDs. This is required by Stackdriver Trace.</li><li class="listitem">Does not use Span joins. Span joins will share the span ID between the client and server Spans. Stackdriver requires that every Span ID within a Trace to be unique, so Span joins are not supported.</li><li class="listitem">Uses <code class="literal">StackdriverHttpClientParser</code> and <code class="literal">StackdriverHttpServerParser</code> by default to populate Stackdriver related fields.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_integration_with_logging" href="#_integration_with_logging"></a>10.3&nbsp;Integration with Logging</h2></div></div></div><p>Integration with Stackdriver Logging is available through the <a class="link" href="logging.adoc" target="_top">Stackdriver Logging Support</a>.
If the Trace integration is used together with the Logging one, the request logs will be associated to the corresponding traces.
The trace logs can be viewed by going to the <a class="link" href="https://console.cloud.google.com/traces/traces" target="_top">Google Cloud Console Trace List</a>, selecting a trace and pressing the <code class="literal">Logs &#8594; View</code> link in the <code class="literal">Details</code> section.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_stackdriver_logging_support" href="#_stackdriver_logging_support"></a>11.&nbsp;Stackdriver Logging Support</h1></div></div></div><p>Maven coordinates, using Spring Cloud GCP BOM:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-starter-logging<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p>Gradle coordinates:</p><pre class="screen">dependencies {
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-starter-logging'
}</pre><p><a class="link" href="https://cloud.google.com/logging/" target="_top">Stackdriver Logging</a> is the managed logging service provided by Google Cloud
Platform.</p><p>This module provides support for associating a web request trace ID with the corresponding log entries.
It does so by retrieving the <code class="literal">X-B3-TraceId</code> value from the <a class="link" href="https://logback.qos.ch/manual/mdc.html" target="_top">Mapped Diagnostic Context (MDC)</a>, which is set by Spring Cloud Sleuth.
If Spring Cloud Sleuth isn&#8217;t used, the configured <code class="literal">TraceIdExtractor</code> extracts the desired header value and sets it as the log entry&#8217;s trace ID.
This allows grouping of log messages by request, for example, in the <a class="link" href="https://console.cloud.google.com/logs/viewer" target="_top">Google Cloud Console Logs viewer</a>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Due to the way logging is set up, the GCP project ID and credentials defined in <code class="literal">application.properties</code> are ignored.
Instead, you should set the <code class="literal">GOOGLE_CLOUD_PROJECT</code> and <code class="literal">GOOGLE_APPLICATION_CREDENTIALS</code> environment variables to the project ID and credentials private key location, respectively.
You can do this easily if you&#8217;re using the <a class="link" href="http://cloud.google.com/sdk" target="_top">Google Cloud SDK</a>, using the <code class="literal">gcloud config set project [YOUR_PROJECT_ID]</code> and <code class="literal">gcloud auth application-default login</code> commands, respectively.</p></td></tr></table></div><p>A <a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-logging-sample" target="_top">sample application</a> is available.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_web_mvc_interceptor" href="#_web_mvc_interceptor"></a>11.1&nbsp;Web MVC Interceptor</h2></div></div></div><p>For use in Web MVC-based applications, <code class="literal">TraceIdLoggingWebMvcInterceptor</code> is provided that extracts the request trace ID from an HTTP request using a <code class="literal">TraceIdExtractor</code> and stores it in a thread-local, which can then be used in a logging appender to add the trace ID metadata to log messages.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>If Spring Cloud GCP Trace is enabled, the logging module disables itself and delegates log correlation to Spring Cloud Sleuth.</p></td></tr></table></div><p><code class="literal">LoggingWebMvcConfigurer</code> configuration class is also provided to help register the <code class="literal">TraceIdLoggingWebMvcInterceptor</code>
in Spring MVC applications.</p><p>Applications hosted on the Google Cloud Platform include trace IDs under the <code class="literal">x-cloud-trace-context</code> header, which will be included in log entries.
However, if Sleuth is used the trace ID will be picked up from the MDC.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_logback_support" href="#_logback_support"></a>11.2&nbsp;Logback Support</h2></div></div></div><p>Currently, only Logback is supported and there are 2 possibilities to log to Stackdriver via this library with Logback:
via direct API calls and through JSON-formatted console logs.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_log_via_api" href="#_log_via_api"></a>11.2.1&nbsp;Log via API</h3></div></div></div><p>A Stackdriver appender is available using <code class="literal">org/springframework/cloud/gcp/autoconfigure/logging/logback-appender.xml</code>.
This appender builds a Stackdriver Logging log entry from a JUL or Logback log entry, adds a trace ID to it and sends it to Stackdriver Logging.</p><p><code class="literal">STACKDRIVER_LOG_NAME</code> and <code class="literal">STACKDRIVER_LOG_FLUSH_LEVEL</code> environment variables can be used to customize the <code class="literal">STACKDRIVER</code> appender.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_log_via_console" href="#_log_via_console"></a>11.2.2&nbsp;Log via Console</h3></div></div></div><p>For Logback, a <code class="literal">org/springframework/cloud/gcp/autoconfigure/logging/logback-json-appender.xml</code> file is made available for import to make it easier to configure the JSON Logback appender.</p><p>Your configuration may then look something like this:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">resource</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"org/springframework/cloud/gcp/autoconfigure/logging/logback-json-appender.xml"</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag"> /&gt;</span>

  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;root</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">level</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"INFO"</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;appender-ref</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">ref</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"CONSOLE_JSON"</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag"> /&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/root&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span></pre><p>If your application is running on Google Container Engine, Google Compute Engine or Google App Engine Flexible, your console logging is automatically saved to Google Stackdriver Logging.
Therefore, you can just include <code class="literal">org/springframework/cloud/gcp/autoconfigure/logging/logback-json-appender.xml</code> in your logging configuration, which logs JSON entries to the console.
The trace id will be set correctly.</p><p>Your Logback configuration may then look something like this:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">resource</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"org/springframework/cloud/gcp/autoconfigure/logging/logback-appender.xml"</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag"> /&gt;</span>

  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;root</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">level</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"INFO"</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;appender-ref</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">ref</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"CONSOLE_JSON"</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">/&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/root&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span></pre><p>If you want to have more control over the log output, you can also configure the <code class="literal">ConsoleAppender</code> yourself.
The following properties are available:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Default Value</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">projectId</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If not set, default value is determined in the following order:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><code class="literal">SPRING_CLOUD_GCP_LOGGING_PROJECT_ID</code> Environmental Variable.</li><li class="listitem">Value of <code class="literal">DefaultGcpProjectIdProvider.getProjectId()</code></li></ol></div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>This is used to generate fully qualified Stackdriver Trace ID format: <code class="literal">projects/[PROJECT-ID]/traces/[TRACE-ID]</code>.</p>
<p>This format is required to correlate trace between Stackdriver Trace and Stackdriver Logging.</p>
<p>If <code class="literal">projectId</code> is not set and cannot be determined, then it&#8217;ll log <code class="literal">traceId</code> without the fully qualified format.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">includeTraceId</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should the <code class="literal">traceId</code> be included</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">includeSpanId</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should the <code class="literal">spanId</code> be included</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">includeLevel</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should the severity be included</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">includeThreadName</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should the thread name be included</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">includeMDC</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should all MDC properties be included. The MDC properties <code class="literal">X-B3-TraceId</code>, <code class="literal">X-B3-SpanId</code> and <code class="literal">X-Span-Export</code> provided by Spring Sleuth will get excluded as they get handled separately</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">includeLoggerName</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should the name of the logger be included</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">includeFormattedMessage</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should the formatted log message be included.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">includeExceptionInMessage</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should the stacktrace be appended to the formatted log message. This setting is only evaluated if <code class="literal">includeFormattedMessage</code> is <code class="literal">true</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">includeContextName</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should the logging context be included</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">includeMessage</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should the log message with blank placeholders be included</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">includeException</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">false</code></p></td><td style="" align="left" valign="top"><p>Should the stacktrace be included as a own field</p></td></tr></tbody></table></div><p>This is an example of such an Logback configuration:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration &gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;property</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">name</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"projectId"</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">value</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"${projectId:-${GOOGLE_CLOUD_PROJECT}}"</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">/&gt;</span>

  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;appender</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">name</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"CONSOLE_JSON"</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">class</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"ch.qos.logback.core.ConsoleAppender"</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;encoder</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">class</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"ch.qos.logback.core.encoder.LayoutWrappingEncoder"</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;layout</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">class</span>=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-value">"org.springframework.cloud.gcp.logging.StackdriverJsonLayout"</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;projectId&gt;</span>${projectId}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/projectId&gt;</span>

        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--&lt;includeTraceId&gt;true&lt;/includeTraceId&gt;--&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--&lt;includeSpanId&gt;true&lt;/includeSpanId&gt;--&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--&lt;includeLevel&gt;true&lt;/includeLevel&gt;--&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--&lt;includeThreadName&gt;true&lt;/includeThreadName&gt;--&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--&lt;includeMDC&gt;true&lt;/includeMDC&gt;--&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--&lt;includeLoggerName&gt;true&lt;/includeLoggerName&gt;--&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--&lt;includeFormattedMessage&gt;true&lt;/includeFormattedMessage&gt;--&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--&lt;includeExceptionInMessage&gt;true&lt;/includeExceptionInMessage&gt;--&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--&lt;includeContextName&gt;true&lt;/includeContextName&gt;--&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--&lt;includeMessage&gt;false&lt;/includeMessage&gt;--&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--&lt;includeException&gt;false&lt;/includeException&gt;--&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/layout&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/encoder&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/appender&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span></pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_cloud_foundry" href="#_cloud_foundry"></a>12.&nbsp;Cloud Foundry</h1></div></div></div><p>Spring Cloud GCP provides support for Cloud Foundry&#8217;s <a class="link" href="https://docs.pivotal.io/partners/gcp-sb/index.html" target="_top">GCP Service Broker</a>.
Our Pub/Sub, Storage, Stackdriver Trace and Cloud SQL MySQL and PostgreSQL starters are Cloud Foundry aware and retrieve properties like project ID, credentials, etc., that are used in auto configuration from the Cloud Foundry environment.</p><p>In cases like Pub/Sub&#8217;s topic and subscription, or Storage&#8217;s bucket name, where those parameters are not used in auto configuration, you can fetch them using the VCAP mapping provided by Spring Boot.
For example, to retrieve the provisioned Pub/Sub topic, you can use the <code class="literal">vcap.services.mypubsub.credentials.topic_name</code> property from the application environment.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If the same service is bound to the same application more than once, the auto configuration will not be able to choose among bindings and will not be activated for that service.
This includes both MySQL and PostgreSQL bindings to the same app.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>In order for the Cloud SQL integration to work in Cloud Foundry, auto-reconfiguration must be disabled.
You can do so using the <code class="literal">cf set-env &lt;APP&gt; JBP_CONFIG_SPRING_AUTO_RECONFIGURATION '{enabled: false}'</code> command.
Otherwise, Cloud Foundry will produce a <code class="literal">DataSource</code> with an invalid JDBC URL (i.e., <code class="literal">jdbc:mysql://null/null</code>).</p></td></tr></table></div></div></div></body></html>