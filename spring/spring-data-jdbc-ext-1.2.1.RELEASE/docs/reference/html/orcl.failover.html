<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>4.&nbsp;Fast Connection Failover</title><link rel="stylesheet" href="css/manual-multipage.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="Spring Data JDBC Extensions Reference Documentation"><link rel="up" href="pt02.html" title="Part&nbsp;II.&nbsp;JDBC Extensions for the Oracle Database"><link rel="prev" href="orcl.datasource.html" title="3.&nbsp;Oracle Pooling DataSource"><link rel="next" href="orcl.streamsaq.html" title="5.&nbsp;Oracle's Streams AQ (Advanced Queueing)"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">4.&nbsp;Fast Connection Failover</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="orcl.datasource.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;II.&nbsp;JDBC Extensions for the Oracle Database</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="orcl.streamsaq.html">Next</a></td></tr></table><hr></div><div class="chapter" title="4.&nbsp;Fast Connection Failover"><div class="titlepage"><div><div><h2 class="title"><a name="orcl.failover"></a>4.&nbsp;Fast Connection Failover</h2></div></div></div><p>Oracle's RAC (Real Application Clusters) is an option that supports
  deployment of a single database across a cluster of servers, providing fault
  tolerance from hardware failures or other outages. Since a single database
  is served by a number of nodes, any node failure can be detected and
  subsequent operations can be directed to other nodes in the cluster. This
  support is provided by the "Fast Connection Failover" feature (FCF). When
  the failover occurs the current transaction is rolled back and a new
  transaction has to be initiated.</p><p>Spring's FCF support detects the transaction failure and attempts to
  retry the entire transaction. If this retry is successful it means that the
  client of the failed application will be unaware of this failover and it
  will look like the transaction completed after a brief delay.</p><p>The configuration for the FCF support is a two step configuration.
  First you need to configure a <code class="classname">DataSource</code> for RAC and
  second you need to configure an AOP advisor with a failover interceptor to
  handle the retries.</p><div class="section" title="4.1&nbsp;DataSource Configuration"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orcl.failover.config.datasource"></a>4.1&nbsp;DataSource Configuration</h2></div></div></div><p>We are going to need a DataSource that is capable of participating
    in a "Fast Connection Failover" scenario. The only one we have available
    is the <code class="classname">oracle.jdbc.pool.OracleDataSource</code>
    implementation that we will configure using the "orcl" namespace. This
    <code class="classname">DataSource</code> configured with some additional
    properties used for RAC.</p><p>We will be using the following property file to specify the username
    and password for the following example.</p><pre class="programlisting">username=spring
password=spring</pre><p>The url used in this example is a two node RAC configuration using
    the thin driver. It is probably too long to fit on the screen or on the
    page so if you would like to see the entire url it's listed in the callout
    notes.</p><pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
       <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
       <span class="hl-attribute">xmlns:orcl</span>=<span class="hl-value">"http://www.springframework.org/schema/data/orcl"</span>
       <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context-3.0.xsd
       http://www.springframework.org/schema/data/orcl
       http://www.springframework.org/schema/data/orcl/spring-data-orcl-1.0.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="bold"><strong>&lt;orcl:pooling-datasource id="racDataSource"
        url="jdbc:oracle:thin:@(description=(address_list=
            (address=(host=rac1)(protocol=tcp)(port=1521))
            (address=(host=rac2)(protocol=tcp)(port=1521)))
            (connect_data=(service_name=racdb1)))"
        properties-location="classpath:orcl.properties"
        fast-connection-failover-enabled="true" <a name="rac.1.fcf"></a><img src="images/callouts/1.png" alt="1" border="0">
        ONS-configuration="rac1:6200,rac2:6200"/&gt;</strong></span> <a name="rac.1.ons"></a><img src="images/callouts/2.png" alt="2" border="0">

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span> 
          <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"racDataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#rac.1.fcf"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>The fast connection failover is enabled here.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rac.1.ons"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>The ONS (Oracle Notification Service) configuration is defined
          here since we are using the thin driver for this example.</p></td></tr></table></div></div><div class="section" title="4.2&nbsp;AOP Configuration for Fast Connection Failover Retry"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orcl.failover.config.aop"></a>4.2&nbsp;AOP Configuration for Fast Connection Failover Retry</h2></div></div></div><p>In order for the Fast Connection Failover to be transparent to the
    end user you need to consider the overall impact of this failover. The
    original transaction will fail and another transaction will be started to
    retry the same operation. You need to consider any non-transactional side
    effects that the failed transaction might have caused. You also need to
    consider work done while the transaction is suspended. This could happen
    if a method with a transactional attribute of "REQUIRES_NEW" is executed
    within the original transaction.</p><p>Once you have considered any possible side effects, you can proceed
    to configure a RacFailoverInterceptor together with the AOP advisor and
    pointcut. The failover advisor must be before or at the same pointcut
    where the transaction advisor is applied. If the pointcuts for the
    failover advisor and the transaction advisor are at the same pointcut then
    the failover advisor must have a higher priority than the transaction
    advisor that it should wrap.</p><p>For the AOP advisor configuration we use the "aop" namespace and for
    the <code class="classname">RacFailoverInterceptor</code> we use the
    <code class="literal">rac-failover-interceptor</code> tag from the "orcl"
    namespace.</p><div class="section" title="4.2.1&nbsp;Configuration when defining transactions using a <tx:advice&gt; and an <aop:advisor&gt;"><div class="titlepage"><div><div><h3 class="title"><a name="orcl.failover.config.aop.advice"></a>4.2.1&nbsp;Configuration when defining transactions using a
      &lt;tx:advice&gt; and an &lt;aop:advisor&gt;</h3></div></div></div><p>When using a <code class="classname">&lt;tx:advice&gt;</code> combined
      with an <code class="classname">&lt;aop:advisor&gt;</code> you simply add an
      additional <code class="classname">&lt;aop:advisor&gt;</code> for the RAC
      failover Interceptor referencing the
      <code class="classname">&lt;orcl:rac-failover-interceptor&gt;</code> element.
      You must make sure that the RAC failover interceptor comes before the
      transaction advice and you can do that by specifying the order attribute
      on the advisor for the RAC failover interceptor. Any advisor specified
      without an order automatically gets the lowest priority, so by
      specifying <code class="classname">order="1"</code> for the RAC failover
      interceptor we are assured this advice will come before the transaction
      advice.</p><pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
       <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
       <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
       <span class="hl-attribute">xmlns:orcl</span>=<span class="hl-value">"http://www.springframework.org/schema/data/orcl"</span>
       <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
       http://www.springframework.org/schema/aop
       http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
       http://www.springframework.org/schema/tx
       http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
       http://www.springframework.org/schema/data/orcl
       http://www.springframework.org/schema/data/orcl/spring-data-orcl-1.0.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="bold"><strong>&lt;aop:config&gt;
        &lt;aop:advisor pointcut="execution(* *..PetStoreFacade.insertOrder(..))" <a name="fcf.1.aop.int"></a><img src="images/callouts/1.png" alt="1" border="0"> 
            advice-ref="racFailoverInterceptor" order="1"/&gt;
        &lt;aop:advisor pointcut="execution(* *..PetStoreFacade.*(..))" <a name="fcf.1.aop.tx"></a><img src="images/callouts/2.png" alt="2" border="0"> 
            advice-ref="txAdvice"/&gt;
    &lt;/aop:config&gt;</strong></span>

    <span class="bold"><strong>&lt;orcl:rac-failover-interceptor id="racFailoverInterceptor"/&gt;</strong></span> <a name="fcf.1.aop.adv"></a><img src="images/callouts/3.png" alt="3" border="0">

    <span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;tx:attributes&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"insert*"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"update*"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/tx:attributes&gt;</span>
    <span class="hl-tag">&lt;/tx:advice&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#fcf.1.aop.int"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>The advisor defined for the RAC failover interceptor. This
            must have a higher order than the transaction advisor. We do use
            the same pointcut</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#fcf.1.aop.tx"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>The standard transaction advice defined here.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#fcf.1.aop.adv"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>The RAC failover interceptor is defined using the
            <code class="classname">rac-failover-interceptor</code> element of the
            "orcl" namespace.</p></td></tr></table></div></div><div class="section" title="4.2.2&nbsp;Configuration when defining transactions using @Transactional annotation"><div class="titlepage"><div><div><h3 class="title"><a name="orcl.failover.config.aop.annotation"></a>4.2.2&nbsp;Configuration when defining transactions using @Transactional
      annotation</h3></div></div></div><p>When using a &lt;tx:annotation-driven&gt; configuration you add
      <code class="classname">&lt;aop:config&gt;</code> entry with an
      <code class="classname">&lt;aop:advisor&gt;</code> element for the RAC failover
      Interceptor referencing the
      <code class="classname">&lt;orcl:rac-failover-interceptor&gt;</code> element.
      You must make sure that the RAC failover interceptor comes before the
      transaction advice and you can do that by specifying the order attribute
      on the advisor for the RAC failover interceptor. Any
      &lt;tx:annotation-driven&gt; specified without an order automatically
      gets the lowest priority, so by specifying
      <code class="classname">order="1"</code> for the RAC failover interceptor we are
      assured this advice will come before the transaction advice.</p><pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
       <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
       <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
       <span class="hl-attribute">xmlns:orcl</span>=<span class="hl-value">"http://www.springframework.org/schema/data/orcl"</span>
       <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
       http://www.springframework.org/schema/aop
       http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
       http://www.springframework.org/schema/tx
       http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
       http://www.springframework.org/schema/data/orcl
       http://www.springframework.org/schema/data/orcl/spring-data-orcl-1.0.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="bold"><strong>&lt;aop:config&gt;
        &lt;aop:advisor <a name="fcf.2.aop.adv"></a><img src="images/callouts/1.png" alt="1" border="0">
            pointcut="@annotation(org.springframework.transaction.annotation.Transactional)" 
            advice-ref="racFailoverInterceptor" order="1"/&gt;
    &lt;/aop:config&gt;</strong></span>

    <span class="bold"><strong>&lt;orcl:rac-failover-interceptor id="racFailoverInterceptor"/&gt;</strong></span> <a name="fcf.2.aop.int"></a><img src="images/callouts/2.png" alt="2" border="0">

    <span class="hl-tag">&lt;tx:annotation-driven/&gt;</span> <a name="fcf.2.aop.anno"></a><img src="images/callouts/3.png" alt="3" border="0">

<span class="hl-tag">&lt;/beans&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#fcf.1.aop.adv"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>The advisor defined for the RAC failover interceptor. This
            must have a higher order than the transaction advisor. We use an
            <code class="classname">@annotation</code> pointcut referencing the
            <code class="classname">@Transactional</code> annotation.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#fcf.1.aop.int"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>The RAC failover interceptor is defined using the
            <code class="classname">rac-failover-interceptor</code> element of the
            "orcl" namespace.</p></td></tr><tr><td width="5%" valign="top" align="left"><p>???</p></td><td valign="top" align="left"><p>The standard transaction annotation-driven element defined
            here.</p></td></tr></table></div></div></div><div class="section" title="4.3&nbsp;Configuration options for <rac-failover-interceptor&gt;"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orcl.failover.config.interceptor"></a>4.3&nbsp;Configuration options for &lt;rac-failover-interceptor&gt;</h2></div></div></div><p>There is a number of optional attributes you can use to configure
    the <code class="literal">rac-failover-interceptor</code>.</p><div class="table"><a name="failover-settings"></a><p class="title"><b>Table&nbsp;4.1.&nbsp;<code class="literal">&lt;rac-failover-interceptor&gt;</code> attribute
      settings</b></p><div class="table-contents"><table summary="<rac-failover-interceptor&gt; attribute&#xA;      settings" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Required</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Default</th><th style="border-bottom: 0.5pt solid ; ">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><code class="literal">recoverable-error-codes</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">No</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">3113, 3114, 1033, 1034, 1089, 17002, 17008, 17410</td><td style="border-bottom: 0.5pt solid ; ">A comma separated list of integer error codes that will be
            used instead of the default set.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><code class="literal">max-number-of-retries</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">No</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">5</td><td style="border-bottom: 0.5pt solid ; ">The maximum number of times the retry will be
            performed.</td></tr><tr><td style="border-right: 0.5pt solid ; "><code class="literal">back-off-policy</code></td><td style="border-right: 0.5pt solid ; ">No</td><td style="border-right: 0.5pt solid ; "><code class="classname">NoBackOffPolicy</code></td><td style="">A specific back off policy to be used. This is a reference
            to a bean that implements <code class="classname">BackOffPolicy
            *</code></td></tr></tbody></table></div></div><br class="table-break"><p>*
    <code class="classname">org.springframework.batch.retry.backoff.BackOffPolicy</code></p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="orcl.datasource.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="pt02.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="orcl.streamsaq.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">3.&nbsp;Oracle Pooling DataSource&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;5.&nbsp;Oracle's Streams AQ (Advanced Queueing)</td></tr></table></div></body></html>