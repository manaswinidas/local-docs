<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<title>Spring Batch - Reference Documentation</title>
<style>
@import url(https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700);
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: white; color: #34302d; padding: 0; margin: 0; font-family: "Varela Round", sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

object, svg { display: inline-block; vertical-align: middle; }

.center { margin-left: auto; margin-right: auto; }

.spread { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.45; color: #0b0a0a; font-weight: normal; margin-top: 0; margin-bottom: 0.25em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #548e2e; text-decoration: underline; line-height: inherit; }
a:hover, a:focus { color: #487a28; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Montserrat, sans-serif; font-weight: 400; font-style: normal; color: #34302d; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.0125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #867c74; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #ddddd8; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-weight: normal; color: rgba(0, 0, 0, 0.9); }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 1.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #34302d; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.9375em; color: rgba(0, 0, 0, 0.6); }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: rgba(0, 0, 0, 0.6); }

blockquote, blockquote p { line-height: 1.6; color: rgba(0, 0, 0, 0.85); }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.2; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dedede; }
table thead, table tfoot { background: #f7f8f7; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #34302d; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #34302d; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f8f8f7; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.6; }

body { -moz-osx-font-smoothing: grayscale; -webkit-font-smoothing: antialiased; tab-size: 4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.2; word-spacing: -0.05em; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: 0.9375em; font-style: normal !important; letter-spacing: 0; padding: 0.1em 0.5ex; word-spacing: -0.15em; background-color: #f7f7f8; -webkit-border-radius: 4px; border-radius: 4px; line-height: 1.45; text-rendering: optimizeSpeed; word-wrap: break-word; }
*:not(pre) > code.nobreak { word-wrap: normal; }
*:not(pre) > code.nowrap { white-space: nowrap; }

pre, pre > code { line-height: 1.45; color: rgba(0, 0, 0, 0.9); font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-weight: normal; text-rendering: optimizeSpeed; }

em em { font-style: normal; }

strong strong { font-weight: normal; }

.keyseq { color: #6b625c; }

kbd { font-family: Monaco, Menlo, Consolas, "Courier New", monospace; display: inline-block; color: #34302d; font-size: 0.65em; line-height: 1.45; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: 0 0.15em; padding: 0.2em 0.5em; vertical-align: middle; position: relative; top: -0.1em; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #191715; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

p a > code:hover { color: rgba(0, 0, 0, 0.9); }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: rgba(0, 0, 0, 0.85); margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #ddddd8; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #ddddd8; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #ddddd8; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: rgba(0, 0, 0, 0.6); display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: rgba(0, 0, 0, 0.85); }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: rgba(0, 0, 0, 0.85); }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: rgba(0, 0, 0, 0.85); border-bottom: 1px solid #ddddd8; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#toc { border-bottom: 1px solid #efefed; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: Montserrat, sans-serif; list-style-type: none; }
#toc li { line-height: 1.3334; margin-top: 0.3334em; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #0b0a0a; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f1f1f1; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #efefed; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; margin-bottom: 0.8rem; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #efefed; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d7d7d7; margin-bottom: 1.25em; padding: 1.25em; background: #f1f1f1; -webkit-border-radius: 4px; border-radius: 4px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #34302d; padding: 1.25em; }

#footer-text { color: #cbcfd2; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #efefed; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #34302d; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #262321; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; font-family: "Varela Round", sans-serif; font-size: 1rem; font-style: italic; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: rgba(0, 0, 0, 0.85); }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: initial; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: Montserrat, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #ddddd8; color: rgba(0, 0, 0, 0.6); }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 4px; border-radius: 4px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d7d7d7; margin-bottom: 1.25em; padding: 1.25em; background: #f1f1f1; -webkit-border-radius: 4px; border-radius: 4px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #0b0a0a; margin-top: 0; text-align: center; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: whitesmoke; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #dddddd; -webkit-border-radius: 4px; border-radius: 4px; word-wrap: break-word; padding: 1em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: whitesmoke; background-color: rgba(0, 0, 0, 0.9); }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 1em; -webkit-border-radius: 4px; border-radius: 4px; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; line-height: 1.45; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #ddddd8; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: rgba(0, 0, 0, 0.85); font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #0b0a0a; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid rgba(0, 0, 0, 0.6); }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: rgba(0, 0, 0, 0.85); font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.9375em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.025em; color: rgba(0, 0, 0, 0.6); }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dedede; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.6; background: #f7f8f7; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #34302d; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 1.75em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-square-o:first-child, ul.checklist li > p:first-child > .fa-check-square-o:first-child { width: 1em; font-size: 0.85em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { width: 1em; position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1, td.hdlist2 { vertical-align: top; padding: 0 0.625em; }

td.hdlist1 { font-weight: bold; padding-bottom: 1.25em; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:first-of-type img { max-width: initial; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; display: inline-block; }
a.image object { pointer-events: none; }

sup.footnote, sup.footnoteref { font-size: 0.875em; position: static; vertical-align: super; }
sup.footnote a, sup.footnoteref a { text-decoration: none; }
sup.footnote a:active, sup.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -0.25em 0 0.75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em 0 0.225em; line-height: 1.3334; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.05em; margin-bottom: 0.2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #3f6a22; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #34302d; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.admonitionblock { border-left: 4px solid #6db33f; background-color: #ebf1e7; padding: 1.2em 0; margin: 30px 0; width: auto; }

#toc a:hover { text-decoration: underline; }

.admonitionblock > table td.content { border-left: none; }

.js-download-widget-selector{display:inline;}.navbar{margin-bottom:0;}.item-slider-widget{display:inline-block;margin-left:15px;}.item-slider-widget .item--slider{height:32px;position:absolute;width:40px;border-radius:2px;margin-top:-4px;z-index:800;background:#68605a;background:-moz-linear-gradient(top,#68605a 0%,#34302d 100%,#020202 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0%,#68605a),color-stop(100%,#34302d),color-stop(100%,#020202));background:-webkit-linear-gradient(top,#68605a 0%,#34302d 100%,#020202 100%);background:-o-linear-gradient(top,#68605a 0%,#34302d 100%,#020202 100%);background:-ms-linear-gradient(top,#68605a 0%,#34302d 100%,#020202 100%);background:linear-gradient(to bottom,#68605a 0%,#34302d 100%,#020202 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#68605a',endColorstr='#020202',GradientType=0);cursor:pointer;transition:all 0.25s;-webkit-transition:all 0.25s;-moz-webkit-transition:all 0.25s;-ms--webkit-transition:all 0.25s;-o-webkit-transition:all 0.25s;}.item-slider-widget .item-slider--container{background-color:white;border:1px solid #999;padding:0 3px;}.item-slider-widget .item-slider--container .item{display:inline-block;color:#c3c3c3;font-family:"Montserrat",sans-serif;font-size:12px;line-height:12px;text-transform:uppercase;padding:7px 6px 5px;cursor:pointer;transition:color 0.25s;-webkit-transition:color 0.25s;-moz-webkit-transition:color 0.25s;-ms--webkit-transition:color 0.25s;-o-webkit-transition:color 0.25s;}.item-slider-widget .item-slider--container .item:hover{color:black;}.item-slider-widget .item-slider--container .item.js-active{z-index:801;position:relative;color:#f1f1f1;}

/* Styling for the toggle buttons */
/* Borrowed from http://jeremyworboys.com/writing/toggle-buttons-without-javascript */
/* Micro clearfix (http://nicolasgallagher.com/micro-clearfix-hack/) */
.cf:before,.cf:after{content:"";display:table}.cf:after{clear:both}.cf{zoom:1}

/* = Function = */

.docToggle-button input {
    display: none;
}
.docToggle-button label {
    background: #ccc;
    border: 1px solid #888;
    color: #666;
    padding: 5px 10px;
}
.docToggle-button label:hover {
    background-color: #ddd;
}
.docToggle-button label:active,
.docToggle-button input:focus + label {
    background-color: #aaa;
}
.docToggle-button input:checked + label {
    background-color: #b4b4b4;
}

.docToggle-button label {
    background-color: #f5f5f5;
    background-image: -webkit-linear-gradient(top, #ffffff, #e6e6e6);
    background-image: -moz-linear-gradient(top, #ffffff, #e6e6e6);
    background-image: -o-linear-gradient(top, #ffffff, #e6e6e6);
    background-image: -ms-linear-gradient(top, #ffffff, #e6e6e6);
    background-image: linear-gradient(top, #ffffff, #e6e6e6);
    background-repeat: repeat-x;
    filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffff', endColorstr='#e6e6e6', GradientType=0);
    border-color: #e6e6e6 #e6e6e6 #bfbfbf;
    border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    border: 1px solid #cccccc;
    border-bottom-color: #b3b3b3;
    -webkit-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
    -moz-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
    color: #333333;
    cursor: pointer;
    display: inline-block;
    margin-bottom: 0;
    margin-left: -1px;
    padding: 4px 10px;
    font-size: 13px;
    line-height: 18px;
    text-align: center;
    text-shadow: 0 1px 1px rgba(255, 255, 255, 0.75);
    vertical-align: middle;
}
.docToggle-button label:hover {
    background-color: #e6e6e6;
    background-position: 0 -15px;
    color: #333333;
    text-decoration: none;
    -webkit-transition: background-position 0.1s linear;
    -moz-transition: background-position 0.1s linear;
    -ms-transition: background-position 0.1s linear;
    -o-transition: background-position 0.1s linear;
    transition: background-position 0.1s linear;
}
.docToggle-button label:active,
.docToggle-button input:focus + label {
    background-color: #d9d9d9;
    background-image: none;
    -webkit-box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
    -moz-box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
    outline: 0;
}

.docToggle-button input:checked + label {
    background: #404040;
    color: #ffffff;
    -webkit-box-shadow: inset 0 1px 6px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
    -moz-box-shadow: inset 0 1px 6px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
    box-shadow: inset 0 1px 6px rgba(0, 0, 0, 0.15), 0 1px 2px  rgba(0, 0, 0, 0.05);
}
.docToggle-button:first-child label {
  -webkit-border-top-left-radius: 4px;
  -moz-border-radius-topleft: 4px;
  border-top-left-radius: 4px;
  -webkit-border-bottom-left-radius: 4px;
  -moz-border-radius-bottomleft: 4px;
  border-bottom-left-radius: 4px;
  margin-left: 0;
}
.docToggle-button:last-child label {
  -webkit-border-top-right-radius: 4px;
  -moz-border-radius-topright: 4px;
  border-top-right-radius: 4px;
  -webkit-border-bottom-right-radius: 4px;
  -moz-border-radius-bottomright: 4px;
  border-bottom-right-radius: 4px;

  -webkit-border-top-left-radius: 4px;
  -moz-border-radius-topleft: 4px;
  border-top-left-radius: 4px;
  -webkit-border-bottom-left-radius: 4px;
  -moz-border-radius-bottomleft: 4px;
  border-bottom-left-radius: 4px;
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<style>
  #tocbot a.toc-link.node-name--H1{ font-style: italic }
  @media screen{
    #tocbot > ul.toc-list{ margin-bottom: 0.5em; margin-left: 0.125em }
    #tocbot ul.sectlevel0, #tocbot a.toc-link.node-name--H1 + ul{
      padding-left: 0 }
    #tocbot a.toc-link{ height:100% }
    .is-collapsible{ max-height:3000px; overflow:hidden; }
    .is-collapsed{ max-height:0 }
    .is-active-link{ font-weight:700 }
  }
  @media print{
    #tocbot a.toc-link.node-name--H4{ display:none }
  }
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Spring Batch - Reference Documentation</h1>
<div class="details">
<span id="revnumber">version 4.1.2.RELEASE</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#spring-batch-intro">1. Spring Batch Introduction</a>
<ul class="sectlevel2">
<li><a href="#springBatchBackground">1.1. Background</a></li>
<li><a href="#springBatchUsageScenarios">1.2. Usage Scenarios</a></li>
<li><a href="#springBatchArchitecture">1.3. Spring Batch Architecture</a></li>
<li><a href="#batchArchitectureConsiderations">1.4. General Batch Principles and Guidelines</a></li>
<li><a href="#batchProcessingStrategy">1.5. Batch Processing Strategies</a></li>
</ul>
</li>
<li><a href="#whatsNew">2. What&#8217;s New in Spring Batch 4.1</a>
<ul class="sectlevel2">
<li><a href="#whatsNewTesting">2.1. <code>@SpringBatchTest</code> Annotation</a></li>
<li><a href="#whatsNewIntegration">2.2. <code>@EnableBatchIntegration</code> Annotation</a></li>
<li><a href="#whatsNewJson">2.3. JSON support</a></li>
<li><a href="#whatsNewBeanValidationApi">2.4. Bean Validation API support</a></li>
<li><a href="#whatsNewJSR305Api">2.5. JSR-305 support</a></li>
<li><a href="#whatsNewFlatFileItemWriterBuilder">2.6. <code>FlatFileItemWriterBuilder</code> enhancements</a></li>
</ul>
</li>
<li><a href="#domainLanguageOfBatch">3. The Domain Language of Batch</a>
<ul class="sectlevel2">
<li><a href="#job">3.1. Job</a>
<ul class="sectlevel3">
<li><a href="#jobinstance">3.1.1. JobInstance</a></li>
<li><a href="#jobparameters">3.1.2. JobParameters</a></li>
<li><a href="#jobexecution">3.1.3. JobExecution</a></li>
</ul>
</li>
<li><a href="#step">3.2. Step</a>
<ul class="sectlevel3">
<li><a href="#stepexecution">3.2.1. StepExecution</a></li>
</ul>
</li>
<li><a href="#executioncontext">3.3. ExecutionContext</a></li>
<li><a href="#jobrepository">3.4. JobRepository</a></li>
<li><a href="#joblauncher">3.5. JobLauncher</a></li>
<li><a href="#item-reader">3.6. Item Reader</a></li>
<li><a href="#item-writer">3.7. Item Writer</a></li>
<li><a href="#item-processor">3.8. Item Processor</a></li>
<li><a href="#batch-namespace">3.9. Batch Namespace</a></li>
</ul>
</li>
<li><a href="#configureJob">4. Configuring and Running a Job</a>
<ul class="sectlevel2">
<li><a href="#configuringAJob">4.1. Configuring a Job</a>
<ul class="sectlevel3">
<li><a href="#restartability">4.1.1. Restartability</a></li>
<li><a href="#interceptingJobExecution">4.1.2. Intercepting Job Execution</a></li>
<li><a href="#inheritingFromAParentJob">4.1.3. Inheriting from a Parent Job</a></li>
<li><a href="#jobparametersvalidator">4.1.4. JobParametersValidator</a></li>
</ul>
</li>
<li><a href="#javaConfig">4.2. Java Config</a></li>
<li><a href="#configuringJobRepository">4.3. Configuring a JobRepository</a>
<ul class="sectlevel3">
<li><a href="#txConfigForJobRepository">4.3.1. Transaction Configuration for the JobRepository</a></li>
<li><a href="#repositoryTablePrefix">4.3.2. Changing the Table Prefix</a></li>
<li><a href="#inMemoryRepository">4.3.3. In-Memory Repository</a></li>
<li><a href="#nonStandardDatabaseTypesInRepository">4.3.4. Non-standard Database Types in a Repository</a></li>
</ul>
</li>
<li><a href="#configuringJobLauncher">4.4. Configuring a JobLauncher</a></li>
<li><a href="#runningAJob">4.5. Running a Job</a>
<ul class="sectlevel3">
<li><a href="#runningJobsFromCommandLine">4.5.1. Running Jobs from the Command Line</a>
<ul class="sectlevel4">
<li><a href="#commandLineJobRunner">The CommandLineJobRunner</a></li>
<li><a href="#exitCodes">ExitCodes</a></li>
</ul>
</li>
<li><a href="#runningJobsFromWebContainer">4.5.2. Running Jobs from within a Web Container</a></li>
</ul>
</li>
<li><a href="#advancedMetaData">4.6. Advanced Meta-Data Usage</a>
<ul class="sectlevel3">
<li><a href="#queryingRepository">4.6.1. Querying the Repository</a></li>
<li><a href="#jobregistry">4.6.2. JobRegistry</a>
<ul class="sectlevel4">
<li><a href="#jobregistrybeanpostprocessor">JobRegistryBeanPostProcessor</a></li>
<li><a href="#automaticjobregistrar">AutomaticJobRegistrar</a></li>
</ul>
</li>
<li><a href="#JobOperator">4.6.3. JobOperator</a></li>
<li><a href="#JobParametersIncrementer">4.6.4. JobParametersIncrementer</a></li>
<li><a href="#stoppingAJob">4.6.5. Stopping a Job</a></li>
<li><a href="#aborting-a-job">4.6.6. Aborting a Job</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#configureStep">5. Configuring a <code>Step</code></a>
<ul class="sectlevel2">
<li><a href="#chunkOrientedProcessing">5.1. Chunk-oriented Processing</a>
<ul class="sectlevel3">
<li><a href="#configuringAStep">5.1.1. Configuring a <code>Step</code></a></li>
<li><a href="#InheritingFromParentStep">5.1.2. Inheriting from a Parent <code>Step</code></a>
<ul class="sectlevel4">
<li><a href="#abstractStep">Abstract <code>Step</code></a></li>
<li><a href="#mergingListsOnStep">Merging Lists</a></li>
</ul>
</li>
<li><a href="#commitInterval">5.1.3. The Commit Interval</a></li>
<li><a href="#stepRestart">5.1.4. Configuring a <code>Step</code> for Restart</a>
<ul class="sectlevel4">
<li><a href="#startLimit">Setting a Start Limit</a></li>
<li><a href="#allowStartIfComplete">Restarting a Completed <code>Step</code></a></li>
<li><a href="#stepRestartExample"><code>Step</code> Restart Configuration Example</a></li>
</ul>
</li>
<li><a href="#configuringSkip">5.1.5. Configuring Skip Logic</a></li>
<li><a href="#retryLogic">5.1.6. Configuring Retry Logic</a></li>
<li><a href="#controllingRollback">5.1.7. Controlling Rollback</a>
<ul class="sectlevel4">
<li><a href="#transactionalReaders">Transactional Readers</a></li>
</ul>
</li>
<li><a href="#transactionAttributes">5.1.8. Transaction Attributes</a></li>
<li><a href="#registeringItemStreams">5.1.9. Registering <code>ItemStream</code> with a <code>Step</code></a></li>
<li><a href="#interceptingStepExecution">5.1.10. Intercepting <code>Step</code> Execution</a>
<ul class="sectlevel4">
<li><a href="#stepExecutionListener"><code>StepExecutionListener</code></a></li>
<li><a href="#chunkListener"><code>ChunkListener</code></a></li>
<li><a href="#itemReadListener"><code>ItemReadListener</code></a></li>
<li><a href="#itemProcessListener"><code>ItemProcessListener</code></a></li>
<li><a href="#itemWriteListener"><code>ItemWriteListener</code></a></li>
<li><a href="#skipListener"><code>SkipListener</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#taskletStep">5.2. <code>TaskletStep</code></a>
<ul class="sectlevel3">
<li><a href="#taskletAdapter">5.2.1. <code>TaskletAdapter</code></a></li>
<li><a href="#exampleTaskletImplementation">5.2.2. Example <code>Tasklet</code> Implementation</a></li>
</ul>
</li>
<li><a href="#controllingStepFlow">5.3. Controlling Step Flow</a>
<ul class="sectlevel3">
<li><a href="#SequentialFlow">5.3.1. Sequential Flow</a></li>
<li><a href="#conditionalFlow">5.3.2. Conditional Flow</a>
<ul class="sectlevel4">
<li><a href="#batchStatusVsExitStatus">Batch Status Versus Exit Status</a></li>
</ul>
</li>
<li><a href="#configuringForStop">5.3.3. Configuring for Stop</a>
<ul class="sectlevel4">
<li><a href="#endElement">Ending at a Step</a></li>
<li><a href="#failElement">Failing a Step</a></li>
<li><a href="#stopElement">Stopping a Job at a Given Step</a></li>
</ul>
</li>
<li><a href="#programmaticFlowDecisions">5.3.4. Programmatic Flow Decisions</a></li>
<li><a href="#split-flows">5.3.5. Split Flows</a></li>
<li><a href="#external-flows">5.3.6. Externalizing Flow Definitions and Dependencies Between Jobs</a></li>
</ul>
</li>
<li><a href="#late-binding">5.4. Late Binding of <code>Job</code> and <code>Step</code> Attributes</a>
<ul class="sectlevel3">
<li><a href="#step-scope">5.4.1. Step Scope</a></li>
<li><a href="#job-scope">5.4.2. Job Scope</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#readersAndWriters">6. ItemReaders and ItemWriters</a>
<ul class="sectlevel2">
<li><a href="#itemReader">6.1. <code>ItemReader</code></a></li>
<li><a href="#itemWriter">6.2. <code>ItemWriter</code></a></li>
<li><a href="#itemProcessor">6.3. <code>ItemProcessor</code></a>
<ul class="sectlevel3">
<li><a href="#chainingItemProcessors">6.3.1. Chaining ItemProcessors</a></li>
<li><a href="#filteringRecords">6.3.2. Filtering Records</a></li>
<li><a href="#faultTolerant">6.3.3. Fault Tolerance</a></li>
</ul>
</li>
<li><a href="#itemStream">6.4. <code>ItemStream</code></a></li>
<li><a href="#delegatePatternAndRegistering">6.5. The Delegate Pattern and Registering with the Step</a></li>
<li><a href="#flatFiles">6.6. Flat Files</a>
<ul class="sectlevel3">
<li><a href="#fieldSet">6.6.1. The <code>FieldSet</code></a></li>
<li><a href="#flatFileItemReader">6.6.2. <code>FlatFileItemReader</code></a>
<ul class="sectlevel4">
<li><a href="#lineMapper"><code>LineMapper</code></a></li>
<li><a href="#lineTokenizer"><code>LineTokenizer</code></a></li>
<li><a href="#fieldSetMapper"><code>FieldSetMapper</code></a></li>
<li><a href="#defaultLineMapper"><code>DefaultLineMapper</code></a></li>
<li><a href="#simpleDelimitedFileReadingExample">Simple Delimited File Reading Example</a></li>
<li><a href="#mappingFieldsByName">Mapping Fields by Name</a></li>
<li><a href="#beanWrapperFieldSetMapper">Automapping FieldSets to Domain Objects</a></li>
<li><a href="#fixedLengthFileFormats">Fixed Length File Formats</a></li>
<li><a href="#prefixMatchingLineMapper">Multiple Record Types within a Single File</a></li>
<li><a href="#exceptionHandlingInFlatFiles">Exception Handling in Flat Files</a></li>
</ul>
</li>
<li><a href="#flatFileItemWriter">6.6.3. <code>FlatFileItemWriter</code></a>
<ul class="sectlevel4">
<li><a href="#lineAggregator"><code>LineAggregator</code></a></li>
<li><a href="#SimplifiedFileWritingExample">Simplified File Writing Example</a></li>
<li><a href="#FieldExtractor"><code>FieldExtractor</code></a></li>
<li><a href="#delimitedFileWritingExample">Delimited File Writing Example</a></li>
<li><a href="#fixedWidthFileWritingExample">Fixed Width File Writing Example</a></li>
<li><a href="#handlingFileCreation">Handling File Creation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#xmlReadingWriting">6.7. XML Item Readers and Writers</a>
<ul class="sectlevel3">
<li><a href="#StaxEventItemReader">6.7.1. <code>StaxEventItemReader</code></a></li>
<li><a href="#StaxEventItemWriter">6.7.2. <code>StaxEventItemWriter</code></a></li>
</ul>
</li>
<li><a href="#jsonReadingWriting">6.8. JSON Item Readers And Writers</a>
<ul class="sectlevel3">
<li><a href="#JsonItemReader">6.8.1. <code>JsonItemReader</code></a></li>
<li><a href="#code-jsonfileitemwriter-code">6.8.2. <code>JsonFileItemWriter</code></a></li>
</ul>
</li>
<li><a href="#multiFileInput">6.9. Multi-File Input</a></li>
<li><a href="#database">6.10. Database</a>
<ul class="sectlevel3">
<li><a href="#cursorBasedItemReaders">6.10.1. Cursor-based <code>ItemReader</code> Implementations</a>
<ul class="sectlevel4">
<li><a href="#JdbcCursorItemReader"><code>JdbcCursorItemReader</code></a></li>
<li><a href="#HibernateCursorItemReader"><code>HibernateCursorItemReader</code></a></li>
<li><a href="#StoredProcedureItemReader"><code>StoredProcedureItemReader</code></a></li>
</ul>
</li>
<li><a href="#pagingItemReaders">6.10.2. Paging <code>ItemReader</code> Implementations</a>
<ul class="sectlevel4">
<li><a href="#JdbcPagingItemReader"><code>JdbcPagingItemReader</code></a></li>
<li><a href="#JpaPagingItemReader"><code>JpaPagingItemReader</code></a></li>
</ul>
</li>
<li><a href="#databaseItemWriters">6.10.3. Database ItemWriters</a></li>
</ul>
</li>
<li><a href="#reusingExistingServices">6.11. Reusing Existing Services</a></li>
<li><a href="#validatingInput">6.12. Validating Input</a></li>
<li><a href="#process-indicator">6.13. Preventing State Persistence</a></li>
<li><a href="#customReadersWriters">6.14. Creating Custom ItemReaders and ItemWriters</a>
<ul class="sectlevel3">
<li><a href="#customReader">6.14.1. Custom <code>ItemReader</code> Example</a>
<ul class="sectlevel4">
<li><a href="#restartableReader">Making the <code>ItemReader</code> Restartable</a></li>
</ul>
</li>
<li><a href="#customWriter">6.14.2. Custom <code>ItemWriter</code> Example</a>
<ul class="sectlevel4">
<li><a href="#restartableWriter">Making the <code>ItemWriter</code> Restartable</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#itemReaderAndWriterImplementations">6.15. Item Reader and Writer Implementations</a>
<ul class="sectlevel3">
<li><a href="#decorators">6.15.1. Decorators</a>
<ul class="sectlevel4">
<li><a href="#synchronizedItemStreamReader"><code>SynchronizedItemStreamReader</code></a></li>
<li><a href="#singleItemPeekableItemReader"><code>SingleItemPeekableItemReader</code></a></li>
<li><a href="#multiResourceItemWriter"><code>MultiResourceItemWriter</code></a></li>
<li><a href="#classifierCompositeItemWriter"><code>ClassifierCompositeItemWriter</code></a></li>
<li><a href="#classifierCompositeItemProcessor"><code>ClassifierCompositeItemProcessor</code></a></li>
</ul>
</li>
<li><a href="#messagingReadersAndWriters">6.15.2. Messaging Readers And Writers</a>
<ul class="sectlevel4">
<li><a href="#amqpItemReader"><code>AmqpItemReader</code></a></li>
<li><a href="#amqpItemWriter"><code>AmqpItemWriter</code></a></li>
<li><a href="#jmsItemReader"><code>JmsItemReader</code></a></li>
<li><a href="#jmsItemWriter"><code>JmsItemWriter</code></a></li>
</ul>
</li>
<li><a href="#databaseReaders">6.15.3. Database Readers</a>
<ul class="sectlevel4">
<li><a href="#Neo4jItemReader"><code>Neo4jItemReader</code></a></li>
<li><a href="#mongoItemReader"><code>MongoItemReader</code></a></li>
<li><a href="#hibernateCursorItemReader"><code>HibernateCursorItemReader</code></a></li>
<li><a href="#hibernatePagingItemReader"><code>HibernatePagingItemReader</code></a></li>
<li><a href="#repositoryItemReader"><code>RepositoryItemReader</code></a></li>
</ul>
</li>
<li><a href="#databaseWriters">6.15.4. Database Writers</a>
<ul class="sectlevel4">
<li><a href="#neo4jItemWriter"><code>Neo4jItemWriter</code></a></li>
<li><a href="#mongoItemWriter"><code>MongoItemWriter</code></a></li>
<li><a href="#repositoryItemWriter"><code>RepositoryItemWriter</code></a></li>
<li><a href="#hibernateItemWriter"><code>HibernateItemWriter</code></a></li>
<li><a href="#jdbcBatchItemWriter"><code>JdbcBatchItemWriter</code></a></li>
<li><a href="#jpaItemWriter"><code>JpaItemWriter</code></a></li>
<li><a href="#gemfireItemWriter"><code>GemfireItemWriter</code></a></li>
</ul>
</li>
<li><a href="#specializedReaders">6.15.5. Specialized Readers</a>
<ul class="sectlevel4">
<li><a href="#ldifReader"><code>LdifReader</code></a></li>
<li><a href="#mappingLdifReader"><code>MappingLdifReader</code></a></li>
</ul>
</li>
<li><a href="#specializedWriters">6.15.6. Specialized Writers</a>
<ul class="sectlevel4">
<li><a href="#simpleMailMessageItemWriter"><code>SimpleMailMessageItemWriter</code></a></li>
</ul>
</li>
<li><a href="#specializedProcessors">6.15.7. Specialized Processors</a>
<ul class="sectlevel4">
<li><a href="#scriptItemProcessor"><code>ScriptItemProcessor</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#scalability">7. Scaling and Parallel Processing</a>
<ul class="sectlevel2">
<li><a href="#multithreadedStep">7.1. Multi-threaded Step</a></li>
<li><a href="#scalabilityParallelSteps">7.2. Parallel Steps</a></li>
<li><a href="#remoteChunking">7.3. Remote Chunking</a></li>
<li><a href="#partitioning">7.4. Partitioning</a>
<ul class="sectlevel3">
<li><a href="#partitionHandler">7.4.1. PartitionHandler</a></li>
<li><a href="#stepExecutionSplitter">7.4.2. Partitioner</a></li>
<li><a href="#bindingInputDataToSteps">7.4.3. Binding Input Data to Steps</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#repeat">8. Repeat</a>
<ul class="sectlevel2">
<li><a href="#repeatTemplate">8.1. RepeatTemplate</a>
<ul class="sectlevel3">
<li><a href="#repeatContext">8.1.1. RepeatContext</a></li>
<li><a href="#repeatStatus">8.1.2. RepeatStatus</a></li>
</ul>
</li>
<li><a href="#completionPolicies">8.2. Completion Policies</a></li>
<li><a href="#repeatExceptionHandling">8.3. Exception Handling</a></li>
<li><a href="#repeatListeners">8.4. Listeners</a></li>
<li><a href="#repeatParallelProcessing">8.5. Parallel Processing</a></li>
<li><a href="#declarativeIteration">8.6. Declarative Iteration</a></li>
</ul>
</li>
<li><a href="#retry">9. Retry</a>
<ul class="sectlevel2">
<li><a href="#retryTemplate">9.1. <code>RetryTemplate</code></a>
<ul class="sectlevel3">
<li><a href="#retryContext">9.1.1. <code>RetryContext</code></a></li>
<li><a href="#recoveryCallback">9.1.2. <code>RecoveryCallback</code></a></li>
<li><a href="#statelessRetry">9.1.3. Stateless Retry</a></li>
<li><a href="#statefulRetry">9.1.4. Stateful Retry</a></li>
</ul>
</li>
<li><a href="#retryPolicies">9.2. Retry Policies</a></li>
<li><a href="#backoffPolicies">9.3. Backoff Policies</a></li>
<li><a href="#retryListeners">9.4. Listeners</a></li>
<li><a href="#declarativeRetry">9.5. Declarative Retry</a></li>
</ul>
</li>
<li><a href="#testing">10. Unit Testing</a>
<ul class="sectlevel2">
<li><a href="#creatingUnitTestClass">10.1. Creating a Unit Test Class</a></li>
<li><a href="#endToEndTesting">10.2. End-To-End Testing of Batch Jobs</a></li>
<li><a href="#testingIndividualSteps">10.3. Testing Individual Steps</a></li>
<li><a href="#testing-step-scoped-components">10.4. Testing Step-Scoped Components</a></li>
<li><a href="#validatingOutputFiles">10.5. Validating Output Files</a></li>
<li><a href="#mockingDomainObjects">10.6. Mocking Domain Objects</a></li>
</ul>
</li>
<li><a href="#commonPatterns">11. Common Batch Patterns</a>
<ul class="sectlevel2">
<li><a href="#loggingItemProcessingAndFailures">11.1. Logging Item Processing and Failures</a></li>
<li><a href="#stoppingAJobManuallyForBusinessReasons">11.2. Stopping a Job Manually for Business Reasons</a></li>
<li><a href="#addingAFooterRecord">11.3. Adding a Footer Record</a>
<ul class="sectlevel3">
<li><a href="#writingASummaryFooter">11.3.1. Writing a Summary Footer</a></li>
</ul>
</li>
<li><a href="#drivingQueryBasedItemReaders">11.4. Driving Query Based ItemReaders</a></li>
<li><a href="#multiLineRecords">11.5. Multi-Line Records</a></li>
<li><a href="#executingSystemCommands">11.6. Executing System Commands</a></li>
<li><a href="#handlingStepCompletionWhenNoInputIsFound">11.7. Handling Step Completion When No Input is Found</a></li>
<li><a href="#passingDataToFutureSteps">11.8. Passing Data to Future Steps</a></li>
</ul>
</li>
<li><a href="#jsr-352">12. JSR-352 Support</a>
<ul class="sectlevel2">
<li><a href="#jsrGeneralNotes">12.1. General Notes about Spring Batch and JSR-352</a></li>
<li><a href="#jsrSetup">12.2. Setup</a>
<ul class="sectlevel3">
<li><a href="#jsrSetupContexts">12.2.1. Application Contexts</a></li>
<li><a href="#jsrSetupLaunching">12.2.2. Launching a JSR-352 based job</a></li>
</ul>
</li>
<li><a href="#dependencyInjection">12.3. Dependency Injection</a></li>
<li><a href="#jsrJobProperties">12.4. Batch Properties</a>
<ul class="sectlevel3">
<li><a href="#jsrPropertySupport">12.4.1. Property Support</a></li>
<li><a href="#jsrBatchPropertyAnnotation">12.4.2. @BatchProperty annotation</a></li>
<li><a href="#jsrPropertySubstitution">12.4.3. Property Substitution</a></li>
</ul>
</li>
<li><a href="#jsrProcessingModels">12.5. Processing Models</a>
<ul class="sectlevel3">
<li><a href="#item-based-processing">12.5.1. Item based processing</a></li>
<li><a href="#custom-checkpointing">12.5.2. Custom checkpointing</a></li>
</ul>
</li>
<li><a href="#jsrRunningAJob">12.6. Running a job</a></li>
<li><a href="#jsrContexts">12.7. Contexts</a></li>
<li><a href="#jsrStepFlow">12.8. Step Flow</a></li>
<li><a href="#jsrScaling">12.9. Scaling a JSR-352 batch job</a>
<ul class="sectlevel3">
<li><a href="#jsrPartitioning">12.9.1. Partitioning</a></li>
</ul>
</li>
<li><a href="#jsrTesting">12.10. Testing</a></li>
</ul>
</li>
<li><a href="#springBatchIntegration">13. Spring Batch Integration</a>
<ul class="sectlevel2">
<li><a href="#spring-batch-integration-introduction">13.1. Spring Batch Integration Introduction</a>
<ul class="sectlevel3">
<li><a href="#namespace-support">13.1.1. Namespace Support</a></li>
<li><a href="#launching-batch-jobs-through-messages">13.1.2. Launching Batch Jobs through Messages</a>
<ul class="sectlevel4">
<li><a href="#transforming-a-file-into-a-joblaunchrequest">Transforming a file into a JobLaunchRequest</a></li>
<li><a href="#the-jobexecution-response">The <code>JobExecution</code> Response</a></li>
<li><a href="#spring-batch-integration-configuration">Spring Batch Integration Configuration</a></li>
<li><a href="#example-itemreader-configuration">Example ItemReader Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#availableAttributesOfTheJobLaunchingGateway">13.2. Available Attributes of the Job-Launching Gateway</a></li>
<li><a href="#sub-elements">13.3. Sub-Elements</a>
<ul class="sectlevel3">
<li><a href="#providing-feedback-with-informational-messages">13.3.1. Providing Feedback with Informational Messages</a></li>
<li><a href="#asynchronous-processors">13.3.2. Asynchronous Processors</a></li>
<li><a href="#externalizing-batch-process-execution">13.3.3. Externalizing Batch Process Execution</a>
<ul class="sectlevel4">
<li><a href="#remote-chunking">Remote Chunking</a></li>
<li><a href="#remote-partitioning">Remote Partitioning</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#listOfReadersAndWriters">Appendix A: List of ItemReaders and ItemWriters</a>
<ul class="sectlevel2">
<li><a href="#itemReadersAppendix">A.1. Item Readers</a></li>
<li><a href="#itemWritersAppendix">A.2. Item Writers</a></li>
</ul>
</li>
<li><a href="#metaDataSchema">Appendix B: Meta-Data Schema</a>
<ul class="sectlevel2">
<li><a href="#metaDataSchemaOverview">B.1. Overview</a>
<ul class="sectlevel3">
<li><a href="#exampleDDLScripts">B.1.1. Example DDL Scripts</a></li>
<li><a href="#migrationDDLScripts">B.1.2. Migration DDL Scripts</a></li>
<li><a href="#metaDataVersion">B.1.3. Version</a></li>
<li><a href="#metaDataIdentity">B.1.4. Identity</a></li>
</ul>
</li>
<li><a href="#metaDataBatchJobInstance">B.2. <code>BATCH_JOB_INSTANCE</code></a></li>
<li><a href="#metaDataBatchJobParams">B.3. <code>BATCH_JOB_EXECUTION_PARAMS</code></a></li>
<li><a href="#metaDataBatchJobExecution">B.4. <code>BATCH_JOB_EXECUTION</code></a></li>
<li><a href="#metaDataBatchStepExecution">B.5. <code>BATCH_STEP_EXECUTION</code></a></li>
<li><a href="#metaDataBatchJobExecutionContext">B.6. <code>BATCH_JOB_EXECUTION_CONTEXT</code></a></li>
<li><a href="#metaDataBatchStepExecutionContext">B.7. <code>BATCH_STEP_EXECUTION_CONTEXT</code></a></li>
<li><a href="#metaDataArchiving">B.8. Archiving</a></li>
<li><a href="#multiByteCharacters">B.9. International and Multi-byte Characters</a></li>
<li><a href="#recommendationsForIndexingMetaDataTables">B.10. Recommendations for Indexing Meta Data Tables</a></li>
</ul>
</li>
<li><a href="#transactions">Appendix C: Batch Processing and Transactions</a>
<ul class="sectlevel2">
<li><a href="#transactionsNoRetry">C.1. Simple Batching with No Retry</a></li>
<li><a href="#transactionStatelessRetry">C.2. Simple Stateless Retry</a></li>
<li><a href="#repeatRetry">C.3. Typical Repeat-Retry Pattern</a></li>
<li><a href="#asyncChunkProcessing">C.4. Asynchronous Chunk Processing</a></li>
<li><a href="#asyncItemProcessing">C.5. Asynchronous Item Processing</a></li>
<li><a href="#transactionPropagation">C.6. Interactions Between Batching and Transaction Propagation</a></li>
<li><a href="#specialTransactionOrthonogonal">C.7. Special Case: Transactions with Orthogonal Resources</a></li>
<li><a href="#statelessRetryCannotRecover">C.8. Stateless Retry Cannot Recover</a></li>
</ul>
</li>
<li><a href="#glossary">Appendix D: Glossary</a>
<ul class="sectlevel2">
<li><a href="#spring-batch-glossary">D.1. Spring Batch Glossary</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>
<div>
  <script type="text/javascript" src="jsfiles/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="jsfiles/js.cookie.js"></script>
  <script type="text/javascript" src="jsfiles/DocumentToggle.js"></script>
  <div class="docToggle-button">
    <input id="xmlButton" type="radio" name="docToggle" value="XML"><label for="xmlButton">XML</label>
    <input id="javaButton" type="radio" name="docToggle" value="Java" checked><label for="javaButton">Java</label>
    <!-- <input id="bothButton" type="radio" name="docToggle" value="Both" checked><label for="bothButton">Both</label> -->
  </div>
</div>
</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-batch-intro"><a class="anchor" href="#spring-batch-intro"></a>1. Spring Batch Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Many applications within the enterprise domain require bulk processing to perform
business operations in mission critical environments. These business operations include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Automated, complex processing of large volumes of information that is most efficiently
processed without user interaction. These operations typically include time-based events
(such as month-end calculations, notices, or correspondence).</p>
</li>
<li>
<p>Periodic application of complex business rules processed repetitively across very large
data sets (for example, insurance benefit determination or rate adjustments).</p>
</li>
<li>
<p>Integration of information that is received from internal and external systems that
typically requires formatting, validation, and processing in a transactional manner into
the system of record. Batch processing is used to process billions of transactions every
day for enterprises.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Batch is a lightweight, comprehensive batch framework designed to enable the
development of robust batch applications vital for the daily operations of enterprise
systems. Spring Batch builds upon the characteristics of the Spring Framework that people
have come to expect (productivity, POJO-based development approach, and general ease of
use), while making it easy for developers to access and leverage more advance enterprise
services when necessary. Spring Batch is not a scheduling framework. There are many good
enterprise schedulers (such as Quartz, Tivoli, Control-M, etc.) available in both the
commercial and open source spaces.  It is intended to work in conjunction with a
scheduler, not replace a scheduler.</p>
</div>
<div class="paragraph">
<p>Spring Batch provides reusable functions that are essential in processing large volumes
of records, including logging/tracing, transaction management, job processing statistics,
job restart, skip, and resource management. It also provides more advanced technical
services and features that enable extremely high-volume and high performance batch jobs
though optimization and partitioning techniques. Spring Batch can be used in both simple
use cases (such as reading a file into a database or running a stored procedure) as well
as complex, high volume use cases (such as moving high volumes of data between databases,
transforming it, and so on). High-volume batch jobs can leverage the framework in a
highly scalable manner to process significant volumes of information.</p>
</div>
<div class="sect2">
<h3 id="springBatchBackground"><a class="anchor" href="#springBatchBackground"></a>1.1. Background</h3>
<div class="paragraph">
<p>While open source software projects and associated communities have focused greater
attention on web-based and microservices-based architecture frameworks, there has been a
notable lack of focus on reusable architecture frameworks to accommodate Java-based batch
processing needs, despite continued needs to handle such processing within enterprise IT
environments. The lack of a standard, reusable batch architecture has resulted in the
proliferation of many one-off, in-house solutions developed within client enterprise IT
functions.</p>
</div>
<div class="paragraph">
<p>SpringSource (now Pivotal) and Accenture collaborated to change this. Accenture&#8217;s
hands-on industry and technical experience in implementing batch architectures,
SpringSource&#8217;s depth of technical experience, and Spring&#8217;s proven programming model
together made a natural and powerful partnership to create high-quality, market-relevant
software aimed at filling an important gap in enterprise Java. Both companies worked with
a number of clients who were solving similar problems by developing Spring-based batch
architecture solutions. This provided some useful additional detail and real-life
constraints that helped to ensure the solution can be applied to the real-world problems
posed by clients.</p>
</div>
<div class="paragraph">
<p>Accenture contributed previously proprietary batch processing architecture frameworks to
the Spring Batch project, along with committer resources to drive support, enhancements,
and the existing feature set. Accenture&#8217;s contribution was based upon decades of
experience in building batch architectures with the last several generations of
platforms: COBOL/Mainframe, C++/Unix, and now Java/anywhere.</p>
</div>
<div class="paragraph">
<p>The collaborative effort between Accenture and SpringSource aimed to promote the
standardization of software processing approaches, frameworks, and tools that can be
consistently leveraged by enterprise users when creating batch applications. Companies
and government agencies desiring to deliver standard, proven solutions to their
enterprise IT environments can benefit from Spring Batch.</p>
</div>
</div>
<div class="sect2">
<h3 id="springBatchUsageScenarios"><a class="anchor" href="#springBatchUsageScenarios"></a>1.2. Usage Scenarios</h3>
<div class="paragraph">
<p>A typical batch program generally:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reads a large number of records from a database, file, or queue.</p>
</li>
<li>
<p>Processes the data in some fashion.</p>
</li>
<li>
<p>Writes back data in a modified form.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Batch automates this basic batch iteration, providing the capability to process
similar transactions as a set, typically in an offline environment without any user
interaction. Batch jobs are part of most IT projects, and Spring Batch is the only open
source framework that provides a robust, enterprise-scale solution.</p>
</div>
<div class="paragraph">
<p>Business Scenarios</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Commit batch process periodically</p>
</li>
<li>
<p>Concurrent batch processing: parallel processing of a job</p>
</li>
<li>
<p>Staged, enterprise message-driven processing</p>
</li>
<li>
<p>Massively parallel batch processing</p>
</li>
<li>
<p>Manual or scheduled restart after failure</p>
</li>
<li>
<p>Sequential processing of dependent steps (with extensions toworkflow-driven batches)</p>
</li>
<li>
<p>Partial processing: skip records (for example, on rollback)</p>
</li>
<li>
<p>Whole-batch transaction, for cases with a small batch size or existing stored
procedures/scripts</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Technical Objectives</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Batch developers use the Spring programming model: Concentrate on business logic and
let the framework take care of infrastructure.</p>
</li>
<li>
<p>Clear separation of concerns between the infrastructure, the batch execution
environment, and the batch application.</p>
</li>
<li>
<p>Provide common, core execution services as interfaces that all projects can implement.</p>
</li>
<li>
<p>Provide simple and default implementations of the core execution interfaces that can be
used 'out of the box'.</p>
</li>
<li>
<p>Easy to configure, customize, and extend services, by leveraging the spring framework
in all layers.</p>
</li>
<li>
<p>All existing core services should be easy to replace or extend, without any impact to
the infrastructure layer.</p>
</li>
<li>
<p>Provide a simple deployment model, with the architecture JARs completely separate from
the application, built using Maven.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="springBatchArchitecture"><a class="anchor" href="#springBatchArchitecture"></a>1.3. Spring Batch Architecture</h3>
<div class="paragraph">
<p>Spring Batch is designed with extensibility and a diverse group of end users in mind. The
figure below shows the layered architecture that supports the extensibility and ease of
use for end-user developers.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/spring-batch-layers.png" alt="Figure 1.1: Spring Batch Layered Architecture">
</div>
<div class="title">Figure 1. Spring Batch Layered Architecture</div>
</div>
<div class="paragraph">
<p>This layered architecture highlights three major high-level components: Application,
Core, and Infrastructure. The application contains all batch jobs and custom code written
by developers using Spring Batch. The Batch Core contains the core runtime classes
necessary to launch and control a batch job. It includes implementations for
<code>JobLauncher</code>, <code>Job</code>, and <code>Step</code>. Both Application and Core are built on top of a common
infrastructure. This infrastructure contains common readers and writers and services
(such as the <code>RetryTemplate</code>), which are used both by application developers(readers and
writers, such as <code>ItemReader</code> and <code>ItemWriter</code>) and the core framework itself (retry,
which is its own library).</p>
</div>
</div>
<div class="sect2">
<h3 id="batchArchitectureConsiderations"><a class="anchor" href="#batchArchitectureConsiderations"></a>1.4. General Batch Principles and Guidelines</h3>
<div class="paragraph">
<p>The following key principles, guidelines, and general considerations should be considered
when building a batch solution.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Remember that a batch architecture typically affects on-line architecture and vice
versa. Design with both architectures and environments in mind using common building
blocks when possible.</p>
</li>
<li>
<p>Simplify as much as possible and avoid building complex logical structures in single
batch applications.</p>
</li>
<li>
<p>Keep the processing and storage of data physically close together (in other words, keep
your data where your processing occurs).</p>
</li>
<li>
<p>Minimize system resource use, especially I/O. Perform as many operations as possible in
internal memory.</p>
</li>
<li>
<p>Review application I/O (analyze SQL statements) to ensure that unnecessary physical I/O
is avoided. In particular, the following four common flaws need to be looked for:</p>
<div class="ulist">
<ul>
<li>
<p>Reading data for every transaction when the data could be read once and cached or kept
in the working storage.</p>
</li>
<li>
<p>Rereading data for a transaction where the data was read earlier in the same
transaction.</p>
</li>
<li>
<p>Causing unnecessary table or index scans.</p>
</li>
<li>
<p>Not specifying key values in the WHERE clause of an SQL statement.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Do not do things twice in a batch run. For instance, if you need data summarization for
reporting purposes, you should (if possible) increment stored totals when data is being
initially processed, so your reporting application does not have to reprocess the same
data.</p>
</li>
<li>
<p>Allocate enough memory at the beginning of a batch application to avoid time-consuming
reallocation during the process.</p>
</li>
<li>
<p>Always assume the worst with regard to data integrity. Insert adequate checks and
record validation to maintain data integrity.</p>
</li>
<li>
<p>Implement checksums for internal validation where possible. For example, flat files
should have a trailer record telling the total of records in the file and an aggregate of
the key fields.</p>
</li>
<li>
<p>Plan and execute stress tests as early as possible in a production-like environment
with realistic data volumes.</p>
</li>
<li>
<p>In large batch systems, backups can be challenging, especially if the system is running
concurrent with on-line on a 24-7 basis. Database backups are typically well taken care
of in the on-line design, but file backups should be considered to be just as important.
If the system depends on flat files, file backup procedures should not only be in place
and documented but be regularly tested as well.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="batchProcessingStrategy"><a class="anchor" href="#batchProcessingStrategy"></a>1.5. Batch Processing Strategies</h3>
<div class="paragraph">
<p>To help design and implement batch systems, basic batch application building blocks and
patterns should be provided to the designers and programmers in the form of sample
structure charts and code shells. When starting to design a batch job, the business logic
should be decomposed into a series of steps that can be implemented using the following
standard building blocks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Conversion Applications:</em> For each type of file supplied by or generated to an
external system, a conversion application must be created to convert the transaction
records supplied into a standard format required for processing. This type of batch
application can partly or entirely consist of translation utility modules (see Basic
Batch Services).</p>
</li>
<li>
<p><em>Validation Applications:</em> Validation applications ensure that all input/output
records are correct and consistent. Validation is typically based on file headers and
trailers, checksums and validation algorithms, and record level cross-checks.</p>
</li>
<li>
<p><em>Extract Applications:</em> An application that reads a set of records from a database or
input file, selects records based on predefined rules, and writes the records to an
output file.</p>
</li>
<li>
<p><em>Extract/Update Applications:</em> An application that reads records from a database or
an input file and makes changes to a database or an output file driven by the data found
in each input record.</p>
</li>
<li>
<p><em>Processing and Updating Applications:</em> An application that performs processing on
input transactions from an extract or a validation application. The processing usually
involves reading a database to obtain data required for processing, potentially updating
the database and creating records for output processing.</p>
</li>
<li>
<p><em>Output/Format Applications:</em> Applications that read an input file, restructure data
from this record according to a standard format, and produce an output file for printing
or transmission to another program or system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, a basic application shell should be provided for business logic that cannot
be built using the previously mentioned building blocks.</p>
</div>
<div class="paragraph">
<p>In addition to the main building blocks, each application may use one or more of standard
utility steps, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sort: A program that reads an input file and produces an output file where records
have been re-sequenced according to a sort key field in the records. Sorts are usually
performed by standard system utilities.</p>
</li>
<li>
<p>Split: A program that reads a single input file and writes each record to one of
several output files based on a field value. Splits can be tailored or performed by
parameter-driven standard system utilities.</p>
</li>
<li>
<p>Merge: A program that reads records from multiple input files and produces one output
file with combined data from the input files. Merges can be tailored or performed by
parameter-driven standard system utilities.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Batch applications can additionally be categorized by their input source:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Database-driven applications are driven by rows or values retrieved from the database.</p>
</li>
<li>
<p>File-driven applications are driven by records or values retrieved from a file.</p>
</li>
<li>
<p>Message-driven applications are driven by messages retrieved from a message queue.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The foundation of any batch system is the processing strategy. Factors affecting the
selection of the strategy include: estimated batch system volume, concurrency with
on-line systems or with other batch systems, available batch windows. (Note that, with
more enterprises wanting to be up and running 24x7, clear batch windows are
disappearing).</p>
</div>
<div class="paragraph">
<p>Typical processing options for batch are (in increasing order of implementation
complexity):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Normal processing during a batch window in off-line mode.</p>
</li>
<li>
<p>Concurrent batch or on-line processing.</p>
</li>
<li>
<p>Parallel processing of many different batch runs or jobs at the same time.</p>
</li>
<li>
<p>Partitioning (processing of many instances of the same job at the same time).</p>
</li>
<li>
<p>A combination of the preceding options.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some or all of these options may be supported by a commercial scheduler.</p>
</div>
<div class="paragraph">
<p>The following section discusses these processing options in more detail. It is important
to notice that, as a rule of thumb, the commit and locking strategy adopted by batch
processes depends on the type of processing performed and that the on-line locking
strategy should also use the same principles. Therefore, the batch architecture cannot be
simply an afterthought when designing an overall architecture.</p>
</div>
<div class="paragraph">
<p>The locking strategy can be to use only normal database locks or to implement an
additional custom locking service in the architecture. The locking service would track
database locking (for example, by storing the necessary information in a dedicated
db-table) and give or deny permissions to the application programs requesting a db
operation. Retry logic could also be implemented by this architecture to avoid aborting a
batch job in case of a lock situation.</p>
</div>
<div class="paragraph">
<p><strong>1. Normal processing in a batch window</strong> For simple batch processes running in a separate
batch window where the data being updated is not required by on-line users or other batch
processes, concurrency is not an issue and a single commit can be done at the end of the
batch run.</p>
</div>
<div class="paragraph">
<p>In most cases, a more robust approach is more appropriate. Keep in mind that batch
systems have a tendency to grow as time goes by, both in terms of complexity and the data
volumes they handle. If no locking strategy is in place and the system still relies on a
single commit point, modifying the batch programs can be painful. Therefore, even with
the simplest batch systems, consider the need for commit logic for restart-recovery
options as well as the information concerning the more complex cases described later in
this section.</p>
</div>
<div class="paragraph">
<p><strong>2. Concurrent batch or on-line processing</strong> Batch applications processing data that can
be simultaneously updated by on-line users should not lock any data (either in the
database or in files) which could be required by on-line users for more than a few
seconds. Also, updates should be committed to the database at the end of every few
transactions. This minimizes the portion of data that is unavailable to other processes
and the elapsed time the data is unavailable.</p>
</div>
<div class="paragraph">
<p>Another option to minimize physical locking is to have logical row-level locking
implemented with either an Optimistic Locking Pattern or a Pessimistic Locking Pattern.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Optimistic locking assumes a low likelihood of record contention. It typically means
inserting a timestamp column in each database table used concurrently by both batch and
on-line processing. When an application fetches a row for processing, it also fetches the
timestamp. As the application then tries to update the processed row, the update uses the
original timestamp in the WHERE clause. If the timestamp matches, the data and the
timestamp are updated. If the timestamp does not match, this indicates that another
application has updated the same row between the fetch and the update attempt. Therefore,
the update cannot be performed.</p>
</li>
<li>
<p>Pessimistic locking is any locking strategy that assumes there is a high likelihood of
record contention and therefore either a physical or logical lock needs to be obtained at
retrieval time. One type of pessimistic logical locking uses a dedicated lock-column in
the database table. When an application retrieves the row for update, it sets a flag in
the lock column. With the flag in place, other applications attempting to retrieve the
same row logically fail. When the application that sets the flag updates the row, it also
clears the flag, enabling the row to be retrieved by other applications. Please note that
the integrity of data must be maintained also between the initial fetch and the setting
of the flag, for example by using db locks (such as <code>SELECT FOR UPDATE</code>). Note also that
this method suffers from the same downside as physical locking except that it is somewhat
easier to manage building a time-out mechanism that gets the lock released if the user
goes to lunch while the record is locked.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These patterns are not necessarily suitable for batch processing, but they might be used
for concurrent batch and on-line processing (such as in cases where the database does not
support row-level locking). As a general rule, optimistic locking is more suitable for
on-line applications, while pessimistic locking is more suitable for batch applications.
Whenever logical locking is used, the same scheme must be used for all applications
accessing data entities protected by logical locks.</p>
</div>
<div class="paragraph">
<p>Note that both of these solutions only address locking a single record. Often, we may
need to lock a logically related group of records. With physical locks, you have to
manage these very carefully in order to avoid potential deadlocks. With logical locks, it
is usually best to build a logical lock manager that understands the logical record
groups you want to protect and that can ensure that locks are coherent and
non-deadlocking. This logical lock manager usually uses its own tables for lock
management, contention reporting, time-out mechanism, and other concerns.</p>
</div>
<div class="paragraph">
<p><strong>3. Parallel Processing</strong> Parallel processing allows multiple batch runs or jobs to run in
parallel to minimize the total elapsed batch processing time. This is not a problem as
long as the jobs are not sharing the same files, db-tables, or index spaces. If they do,
this service should be implemented using partitioned data. Another option is to build an
architecture module for maintaining interdependencies by using a control table. A control
table should contain a row for each shared resource and whether it is in use by an
application or not. The batch architecture or the application in a parallel job would
then retrieve information from that table to determine if it can get access to the
resource it needs or not.</p>
</div>
<div class="paragraph">
<p>If the data access is not a problem, parallel processing can be implemented through the
use of additional threads to process in parallel.  In the mainframe environment, parallel
job classes have traditionally been used, in order to ensure adequate CPU time for all
the processes. Regardless, the solution has to be robust enough to ensure time slices for
all the running processes.</p>
</div>
<div class="paragraph">
<p>Other key issues in parallel processing include load balancing and the availability of
general system resources such as files, database buffer pools, and so on. Also note that
the control table itself can easily become a critical resource.</p>
</div>
<div class="paragraph">
<p><strong>4. Partitioning</strong> Using partitioning allows multiple versions of large batch applications
to run concurrently. The purpose of this is to reduce the elapsed time required to
process long batch jobs. Processes that can be successfully partitioned are those where
the input file can be split and/or the main database tables partitioned to allow the
application to run against different sets of data.</p>
</div>
<div class="paragraph">
<p>In addition, processes which are partitioned must be designed to only process their
assigned data set. A partitioning architecture has to be closely tied to the database
design and the database partitioning strategy. Note that database partitioning does not
necessarily mean physical partitioning of the database, although in most cases this is
advisable. The following picture illustrates the partitioning approach:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/partitioned.png" alt="Figure 1.2: Partitioned Process">
</div>
<div class="title">Figure 2. Partitioned Process</div>
</div>
<div class="paragraph">
<p>The architecture should be flexible enough to allow dynamic configuration of the number
of partitions. Both automatic and user controlled configuration should be considered.
Automatic configuration may be based on parameters such as the input file size and the
number of input records.</p>
</div>
<div class="paragraph">
<p><strong>4.1 Partitioning Approaches</strong> Selecting a partitioning approach has to be done on a
case-by-case basis. The  following list describes some of the possible partitioning
approaches:</p>
</div>
<div class="paragraph">
<p><em>1. Fixed and Even Break-Up of Record Set</em></p>
</div>
<div class="paragraph">
<p>This involves breaking the input record set into an even number of portions (for example,
10, where each portion has exactly 1/10th of the entire record set). Each portion is then
processed by one instance of the batch/extract application.</p>
</div>
<div class="paragraph">
<p>In order to use this approach, preprocessing is required to split the recordset up. The
result of this split will be a lower and upper bound placement number which can be used
as input to the batch/extract application in order to restrict its processing to only its
portion.</p>
</div>
<div class="paragraph">
<p>Preprocessing could be a large overhead, as it has to calculate and determine the bounds
of each portion of the record set.</p>
</div>
<div class="paragraph">
<p><em>2. Break up by a Key Column</em></p>
</div>
<div class="paragraph">
<p>This involves breaking up the input record set by a key column, such as a location code,
and assigning data from each key to a batch instance. In order to achieve this, column
values can be either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Assigned to a batch instance by a partitioning table (described later in this
section).</p>
</li>
<li>
<p>Assigned to a batch instance by a portion of the value (such as 0000-0999, 1000 - 1999,
and so on).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Under option 1, adding new values means a manual reconfiguration of the batch/extract to
ensure that the new value is added to a particular instance.</p>
</div>
<div class="paragraph">
<p>Under option 2, this ensures that all values are covered via an instance of the batch
job. However, the number of values processed by one instance is dependent on the
distribution of column values (there may be a large number of locations in the 0000-0999
range, and few in the 1000-1999 range). Under this option, the data range should be
designed with partitioning in mind.</p>
</div>
<div class="paragraph">
<p>Under both options, the optimal even distribution of records to batch instances cannot be
realized. There is no dynamic configuration of the number of batch instances used.</p>
</div>
<div class="paragraph">
<p><em>3. Breakup by Views</em></p>
</div>
<div class="paragraph">
<p>This approach is basically breakup by a key column but on the database level. It involves
breaking up the recordset into views. These views are used by each instance of the batch
application during its processing. The breakup is done by grouping the data.</p>
</div>
<div class="paragraph">
<p>With this option, each instance of a batch application has to be configured to hit a
particular view (instead of the master table). Also, with the addition of new data
values, this new group of data has to be included into a view. There is no dynamic
configuration capability, as a change in the number of instances results in a change to
the views.</p>
</div>
<div class="paragraph">
<p><em>4. Addition of a Processing Indicator</em></p>
</div>
<div class="paragraph">
<p>This involves the addition of a new column to the input table, which acts as an
indicator. As a preprocessing step, all indicators are marked as being non-processed.
During the record fetch stage of the batch application, records are read on the condition
that that record is marked as being non-processed, and once they are read (with lock),
they are marked as being in processing. When that record is completed, the indicator is
updated to either complete or error. Many instances of a batch application can be started
without a change, as the additional column ensures that a record is only processed once.
sentence or two on the order of "On completion, indicators are marked as being
complete.")</p>
</div>
<div class="paragraph">
<p>With this option, I/O on the table increases dynamically. In the case of an updating
batch application, this impact is reduced, as a write must occur anyway.</p>
</div>
<div class="paragraph">
<p><em>5. Extract Table to a Flat File</em></p>
</div>
<div class="paragraph">
<p>This involves the extraction of the table into a file. This file can then be split into
multiple segments and used as input to the batch instances.</p>
</div>
<div class="paragraph">
<p>With this option, the additional overhead of extracting the table into a file and
splitting it may cancel out the effect of multi-partitioning. Dynamic configuration can
be achieved by changing the file splitting script.</p>
</div>
<div class="paragraph">
<p><em>6. Use of a Hashing Column</em></p>
</div>
<div class="paragraph">
<p>This scheme involves the addition of a hash column (key/index) to the database tables
used to retrieve the driver record. This hash column has an indicator to determine which
instance of the batch application processes this particular row. For example, if there
are three batch instances to be started, then an indicator of 'A' marks a row for
processing by instance 1, an indicator of 'B' marks a row for processing by instance 2,
and an indicator of 'C' marks a row for processing by instance 3.</p>
</div>
<div class="paragraph">
<p>The procedure used to retrieve the records would then have an additional <code>WHERE</code> clause
to select all rows marked by a particular indicator. The inserts in this table would
involve the addition of the marker field, which would be defaulted to one of the
instances (such as 'A').</p>
</div>
<div class="paragraph">
<p>A simple batch application would be used to update the indicators, such as to
redistribute the load between the different instances. When a sufficiently large number
of new rows have been added, this batch can be run (anytime, except in the batch window)
to redistribute the new rows to other instances.</p>
</div>
<div class="paragraph">
<p>Additional instances of the batch application only require the running of the batch
application as described in the preceding paragraphs to redistribute the indicators to
work with a new number of instances.</p>
</div>
<div class="paragraph">
<p><strong>4.2 Database and Application Design Principles</strong></p>
</div>
<div class="paragraph">
<p>An architecture that supports multi-partitioned applications which run against
partitioned database tables using the key column approach should include a central
partition repository for storing partition parameters. This provides flexibility and
ensures maintainability. The repository generally consists of a single table, known as
the partition table.</p>
</div>
<div class="paragraph">
<p>Information stored in the partition table is static and, in general, should be maintained
by the DBA. The table should consist of one row of information for each partition of a
multi-partitioned application. The table should have columns for  Program ID Code,
Partition Number (logical ID of the partition), Low Value of the db key column for this
partition, and High Value of the db key column for this partition.</p>
</div>
<div class="paragraph">
<p>On program start-up, the program <code>id</code> and partition number should be passed to the
application from the architecture (specifically, from the Control Processing Tasklet). If
a key column approach is used, these variables are used to read the partition table in
order to determine what range of data the application is to process. In addition the
partition number must be used throughout the processing to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add to the output files/database updates in order for the merge process to work
properly.</p>
</li>
<li>
<p>Report normal processing to the batch log and any errors to the architecture error
handler.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>4.3 Minimizing Deadlocks</strong></p>
</div>
<div class="paragraph">
<p>When applications run in parallel or are partitioned, contention in database resources
and deadlocks may occur. It is critical that the database design team eliminates
potential contention situations as much as possible as part of the database design.</p>
</div>
<div class="paragraph">
<p>Also, the developers must ensure that the database index tables are designed with
deadlock prevention and performance in mind.</p>
</div>
<div class="paragraph">
<p>Deadlocks or hot spots often occur in administration or architecture tables, such as log
tables, control tables, and lock tables. The implications of these should be taken into
account as well. A realistic stress test is crucial for identifying the possible
bottlenecks in the architecture.</p>
</div>
<div class="paragraph">
<p>To minimize the impact of conflicts on data, the architecture should provide services
such as wait-and-retry intervals when attaching to a database or when encountering a
deadlock. This means a built-in mechanism to react to certain database return codes and,
instead of issuing an immediate error, waiting a predetermined amount of time and
retrying the database operation.</p>
</div>
<div class="paragraph">
<p><strong>4.4 Parameter Passing and Validation</strong></p>
</div>
<div class="paragraph">
<p>The partition architecture should be relatively transparent to application developers.
The architecture should perform all tasks associated with running the application in a
partitioned mode, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Retrieving partition parameters before application start-up.</p>
</li>
<li>
<p>Validating partition parameters before application start-up.</p>
</li>
<li>
<p>Passing parameters to the application at start-up.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The validation should include checks to ensure that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The application has sufficient partitions to cover the whole data range.</p>
</li>
<li>
<p>There are no gaps between partitions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the database is partitioned, some additional validation may be necessary to ensure
that a single partition does not span database partitions.</p>
</div>
<div class="paragraph">
<p>Also, the architecture should take into consideration the consolidation of partitions.
Key questions include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Must all the partitions be finished before going into the next job step?</p>
</li>
<li>
<p>What happens if one of the partitions aborts?</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="whatsNew"><a class="anchor" href="#whatsNew"></a>2. What&#8217;s New in Spring Batch 4.1</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Spring Batch 4.1 release adds the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A new <code>@SpringBatchTest</code> annotation to simplify testing batch components</p>
</li>
<li>
<p>A new <code>@EnableBatchIntegration</code> annotation to simplify remote chunking and partitioning configuration</p>
</li>
<li>
<p>A new <code>JsonItemReader</code> and <code>JsonFileItemWriter</code> to support the JSON format</p>
</li>
<li>
<p>Add support for validating items with the Bean Validation API</p>
</li>
<li>
<p>Add support for JSR-305 annotations</p>
</li>
<li>
<p>Enhancements to the <code>FlatFileItemWriterBuilder</code> API</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="whatsNewTesting"><a class="anchor" href="#whatsNewTesting"></a>2.1. <code>@SpringBatchTest</code> Annotation</h3>
<div class="paragraph">
<p>Spring Batch provides some nice utility classes (such as the <code>JobLauncherTestUtils</code> and
<code>JobRepositoryTestUtils</code>) and test execution listeners (<code>StepScopeTestExecutionListener</code>
and <code>JobScopeTestExecutionListener</code>) to test batch components. However, in order
to use these utilities, you must configure them explicitly. This release introduces
a new annotation named <code>@SpringBatchTest</code> that automatically adds utility beans and
listeners to the test context and makes them  available for autowiring,
as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RunWith</span>(SpringRunner.class)
<span class="annotation">@SpringBatchTest</span>
<span class="annotation">@ContextConfiguration</span>(classes = {JobConfiguration.class})
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobTest</span> {

   <span class="annotation">@Autowired</span>
   <span class="directive">private</span> JobLauncherTestUtils jobLauncherTestUtils;

   <span class="annotation">@Autowired</span>
   <span class="directive">private</span> JobRepositoryTestUtils jobRepositoryTestUtils;


   <span class="annotation">@Before</span>
   <span class="directive">public</span> <span class="type">void</span> clearMetadata() {
      jobRepositoryTestUtils.removeJobExecutions();
   }

   <span class="annotation">@Test</span>
   <span class="directive">public</span> <span class="type">void</span> testJob() <span class="directive">throws</span> <span class="exception">Exception</span> {
      <span class="comment">// given</span>
      JobParameters jobParameters =
            jobLauncherTestUtils.getUniqueJobParameters();

      <span class="comment">// when</span>
      JobExecution jobExecution =
            jobLauncherTestUtils.launchJob(jobParameters);

      <span class="comment">// then</span>
      Assert.assertEquals(ExitStatus.COMPLETED,
                          jobExecution.getExitStatus());
   }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details about this new annotation, see the
<a href="#creatingUnitTestClass">Unit Testing</a> chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="whatsNewIntegration"><a class="anchor" href="#whatsNewIntegration"></a>2.2. <code>@EnableBatchIntegration</code> Annotation</h3>
<div class="paragraph">
<p>Setting up a remote chunking job requires the definition of a number of beans:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A connection factory to acquire connections from the messaging middleware (JMS, AMQP, and others)</p>
</li>
<li>
<p>A <code>MessagingTemplate</code> to send requests from the master to the workers and back again</p>
</li>
<li>
<p>An input channel and an output channel for Spring Integration to get messages from the messaging middleware</p>
</li>
<li>
<p>A special item writer (<code>ChunkMessageChannelItemWriter</code>) on the master side that knows how to send chunks of data to workers for processing and writing</p>
</li>
<li>
<p>A message listener (<code>ChunkProcessorChunkHandler</code>) on the worker side to receive data from the master</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This can be a bit daunting at first glance. This release introduces a new annotation
named <code>@EnableBatchIntegration</code> as well as new APIs (<code>RemoteChunkingMasterStepBuilder</code>
and <code>RemoteChunkingWorkerBuilder</code>) to simplify the configuration. The following
example shows how to use the new annotation and APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Configuration</span>
<span class="annotation">@EnableBatchProcessing</span>
<span class="annotation">@EnableBatchIntegration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RemoteChunkingAppConfig</span> {

   <span class="annotation">@Autowired</span>
   <span class="directive">private</span> RemoteChunkingMasterStepBuilderFactory masterStepBuilderFactory;

   <span class="annotation">@Autowired</span>
   <span class="directive">private</span> RemoteChunkingWorkerBuilder workerBuilder;

   <span class="annotation">@Bean</span>
   <span class="directive">public</span> TaskletStep masterStep() {
         <span class="keyword">return</span> <span class="local-variable">this</span>.masterStepBuilderFactory
                         .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">masterStep</span><span class="delimiter">&quot;</span></span>)
                         .chunk(<span class="integer">100</span>)
                         .reader(itemReader())
                         .outputChannel(outgoingRequestsToWorkers())
                         .inputChannel(incomingRepliesFromWorkers())
                         .build();
   }

   <span class="annotation">@Bean</span>
   <span class="directive">public</span> IntegrationFlow worker() {
         <span class="keyword">return</span> <span class="local-variable">this</span>.workerBuilder
                         .itemProcessor(itemProcessor())
                         .itemWriter(itemWriter())
                         .inputChannel(incomingRequestsFromMaster())
                         .outputChannel(outgoingRepliesToMaster())
                         .build();
   }

   <span class="comment">// Middleware beans setup omitted</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This new annotation and builders take care of the heavy lifting of configuring
infrastructure beans. You can now easily configure a master step as well as
a Spring Integration flow on the worker side. You can find a remote chunking sample
that uses these new APIs in the
<a href="https://github.com/spring-projects/spring-batch/tree/master/spring-batch-samples#remote-chunking-sample">samples module</a>
as well as more details in the <a href="#remote-chunking">Spring Batch Integration</a> chapter.</p>
</div>
<div class="paragraph">
<p>Just like the remote chunking configuration simplification, this version also
introduces new APIs to simplify a remote partitioning setup:
<code>RemotePartitioningMasterStepBuilder</code> and <code>RemotePartitioningWorkerStepBuilder</code>.
Those can be autowired in your configuration class if the
<code>@EnableBatchIntegration</code> is present as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Configuration</span>
<span class="annotation">@EnableBatchProcessing</span>
<span class="annotation">@EnableBatchIntegration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RemotePartitioningAppConfig</span> {

   <span class="annotation">@Autowired</span>
   <span class="directive">private</span> RemotePartitioningMasterStepBuilderFactory masterStepBuilderFactory;

   <span class="annotation">@Autowired</span>
   <span class="directive">private</span> RemotePartitioningWorkerStepBuilderFactory workerStepBuilderFactory;

   <span class="annotation">@Bean</span>
   <span class="directive">public</span> Step masterStep() {
            <span class="keyword">return</span> <span class="local-variable">this</span>.masterStepBuilderFactory
               .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">masterStep</span><span class="delimiter">&quot;</span></span>)
               .partitioner(<span class="string"><span class="delimiter">&quot;</span><span class="content">workerStep</span><span class="delimiter">&quot;</span></span>, partitioner())
               .gridSize(<span class="integer">10</span>)
               .outputChannel(outgoingRequestsToWorkers())
               .inputChannel(incomingRepliesFromWorkers())
               .build();
   }

   <span class="annotation">@Bean</span>
   <span class="directive">public</span> Step workerStep() {
            <span class="keyword">return</span> <span class="local-variable">this</span>.workerStepBuilderFactory
               .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">workerStep</span><span class="delimiter">&quot;</span></span>)
               .inputChannel(incomingRequestsFromMaster())
               .outputChannel(outgoingRepliesToMaster())
               .chunk(<span class="integer">100</span>)
               .reader(itemReader())
               .processor(itemProcessor())
               .writer(itemWriter())
               .build();
   }

   <span class="comment">// Middleware beans setup omitted</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can find more details about these new APIs in the <a href="#remote-partitioning">Spring Batch Integration</a> chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="whatsNewJson"><a class="anchor" href="#whatsNewJson"></a>2.3. JSON support</h3>
<div class="paragraph">
<p>Spring Batch 4.1 adds support for the JSON format. This release introduces a new
item reader that can read a JSON resource in the following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[
  {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">isin</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">quantity</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="float">1.2</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>
  },
  {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">isin</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">456</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">quantity</span><span class="delimiter">&quot;</span></span>: <span class="integer">2</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="float">1.4</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>
  }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to the <code>StaxEventItemReader</code> for XML, the new <code>JsonItemReader</code> uses streaming
APIs to read JSON objects in chunks. Spring Batch supports two libraries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/FasterXML/jackson">Jackson</a></p>
</li>
<li>
<p><a href="https://github.com/google/gson">Gson</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To add other libraries, you can implement the <code>JsonObjectReader</code> interface.</p>
</div>
<div class="paragraph">
<p>Writing JSON data is also supported through the <code>JsonFileItemWriter</code>.
For more details about JSON support, see the
<a href="#jsonReadingWriting">ItemReaders and ItemWriters</a> chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="whatsNewBeanValidationApi"><a class="anchor" href="#whatsNewBeanValidationApi"></a>2.4. Bean Validation API support</h3>
<div class="paragraph">
<p>This release brings a new <code>ValidatingItemProcessor</code> implementation called
<code>BeanValidatingItemProcessor</code> which allows you to validate items annotated with
the Bean Validation API (JSR-303) annotations. For example, given the following
type <code>Person</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

    <span class="annotation">@NotEmpty</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> Person(<span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.name = name;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> name;
    }

    <span class="directive">public</span> <span class="type">void</span> setName(<span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.name = name;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>you can validate items by declaring a <code>BeanValidatingItemProcessor</code> bean in your
application context and register it as a processor in your chunk-oriented step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> BeanValidatingItemProcessor&lt;Person&gt; beanValidatingItemProcessor() <span class="directive">throws</span> <span class="exception">Exception</span> {
        BeanValidatingItemProcessor&lt;Person&gt; beanValidatingItemProcessor = <span class="keyword">new</span> BeanValidatingItemProcessor&lt;&gt;();
        beanValidatingItemProcessor.setFilter(<span class="predefined-constant">true</span>);

        <span class="keyword">return</span> beanValidatingItemProcessor;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="whatsNewJSR305Api"><a class="anchor" href="#whatsNewJSR305Api"></a>2.5. JSR-305 support</h3>
<div class="paragraph">
<p>This release adds support for JSR-305 annotations. It leverages Spring Framework’s
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#null-safety">Null-safety</a>
annotations and adds them on all public APIs of Spring Batch.</p>
</div>
<div class="paragraph">
<p>These annotations will not only enforce null-safety when using Spring Batch APIs,
but also can be used by IDEs to provide useful information related to nullability.
For example, if a user wants to implement the <code>ItemReader</code> interface, any IDE
supporting JSR-305 annotations will generate something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyItemReader</span> <span class="directive">implements</span> ItemReader&lt;<span class="predefined-type">String</span>&gt; {

        <span class="annotation">@Nullable</span>
        <span class="directive">public</span> <span class="predefined-type">String</span> read() <span class="directive">throws</span> <span class="exception">Exception</span> {
                <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Nullable</code> annotation present on the <code>read</code> method makes it clear that the
contract of this method says it may return <code>null</code>. This enforces what is said in its
Javadoc, that the <code>read</code> method should return <code>null</code> when the data source is exhausted.</p>
</div>
</div>
<div class="sect2">
<h3 id="whatsNewFlatFileItemWriterBuilder"><a class="anchor" href="#whatsNewFlatFileItemWriterBuilder"></a>2.6. <code>FlatFileItemWriterBuilder</code> enhancements</h3>
<div class="paragraph">
<p>Another small feature added in this release is a simplification of the configuration
for the writing of a flat file. Specifically, these updates simplify the configuration
of both a delimited and fixed width file. Below is an example of before and after the change.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Before</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemWriter&lt;Item&gt; itemWriter(Resource resource) {
        BeanWrapperFieldExtractor&lt;Item&gt; fieldExtractor =
            <span class="keyword">new</span> BeanWrapperFieldExtractor&lt;Item&gt;();
        fieldExtractor.setNames(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">field1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">field2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">field3</span><span class="delimiter">&quot;</span></span>});
        fieldExtractor.afterPropertiesSet();

        DelimitedLineAggregator aggregator = <span class="keyword">new</span> DelimitedLineAggregator();
        aggregator.setFieldExtractor(fieldExtractor);
        aggregator.setDelimiter(<span class="string"><span class="delimiter">&quot;</span><span class="content">;</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemWriterBuilder&lt;Item&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span>)
                        .resource(resource)
                        .lineAggregator(aggregator)
                        .build();
}

<span class="comment">// After</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemWriter&lt;Item&gt; itemWriter(Resource resource) {
        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemWriterBuilder&lt;Item&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span>)
                        .resource(resource)
                        .delimited()
                        .delimiter(<span class="string"><span class="delimiter">&quot;</span><span class="content">;</span><span class="delimiter">&quot;</span></span>)
                        .names(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">field1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">field2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">field3</span><span class="delimiter">&quot;</span></span>})
                        .build();
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="domainLanguageOfBatch"><a class="anchor" href="#domainLanguageOfBatch"></a>3. The Domain Language of Batch</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To any experienced batch architect, the overall concepts of batch processing used in
Spring Batch should be familiar and comfortable. There are "Jobs" and "Steps" and
developer-supplied processing units called <code>ItemReader</code> and <code>ItemWriter</code>. However,
because of the Spring patterns, operations, templates, callbacks, and idioms, there are
opportunities for the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Significant improvement in adherence to a clear separation of concerns.</p>
</li>
<li>
<p>Clearly delineated architectural layers and services provided as interfaces.</p>
</li>
<li>
<p>Simple and default implementations that allow for quick adoption and ease of use
out-of-the-box.</p>
</li>
<li>
<p>Significantly enhanced extensibility.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following diagram is a simplified version of the batch reference architecture that
has been used for decades. It provides an overview of the components that make up the
domain language of batch processing. This architecture framework is a blueprint that has
been proven through decades of implementations on the last several generations of
platforms (COBOL/Mainframe, C/Unix, and now Java/anywhere). JCL and COBOL developers
are likely to be as comfortable with the concepts as C, C#, and Java developers. Spring
Batch provides a physical implementation of the layers, components, and technical
services commonly found in the robust, maintainable systems that are used to address the
creation of simple to complex batch applications, with the infrastructure and extensions
to address very complex processing needs.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/spring-batch-reference-model.png" alt="Figure 2.1: Batch Stereotypes">
</div>
<div class="title">Figure 3. Batch Stereotypes</div>
</div>
<div class="paragraph">
<p>The preceding diagram highlights the key concepts that make up the domain language of
Spring Batch. A Job has one to many steps, each of which has exactly one <code>ItemReader</code>,
one <code>ItemProcessor</code>, and one <code>ItemWriter</code>. A job needs to be launched (with
<code>JobLauncher</code>), and metadata about the currently running process needs to be stored (in
<code>JobRepository</code>).</p>
</div>
<div class="sect2">
<h3 id="job"><a class="anchor" href="#job"></a>3.1. Job</h3>
<div class="paragraph">
<p>This section describes stereotypes relating to the concept of a batch job. A <code>Job</code> is an
entity that encapsulates an entire batch process. As is common with other Spring
projects, a <code>Job</code> is wired together with either an XML configuration file or Java-based
configuration. This configuration may be referred to as the "job configuration". However,
<code>Job</code> is just the top of an overall hierarchy, as shown in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/job-heirarchy.png" alt="Job Hierarchy">
</div>
<div class="title">Figure 4. Job Hierarchy</div>
</div>
<div class="paragraph">
<p>In Spring Batch, a <code>Job</code> is simply a container for <code>Step</code> instances. It combines multiple
steps that belong logically together in a flow and allows for configuration of properties
global to all steps, such as restartability. The job configuration contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The simple name of the job.</p>
</li>
<li>
<p>Definition and ordering of <code>Step</code> instances.</p>
</li>
<li>
<p>Whether or not the job is restartable.</p>
</li>
</ul>
</div>
<div class="paragraph javaContent">
<p>A default simple implementation of the Job interface is provided by Spring Batch in the
form of the <code>SimpleJob</code> class, which creates some standard functionality on top of <code>Job</code>.
When using java based configuration, a collection of builders is made available for the
instantiation of a <code>Job</code>, as shown in the following example:</p>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job footballJob() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span>)
                     .start(playerLoad())
                     .next(gameLoad())
                     .next(playerSummarization())
                     .end()
                     .build();
}</code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>A default simple implementation of the <code>Job</code> interface is provided by Spring Batch in the
form of the <code>SimpleJob</code> class, which creates some standard functionality on top of <code>Job</code>.
However, the batch namespace abstracts away the need to instantiate it directly. Instead,
the <code>&lt;job&gt;</code> tag can be used as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerload</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gameLoad</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gameLoad</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarization</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarization</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="jobinstance"><a class="anchor" href="#jobinstance"></a>3.1.1. JobInstance</h4>
<div class="paragraph">
<p>A <code>JobInstance</code> refers to the concept of a logical job run. Consider a batch job that
should be run once at the end of the day, such as the 'EndOfDay' <code>Job</code> from the preceding
diagram. There is one 'EndOfDay' job, but each individual run of the <code>Job</code> must be
tracked separately. In the case of this job, there is one logical <code>JobInstance</code> per day.
For example, there is a January 1st run, a January 2nd run, and so on. If the January 1st
run fails the first time and is run again the next day, it is still the January 1st run.
(Usually, this corresponds with the data it is processing as well, meaning the January
1st run processes data for January 1st). Therefore, each <code>JobInstance</code> can have multiple
executions (<code>JobExecution</code> is discussed in more detail later in this chapter), and only
one <code>JobInstance</code> corresponding to a particular <code>Job</code> and identifying <code>JobParameters</code> can
run at a given time.</p>
</div>
<div class="paragraph">
<p>The definition of a <code>JobInstance</code> has absolutely no bearing on the data the to be loaded.
It is entirely up to the <code>ItemReader</code> implementation to determine how data is loaded. For
example, in the EndOfDay scenario, there may be a column on the data that indicates the
'effective date' or 'schedule date' to which the data belongs. So, the January 1st run
would load only data from the 1st, and the January 2nd run would use only data from the
2nd. Because this determination is likely to be a business decision, it is left up to the
<code>ItemReader</code> to decide. However, using the same <code>JobInstance</code> determines whether or not
the 'state' (that is, the <code>ExecutionContext</code>, which is discussed later in this chapter)
from previous executions is used. Using a new <code>JobInstance</code> means 'start from the
beginning', and using an existing instance generally means 'start from where you left
off'.</p>
</div>
</div>
<div class="sect3">
<h4 id="jobparameters"><a class="anchor" href="#jobparameters"></a>3.1.2. JobParameters</h4>
<div class="paragraph">
<p>Having discussed <code>JobInstance</code> and how it differs from Job, the natural question to ask
is: "How is one <code>JobInstance</code> distinguished from another?" The answer is:
<code>JobParameters</code>. A <code>JobParameters</code> object holds a set of parameters used to start a batch
job. They can be used for identification or even as reference data during the run, as
shown in the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/job-stereotypes-parameters.png" alt="Job Parameters">
</div>
<div class="title">Figure 5. Job Parameters</div>
</div>
<div class="paragraph">
<p>In the preceding example, where there are two instances, one for January 1st, and another
for January 2nd, there is really only one <code>Job</code>, but it has two <code>JobParameter</code> objects:
one that was started with a job parameter of 01-01-2017 and another that was started with
a parameter of 01-02-2017. Thus, the contract can be defined as: <code>JobInstance</code> = <code>Job</code>
 + identifying <code>JobParameters</code>. This allows a developer to effectively control how a
<code>JobInstance</code> is defined, since they control what parameters are passed in.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Not all job parameters are required to contribute to the identification of a
<code>JobInstance</code>.  By default, they do so. However, the framework also allows the submission
of a <code>Job</code> with parameters that do not contribute to the identity of a <code>JobInstance</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="jobexecution"><a class="anchor" href="#jobexecution"></a>3.1.3. JobExecution</h4>
<div class="paragraph">
<p>A <code>JobExecution</code> refers to the technical concept of a single attempt to run a Job. An
execution may end in failure or success, but the <code>JobInstance</code> corresponding to a given
execution is not considered to be complete unless the execution completes successfully.
Using the EndOfDay <code>Job</code> described previously as an example, consider a <code>JobInstance</code> for
01-01-2017 that failed the first time it was run. If it is run again with the same
identifying job parameters as the first run (01-01-2017), a new <code>JobExecution</code> is
created. However, there is still only one <code>JobInstance</code>.</p>
</div>
<div class="paragraph">
<p>A <code>Job</code> defines what a job is and how it is to be executed, and a <code>JobInstance</code> is a
purely organizational object to group executions together, primarily to enable correct
restart semantics. A <code>JobExecution</code>, however, is the primary storage mechanism for what
actually happened during a run and contains many more properties that must be controlled
and persisted, as shown in the following table:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. JobExecution Properties</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>BatchStatus</code> object that indicates the status of the execution. While running, it is
<code>BatchStatus#STARTED</code>. If it fails, it is <code>BatchStatus#FAILED</code>. If it finishes
successfully, it is <code>BatchStatus#COMPLETED</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">startTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>java.util.Date</code> representing the current system time when the execution was started.
This field is empty if the job has yet to start.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">endTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>java.util.Date</code> representing the current system time when the execution finished,
regardless of whether or not it was successful. The field is empty if the job has yet to
finish.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">exitStatus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>ExitStatus</code>, indicating the result of the run. It is most important, because it
contains an exit code that is returned to the caller. See chapter 5 for more details. The
field is empty if the job has yet to finish.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">createTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>java.util.Date</code> representing the current system time when the <code>JobExecution</code> was
first persisted. The job may not have been started yet (and thus has no start time), but
it always has a createTime, which is required by the framework for managing job level
<code>ExecutionContexts</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lastUpdated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>java.util.Date</code> representing the last time a <code>JobExecution</code> was persisted. This field
is empty if the job has yet to start.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">executionContext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The "property bag" containing any user data that needs to be persisted between
executions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">failureExceptions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The list of exceptions encountered during the execution of a <code>Job</code>. These can be useful
if more than one exception is encountered during the failure of a <code>Job</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These properties are important because they are persisted and can be used to completely
determine the status of an execution. For example, if the EndOfDay job for 01-01 is
executed at 9:00 PM and fails at 9:30, the following entries are made in the batch
metadata tables:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. BATCH_JOB_INSTANCE</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_INST_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayJob</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. BATCH_JOB_EXECUTION_PARAMS</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TYPE_CD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">KEY_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATE_VAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IDENTIFYING</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">schedule.Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. BATCH_JOB_EXECUTION</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXEC_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_INST_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">START_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">END_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-01 21:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-01 21:30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAILED</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Column names may have been abbreviated or removed for the sake of clarity and
formatting.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that the job has failed, assume that it took the entire night for the problem to be
determined, so that the 'batch window' is now closed. Further assuming that the window
starts at 9:00 PM, the job is kicked off again for 01-01, starting where it left off and
completing successfully at 9:30. Because it is now the next day, the 01-02 job must be
run as well, and it is kicked off just afterwards at 9:31 and completes in its normal one
hour time at 10:30. There is no requirement that one <code>JobInstance</code> be kicked off after
another, unless there is potential for the two jobs to attempt to access the same data,
causing issues with locking at the database level. It is entirely up to the scheduler to
determine when a <code>Job</code> should be run. Since they are separate <code>JobInstances</code>, Spring
Batch makes no attempt to stop them from being run concurrently. (Attempting to run the
same <code>JobInstance</code> while another is already running results in a
<code>JobExecutionAlreadyRunningException</code> being thrown). There should now be an extra entry
in both the <code>JobInstance</code> and <code>JobParameters</code> tables and two extra entries in the
<code>JobExecution</code> table, as shown in the following tables:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 5. BATCH_JOB_INSTANCE</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_INST_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayJob</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayJob</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 6. BATCH_JOB_EXECUTION_PARAMS</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TYPE_CD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">KEY_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATE_VAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IDENTIFYING</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">schedule.Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-01 00:00:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">schedule.Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-01 00:00:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">schedule.Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-02 00:00:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 7. BATCH_JOB_EXECUTION</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXEC_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_INST_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">START_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">END_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-01 21:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-01 21:30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAILED</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-02 21:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-02 21:30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">COMPLETED</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-02 21:31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-02 22:29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">COMPLETED</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Column names may have been abbreviated or removed for the sake of clarity and
formatting.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="step"><a class="anchor" href="#step"></a>3.2. Step</h3>
<div class="paragraph">
<p>A <code>Step</code> is a domain object that encapsulates an independent, sequential phase of a batch
job. Therefore, every Job is composed entirely of one or more steps. A <code>Step</code> contains
all of the information necessary to define and control the actual batch processing. This
is a necessarily vague description because the contents of any given <code>Step</code> are at the
discretion of the developer writing a <code>Job</code>. A <code>Step</code> can be as simple or complex as the
developer desires. A simple <code>Step</code> might load data from a file into the database,
requiring little or no code (depending upon the implementations used). A more complex
<code>Step</code> may have complicated business rules that are applied as part of the processing. As
with a <code>Job</code>, a <code>Step</code> has an individual <code>StepExecution</code> that correlates with a unique
<code>JobExecution</code>, as shown in the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/jobHeirarchyWithSteps.png" alt="Figure 2.1: Job Hierarchy With Steps">
</div>
<div class="title">Figure 6. Job Hierarchy With Steps</div>
</div>
<div class="sect3">
<h4 id="stepexecution"><a class="anchor" href="#stepexecution"></a>3.2.1. StepExecution</h4>
<div class="paragraph">
<p>A <code>StepExecution</code> represents a single attempt to execute a <code>Step</code>. A new <code>StepExecution</code>
is created each time a <code>Step</code> is run, similar to <code>JobExecution</code>. However, if a step fails
to execute because the step before it fails, no execution is persisted for it. A
<code>StepExecution</code> is created only when its <code>Step</code> is actually started.</p>
</div>
<div class="paragraph">
<p><code>Step</code> executions are represented by objects of the <code>StepExecution</code> class. Each execution
contains a reference to its corresponding step and <code>JobExecution</code> and transaction related
data, such as commit and rollback counts and start and end times. Additionally, each step
execution contains an <code>ExecutionContext</code>, which contains any data a developer needs to
have persisted across batch runs, such as statistics or state information needed to
restart. The following table lists the properties for <code>StepExecution</code>:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 8. StepExecution Properties</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>BatchStatus</code> object that indicates the status of the execution. While running, the
status is <code>BatchStatus.STARTED</code>. If it fails, the status is <code>BatchStatus.FAILED</code>. If it
finishes successfully, the status is <code>BatchStatus.COMPLETED</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">startTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>java.util.Date</code> representing the current system time when the execution was started.
This field is empty if the step has yet to start.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">endTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>java.util.Date</code> representing the current system time when the execution finished,
regardless of whether or not it was successful. This field is empty if the step has yet to
exit.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">exitStatus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>ExitStatus</code> indicating the result of the execution. It is most important, because
it contains an exit code that is returned to the caller. See chapter 5 for more details.
This field is empty if the job has yet to exit.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">executionContext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The "property bag" containing any user data that needs to be persisted between
executions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">readCount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of items that have been successfully read.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">writeCount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of items that have been successfully written.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">commitCount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of transactions that have been committed for this execution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rollbackCount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of times the business transaction controlled by the <code>Step</code> has been rolled
back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">readSkipCount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of times <code>read</code> has failed, resulting in a skipped item.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">processSkipCount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of times <code>process</code> has failed, resulting in a skipped item.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">filterCount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of items that have been 'filtered' by the <code>ItemProcessor</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">writeSkipCount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of times <code>write</code> has failed, resulting in a skipped item.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="executioncontext"><a class="anchor" href="#executioncontext"></a>3.3. ExecutionContext</h3>
<div class="paragraph">
<p>An <code>ExecutionContext</code> represents a collection of key/value pairs that are persisted and
controlled by the framework in order to allow developers a place to store persistent
state that is scoped to a <code>StepExecution</code> object or a <code>JobExecution</code> object. For those
familiar with Quartz, it is very similar to JobDataMap. The best usage example is to
facilitate restart. Using flat file input as an example, while processing individual
lines, the framework periodically persists the <code>ExecutionContext</code> at commit points. Doing
so allows the <code>ItemReader</code> to store its state in case a fatal error occurs during the run
or even if the power goes out. All that is needed is to put the current number of lines
read into the context, as shown in the following example, and the framework will do the
rest:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">executionContext.putLong(getKey(LINES_READ_COUNT), reader.getPosition());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the EndOfDay example from the <code>Job</code> Stereotypes section as an example, assume there
is one step, 'loadData', that loads a file into the database. After the first failed run,
the metadata tables would look like the following example:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 9. BATCH_JOB_INSTANCE</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_INST_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayJob</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 10. BATCH_JOB_EXECUTION_PARAMS</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_INST_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TYPE_CD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">KEY_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATE_VAL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">schedule.Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-01</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 11. BATCH_JOB_EXECUTION</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXEC_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_INST_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">START_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">END_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-01 21:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-01 21:30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAILED</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 12. BATCH_STEP_EXECUTION</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STEP_EXEC_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXEC_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STEP_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">START_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">END_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">loadData</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-01 21:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-01-01 21:30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAILED</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 13. BATCH_STEP_EXECUTION_CONTEXT</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STEP_EXEC_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHORT_CONTEXT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{piece.count=40321}</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In the preceding case, the <code>Step</code> ran for 30 minutes and processed 40,321 'pieces', which
would represent lines in a file in this scenario. This value is updated just before each
commit by the framework and can contain multiple rows corresponding to entries within the
<code>ExecutionContext</code>. Being notified before a commit requires one of the various
<code>StepListener</code> implementations (or an <code>ItemStream</code>), which are discussed in more detail
later in this guide. As with the previous example, it is assumed that the <code>Job</code> is
restarted the next day. When it is restarted, the values from the <code>ExecutionContext</code> of
the last run are reconstituted from the database. When the <code>ItemReader</code> is opened, it can
check to see if it has any stored state in the context and initialize itself from there,
as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">if</span> (executionContext.containsKey(getKey(LINES_READ_COUNT))) {
    log.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Initializing for restart. Restart data is: </span><span class="delimiter">&quot;</span></span> + executionContext);

    <span class="type">long</span> lineCount = executionContext.getLong(getKey(LINES_READ_COUNT));

    LineReader reader = getReader();

    <span class="predefined-type">Object</span> record = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
    <span class="keyword">while</span> (reader.getPosition() &lt; lineCount &amp;&amp; record != <span class="predefined-constant">null</span>) {
        record = readLine();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, after the above code runs, the current line is 40,322, allowing the <code>Step</code>
to start again from where it left off. The <code>ExecutionContext</code> can also be used for
statistics that need to be persisted about the run itself. For example, if a flat file
contains orders for processing that exist across multiple lines, it may be necessary to
store how many orders have been processed (which is much different from the number of
lines read), so that an email can be sent at the end of the <code>Step</code> with the total number
of orders processed in the body. The framework handles storing this for the developer, in
order to correctly scope it with an individual <code>JobInstance</code>. It can be very difficult to
know whether an existing <code>ExecutionContext</code> should be used or not. For example, using the
'EndOfDay' example from above, when the 01-01 run starts again for the second time, the
framework recognizes that it is the same <code>JobInstance</code> and on an individual <code>Step</code> basis,
pulls the <code>ExecutionContext</code> out of the database, and hands it (as part of the
<code>StepExecution</code>) to the <code>Step</code> itself. Conversely, for the 01-02 run, the framework
recognizes that it is a different instance, so an empty context must be handed to the
<code>Step</code>. There are many of these types of determinations that the framework makes for the
developer, to ensure the state is given to them at the correct time. It is also important
to note that exactly one <code>ExecutionContext</code> exists per <code>StepExecution</code> at any given time.
Clients of the <code>ExecutionContext</code> should be careful, because this creates a shared
keyspace. As a result, care should be taken when putting values in to ensure no data is
overwritten. However, the <code>Step</code> stores absolutely no data in the context, so there is no
way to adversely affect the framework.</p>
</div>
<div class="paragraph">
<p>It is also important to note that there is at least one <code>ExecutionContext</code> per
<code>JobExecution</code> and one for every <code>StepExecution</code>. For example, consider the following
code snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ExecutionContext ecStep = stepExecution.getExecutionContext();
ExecutionContext ecJob = jobExecution.getExecutionContext();
<span class="comment">//ecStep does not equal ecJob</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As noted in the comment, <code>ecStep</code> does not equal <code>ecJob</code>. They are two different
<code>ExecutionContexts</code>. The one scoped to the <code>Step</code> is saved at every commit point in the
<code>Step</code>, whereas the one scoped to the Job is saved in between every <code>Step</code> execution.</p>
</div>
</div>
<div class="sect2">
<h3 id="jobrepository"><a class="anchor" href="#jobrepository"></a>3.4. JobRepository</h3>
<div class="paragraph">
<p><code>JobRepository</code> is the persistence mechanism for all of the Stereotypes mentioned above.
It provides CRUD operations for <code>JobLauncher</code>, <code>Job</code>, and <code>Step</code> implementations. When a
<code>Job</code> is first launched, a <code>JobExecution</code> is obtained from the repository, and, during
the course of execution, <code>StepExecution</code> and <code>JobExecution</code> implementations are persisted
by passing them to the repository.</p>
</div>
<div class="paragraph xmlContent">
<p>The batch namespace provides support for configuring a <code>JobRepository</code> instance with the
<code>&lt;job-repository&gt;</code> tag, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job-repository</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>When using java configuration, <code>@EnableBatchProcessing</code> annotation provides a
<code>JobRepository</code> as one of the components automatically configured out of the box.</p>
</div>
</div>
<div class="sect2">
<h3 id="joblauncher"><a class="anchor" href="#joblauncher"></a>3.5. JobLauncher</h3>
<div class="paragraph">
<p><code>JobLauncher</code> represents a simple interface for launching a <code>Job</code> with a given set of
<code>JobParameters</code>, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">JobLauncher</span> {

<span class="directive">public</span> JobExecution run(Job job, JobParameters jobParameters)
            <span class="directive">throws</span> JobExecutionAlreadyRunningException, JobRestartException,
                   JobInstanceAlreadyCompleteException, JobParametersInvalidException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is expected that implementations obtain a valid <code>JobExecution</code> from the
<code>JobRepository</code> and execute the <code>Job</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="item-reader"><a class="anchor" href="#item-reader"></a>3.6. Item Reader</h3>
<div class="paragraph">
<p><code>ItemReader</code> is an abstraction that represents the retrieval of input for a <code>Step</code>, one
item at a time. When the <code>ItemReader</code> has exhausted the items it can provide, it
indicates this by returning <code>null</code>. More details about the <code>ItemReader</code> interface and its
various implementations can be found in
<a href="#readersAndWriters">Readers And Writers</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="item-writer"><a class="anchor" href="#item-writer"></a>3.7. Item Writer</h3>
<div class="paragraph">
<p><code>ItemWriter</code> is an abstraction that represents the output of a <code>Step</code>, one batch or chunk
of items at a time.  Generally, an <code>ItemWriter</code> has no knowledge of the input it should
receive next and knows only the item that was passed in its current invocation. More
details about the <code>ItemWriter</code> interface and its various implementations can be found in
<a href="#readersAndWriters">Readers And Writers</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="item-processor"><a class="anchor" href="#item-processor"></a>3.8. Item Processor</h3>
<div class="paragraph">
<p><code>ItemProcessor</code> is an abstraction that represents the business processing of an item.
While the <code>ItemReader</code> reads one item, and the <code>ItemWriter</code> writes them, the
<code>ItemProcessor</code> provides an access point to transform or apply other business processing.
If, while processing the item, it is determined that the item is not valid, returning
<code>null</code> indicates that the item should not be written out. More details about the
<code>ItemProcessor</code> interface can be found in
<a href="#readersAndWriters">Readers And Writers</a>.</p>
</div>
</div>
<div class="sect2 xmlContent">
<h3 id="batch-namespace"><a class="anchor" href="#batch-namespace"></a>3.9. Batch Namespace</h3>
<div class="paragraph">
<p>Many of the domain concepts listed previously need to be configured in a Spring
<code>ApplicationContext</code>. While there are implementations of the interfaces above that can be
used in a standard bean definition, a namespace has been provided for ease of
configuration, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans:beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
<span class="attribute-name">xmlns:beans</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
<span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
<span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
   <span class="content">http://www.springframework.org/schema/beans</span>
   <span class="content">https://www.springframework.org/schema/beans/spring-beans.xsd</span>
   <span class="content">http://www.springframework.org/schema/batch</span>
   <span class="content">https://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

<span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ioSampleJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span>

<span class="tag">&lt;/beans:beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>As long as the batch namespace has been declared, any of its elements can be used. More
information on configuring a Job can be found in <a href="#configureJob">Configuring and
Running a Job</a>. More information on configuring a <code>Step</code> can be found in
<a href="#configureStep">Configuring a Step</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configureJob"><a class="anchor" href="#configureJob"></a>4. Configuring and Running a Job</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the <a href="#domainLanguageOfBatch">domain section</a> , the overall
  architecture design was discussed, using the following diagram as a
  guide:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/spring-batch-reference-model.png" alt="Figure 2.1: Batch Stereotypes">
</div>
<div class="title">Figure 7. Batch Stereotypes</div>
</div>
<div class="paragraph">
<p>While the <code>Job</code> object may seem like a simple
container for steps, there are many configuration options of which a
developer must be aware. Furthermore, there are many considerations for
how a <code>Job</code> will be run and how its meta-data will be
stored during that run. This chapter will explain the various configuration
options and runtime concerns of a <code>Job</code>.</p>
</div>
<div class="sect2">
<h3 id="configuringAJob"><a class="anchor" href="#configuringAJob"></a>4.1. Configuring a Job</h3>
<div class="paragraph javaContent">
<p>There are multiple implementations of the <a href="#configureJob"><code>Job</code></a> interface, however
builders abstract away the difference in configuration.</p>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job footballJob() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span>)
                     .start(playerLoad())
                     .next(gameLoad())
                     .next(playerSummarization())
                     .end()
                     .build();
}</code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>A <code>Job</code> (and typically any <code>Step</code> within it) requires a <code>JobRepository</code>.  The
configuration of the <code>JobRepository</code> is handled via the <a href="#javaConfig"><code>BatchConfigurer</code></a>.</p>
</div>
<div class="paragraph javaContent">
<p>The above example illustrates a <code>Job</code> that consists of three <code>Step</code> instances.  The job related
builders can also contain other elements that help with parallelisation (<code>Split</code>),
declarative flow control (<code>Decision</code>) and externalization of flow definitions (<code>Flow</code>).</p>
</div>
<div class="paragraph xmlContent">
<p>There are multiple implementations of the <a href="#configureJob"><code>Job</code></a> interface, however, the namespace
abstracts away the differences in configuration. It has only three
required dependencies: a name, a <code>JobRepository</code> , and
a list of <code>Step</code> instances.</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerload</span><span class="delimiter">&quot;</span></span>          <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gameLoad</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gameLoad</span><span class="delimiter">&quot;</span></span>            <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarization</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarization</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>The examples here use a parent bean definition to create the steps;
see the section on <a href="#configureStep">step configuration</a>
for more options declaring specific step details inline. The XML namespace
defaults to referencing a repository with an id of 'jobRepository', which
is a sensible default. However, this can be overridden explicitly:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">specialRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerload</span><span class="delimiter">&quot;</span></span>          <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gameLoad</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gameLoad</span><span class="delimiter">&quot;</span></span>            <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarization</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarization</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>In addition to steps a job configuration can contain other elements
    that help with parallelisation (<code>&lt;split&gt;</code>),
    declarative flow control (<code>&lt;decision&gt;</code>) and
    externalization of flow definitions
    (<code>&lt;flow/&gt;</code>).</p>
</div>
<div class="sect3">
<h4 id="restartability"><a class="anchor" href="#restartability"></a>4.1.1. Restartability</h4>
<div class="paragraph">
<p>One key issue when executing a batch job concerns the behavior of
a <code>Job</code> when it is restarted. The launching of a
<code>Job</code> is considered to be a 'restart' if a
<code>JobExecution</code> already exists for the particular
<code>JobInstance</code>. Ideally, all jobs should be able to
start up where they left off, but there are scenarios where this is not
possible. <em>It is entirely up to the developer to ensure that a new <code>JobInstance</code> is created in this scenario</em>. However, Spring Batch does provide some help. If a
<code>Job</code> should never be restarted, but should always
be run as part of a new <code>JobInstance</code>, then the
restartable property may be set to 'false':</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restartable</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job footballJob() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span>)
                     .preventRestart()
                     ...
                     .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To phrase it another way, setting restartable to false means "this
<code>Job</code> does not support being started again". Restarting a <code>Job</code> that is not
restartable will cause a <code>JobRestartException</code> to
be thrown:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Job job = <span class="keyword">new</span> SimpleJob();
job.setRestartable(<span class="predefined-constant">false</span>);

JobParameters jobParameters = <span class="keyword">new</span> JobParameters();

JobExecution firstExecution = jobRepository.createJobExecution(job, jobParameters);
jobRepository.saveOrUpdate(firstExecution);

<span class="keyword">try</span> {
    jobRepository.createJobExecution(job, jobParameters);
    fail();
}
<span class="keyword">catch</span> (JobRestartException e) {
    <span class="comment">// expected</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This snippet of JUnit code shows how attempting to create a
<code>JobExecution</code> the first time for a non restartable
job will cause no issues. However, the second
attempt will throw a <code>JobRestartException</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="interceptingJobExecution"><a class="anchor" href="#interceptingJobExecution"></a>4.1.2. Intercepting Job Execution</h4>
<div class="paragraph">
<p>During the course of the execution of a
Job, it may be useful to be notified of various
events in its lifecycle so that custom code may be executed. The
<code>SimpleJob</code> allows for this by calling a
<code>JobListener</code> at the appropriate time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">JobExecutionListener</span> {

    <span class="type">void</span> beforeJob(JobExecution jobExecution);

    <span class="type">void</span> afterJob(JobExecution jobExecution);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>JobListeners</code> can be added to a
<code>SimpleJob</code> via the listeners element on the
job:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerload</span><span class="delimiter">&quot;</span></span>          <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gameLoad</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gameLoad</span><span class="delimiter">&quot;</span></span>            <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarization</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarization</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;listeners&gt;</span>
        <span class="tag">&lt;listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/listeners&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job footballJob() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span>)
                     .listener(sampleListener())
                     ...
                     .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It should be noted that <code>afterJob</code> will be
      called regardless of the success or failure of the
      Job. If success or failure needs to be determined
      it can be obtained from the <code>JobExecution</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> afterJob(JobExecution jobExecution){
    <span class="keyword">if</span>( jobExecution.getStatus() == BatchStatus.COMPLETED ){
        <span class="comment">//job success</span>
    }
    <span class="keyword">else</span> <span class="keyword">if</span>(jobExecution.getStatus() == BatchStatus.FAILED){
        <span class="comment">//job failure</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The annotations corresponding to this interface are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@BeforeJob</code></p>
</li>
<li>
<p><code>@AfterJob</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3 xmlContent">
<h4 id="inheritingFromAParentJob"><a class="anchor" href="#inheritingFromAParentJob"></a>4.1.3. Inheriting from a Parent Job</h4>
<div class="paragraph xmlContent">
<p>If a group of Jobs share similar, but not
      identical, configurations, then it may be helpful to define a "parent"
      <code>Job</code> from which the concrete
      Jobs may inherit properties. Similar to class
      inheritance in Java, the "child" <code>Job</code> will combine
      its elements and attributes with the parent&#8217;s.</p>
</div>
<div class="paragraph xmlContent">
<p>In the following example, "baseJob" is an abstract
      <code>Job</code> definition that defines only a list of
      listeners. The <code>Job</code> "job1" is a concrete
      definition that inherits the list of listeners from "baseJob" and merges
      it with its own list of listeners to produce a
      <code>Job</code> with two listeners and one
      <code>Step</code>, "step1".</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">baseJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">abstract</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;listeners&gt;</span>
        <span class="tag">&lt;listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenerOne</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;listeners&gt;</span>
<span class="tag">&lt;/job&gt;</span>

<span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">baseJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standaloneStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;listeners</span> <span class="attribute-name">merge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenerTwo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;listeners&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>Please see the section on <a href="#inheritingFromParentStep">Inheriting from a Parent Step</a>
      for more detailed information.</p>
</div>
</div>
<div class="sect3">
<h4 id="jobparametersvalidator"><a class="anchor" href="#jobparametersvalidator"></a>4.1.4. JobParametersValidator</h4>
<div class="paragraph">
<p>A job declared in the XML namespace or using any subclass of
      <code>AbstractJob</code> can optionally declare a validator for the job parameters at
      runtime. This is useful when for instance you need to assert that a job
      is started with all its mandatory parameters. There is a
      <code>DefaultJobParametersValidator</code> that can be used to constrain combinations
      of simple mandatory and optional parameters, and for more complex
      constraints you can implement the interface yourself.</p>
</div>
<div class="paragraph xmlContent">
<p>The configuration of a validator is supported through the XML namespace through a child
      element of the job, e.g:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">baseJob3</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standaloneStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;validator</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parametersValidator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>The validator can be specified as a reference (as above) or as a
      nested bean definition in the beans namespace.</p>
</div>
<div class="paragraph javaContent">
<p>The configuration of a validator is supported through the java builders, e.g:</p>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job1() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job1</span><span class="delimiter">&quot;</span></span>)
                     .validator(parametersValidator())
                     ...
                     .build();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="javaConfig"><a class="anchor" href="#javaConfig"></a>4.2. Java Config</h3>
<div class="paragraph">
<p>Spring 3 brought the ability to configure applications via java in addition to XML.
  	As of Spring Batch 2.2.0, batch jobs can be configured using the same
  	java config.  There are two components for the java based configuration:
  	the <code>@EnableBatchProcessing</code> annotation and two builders.</p>
</div>
<div class="paragraph">
<p>The <code>@EnableBatchProcessing</code> works similarly to the other
  	@Enable* annotations in the Spring family.  In this case,
  	<code>@EnableBatchProcessing</code> provides a base configuration for
  	building batch jobs.  Within this base configuration, an instance of
  	<code>StepScope</code> is created in addition to a number of beans made
  	available to be autowired:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JobRepository</code> - bean name "jobRepository"</p>
</li>
<li>
<p><code>JobLauncher</code> - bean name "jobLauncher"</p>
</li>
<li>
<p><code>JobRegistry</code> - bean name "jobRegistry"</p>
</li>
<li>
<p><code>PlatformTransactionManager</code> - bean name "transactionManager"</p>
</li>
<li>
<p><code>JobBuilderFactory</code> - bean name "jobBuilders"</p>
</li>
<li>
<p><code>StepBuilderFactory</code> - bean name "stepBuilders"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The core interface for this configuration is the <code>BatchConfigurer</code>.
    The default implementation provides the beans mentioned above and requires a
    <code>DataSource</code> as a bean within the context to be provided.  This data
    source will be used by the JobRepository. You can customize any of these beans
    by creating a custom implementation of the <code>BatchConfigurer</code> interface.
    Typically, extending the <code>DefaultBatchConfigurer</code> (which is provided if a
    <code>BatchConfigurer</code> is not found) and overriding the required getter is sufficient.
    However, implementing your own from scratch may be required. The following
    example shows how to provide a custom transaction manager:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> BatchConfigurer batchConfigurer() {
        <span class="keyword">return</span> <span class="keyword">new</span> DefaultBatchConfigurer() {
                <span class="annotation">@Override</span>
                <span class="directive">public</span> PlatformTransactionManager getTransactionManager() {
                        <span class="keyword">return</span> <span class="keyword">new</span> MyTransactionManager();
                }
        };
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Only one configuration class needs to have the
    	<code>@EnableBatchProcessing</code> annotation.  Once you have a class
    	annotated with it, you will have all of the above available.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the base configuration in place, a user can use the provided builder factories
	to configure a job.  Below is an example of a two step job configured via the
	<code>JobBuilderFactory</code> and the <code>StepBuilderFactory</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Configuration</span>
<span class="annotation">@EnableBatchProcessing</span>
<span class="annotation">@Import</span>(DataSourceConfiguration.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">AppConfig</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> JobBuilderFactory jobs;

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> StepBuilderFactory steps;

    <span class="annotation">@Bean</span>
    <span class="directive">public</span> Job job(<span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>) Step step1, <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span>) Step step2) {
        <span class="keyword">return</span> jobs.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">myJob</span><span class="delimiter">&quot;</span></span>).start(step1).next(step2).build();
    }

    <span class="annotation">@Bean</span>
    <span class="directive">protected</span> Step step1(ItemReader&lt;Person&gt; reader,
                         ItemProcessor&lt;Person, Person&gt; processor,
                         ItemWriter&lt;Person&gt; writer) {
        <span class="keyword">return</span> steps.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
            .&lt;Person, Person&gt; chunk(<span class="integer">10</span>)
            .reader(reader)
            .processor(processor)
            .writer(writer)
            .build();
    }

    <span class="annotation">@Bean</span>
    <span class="directive">protected</span> Step step2(Tasklet tasklet) {
        <span class="keyword">return</span> steps.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span>)
            .tasklet(tasklet)
            .build();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuringJobRepository"><a class="anchor" href="#configuringJobRepository"></a>4.3. Configuring a JobRepository</h3>
<div class="paragraph javaContent">
<p>When using <code>@EnableBatchProcessing</code>, a <code>JobRepository</code> is provided out of the box for you.
This section addresses configuring your own.</p>
</div>
<div class="paragraph">
<p>As described in earlier, the <a href="#configureJob"><code>JobRepository</code></a> is used for basic CRUD operations of the various persisted
    domain objects within Spring Batch, such as
    <code>JobExecution</code> and
    <code>StepExecution</code>. It is required by many of the major
    framework features, such as the <code>JobLauncher</code>,
    <code>Job</code>, and <code>Step</code>.</p>
</div>
<div class="paragraph xmlContent">
<p>The batch
    namespace abstracts away many of the implementation details of the
    <code>JobRepository</code> implementations and their
    collaborators. However, there are still a few configuration options
    available:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job-repository</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">data-source</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">isolation-level-for-create</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SERIALIZABLE</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">table-prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BATCH_</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">max-varchar-length</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>None of the configuration options listed above are required except
    the id. If they are not set, the defaults shown above will be used. They
    are shown above for awareness purposes. The
    <code>max-varchar-length</code> defaults to 2500, which is the
    length of the long <code>VARCHAR</code> columns in the <a href="#metaDataSchemaOverview">sample schema scripts</a></p>
</div>
<div class="paragraph javaContent">
<p>When using java configuration, a <code>JobRepository</code> is provided for you.  A JDBC based one is
provided out of the box if a <code>DataSource</code> is provided, the <code>Map</code> based one if not.  However
you can customize the configuration of the <code>JobRepository</code> via an implementation of the
<code>BatchConfigurer</code> interface.</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
<span class="comment">// This would reside in your BatchConfigurer implementation</span>
<span class="annotation">@Override</span>
<span class="directive">protected</span> JobRepository createJobRepository() <span class="directive">throws</span> <span class="exception">Exception</span> {
    JobRepositoryFactoryBean factory = <span class="keyword">new</span> JobRepositoryFactoryBean();
    factory.setDataSource(dataSource);
    factory.setTransactionManager(transactionManager);
    factory.setIsolationLevelForCreate(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISOLATION_SERIALIZABLE</span><span class="delimiter">&quot;</span></span>);
    factory.setTablePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">BATCH_</span><span class="delimiter">&quot;</span></span>);
    factory.setMaxVarCharLength(<span class="integer">1000</span>);
    <span class="keyword">return</span> factory.getObject();
}
...</code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>None of the configuration options listed above are required except
    the dataSource and transactionManager. If they are not set, the defaults shown above
    will be used. They are shown above for awareness purposes. The
    max varchar length defaults to 2500, which is the
    length of the long <code>VARCHAR</code> columns in the
    <a href="#metaDataSchemaOverview">sample schema scripts</a></p>
</div>
<div class="sect3">
<h4 id="txConfigForJobRepository"><a class="anchor" href="#txConfigForJobRepository"></a>4.3.1. Transaction Configuration for the JobRepository</h4>
<div class="paragraph">
<p>If the namespace or the provided <code>FactoryBean</code> is used, transactional advice will be
      automatically created around the repository. This is to ensure that the
      batch meta data, including state that is necessary for restarts after a
      failure, is persisted correctly. The behavior of the framework is not
      well defined if the repository methods are not transactional. The
      isolation level in the <code>create*</code> method attributes is
      specified separately to ensure that when jobs are launched, if two
      processes are trying to launch the same job at the same time, only one
      will succeed. The default isolation level for that method is
      SERIALIZABLE, which is quite aggressive: READ_COMMITTED would work just
      as well; READ_UNCOMMITTED would be fine if two processes are not likely
      to collide in this way. However, since a call to the
      <code>create*</code> method is quite short, it is unlikely
      that the SERIALIZED will cause problems, as long as the database
      platform supports it. However, this can be overridden:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job-repository</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">isolation-level-for-create</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REPEATABLE_READ</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// This would reside in your BatchConfigurer implementation</span>
<span class="annotation">@Override</span>
<span class="directive">protected</span> JobRepository createJobRepository() <span class="directive">throws</span> <span class="exception">Exception</span> {
    JobRepositoryFactoryBean factory = <span class="keyword">new</span> JobRepositoryFactoryBean();
    factory.setDataSource(dataSource);
    factory.setTransactionManager(transactionManager);
    factory.setIsolationLevelForCreate(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISOLATION_REPEATABLE_READ</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> factory.getObject();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the namespace or factory beans aren&#8217;t used then it is also
      essential to configure the transactional behavior of the repository
      using AOP:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;aop:config&gt;</span>
    <span class="tag">&lt;aop:advisor</span>
           <span class="attribute-name">pointcut</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">execution(* org.springframework.batch.core..*Repository+.*(..))</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;advice-ref</span><span class="error">=</span><span class="error">&quot;</span><span class="attribute-name">txAdvice</span><span class="error">&quot;</span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/aop:config&gt;</span>

<span class="tag">&lt;tx:advice</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txAdvice</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tx:attributes&gt;</span>
        <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/tx:attributes&gt;</span>
<span class="tag">&lt;/tx:advice&gt;</span></code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>This fragment can be used as is, with almost no changes. Remember
      also to include the appropriate namespace declarations and to make sure
      spring-tx and spring-aop (or the whole of spring) are on the
      classpath.</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> TransactionProxyFactoryBean baseProxy() {
        TransactionProxyFactoryBean transactionProxyFactoryBean = <span class="keyword">new</span> TransactionProxyFactoryBean();
        <span class="predefined-type">Properties</span> transactionAttributes = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
        transactionAttributes.setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">PROPAGATION_REQUIRED</span><span class="delimiter">&quot;</span></span>);
        transactionProxyFactoryBean.setTransactionAttributes(transactionAttributes);
        transactionProxyFactoryBean.setTarget(jobRepository());
        transactionProxyFactoryBean.setTransactionManager(transactionManager());
        <span class="keyword">return</span> transactionProxyFactoryBean;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositoryTablePrefix"><a class="anchor" href="#repositoryTablePrefix"></a>4.3.2. Changing the Table Prefix</h4>
<div class="paragraph">
<p>Another modifiable property of the
      <code>JobRepository</code> is the table prefix of the
      meta-data tables. By default they are all prefaced with BATCH_.
      BATCH_JOB_EXECUTION and BATCH_STEP_EXECUTION are two examples. However,
      there are potential reasons to modify this prefix. If the schema names
      needs to be prepended to the table names, or if more than one set of
      meta data tables is needed within the same schema, then the table prefix
      will need to be changed:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job-repository</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">table-prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYSTEM.TEST_</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// This would reside in your BatchConfigurer implementation</span>
<span class="annotation">@Override</span>
<span class="directive">protected</span> JobRepository createJobRepository() <span class="directive">throws</span> <span class="exception">Exception</span> {
    JobRepositoryFactoryBean factory = <span class="keyword">new</span> JobRepositoryFactoryBean();
    factory.setDataSource(dataSource);
    factory.setTransactionManager(transactionManager);
    factory.setTablePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">SYSTEM.TEST_</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> factory.getObject();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given the above changes, every query to the meta data tables will
      be prefixed with "SYSTEM.TEST_". BATCH_JOB_EXECUTION will be referred to
      as SYSTEM.TEST_JOB_EXECUTION.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Only the table prefix is configurable. The table and column
        names are not.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="inMemoryRepository"><a class="anchor" href="#inMemoryRepository"></a>4.3.3. In-Memory Repository</h4>
<div class="paragraph">
<p>There are scenarios in which you may not want to persist your
      domain objects to the database. One reason may be speed; storing domain
      objects at each commit point takes extra time. Another reason may be
      that you just don&#8217;t need to persist status for a particular job. For
      this reason, Spring batch provides an in-memory Map version of the job
      repository:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.repository.support.MapJobRepositoryFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// This would reside in your BatchConfigurer implementation</span>
<span class="annotation">@Override</span>
<span class="directive">protected</span> JobRepository createJobRepository() <span class="directive">throws</span> <span class="exception">Exception</span> {
    JobRepositoryFactoryBean factory = <span class="keyword">new</span> JobRepositoryFactoryBean();
    factory.setDataSource(dataSource);
    factory.setTransactionManager(transactionManager);
    factory.setIsolationLevelForCreate(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISOLATION_REPEATABLE_READ</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> factory.getObject();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the in-memory repository is volatile and so does not
      allow restart between JVM instances. It also cannot guarantee that two
      job instances with the same parameters are launched simultaneously, and
      is not suitable for use in a multi-threaded Job, or a locally
      partitioned <code>Step</code>. So use the database version of the repository wherever
      you need those features.</p>
</div>
<div class="paragraph">
<p>However it does require a transaction manager to be defined
      because there are rollback semantics within the repository, and because
      the business logic might still be transactional (e.g. RDBMS access). For
      testing purposes many people find the
      <code>ResourcelessTransactionManager</code> useful.</p>
</div>
</div>
<div class="sect3">
<h4 id="nonStandardDatabaseTypesInRepository"><a class="anchor" href="#nonStandardDatabaseTypesInRepository"></a>4.3.4. Non-standard Database Types in a Repository</h4>
<div class="paragraph">
<p>If you are using a database platform that is not in the list of
      supported platforms, you may be able to use one of the supported types,
      if the SQL variant is close enough. To do this you can use the raw
      <code>JobRepositoryFactoryBean</code> instead of the namespace
      shortcut and use it to set the database type to the closest
      match:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org...JobRepositoryFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">databaseType</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">db2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// This would reside in your BatchConfigurer implementation</span>
<span class="annotation">@Override</span>
<span class="directive">protected</span> JobRepository createJobRepository() <span class="directive">throws</span> <span class="exception">Exception</span> {
    JobRepositoryFactoryBean factory = <span class="keyword">new</span> JobRepositoryFactoryBean();
    factory.setDataSource(dataSource);
    factory.setDatabaseType(<span class="string"><span class="delimiter">&quot;</span><span class="content">db2</span><span class="delimiter">&quot;</span></span>);
    factory.setTransactionManager(transactionManager);
    <span class="keyword">return</span> factory.getObject();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>(The <code>JobRepositoryFactoryBean</code> tries to
      auto-detect the database type from the <code>DataSource</code>
      if it is not specified.) The major differences between platforms are
      mainly accounted for by the strategy for incrementing primary keys, so
      often it might be necessary to override the
      <code>incrementerFactory</code> as well (using one of the standard
      implementations from the Spring Framework).</p>
</div>
<div class="paragraph">
<p>If even that doesn&#8217;t work, or you are not using an RDBMS, then the
      only option may be to implement the various <code>Dao</code>
      interfaces that the <code>SimpleJobRepository</code> depends
      on and wire one up manually in the normal Spring way.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuringJobLauncher"><a class="anchor" href="#configuringJobLauncher"></a>4.4. Configuring a JobLauncher</h3>
<div class="paragraph javaContent">
<p>When using <code>@EnableBatchProcessing</code>, a <code>JobRegistry</code> is provided out of the box for you.
This section addresses configuring your own.</p>
</div>
<div class="paragraph">
<p>The most basic implementation of the
    <code>JobLauncher</code> interface is the
    <code>SimpleJobLauncher</code>. Its only required dependency is
    a <code>JobRepository</code>, in order to obtain an
    execution:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLauncher</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.launch.support.SimpleJobLauncher</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
<span class="comment">// This would reside in your BatchConfigurer implementation</span>
<span class="annotation">@Override</span>
<span class="directive">protected</span> JobLauncher createJobLauncher() <span class="directive">throws</span> <span class="exception">Exception</span> {
        SimpleJobLauncher jobLauncher = <span class="keyword">new</span> SimpleJobLauncher();
        jobLauncher.setJobRepository(jobRepository);
        jobLauncher.afterPropertiesSet();
        <span class="keyword">return</span> jobLauncher;
}
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once a <a href="#domainLanguageOfBatch">JobExecution</a> is
    obtained, it is passed to the execute method of
    Job, ultimately returning the
    <code>JobExecution</code> to the caller:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/job-launcher-sequence-sync.png" alt="Job Launcher Sequence">
</div>
<div class="title">Figure 8. Job Launcher Sequence</div>
</div>
<div class="paragraph">
<p>The sequence is straightforward and works well when launched from a
    scheduler. However, issues arise when trying to launch from an HTTP
    request. In this scenario, the launching needs to be done asynchronously
    so that the <code>SimpleJobLauncher</code> returns immediately
    to its caller. This is because it is not good practice to keep an HTTP
    request open for the amount of time needed by long running processes such
    as batch. An example sequence is below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/job-launcher-sequence-async.png" alt="Async Job Launcher Sequence">
</div>
<div class="title">Figure 9. Asynchronous Job Launcher Sequence</div>
</div>
<div class="paragraph">
<p>The <code>SimpleJobLauncher</code> can easily be
    configured to allow for this scenario by configuring a
    <code>TaskExecutor</code>:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLauncher</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.launch.support.SimpleJobLauncher</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.core.task.SimpleAsyncTaskExecutor</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> JobLauncher jobLauncher() {
        SimpleJobLauncher jobLauncher = <span class="keyword">new</span> SimpleJobLauncher();
        jobLauncher.setJobRepository(jobRepository());
        jobLauncher.setTaskExecutor(<span class="keyword">new</span> SimpleAsyncTaskExecutor());
        jobLauncher.afterPropertiesSet();
        <span class="keyword">return</span> jobLauncher;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any implementation of the spring <code>TaskExecutor</code>
    interface can be used to control how jobs are asynchronously
    executed.</p>
</div>
</div>
<div class="sect2">
<h3 id="runningAJob"><a class="anchor" href="#runningAJob"></a>4.5. Running a Job</h3>
<div class="paragraph">
<p>At a minimum, launching a batch job requires two things: the
    <code>Job</code> to be launched and a
    <code>JobLauncher</code>. Both can be contained within the same
    context or different contexts. For example, if launching a job from the
    command line, a new JVM will be instantiated for each Job, and thus every
    job will have its own <code>JobLauncher</code>. However, if
    running from within a web container within the scope of an
    <code>HttpRequest</code>, there will usually be one
    <code>JobLauncher</code>, configured for asynchronous job
    launching, that multiple requests will invoke to launch their jobs.</p>
</div>
<div class="sect3">
<h4 id="runningJobsFromCommandLine"><a class="anchor" href="#runningJobsFromCommandLine"></a>4.5.1. Running Jobs from the Command Line</h4>
<div class="paragraph">
<p>For users that want to run their jobs from an enterprise
      scheduler, the command line is the primary interface. This is because
      most schedulers (with the exception of Quartz unless using the
      NativeJob) work directly with operating system
      processes, primarily kicked off with shell scripts. There are many ways
      to launch a Java process besides a shell script, such as Perl, Ruby, or
      even 'build tools' such as ant or maven. However, because most people
      are familiar with shell scripts, this example will focus on them.</p>
</div>
<div class="sect4">
<h5 id="commandLineJobRunner"><a class="anchor" href="#commandLineJobRunner"></a>The CommandLineJobRunner</h5>
<div class="paragraph">
<p>Because the script launching the job must kick off a Java
        Virtual Machine, there needs to be a class with a main method to act
        as the primary entry point. Spring Batch provides an implementation
        that serves just this purpose:
        <code>CommandLineJobRunner</code>. It&#8217;s important to note
        that this is just one way to bootstrap your application, but there are
        many ways to launch a Java process, and this class should in no way be
        viewed as definitive. The <code>CommandLineJobRunner</code>
        performs four tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Load the appropriate
<code>ApplicationContext</code></p>
</li>
<li>
<p>Parse command line arguments into
<code>JobParameters</code></p>
</li>
<li>
<p>Locate the appropriate job based on arguments</p>
</li>
<li>
<p>Use the <code>JobLauncher</code> provided in the
application context to launch the job.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these tasks are accomplished using only the arguments
        passed in. The following are required arguments:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 14. CommandLineJobRunner arguments</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobPath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The location of the XML file that will be used to
                create an <code>ApplicationContext</code>. This file
                should contain everything needed to run the complete
                Job</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the job to be run.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These arguments must be passed in with the path first and the
        name second. All arguments after these are considered to be
        <code>JobParameters</code> and must be in the format of 'name=value':</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;bash$ java CommandLineJobRunner endOfDayJob.xml endOfDay schedule.date(date)=2007/05/05</code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;bash$ java CommandLineJobRunner io.spring.EndOfDayJobConfiguration endOfDay schedule.date(date)=2007/05/05</code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>In most cases you would want to use a manifest to declare your
        main class in a jar, but for simplicity, the class was used directly.
        This example is using the same 'EndOfDay' example from the <a href="#domainLanguageOfBatch">domainLanguageOfBatch</a>. The first argument is
        'endOfDayJob.xml', which is the Spring
        <code>ApplicationContext</code> containing the
        Job. The second argument, 'endOfDay' represents
        the job name. The final argument, 'schedule.date(date)=2007/05/05'
        will be converted into <code>JobParameters</code>. An
        example of the XML configuration is below:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endOfDay</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleStep</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/job&gt;</span>

<span class="comment">&lt;!-- Launcher details removed for clarity --&gt;</span>
<span class="tag">&lt;beans:bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLauncher</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.launch.support.SimpleJobLauncher</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>In most cases you would want to use a manifest to declare your
        main class in a jar, but for simplicity, the class was used directly.
        This example is using the same 'EndOfDay' example from the <a href="#domainLanguageOfBatch">domainLanguageOfBatch</a>. The first argument is
        'io.spring.EndOfDayJobConfiguration', which is the fully qualified class name to
         the configuration class containing the
        Job. The second argument, 'endOfDay' represents
        the job name. The final argument, 'schedule.date(date)=2007/05/05'
        will be converted into JobParameters. An
        example of the java configuration is below:</p>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Configuration</span>
<span class="annotation">@EnableBatchProcessing</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">EndOfDayJobConfiguration</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> JobBuilderFactory jobBuilderFactory;

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> StepBuilderFactory stepBuilderFactory;

    <span class="annotation">@Bean</span>
    <span class="directive">public</span> Job endOfDay() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">endOfDay</span><span class="delimiter">&quot;</span></span>)
                                    .start(step1())
                                    .build();
    }

    <span class="annotation">@Bean</span>
    <span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                    .tasklet((contribution, chunkContext) -&gt; <span class="predefined-constant">null</span>)
                                    .build();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example is overly simplistic, since there are many more
        requirements to a run a batch job in Spring Batch in general, but it
        serves to show the two main requirements of the
        <code>CommandLineJobRunner</code>:
        <code>Job</code> and
        <code>JobLauncher</code></p>
</div>
</div>
<div class="sect4">
<h5 id="exitCodes"><a class="anchor" href="#exitCodes"></a>ExitCodes</h5>
<div class="paragraph">
<p>When launching a batch job from the command-line, an enterprise
        scheduler is often used. Most schedulers are fairly dumb and work only
        at the process level. This means that they only know about some
        operating system process such as a shell script that they&#8217;re invoking.
        In this scenario, the only way to communicate back to the scheduler
        about the success or failure of a job is through return codes. A
        return code is a number that is returned to a scheduler by the process
        that indicates the result of the run. In the simplest case: 0 is
        success and 1 is failure. However, there may be more complex
        scenarios: If job A returns 4 kick off job B, and if it returns 5 kick
        off job C. This type of behavior is configured at the scheduler level,
        but it is important that a processing framework such as Spring Batch
        provide a way to return a numeric representation of the 'Exit Code'
        for a particular batch job. In Spring Batch this is encapsulated
        within an <code>ExitStatus</code>, which is covered in more
        detail in Chapter 5. For the purposes of discussing exit codes, the
        only important thing to know is that an
        <code>ExitStatus</code> has an exit code property that is
        set by the framework (or the developer) and is returned as part of the
        <code>JobExecution</code> returned from the
        <code>JobLauncher</code>. The
        <code>CommandLineJobRunner</code> converts this string value
        to a number using the <code>ExitCodeMapper</code>
        interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ExitCodeMapper</span> {

    <span class="directive">public</span> <span class="type">int</span> intValue(<span class="predefined-type">String</span> exitCode);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The essential contract of an
        <code>ExitCodeMapper</code> is that, given a string exit
        code, a number representation will be returned. The default
        implementation used by the job runner is the <code>SimpleJvmExitCodeMapper</code>
        that returns 0 for completion, 1 for generic errors, and 2 for any job
        runner errors such as not being able to find a
        <code>Job</code> in the provided context. If anything more
        complex than the 3 values above is needed, then a custom
        implementation of the <code>ExitCodeMapper</code> interface
        must be supplied. Because the
        <code>CommandLineJobRunner</code> is the class that creates
        an <code>ApplicationContext</code>, and thus cannot be
        'wired together', any values that need to be overwritten must be
        autowired. This means that if an implementation of
        <code>ExitCodeMapper</code> is found within the <code>BeanFactory</code>,
        it will be injected into the runner after the context is created. All
        that needs to be done to provide your own
        <code>ExitCodeMapper</code> is to declare the implementation
        as a root level bean and ensure that it is part of the
        <code>ApplicationContext</code> that is loaded by the
        runner.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="runningJobsFromWebContainer"><a class="anchor" href="#runningJobsFromWebContainer"></a>4.5.2. Running Jobs from within a Web Container</h4>
<div class="paragraph">
<p>Historically, offline processing such as batch jobs have been
      launched from the command-line, as described above. However, there are
      many cases where launching from an <code>HttpRequest</code> is
      a better option. Many such use cases include reporting, ad-hoc job
      running, and web application support. Because a batch job by definition
      is long running, the most important concern is ensuring to launch the
      job asynchronously:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/launch-from-request.png" alt="Async Job Launcher Sequence from web container">
</div>
<div class="title">Figure 10. Asynchronous Job Launcher Sequence From Web Container</div>
</div>
<div class="paragraph">
<p>The controller in this case is a Spring MVC controller. More
      information on Spring MVC can be found here: <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc"><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc" class="bare">https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc</a></a>.
      The controller launches a <code>Job</code> using a
      <code>JobLauncher</code> that has been configured to launch
      <a href="#runningJobsFromWebContainer">asynchronously</a>, which
      immediately returns a <code>JobExecution</code>. The
      <code>Job</code> will likely still be running, however, this
      nonblocking behaviour allows the controller to return immediately, which
      is required when handling an <code>HttpRequest</code>. An
      example is below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Controller</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobLauncherController</span> {

    <span class="annotation">@Autowired</span>
    JobLauncher jobLauncher;

    <span class="annotation">@Autowired</span>
    Job job;

    <span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/jobLauncher.html</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> handle() <span class="directive">throws</span> <span class="exception">Exception</span>{
        jobLauncher.run(job, <span class="keyword">new</span> JobParameters());
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advancedMetaData"><a class="anchor" href="#advancedMetaData"></a>4.6. Advanced Meta-Data Usage</h3>
<div class="paragraph">
<p>So far, both the <code>JobLauncher</code> and <code>JobRepository</code> interfaces have been
    discussed. Together, they represent simple launching of a job, and basic
    CRUD operations of batch domain objects:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/job-repository.png" alt="Job Repository">
</div>
<div class="title">Figure 11. Job Repository</div>
</div>
<div class="paragraph">
<p>A <code>JobLauncher</code> uses the
    <code>JobRepository</code> to create new
    <code>JobExecution</code> objects and run them.
    <code>Job</code> and <code>Step</code> implementations
    later use the same <code>JobRepository</code> for basic updates
    of the same executions during the running of a Job.
    The basic operations suffice for simple scenarios, but in a large batch
    environment with hundreds of batch jobs and complex scheduling
    requirements, more advanced access of the meta data is required:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/job-repository-advanced.png" alt="Job Repository Advanced">
</div>
<div class="title">Figure 12. Advanced Job Repository Access</div>
</div>
<div class="paragraph">
<p>The <code>JobExplorer</code> and
    <code>JobOperator</code> interfaces, which will be discussed
    below, add additional functionality for querying and controlling the meta
    data.</p>
</div>
<div class="sect3">
<h4 id="queryingRepository"><a class="anchor" href="#queryingRepository"></a>4.6.1. Querying the Repository</h4>
<div class="paragraph">
<p>The most basic need before any advanced features is the ability to
      query the repository for existing executions. This functionality is
      provided by the <code>JobExplorer</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">JobExplorer</span> {

    <span class="predefined-type">List</span>&lt;JobInstance&gt; getJobInstances(<span class="predefined-type">String</span> jobName, <span class="type">int</span> start, <span class="type">int</span> count);

    JobExecution getJobExecution(<span class="predefined-type">Long</span> executionId);

    StepExecution getStepExecution(<span class="predefined-type">Long</span> jobExecutionId, <span class="predefined-type">Long</span> stepExecutionId);

    JobInstance getJobInstance(<span class="predefined-type">Long</span> instanceId);

    <span class="predefined-type">List</span>&lt;JobExecution&gt; getJobExecutions(JobInstance jobInstance);

    <span class="predefined-type">Set</span>&lt;JobExecution&gt; findRunningJobExecutions(<span class="predefined-type">String</span> jobName);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As is evident from the method signatures above,
      <code>JobExplorer</code> is a read-only version of the
      <code>JobRepository</code>, and like the
      <code>JobRepository</code>, it can be easily configured via a
      factory bean:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExplorer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...JobExplorerFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
<span class="comment">// This would reside in your BatchConfigurer implementation</span>
<span class="annotation">@Override</span>
<span class="directive">public</span> JobExplorer getJobExplorer() <span class="directive">throws</span> <span class="exception">Exception</span> {
        JobExplorerFactoryBean factoryBean = <span class="keyword">new</span> JobExplorerFactoryBean();
        factoryBean.setDataSource(<span class="local-variable">this</span>.dataSource);
        <span class="keyword">return</span> factoryBean.getObject();
}
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#repositoryTablePrefix">Earlier in this chapter</a>, it was mentioned that the table prefix of the
      <code>JobRepository</code> can be modified to allow for
      different versions or schemas. Because the
      <code>JobExplorer</code> is working with the same tables, it
      too needs the ability to set a prefix:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExplorer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...JobExplorerFactoryBean</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">p:tablePrefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYSTEM.</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
<span class="comment">// This would reside in your BatchConfigurer implementation</span>
<span class="annotation">@Override</span>
<span class="directive">public</span> JobExplorer getJobExplorer() <span class="directive">throws</span> <span class="exception">Exception</span> {
        JobExplorerFactoryBean factoryBean = <span class="keyword">new</span> JobExplorerFactoryBean();
        factoryBean.setDataSource(<span class="local-variable">this</span>.dataSource);
        factoryBean.setTablePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">SYSTEM.</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> factoryBean.getObject();
}
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jobregistry"><a class="anchor" href="#jobregistry"></a>4.6.2. JobRegistry</h4>
<div class="paragraph">
<p>A <code>JobRegistry</code> (and its parent interface <code>JobLocator</code>) is not
      mandatory, but it can be useful if you want to keep track of which jobs
      are available in the context. It is also useful for collecting jobs
      centrally in an application context when they have been created
      elsewhere (e.g. in child contexts). Custom <code>JobRegistry</code> implementations
      can also be used to manipulate the names and other properties of the
      jobs that are registered. There is only one implementation provided by
      the framework and this is based on a simple map from job name to job
      instance.</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.MapJobRegistry</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>When using <code>@EnableBatchProcessing</code>, a <code>JobRegistry</code> is provided out of the box for you.
If you want to configure your own:</p>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
<span class="comment">// This is already provided via the @EnableBatchProcessing but can be customized via</span>
<span class="comment">// overriding the getter in the SimpleBatchConfiguration</span>
<span class="annotation">@Override</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> JobRegistry jobRegistry() <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">return</span> <span class="keyword">new</span> MapJobRegistry();
}
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two ways to populate a <code>JobRegistry</code> automatically: using
      a bean post processor and using a registrar lifecycle component. These
      two mechanisms are described in the following sections.</p>
</div>
<div class="sect4">
<h5 id="jobregistrybeanpostprocessor"><a class="anchor" href="#jobregistrybeanpostprocessor"></a>JobRegistryBeanPostProcessor</h5>
<div class="paragraph">
<p>This is a bean post-processor that can register all jobs as they
        are created:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistryBeanPostProcessor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...JobRegistryBeanPostProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> JobRegistryBeanPostProcessor jobRegistryBeanPostProcessor() {
    JobRegistryBeanPostProcessor postProcessor = <span class="keyword">new</span> JobRegistryBeanPostProcessor();
    postProcessor.setJobRegistry(jobRegistry());
    <span class="keyword">return</span> postProcessor;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although it is not strictly necessary, the post-processor in the
        example has been given an id so that it can be included in child
        contexts (e.g. as a parent bean definition) and cause all jobs created
        there to also be registered automatically.</p>
</div>
</div>
<div class="sect4">
<h5 id="automaticjobregistrar"><a class="anchor" href="#automaticjobregistrar"></a>AutomaticJobRegistrar</h5>
<div class="paragraph">
<p>This is a lifecycle component that creates child contexts and
        registers jobs from those contexts as they are created. One advantage
        of doing this is that, while the job names in the child contexts still
        have to be globally unique in the registry, their dependencies can
        have "natural" names. So for example, you can create a set of XML
        configuration files each having only one Job,
        but all having different definitions of an
        <code>ItemReader</code> with the same bean name, e.g.
        "reader". If all those files were imported into the same context, the
        reader definitions would clash and override one another, but with the
        automatic registrar this is avoided. This makes it easier to
        integrate jobs contributed from separate modules of an
        application.</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...AutomaticJobRegistrar</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">applicationContextFactories</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...ClasspathXmlApplicationContextsFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resources</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath*:/config/job*.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/bean&gt;</span>
   <span class="tag">&lt;/property&gt;</span>
   <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLoader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...DefaultJobLoader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/bean&gt;</span>
   <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> AutomaticJobRegistrar registrar() {

    AutomaticJobRegistrar registrar = <span class="keyword">new</span> AutomaticJobRegistrar();
    registrar.setJobLoader(jobLoader());
    registrar.setApplicationContextFactories(applicationContextFactories());
    registrar.afterPropertiesSet();
    <span class="keyword">return</span> registrar;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The registrar has two mandatory properties, one is an array of
        <code>ApplicationContextFactory</code> (here created from a
        convenient factory bean), and the other is a
        <code>JobLoader</code>. The <code>JobLoader</code>
        is responsible for managing the lifecycle of the child contexts and
        registering jobs in the <code>JobRegistry</code>.</p>
</div>
<div class="paragraph">
<p>The <code>ApplicationContextFactory</code> is
        responsible for creating the child context and the most common usage
        would be as above using a
        <code>ClassPathXmlApplicationContextFactory</code>. One of
        the features of this factory is that by default it copies some of the
        configuration down from the parent context to the child. So for
        instance you don&#8217;t have to re-define the
        <code>PropertyPlaceholderConfigurer</code> or AOP
        configuration in the child, if it should be the same as the
        parent.</p>
</div>
<div class="paragraph">
<p>The <code>AutomaticJobRegistrar</code> can be used in
        conjunction with a <code>JobRegistryBeanPostProcessor</code>
        if desired (as long as the <code>DefaultJobLoader</code> is
        used as well). For instance this might be desirable if there are jobs
        defined in the main parent context as well as in the child
        locations.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="JobOperator"><a class="anchor" href="#JobOperator"></a>4.6.3. JobOperator</h4>
<div class="paragraph">
<p>As previously discussed, the <code>JobRepository</code>
      provides CRUD operations on the meta-data, and the
      <code>JobExplorer</code> provides read-only operations on the
      meta-data. However, those operations are most useful when used together
      to perform common monitoring tasks such as stopping, restarting, or
      summarizing a Job, as is commonly done by batch operators. Spring Batch
      provides these types of operations via the
      <code>JobOperator</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">JobOperator</span> {

    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Long</span>&gt; getExecutions(<span class="type">long</span> instanceId) <span class="directive">throws</span> NoSuchJobInstanceException;

    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Long</span>&gt; getJobInstances(<span class="predefined-type">String</span> jobName, <span class="type">int</span> start, <span class="type">int</span> count)
          <span class="directive">throws</span> NoSuchJobException;

    <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Long</span>&gt; getRunningExecutions(<span class="predefined-type">String</span> jobName) <span class="directive">throws</span> NoSuchJobException;

    <span class="predefined-type">String</span> getParameters(<span class="type">long</span> executionId) <span class="directive">throws</span> NoSuchJobExecutionException;

    <span class="predefined-type">Long</span> start(<span class="predefined-type">String</span> jobName, <span class="predefined-type">String</span> parameters)
          <span class="directive">throws</span> NoSuchJobException, JobInstanceAlreadyExistsException;

    <span class="predefined-type">Long</span> restart(<span class="type">long</span> executionId)
          <span class="directive">throws</span> JobInstanceAlreadyCompleteException, NoSuchJobExecutionException,
                  NoSuchJobException, JobRestartException;

    <span class="predefined-type">Long</span> startNextInstance(<span class="predefined-type">String</span> jobName)
          <span class="directive">throws</span> NoSuchJobException, JobParametersNotFoundException, JobRestartException,
                 JobExecutionAlreadyRunningException, JobInstanceAlreadyCompleteException;

    <span class="type">boolean</span> stop(<span class="type">long</span> executionId)
          <span class="directive">throws</span> NoSuchJobExecutionException, JobExecutionNotRunningException;

    <span class="predefined-type">String</span> getSummary(<span class="type">long</span> executionId) <span class="directive">throws</span> NoSuchJobExecutionException;

    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">Long</span>, <span class="predefined-type">String</span>&gt; getStepExecutionSummaries(<span class="type">long</span> executionId)
          <span class="directive">throws</span> NoSuchJobExecutionException;

    <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; getJobNames();

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above operations represent methods from many different
      interfaces, such as <code>JobLauncher</code>,
      <code>JobRepository</code>,
      <code>JobExplorer</code>, and
      <code>JobRegistry</code>. For this reason, the provided
      implementation of <code>JobOperator</code>,
      <code>SimpleJobOperator</code>, has many dependencies:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobOperator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...SimpleJobOperator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExplorer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...JobExplorerFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLauncher</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLauncher</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"> <span class="comment">/**
  * All injected dependencies for this bean are provided by the @EnableBatchProcessing
  * infrastructure out of the box.
  */</span>
 <span class="annotation">@Bean</span>
 <span class="directive">public</span> SimpleJobOperator jobOperator(JobExplorer jobExplorer,
                                JobRepository jobRepository,
                                JobRegistry jobRegistry) {

        SimpleJobOperator jobOperator = <span class="keyword">new</span> SimpleJobOperator();

        jobOperator.setJobExplorer(jobExplorer);
        jobOperator.setJobRepository(jobRepository);
        jobOperator.setJobRegistry(jobRegistry);
        jobOperator.setJobLauncher(jobLauncher);

        <span class="keyword">return</span> jobOperator;
 }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you set the table prefix on the job repository, don&#8217;t forget to set it on the job explorer as well.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="JobParametersIncrementer"><a class="anchor" href="#JobParametersIncrementer"></a>4.6.4. JobParametersIncrementer</h4>
<div class="paragraph">
<p>Most of the methods on <code>JobOperator</code> are
      self-explanatory, and more detailed explanations can be found on the
      <a href="https://docs.spring.io/spring-batch/apidocs/org/springframework/batch/core/launch/JobOperator.html">javadoc of the interface</a>. However, the
      <code>startNextInstance</code> method is worth noting. This
      method will always start a new instance of a Job.
      This can be extremely useful if there are serious issues in a
      <code>JobExecution</code> and the Job
      needs to be started over again from the beginning. Unlike
      <code>JobLauncher</code> though, which requires a new
      <code>JobParameters</code> object that will trigger a new
      <code>JobInstance</code> if the parameters are different from
      any previous set of parameters, the
      <code>startNextInstance</code> method will use the
      <code>JobParametersIncrementer</code> tied to the
      <code>Job</code> to force the <code>Job</code> to a
      new instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">JobParametersIncrementer</span> {

    JobParameters getNext(JobParameters parameters);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The contract of <code>JobParametersIncrementer</code> is
      that, given a <a href="#jobParameters">JobParameters</a>
      object, it will return the 'next' JobParameters
      object by incrementing any necessary values it may contain. This
      strategy is useful because the framework has no way of knowing what
      changes to the <code>JobParameters</code> make it the 'next'
      instance. For example, if the only value in
      <code>JobParameters</code> is a date, and the next instance
      should be created, should that value be incremented by one day? Or one
      week (if the job is weekly for instance)? The same can be said for any
      numerical values that help to identify the Job,
      as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SampleIncrementer</span> <span class="directive">implements</span> JobParametersIncrementer {

    <span class="directive">public</span> JobParameters getNext(JobParameters parameters) {
        <span class="keyword">if</span> (parameters==<span class="predefined-constant">null</span> || parameters.isEmpty()) {
            <span class="keyword">return</span> <span class="keyword">new</span> JobParametersBuilder().addLong(<span class="string"><span class="delimiter">&quot;</span><span class="content">run.id</span><span class="delimiter">&quot;</span></span>, <span class="integer">1L</span>).toJobParameters();
        }
        <span class="type">long</span> id = parameters.getLong(<span class="string"><span class="delimiter">&quot;</span><span class="content">run.id</span><span class="delimiter">&quot;</span></span>,<span class="integer">1L</span>) + <span class="integer">1</span>;
        <span class="keyword">return</span> <span class="keyword">new</span> JobParametersBuilder().addLong(<span class="string"><span class="delimiter">&quot;</span><span class="content">run.id</span><span class="delimiter">&quot;</span></span>, id).toJobParameters();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the value with a key of 'run.id' is used to
      discriminate between <code>JobInstances</code>. If the
      <code>JobParameters</code> passed in is null, it can be
      assumed that the <code>Job</code> has never been run before
      and thus its initial state can be returned. However, if not, the old
      value is obtained, incremented by one, and returned.</p>
</div>
<div class="paragraph xmlContent">
<p>An incrementer can
      be associated with <code>Job</code> via the 'incrementer'
      attribute in the namespace:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">incrementer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleIncrementer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>An incrementer can be associated with a 'Job' via the <code>incrementer</code> method provided in the
builders:</p>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job footballJob() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span>)
                                     .incrementer(sampleIncrementer())
                                     ...
                     .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="stoppingAJob"><a class="anchor" href="#stoppingAJob"></a>4.6.5. Stopping a Job</h4>
<div class="paragraph">
<p>One of the most common use cases of
      <code>JobOperator</code> is gracefully stopping a
      Job:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;<span class="predefined-type">Long</span>&gt; executions = jobOperator.getRunningExecutions(<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleJob</span><span class="delimiter">&quot;</span></span>);
jobOperator.stop(executions.iterator().next());</code></pre>
</div>
</div>
<div class="paragraph">
<p>The shutdown is not immediate, since there is no way to force
      immediate shutdown, especially if the execution is currently in
      developer code that the framework has no control over, such as a
      business service. However, as soon as control is returned back to the
      framework, it will set the status of the current
      <code>StepExecution</code> to
      <code>BatchStatus.STOPPED</code>, save it, then do the same
      for the <code>JobExecution</code> before finishing.</p>
</div>
</div>
<div class="sect3">
<h4 id="aborting-a-job"><a class="anchor" href="#aborting-a-job"></a>4.6.6. Aborting a Job</h4>
<div class="paragraph">
<p>A job execution which is <code>FAILED</code> can be
      restarted (if the <code>Job</code> is restartable). A job execution whose status is
      <code>ABANDONED</code> will not be restarted by the framework.
      The <code>ABANDONED</code> status is also used in step
      executions to mark them as skippable in a restarted job execution: if a
      job is executing and encounters a step that has been marked
      <code>ABANDONED</code> in the previous failed job execution, it
      will move on to the next step (as determined by the job flow definition
      and the step execution exit status).</p>
</div>
<div class="paragraph">
<p>If the process died (<code>"kill -9"</code> or server
      failure) the job is, of course, not running, but the <code>JobRepository</code> has
      no way of knowing because no-one told it before the process died. You
      have to tell it manually that you know that the execution either failed
      or should be considered aborted (change its status to
      <code>FAILED</code> or <code>ABANDONED</code>) - it&#8217;s
      a business decision and there is no way to automate it. Only change the
      status to <code>FAILED</code> if it is not restartable, or if
      you know the restart data is valid. There is a utility in Spring Batch
      Admin <code>JobService</code> to abort a job execution.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configureStep"><a class="anchor" href="#configureStep"></a>5. Configuring a <code>Step</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>As discussed in <a href="#domainLanguageOfBatch">the domain chapter</a>, a <code>Step</code> is a
domain object that encapsulates an independent, sequential phase of a batch job and
contains all of the information necessary to define and control the actual batch
processing. This is a necessarily vague description because the contents of any given
<code>Step</code> are at the discretion of the developer writing a <code>Job</code>. A <code>Step</code> can be as simple
or complex as the developer desires. A simple <code>Step</code> might load data from a file into the
database, requiring little or no code (depending upon the implementations used). A more
complex <code>Step</code> might have complicated business rules that are applied as part of the
processing, as shown in the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/step.png" alt="Step">
</div>
<div class="title">Figure 13. Step</div>
</div>
<div class="sect2">
<h3 id="chunkOrientedProcessing"><a class="anchor" href="#chunkOrientedProcessing"></a>5.1. Chunk-oriented Processing</h3>
<div class="paragraph">
<p>Spring Batch uses a 'Chunk-oriented' processing style within its most common
implementation. Chunk oriented processing refers to reading the data one at a time and
creating 'chunks' that are written out within a transaction boundary. One item is read in
from an <code>ItemReader</code>, handed to an <code>ItemProcessor</code>, and aggregated. Once the number of
items read equals the commit interval, the entire chunk is written out by the
<code>ItemWriter</code>, and then the transaction is committed. The following image shows the
process:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/chunk-oriented-processing.png" alt="Chunk Oriented Processing">
</div>
<div class="title">Figure 14. Chunk-oriented Processing</div>
</div>
<div class="paragraph">
<p>The following code shows the same concepts shown:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span> items = <span class="keyword">new</span> Arraylist();
<span class="keyword">for</span>(<span class="type">int</span> i = <span class="integer">0</span>; i &lt; commitInterval; i++){
    <span class="predefined-type">Object</span> item = itemReader.read()
    <span class="predefined-type">Object</span> processedItem = itemProcessor.process(item);
    items.add(processedItem);
}
itemWriter.write(items);</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="configuringAStep"><a class="anchor" href="#configuringAStep"></a>5.1.1. Configuring a <code>Step</code></h4>
<div class="paragraph">
<p>Despite the relatively short list of required dependencies for a <code>Step</code>, it is an
extremely complex class that can potentially contain many collaborators.</p>
</div>
<div class="paragraph xmlContent">
<p>In order to ease configuration, the Spring Batch namespace can be used, as shown in the
following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>When using java configuration, the Spring Batch builders can be used, as shown in the
following example:</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * Note the JobRepository is typically autowired in and not needed to be explicitly
 * configured
 */</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> Job sampleJob(JobRepository jobRepository, Step sampleStep) {
    <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleJob</span><span class="delimiter">&quot;</span></span>)
                            .repository(jobRepository)
                .start(sampleStep)
                .build();
}

<span class="comment">/**
 * Note the TransactionManager is typically autowired in and not needed to be explicitly
 * configured
 */</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> Step sampleStep(PlatformTransactionManager transactionManager) {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleStep</span><span class="delimiter">&quot;</span></span>)
                                .transactionManager(transactionManager)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                                .reader(itemReader())
                                .writer(itemWriter())
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration above includes the only required dependencies to create a item-oriented
step:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>reader</code>: The <code>ItemReader</code> that provides items for processing.</p>
</li>
<li>
<p><code>writer</code>: The <code>ItemWriter</code> that processes the items provided by the <code>ItemReader</code>.</p>
</li>
</ul>
</div>
<div class="ulist xmlContent">
<ul>
<li>
<p><code>transaction-manager</code>: Spring&#8217;s <code>PlatformTransactionManager</code> that begins and commits
transactions during processing.</p>
</li>
</ul>
</div>
<div class="ulist javaContent">
<ul>
<li>
<p><code>transactionManager</code>: Spring&#8217;s <code>PlatformTransactionManager</code> that begins and commits
transactions during processing.</p>
</li>
</ul>
</div>
<div class="ulist xmlContent">
<ul>
<li>
<p><code>job-repository</code>: The <code>JobRepository</code> that periodically stores the <code>StepExecution</code> and
<code>ExecutionContext</code> during processing (just before committing). For an in-line &lt;step/&gt;
(one defined within a &lt;job/&gt;), it is an attribute on the &lt;job/&gt; element. For a standalone
step, it is defined as an attribute of the &lt;tasklet/&gt;.</p>
</li>
</ul>
</div>
<div class="ulist javaContent">
<ul>
<li>
<p><code>repository</code>: The <code>JobRepository</code> that periodically stores the <code>StepExecution</code> and
<code>ExecutionContext</code> during processing (just before committing).</p>
</li>
</ul>
</div>
<div class="ulist xmlContent">
<ul>
<li>
<p><code>commit-interval</code>: The number of items to be processed before the transaction is
committed.</p>
</li>
</ul>
</div>
<div class="ulist javaContent">
<ul>
<li>
<p><code>chunk</code>: Indicates that this is an item based step and the number of items to be
processed before the transaction is committed.</p>
</li>
</ul>
</div>
<div class="paragraph xmlContent">
<p>It should be noted that <code>job-repository</code> defaults to <code>jobRepository</code> and
<code>transaction-manager</code> defaults to <code>transactionManger</code>. Also, the <code>ItemProcessor</code> is
optional, since the item could be directly passed from the reader to the writer.</p>
</div>
<div class="paragraph javaContent">
<p>It should be noted that <code>repository</code> defaults to <code>jobRepository</code> and <code>transactionManager</code>
defaults to <code>transactionManger</code> (all provided through the infrastructure from
<code>@EnableBatchProcessing</code>). Also, the <code>ItemProcessor</code> is optional, since the item could be
directly passed from the reader to the writer.</p>
</div>
</div>
<div class="sect3 xmlContent">
<h4 id="InheritingFromParentStep"><a class="anchor" href="#InheritingFromParentStep"></a>5.1.2. Inheriting from a Parent <code>Step</code></h4>
<div class="paragraph xmlContent">
<p>If a group of <code>Steps</code> share similar configurations, then it may be helpful to define a
"parent" <code>Step</code> from which the concrete <code>Steps</code> may inherit properties. Similar to class
inheritance in Java, the "child" <code>Step</code> combines its elements and attributes with the
parent&#8217;s. The child also overrides any of the parent&#8217;s <code>Steps</code>.</p>
</div>
<div class="paragraph xmlContent">
<p>In the following example, the <code>Step</code>, "concreteStep1", inherits from "parentStep". It is
instantiated with 'itemReader', 'itemProcessor', 'itemWriter', <code>startLimit=5</code>, and
<code>allowStartIfComplete=true</code>. Additionally, the <code>commitInterval</code> is '5', since it is
overridden by the "concreteStep1" <code>Step</code>, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet</span> <span class="attribute-name">allow-start-if-complete</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span>

<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">concreteStep1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet</span> <span class="attribute-name">start-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemProcessor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>The <code>id</code> attribute is still required on the step within the job element. This is for two
reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>id</code> is used as the step name when persisting the <code>StepExecution</code>. If the same
standalone step is referenced in more than one step in the job, an error occurs.</p>
</li>
</ul>
</div>
<div class="ulist xmlContent">
<ul>
<li>
<p>When creating job flows, as described later in this chapter, the <code>next</code> attribute
should be referring to the step in the flow, not the standalone step.</p>
</li>
</ul>
</div>
<div class="sect4 xmlContent">
<h5 id="abstractStep"><a class="anchor" href="#abstractStep"></a>Abstract <code>Step</code></h5>
<div class="paragraph xmlContent">
<p>Sometimes, it may be necessary to define a parent <code>Step</code> that is not a complete <code>Step</code>
configuration. If, for instance, the <code>reader</code>, <code>writer</code>, and <code>tasklet</code> attributes are
left off of a <code>Step</code> configuration, then initialization fails. If a parent must be
defined without these properties, then the <code>abstract</code> attribute should be used. An
<code>abstract</code> <code>Step</code> is only extended, never instantiated.</p>
</div>
<div class="paragraph xmlContent">
<p>In the following example, the <code>Step</code> <code>abstractParentStep</code> would not be instantiated if it
were not declared to be abstract. The <code>Step</code>, "concreteStep2", has 'itemReader',
'itemWriter', and commit-interval=10.</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">abstractParentStep</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">abstract</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span>

<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">concreteStep2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">abstractParentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4 xmlContent">
<h5 id="mergingListsOnStep"><a class="anchor" href="#mergingListsOnStep"></a>Merging Lists</h5>
<div class="paragraph xmlContent">
<p>Some of the configurable elements on <code>Steps</code> are lists, such as the <code>&lt;listeners/&gt;</code> element.
If both the parent and child <code>Steps</code> declare a <code>&lt;listeners/&gt;</code> element, then the
child&#8217;s list overrides the parent&#8217;s. In order to allow a child to add additional
listeners to the list defined by the parent, every list element has a <code>merge</code> attribute.
If the element specifies that <code>merge="true"</code>, then the child&#8217;s list is combined with the
parent&#8217;s instead of overriding it.</p>
</div>
<div class="paragraph xmlContent">
<p>In the following example, the <code>Step</code> "concreteStep3", is created with two listeners:
<code>listenerOne</code> and <code>listenerTwo</code>:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenersParentStep</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">abstract</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;listeners&gt;</span>
        <span class="tag">&lt;listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenerOne</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;listeners&gt;</span>
<span class="tag">&lt;/step&gt;</span>

<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">concreteStep3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenersParentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
    <span class="tag">&lt;listeners</span> <span class="attribute-name">merge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenerTwo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;listeners&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="commitInterval"><a class="anchor" href="#commitInterval"></a>5.1.3. The Commit Interval</h4>
<div class="paragraph">
<p>As mentioned previously, a step reads in and writes out items, periodically committing
using the supplied <code>PlatformTransactionManager</code>. With a <code>commit-interval</code> of 1, it
commits after writing each individual item. This is less than ideal in many situations,
since beginning and committing a transaction is expensive. Ideally, it is preferable to
process as many items as possible in each transaction, which is completely dependent upon
the type of data being processed and the resources with which the step is interacting.
For this reason, the number of items that are processed within a commit can be
configured. The following example shows a <code>step</code> whose <code>tasklet</code> has a <code>commit-interval</code>
value of 10.</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job sampleJob() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleJob</span><span class="delimiter">&quot;</span></span>)
                     .start(step1())
                     .end()
                     .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                                .reader(itemReader())
                                .writer(itemWriter())
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, 10 items are processed within each transaction. At the
beginning of processing, a transaction is begun. Also, each time <code>read</code> is called on the
<code>ItemReader</code>, a counter is incremented. When it reaches 10, the list of aggregated items
is passed to the <code>ItemWriter</code>, and the transaction is committed.</p>
</div>
</div>
<div class="sect3">
<h4 id="stepRestart"><a class="anchor" href="#stepRestart"></a>5.1.4. Configuring a <code>Step</code> for Restart</h4>
<div class="paragraph">
<p>In the "<a href="#configureJob">Configuring and Running a Job</a>" section , restarting a
<code>Job</code> was discussed. Restart has numerous impacts on steps, and, consequently, may
require some specific configuration.</p>
</div>
<div class="sect4">
<h5 id="startLimit"><a class="anchor" href="#startLimit"></a>Setting a Start Limit</h5>
<div class="paragraph">
<p>There are many scenarios where you may want to control the number of times a <code>Step</code> may
be started. For example, a particular <code>Step</code> might need to be configured so that it only
runs once because it invalidates some resource that must be fixed manually before it can
be run again. This is configurable on the step level, since different steps may have
different requirements. A <code>Step</code> that may only be executed once can exist as part of the
same <code>Job</code> as a <code>Step</code> that can be run infinitely. The following code fragment shows an
example of a start limit configuration:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet</span> <span class="attribute-name">start-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                                .reader(itemReader())
                                .writer(itemWriter())
                                .startLimit(<span class="integer">1</span>)
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step above can be run only once. Attempting to run it again causes a
<code>StartLimitExceededException</code> to be thrown. Note that the default value for the
start-limit is <code>Integer.MAX_VALUE</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="allowStartIfComplete"><a class="anchor" href="#allowStartIfComplete"></a>Restarting a Completed <code>Step</code></h5>
<div class="paragraph">
<p>In the case of a restartable job, there may be one or more steps that should always be
run, regardless of whether or not they were successful the first time. An example might
be a validation step or a <code>Step</code> that cleans up resources before processing. During
normal processing of a restarted job, any step with a status of 'COMPLETED', meaning it
has already been completed successfully, is skipped. Setting <code>allow-start-if-complete</code> to
"true" overrides this so that the step always runs, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet</span> <span class="attribute-name">allow-start-if-complete</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                                .reader(itemReader())
                                .writer(itemWriter())
                                .allowStartIfComplete(<span class="predefined-constant">true</span>)
                                .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="stepRestartExample"><a class="anchor" href="#stepRestartExample"></a><code>Step</code> Restart Configuration Example</h5>
<div class="paragraph">
<p>The following example shows how to configure a job to have steps that can be restarted:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restartable</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerload</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gameLoad</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerWriter</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gameLoad</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarization</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet</span> <span class="attribute-name">allow-start-if-complete</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gameFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gameWriter</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarization</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet</span> <span class="attribute-name">start-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarizationSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">summaryWriter</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job footballJob() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">footballJob</span><span class="delimiter">&quot;</span></span>)
                                .start(playerLoad())
                                .next(gameLoad())
                                .next(playerSummarization())
                                .end()
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step playerLoad() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">playerLoad</span><span class="delimiter">&quot;</span></span>)
                        .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                        .reader(playerFileItemReader())
                        .writer(playerWriter())
                        .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step gameLoad() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">gameLoad</span><span class="delimiter">&quot;</span></span>)
                        .allowStartIfComplete(<span class="predefined-constant">true</span>)
                        .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                        .reader(gameFileItemReader())
                        .writer(gameWriter())
                        .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step playerSummarization() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactor.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarization</span><span class="delimiter">&quot;</span></span>)
                        .startLimit(<span class="integer">2</span>)
                        .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                        .reader(playerSummarizationSource())
                        .writer(summaryWriter())
                        .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding example configuration is for a job that loads in information about football
games and summarizes them. It contains three steps: <code>playerLoad</code>, <code>gameLoad</code>, and
<code>playerSummarization</code>. The <code>playerLoad</code> step loads player information from a flat file,
while the <code>gameLoad</code> step does the same for games. The final step,
<code>playerSummarization</code>, then summarizes the statistics for each player, based upon the
provided games. It is assumed that the file loaded by <code>playerLoad</code> must be loaded only
once, but that <code>gameLoad</code> can load any games found within a particular directory,
deleting them after they have been successfully loaded into the database. As a result,
the <code>playerLoad</code> step contains no additional configuration. It can be started any number
of times, and, if complete, is skipped. The <code>gameLoad</code> step, however, needs to be run
every time in case extra files have been added since it last ran. It has
'allow-start-if-complete' set to 'true' in order to always be started. (It is assumed
that the database tables games are loaded into has a process indicator on it, to ensure
new games can be properly found by the summarization step). The summarization step,
which is the most important in the job, is configured to have a start limit of 2. This
is useful because if the step continually fails, a new exit code is returned to the
operators that control job execution, and it can not start again until manual
intervention has taken place.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This job provides an example for this document and is not the same as the <code>footballJob</code>
found in the samples project.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The remainder of this section describes what happens for each of the three runs of the
<code>footballJob</code> example.</p>
</div>
<div class="paragraph">
<p>Run 1:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>playerLoad</code> runs and completes successfully, adding 400 players to the 'PLAYERS'
table.</p>
</li>
<li>
<p><code>gameLoad</code> runs and processes 11 files worth of game data, loading their contents
into the 'GAMES' table.</p>
</li>
<li>
<p><code>playerSummarization</code> begins processing and fails after 5 minutes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Run 2:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>playerLoad</code> does not run, since it has already completed successfully, and
<code>allow-start-if-complete</code> is 'false' (the default).</p>
</li>
<li>
<p><code>gameLoad</code> runs again and processes another 2 files, loading their contents into the
'GAMES' table as well (with a process indicator indicating they have yet to be
processed).</p>
</li>
<li>
<p><code>playerSummarization</code> begins processing of all remaining game data (filtering using the
process indicator) and fails again after 30 minutes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Run 3:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>playerLoad</code> does not run, since it has already completed successfully, and
<code>allow-start-if-complete</code> is 'false' (the default).</p>
</li>
<li>
<p><code>gameLoad</code> runs again and processes another 2 files, loading their contents into the
'GAMES' table as well (with a process indicator indicating they have yet to be
processed).</p>
</li>
<li>
<p><code>playerSummarization</code> is not started and the job is immediately killed, since this is
the third execution of <code>playerSummarization</code>, and its limit is only 2. Either the limit
must be raised or the <code>Job</code> must be executed as a new <code>JobInstance</code>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuringSkip"><a class="anchor" href="#configuringSkip"></a>5.1.5. Configuring Skip Logic</h4>
<div class="paragraph">
<p>There are many scenarios where errors encountered while processing should not result in
<code>Step</code> failure, but should be skipped instead. This is usually a decision that must be
made by someone who understands the data itself and what meaning it has. Financial data,
for example, may not be skippable because it results in money being transferred, which
needs to be completely accurate. Loading a list of vendors, on the other hand, might
allow for skips. If a vendor is not loaded because it was formatted incorrectly or was
missing necessary information, then there probably are not issues. Usually, these bad
records are logged as well, which is covered later when discussing listeners.</p>
</div>
<div class="paragraph">
<p>The following example shows an example of using a skip limit:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;tasklet&gt;</span>
      <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">skip-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;skippable-exception-classes&gt;</span>
            <span class="tag">&lt;include</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileParseException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/skippable-exception-classes&gt;</span>
      <span class="tag">&lt;/chunk&gt;</span>
   <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                                .reader(flatFileItemReader())
                                .writer(itemWriter())
                                .faultTolerant()
                                .skipLimit(<span class="integer">10</span>)
                                .skip(FlatFileParseException.class)
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, a <code>FlatFileItemReader</code> is used. If, at any point, a
<code>FlatFileParseException</code> is thrown, the item is skipped and counted against the total
skip limit of 10. Separate counts are made of skips on read, process, and write inside
the step execution, but the limit applies across all skips. Once the skip limit is
reached, the next exception found causes the step to fail. In other words, the eleventh
skip triggers the exception, not the tenth.</p>
</div>
<div class="paragraph">
<p>One problem with the preceding example is that any other exception besides a
<code>FlatFileParseException</code> causes the <code>Job</code> to fail. In certain scenarios, this may be the
correct behavior. However, in other scenarios, it may be easier to identify which
exceptions should cause failure and skip everything else, as shown in the following
example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">skip-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;skippable-exception-classes&gt;</span>
                <span class="tag">&lt;include</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Exception</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;exclude</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.io.FileNotFoundException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/skippable-exception-classes&gt;</span>
        <span class="tag">&lt;/chunk&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                                .reader(flatFileItemReader())
                                .writer(itemWriter())
                                .faultTolerant()
                                .skipLimit(<span class="integer">10</span>)
                                .skip(<span class="exception">Exception</span>.class)
                                .noSkip(<span class="exception">FileNotFoundException</span>.class)
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By identifying <code>java.lang.Exception</code> as a skippable exception class, the configuration
indicates that all <code>Exceptions</code> are skippable. However, by 'excluding'
<code>java.io.FileNotFoundException</code>, the configuration refines the list of skippable
exception classes to be all <code>Exceptions</code> <em>except</em> <code>FileNotFoundException</code>. Any excluded
exception classes is fatal if encountered (that is, they are not skipped).</p>
</div>
<div class="paragraph">
<p>For any exception encountered, the skippability is determined by the nearest superclass
in the class hierarchy. Any unclassified exception is treated as 'fatal'.</p>
</div>
<div class="paragraph xmlContent">
<p>The order of the <code>&lt;include/&gt;</code> and <code>&lt;exclude/&gt;</code> elements does not matter.</p>
</div>
<div class="paragraph javaContent">
<p>The order of the <code>skip</code> and <code>noSkip</code> calls does not matter.</p>
</div>
</div>
<div class="sect3">
<h4 id="retryLogic"><a class="anchor" href="#retryLogic"></a>5.1.6. Configuring Retry Logic</h4>
<div class="paragraph">
<p>In most cases, you want an exception to cause either a skip or a <code>Step</code> failure. However,
not all exceptions are deterministic. If a <code>FlatFileParseException</code> is encountered while
reading, it is always thrown for that record. Resetting the <code>ItemReader</code> does not help.
However, for other exceptions, such as a <code>DeadlockLoserDataAccessException</code>, which
indicates that the current process has attempted to update a record that another process
holds a lock on, waiting and trying again might result in success. In this case, retry
should be configured as follows:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;tasklet&gt;</span>
      <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">retry-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;retryable-exception-classes&gt;</span>
            <span class="tag">&lt;include</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.dao.DeadlockLoserDataAccessException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/retryable-exception-classes&gt;</span>
      <span class="tag">&lt;/chunk&gt;</span>
   <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">2</span>)
                                .reader(itemReader())
                                .writer(itemWriter())
                                .faultTolerant()
                                .retryLimit(<span class="integer">3</span>)
                                .retry(DeadlockLoserDataAccessException.class)
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Step</code> allows a limit for the number of times an individual item can be retried and a
list of exceptions that are 'retryable'. More details on how retry works can be found in
<a href="#retry">retry</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="controllingRollback"><a class="anchor" href="#controllingRollback"></a>5.1.7. Controlling Rollback</h4>
<div class="paragraph">
<p>By default, regardless of retry or skip, any exceptions thrown from the <code>ItemWriter</code>
cause the transaction controlled by the <code>Step</code> to rollback. If skip is configured as
described earlier, exceptions thrown from the <code>ItemReader</code> do not cause a rollback.
However, there are many scenarios in which exceptions thrown from the <code>ItemWriter</code> should
not cause a rollback, because no action has taken place to invalidate the transaction.
For this reason, the <code>Step</code> can be configured with a list of exceptions that should not
cause rollback, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;tasklet&gt;</span>
      <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;no-rollback-exception-classes&gt;</span>
         <span class="tag">&lt;include</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.validator.ValidationException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/no-rollback-exception-classes&gt;</span>
   <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">2</span>)
                                .reader(itemReader())
                                .writer(itemWriter())
                                .faultTolerant()
                                .noRollback(ValidationException.class)
                                .build();
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="transactionalReaders"><a class="anchor" href="#transactionalReaders"></a>Transactional Readers</h5>
<div class="paragraph">
<p>The basic contract of the <code>ItemReader</code> is that it is forward only. The step buffers
reader input, so that in the case of a rollback, the items do not need to be re-read
from the reader. However, there are certain scenarios in which the reader is built on
top of a transactional resource, such as a JMS queue. In this case, since the queue is
tied to the transaction that is rolled back, the messages that have been pulled from the
queue are put back on. For this reason, the step can be configured to not buffer the
items, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">is-reader-transactional-queue</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">2</span>)
                                .reader(itemReader())
                                .writer(itemWriter())
                                .readerIsTransactionalQueue()
                                .build();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="transactionAttributes"><a class="anchor" href="#transactionAttributes"></a>5.1.8. Transaction Attributes</h4>
<div class="paragraph">
<p>Transaction attributes can be used to control the <code>isolation</code>, <code>propagation</code>, and
<code>timeout</code> settings. More information on setting transaction attributes can be found in
the
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction">Spring
core documentation</a>. The following example sets the <code>isolation</code>, <code>propagation</code>, and
<code>timeout</code> transaction attributes:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;transaction-attributes</span> <span class="attribute-name">isolation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DEFAULT</span><span class="delimiter">&quot;</span></span>
                                <span class="attribute-name">propagation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REQUIRED</span><span class="delimiter">&quot;</span></span>
                                <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        DefaultTransactionAttribute attribute = <span class="keyword">new</span> DefaultTransactionAttribute();
        attribute.setPropagationBehavior(Propagation.REQUIRED.value());
        attribute.setIsolationLevel(Isolation.DEFAULT.value());
        attribute.setTimeout(<span class="integer">30</span>);

        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">2</span>)
                                .reader(itemReader())
                                .writer(itemWriter())
                                .transactionAttribute(attribute)
                                .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="registeringItemStreams"><a class="anchor" href="#registeringItemStreams"></a>5.1.9. Registering <code>ItemStream</code> with a <code>Step</code></h4>
<div class="paragraph">
<p>The step has to take care of <code>ItemStream</code> callbacks at the necessary points in its
lifecycle (For more information on the <code>ItemStream</code> interface, see
<a href="#itemStream">ItemStream</a>). This is vital if a step fails and might
need to be restarted, because the <code>ItemStream</code> interface is where the step gets the
information it needs about persistent state between executions.</p>
</div>
<div class="paragraph">
<p>If the <code>ItemReader</code>, <code>ItemProcessor</code>, or <code>ItemWriter</code> itself implements the <code>ItemStream</code>
interface, then these are registered automatically. Any other streams need to be
registered separately. This is often the case where indirect dependencies, such as
delegates, are injected into the reader and writer. A stream can be registered on the
<code>Step</code> through the 'streams' element, as illustrated in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">compositeWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;streams&gt;</span>
                <span class="tag">&lt;stream</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileItemWriter1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;stream</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileItemWriter2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/streams&gt;</span>
        <span class="tag">&lt;/chunk&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span>

<span class="tag">&lt;beans:bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">compositeWriter</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.CompositeItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;beans:property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegates</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;beans:list&gt;</span>
            <span class="tag">&lt;beans:ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileItemWriter1</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;beans:ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileItemWriter2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/beans:list&gt;</span>
    <span class="tag">&lt;/beans:property&gt;</span>
<span class="tag">&lt;/beans:bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">2</span>)
                                .reader(itemReader())
                                .writer(compositeItemWriter())
                                .stream(fileItemWriter1())
                                .stream(fileItemWriter2())
                                .build();
}

<span class="comment">/**
 * In Spring Batch 4, the CompositeItemWriter implements ItemStream so this isn't
 * necessary, but used for an example.
 */</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> CompositeItemWriter compositeItemWriter() {
        <span class="predefined-type">List</span>&lt;ItemWriter&gt; writers = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(<span class="integer">2</span>);
        writers.add(fileItemWriter1());
        writers.add(fileItemWriter2());

        CompositeItemWriter itemWriter = <span class="keyword">new</span> CompositeItemWriter();

        itemWriter.setDelegates(writers);

        <span class="keyword">return</span> itemWriter;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, the <code>CompositeItemWriter</code> is not an <code>ItemStream</code>, but both of its
delegates are. Therefore, both delegate writers must be explicitly registered as streams
in order for the framework to handle them correctly. The <code>ItemReader</code> does not need to be
explicitly registered as a stream because it is a direct property of the <code>Step</code>. The step
is now restartable, and the state of the reader and writer is correctly persisted in the
event of a failure.</p>
</div>
</div>
<div class="sect3">
<h4 id="interceptingStepExecution"><a class="anchor" href="#interceptingStepExecution"></a>5.1.10. Intercepting <code>Step</code> Execution</h4>
<div class="paragraph">
<p>Just as with the <code>Job</code>, there are many events during the execution of a <code>Step</code> where a
user may need to perform some functionality. For example, in order to write out to a flat
file that requires a footer, the <code>ItemWriter</code> needs to be notified when the <code>Step</code> has
been completed, so that the footer can be written. This can be accomplished with one of many
<code>Step</code> scoped listeners.</p>
</div>
<div class="paragraph">
<p>Any class that implements one of the extensions of <code>StepListener</code> (but not that interface
itself since it is empty) can be applied to a step through the <code>listeners</code> element.
The <code>listeners</code> element is valid inside a step, tasklet, or chunk declaration.  It is
recommended that you declare the listeners at the level at which its function applies,
or, if it is multi-featured (such as <code>StepExecutionListener</code> and <code>ItemReadListener</code>),
then declare it at the most granular level where it applies. The following example shows
a listener applied at the chunk level:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;listeners&gt;</span>
            <span class="tag">&lt;listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/listeners&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                                .reader(reader())
                                .writer(writer())
                                .listener(chunkListener())
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An <code>ItemReader</code>, <code>ItemWriter</code> or <code>ItemProcessor</code> that itself implements one of the
<code>StepListener</code> interfaces is registered automatically with the <code>Step</code> if using the
namespace <code>&lt;step&gt;</code> element or one of the the <code>*StepFactoryBean</code> factories. This only
applies to components directly injected into the <code>Step</code>. If the listener is nested inside
another component, it needs to be explicitly registered (as described previously under
<a href="#registeringItemStreams">Registering <code>ItemStream</code> with a <code>Step</code></a>).</p>
</div>
<div class="paragraph">
<p>In addition to the <code>StepListener</code> interfaces, annotations are provided to address the
same concerns. Plain old Java objects can have methods with these annotations that are
then converted into the corresponding <code>StepListener</code> type. It is also common to annotate
custom implementations of chunk components such as <code>ItemReader</code> or <code>ItemWriter</code> or
<code>Tasklet</code>. The annotations are analyzed by the XML parser for the <code>&lt;listener/&gt;</code> elements
as well as registered with the <code>listener</code> methods in the builders, so all you need to do
is use the XML namespace or builders to register the listeners with a step.</p>
</div>
<div class="sect4">
<h5 id="stepExecutionListener"><a class="anchor" href="#stepExecutionListener"></a><code>StepExecutionListener</code></h5>
<div class="paragraph">
<p><code>StepExecutionListener</code> represents the most generic listener for <code>Step</code> execution. It
allows for notification before a <code>Step</code> is started and after it ends, whether it ended
normally or failed, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">StepExecutionListener</span> <span class="directive">extends</span> StepListener {

    <span class="type">void</span> beforeStep(StepExecution stepExecution);

    ExitStatus afterStep(StepExecution stepExecution);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ExitStatus</code> is the return type of <code>afterStep</code> in order to allow listeners the chance to
modify the exit code that is returned upon completion of a <code>Step</code>.</p>
</div>
<div class="paragraph">
<p>The annotations corresponding to this interface are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@BeforeStep</code></p>
</li>
<li>
<p><code>@AfterStep</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="chunkListener"><a class="anchor" href="#chunkListener"></a><code>ChunkListener</code></h5>
<div class="paragraph">
<p>A chunk is defined as the items processed within the scope of a transaction. Committing a
transaction, at each commit interval, commits a 'chunk'. A <code>ChunkListener</code> can be used to
perform logic before a chunk begins processing or after a chunk has completed
successfully, as shown in the following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ChunkListener</span> <span class="directive">extends</span> StepListener {

    <span class="type">void</span> beforeChunk(ChunkContext context);
    <span class="type">void</span> afterChunk(ChunkContext context);
    <span class="type">void</span> afterChunkError(ChunkContext context);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The beforeChunk method is called after the transaction is started but before read is
called on the <code>ItemReader</code>. Conversely, <code>afterChunk</code> is called after the chunk has been
committed (and not at all if there is a rollback).</p>
</div>
<div class="paragraph">
<p>The annotations corresponding to this interface are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@BeforeChunk</code></p>
</li>
<li>
<p><code>@AfterChunk</code></p>
</li>
<li>
<p><code>@AfterChunkError</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A <code>ChunkListener</code> can be applied when there is no chunk declaration. The <code>TaskletStep</code> is
responsible for calling the <code>ChunkListener</code>, so it applies to a non-item-oriented tasklet
as well (it is called before and after the tasklet).</p>
</div>
</div>
<div class="sect4">
<h5 id="itemReadListener"><a class="anchor" href="#itemReadListener"></a><code>ItemReadListener</code></h5>
<div class="paragraph">
<p>When discussing skip logic previously, it was mentioned that it may be beneficial to log
the skipped records, so that they can be dealt with later. In the case of read errors,
this can be done with an <code>ItemReaderListener</code>, as shown in the following interface
definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemReadListener</span>&lt;T&gt; <span class="directive">extends</span> StepListener {

    <span class="type">void</span> beforeRead();
    <span class="type">void</span> afterRead(T item);
    <span class="type">void</span> onReadError(<span class="exception">Exception</span> ex);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>beforeRead</code> method is called before each call to read on the <code>ItemReader</code>. The
<code>afterRead</code> method is called after each successful call to read and is passed the item
that was read. If there was an error while reading, the <code>onReadError</code> method is called.
The exception encountered is provided so that it can be logged.</p>
</div>
<div class="paragraph">
<p>The annotations corresponding to this interface are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@BeforeRead</code></p>
</li>
<li>
<p><code>@AfterRead</code></p>
</li>
<li>
<p><code>@OnReadError</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="itemProcessListener"><a class="anchor" href="#itemProcessListener"></a><code>ItemProcessListener</code></h5>
<div class="paragraph">
<p>Just as with the <code>ItemReadListener</code>, the processing of an item can be 'listened' to, as
shown in the following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemProcessListener</span>&lt;T, S&gt; <span class="directive">extends</span> StepListener {

    <span class="type">void</span> beforeProcess(T item);
    <span class="type">void</span> afterProcess(T item, S result);
    <span class="type">void</span> onProcessError(T item, <span class="exception">Exception</span> e);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>beforeProcess</code> method is called before <code>process</code> on the <code>ItemProcessor</code> and is
handed the item that is to be processed. The <code>afterProcess</code> method is called after the
item has been successfully processed. If there was an error while processing, the
<code>onProcessError</code> method is called. The exception encountered and the item that was
attempted to be processed are provided, so that they can be logged.</p>
</div>
<div class="paragraph">
<p>The annotations corresponding to this interface are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@BeforeProcess</code></p>
</li>
<li>
<p><code>@AfterProcess</code></p>
</li>
<li>
<p><code>@OnProcessError</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="itemWriteListener"><a class="anchor" href="#itemWriteListener"></a><code>ItemWriteListener</code></h5>
<div class="paragraph">
<p>The writing of an item can be 'listened' to with the <code>ItemWriteListener</code>, as shown in the
following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemWriteListener</span>&lt;S&gt; <span class="directive">extends</span> StepListener {

    <span class="type">void</span> beforeWrite(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> S&gt; items);
    <span class="type">void</span> afterWrite(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> S&gt; items);
    <span class="type">void</span> onWriteError(<span class="exception">Exception</span> exception, <span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> S&gt; items);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>beforeWrite</code> method is called before <code>write</code> on the <code>ItemWriter</code> and is handed the
list of items that is written. The <code>afterWrite</code> method is called after the item has been
successfully written. If there was an error while writing, the <code>onWriteError</code> method is
called. The exception encountered and the item that was attempted to be written are
provided, so that they can be logged.</p>
</div>
<div class="paragraph">
<p>The annotations corresponding to this interface are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@BeforeWrite</code></p>
</li>
<li>
<p><code>@AfterWrite</code></p>
</li>
<li>
<p><code>@OnWriteError</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="skipListener"><a class="anchor" href="#skipListener"></a><code>SkipListener</code></h5>
<div class="paragraph">
<p><code>ItemReadListener</code>, <code>ItemProcessListener</code>, and <code>ItemWriteListener</code> all provide mechanisms
for being notified of errors, but none informs you that a record has actually been
skipped. <code>onWriteError</code>, for example, is called even if an item is retried and
successful. For this reason, there is a separate interface for tracking skipped items, as
shown in the following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SkipListener</span>&lt;T,S&gt; <span class="directive">extends</span> StepListener {

    <span class="type">void</span> onSkipInRead(<span class="predefined-type">Throwable</span> t);
    <span class="type">void</span> onSkipInProcess(T item, <span class="predefined-type">Throwable</span> t);
    <span class="type">void</span> onSkipInWrite(S item, <span class="predefined-type">Throwable</span> t);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>onSkipInRead</code> is called whenever an item is skipped while reading. It should be noted
that rollbacks may cause the same item to be registered as skipped more than once.
<code>onSkipInWrite</code> is called when an item is skipped while writing. Because the item has
been read successfully (and not skipped), it is also provided the item itself as an
argument.</p>
</div>
<div class="paragraph">
<p>The annotations corresponding to this interface are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@OnSkipInRead</code></p>
</li>
<li>
<p><code>@OnSkipInWrite</code></p>
</li>
<li>
<p><code>@OnSkipInProcess</code></p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="skipListenersAndTransactions"><a class="anchor" href="#skipListenersAndTransactions"></a>SkipListeners and Transactions</h6>
<div class="paragraph">
<p>One of the most common use cases for a <code>SkipListener</code> is to log out a skipped item, so
that another batch process or even human process can be used to evaluate and fix the
issue leading to the skip. Because there are many cases in which the original transaction
may be rolled back, Spring Batch makes two guarantees:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The appropriate skip method (depending on when the error happened) is called only once
per item.</p>
</li>
<li>
<p>The <code>SkipListener</code> is always called just before the transaction is committed. This is
to ensure that any transactional resources call by the listener are not rolled back by a
failure within the <code>ItemWriter</code>.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="taskletStep"><a class="anchor" href="#taskletStep"></a>5.2. <code>TaskletStep</code></h3>
<div class="paragraph">
<p><a href="#chunkOrientedProcessing">Chunk-oriented processing</a> is not the only way to process in a
<code>Step</code>. What if a <code>Step</code> must consist of a simple stored procedure call? You could
implement the call as an <code>ItemReader</code> and return null after the procedure finishes.
However, doing so is a bit unnatural, since there would need to be a no-op <code>ItemWriter</code>.
Spring Batch provides the <code>TaskletStep</code> for this scenario.</p>
</div>
<div class="paragraph">
<p><code>Tasklet</code> is a simple interface that has one method, <code>execute</code>, which is called
repeatedly by the <code>TaskletStep</code> until it either returns <code>RepeatStatus.FINISHED</code> or throws
an exception to signal a failure. Each call to a <code>Tasklet</code> is wrapped in a transaction.
<code>Tasklet</code> implementors might call a stored procedure, a script, or a simple SQL update
statement.</p>
</div>
<div class="paragraph xmlContent">
<p>To create a <code>TaskletStep</code>, the 'ref' attribute of the
    &lt;tasklet/&gt; element should reference a bean that defines a
    <code>Tasklet</code> object. No &lt;chunk/&gt; element should be
    used within the &lt;tasklet/&gt;. The following example shows a simple tasklet:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>To create a <code>TaskletStep</code>, the bean passed to the <code>tasklet</code> method of the builder should
implement the <code>Tasklet</code> interface.  No call to <code>chunk</code> should be called when building a
<code>TaskletStep</code>.  The following example shows  a simple tasklet:</p>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                            .tasklet(myTasklet())
                            .build();
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>TaskletStep</code> automatically registers the
      tasklet as a <code>StepListener</code> if it implements the <code>StepListener</code>
      interface.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="taskletAdapter"><a class="anchor" href="#taskletAdapter"></a>5.2.1. <code>TaskletAdapter</code></h4>
<div class="paragraph">
<p>As with other adapters for the <code>ItemReader</code> and <code>ItemWriter</code> interfaces, the <code>Tasklet</code>
interface contains an implementation that allows for adapting itself to any pre-existing
class: <code>TaskletAdapter</code>. An example where this may be useful is an existing DAO that is
used to update a flag on a set of records. The <code>TaskletAdapter</code> can be used to call this
class without having to write an adapter for the <code>Tasklet</code> interface, as shown in the
following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">o.s.b.core.step.tasklet.MethodInvokingTaskletAdapter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">targetObject</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mycompany.FooDao</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">targetMethod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updateFoo</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> MethodInvokingTaskletAdapter myTasklet() {
        MethodInvokingTaskletAdapter adapter = <span class="keyword">new</span> MethodInvokingTaskletAdapter();

        adapter.setTargetObject(fooDao());
        adapter.setTargetMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">updateFoo</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> adapter;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="exampleTaskletImplementation"><a class="anchor" href="#exampleTaskletImplementation"></a>5.2.2. Example <code>Tasklet</code> Implementation</h4>
<div class="paragraph">
<p>Many batch jobs contain steps that must be done before the main processing begins in
order to set up various resources or after processing has completed to cleanup those
resources. In the case of a job that works heavily with files, it is often necessary to
delete certain files locally after they have been uploaded successfully to another
location. The following example (taken from the
<a href="https://github.com/spring-projects/spring-batch/tree/master/spring-batch-samples">Spring
Batch samples project</a>) is a <code>Tasklet</code> implementation with just such a responsibility:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">FileDeletingTasklet</span> <span class="directive">implements</span> Tasklet, InitializingBean {

    <span class="directive">private</span> Resource directory;

    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
                                ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">File</span> dir = directory.getFile();
        Assert.state(dir.isDirectory());

        <span class="predefined-type">File</span><span class="type">[]</span> files = dir.listFiles();
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; files.length; i++) {
            <span class="type">boolean</span> deleted = files[i].delete();
            <span class="keyword">if</span> (!deleted) {
                <span class="keyword">throw</span> <span class="keyword">new</span> UnexpectedJobExecutionException(<span class="string"><span class="delimiter">&quot;</span><span class="content">Could not delete file </span><span class="delimiter">&quot;</span></span> +
                                                          files[i].getPath());
            }
        }
        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }

    <span class="directive">public</span> <span class="type">void</span> setDirectoryResource(Resource directory) {
        <span class="local-variable">this</span>.directory = directory;
    }

    <span class="directive">public</span> <span class="type">void</span> afterPropertiesSet() <span class="directive">throws</span> <span class="exception">Exception</span> {
        Assert.notNull(directory, <span class="string"><span class="delimiter">&quot;</span><span class="content">directory must be set</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding <code>Tasklet</code> implementation deletes all files within a given directory. It
should be noted that the <code>execute</code> method is called only once. All that is left is to
reference the <code>Tasklet</code> from the <code>Step</code>:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">deleteFilesInDir</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileDeletingTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span>

<span class="tag">&lt;beans:bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileDeletingTasklet</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.sample.tasklet.FileDeletingTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;beans:property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">directoryResource</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;beans:bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">directory</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.core.io.FileSystemResource</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;beans:constructor-arg</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">target/test-outputs/test-dir</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/beans:bean&gt;</span>
    <span class="tag">&lt;/beans:property&gt;</span>
<span class="tag">&lt;/beans:bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job taskletJob() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletJob</span><span class="delimiter">&quot;</span></span>)
                                .start(deleteFilesInDir())
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step deleteFilesInDir() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">deleteFilesInDir</span><span class="delimiter">&quot;</span></span>)
                                .tasklet(fileDeletingTasklet())
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> FileDeletingTasklet fileDeletingTasklet() {
        FileDeletingTasklet tasklet = <span class="keyword">new</span> FileDeletingTasklet();

        tasklet.setDirectoryResource(<span class="keyword">new</span> FileSystemResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">target/test-outputs/test-dir</span><span class="delimiter">&quot;</span></span>));

        <span class="keyword">return</span> tasklet;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="controllingStepFlow"><a class="anchor" href="#controllingStepFlow"></a>5.3. Controlling Step Flow</h3>
<div class="paragraph">
<p>With the ability to group steps together within an owning job comes the need to be able
to control how the job "flows" from one step to another. The failure of a <code>Step</code> does not
necessarily mean that the <code>Job</code> should fail. Furthermore, there may be more than one type
of 'success' that determines which <code>Step</code> should be executed next. Depending upon how a
group of <code>Steps</code> is configured, certain steps may not even be processed at all.</p>
</div>
<div class="sect3">
<h4 id="SequentialFlow"><a class="anchor" href="#SequentialFlow"></a>5.3.1. Sequential Flow</h4>
<div class="paragraph">
<p>The simplest flow scenario is a job where all of the steps execute sequentially, as shown
in the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/sequential-flow.png" alt="Sequential Flow">
</div>
<div class="title">Figure 15. Sequential Flow</div>
</div>
<div class="paragraph">
<p>This can be achieved by using the 'next' attribute of the step element, as shown in the
following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepA</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepB</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepB</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
                                .start(stepA())
                                .next(stepB())
                                .next(stepC())
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the scenario above, 'step A' runs first because it is the first <code>Step</code> listed. If
'step A' completes normally, then 'step B' runs, and so on. However, if 'step A' fails,
then the entire <code>Job</code> fails and 'step B' does not execute.</p>
</div>
<div class="admonitionblock note xmlContent">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With the Spring Batch namespace, the first step listed in the
        configuration is <em>always</em> the first step
        run by the <code>Job</code>. The order of the other
        step elements does not matter, but the first step must always appear
        first in the xml.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="conditionalFlow"><a class="anchor" href="#conditionalFlow"></a>5.3.2. Conditional Flow</h4>
<div class="paragraph">
<p>In the example above, there are only two possibilities:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>Step</code> is successful and the next <code>Step</code> should be executed.</p>
</li>
<li>
<p>The <code>Step</code> failed and, thus, the <code>Job</code> should fail.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In many cases, this may be sufficient. However, what about a scenario in which the
failure of a <code>Step</code> should trigger a different <code>Step</code>, rather than causing failure? The
following image shows such a flow:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/conditional-flow.png" alt="Conditional Flow">
</div>
<div class="title">Figure 16. Conditional Flow</div>
</div>
<div id="nextElement" class="paragraph">
<p>In order to handle more complex scenarios, the Spring Batch namespace allows transition
elements to be defined within the step element. One such transition is the <code>next</code>
element. Like the <code>next</code> attribute, the <code>next</code> element tells the <code>Job</code> which <code>Step</code> to
execute next. However, unlike the attribute, any number of <code>next</code> elements are allowed on
a given <code>Step</code>, and there is no default behavior in the case of failure. This means that, if
transition elements are used, then all of the behavior for the <code>Step</code> transitions must be
defined explicitly. Note also that a single step cannot have both a <code>next</code> attribute and
a <code>transition</code> element.</p>
</div>
<div class="paragraph">
<p>The <code>next</code> element specifies a pattern to match and the step to execute next, as shown in
the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepA</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepB</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepC</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepB</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepC</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
                                .start(stepA())
                                .on(<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>).to(stepB())
                                .from(stepA()).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span>).to(stepC())
                                .end()
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>When using XML configuration, the <code>on</code> attribute of a transition element uses a simple
pattern-matching scheme to match the <code>ExitStatus</code> that results from the execution of the
<code>Step</code>.</p>
</div>
<div class="paragraph javaContent">
<p>When using java configuration the <code>on</code> method uses a simple pattern-matching scheme to
match the <code>ExitStatus</code> that results from the execution of the <code>Step</code>.</p>
</div>
<div class="paragraph">
<p>Only two special characters are allowed in the pattern:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"*" matches zero or more characters</p>
</li>
<li>
<p>"?" matches exactly one character</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, "c*t" matches "cat" and "count", while "c?t" matches "cat" but not "count".</p>
</div>
<div class="paragraph">
<p>While there is no limit to the number of transition elements on a <code>Step</code>, if the <code>Step</code>
execution results in an <code>ExitStatus</code> that is not covered by an element, then the
framework throws an exception and the <code>Job</code> fails. The framework automatically orders
transitions from most specific to least specific. This means that, even if the ordering
were swapped for "stepA" in the example above, an <code>ExitStatus</code> of "FAILED" would still go
to "stepC".</p>
</div>
<div class="sect4">
<h5 id="batchStatusVsExitStatus"><a class="anchor" href="#batchStatusVsExitStatus"></a>Batch Status Versus Exit Status</h5>
<div class="paragraph">
<p>When configuring a <code>Job</code> for conditional flow, it is important to understand the
difference between <code>BatchStatus</code> and <code>ExitStatus</code>. <code>BatchStatus</code> is an enumeration that
is a property of both <code>JobExecution</code> and <code>StepExecution</code> and is used by the framework to
record the status of a <code>Job</code> or <code>Step</code>. It can be one of the following values:
<code>COMPLETED</code>, <code>STARTING</code>, <code>STARTED</code>, <code>STOPPING</code>, <code>STOPPED</code>, <code>FAILED</code>, <code>ABANDONED</code>, or
<code>UNKNOWN</code>. Most of them are self explanatory: <code>COMPLETED</code> is the status set when a step
or job has completed successfully, <code>FAILED</code> is set when it fails, and so on.</p>
</div>
<div class="paragraph xmlContent">
<p>The following example contains the 'next' element when using XML configuration:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepB</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>The following example contains the 'on' element when using Java Configuration:</p>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
.from(stepA()).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span>).to(stepB())
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>At first glance, it would appear that 'on' references the <code>BatchStatus</code> of the <code>Step</code> to
which it belongs. However, it actually references the <code>ExitStatus</code> of the <code>Step</code>. As the
name implies, <code>ExitStatus</code> represents the status of a <code>Step</code> after it finishes execution.</p>
</div>
<div class="paragraph xmlContent">
<p>More specifically, when using XML configuration, the 'next' element shown in the
preceding XML configuration example references the exit code of <code>ExitStatus</code>.</p>
</div>
<div class="paragraph xmlContent">
<p>When using Java configuration, the 'on' method shown in the preceding
Java configuration example references the exit code of <code>ExitStatus</code>.</p>
</div>
<div class="paragraph">
<p>In English, it says: "go to stepB if the exit code is <code>FAILED</code> ". By default, the exit
code is always the same as the <code>BatchStatus</code> for the <code>Step</code>, which is why the entry above
works. However, what if the exit code needs to be different? A good example comes from
the skip sample job within the samples project:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;end</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED WITH SKIPS</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">errorPrint1</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
                        .start(step1()).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span>).end()
                        .from(step1()).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED WITH SKIPS</span><span class="delimiter">&quot;</span></span>).to(errorPrint1())
                        .from(step1()).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>).to(step2())
                        .end()
                        .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>step1</code> has three possibilities:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>Step</code> failed, in which case the job should fail.</p>
</li>
<li>
<p>The <code>Step</code> completed successfully.</p>
</li>
<li>
<p>The <code>Step</code> completed successfully but with an exit code of 'COMPLETED WITH SKIPS'. In
this case, a different step should be run to handle the errors.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The above configuration works. However, something needs to change the exit code based on
the condition of the execution having skipped records, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SkipCheckingListener</span> <span class="directive">extends</span> StepExecutionListenerSupport {
    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {
        <span class="predefined-type">String</span> exitCode = stepExecution.getExitStatus().getExitCode();
        <span class="keyword">if</span> (!exitCode.equals(ExitStatus.FAILED.getExitCode()) &amp;&amp;
              stepExecution.getSkipCount() &gt; <span class="integer">0</span>) {
            <span class="keyword">return</span> <span class="keyword">new</span> ExitStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED WITH SKIPS</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="keyword">else</span> {
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above code is a <code>StepExecutionListener</code> that first checks to make sure the <code>Step</code> was
successful and then checks to see if the skip count on the <code>StepExecution</code> is higher than
0. If both conditions are met, a new <code>ExitStatus</code> with an exit code of
<code>COMPLETED WITH SKIPS</code> is returned.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuringForStop"><a class="anchor" href="#configuringForStop"></a>5.3.3. Configuring for Stop</h4>
<div class="paragraph">
<p>After the discussion of <a href="#batchStatusVsExitStatus">BatchStatus and ExitStatus</a>,
one might wonder how the <code>BatchStatus</code> and <code>ExitStatus</code> are determined for the <code>Job</code>.
While these statuses are determined for the <code>Step</code> by the code that is executed, the
statuses for the <code>Job</code> are determined based on the configuration.</p>
</div>
<div class="paragraph">
<p>So far, all of the job configurations discussed have had at least one final <code>Step</code> with
no transitions. For example, after the following step executes, the <code>Job</code> ends, as shown
in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
                                .start(step1())
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no transitions are defined for a <code>Step</code>, then the status of the <code>Job</code> is defined as
follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the <code>Step</code> ends with <code>ExitStatus</code> FAILED, then the <code>BatchStatus</code> and <code>ExitStatus</code> of
the <code>Job</code> are both <code>FAILED</code>.</p>
</li>
<li>
<p>Otherwise, the <code>BatchStatus</code> and <code>ExitStatus</code> of the <code>Job</code> are both <code>COMPLETED</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While this method of terminating a batch job is sufficient for some batch jobs, such as a
simple sequential step job, custom defined job-stopping scenarios may be required. For
this purpose, Spring Batch provides three transition elements to stop a <code>Job</code> (in
addition to the <a href="#nextElement"><code>next</code> element</a> that we discussed previously).
Each of these stopping elements stops a <code>Job</code> with a particular <code>BatchStatus</code>. It is
important to note that the stop transition elements have no effect on either the
<code>BatchStatus</code> or <code>ExitStatus</code> of any <code>Steps</code> in the <code>Job</code>. These elements affect only the
final statuses of the <code>Job</code>. For example, it is possible for every step in a job to have
a status of <code>FAILED</code> but for the job to have a status of <code>COMPLETED</code>.</p>
</div>
<div class="sect4">
<h5 id="endElement"><a class="anchor" href="#endElement"></a>Ending at a Step</h5>
<div class="paragraph">
<p>Configuring a step end instructs a <code>Job</code> to stop with a <code>BatchStatus</code> of <code>COMPLETED</code>. A
<code>Job</code> that has finished with status <code>COMPLETED</code> cannot be restarted (the framework throws
a <code>JobInstanceAlreadyCompleteException</code>).</p>
</div>
<div class="paragraph xmlContent">
<p>When using XML configuration, the 'end' element is used for this task.  The <code>end</code> element
also allows for an optional 'exit-code' attribute that can be used to customize the
<code>ExitStatus</code> of the <code>Job</code>. If no 'exit-code' attribute is given, then the <code>ExitStatus</code> is
<code>COMPLETED</code> by default, to match the <code>BatchStatus</code>.</p>
</div>
<div class="paragraph javaContent">
<p>When using Java configuration, the 'end' method is used for this task.  The <code>end</code> method
also allows for an optional 'exitStatus' parameter that can be used to customize the
<code>ExitStatus</code> of the <code>Job</code>. If no 'exitStatus' value is provided, then the <code>ExitStatus</code> is
<code>COMPLETED</code> by default, to match the <code>BatchStatus</code>.</p>
</div>
<div class="paragraph">
<p>In the following scenario, if <code>step2</code> fails, then the <code>Job</code> stops with a <code>BatchStatus</code> of
<code>COMPLETED</code> and an <code>ExitStatus</code> of <code>COMPLETED</code> and <code>step3</code> does not run. Otherwise,
execution moves to <code>step3</code>. Note that if <code>step2</code> fails, the <code>Job</code> is not restartable
(because the status is <code>COMPLETED</code>).</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;end</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/step&gt;</span>

<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
                                .start(step1())
                                .next(step2())
                                .on(<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span>).end()
                                .from(step2()).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>).to(step3())
                                .end()
                                .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="failElement"><a class="anchor" href="#failElement"></a>Failing a Step</h5>
<div class="paragraph">
<p>Configuring a step to fail at a given point instructs a <code>Job</code> to stop with a
<code>BatchStatus</code> of <code>FAILED</code>. Unlike end, the failure of a <code>Job</code> does not prevent the <code>Job</code>
from being restarted.</p>
</div>
<div class="paragraph xmlContent">
<p>When using XML configuration, the 'fail' element also allows for an optional 'exit-code'
attribute that can be used to customize the <code>ExitStatus</code> of the <code>Job</code>. If no 'exit-code'
attribute is given, then the <code>ExitStatus</code> is <code>FAILED</code> by default, to match the
<code>BatchStatus</code>.</p>
</div>
<div class="paragraph">
<p>In the following scenario, if <code>step2</code> fails, then the <code>Job</code> stops with a <code>BatchStatus</code> of
<code>FAILED</code> and an <code>ExitStatus</code> of <code>EARLY TERMINATION</code> and <code>step3</code> does not execute.
Otherwise, execution moves to <code>step3</code>. Additionally, if <code>step2</code> fails and the <code>Job</code> is
restarted, then execution begins again on <code>step2</code>.</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;fail</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exit-code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EARLY TERMINATION</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/step&gt;</span>

<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
                        .start(step1())
                        .next(step2()).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span>).fail()
                        .from(step2()).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>).to(step3())
                        .end()
                        .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="stopElement"><a class="anchor" href="#stopElement"></a>Stopping a Job at a Given Step</h5>
<div class="paragraph">
<p>Configuring a job to stop at a particular step instructs a <code>Job</code> to stop with a
<code>BatchStatus</code> of <code>STOPPED</code>. Stopping a <code>Job</code> can provide a temporary break in processing,
so that the operator can take some action before restarting the <code>Job</code>.</p>
</div>
<div class="paragraph xmlContent">
<p>When using XML configuration 'stop' element requires a 'restart' attribute that specifies
the step where execution should pick up when the "Job is restarted".</p>
</div>
<div class="paragraph javaContent">
<p>When using java configuration, the <code>stopAndRestart</code> method requires a 'restart' attribute
that specifies the step where execution should pick up when the "Job is restarted".</p>
</div>
<div class="paragraph">
<p>In the following scenario, if <code>step1</code> finishes with <code>COMPLETE</code>, then the job stops.
Once it is restarted, execution begins on <code>step2</code>.</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;stop</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restart</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/step&gt;</span>

<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
                        .start(step1()).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span>).stopAndRestart(step2())
                        .end()
                        .build();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="programmaticFlowDecisions"><a class="anchor" href="#programmaticFlowDecisions"></a>5.3.4. Programmatic Flow Decisions</h4>
<div class="paragraph">
<p>In some situations, more information than the <code>ExitStatus</code> may be required to decide
which step to execute next. In this case, a <code>JobExecutionDecider</code> can be used to assist
in the decision, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyDecider</span> <span class="directive">implements</span> JobExecutionDecider {
    <span class="directive">public</span> FlowExecutionStatus decide(JobExecution jobExecution, StepExecution stepExecution) {
        <span class="predefined-type">String</span> status;
        <span class="keyword">if</span> (someCondition()) {
            status = <span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span>;
        }
        <span class="keyword">else</span> {
            status = <span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span>;
        }
        <span class="keyword">return</span> <span class="keyword">new</span> FlowExecutionStatus(status);
    }
}</code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>In the following sample job configuration, a <code>decision</code> specifies the decider to use as
well as all of the transitions:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">decision</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

    <span class="tag">&lt;decision</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">decision</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">decider</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">decider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step3</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/decision&gt;</span>

    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/job&gt;</span>

<span class="tag">&lt;beans:bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">decider</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.MyDecider</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>In the following example, a bean implementing the <code>JobExecutionDecider</code> is passed
directly to the <code>next</code> call when using Java configuration.</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
                        .start(step1())
                        .next(decider()).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span>).to(step2())
                        .from(decider()).on(<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span>).to(step3())
                        .end()
                        .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="split-flows"><a class="anchor" href="#split-flows"></a>5.3.5. Split Flows</h4>
<div class="paragraph">
<p>Every scenario described so far has involved a <code>Job</code> that executes its steps one at a
time in a linear fashion. In addition to this typical style, Spring Batch also allows
for a job to be configured with parallel flows.</p>
</div>
<div class="paragraph xmlContent">
<p>The XML namespace allows you to use the 'split' element. As the following example shows,
the 'split' element contains one or more 'flow' elements, where entire separate flows can
be defined. A 'split' element may also contain any of the previously discussed transition
elements, such as the 'next' attribute or the 'next', 'end' or 'fail' elements.</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;split</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">split1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;flow&gt;</span>
        <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/flow&gt;</span>
    <span class="tag">&lt;flow&gt;</span>
        <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/flow&gt;</span>
<span class="tag">&lt;/split&gt;</span>
<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>Java based configuration lets you configure splits through the provided builders. As the
following example shows, the 'split' element contains one or more 'flow' elements, where
entire separate flows can be defined. A 'split' element may also contain any of the
previously discussed transition elements, such as the 'next' attribute or the 'next',
'end' or 'fail' elements.</p>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job() {
        Flow flow1 = <span class="keyword">new</span> FlowBuilder&lt;SimpleFlow&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">flow1</span><span class="delimiter">&quot;</span></span>)
                        .start(step1())
                        .next(step2())
                        .build();
        Flow flow2 = <span class="keyword">new</span> FlowBuilder&lt;SimpleFlow&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">flow2</span><span class="delimiter">&quot;</span></span>)
                        .start(step3())
                        .build();

        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
                                .start(flow1)
                                .split(<span class="keyword">new</span> SimpleAsyncTaskExecutor())
                                .add(flow2)
                                .next(step4())
                                .end()
                                .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="external-flows"><a class="anchor" href="#external-flows"></a>5.3.6. Externalizing Flow Definitions and Dependencies Between Jobs</h4>
<div class="paragraph">
<p>Part of the flow in a job can be externalized as a separate bean definition and then
re-used. There are two ways to do so. The first is to simply declare the flow as a
reference to one defined elsewhere, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;flow</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job1.flow1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flow1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/job&gt;</span>

<span class="tag">&lt;flow</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flow1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
                                .start(flow1())
                                .next(step3())
                                .end()
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Flow flow1() {
        <span class="keyword">return</span> <span class="keyword">new</span> FlowBuilder&lt;SimpleFlow&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">flow1</span><span class="delimiter">&quot;</span></span>)
                        .start(step1())
                        .next(step2())
                        .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The effect of defining an external flow as shown in the preceding example is to insert
the steps from the external flow into the job as if they had been declared inline. In
this way, many jobs can refer to the same template flow and compose such templates into
different logical flows. This is also a good way to separate the integration testing of
the individual flows.</p>
</div>
<div class="paragraph">
<p>The other form of an externalized flow is to use a <code>JobStep</code>. A <code>JobStep</code> is similar to a
<code>FlowStep</code> but actually creates and launches a separate job execution for the steps in
the flow specified.</p>
</div>
<div class="paragraph xmlContent">
<p>The following XML snippet shows an example of a <code>JobStep</code>:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStepJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restartable</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStepJob.step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;job</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-launcher</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLauncher</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">job-parameters-extractor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span>

<span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restartable</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>...<span class="tag">&lt;/job&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersExtractor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...DefaultJobParametersExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keys</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">input.file</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>The following Java snippet shows an example of a <code>JobStep</code>:</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job jobStepJob() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStepJob</span><span class="delimiter">&quot;</span></span>)
                                .start(jobStepJobStep1(<span class="predefined-constant">null</span>))
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step jobStepJobStep1(JobLauncher jobLauncher) {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStepJobStep1</span><span class="delimiter">&quot;</span></span>)
                                .job(job())
                                .launcher(jobLauncher)
                                .parametersExtractor(jobParametersExtractor())
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Job job() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
                                .start(step1())
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> DefaultJobParametersExtractor jobParametersExtractor() {
        DefaultJobParametersExtractor extractor = <span class="keyword">new</span> DefaultJobParametersExtractor();

        extractor.setKeys(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span>{<span class="string"><span class="delimiter">&quot;</span><span class="content">input.file</span><span class="delimiter">&quot;</span></span>});

        <span class="keyword">return</span> extractor;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The job parameters extractor is a strategy that determines how the <code>ExecutionContext</code> for
the <code>Step</code> is converted into <code>JobParameters</code> for the <code>Job</code> that is run. The <code>JobStep</code> is
useful when you want to have some more granular options for monitoring and reporting on
jobs and steps. Using <code>JobStep</code> is also often a good answer to the question: "How do I
create dependencies between jobs?" It is a good way to break up a large system into
smaller modules and control the flow of jobs.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="late-binding"><a class="anchor" href="#late-binding"></a>5.4. Late Binding of <code>Job</code> and <code>Step</code> Attributes</h3>
<div class="paragraph">
<p>Both the XML and flat file examples shown earlier use the Spring <code>Resource</code> abstraction
to obtain a file. This works because <code>Resource</code> has a <code>getFile</code> method, which returns a
<code>java.io.File</code>. Both XML and flat file resources can be configured using standard Spring
constructs, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file://outputs/file.txt</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemReader flatFileItemReader() {
        FlatFileItemReader&lt;Foo&gt; reader = <span class="keyword">new</span> FlatFileItemReaderBuilder&lt;Foo&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span>)
                        .resource(<span class="keyword">new</span> FileSystemResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">file://outputs/file.txt</span><span class="delimiter">&quot;</span></span>))
                        ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding <code>Resource</code> loads the file from the specified file system location. Note
that absolute locations have to start with a double slash (<code>//</code>). In most Spring
applications, this solution is good enough, because the names of these resources are
known at compile time. However, in batch scenarios, the file name may need to be
determined at runtime as a parameter to the job. This can be solved using '-D' parameters
to read a system property.</p>
</div>
<div class="paragraph xmlContent">
<p>The following XML snippet shows how to read a file name from a property:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${input.file.name}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>The following Java snippet shows how to read a file name from a property:</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemReader flatFileItemReader(<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${input.file.name}</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name) {
        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemReaderBuilder&lt;Foo&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span>)
                        .resource(<span class="keyword">new</span> FileSystemResource(name))
                        ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All that would be required for this solution to work would be a system argument (such as
<code>-Dinput.file.name="file://outputs/file.txt"</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Although a <code>PropertyPlaceholderConfigurer</code> can be used here, it is not
necessary if the system property is always set because the <code>ResourceEditor</code> in Spring
already filters and does placeholder replacement on system properties.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Often, in a batch setting, it is preferable to parametrize the file name in the
<code>JobParameters</code> of the job, instead of through system properties, and access them that
way. To accomplish this, Spring Batch allows for the late binding of various <code>Job</code> and
<code>Step</code> attributes, as shown in the following snippet:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['input.file.name']}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@StepScope</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemReader flatFileItemReader(<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['input.file.name']}</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name) {
        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemReaderBuilder&lt;Foo&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span>)
                        .resource(<span class="keyword">new</span> FileSystemResource(name))
                        ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both the <code>JobExecution</code> and <code>StepExecution</code> level <code>ExecutionContext</code> can be accessed in
the same way, as shown in the following examples:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobExecutionContext['input.file.name']}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{stepExecutionContext['input.file.name']}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@StepScope</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemReader flatFileItemReader(<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobExecutionContext['input.file.name']}</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name) {
        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemReaderBuilder&lt;Foo&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span>)
                        .resource(<span class="keyword">new</span> FileSystemResource(name))
                        ...
}</code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@StepScope</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemReader flatFileItemReader(<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{stepExecutionContext['input.file.name']}</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name) {
        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemReaderBuilder&lt;Foo&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span>)
                        .resource(<span class="keyword">new</span> FileSystemResource(name))
                        ...
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Any bean that uses late-binding must be declared with scope="step". See
<a href="#step-scope">Step Scope</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="step-scope"><a class="anchor" href="#step-scope"></a>5.4.1. Step Scope</h4>
<div class="paragraph">
<p>All of the late binding examples from above have a scope of "step" declared on the bean
definition, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters[input.file.name]}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@StepScope</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemReader flatFileItemReader(<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters[input.file.name]}</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name) {
        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemReaderBuilder&lt;Foo&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span>)
                        .resource(<span class="keyword">new</span> FileSystemResource(name))
                        ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using a scope of <code>Step</code> is required in order to use late binding, because the bean cannot
actually be instantiated until the <code>Step</code> starts, to allow the attributes to be found.
Because it is not part of the Spring container by default, the scope must be added
explicitly, by using the <code>batch</code> namespace or by including a bean definition explicitly
for the <code>StepScope</code>, or by using the <code>@EnableBatchProcessing</code> annotation. Use only one of
those methods.  The following example uses the <code>batch</code> namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">...</span><span class="tag">/&gt;</span>
...
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example includes the bean definition explicitly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.scope.StepScope</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="job-scope"><a class="anchor" href="#job-scope"></a>5.4.2. Job Scope</h4>
<div class="paragraph">
<p><code>Job</code> scope, introduced in Spring Batch 3.0, is similar to <code>Step</code> scope in configuration
but is a Scope for the <code>Job</code> context, so that there is only one instance of such a bean
per running job. Additionally, support is provided for late binding of references
accessible from the <code>JobContext</code> using <code>#{..}</code> placeholders. Using this feature, bean
properties can be pulled from the job or job execution context and the job parameters, as
shown in the following examples:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters[input]}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobExecutionContext['input.name']}.txt</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JobScope</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemReader flatFileItemReader(<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters[input]}</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name) {
        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemReaderBuilder&lt;Foo&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span>)
                        .resource(<span class="keyword">new</span> FileSystemResource(name))
                        ...
}</code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JobScope</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemReader flatFileItemReader(<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobExecutionContext['input.name']}</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name) {
        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemReaderBuilder&lt;Foo&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span>)
                        .resource(<span class="keyword">new</span> FileSystemResource(name))
                        ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because it is not part of the Spring container by default, the scope must be added
explicitly, by using the <code>batch</code> namespace, by including a bean definition explicitly for
the JobScope, or using the <code>@EnableBatchProcessing</code> annotation (but not all of them).
The following example uses the <code>batch</code> namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">...</span><span class="tag">/&gt;</span>
...
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example includes a bean that explicitly defines the <code>JobScope</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.scope.JobScope</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="readersAndWriters"><a class="anchor" href="#readersAndWriters"></a>6. ItemReaders and ItemWriters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All batch processing can be described in its most simple form as reading in large amounts
of data, performing some type of calculation or transformation, and writing the result
out. Spring Batch provides three key interfaces to help perform bulk reading and writing:
<code>ItemReader</code>, <code>ItemProcessor</code>, and <code>ItemWriter</code>.</p>
</div>
<div class="sect2">
<h3 id="itemReader"><a class="anchor" href="#itemReader"></a>6.1. <code>ItemReader</code></h3>
<div class="paragraph">
<p>Although a simple concept, an <code>ItemReader</code> is the means for providing data from many
different types of input. The most general examples include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Flat File: Flat-file item readers read lines of data from a flat file that typically
describes records with fields of data defined by fixed positions in the file or delimited
by some special character (such as a comma).</p>
</li>
<li>
<p>XML: XML <code>ItemReaders</code> process XML independently of technologies used for parsing,
mapping and validating objects. Input data allows for the validation of an XML file
against an XSD schema.</p>
</li>
<li>
<p>Database: A database resource is accessed to return resultsets which can be mapped to
objects for processing. The default SQL <code>ItemReader</code> implementations invoke a <code>RowMapper</code>
to return objects, keep track of the current row if restart is required, store basic
statistics, and provide some transaction enhancements that are explained later.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are many more possibilities, but we focus on the basic ones for this chapter. A
complete list of all available <code>ItemReader</code> implementations can be found in
<a href="#listOfReadersAndWriters">Appendix A</a>.</p>
</div>
<div class="paragraph">
<p><code>ItemReader</code> is a basic interface for generic
input operations, as shown in the following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemReader</span>&lt;T&gt; {

    T read() <span class="directive">throws</span> <span class="exception">Exception</span>, UnexpectedInputException, <span class="exception">ParseException</span>, NonTransientResourceException;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>read</code> method defines the most essential contract of the <code>ItemReader</code>. Calling it
returns one item or <code>null</code> if no more items are left. An item might represent a line in a
file, a row in a database, or an element in an XML file. It is generally expected that
these are mapped to a usable domain object (such as <code>Trade</code>, <code>Foo</code>, or others), but there
is no requirement in the contract to do so.</p>
</div>
<div class="paragraph">
<p>It is expected that implementations of the <code>ItemReader</code> interface are forward only.
However, if the underlying resource is transactional (such as a JMS queue) then calling
<code>read</code> may return the same logical item on subsequent calls in a rollback scenario. It is
also worth noting that a lack of items to process by an <code>ItemReader</code> does not cause an
exception to be thrown. For example, a database <code>ItemReader</code> that is configured with a
query that returns 0 results returns <code>null</code> on the first invocation of read.</p>
</div>
</div>
<div class="sect2">
<h3 id="itemWriter"><a class="anchor" href="#itemWriter"></a>6.2. <code>ItemWriter</code></h3>
<div class="paragraph">
<p><code>ItemWriter</code> is similar in functionality to an <code>ItemReader</code> but with inverse operations.
Resources still need to be located, opened, and closed but they differ in that an
<code>ItemWriter</code> writes out, rather than reading in. In the case of databases or queues,
these operations may be inserts, updates, or sends. The format of the serialization of
the output is specific to each batch job.</p>
</div>
<div class="paragraph">
<p>As with <code>ItemReader</code>,
<code>ItemWriter</code> is a fairly generic interface, as shown in the following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemWriter</span>&lt;T&gt; {

    <span class="type">void</span> write(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> T&gt; items) <span class="directive">throws</span> <span class="exception">Exception</span>;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with <code>read</code> on <code>ItemReader</code>, <code>write</code> provides the basic contract of <code>ItemWriter</code>. It
attempts to write out the list of items passed in as long as it is open. Because it is
generally expected that items are 'batched' together into a chunk and then output, the
interface accepts a list of items, rather than an item by itself. After writing out the
list, any flushing that may be necessary can be performed before returning from the write
method. For example, if writing to a Hibernate DAO, multiple calls to write can be made,
one for each item. The writer can then call <code>flush</code> on the hibernate session before
returning.</p>
</div>
</div>
<div class="sect2">
<h3 id="itemProcessor"><a class="anchor" href="#itemProcessor"></a>6.3. <code>ItemProcessor</code></h3>
<div class="paragraph">
<p>The <code>ItemReader</code> and <code>ItemWriter</code> interfaces are both very useful for their specific
tasks, but what if you want to insert business logic before writing? One option for both
reading and writing is to use the composite pattern: Create an <code>ItemWriter</code> that contains
another <code>ItemWriter</code> or an <code>ItemReader</code> that contains another <code>ItemReader</code>. The following
code shows an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CompositeItemWriter</span>&lt;T&gt; <span class="directive">implements</span> ItemWriter&lt;T&gt; {

    ItemWriter&lt;T&gt; itemWriter;

    <span class="directive">public</span> CompositeItemWriter(ItemWriter&lt;T&gt; itemWriter) {
        <span class="local-variable">this</span>.itemWriter = itemWriter;
    }

    <span class="directive">public</span> <span class="type">void</span> write(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> T&gt; items) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">//Add business logic here</span>
       itemWriter.write(items);
    }

    <span class="directive">public</span> <span class="type">void</span> setDelegate(ItemWriter&lt;T&gt; itemWriter){
        <span class="local-variable">this</span>.itemWriter = itemWriter;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding class contains another <code>ItemWriter</code> to which it delegates after having
provided some business logic. This pattern could easily be used for an <code>ItemReader</code> as
well, perhaps to obtain more reference data based upon the input that was provided by the
main <code>ItemReader</code>. It is also useful if you need to control the call to <code>write</code> yourself.
However, if you only want to 'transform' the item passed in for writing before it is
actually written, you need not <code>write</code> yourself. You can just modify the item. For this
scenario, Spring Batch provides the <code>ItemProcessor</code> interface, as shown in the following
interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemProcessor</span>&lt;I, O&gt; {

    O process(I item) <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An <code>ItemProcessor</code> is simple. Given one object, transform it and return another. The
provided object may or may not be of the same type. The point is that business logic may
be applied within the process, and it is completely up to the developer to create that
logic. An <code>ItemProcessor</code> can be wired directly into a step. For example, assume an
<code>ItemReader</code> provides a class of type <code>Foo</code> and that it needs to be converted to type <code>Bar</code>
before being written out. The following example shows an <code>ItemProcessor</code> that performs
the conversion:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Foo</span> {}

<span class="directive">public</span> <span class="type">class</span> <span class="class">Bar</span> {
    <span class="directive">public</span> Bar(Foo foo) {}
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">FooProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;Foo,Bar&gt;{
    <span class="directive">public</span> Bar process(Foo foo) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">//Perform simple transformation, convert a Foo to a Bar</span>
        <span class="keyword">return</span> <span class="keyword">new</span> Bar(foo);
    }
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">BarWriter</span> <span class="directive">implements</span> ItemWriter&lt;Bar&gt;{
    <span class="directive">public</span> <span class="type">void</span> write(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> Bar&gt; bars) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">//write bars</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, there is a class <code>Foo</code>, a class <code>Bar</code>, and a class
<code>FooProcessor</code> that adheres to the <code>ItemProcessor</code> interface. The transformation is
simple, but any type of transformation could be done here. The <code>BarWriter</code> writes <code>Bar</code>
objects, throwing an exception if any other type is provided. Similarly, the
<code>FooProcessor</code> throws an exception if anything but a <code>Foo</code> is provided. The
<code>FooProcessor</code> can then be injected into a <code>Step</code>, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ioSampleJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooProcessor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">barWriter</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job ioSampleJob() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">ioSampleJOb</span><span class="delimiter">&quot;</span></span>)
                                .start(step1())
                                .end()
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">2</span>)
                                .reader(fooReader())
                                .processor(fooProcessor())
                                .writer(barWriter())
                                .build();
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="chainingItemProcessors"><a class="anchor" href="#chainingItemProcessors"></a>6.3.1. Chaining ItemProcessors</h4>
<div class="paragraph">
<p>Performing a single transformation is useful in many scenarios, but what if you want to
'chain' together multiple <code>ItemProcessor</code> implementations? This can be accomplished using
the composite pattern mentioned previously. To update the previous, single
transformation, example, <code>Foo</code> is transformed to <code>Bar</code>, which is transformed to <code>Foobar</code>
and written out, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Foo</span> {}

<span class="directive">public</span> <span class="type">class</span> <span class="class">Bar</span> {
    <span class="directive">public</span> Bar(Foo foo) {}
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">Foobar</span> {
    <span class="directive">public</span> Foobar(Bar bar) {}
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">FooProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;Foo,Bar&gt;{
    <span class="directive">public</span> Bar process(Foo foo) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">//Perform simple transformation, convert a Foo to a Bar</span>
        <span class="keyword">return</span> <span class="keyword">new</span> Bar(foo);
    }
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">BarProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;Bar,Foobar&gt;{
    <span class="directive">public</span> Foobar process(Bar bar) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">return</span> <span class="keyword">new</span> Foobar(bar);
    }
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">FoobarWriter</span> <span class="directive">implements</span> ItemWriter&lt;Foobar&gt;{
    <span class="directive">public</span> <span class="type">void</span> write(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> Foobar&gt; items) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">//write items</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>FooProcessor</code> and a <code>BarProcessor</code> can be 'chained' together to give the resultant
<code>Foobar</code>, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CompositeItemProcessor&lt;Foo,Foobar&gt; compositeProcessor =
                                      <span class="keyword">new</span> CompositeItemProcessor&lt;Foo,Foobar&gt;();
<span class="predefined-type">List</span> itemProcessors = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>();
itemProcessors.add(<span class="keyword">new</span> FooTransformer());
itemProcessors.add(<span class="keyword">new</span> BarTransformer());
compositeProcessor.setDelegates(itemProcessors);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just as with the previous example, the composite processor can be configured into the
<code>Step</code>:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ioSampleJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">compositeItemProcessor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foobarWriter</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">compositeItemProcessor</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.CompositeItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegates</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">..FooProcessor</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">..BarProcessor</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job ioSampleJob() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">ioSampleJob</span><span class="delimiter">&quot;</span></span>)
                                .start(step1())
                                .end()
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">2</span>)
                                .reader(fooReader())
                                .processor(compositeProcessor())
                                .writer(foobarWriter())
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> CompositeItemProcessor compositeProcessor() {
        <span class="predefined-type">List</span>&lt;ItemProcessor&gt; delegates = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(<span class="integer">2</span>);
        delegates.add(<span class="keyword">new</span> FooProcessor());
        delegates.add(<span class="keyword">new</span> BarProcessor());

        CompositeItemProcessor processor = <span class="keyword">new</span> CompositeItemProcessor();

        processor.setDelegates(delegates);

        <span class="keyword">return</span> processor;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="filteringRecords"><a class="anchor" href="#filteringRecords"></a>6.3.2. Filtering Records</h4>
<div class="paragraph">
<p>One typical use for an item processor is to filter out records before they are passed to
the <code>ItemWriter</code>. Filtering is an action distinct from skipping. Skipping indicates that
a record is invalid, while filtering simply indicates that a record should not be
written.</p>
</div>
<div class="paragraph">
<p>For example, consider a batch job that reads a file containing three different types of
records: records to insert, records to update, and records to delete. If record deletion
is not supported by the system, then we would not want to send any "delete" records to
the <code>ItemWriter</code>. But, since these records are not actually bad records, we would want to
filter them out rather than skip them. As a result, the <code>ItemWriter</code> would receive only
"insert" and "update" records.</p>
</div>
<div class="paragraph">
<p>To filter a record, you can return <code>null</code> from the <code>ItemProcessor</code>. The framework detects
that the result is <code>null</code> and avoids adding that item to the list of records delivered to
the <code>ItemWriter</code>. As usual, an exception thrown from the <code>ItemProcessor</code> results in a
skip.</p>
</div>
</div>
<div class="sect3">
<h4 id="faultTolerant"><a class="anchor" href="#faultTolerant"></a>6.3.3. Fault Tolerance</h4>
<div class="paragraph">
<p>When a chunk is rolled back, items that have been cached during reading may be
reprocessed.  If a step is configured to be fault tolerant (typically by using skip or
retry processing), any <code>ItemProcessor</code> used should be implemented in a way that is
idempotent.  Typically that would consist of performing no changes on the input item for
the <code>ItemProcessor</code> and only updating the
instance that is the result.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="itemStream"><a class="anchor" href="#itemStream"></a>6.4. <code>ItemStream</code></h3>
<div class="paragraph">
<p>Both <code>ItemReaders</code> and <code>ItemWriters</code> serve their individual purposes well, but there is a
common concern among both of them that necessitates another interface. In general, as
part of the scope of a batch job, readers and writers need to be opened, closed, and
require a mechanism for persisting state. The <code>ItemStream</code> interface serves that purpose,
as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemStream</span> {

    <span class="type">void</span> open(ExecutionContext executionContext) <span class="directive">throws</span> ItemStreamException;

    <span class="type">void</span> update(ExecutionContext executionContext) <span class="directive">throws</span> ItemStreamException;

    <span class="type">void</span> close() <span class="directive">throws</span> ItemStreamException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before describing each method, we should mention the <code>ExecutionContext</code>. Clients of an
<code>ItemReader</code> that also implement <code>ItemStream</code> should call <code>open</code> before any calls to
<code>read</code>, in order to open any resources such as files or to obtain connections. A similar
restriction applies to an <code>ItemWriter</code> that implements <code>ItemStream</code>. As mentioned in
Chapter 2, if expected data is found in the <code>ExecutionContext</code>, it may be used to start
the <code>ItemReader</code> or <code>ItemWriter</code> at a location other than its initial state. Conversely,
<code>close</code> is called to ensure that any resources allocated during open are released safely.
<code>update</code> is called primarily to ensure that any state currently being held is loaded into
the provided <code>ExecutionContext</code>. This method is called before committing, to ensure that
the current state is persisted in the database before commit.</p>
</div>
<div class="paragraph">
<p>In the special case where the client of an <code>ItemStream</code> is a <code>Step</code> (from the Spring
Batch Core), an <code>ExecutionContext</code> is created for each StepExecution to allow users to
store the state of a particular execution, with the expectation that it is returned if
the same <code>JobInstance</code> is started again. For those familiar with Quartz, the semantics
are very similar to a Quartz <code>JobDataMap</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="delegatePatternAndRegistering"><a class="anchor" href="#delegatePatternAndRegistering"></a>6.5. The Delegate Pattern and Registering with the Step</h3>
<div class="paragraph">
<p>Note that the <code>CompositeItemWriter</code> is an example of the delegation pattern, which is
common in Spring Batch. The delegates themselves might implement callback interfaces,
such as <code>StepListener</code>. If they do and if they are being used in conjunction with Spring
Batch Core as part of a <code>Step</code> in a <code>Job</code>, then they almost certainly need to be
registered manually with the <code>Step</code>. A reader, writer, or processor that is directly
wired into the <code>Step</code> gets registered automatically if it implements <code>ItemStream</code> or a
<code>StepListener</code> interface. However, because the delegates are not known to the <code>Step</code>,
they need to be injected as listeners or streams (or both if appropriate), as shown in
the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ioSampleJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooProcessor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">compositeItemWriter</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;streams&gt;</span>
                    <span class="tag">&lt;stream</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">barWriter</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                <span class="tag">&lt;/streams&gt;</span>
            <span class="tag">&lt;/chunk&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">compositeItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...CustomCompositeItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegate</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">barWriter</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">barWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...BarWriter</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job ioSampleJob() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">ioSampleJob</span><span class="delimiter">&quot;</span></span>)
                                .start(step1())
                                .end()
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">2</span>)
                                .reader(fooReader())
                                .processor(fooProcessor())
                                .writer(compositeItemWriter())
                                .stream(barWriter())
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> CustomCompositeItemWriter compositeItemWriter() {

        CustomCompositeItemWriter writer = <span class="keyword">new</span> CustomCompositeItemWriter();

        writer.setDelegate(barWriter());

        <span class="keyword">return</span> writer;
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> BarWriter barWriter() {
        <span class="keyword">return</span> <span class="keyword">new</span> BarWriter();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="flatFiles"><a class="anchor" href="#flatFiles"></a>6.6. Flat Files</h3>
<div class="paragraph">
<p>One of the most common mechanisms for interchanging bulk data has always been the flat
file. Unlike XML, which has an agreed upon standard for defining how it is structured
(XSD), anyone reading a flat file must understand ahead of time exactly how the file is
structured. In general, all flat files fall into two types: delimited and fixed length.
Delimited files are those in which fields are separated by a delimiter, such as a comma.
Fixed Length files have fields that are a set length.</p>
</div>
<div class="sect3">
<h4 id="fieldSet"><a class="anchor" href="#fieldSet"></a>6.6.1. The <code>FieldSet</code></h4>
<div class="paragraph">
<p>When working with flat files in Spring Batch, regardless of whether it is for input or
output, one of the most important classes is the <code>FieldSet</code>. Many architectures and
libraries contain abstractions for helping you read in from a file, but they usually
return a <code>String</code> or an array of <code>String</code> objects. This really only gets you halfway
there. A <code>FieldSet</code> is Spring Batch&#8217;s abstraction for enabling the binding of fields from
a file resource. It allows developers to work with file input in much the same way as
they would work with database input. A <code>FieldSet</code> is conceptually similar to a JDBC
<code>ResultSet</code>. A <code>FieldSet</code> requires only one argument: a <code>String</code> array of tokens.
Optionally, you can also configure the names of the fields so that the fields may be
accessed either by index or name as patterned after <code>ResultSet</code>, as shown in the following
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span><span class="type">[]</span> tokens = <span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span>{<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>};
FieldSet fs = <span class="keyword">new</span> DefaultFieldSet(tokens);
<span class="predefined-type">String</span> name = fs.readString(<span class="integer">0</span>);
<span class="type">int</span> value = fs.readInt(<span class="integer">1</span>);
<span class="type">boolean</span> booleanValue = fs.readBoolean(<span class="integer">2</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are many more options on the <code>FieldSet</code> interface, such as <code>Date</code>, long,
<code>BigDecimal</code>, and so on. The biggest advantage of the <code>FieldSet</code> is that it provides
consistent parsing of flat file input. Rather than each batch job parsing differently in
potentially unexpected ways, it can be consistent, both when handling errors caused by a
format exception, or when doing simple data conversions.</p>
</div>
</div>
<div class="sect3">
<h4 id="flatFileItemReader"><a class="anchor" href="#flatFileItemReader"></a>6.6.2. <code>FlatFileItemReader</code></h4>
<div class="paragraph">
<p>A flat file is any type of file that contains at most two-dimensional (tabular) data.
Reading flat files in the Spring Batch framework is facilitated by the class called
<code>FlatFileItemReader</code>, which provides basic functionality for reading and parsing flat
files. The two most important required dependencies of <code>FlatFileItemReader</code> are
<code>Resource</code> and <code>LineMapper</code>. The <code>LineMapper</code> interface is explored more in the next
sections. The resource property represents a Spring Core <code>Resource</code>. Documentation
explaining how to create beans of this type can be found in
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#resources">Spring
Framework, Chapter 5. Resources</a>. Therefore, this guide does not go into the details of
creating <code>Resource</code> objects beyond showing the following simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Resource resource = <span class="keyword">new</span> FileSystemResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">resources/trades.csv</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In complex batch environments, the directory structures are often managed by the EAI
infrastructure, where drop zones for external interfaces are established for moving files
from FTP locations to batch processing locations and vice versa. File moving utilities
are beyond the scope of the Spring Batch architecture, but it is not unusual for batch
job streams to include file moving utilities as steps in the job stream. The batch
architecture only needs to know how to locate the files to be processed. Spring Batch
begins the process of feeding the data into the pipe from this starting point. However,
<a href="https://projects.spring.io/spring-integration/">Spring Integration</a> provides many
of these types of services.</p>
</div>
<div class="paragraph">
<p>The other properties in <code>FlatFileItemReader</code> let you further specify how your data is
interpreted, as described in the following table:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 15. <code>FlatFileItemReader</code> Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">comments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String[]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies line prefixes that indicate comment rows.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies what text encoding to use. The default is the value of <code>Charset.defaultCharset()</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LineMapper</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a <code>String</code> to an <code>Object</code> representing the item.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">linesToSkip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of lines to ignore at the top of the file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recordSeparatorPolicy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RecordSeparatorPolicy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used to determine where the line endings are
and do things like continue over a line ending if inside a quoted string.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Resource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The resource from which to read.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">skippedLinesCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LineCallbackHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface that passes the raw line content of
the lines in the file to be skipped. If <code>linesToSkip</code> is set to 2, then this interface is
called twice.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In strict mode, the reader throws an exception on <code>ExecutionContext</code> if
the input resource does not exist. Otherwise, it logs the problem and continues.</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="lineMapper"><a class="anchor" href="#lineMapper"></a><code>LineMapper</code></h5>
<div class="paragraph">
<p>As with <code>RowMapper</code>, which takes a low-level construct such as <code>ResultSet</code> and returns
an <code>Object</code>, flat file processing requires the same construct to convert a <code>String</code> line
into an <code>Object</code>, as shown in the following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">LineMapper</span>&lt;T&gt; {

    T mapLine(<span class="predefined-type">String</span> line, <span class="type">int</span> lineNumber) <span class="directive">throws</span> <span class="exception">Exception</span>;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The basic contract is that, given the current line and the line number with which it is
associated, the mapper should return a resulting domain object. This is similar to
<code>RowMapper</code>, in that each line is associated with its line number, just as each row in a
<code>ResultSet</code> is tied to its row number. This allows the line number to be tied to the
resulting domain object for identity comparison or for more informative logging. However,
unlike <code>RowMapper</code>, the <code>LineMapper</code> is given a raw line which, as discussed above, only
gets you halfway there. The line must be tokenized into a <code>FieldSet</code>, which can then be
mapped to an object, as described later in this document.</p>
</div>
</div>
<div class="sect4">
<h5 id="lineTokenizer"><a class="anchor" href="#lineTokenizer"></a><code>LineTokenizer</code></h5>
<div class="paragraph">
<p>An abstraction for turning a line of input into a <code>FieldSet</code> is necessary because there
can be many formats of flat file data that need to be converted to a <code>FieldSet</code>. In
Spring Batch, this interface is the <code>LineTokenizer</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">LineTokenizer</span> {

    FieldSet tokenize(<span class="predefined-type">String</span> line);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The contract of a <code>LineTokenizer</code> is such that, given a line of input (in theory the
<code>String</code> could encompass more than one line), a <code>FieldSet</code> representing the line is
returned. This <code>FieldSet</code> can then be passed to a <code>FieldSetMapper</code>. Spring Batch contains
the following <code>LineTokenizer</code> implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DelimitedLineTokenizer</code>: Used for files where fields in a record are separated by a
delimiter. The most common delimiter is a comma, but pipes or semicolons are often used
as well.</p>
</li>
<li>
<p><code>FixedLengthTokenizer</code>: Used for files where fields in a record are each a "fixed
width". The width of each field must be defined for each record type.</p>
</li>
<li>
<p><code>PatternMatchingCompositeLineTokenizer</code>: Determines which <code>LineTokenizer</code> among a list of
tokenizers should be used on a particular line by checking against a pattern.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="fieldSetMapper"><a class="anchor" href="#fieldSetMapper"></a><code>FieldSetMapper</code></h5>
<div class="paragraph">
<p>The <code>FieldSetMapper</code> interface defines a single method, <code>mapFieldSet</code>, which takes a
<code>FieldSet</code> object and maps its contents to an object. This object may be a custom DTO, a
domain object, or an array, depending on the needs of the job. The <code>FieldSetMapper</code> is
used in conjunction with the <code>LineTokenizer</code> to translate a line of data from a resource
into an object of the desired type, as shown in the following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">FieldSetMapper</span>&lt;T&gt; {

    T mapFieldSet(FieldSet fieldSet) <span class="directive">throws</span> <span class="exception">BindException</span>;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The pattern used is the same as the <code>RowMapper</code> used by <code>JdbcTemplate</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="defaultLineMapper"><a class="anchor" href="#defaultLineMapper"></a><code>DefaultLineMapper</code></h5>
<div class="paragraph">
<p>Now that the basic interfaces for reading in flat files have been defined, it becomes
clear that three basic steps are required:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read one line from the file.</p>
</li>
<li>
<p>Pass the <code>String</code> line into the <code>LineTokenizer#tokenize()</code> method to retrieve a
<code>FieldSet</code>.</p>
</li>
<li>
<p>Pass the <code>FieldSet</code> returned from tokenizing to a <code>FieldSetMapper</code>, returning the
result from the <code>ItemReader#read()</code> method.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The two interfaces described above represent two separate tasks: converting a line into a
<code>FieldSet</code> and mapping a <code>FieldSet</code> to a domain object. Because the input of a
<code>LineTokenizer</code> matches the input of the <code>LineMapper</code> (a line), and the output of a
<code>FieldSetMapper</code> matches the output of the <code>LineMapper</code>, a default implementation that
uses both a <code>LineTokenizer</code> and a <code>FieldSetMapper</code> is provided. The <code>DefaultLineMapper</code>,
shown in the following class definition, represents the behavior most users need:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DefaultLineMapper</span>&lt;T&gt; <span class="directive">implements</span> LineMapper&lt;&gt;, InitializingBean {

    <span class="directive">private</span> LineTokenizer tokenizer;

    <span class="directive">private</span> FieldSetMapper&lt;T&gt; fieldSetMapper;

    <span class="directive">public</span> T mapLine(<span class="predefined-type">String</span> line, <span class="type">int</span> lineNumber) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">return</span> fieldSetMapper.mapFieldSet(tokenizer.tokenize(line));
    }

    <span class="directive">public</span> <span class="type">void</span> setLineTokenizer(LineTokenizer tokenizer) {
        <span class="local-variable">this</span>.tokenizer = tokenizer;
    }

    <span class="directive">public</span> <span class="type">void</span> setFieldSetMapper(FieldSetMapper&lt;T&gt; fieldSetMapper) {
        <span class="local-variable">this</span>.fieldSetMapper = fieldSetMapper;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above functionality is provided in a default implementation, rather than being built
into the reader itself (as was done in previous versions of the framework) to allow users
greater flexibility in controlling the parsing process, especially if access to the raw
line is needed.</p>
</div>
</div>
<div class="sect4">
<h5 id="simpleDelimitedFileReadingExample"><a class="anchor" href="#simpleDelimitedFileReadingExample"></a>Simple Delimited File Reading Example</h5>
<div class="paragraph">
<p>The following example illustrates how to read a flat file with an actual domain scenario.
This particular batch job reads in football players from the following file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ID,lastName,firstName,position,birthYear,debutYear
"AbduKa00,Abdul-Jabbar,Karim,rb,1974,1996",
"AbduRa00,Abdullah,Rabih,rb,1975,1999",
"AberWa00,Abercrombie,Walter,rb,1959,1982",
"AbraDa00,Abramowicz,Danny,wr,1945,1967",
"AdamBo00,Adams,Bob,te,1946,1969",
"AdamCh00,Adams,Charlie,wr,1979,2003"</pre>
</div>
</div>
<div class="paragraph">
<p>The contents of this file are mapped to the following
<code>Player</code> domain object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Player</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> ID;
    <span class="directive">private</span> <span class="predefined-type">String</span> lastName;
    <span class="directive">private</span> <span class="predefined-type">String</span> firstName;
    <span class="directive">private</span> <span class="predefined-type">String</span> position;
    <span class="directive">private</span> <span class="type">int</span> birthYear;
    <span class="directive">private</span> <span class="type">int</span> debutYear;

    <span class="directive">public</span> <span class="predefined-type">String</span> toString() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">PLAYER:ID=</span><span class="delimiter">&quot;</span></span> + ID + <span class="string"><span class="delimiter">&quot;</span><span class="content">,Last Name=</span><span class="delimiter">&quot;</span></span> + lastName +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">,First Name=</span><span class="delimiter">&quot;</span></span> + firstName + <span class="string"><span class="delimiter">&quot;</span><span class="content">,Position=</span><span class="delimiter">&quot;</span></span> + position +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">,Birth Year=</span><span class="delimiter">&quot;</span></span> + birthYear + <span class="string"><span class="delimiter">&quot;</span><span class="content">,DebutYear=</span><span class="delimiter">&quot;</span></span> +
            debutYear;
    }

    <span class="comment">// setters and getters...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To map a <code>FieldSet</code> into a <code>Player</code> object, a <code>FieldSetMapper</code> that returns players needs
to be defined, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">protected</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">PlayerFieldSetMapper</span> <span class="directive">implements</span> FieldSetMapper&lt;Player&gt; {
    <span class="directive">public</span> Player mapFieldSet(FieldSet fieldSet) {
        Player player = <span class="keyword">new</span> Player();

        player.setID(fieldSet.readString(<span class="integer">0</span>));
        player.setLastName(fieldSet.readString(<span class="integer">1</span>));
        player.setFirstName(fieldSet.readString(<span class="integer">2</span>));
        player.setPosition(fieldSet.readString(<span class="integer">3</span>));
        player.setBirthYear(fieldSet.readInt(<span class="integer">4</span>));
        player.setDebutYear(fieldSet.readInt(<span class="integer">5</span>));

        <span class="keyword">return</span> player;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file can then be read by correctly constructing a <code>FlatFileItemReader</code> and calling
<code>read</code>, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">FlatFileItemReader&lt;Player&gt; itemReader = <span class="keyword">new</span> FlatFileItemReader&lt;Player&gt;();
itemReader.setResource(<span class="keyword">new</span> FileSystemResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">resources/players.csv</span><span class="delimiter">&quot;</span></span>));
<span class="comment">//DelimitedLineTokenizer defaults to comma as its delimiter</span>
DefaultLineMapper&lt;Player&gt; lineMapper = <span class="keyword">new</span> DefaultLineMapper&lt;Player&gt;();
lineMapper.setLineTokenizer(<span class="keyword">new</span> DelimitedLineTokenizer());
lineMapper.setFieldSetMapper(<span class="keyword">new</span> PlayerFieldSetMapper());
itemReader.setLineMapper(lineMapper);
itemReader.open(<span class="keyword">new</span> ExecutionContext());
Player player = itemReader.read();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each call to <code>read</code> returns a new
        <code>Player</code> object from each line in the file. When the end of the file is
        reached, <code>null</code> is returned.</p>
</div>
</div>
<div class="sect4">
<h5 id="mappingFieldsByName"><a class="anchor" href="#mappingFieldsByName"></a>Mapping Fields by Name</h5>
<div class="paragraph">
<p>There is one additional piece of functionality that is allowed by both
<code>DelimitedLineTokenizer</code> and <code>FixedLengthTokenizer</code> and that is similar in function to a
JDBC <code>ResultSet</code>. The names of the fields can be injected into either of these
<code>LineTokenizer</code> implementations to increase the readability of the mapping function.
First, the column names of all fields in the flat file are injected into the tokenizer,
as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tokenizer.setNames(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">ID</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">position</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">birthYear</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">debutYear</span><span class="delimiter">&quot;</span></span>});</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>FieldSetMapper</code> can use this information as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PlayerMapper</span> <span class="directive">implements</span> FieldSetMapper&lt;Player&gt; {
    <span class="directive">public</span> Player mapFieldSet(FieldSet fs) {

       <span class="keyword">if</span>(fs == <span class="predefined-constant">null</span>){
           <span class="keyword">return</span> <span class="predefined-constant">null</span>;
       }

       Player player = <span class="keyword">new</span> Player();
       player.setID(fs.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID</span><span class="delimiter">&quot;</span></span>));
       player.setLastName(fs.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>));
       player.setFirstName(fs.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>));
       player.setPosition(fs.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">position</span><span class="delimiter">&quot;</span></span>));
       player.setDebutYear(fs.readInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">debutYear</span><span class="delimiter">&quot;</span></span>));
       player.setBirthYear(fs.readInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">birthYear</span><span class="delimiter">&quot;</span></span>));

       <span class="keyword">return</span> player;
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="beanWrapperFieldSetMapper"><a class="anchor" href="#beanWrapperFieldSetMapper"></a>Automapping FieldSets to Domain Objects</h5>
<div class="paragraph">
<p>For many, having to write a specific <code>FieldSetMapper</code> is equally as cumbersome as writing
a specific <code>RowMapper</code> for a <code>JdbcTemplate</code>. Spring Batch makes this easier by providing
a <code>FieldSetMapper</code> that automatically maps fields by matching a field name with a setter
on the object using the JavaBean specification. Again using the football example, the
<code>BeanWrapperFieldSetMapper</code> configuration looks like the following snippet:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">prototypeBeanName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">player</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">player</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.sample.domain.Player</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">prototype</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> FieldSetMapper fieldSetMapper() {
        BeanWrapperFieldSetMapper fieldSetMapper = <span class="keyword">new</span> BeanWrapperFieldSetMapper();

        fieldSetMapper.setPrototypeBeanName(<span class="string"><span class="delimiter">&quot;</span><span class="content">player</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> fieldSetMapper;
}

<span class="annotation">@Bean</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">prototype</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> Player player() {
        <span class="keyword">return</span> <span class="keyword">new</span> Player();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For each entry in the <code>FieldSet</code>, the mapper looks for a corresponding setter on a new
instance of the <code>Player</code> object (for this reason, prototype scope is required) in the
same way the Spring container looks for setters matching a property name. Each available
field in the <code>FieldSet</code> is mapped, and the resultant <code>Player</code> object is returned, with no
code required.</p>
</div>
</div>
<div class="sect4">
<h5 id="fixedLengthFileFormats"><a class="anchor" href="#fixedLengthFileFormats"></a>Fixed Length File Formats</h5>
<div class="paragraph">
<p>So far, only delimited files have been discussed in much detail. However, they represent
only half of the file reading picture. Many organizations that use flat files use fixed
length formats. An example fixed length file follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>UK21341EAH4121131.11customer1
UK21341EAH4221232.11customer2
UK21341EAH4321333.11customer3
UK21341EAH4421434.11customer4
UK21341EAH4521535.11customer5</pre>
</div>
</div>
<div class="paragraph">
<p>While this looks like one large field, it actually represent 4 distinct fields:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ISIN: Unique identifier for the item being ordered - 12 characters long.</p>
</li>
<li>
<p>Quantity: Number of the item being ordered - 3 characters long.</p>
</li>
<li>
<p>Price: Price of the item - 5 characters long.</p>
</li>
<li>
<p>Customer: ID of the customer ordering the item - 9 characters long.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When configuring the <code>FixedLengthLineTokenizer</code>, each of these lengths must be provided
in the form of ranges, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fixedLengthLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.io.file.transform.FixedLengthTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">names</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISIN,Quantity,Price,Customer</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">columns</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1-12, 13-15, 16-20, 21-29</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph xmlContent">
<p>Because the <code>FixedLengthLineTokenizer</code> uses the same <code>LineTokenizer</code> interface as
discussed above, it returns the same <code>FieldSet</code> as if a delimiter had been used. This
allows the same approaches to be used in handling its output, such as using the
<code>BeanWrapperFieldSetMapper</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Supporting the above syntax for ranges requires that a specialized property editor,
<code>RangeArrayPropertyEditor</code>, be configured in the <code>ApplicationContext</code>. However, this bean
is automatically declared in an <code>ApplicationContext</code> where the batch namespace is used.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> FixedLengthTokenizer fixedLengthTokenizer() {
        FixedLengthTokenizer tokenizer = <span class="keyword">new</span> FixedLengthTokenizer();

        tokenizer.setNames(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISIN</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Quantity</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Price</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>);
        tokenizer.setColumns(<span class="keyword">new</span> Range(<span class="integer">1</span>-<span class="integer">12</span>),
                                                <span class="keyword">new</span> Range(<span class="integer">13</span>-<span class="integer">15</span>),
                                                <span class="keyword">new</span> Range(<span class="integer">16</span>-<span class="integer">20</span>),
                                                <span class="keyword">new</span> Range(<span class="integer">21</span>-<span class="integer">29</span>));

        <span class="keyword">return</span> tokenizer;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the <code>FixedLengthLineTokenizer</code> uses the same <code>LineTokenizer</code> interface as
discussed above, it returns the same <code>FieldSet</code> as if a delimiter had been used. This
lets the same approaches be used in handling its output, such as using the
<code>BeanWrapperFieldSetMapper</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="prefixMatchingLineMapper"><a class="anchor" href="#prefixMatchingLineMapper"></a>Multiple Record Types within a Single File</h5>
<div class="paragraph">
<p>All of the file reading examples up to this point have all made a key assumption for
simplicity&#8217;s sake: all of the records in a file have the same format. However, this may
not always be the case. It is very common that a file might have records with different
formats that need to be tokenized differently and mapped to different objects. The
following excerpt from a file illustrates this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>USER;Smith;Peter;;T;20014539;F
LINEA;1044391041ABC037.49G201XX1383.12H
LINEB;2134776319DEF422.99M005LI</pre>
</div>
</div>
<div class="paragraph">
<p>In this file we have three types of records, "USER", "LINEA", and "LINEB". A "USER" line
corresponds to a <code>User</code> object. "LINEA" and "LINEB" both correspond to <code>Line</code> objects,
though a "LINEA" has more information than a "LINEB".</p>
</div>
<div class="paragraph">
<p>The <code>ItemReader</code> reads each line individually, but we must specify different
<code>LineTokenizer</code> and <code>FieldSetMapper</code> objects so that the <code>ItemWriter</code> receives the
correct items. The <code>PatternMatchingCompositeLineMapper</code> makes this easy by allowing maps
of patterns to <code>LineTokenizer</code> instances and patterns to <code>FieldSetMapper</code> instances to be
configured, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">orderFileLineMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...PatternMatchingCompositeLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tokenizers</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">USER*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">userTokenizer</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LINEA*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineATokenizer</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LINEB*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineBTokenizer</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMappers</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">USER*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">userFieldSetMapper</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LINE*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineFieldSetMapper</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> PatternMatchingCompositeLineMapper orderFileLineMapper() {
        PatternMatchingCompositeLineMapper lineMapper =
                <span class="keyword">new</span> PatternMatchingCompositeLineMapper();

        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, LineTokenizer&gt; tokenizers = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;(<span class="integer">3</span>);
        tokenizers.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">USER*</span><span class="delimiter">&quot;</span></span>, userTokenizer());
        tokenizers.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">LINEA*</span><span class="delimiter">&quot;</span></span>, lineATokenizer());
        tokenizers.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">LINEB*</span><span class="delimiter">&quot;</span></span>, lineBTokenizer());

        lineMapper.setTokenizers(tokenizers);

        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, FieldSetMapper&gt; mappers = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;(<span class="integer">2</span>);
        mappers.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">USER*</span><span class="delimiter">&quot;</span></span>, userFieldSetMapper());
        mappers.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">LINE*</span><span class="delimiter">&quot;</span></span>, lineFieldSetMapper());

        lineMapper.setFieldSetMappers(mappers);

        <span class="keyword">return</span> lineMapper;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, "LINEA" and "LINEB" have separate <code>LineTokenizer</code> instances, but they both use
the same <code>FieldSetMapper</code>.</p>
</div>
<div class="paragraph">
<p>The <code>PatternMatchingCompositeLineMapper</code> uses the <code>PatternMatcher#match</code> method
in order to select the correct delegate for each line. The <code>PatternMatcher</code> allows for
two wildcard characters with special meaning: the question mark ("?") matches exactly one
character, while the asterisk ("*") matches zero or more characters. Note that, in the
preceding configuration, all patterns end with an asterisk, making them effectively
prefixes  to lines. The <code>PatternMatcher</code> always matches the most specific pattern
possible, regardless of the order in the configuration. So if "LINE*" and "LINEA*" were
both listed as patterns, "LINEA" would match pattern "LINEA*", while "LINEB" would match
pattern "LINE*". Additionally, a single asterisk ("*") can serve as a default by matching
any line not matched by any other pattern, as shown in the following example.</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultLineTokenizer</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
tokenizers.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, defaultLineTokenizer());
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also a <code>PatternMatchingCompositeLineTokenizer</code> that can be used for tokenization
alone.</p>
</div>
<div class="paragraph">
<p>It is also common for a flat file to contain records that each span multiple lines. To
handle this situation, a more complex strategy is required. A demonstration of this
common pattern can be found in the <code>multiLineRecords</code> sample.</p>
</div>
</div>
<div class="sect4">
<h5 id="exceptionHandlingInFlatFiles"><a class="anchor" href="#exceptionHandlingInFlatFiles"></a>Exception Handling in Flat Files</h5>
<div class="paragraph">
<p>There are many scenarios when tokenizing a line may cause exceptions to be thrown. Many
flat files are imperfect and contain incorrectly formatted records. Many users choose to
skip these erroneous lines while logging the issue, the original line, and the line
number. These logs can later be inspected manually or by another batch job. For this
reason, Spring Batch provides a hierarchy of exceptions for handling parse exceptions:
<code>FlatFileParseException</code> and <code>FlatFileFormatException</code>. <code>FlatFileParseException</code> is
thrown by the <code>FlatFileItemReader</code> when any errors are encountered while trying to read a
file. <code>FlatFileFormatException</code> is thrown by implementations of the <code>LineTokenizer</code>
interface and indicates a more specific error encountered while tokenizing.</p>
</div>
<div class="sect5">
<h6 id="incorrectTokenCountException"><a class="anchor" href="#incorrectTokenCountException"></a><code>IncorrectTokenCountException</code></h6>
<div class="paragraph">
<p>Both <code>DelimitedLineTokenizer</code> and <code>FixedLengthLineTokenizer</code> have the ability to specify
column names that can be used for creating a <code>FieldSet</code>. However, if the number of column
names does not match the number of columns found while tokenizing a line, the <code>FieldSet</code>
cannot be created, and an <code>IncorrectTokenCountException</code> is thrown, which contains the
number of tokens encountered, and the number expected, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tokenizer.setNames(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">C</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>});

<span class="keyword">try</span> {
    tokenizer.tokenize(<span class="string"><span class="delimiter">&quot;</span><span class="content">a,b,c</span><span class="delimiter">&quot;</span></span>);
}
<span class="keyword">catch</span>(IncorrectTokenCountException e){
    assertEquals(<span class="integer">4</span>, e.getExpectedCount());
    assertEquals(<span class="integer">3</span>, e.getActualCount());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the tokenizer was configured with 4 column names but only 3 tokens were found in
the file, an <code>IncorrectTokenCountException</code> was thrown.</p>
</div>
</div>
<div class="sect5">
<h6 id="incorrectLineLengthException"><a class="anchor" href="#incorrectLineLengthException"></a><code>IncorrectLineLengthException</code></h6>
<div class="paragraph">
<p>Files formatted in a fixed-length format have additional requirements when parsing
because, unlike a delimited format, each column must strictly adhere to its predefined
width. If the total line length does not equal the widest value of this column, an
exception is thrown, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tokenizer.setColumns(<span class="keyword">new</span> Range<span class="type">[]</span> { <span class="keyword">new</span> Range(<span class="integer">1</span>, <span class="integer">5</span>),
                                   <span class="keyword">new</span> Range(<span class="integer">6</span>, <span class="integer">10</span>),
                                   <span class="keyword">new</span> Range(<span class="integer">11</span>, <span class="integer">15</span>) });
<span class="keyword">try</span> {
    tokenizer.tokenize(<span class="string"><span class="delimiter">&quot;</span><span class="content">12345</span><span class="delimiter">&quot;</span></span>);
    fail(<span class="string"><span class="delimiter">&quot;</span><span class="content">Expected IncorrectLineLengthException</span><span class="delimiter">&quot;</span></span>);
}
<span class="keyword">catch</span> (IncorrectLineLengthException ex) {
    assertEquals(<span class="integer">15</span>, ex.getExpectedLength());
    assertEquals(<span class="integer">5</span>, ex.getActualLength());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configured ranges for the tokenizer above are: 1-5, 6-10, and 11-15. Consequently,
the total length of the line is 15. However, in the preceding example, a line of length 5
was passed in, causing an <code>IncorrectLineLengthException</code> to be thrown. Throwing an
exception here rather than only mapping the first column allows the processing of the
line to fail earlier and with more information than it would contain if it failed while
trying to read in column 2 in a <code>FieldSetMapper</code>. However, there are scenarios where the
length of the line is not always constant. For this reason, validation of line length can
be turned off via the 'strict' property, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tokenizer.setColumns(<span class="keyword">new</span> Range<span class="type">[]</span> { <span class="keyword">new</span> Range(<span class="integer">1</span>, <span class="integer">5</span>), <span class="keyword">new</span> Range(<span class="integer">6</span>, <span class="integer">10</span>) });
tokenizer.setStrict(<span class="predefined-constant">false</span>);
FieldSet tokens = tokenizer.tokenize(<span class="string"><span class="delimiter">&quot;</span><span class="content">12345</span><span class="delimiter">&quot;</span></span>);
assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">12345</span><span class="delimiter">&quot;</span></span>, tokens.readString(<span class="integer">0</span>));
assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>, tokens.readString(<span class="integer">1</span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding example is almost identical to the one before it, except that
<code>tokenizer.setStrict(false)</code> was called. This setting tells the tokenizer to not enforce
line lengths when tokenizing the line. A <code>FieldSet</code> is now correctly created and
returned. However, it contains only empty tokens for the remaining values.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="flatFileItemWriter"><a class="anchor" href="#flatFileItemWriter"></a>6.6.3. <code>FlatFileItemWriter</code></h4>
<div class="paragraph">
<p>Writing out to flat files has the same problems and issues that reading in from a file
must overcome. A step must be able to write either delimited or fixed length formats in a
transactional manner.</p>
</div>
<div class="sect4">
<h5 id="lineAggregator"><a class="anchor" href="#lineAggregator"></a><code>LineAggregator</code></h5>
<div class="paragraph">
<p>Just as the <code>LineTokenizer</code> interface is necessary to take an item and turn it into a
<code>String</code>, file writing must have a way to aggregate multiple fields into a single string
for writing to a file. In Spring Batch, this is the <code>LineAggregator</code>, shown in the
following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">LineAggregator</span>&lt;T&gt; {

    <span class="directive">public</span> <span class="predefined-type">String</span> aggregate(T item);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>LineAggregator</code> is the logical opposite of <code>LineTokenizer</code>.  <code>LineTokenizer</code> takes a
<code>String</code> and returns a <code>FieldSet</code>, whereas <code>LineAggregator</code> takes an <code>item</code> and returns a
<code>String</code>.</p>
</div>
<div class="sect5">
<h6 id="PassThroughLineAggregator"><a class="anchor" href="#PassThroughLineAggregator"></a><code>PassThroughLineAggregator</code></h6>
<div class="paragraph">
<p>The most basic implementation of the <code>LineAggregator</code> interface is the
<code>PassThroughLineAggregator</code>, which assumes that the object is already a string or that
its string representation is acceptable for writing, as shown in the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PassThroughLineAggregator</span>&lt;T&gt; <span class="directive">implements</span> LineAggregator&lt;T&gt; {

    <span class="directive">public</span> <span class="predefined-type">String</span> aggregate(T item) {
        <span class="keyword">return</span> item.toString();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding implementation is useful if direct control of creating the string is
required but the advantages of a <code>FlatFileItemWriter</code>, such as transaction and restart
support, are necessary.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="SimplifiedFileWritingExample"><a class="anchor" href="#SimplifiedFileWritingExample"></a>Simplified File Writing Example</h5>
<div class="paragraph">
<p>Now that the <code>LineAggregator</code> interface and its most basic implementation,
<code>PassThroughLineAggregator</code>, have been defined, the basic flow of writing can be
explained:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The object to be written is passed to the <code>LineAggregator</code> in order to obtain a
<code>String</code>.</p>
</li>
<li>
<p>The returned <code>String</code> is written to the configured file.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following excerpt from the <code>FlatFileItemWriter</code> expresses this in code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> write(T item) <span class="directive">throws</span> <span class="exception">Exception</span> {
    write(lineAggregator.aggregate(item) + LINE_SEPARATOR);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A simple configuration might look like the following:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...FlatFileItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:target/test-outputs/output.txt</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...PassThroughLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemWriter itemWriter() {
        <span class="keyword">return</span>  <span class="keyword">new</span> FlatFileItemWriterBuilder&lt;Foo&gt;()
                                   .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span>)
                                   .resource(<span class="keyword">new</span> FileSystemResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">target/test-outputs/output.txt</span><span class="delimiter">&quot;</span></span>))
                                   .lineAggregator(<span class="keyword">new</span> PassThroughLineAggregator&lt;&gt;())
                                   .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="FieldExtractor"><a class="anchor" href="#FieldExtractor"></a><code>FieldExtractor</code></h5>
<div class="paragraph">
<p>The preceding example may be useful for the most basic uses of a writing to a file.
However, most users of the <code>FlatFileItemWriter</code> have a domain object that needs to be
written out and, thus, must be converted into a line. In file reading, the following was
required:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read one line from the file.</p>
</li>
<li>
<p>Pass the line into the <code>LineTokenizer#tokenize()</code> method, in order to retrieve a
<code>FieldSet</code>.</p>
</li>
<li>
<p>Pass the <code>FieldSet</code> returned from tokenizing to a <code>FieldSetMapper</code>, returning the
result from the <code>ItemReader#read()</code> method.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>File writing has similar but inverse steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pass the item to be written to the writer.</p>
</li>
<li>
<p>Convert the fields on the item into an array.</p>
</li>
<li>
<p>Aggregate the resulting array into a line.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Because there is no way for the framework to know which fields from the object need to
be written out, a <code>FieldExtractor</code> must be written to accomplish the task of turning the
item into an array, as shown in the following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">FieldExtractor</span>&lt;T&gt; {

    <span class="predefined-type">Object</span><span class="type">[]</span> extract(T item);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementations of the <code>FieldExtractor</code> interface should create an array from the fields
of the provided object, which can then be written out with a delimiter between the
elements or as part of a fixed-width line.</p>
</div>
<div class="sect5">
<h6 id="PassThroughFieldExtractor"><a class="anchor" href="#PassThroughFieldExtractor"></a><code>PassThroughFieldExtractor</code></h6>
<div class="paragraph">
<p>There are many cases where a collection, such as an array, <code>Collection</code>, or <code>FieldSet</code>,
needs to be written out. "Extracting" an array from one of these collection types is very
straightforward. To do so, convert the collection to an array. Therefore, the
<code>PassThroughFieldExtractor</code> should be used in this scenario. It should be noted that, if
the object passed in is not a type of collection, then the <code>PassThroughFieldExtractor</code>
returns an array containing solely the item to be extracted.</p>
</div>
</div>
<div class="sect5">
<h6 id="BeanWrapperFieldExtractor"><a class="anchor" href="#BeanWrapperFieldExtractor"></a><code>BeanWrapperFieldExtractor</code></h6>
<div class="paragraph">
<p>As with the <code>BeanWrapperFieldSetMapper</code> described in the file reading section, it is
often preferable to configure how to convert a domain object to an object array, rather
than writing the conversion yourself. The <code>BeanWrapperFieldExtractor</code> provides this
functionality, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">BeanWrapperFieldExtractor&lt;<span class="predefined-type">Name</span>&gt; extractor = <span class="keyword">new</span> BeanWrapperFieldExtractor&lt;<span class="predefined-type">Name</span>&gt;();
extractor.setNames(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> { <span class="string"><span class="delimiter">&quot;</span><span class="content">first</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">last</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">born</span><span class="delimiter">&quot;</span></span> });

<span class="predefined-type">String</span> first = <span class="string"><span class="delimiter">&quot;</span><span class="content">Alan</span><span class="delimiter">&quot;</span></span>;
<span class="predefined-type">String</span> last = <span class="string"><span class="delimiter">&quot;</span><span class="content">Turing</span><span class="delimiter">&quot;</span></span>;
<span class="type">int</span> born = <span class="integer">1912</span>;

<span class="predefined-type">Name</span> n = <span class="keyword">new</span> <span class="predefined-type">Name</span>(first, last, born);
<span class="predefined-type">Object</span><span class="type">[]</span> values = extractor.extract(n);

assertEquals(first, values[<span class="integer">0</span>]);
assertEquals(last, values[<span class="integer">1</span>]);
assertEquals(born, values[<span class="integer">2</span>]);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This extractor implementation has only one required property: the names of the fields to
map. Just as the <code>BeanWrapperFieldSetMapper</code> needs field names to map fields on the
<code>FieldSet</code> to setters on the provided object, the <code>BeanWrapperFieldExtractor</code> needs names
to map to getters for creating an object array. It is worth noting that the order of the
names determines the order of the fields within the array.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="delimitedFileWritingExample"><a class="anchor" href="#delimitedFileWritingExample"></a>Delimited File Writing Example</h5>
<div class="paragraph">
<p>The most basic flat file format is one in which all fields are separated by a delimiter.
This can be accomplished using a <code>DelimitedLineAggregator</code>. The following example writes
out a simple domain object that represents a credit to a customer account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerCredit</span> {

    <span class="directive">private</span> <span class="type">int</span> id;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> credit;

    <span class="comment">//getters and setters removed for clarity</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because a domain object is being used, an implementation of the <code>FieldExtractor</code>
interface must be provided, along with the delimiter to use, as shown in the following
example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputResource</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">names</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name,credit</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/bean&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemWriter&lt;CustomerCredit&gt; itemWriter(Resource outputResource) <span class="directive">throws</span> <span class="exception">Exception</span> {
        BeanWrapperFieldExtractor&lt;CustomerCredit&gt; fieldExtractor = <span class="keyword">new</span> BeanWrapperFieldExtractor&lt;&gt;();
        fieldExtractor.setNames(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">credit</span><span class="delimiter">&quot;</span></span>});
        fieldExtractor.afterPropertiesSet();

        DelimitedLineAggregator&lt;CustomerCredit&gt; lineAggregator = <span class="keyword">new</span> DelimitedLineAggregator&lt;&gt;();
        lineAggregator.setDelimiter(<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>);
        lineAggregator.setFieldExtractor(fieldExtractor);

        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemWriterBuilder&lt;CustomerCredit&gt;()
                                .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">customerCreditWriter</span><span class="delimiter">&quot;</span></span>)
                                .resource(outputResource)
                                .lineAggregator(lineAggregator)
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the previous example, the <code>BeanWrapperFieldExtractor</code> described earlier in this
chapter is used to turn the name and credit fields within <code>CustomerCredit</code> into an object
array, which is then written out with commas between each field.</p>
</div>
<div class="paragraph">
<p>It is also possible to use the <code>FlatFileItemWriterBuilder.DelimitedBuilder</code> to
automatically create the <code>BeanWrapperFieldExtractor</code> and <code>DelimitedLineAggregator</code>
as shown in the following example:</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemWriter&lt;CustomerCredit&gt; itemWriter(Resource outputResource) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemWriterBuilder&lt;CustomerCredit&gt;()
                                .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">customerCreditWriter</span><span class="delimiter">&quot;</span></span>)
                                .resource(outputResource)
                                .delimited()
                                .delimiter(<span class="string"><span class="delimiter">&quot;</span><span class="content">|</span><span class="delimiter">&quot;</span></span>)
                                .names(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">credit</span><span class="delimiter">&quot;</span></span>})
                                .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="fixedWidthFileWritingExample"><a class="anchor" href="#fixedWidthFileWritingExample"></a>Fixed Width File Writing Example</h5>
<div class="paragraph">
<p>Delimited is not the only type of flat file format. Many prefer to use a set width for
each column to delineate between fields, which is usually referred to as 'fixed width'.
Spring Batch supports this in file writing with the <code>FormatterLineAggregator</code>. Using the
same <code>CustomerCredit</code> domain object described above, it can be configured as follows:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputResource</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...FormatterLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">names</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name,credit</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                <span class="tag">&lt;/bean&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">format</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">%-9s%-2.0f</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemWriter&lt;CustomerCredit&gt; itemWriter(Resource outputResource) <span class="directive">throws</span> <span class="exception">Exception</span> {
        BeanWrapperFieldExtractor&lt;CustomerCredit&gt; fieldExtractor = <span class="keyword">new</span> BeanWrapperFieldExtractor&lt;&gt;();
        fieldExtractor.setNames(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">credit</span><span class="delimiter">&quot;</span></span>});
        fieldExtractor.afterPropertiesSet();

        FormatterLineAggregator&lt;CustomerCredit&gt; lineAggregator = <span class="keyword">new</span> FormatterLineAggregator&lt;&gt;();
        lineAggregator.setFormat(<span class="string"><span class="delimiter">&quot;</span><span class="content">%-9s%-2.0f</span><span class="delimiter">&quot;</span></span>);
        lineAggregator.setFieldExtractor(fieldExtractor);

        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemWriterBuilder&lt;CustomerCredit&gt;()
                                .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">customerCreditWriter</span><span class="delimiter">&quot;</span></span>)
                                .resource(outputResource)
                                .lineAggregator(lineAggregator)
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of the preceding example should look familiar. However, the value of the format
property is new and is shown in the following element:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">format</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">%-9s%-2.0f</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
FormatterLineAggregator&lt;CustomerCredit&gt; lineAggregator = <span class="keyword">new</span> FormatterLineAggregator&lt;&gt;();
lineAggregator.setFormat(<span class="string"><span class="delimiter">&quot;</span><span class="content">%-9s%-2.0f</span><span class="delimiter">&quot;</span></span>);
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The underlying implementation is built using the same
<code>Formatter</code> added as part of Java 5. The Java
<code>Formatter</code> is based on the
<code>printf</code> functionality of the C programming
language. Most details on how to configure a formatter can be found in
the Javadoc of <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Formatter.html">Formatter</a>.</p>
</div>
<div class="paragraph">
<p>It is also possible to use the <code>FlatFileItemWriterBuilder.FormattedBuilder</code> to
automatically create the <code>BeanWrapperFieldExtractor</code> and <code>FormatterLineAggregator</code>
as shown in following example:</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemWriter&lt;CustomerCredit&gt; itemWriter(Resource outputResource) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemWriterBuilder&lt;CustomerCredit&gt;()
                                .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">customerCreditWriter</span><span class="delimiter">&quot;</span></span>)
                                .resource(outputResource)
                                .formatted()
                                .format(<span class="string"><span class="delimiter">&quot;</span><span class="content">%-9s%-2.0f</span><span class="delimiter">&quot;</span></span>)
                                .names(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">credit</span><span class="delimiter">&quot;</span></span>})
                                .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="handlingFileCreation"><a class="anchor" href="#handlingFileCreation"></a>Handling File Creation</h5>
<div class="paragraph">
<p><code>FlatFileItemReader</code> has a very simple relationship with file resources. When the reader
is initialized, it opens the file (if it exists), and throws an exception if it does not.
File writing isn&#8217;t quite so simple. At first glance, it seems like a similar
straightforward contract should exist for <code>FlatFileItemWriter</code>: If the file already
exists, throw an exception, and, if it does not, create it and start writing. However,
potentially restarting a <code>Job</code> can cause issues. In normal restart scenarios, the
contract is reversed: If the file exists, start writing to it from the last known good
position, and, if it does not, throw an exception. However, what happens if the file name
for this job is always the same? In this case, you would want to delete the file if it
exists, unless it&#8217;s a restart. Because of this possibility, the <code>FlatFileItemWriter</code>
contains the property, <code>shouldDeleteIfExists</code>. Setting this property to true causes an
existing file with the same name to be deleted when the writer is opened.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="xmlReadingWriting"><a class="anchor" href="#xmlReadingWriting"></a>6.7. XML Item Readers and Writers</h3>
<div class="paragraph">
<p>Spring Batch provides transactional infrastructure for both reading XML records and
mapping them to Java objects as well as writing Java objects as XML records.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Constraints on streaming XML</div>
<div class="paragraph">
<p>The StAX API is used for I/O, as other standard XML parsing APIs do not fit batch
processing requirements (DOM loads the whole input into memory at once and SAX controls
the parsing process by allowing the user to provide only callbacks).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We need to consider how XML input and output works in Spring Batch. First, there are a
few concepts that vary from file reading and writing but are common across Spring Batch
XML processing. With XML processing, instead of lines of records (<code>FieldSet</code> instances) that need
to be tokenized, it is assumed an XML resource is a collection of 'fragments'
corresponding to individual records, as shown in the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/xmlinput.png" alt="XML Input">
</div>
<div class="title">Figure 17. XML Input</div>
</div>
<div class="paragraph">
<p>The 'trade' tag is defined as the 'root element' in the scenario above. Everything
between '&lt;trade&gt;' and '&lt;/trade&gt;' is considered one 'fragment'. Spring Batch
uses Object/XML Mapping (OXM) to bind fragments to objects. However, Spring Batch is not
tied to any particular XML binding technology. Typical use is to delegate to
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#oxm">Spring OXM</a>, which
provides uniform abstraction for the most popular OXM technologies. The dependency on
Spring OXM is optional and you can choose to implement Spring Batch specific interfaces
if desired. The relationship to the technologies that OXM supports is shown in the
following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/oxm-fragments.png" alt="OXM Binding">
</div>
<div class="title">Figure 18. OXM Binding</div>
</div>
<div class="paragraph">
<p>With an introduction to OXM and how one can use XML fragments to represent records, we
can now more closely examine readers and writers.</p>
</div>
<div class="sect3">
<h4 id="StaxEventItemReader"><a class="anchor" href="#StaxEventItemReader"></a>6.7.1. <code>StaxEventItemReader</code></h4>
<div class="paragraph">
<p>The <code>StaxEventItemReader</code> configuration provides a typical setup for the processing of
records from an XML input stream. First, consider the following set of XML records that
the <code>StaxEventItemReader</code> can process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
    <span class="tag">&lt;trade</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://springframework.org/batch/sample/io/oxm/domain</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;isin&gt;</span>XYZ0001<span class="tag">&lt;/isin&gt;</span>
        <span class="tag">&lt;quantity&gt;</span>5<span class="tag">&lt;/quantity&gt;</span>
        <span class="tag">&lt;price&gt;</span>11.39<span class="tag">&lt;/price&gt;</span>
        <span class="tag">&lt;customer&gt;</span>Customer1<span class="tag">&lt;/customer&gt;</span>
    <span class="tag">&lt;/trade&gt;</span>
    <span class="tag">&lt;trade</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://springframework.org/batch/sample/io/oxm/domain</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;isin&gt;</span>XYZ0002<span class="tag">&lt;/isin&gt;</span>
        <span class="tag">&lt;quantity&gt;</span>2<span class="tag">&lt;/quantity&gt;</span>
        <span class="tag">&lt;price&gt;</span>72.99<span class="tag">&lt;/price&gt;</span>
        <span class="tag">&lt;customer&gt;</span>Customer2c<span class="tag">&lt;/customer&gt;</span>
    <span class="tag">&lt;/trade&gt;</span>
    <span class="tag">&lt;trade</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://springframework.org/batch/sample/io/oxm/domain</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;isin&gt;</span>XYZ0003<span class="tag">&lt;/isin&gt;</span>
        <span class="tag">&lt;quantity&gt;</span>9<span class="tag">&lt;/quantity&gt;</span>
        <span class="tag">&lt;price&gt;</span>99.99<span class="tag">&lt;/price&gt;</span>
        <span class="tag">&lt;customer&gt;</span>Customer3<span class="tag">&lt;/customer&gt;</span>
    <span class="tag">&lt;/trade&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To be able to process the XML records, the following is needed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Root Element Name: The name of the root element of the fragment that constitutes the
object to be mapped. The example configuration demonstrates this with the value of trade.</p>
</li>
<li>
<p>Resource: A Spring Resource that represents the file to read.</p>
</li>
<li>
<p><code>Unmarshaller</code>: An unmarshalling facility provided by Spring OXM for mapping the XML
fragment to an object.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example shows how to define a <code>StaxEventItemReader</code> that works with a root
element named <code>trade</code>, a resource of <code>org/springframework/batch/item/xml/domain/trades.xml</code>, and an unmarshaller
called <code>tradeMarshaller</code>.</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fragmentRootElementName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trade</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org/springframework/batch/item/xml/domain/trades.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unmarshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tradeMarshaller</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> StaxEventItemReader itemReader() {
        <span class="keyword">return</span> <span class="keyword">new</span> StaxEventItemReaderBuilder&lt;Trade&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span>)
                        .resource(<span class="keyword">new</span> FileSystemResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">org/springframework/batch/item/xml/domain/trades.xml</span><span class="delimiter">&quot;</span></span>))
                        .addFragmentRootElements(<span class="string"><span class="delimiter">&quot;</span><span class="content">trade</span><span class="delimiter">&quot;</span></span>)
                        .unmarshaller(tradeMarshaller())
                        .build();

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that, in this example, we have chosen to use an <code>XStreamMarshaller</code>, which accepts
an alias passed in as a map with the first key and value being the name of the fragment
(that is, a root element) and the object type to bind. Then, similar to a <code>FieldSet</code>, the
names of the other elements that map to fields within the object type are described as
key/value pairs in the map. In the configuration file, we can use a Spring configuration
utility to describe the required alias, as follows:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tradeMarshaller</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.xstream.XStreamMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">aliases</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;util:map</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">aliases</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trade</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.sample.domain.trade.Trade</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.math.BigDecimal</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">isin</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">quantity</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Long</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/util:map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> XStreamMarshaller tradeMarshaller() {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Class</span>&gt; aliases = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
        aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">trade</span><span class="delimiter">&quot;</span></span>, Trade.class);
        aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">BigDecimal</span>.class);
        aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">isin</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class);
        aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class);
        aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">quantity</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Long</span>.class);

        XStreamMarshaller marshaller = <span class="keyword">new</span> XStreamMarshaller();

        marshaller.setAliases(aliases);

        <span class="keyword">return</span> marshaller;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>On input, the reader reads the XML resource until it recognizes that a new fragment is
about to start. By default, the reader matches the element name to recognize that a new
fragment is about to start. The reader creates a standalone XML document from the
fragment and passes the document to a deserializer (typically a wrapper around a Spring
OXM <code>Unmarshaller</code>) to map the XML to a Java object.</p>
</div>
<div class="paragraph">
<p>In summary, this procedure is analogous to the following Java code, which uses the
injection provided by the Spring configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">StaxEventItemReader&lt;Trade&gt; xmlStaxEventItemReader = <span class="keyword">new</span> StaxEventItemReader&lt;&gt;();
Resource resource = <span class="keyword">new</span> ByteArrayResource(xmlResource.getBytes());

<span class="predefined-type">Map</span> aliases = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>();
aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">trade</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.sample.domain.trade.Trade</span><span class="delimiter">&quot;</span></span>);
aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">java.math.BigDecimal</span><span class="delimiter">&quot;</span></span>);
aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span>);
aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">isin</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span>);
aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">quantity</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Long</span><span class="delimiter">&quot;</span></span>);
XStreamMarshaller unmarshaller = <span class="keyword">new</span> XStreamMarshaller();
unmarshaller.setAliases(aliases);
xmlStaxEventItemReader.setUnmarshaller(unmarshaller);
xmlStaxEventItemReader.setResource(resource);
xmlStaxEventItemReader.setFragmentRootElementName(<span class="string"><span class="delimiter">&quot;</span><span class="content">trade</span><span class="delimiter">&quot;</span></span>);
xmlStaxEventItemReader.open(<span class="keyword">new</span> ExecutionContext());

<span class="type">boolean</span> hasNext = <span class="predefined-constant">true</span>;

Trade trade = <span class="predefined-constant">null</span>;

<span class="keyword">while</span> (hasNext) {
    trade = xmlStaxEventItemReader.read();
    <span class="keyword">if</span> (trade == <span class="predefined-constant">null</span>) {
        hasNext = <span class="predefined-constant">false</span>;
    }
    <span class="keyword">else</span> {
        <span class="predefined-type">System</span>.out.println(trade);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="StaxEventItemWriter"><a class="anchor" href="#StaxEventItemWriter"></a>6.7.2. <code>StaxEventItemWriter</code></h4>
<div class="paragraph">
<p>Output works symmetrically to input. The <code>StaxEventItemWriter</code> needs a <code>Resource</code>, a
marshaller, and a <code>rootTagName</code>. A Java object is passed to a marshaller (typically a
standard Spring OXM Marshaller) which writes to a <code>Resource</code> by using a custom event
writer that filters the <code>StartDocument</code> and <code>EndDocument</code> events produced for each
fragment by the OXM tools. The following example uses the
<code>StaxEventItemWriter</code>:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputResource</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tradeMarshaller</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rootTagName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trade</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">overwriteOutput</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> StaxEventItemWriter itemWriter(Resource outputResource) {
        <span class="keyword">return</span> <span class="keyword">new</span> StaxEventItemWriterBuilder&lt;Trade&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">tradesWriter</span><span class="delimiter">&quot;</span></span>)
                        .marshaller(tradeMarshaller())
                        .resource(outputResource)
                        .rootTagName(<span class="string"><span class="delimiter">&quot;</span><span class="content">trade</span><span class="delimiter">&quot;</span></span>)
                        .overwriteOutput(<span class="predefined-constant">true</span>)
                        .build();

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding configuration sets up the three required properties and sets the optional
<code>overwriteOutput=true</code> attribute, mentioned earlier in this chapter for specifying whether
an existing file can be overwritten. It should be noted the marshaller used for the
writer in the following example is the exact same as the one used in the reading example
from earlier in the chapter:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerCreditMarshaller</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.xstream.XStreamMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">aliases</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;util:map</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">aliases</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.sample.domain.trade.Trade</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.math.BigDecimal</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">isin</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">quantity</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Long</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/util:map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> XStreamMarshaller customerCreditMarshaller() {
        XStreamMarshaller marshaller = <span class="keyword">new</span> XStreamMarshaller();

        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Class</span>&gt; aliases = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
        aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">trade</span><span class="delimiter">&quot;</span></span>, Trade.class);
        aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">BigDecimal</span>.class);
        aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">isin</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class);
        aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class);
        aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">quantity</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Long</span>.class);

        marshaller.setAliases(aliases);

        <span class="keyword">return</span> marshaller;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To summarize with a Java example, the following code illustrates all of the points
discussed, demonstrating the programmatic setup of the required properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">FileSystemResource resource = <span class="keyword">new</span> FileSystemResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">data/outputFile.xml</span><span class="delimiter">&quot;</span></span>)

<span class="predefined-type">Map</span> aliases = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>();
aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">trade</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.sample.domain.trade.Trade</span><span class="delimiter">&quot;</span></span>);
aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">java.math.BigDecimal</span><span class="delimiter">&quot;</span></span>);
aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span>);
aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">isin</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span>);
aliases.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">quantity</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Long</span><span class="delimiter">&quot;</span></span>);
Marshaller marshaller = <span class="keyword">new</span> XStreamMarshaller();
marshaller.setAliases(aliases);

StaxEventItemWriter staxItemWriter =
        <span class="keyword">new</span> StaxEventItemWriterBuilder&lt;Trade&gt;()
                                .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">tradesWriter</span><span class="delimiter">&quot;</span></span>)
                                .marshaller(marshaller)
                                .resource(resource)
                                .rootTagName(<span class="string"><span class="delimiter">&quot;</span><span class="content">trade</span><span class="delimiter">&quot;</span></span>)
                                .overwriteOutput(<span class="predefined-constant">true</span>)
                                .build();

staxItemWriter.afterPropertiesSet();

ExecutionContext executionContext = <span class="keyword">new</span> ExecutionContext();
staxItemWriter.open(executionContext);
Trade trade = <span class="keyword">new</span> Trade();
trade.setPrice(<span class="float">11.39</span>);
trade.setIsin(<span class="string"><span class="delimiter">&quot;</span><span class="content">XYZ0001</span><span class="delimiter">&quot;</span></span>);
trade.setQuantity(<span class="integer">5L</span>);
trade.setCustomer(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer1</span><span class="delimiter">&quot;</span></span>);
staxItemWriter.write(trade);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jsonReadingWriting"><a class="anchor" href="#jsonReadingWriting"></a>6.8. JSON Item Readers And Writers</h3>
<div class="paragraph">
<p>Spring Batch provides support for reading and Writing JSON resources in the following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[
  {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">isin</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">quantity</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="float">1.2</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>
  },
  {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">isin</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">456</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">quantity</span><span class="delimiter">&quot;</span></span>: <span class="integer">2</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>: <span class="float">1.4</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>
  }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is assumed that the JSON resource is an array of JSON objects corresponding to
individual items. Spring Batch is not tied to any particular JSON library.</p>
</div>
<div class="sect3">
<h4 id="JsonItemReader"><a class="anchor" href="#JsonItemReader"></a>6.8.1. <code>JsonItemReader</code></h4>
<div class="paragraph">
<p>The <code>JsonItemReader</code> delegates JSON parsing and binding to implementations of the
<code>org.springframework.batch.item.json.JsonObjectReader</code> interface. This interface
is intended to be implemented by using a streaming API to read JSON objects
in chunks. Two implementations are currently provided:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/FasterXML/jackson">Jackson</a> through the <code>org.springframework.batch.item.json.JacksonJsonObjectReader</code></p>
</li>
<li>
<p><a href="https://github.com/google/gson">Gson</a> through the <code>org.springframework.batch.item.json.GsonJsonObjectReader</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To be able to process JSON records, the following is needed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Resource</code>: A Spring Resource that represents the JSON file to read.</p>
</li>
<li>
<p><code>JsonObjectReader</code>: A JSON object reader to parse and bind JSON objects to items</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example shows how to define a <code>JsonItemReader</code> that works with the
previous JSON resource <code>org/springframework/batch/item/json/trades.json</code> and a
<code>JsonObjectReader</code> based on Jackson:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> JsonItemReader&lt;Trade&gt; jsonItemReader() {
   <span class="keyword">return</span> <span class="keyword">new</span> JsonItemReaderBuilder&lt;Trade&gt;()
                 .jsonObjectReader(<span class="keyword">new</span> JacksonJsonObjectReader&lt;&gt;(Trade.class))
                 .resource(<span class="keyword">new</span> ClassPathResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">trades.json</span><span class="delimiter">&quot;</span></span>))
                 .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">tradeJsonItemReader</span><span class="delimiter">&quot;</span></span>)
                 .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="code-jsonfileitemwriter-code"><a class="anchor" href="#code-jsonfileitemwriter-code"></a>6.8.2. <code>JsonFileItemWriter</code></h4>
<div class="paragraph">
<p>The <code>JsonFileItemWriter</code> delegates the marshalling of items to the
<code>org.springframework.batch.item.json.JsonObjectMarshaller</code> interface. The contract
of this interface is to take an object and marshall it to a JSON <code>String</code>.
Two implementations are currently provided:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/FasterXML/jackson">Jackson</a> through the <code>org.springframework.batch.item.json.JacksonJsonObjectMarshaller</code></p>
</li>
<li>
<p><a href="https://github.com/google/gson">Gson</a> through the <code>org.springframework.batch.item.json.GsonJsonObjectMarshaller</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To be able to write JSON records, the following is needed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Resource</code>: A Spring <code>Resource</code> that represents the JSON file to write</p>
</li>
<li>
<p><code>JsonObjectMarshaller</code>: A JSON object marshaller to marshall objects to JSON format</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example shows how to define a <code>JsonFileItemWriter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> JsonFileItemWriter&lt;Trade&gt; jsonFileItemWriter() {
   <span class="keyword">return</span> <span class="keyword">new</span> JsonFileItemWriterBuilder&lt;Trade&gt;()
                 .jsonObjectMarshaller(<span class="keyword">new</span> JacksonJsonObjectMarshaller&lt;&gt;())
                 .resource(<span class="keyword">new</span> ClassPathResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">trades.json</span><span class="delimiter">&quot;</span></span>))
                 .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">tradeJsonFileItemWriter</span><span class="delimiter">&quot;</span></span>)
                 .build();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multiFileInput"><a class="anchor" href="#multiFileInput"></a>6.9. Multi-File Input</h3>
<div class="paragraph">
<p>It is a common requirement to process multiple files within a single <code>Step</code>. Assuming the
files all have the same formatting, the <code>MultiResourceItemReader</code> supports this type of
input for both XML and flat file processing. Consider the following files in a directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>file-1.txt  file-2.txt  ignored.txt</pre>
</div>
</div>
<div class="paragraph">
<p><code>file-1.txt</code> and <code>file-2.txt</code> are formatted the same and, for business reasons, should be
processed together. The <code>MultiResourceItemReader</code> can be used to read in both files by
using wildcards, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multiResourceReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...MultiResourceItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resources</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:data/input/file-*.txt</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegate</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> MultiResourceItemReader multiResourceReader() {
        <span class="keyword">return</span> <span class="keyword">new</span> MultiResourceItemReaderBuilder&lt;Foo&gt;()
                                        .delegate(flatFileItemReader())
                                        .resources(resources())
                                        .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The referenced delegate is a simple <code>FlatFileItemReader</code>. The above configuration reads
input from both files, handling rollback and restart scenarios. It should be noted that,
as with any <code>ItemReader</code>, adding extra input (in this case a file) could cause potential
issues when restarting. It is recommended that batch jobs work with their own individual
directories until completed successfully.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Input resources are ordered by using <code>MultiResourceItemReader#setComparator(Comparator)</code>
 to make sure resource ordering is preserved between job runs in restart scenario.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="database"><a class="anchor" href="#database"></a>6.10. Database</h3>
<div class="paragraph">
<p>Like most enterprise application styles, a database is the central storage mechanism for
batch. However, batch differs from other application styles due to the sheer size of the
datasets with which the system must work. If a SQL statement returns 1 million rows, the
result set probably holds all returned results in memory until all rows have been read.
Spring Batch provides two types of solutions for this problem:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#cursorBasedItemReaders">Cursor-based <code>ItemReader</code> Implementations</a></p>
</li>
<li>
<p><a href="#pagingItemReaders">Paging <code>ItemReader</code> Implementations</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="cursorBasedItemReaders"><a class="anchor" href="#cursorBasedItemReaders"></a>6.10.1. Cursor-based <code>ItemReader</code> Implementations</h4>
<div class="paragraph">
<p>Using a database cursor is generally the default approach of most batch developers,
because it is the database&#8217;s solution to the problem of 'streaming' relational data. The
Java <code>ResultSet</code> class is essentially an object oriented mechanism for manipulating a
cursor. A <code>ResultSet</code> maintains a cursor to the current row of data. Calling <code>next</code> on a
<code>ResultSet</code> moves this cursor to the next row. The Spring Batch cursor-based <code>ItemReader</code>
implementation opens a cursor on initialization and moves the cursor forward one row for
every call to <code>read</code>, returning a mapped object that can be used for processing. The
<code>close</code> method is then called to ensure all resources are freed up. The Spring core
<code>JdbcTemplate</code> gets around this problem by using the callback pattern to completely map
all rows in a <code>ResultSet</code> and close before returning control back to the method caller.
However, in batch, this must wait until the step is complete. The following image shows a
generic diagram of how a cursor-based <code>ItemReader</code> works. Note that, while the example
uses SQL (because SQL is so widely known), any technology could implement the basic
approach.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/cursorExample.png" alt="Cursor Example">
</div>
<div class="title">Figure 19. Cursor Example</div>
</div>
<div class="paragraph">
<p>This example illustrates the basic pattern. Given a 'FOO' table, which has three columns:
<code>ID</code>, <code>NAME</code>, and <code>BAR</code>, select all rows with an ID greater than 1 but less than 7. This
puts the beginning of the cursor (row 1) on ID 2. The result of this row should be a
completely mapped <code>Foo</code> object. Calling <code>read()</code> again moves the cursor to the next row,
which is the <code>Foo</code> with an ID of 3. The results of these reads are written out after each
<code>read</code>, allowing the objects to be garbage collected (assuming no instance variables are
maintaining references to them).</p>
</div>
<div class="sect4">
<h5 id="JdbcCursorItemReader"><a class="anchor" href="#JdbcCursorItemReader"></a><code>JdbcCursorItemReader</code></h5>
<div class="paragraph">
<p><code>JdbcCursorItemReader</code> is the JDBC implementation of the cursor-based technique. It works
directly with a <code>ResultSet</code> and requires an SQL statement to run against a connection
obtained from a <code>DataSource</code>. The following database schema is used as an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> CUSTOMER (
   ID <span class="predefined-type">BIGINT</span> IDENTITY <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
   NAME <span class="predefined-type">VARCHAR</span>(<span class="integer">45</span>),
   CREDIT <span class="predefined-type">FLOAT</span>
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Many people prefer to use a domain object for each row, so the following example uses an
implementation of the <code>RowMapper</code> interface to map a <code>CustomerCredit</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerCreditRowMapper</span> <span class="directive">implements</span> <span class="predefined-type">RowMapper</span>&lt;CustomerCredit&gt; {

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> ID_COLUMN = <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NAME_COLUMN = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CREDIT_COLUMN = <span class="string"><span class="delimiter">&quot;</span><span class="content">credit</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">public</span> CustomerCredit mapRow(<span class="predefined-type">ResultSet</span> rs, <span class="type">int</span> rowNum) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        CustomerCredit customerCredit = <span class="keyword">new</span> CustomerCredit();

        customerCredit.setId(rs.getInt(ID_COLUMN));
        customerCredit.setName(rs.getString(NAME_COLUMN));
        customerCredit.setCredit(rs.getBigDecimal(CREDIT_COLUMN));

        <span class="keyword">return</span> customerCredit;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because <code>JdbcCursorItemReader</code> shares key interfaces with <code>JdbcTemplate</code>, it is useful to
see an example of how to read in this data with <code>JdbcTemplate</code>, in order to contrast it
with the <code>ItemReader</code>. For the purposes of this example, assume there are 1,000 rows in
the <code>CUSTOMER</code> database. The first example uses <code>JdbcTemplate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//For simplicity sake, assume a dataSource has already been obtained</span>
JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
<span class="predefined-type">List</span> customerCredits = jdbcTemplate.query(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT ID, NAME, CREDIT from CUSTOMER</span><span class="delimiter">&quot;</span></span>,
                                          <span class="keyword">new</span> CustomerCreditRowMapper());</code></pre>
</div>
</div>
<div class="paragraph">
<p>After running the preceding code snippet, the <code>customerCredits</code> list contains 1,000
<code>CustomerCredit</code> objects. In the query method, a connection is obtained from the
<code>DataSource</code>, the provided SQL is run against it, and the <code>mapRow</code> method is called for
each row in the <code>ResultSet</code>. Contrast this with the approach of the
<code>JdbcCursorItemReader</code>, shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">JdbcCursorItemReader itemReader = <span class="keyword">new</span> JdbcCursorItemReader();
itemReader.setDataSource(dataSource);
itemReader.setSql(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT ID, NAME, CREDIT from CUSTOMER</span><span class="delimiter">&quot;</span></span>);
itemReader.setRowMapper(<span class="keyword">new</span> CustomerCreditRowMapper());
<span class="type">int</span> counter = <span class="integer">0</span>;
ExecutionContext executionContext = <span class="keyword">new</span> ExecutionContext();
itemReader.open(executionContext);
<span class="predefined-type">Object</span> customerCredit = <span class="keyword">new</span> <span class="predefined-type">Object</span>();
<span class="keyword">while</span>(customerCredit != <span class="predefined-constant">null</span>){
    customerCredit = itemReader.read();
    counter++;
}
itemReader.close();</code></pre>
</div>
</div>
<div class="paragraph">
<p>After running the preceding code snippet, the counter equals 1,000. If the code above had
put the returned <code>customerCredit</code> into a list, the result would have been exactly the
same as with the <code>JdbcTemplate</code> example. However, the big advantage of the <code>ItemReader</code>
is that it allows items to be 'streamed'. The <code>read</code> method can be called once, the item
can be written out by an <code>ItemWriter</code>, and then the next item can be obtained with
<code>read</code>. This allows item reading and writing to be done in 'chunks' and committed
periodically, which is the essence of high performance batch processing. Furthermore, it
is very easily configured for injection into a Spring Batch <code>Step</code>, as shown in the
following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...JdbcCursorItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sql</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">select ID, NAME, CREDIT from CUSTOMER</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rowMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.sample.domain.CustomerCreditRowMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> JdbcCursorItemReader&lt;CustomerCredit&gt; itemReader() {
        <span class="keyword">return</span> <span class="keyword">new</span> JdbcCursorItemReaderBuilder&lt;CustomerCredit&gt;()
                        .dataSource(<span class="local-variable">this</span>.dataSource)
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">creditReader</span><span class="delimiter">&quot;</span></span>)
                        .sql(<span class="string"><span class="delimiter">&quot;</span><span class="content">select ID, NAME, CREDIT from CUSTOMER</span><span class="delimiter">&quot;</span></span>)
                        .rowMapper(<span class="keyword">new</span> CustomerCreditRowMapper())
                        .build();

}</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="JdbcCursorItemReaderProperties"><a class="anchor" href="#JdbcCursorItemReaderProperties"></a>Additional Properties</h6>
<div class="paragraph">
<p>Because there are so many varying options for opening a cursor in Java, there are many
properties on the <code>JdbcCursorItemReader</code> that can be set, as described in the following
table:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 16. JdbcCursorItemReader Properties</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignoreWarnings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determines whether or not SQLWarnings are logged or cause an exception.
The default is <code>true</code> (meaning that warnings are logged).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fetchSize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gives the JDBC driver a hint as to the number of rows that should be fetched
from the database when more rows are needed by the <code>ResultSet</code> object used by the
<code>ItemReader</code>. By default, no hint is given.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxRows</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the limit for the maximum number of rows the underlying <code>ResultSet</code> can
hold at any one time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">queryTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the number of seconds the driver waits for a <code>Statement</code> object to
run. If the limit is exceeded, a <code>DataAccessException</code> is thrown. (Consult your driver
vendor documentation for details).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">verifyCursorPosition</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Because the same <code>ResultSet</code> held by the <code>ItemReader</code> is passed to
the <code>RowMapper</code>, it is possible for users to call <code>ResultSet.next()</code> themselves, which
could cause issues with the reader&#8217;s internal count. Setting this value to <code>true</code> causes
an exception to be thrown if the cursor position is not the same after the <code>RowMapper</code>
call as it was before.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">saveState</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates whether or not the reader&#8217;s state should be saved in the
<code>ExecutionContext</code> provided by <code>ItemStream#update(ExecutionContext)</code>. The default is
<code>true</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">driverSupportsAbsolute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates whether the JDBC driver supports
setting the absolute row on a <code>ResultSet</code>. It is recommended that this is set to <code>true</code>
for JDBC drivers that support <code>ResultSet.absolute()</code>, as it may improve performance,
especially if a step fails while working with a large data set. Defaults to <code>false</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">setUseSharedExtendedConnection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates whether the connection
used for the cursor should be used by all other processing, thus sharing the same
transaction. If this is set to <code>false</code>, then the cursor is opened with its own connection
and does not participate in any transactions started for the rest of the step processing.
If you set this flag to <code>true</code> then you must wrap the DataSource in an
<code>ExtendedConnectionDataSourceProxy</code> to prevent the connection from being closed and
released after each commit. When you set this option to <code>true</code>, the statement used to
open the cursor is created with both 'READ_ONLY' and 'HOLD_CURSORS_OVER_COMMIT' options.
This allows holding the cursor open over transaction start and commits performed in the
step processing. To use this feature, you need a database that supports this and a JDBC
driver supporting JDBC 3.0 or later. Defaults to <code>false</code>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="HibernateCursorItemReader"><a class="anchor" href="#HibernateCursorItemReader"></a><code>HibernateCursorItemReader</code></h5>
<div class="paragraph">
<p>Just as normal Spring users make important decisions about whether or not to use ORM
solutions, which affect whether or not they use a <code>JdbcTemplate</code> or a
<code>HibernateTemplate</code>, Spring Batch users have the same options.
<code>HibernateCursorItemReader</code> is the Hibernate implementation of the cursor technique.
Hibernate&#8217;s usage in batch has been fairly controversial. This has largely been because
Hibernate was originally developed to support online application styles. However, that
does not mean it cannot be used for batch processing. The easiest approach for solving
this problem is to use a <code>StatelessSession</code> rather than a standard session. This removes
all of the caching and dirty checking Hibernate employs and that can cause issues in a
batch scenario. For more information on the differences between stateless and normal
hibernate sessions, refer to the documentation of your specific hibernate release. The
<code>HibernateCursorItemReader</code> lets you declare an HQL statement and pass in a
<code>SessionFactory</code>, which will pass back one item per call to read in the same basic
fashion as the <code>JdbcCursorItemReader</code>. The following example configuration uses the same
'customer credit' example as the JDBC reader:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">HibernateCursorItemReader itemReader = <span class="keyword">new</span> HibernateCursorItemReader();
itemReader.setQueryString(<span class="string"><span class="delimiter">&quot;</span><span class="content">from CustomerCredit</span><span class="delimiter">&quot;</span></span>);
<span class="comment">//For simplicity sake, assume sessionFactory already obtained.</span>
itemReader.setSessionFactory(sessionFactory);
itemReader.setUseStatelessSession(<span class="predefined-constant">true</span>);
<span class="type">int</span> counter = <span class="integer">0</span>;
ExecutionContext executionContext = <span class="keyword">new</span> ExecutionContext();
itemReader.open(executionContext);
<span class="predefined-type">Object</span> customerCredit = <span class="keyword">new</span> <span class="predefined-type">Object</span>();
<span class="keyword">while</span>(customerCredit != <span class="predefined-constant">null</span>){
    customerCredit = itemReader.read();
    counter++;
}
itemReader.close();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configured <code>ItemReader</code> returns <code>CustomerCredit</code> objects in the exact same manner
as described by the <code>JdbcCursorItemReader</code>, assuming hibernate mapping files have been
created correctly for the <code>Customer</code> table. The 'useStatelessSession' property defaults
to true but has been added here to draw attention to the ability to switch it on or off.
It is also worth noting that the fetch size of the underlying cursor can be set via the
<code>setFetchSize</code> property. As with <code>JdbcCursorItemReader</code>, configuration is
straightforward, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.database.HibernateCursorItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessionFactory</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">queryString</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">from CustomerCredit</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> HibernateCursorItemReader itemReader(SessionFactory sessionFactory) {
        <span class="keyword">return</span> <span class="keyword">new</span> HibernateCursorItemReaderBuilder&lt;CustomerCredit&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">creditReader</span><span class="delimiter">&quot;</span></span>)
                        .sessionFactory(sessionFactory)
                        .queryString(<span class="string"><span class="delimiter">&quot;</span><span class="content">from CustomerCredit</span><span class="delimiter">&quot;</span></span>)
                        .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="StoredProcedureItemReader"><a class="anchor" href="#StoredProcedureItemReader"></a><code>StoredProcedureItemReader</code></h5>
<div class="paragraph">
<p>Sometimes it is necessary to obtain the cursor data by using a stored procedure. The
<code>StoredProcedureItemReader</code> works like the <code>JdbcCursorItemReader</code>, except that, instead
of running a query to obtain a cursor, it runs a stored procedure that returns a cursor.
The stored procedure can return the cursor in three different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>As a returned <code>ResultSet</code> (used by SQL Server, Sybase, DB2, Derby, and MySQL).</p>
</li>
<li>
<p>As a ref-cursor returned as an out parameter (used by Oracle and PostgreSQL).</p>
</li>
<li>
<p>As the return value of a stored function call.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example configuration uses the same 'customer credit' example as earlier
examples:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">o.s.batch.item.database.StoredProcedureItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">procedureName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sp_customer_credit</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rowMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.sample.domain.CustomerCreditRowMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">@Bean
public StoredProcedureItemReader reader(DataSource dataSource) {
        StoredProcedureItemReader reader = new StoredProcedureItemReader();

        reader.setDataSource(dataSource);
        reader.setProcedureName(&quot;sp_customer_credit&quot;);
        reader.setRowMapper(new CustomerCreditRowMapper());

        return reader;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding example relies on the stored procedure to provide a <code>ResultSet</code> as a
returned result (option 1 from earlier).</p>
</div>
<div class="paragraph">
<p>If the stored procedure returned a <code>ref-cursor</code> (option 2), then we would need to provide
the position of the out parameter that is the returned <code>ref-cursor</code>. The following
example shows how to work with the first parameter being a ref-cursor:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">o.s.batch.item.database.StoredProcedureItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">procedureName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sp_customer_credit</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">refCursorPosition</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rowMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.sample.domain.CustomerCreditRowMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> StoredProcedureItemReader reader(<span class="predefined-type">DataSource</span> dataSource) {
        StoredProcedureItemReader reader = <span class="keyword">new</span> StoredProcedureItemReader();

        reader.setDataSource(dataSource);
        reader.setProcedureName(<span class="string"><span class="delimiter">&quot;</span><span class="content">sp_customer_credit</span><span class="delimiter">&quot;</span></span>);
        reader.setRowMapper(<span class="keyword">new</span> CustomerCreditRowMapper());
        reader.setRefCursorPosition(<span class="integer">1</span>);

        <span class="keyword">return</span> reader;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the cursor was returned from a stored function (option 3), we would need to set the
property "<span class="maroon">function</span>" to <code>true</code>. It defaults to <code>false</code>. The following example
shows what that would look like:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">o.s.batch.item.database.StoredProcedureItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">procedureName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sp_customer_credit</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">function</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rowMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.sample.domain.CustomerCreditRowMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> StoredProcedureItemReader reader(<span class="predefined-type">DataSource</span> dataSource) {
        StoredProcedureItemReader reader = <span class="keyword">new</span> StoredProcedureItemReader();

        reader.setDataSource(dataSource);
        reader.setProcedureName(<span class="string"><span class="delimiter">&quot;</span><span class="content">sp_customer_credit</span><span class="delimiter">&quot;</span></span>);
        reader.setRowMapper(<span class="keyword">new</span> CustomerCreditRowMapper());
        reader.setFunction(<span class="predefined-constant">true</span>);

        <span class="keyword">return</span> reader;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In all of these cases, we need to define a <code>RowMapper</code> as well as a <code>DataSource</code> and the
actual procedure name.</p>
</div>
<div class="paragraph">
<p>If the stored procedure or function takes in parameters, then they must be declared and
set via the <code>parameters</code> property. The following example, for Oracle, declares three
parameters. The first one is the out parameter that returns the ref-cursor, and the
second and third are in parameters that takes a value of type <code>INTEGER</code>.</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">o.s.batch.item.database.StoredProcedureItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">procedureName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">spring.cursor_func</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameters</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.core.SqlOutParameter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;constructor-arg</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">newid</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;constructor-arg</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;util:constant</span> <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">oracle.jdbc.OracleTypes.CURSOR</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/constructor-arg&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.core.SqlParameter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;constructor-arg</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;constructor-arg</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;util:constant</span> <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.sql.Types.INTEGER</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/constructor-arg&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.core.SqlParameter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;constructor-arg</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custid</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;constructor-arg</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;util:constant</span> <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.sql.Types.INTEGER</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/constructor-arg&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">refCursorPosition</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rowMapper</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rowMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">preparedStatementSetter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameterSetter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> StoredProcedureItemReader reader(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="predefined-type">List</span>&lt;SqlParameter&gt; parameters = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
        parameters.add(<span class="keyword">new</span> SqlOutParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">newId</span><span class="delimiter">&quot;</span></span>, OracleTypes.CURSOR));
        parameters.add(<span class="keyword">new</span> SqlParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.INTEGER);
        parameters.add(<span class="keyword">new</span> SqlParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">custId</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.INTEGER);

        StoredProcedureItemReader reader = <span class="keyword">new</span> StoredProcedureItemReader();

        reader.setDataSource(dataSource);
        reader.setProcedureName(<span class="string"><span class="delimiter">&quot;</span><span class="content">spring.cursor_func</span><span class="delimiter">&quot;</span></span>);
        reader.setParameters(parameters);
        reader.setRefCursorPosition(<span class="integer">1</span>);
        reader.setRowMapper(rowMapper());
        reader.setPreparedStatementSetter(parameterSetter());

        <span class="keyword">return</span> reader;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the parameter declarations, we need to specify a <code>PreparedStatementSetter</code>
implementation that sets the parameter values for the call. This works the same as for
the <code>JdbcCursorItemReader</code> above. All the additional properties listed in
<a href="#JdbcCursorItemReaderProperties">Additional Properties</a> apply to the <code>StoredProcedureItemReader</code> as well.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pagingItemReaders"><a class="anchor" href="#pagingItemReaders"></a>6.10.2. Paging <code>ItemReader</code> Implementations</h4>
<div class="paragraph">
<p>An alternative to using a database cursor is running multiple queries where each query
fetches a portion of the results. We refer to this portion as a page. Each query must
specify the starting row number and the number of rows that we want returned in the page.</p>
</div>
<div class="sect4">
<h5 id="JdbcPagingItemReader"><a class="anchor" href="#JdbcPagingItemReader"></a><code>JdbcPagingItemReader</code></h5>
<div class="paragraph">
<p>One implementation of a paging <code>ItemReader</code> is the <code>JdbcPagingItemReader</code>. The
<code>JdbcPagingItemReader</code> needs a <code>PagingQueryProvider</code> responsible for providing the SQL
queries used to retrieve the rows making up a page. Since each database has its own
strategy for providing paging support, we need to use a different <code>PagingQueryProvider</code>
for each supported database type. There is also the <code>SqlPagingQueryProviderFactoryBean</code>
that auto-detects the database that is being used and determine the appropriate
<code>PagingQueryProvider</code> implementation. This simplifies the configuration and is the
recommended best practice.</p>
</div>
<div class="paragraph">
<p>The <code>SqlPagingQueryProviderFactoryBean</code> requires that you specify a <code>select</code> clause and a
<code>from</code> clause. You can also provide an optional <code>where</code> clause. These clauses and the
required <code>sortKey</code> are used to build an SQL statement.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is important to have a unique key constraint on the <code>sortKey</code> to guarantee that
 no data is lost between executions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After the reader has been opened, it passes back one item per call to <code>read</code> in the same
basic fashion as any other <code>ItemReader</code>. The paging happens behind the scenes when
additional rows are needed.</p>
</div>
<div class="paragraph">
<p>The following example configuration uses a similar 'customer credit' example as the
cursor-based <code>ItemReaders</code> shown previously:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...JdbcPagingItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">queryProvider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...SqlPagingQueryProviderFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">selectClause</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">select id, name, credit</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fromClause</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">from customer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">whereClause</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">where status=:status</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sortKey</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameterValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NEW</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pageSize</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rowMapper</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> JdbcPagingItemReader itemReader(<span class="predefined-type">DataSource</span> dataSource, PagingQueryProvider queryProvider) {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; parameterValues = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
        parameterValues.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">NEW</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> <span class="keyword">new</span> JdbcPagingItemReaderBuilder&lt;CustomerCredit&gt;()
                                           .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">creditReader</span><span class="delimiter">&quot;</span></span>)
                                           .dataSource(dataSource)
                                           .queryProvider(queryProvider)
                                           .parameterValues(parameterValues)
                                           .rowMapper(customerCreditMapper())
                                           .pageSize(<span class="integer">1000</span>)
                                           .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> SqlPagingQueryProviderFactoryBean queryProvider() {
        SqlPagingQueryProviderFactoryBean provider = <span class="keyword">new</span> SqlPagingQueryProviderFactoryBean();

        provider.setSelectClause(<span class="string"><span class="delimiter">&quot;</span><span class="content">select id, name, credit</span><span class="delimiter">&quot;</span></span>);
        provider.setFromClause(<span class="string"><span class="delimiter">&quot;</span><span class="content">from customer</span><span class="delimiter">&quot;</span></span>);
        provider.setWhereClause(<span class="string"><span class="delimiter">&quot;</span><span class="content">where status=:status</span><span class="delimiter">&quot;</span></span>);
        provider.setSortKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> provider;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configured <code>ItemReader</code> returns <code>CustomerCredit</code> objects using the <code>RowMapper</code>,
which must be specified. The 'pageSize' property determines the number of entities read
from the database for each query run.</p>
</div>
<div class="paragraph">
<p>The 'parameterValues' property can be used to specify a <code>Map</code> of parameter values for the
query. If you use named parameters in the <code>where</code> clause, the key for each entry should
match the name of the named parameter. If you use a traditional '?' placeholder, then the
key for each entry should be the number of the placeholder, starting with 1.</p>
</div>
</div>
<div class="sect4">
<h5 id="JpaPagingItemReader"><a class="anchor" href="#JpaPagingItemReader"></a><code>JpaPagingItemReader</code></h5>
<div class="paragraph">
<p>Another implementation of a paging <code>ItemReader</code> is the <code>JpaPagingItemReader</code>. JPA does
not have a concept similar to the Hibernate <code>StatelessSession</code>, so we have to use other
features provided by the JPA specification. Since JPA supports paging, this is a natural
choice when it comes to using JPA for batch processing. After each page is read, the
entities become detached and the persistence context is cleared, to allow the entities to
be garbage collected once the page is processed.</p>
</div>
<div class="paragraph">
<p>The <code>JpaPagingItemReader</code> lets you declare a JPQL statement and pass in a
<code>EntityManagerFactory</code>. It then passes back one item per call to read in the same basic
fashion as any other <code>ItemReader</code>. The paging happens behind the scenes when additional
entities are needed. The following example configuration uses the same 'customer credit'
example as the JDBC reader shown previously:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...JpaPagingItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">entityManagerFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">entityManagerFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">queryString</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">select c from CustomerCredit c</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pageSize</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> JpaPagingItemReader itemReader() {
        <span class="keyword">return</span> <span class="keyword">new</span> JpaPagingItemReaderBuilder&lt;CustomerCredit&gt;()
                                           .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">creditReader</span><span class="delimiter">&quot;</span></span>)
                                           .entityManagerFactory(entityManagerFactory())
                                           .queryString(<span class="string"><span class="delimiter">&quot;</span><span class="content">select c from CustomerCredit c</span><span class="delimiter">&quot;</span></span>)
                                           .pageSize(<span class="integer">1000</span>)
                                           .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configured <code>ItemReader</code> returns <code>CustomerCredit</code> objects in the exact same manner as
described for the <code>JdbcPagingItemReader</code> above, assuming the <code>CustomerCredit</code> object has the
correct JPA annotations or ORM mapping file. The 'pageSize' property determines the
number of entities read from the database for each query execution.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="databaseItemWriters"><a class="anchor" href="#databaseItemWriters"></a>6.10.3. Database ItemWriters</h4>
<div class="paragraph">
<p>While both flat files and XML files have a specific <code>ItemWriter</code> instance, there is no exact equivalent
in the database world. This is because transactions provide all the needed functionality.
<code>ItemWriter</code> implementations are necessary for files because they must act as if they&#8217;re transactional,
keeping track of written items and flushing or clearing at the appropriate times.
Databases have no need for this functionality, since the write is already contained in a
transaction. Users can create their own DAOs that implement the <code>ItemWriter</code> interface or
use one from a custom <code>ItemWriter</code> that&#8217;s written for generic processing concerns. Either
way, they should work without any issues. One thing to look out for is the performance
and error handling capabilities that are provided by batching the outputs. This is most
common when using hibernate as an <code>ItemWriter</code> but could have the same issues when using
JDBC batch mode. Batching database output does not have any inherent flaws, assuming we
are careful to flush and there are no errors in the data. However, any errors while
writing can cause confusion, because there is no way to know which individual item caused
an exception or even if any individual item was responsible, as illustrated in the
following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/errorOnFlush.png" alt="Error On Flush">
</div>
<div class="title">Figure 20. Error On Flush</div>
</div>
<div class="paragraph">
<p>If items are buffered before being written, any errors are not thrown until the buffer is
flushed just before a commit. For example, assume that 20 items are written per chunk,
and the 15th item throws a <code>DataIntegrityViolationException</code>. As far as the <code>Step</code>
is concerned, all 20 item are written successfully, since there is no way to know that an
error occurs until they are actually written. Once <code>Session#flush()</code> is called, the
buffer is emptied and the exception is hit. At this point, there is nothing the <code>Step</code>
can do. The transaction must be rolled back. Normally, this exception might cause the
item to be skipped (depending upon the skip/retry policies), and then it is not written
again. However, in the batched scenario, there is no way to know which item caused the
issue. The whole buffer was being written when the failure happened. The only way to
solve this issue is to flush after each item, as shown in the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/errorOnWrite.png" alt="Error On Write">
</div>
<div class="title">Figure 21. Error On Write</div>
</div>
<div class="paragraph">
<p>This is a common use case, especially when using Hibernate, and the simple guideline for
implementations of <code>ItemWriter</code> is to flush on each call to <code>write()</code>. Doing so allows
for items to be skipped reliably, with Spring Batch internally taking care of the
granularity of the calls to <code>ItemWriter</code> after an error.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="reusingExistingServices"><a class="anchor" href="#reusingExistingServices"></a>6.11. Reusing Existing Services</h3>
<div class="paragraph">
<p>Batch systems are often used in conjunction with other application styles. The most
common is an online system, but it may also support integration or even a thick client
application by moving necessary bulk data that each application style uses. For this
reason, it is common that many users want to reuse existing DAOs or other services within
their batch jobs. The Spring container itself makes this fairly easy by allowing any
necessary class to be injected. However, there may be cases where the existing service
needs to act as an <code>ItemReader</code> or <code>ItemWriter</code>, either to satisfy the dependency of
another Spring Batch class or because it truly is the main <code>ItemReader</code> for a step. It is
fairly trivial to write an adapter class for each service that needs wrapping, but
because it is such a common concern, Spring Batch provides implementations:
<code>ItemReaderAdapter</code> and <code>ItemWriterAdapter</code>. Both classes implement the standard Spring
method by invoking the delegate pattern and are fairly simple to set up. The following
example uses the <code>ItemReaderAdapter</code>:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.adapter.ItemReaderAdapter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">targetObject</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooService</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">targetMethod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">generateFoo</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.sample.FooService</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> ItemReaderAdapter itemReader() {
        ItemReaderAdapter reader = <span class="keyword">new</span> ItemReaderAdapter();

        reader.setTargetObject(fooService());
        reader.setTargetMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">generateFoo</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> reader;
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> FooService fooService() {
        <span class="keyword">return</span> <span class="keyword">new</span> FooService();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One important point to note is that the contract of the <code>targetMethod</code> must be the same
as the contract for <code>read</code>: When exhausted, it returns <code>null</code>. Otherwise, it returns an
<code>Object</code>. Anything else prevents the framework from knowing when processing should end,
either causing an infinite loop or incorrect failure, depending upon the implementation
of the <code>ItemWriter</code>. The following example uses the <code>ItemWriterAdapter</code>:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.adapter.ItemWriterAdapter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">targetObject</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooService</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">targetMethod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">processFoo</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.sample.FooService</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> ItemWriterAdapter itemWriter() {
        ItemWriterAdapter writer = <span class="keyword">new</span> ItemWriterAdapter();

        writer.setTargetObject(fooService());
        writer.setTargetMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">processFoo</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> writer;
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> FooService fooService() {
        <span class="keyword">return</span> <span class="keyword">new</span> FooService();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="validatingInput"><a class="anchor" href="#validatingInput"></a>6.12. Validating Input</h3>
<div class="paragraph">
<p>During the course of this chapter, multiple approaches to parsing input have been
discussed. Each major implementation throws an exception if it is not 'well-formed'. The
<code>FixedLengthTokenizer</code> throws an exception if a range of data is missing. Similarly,
attempting to access an index in a <code>RowMapper</code> or <code>FieldSetMapper</code> that does not exist or
is in a different format than the one expected causes an exception to be thrown. All of
these types of exceptions are thrown before <code>read</code> returns. However, they do not address
the issue of whether or not the returned item is valid. For example, if one of the fields
is an age, it obviously cannot be negative. It may parse correctly, because it exists and
is a number, but it does not cause an exception. Since there are already a plethora of
validation frameworks, Spring Batch does not attempt to provide yet another. Rather, it
provides a simple interface, called <code>Validator</code>, that can be implemented by any number of
frameworks, as shown in the following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Validator</span>&lt;T&gt; {

    <span class="type">void</span> validate(T value) <span class="directive">throws</span> ValidationException;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The contract is that the <code>validate</code> method throws an exception if the object is invalid
and returns normally if it is valid. Spring Batch provides an out of the box
<code>ValidatingItemProcessor</code>, as shown in the following bean definition:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.validator.ValidatingItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">validator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">validator</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">validator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.validator.SpringValidator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">validator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.sample.domain.trade.internal.validator.TradeValidator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> ValidatingItemProcessor itemProcessor() {
        ValidatingItemProcessor processor = <span class="keyword">new</span> ValidatingItemProcessor();

        processor.setValidator(validator());

        <span class="keyword">return</span> processor;
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> SpringValidator validator() {
        SpringValidator validator = <span class="keyword">new</span> SpringValidator();

        validator.setValidator(<span class="keyword">new</span> TradeValidator());

        <span class="keyword">return</span> validator;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <code>BeanValidatingItemProcessor</code> to validate items annotated with
the Bean Validation API (JSR-303) annotations. For example, given the following type <code>Person</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

    <span class="annotation">@NotEmpty</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> Person(<span class="predefined-type">String</span> name) {
     <span class="local-variable">this</span>.name = name;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
     <span class="keyword">return</span> name;
    }

    <span class="directive">public</span> <span class="type">void</span> setName(<span class="predefined-type">String</span> name) {
     <span class="local-variable">this</span>.name = name;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>you can validate items by declaring a <code>BeanValidatingItemProcessor</code> bean in your
application context and register it as a processor in your chunk-oriented step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> BeanValidatingItemProcessor&lt;Person&gt; beanValidatingItemProcessor() <span class="directive">throws</span> <span class="exception">Exception</span> {
    BeanValidatingItemProcessor&lt;Person&gt; beanValidatingItemProcessor = <span class="keyword">new</span> BeanValidatingItemProcessor&lt;&gt;();
    beanValidatingItemProcessor.setFilter(<span class="predefined-constant">true</span>);

    <span class="keyword">return</span> beanValidatingItemProcessor;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="process-indicator"><a class="anchor" href="#process-indicator"></a>6.13. Preventing State Persistence</h3>
<div class="paragraph">
<p>By default, all of the <code>ItemReader</code> and <code>ItemWriter</code> implementations store their current
state in the <code>ExecutionContext</code> before it is committed. However, this may not always be
the desired behavior. For example, many developers choose to make their database readers
'rerunnable' by using a process indicator. An extra column is added to the input data to
indicate whether or not it has been processed. When a particular record is being read (or
written) the processed flag is flipped from <code>false</code> to <code>true</code>. The SQL statement can then
contain an extra statement in the <code>where</code> clause, such as <code>where PROCESSED_IND = false</code>,
thereby ensuring that only unprocessed records are returned in the case of a restart. In
this scenario, it is preferable to not store any state, such as the current row number,
since it is irrelevant upon restart. For this reason, all readers and writers include the
'saveState' property, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playerSummarizationSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...JdbcCursorItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rowMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.sample.PlayerSummaryMapper</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">saveState</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sql</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;value&gt;</span>
            SELECT games.player_id, games.year_no, SUM(COMPLETES),
            SUM(ATTEMPTS), SUM(PASSING_YARDS), SUM(PASSING_TD),
            SUM(INTERCEPTIONS), SUM(RUSHES), SUM(RUSH_YARDS),
            SUM(RECEPTIONS), SUM(RECEPTIONS_YARDS), SUM(TOTAL_TD)
            from games, players where players.player_id =
            games.player_id group by games.player_id, games.year_no
        <span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> JdbcCursorItemReader playerSummarizationSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="keyword">return</span> <span class="keyword">new</span> JdbcCursorItemReaderBuilder&lt;PlayerSummary&gt;()
                                .dataSource(dataSource)
                                .rowMapper(<span class="keyword">new</span> PlayerSummaryMapper())
                                .saveState(<span class="predefined-constant">false</span>)
                                .sql(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT games.player_id, games.year_no, SUM(COMPLETES),</span><span class="delimiter">&quot;</span></span>
                                  + <span class="string"><span class="delimiter">&quot;</span><span class="content">SUM(ATTEMPTS), SUM(PASSING_YARDS), SUM(PASSING_TD),</span><span class="delimiter">&quot;</span></span>
                                  + <span class="string"><span class="delimiter">&quot;</span><span class="content">SUM(INTERCEPTIONS), SUM(RUSHES), SUM(RUSH_YARDS),</span><span class="delimiter">&quot;</span></span>
                                  + <span class="string"><span class="delimiter">&quot;</span><span class="content">SUM(RECEPTIONS), SUM(RECEPTIONS_YARDS), SUM(TOTAL_TD)</span><span class="delimiter">&quot;</span></span>
                                  + <span class="string"><span class="delimiter">&quot;</span><span class="content">from games, players where players.player_id =</span><span class="delimiter">&quot;</span></span>
                                  + <span class="string"><span class="delimiter">&quot;</span><span class="content">games.player_id group by games.player_id, games.year_no</span><span class="delimiter">&quot;</span></span>)
                                .build();

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ItemReader</code> configured above does not make any entries in the <code>ExecutionContext</code> for
any executions in which it participates.</p>
</div>
</div>
<div class="sect2">
<h3 id="customReadersWriters"><a class="anchor" href="#customReadersWriters"></a>6.14. Creating Custom ItemReaders and ItemWriters</h3>
<div class="paragraph">
<p>So far, this chapter has discussed the basic contracts of reading and writing in Spring
Batch and some common implementations for doing so. However, these are all fairly
generic, and there are many potential scenarios that may not be covered by out-of-the-box
implementations. This section shows, by using a simple example, how to create a custom
<code>ItemReader</code> and <code>ItemWriter</code> implementation and implement their contracts correctly. The
<code>ItemReader</code> also implements <code>ItemStream</code>, in order to illustrate how to make a reader or
writer restartable.</p>
</div>
<div class="sect3">
<h4 id="customReader"><a class="anchor" href="#customReader"></a>6.14.1. Custom <code>ItemReader</code> Example</h4>
<div class="paragraph">
<p>For the purpose of this example, we create a simple <code>ItemReader</code> implementation that
reads from a provided list. We start by implementing the most basic contract of
<code>ItemReader</code>, the <code>read</code> method, as shown in the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomItemReader</span>&lt;T&gt; <span class="directive">implements</span> ItemReader&lt;T&gt;{

    <span class="predefined-type">List</span>&lt;T&gt; items;

    <span class="directive">public</span> CustomItemReader(<span class="predefined-type">List</span>&lt;T&gt; items) {
        <span class="local-variable">this</span>.items = items;
    }

    <span class="directive">public</span> T read() <span class="directive">throws</span> <span class="exception">Exception</span>, UnexpectedInputException,
       NonTransientResourceException, <span class="exception">ParseException</span> {

        <span class="keyword">if</span> (!items.isEmpty()) {
            <span class="keyword">return</span> items.remove(<span class="integer">0</span>);
        }
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding class takes a list of items and returns them one at a time, removing each
from the list. When the list is empty, it returns <code>null</code>, thus satisfying the most basic
requirements of an <code>ItemReader</code>, as illustrated in the following test code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;<span class="predefined-type">String</span>&gt;();
items.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>);
items.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>);
items.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>);

ItemReader itemReader = <span class="keyword">new</span> CustomItemReader&lt;<span class="predefined-type">String</span>&gt;(items);
assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>, itemReader.read());
assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>, itemReader.read());
assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>, itemReader.read());
assertNull(itemReader.read());</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="restartableReader"><a class="anchor" href="#restartableReader"></a>Making the <code>ItemReader</code> Restartable</h5>
<div class="paragraph">
<p>The final challenge is to make the <code>ItemReader</code> restartable. Currently, if processing is
interrupted and begins again, the <code>ItemReader</code> must start at the beginning. This is
actually valid in many scenarios, but it is sometimes preferable that a batch job
restarts where it left off. The key discriminant is often whether the reader is stateful
or stateless. A stateless reader does not need to worry about restartability, but a
stateful one has to try to reconstitute its last known state on restart. For this reason,
we recommend that you keep custom readers stateless if possible, so you need not worry
about restartability.</p>
</div>
<div class="paragraph">
<p>If you do need to store state, then the <code>ItemStream</code> interface should be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomItemReader</span>&lt;T&gt; <span class="directive">implements</span> ItemReader&lt;T&gt;, ItemStream {

    <span class="predefined-type">List</span>&lt;T&gt; items;
    <span class="type">int</span> currentIndex = <span class="integer">0</span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CURRENT_INDEX = <span class="string"><span class="delimiter">&quot;</span><span class="content">current.index</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">public</span> CustomItemReader(<span class="predefined-type">List</span>&lt;T&gt; items) {
        <span class="local-variable">this</span>.items = items;
    }

    <span class="directive">public</span> T read() <span class="directive">throws</span> <span class="exception">Exception</span>, UnexpectedInputException,
        <span class="exception">ParseException</span>, NonTransientResourceException {

        <span class="keyword">if</span> (currentIndex &lt; items.size()) {
            <span class="keyword">return</span> items.get(currentIndex++);
        }

        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

    <span class="directive">public</span> <span class="type">void</span> open(ExecutionContext executionContext) <span class="directive">throws</span> ItemStreamException {
        <span class="keyword">if</span>(executionContext.containsKey(CURRENT_INDEX)){
            currentIndex = <span class="keyword">new</span> <span class="predefined-type">Long</span>(executionContext.getLong(CURRENT_INDEX)).intValue();
        }
        <span class="keyword">else</span>{
            currentIndex = <span class="integer">0</span>;
        }
    }

    <span class="directive">public</span> <span class="type">void</span> update(ExecutionContext executionContext) <span class="directive">throws</span> ItemStreamException {
        executionContext.putLong(CURRENT_INDEX, <span class="keyword">new</span> <span class="predefined-type">Long</span>(currentIndex).longValue());
    }

    <span class="directive">public</span> <span class="type">void</span> close() <span class="directive">throws</span> ItemStreamException {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>On each call to the <code>ItemStream</code> <code>update</code> method, the current index of the <code>ItemReader</code>
is stored in the provided <code>ExecutionContext</code> with a key of 'current.index'. When the
<code>ItemStream</code> <code>open</code> method is called, the <code>ExecutionContext</code> is checked to see if it
contains an entry with that key. If the key is found, then the current index is moved to
that location. This is a fairly trivial example, but it still meets the general contract:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ExecutionContext executionContext = <span class="keyword">new</span> ExecutionContext();
((ItemStream)itemReader).open(executionContext);
assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>, itemReader.read());
((ItemStream)itemReader).update(executionContext);

<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;<span class="predefined-type">String</span>&gt;();
items.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>);
items.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>);
items.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>);
itemReader = <span class="keyword">new</span> CustomItemReader&lt;<span class="predefined-type">String</span>&gt;(items);

((ItemStream)itemReader).open(executionContext);
assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>, itemReader.read());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most <code>ItemReaders</code> have much more sophisticated restart logic. The
<code>JdbcCursorItemReader</code>, for example, stores the row ID of the last processed row in the
cursor.</p>
</div>
<div class="paragraph">
<p>It is also worth noting that the key used within the <code>ExecutionContext</code> should not be
trivial. That is because the same <code>ExecutionContext</code> is used for all <code>ItemStreams</code> within
a <code>Step</code>. In most cases, simply prepending the key with the class name should be enough
to guarantee uniqueness. However, in the rare cases where two of the same type of
<code>ItemStream</code> are used in the same step (which can happen if two files are needed for
output), a more unique name is needed. For this reason, many of the Spring Batch
<code>ItemReader</code> and <code>ItemWriter</code> implementations have a <code>setName()</code> property that lets this
key name be overridden.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="customWriter"><a class="anchor" href="#customWriter"></a>6.14.2. Custom <code>ItemWriter</code> Example</h4>
<div class="paragraph">
<p>Implementing a Custom <code>ItemWriter</code> is similar in many ways to the <code>ItemReader</code> example
above but differs in enough ways as to warrant its own example. However, adding
restartability is essentially the same, so it is not covered in this example. As with the
<code>ItemReader</code> example, a <code>List</code> is used in order to keep the example as simple as
possible:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomItemWriter</span>&lt;T&gt; <span class="directive">implements</span> ItemWriter&lt;T&gt; {

    <span class="predefined-type">List</span>&lt;T&gt; output = TransactionAwareProxyFactory.createTransactionalList();

    <span class="directive">public</span> <span class="type">void</span> write(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> T&gt; items) <span class="directive">throws</span> <span class="exception">Exception</span> {
        output.addAll(items);
    }

    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;T&gt; getOutput() {
        <span class="keyword">return</span> output;
    }
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="restartableWriter"><a class="anchor" href="#restartableWriter"></a>Making the <code>ItemWriter</code> Restartable</h5>
<div class="paragraph">
<p>To make the <code>ItemWriter</code> restartable, we would follow the same process as for the
<code>ItemReader</code>, adding and implementing the <code>ItemStream</code> interface to synchronize the
execution context. In the example, we might have to count the number of items processed
and add that as a footer record. If we needed to do that, we could implement
<code>ItemStream</code> in our <code>ItemWriter</code> so that the counter was reconstituted from the execution
context if the stream was re-opened.</p>
</div>
<div class="paragraph">
<p>In many realistic cases, custom <code>ItemWriters</code> also delegate to another writer that itself
is restartable (for example, when writing to a file), or else it writes to a
transactional resource and so does not need to be restartable, because it is stateless.
When you have a stateful writer you should probably be sure to implement <code>ItemStream</code> as
well as <code>ItemWriter</code>. Remember also that the client of the writer needs to be aware of
the <code>ItemStream</code>, so you may need to register it as a stream in the configuration.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="itemReaderAndWriterImplementations"><a class="anchor" href="#itemReaderAndWriterImplementations"></a>6.15. Item Reader and Writer Implementations</h3>
<div class="paragraph">
<p>In this section, we will introduce you to readers and writers that have not already been
discussed in the previous sections.</p>
</div>
<div class="sect3">
<h4 id="decorators"><a class="anchor" href="#decorators"></a>6.15.1. Decorators</h4>
<div class="paragraph">
<p>In some cases, a user needs specialized behavior to be appended to a pre-existing
<code>ItemReader</code>.   Spring Batch offers some out of the box decorators that can add
additional behavior to to your <code>ItemReader</code> and <code>ItemWriter</code> implementations.</p>
</div>
<div class="paragraph">
<p>Spring Batch includes the following decorators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#synchronizedItemStreamReader"><code>SynchronizedItemStreamReader</code></a></p>
</li>
<li>
<p><a href="#singleItemPeekableItemReader"><code>SingleItemPeekableItemReader</code></a></p>
</li>
<li>
<p><a href="#multiResourceItemWriter"><code>MultiResourceItemWriter</code></a></p>
</li>
<li>
<p><a href="#classifierCompositeItemWriter"><code>ClassifierCompositeItemWriter</code></a></p>
</li>
<li>
<p><a href="#classifierCompositeItemProcessor"><code>ClassifierCompositeItemProcessor</code></a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="synchronizedItemStreamReader"><a class="anchor" href="#synchronizedItemStreamReader"></a><code>SynchronizedItemStreamReader</code></h5>
<div class="paragraph">
<p>When using an <code>ItemReader</code> that is not thread safe, Spring Batch offers the
<code>SynchronizedItemStreamReader</code> decorator, which can be used to make the <code>ItemReader</code>
thread safe. Spring Batch provides a <code>SynchronizedItemStreamReaderBuilder</code> to construct
an instance of the <code>SynchronizedItemStreamReader</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="singleItemPeekableItemReader"><a class="anchor" href="#singleItemPeekableItemReader"></a><code>SingleItemPeekableItemReader</code></h5>
<div class="paragraph">
<p>Spring Batch includes a decorator that adds a peek method to an <code>ItemReader</code>. This peek
method lets the user peek one item ahead.  Repeated calls to the peek returns the same
item, and this is the next item returned from the <code>read</code> method. Spring Batch provides a
<code>SingleItemPeekableItemReaderBuilder</code> to construct an instance of the
<code>SingleItemPeekableItemReader</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
SingleItemPeekableItemReader&#8217;s peek method is not thread-safe, because it would not
be possible to honor the peek in multiple threads. Only one of the threads that peeked
would get that item in the next call to read.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="multiResourceItemWriter"><a class="anchor" href="#multiResourceItemWriter"></a><code>MultiResourceItemWriter</code></h5>
<div class="paragraph">
<p>The <code>MultiResourceItemWriter</code> wraps a <code>ResourceAwareItemWriterItemStream</code> and creates a new
output resource when the count of items written in the current resource exceeds the
<code>itemCountLimitPerResource</code>. Spring Batch provides a <code>MultiResourceItemWriterBuilder</code> to
construct an instance of the <code>MultiResourceItemWriter</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="classifierCompositeItemWriter"><a class="anchor" href="#classifierCompositeItemWriter"></a><code>ClassifierCompositeItemWriter</code></h5>
<div class="paragraph">
<p>The <code>ClassifierCompositeItemWriter</code> calls one of a collection of <code>ItemWriter</code>
implementations for each item, based on a router pattern implemented through the provided
<code>Classifier</code>.  The implementation is thread-safe if all delegates are thread-safe. Spring
Batch provides a <code>ClassifierCompositeItemWriterBuilder</code> to construct an instance of the
<code>ClassifierCompositeItemWriter</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="classifierCompositeItemProcessor"><a class="anchor" href="#classifierCompositeItemProcessor"></a><code>ClassifierCompositeItemProcessor</code></h5>
<div class="paragraph">
<p>The <code>ClassifierCompositeItemProcessor</code> is an <code>ItemProcessor</code> that calls one of a
collection of <code>ItemProcessor</code> implementations, based on a router pattern implemented
through the provided <code>Classifier</code>. Spring Batch provides a
<code>ClassifierCompositeItemProcessorBuilder</code> to construct an instance of the
<code>ClassifierCompositeItemProcessor</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="messagingReadersAndWriters"><a class="anchor" href="#messagingReadersAndWriters"></a>6.15.2. Messaging Readers And Writers</h4>
<div class="paragraph">
<p>Spring Batch offers the following readers and writers for commonly used messaging systems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#amqpItemReader"><code>AmqpItemReader</code></a></p>
</li>
<li>
<p><a href="#amqpItemWriter"><code>AmqpItemWriter</code></a></p>
</li>
<li>
<p><a href="#jmsItemReader"><code>JmsItemReader</code></a></p>
</li>
<li>
<p><a href="#jmsItemWriter"><code>JmsItemWriter</code></a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="amqpItemReader"><a class="anchor" href="#amqpItemReader"></a><code>AmqpItemReader</code></h5>
<div class="paragraph">
<p>The <code>AmqpItemReader</code> is an <code>ItemReader</code> that uses an <code>AmqpTemplate</code> to receive or convert
messages from an exchange. Spring Batch provides a <code>AmqpItemReaderBuilder</code> to construct
an instance of the <code>AmqpItemReader</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="amqpItemWriter"><a class="anchor" href="#amqpItemWriter"></a><code>AmqpItemWriter</code></h5>
<div class="paragraph">
<p>The <code>AmqpItemWriter</code> is an <code>ItemWriter</code> that uses an <code>AmqpTemplate</code> to send messages to
an AMQP exchange. Messages are sent to the nameless exchange if the name not specified in
the provided <code>AmqpTemplate</code>.  Spring Batch provides an <code>AmqpItemWriterBuilder</code> to
construct an instance of the <code>AmqpItemWriter</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="jmsItemReader"><a class="anchor" href="#jmsItemReader"></a><code>JmsItemReader</code></h5>
<div class="paragraph">
<p>The <code>JmsItemReader</code> is an <code>ItemReader</code> for JMS that uses a <code>JmsTemplate</code>. The template
should have a default destination, which is used to provide items for the <code>read()</code>
method. Spring Batch provides a <code>JmsItemReaderBuilder</code> to construct an instance of the
<code>JmsItemReader</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="jmsItemWriter"><a class="anchor" href="#jmsItemWriter"></a><code>JmsItemWriter</code></h5>
<div class="paragraph">
<p>The <code>JmsItemWriter</code> is an <code>ItemWriter</code> for JMS that uses a <code>JmsTemplate</code>. The template
should have a default destination, which is used to send items in <code>write(List)</code>. Spring
Batch provides a <code>JmsItemWriterBuilder</code> to construct an instance of the <code>JmsItemWriter</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="databaseReaders"><a class="anchor" href="#databaseReaders"></a>6.15.3. Database Readers</h4>
<div class="paragraph">
<p>Spring Batch offers the following database readers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Neo4jItemReader"><code>Neo4jItemReader</code></a></p>
</li>
<li>
<p><a href="#mongoItemReader"><code>MongoItemReader</code></a></p>
</li>
<li>
<p><a href="#hibernateCursorItemReader"><code>HibernateCursorItemReader</code></a></p>
</li>
<li>
<p><a href="#hibernatePagingItemReader"><code>HibernatePagingItemReader</code></a></p>
</li>
<li>
<p><a href="#repositoryItemReader"><code>RepositoryItemReader</code></a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Neo4jItemReader"><a class="anchor" href="#Neo4jItemReader"></a><code>Neo4jItemReader</code></h5>
<div class="paragraph">
<p>The <code>Neo4jItemReader</code> is an <code>ItemReader</code> that reads objects from the graph database Neo4j
by using a paging technique. Spring Batch provides a <code>Neo4jItemReaderBuilder</code> to
construct an instance of the <code>Neo4jItemReader</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="mongoItemReader"><a class="anchor" href="#mongoItemReader"></a><code>MongoItemReader</code></h5>
<div class="paragraph">
<p>The <code>MongoItemReader</code> is an <code>ItemReader</code> that reads documents from MongoDB by using a
paging technique. Spring Batch provides a <code>MongoItemReaderBuilder</code> to construct an
instance of the <code>MongoItemReader</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="hibernateCursorItemReader"><a class="anchor" href="#hibernateCursorItemReader"></a><code>HibernateCursorItemReader</code></h5>
<div class="paragraph">
<p>The <code>HibernateCursorItemReader</code> is an <code>ItemStreamReader</code> for reading database records
built on top of Hibernate. It executes the HQL query and then, when initialized, iterates
over the result set as the <code>read()</code> method is called, successively returning an object
corresponding to the current row. Spring Batch provides a
<code>HibernateCursorItemReaderBuilder</code> to construct an instance of the
<code>HibernateCursorItemReader</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="hibernatePagingItemReader"><a class="anchor" href="#hibernatePagingItemReader"></a><code>HibernatePagingItemReader</code></h5>
<div class="paragraph">
<p>The <code>HibernatePagingItemReader</code> is an <code>ItemReader</code> for reading database records built on
top of Hibernate and reading only up to a fixed number of items at a time. Spring Batch
provides a <code>HibernatePagingItemReaderBuilder</code> to construct an instance of the
<code>HibernatePagingItemReader</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="repositoryItemReader"><a class="anchor" href="#repositoryItemReader"></a><code>RepositoryItemReader</code></h5>
<div class="paragraph">
<p>The <code>RepositoryItemReader</code> is an <code>ItemReader</code> that reads records by using a
<code>PagingAndSortingRepository</code>. Spring Batch provides a <code>RepositoryItemReaderBuilder</code> to
construct an instance of the <code>RepositoryItemReader</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="databaseWriters"><a class="anchor" href="#databaseWriters"></a>6.15.4. Database Writers</h4>
<div class="paragraph">
<p>Spring Batch offers the following database writers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#neo4jItemWriter"><code>Neo4jItemWriter</code></a></p>
</li>
<li>
<p><a href="#mongoItemWriter"><code>MongoItemWriter</code></a></p>
</li>
<li>
<p><a href="#repositoryItemWriter"><code>RepositoryItemWriter</code></a></p>
</li>
<li>
<p><a href="#hibernateItemWriter"><code>HibernateItemWriter</code></a></p>
</li>
<li>
<p><a href="#jdbcBatchItemWriter"><code>JdbcBatchItemWriter</code></a></p>
</li>
<li>
<p><a href="#jpaItemWriter"><code>JpaItemWriter</code></a></p>
</li>
<li>
<p><a href="#gemfireItemWriter"><code>GemfireItemWriter</code></a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="neo4jItemWriter"><a class="anchor" href="#neo4jItemWriter"></a><code>Neo4jItemWriter</code></h5>
<div class="paragraph">
<p>The <code>Neo4jItemWriter</code> is an <code>ItemWriter</code> implementation that writes to a Neo4j database.
Spring Batch provides a <code>Neo4jItemWriterBuilder</code> to construct an instance of the
<code>Neo4jItemWriter</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="mongoItemWriter"><a class="anchor" href="#mongoItemWriter"></a><code>MongoItemWriter</code></h5>
<div class="paragraph">
<p>The <code>MongoItemWriter</code> is an <code>ItemWriter</code> implementation that writes to a MongoDB store
using an implementation of Spring Data&#8217;s <code>MongoOperations</code>. Spring Batch provides a
<code>MongoItemWriterBuilder</code> to construct an instance of the <code>MongoItemWriter</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="repositoryItemWriter"><a class="anchor" href="#repositoryItemWriter"></a><code>RepositoryItemWriter</code></h5>
<div class="paragraph">
<p>The <code>RepositoryItemWriter</code> is an <code>ItemWriter</code> wrapper for a <code>CrudRepository</code> from Spring
Data. Spring Batch provides a <code>RepositoryItemWriterBuilder</code> to construct an instance of
the <code>RepositoryItemWriter</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="hibernateItemWriter"><a class="anchor" href="#hibernateItemWriter"></a><code>HibernateItemWriter</code></h5>
<div class="paragraph">
<p>The <code>HibernateItemWriter</code> is an <code>ItemWriter</code> that uses a Hibernate session to save or
update entities that are not part of the current Hibernate session. Spring Batch provides
a <code>HibernateItemWriterBuilder</code> to construct an instance of the <code>HibernateItemWriter</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="jdbcBatchItemWriter"><a class="anchor" href="#jdbcBatchItemWriter"></a><code>JdbcBatchItemWriter</code></h5>
<div class="paragraph">
<p>The <code>JdbcBatchItemWriter</code> is an <code>ItemWriter</code> that uses the batching features from
<code>NamedParameterJdbcTemplate</code> to execute a batch of statements for all items provided.
Spring Batch provides a <code>JdbcBatchItemWriterBuilder</code> to construct an instance of the
<code>JdbcBatchItemWriter</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="jpaItemWriter"><a class="anchor" href="#jpaItemWriter"></a><code>JpaItemWriter</code></h5>
<div class="paragraph">
<p>The <code>JpaItemWriter</code> is an <code>ItemWriter</code> that uses a JPA <code>EntityManagerFactory</code> to merge
any entities that are not part of the persistence context. Spring Batch provides a
<code>JpaItemWriterBuilder</code> to construct an instance of the <code>JpaItemWriter</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="gemfireItemWriter"><a class="anchor" href="#gemfireItemWriter"></a><code>GemfireItemWriter</code></h5>
<div class="paragraph">
<p>The <code>GemfireItemWriter</code> is an <code>ItemWriter</code> that uses a <code>GemfireTemplate</code> that stores
items in GemFire as key/value pairs. Spring Batch provides a <code>GemfireItemWriterBuilder</code>
to construct an instance of the <code>GemfireItemWriter</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="specializedReaders"><a class="anchor" href="#specializedReaders"></a>6.15.5. Specialized Readers</h4>
<div class="paragraph">
<p>Spring Batch offers the following specialized readers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#ldifReader"><code>LdifReader</code></a></p>
</li>
<li>
<p><a href="#mappingLdifReader"><code>MappingLdifReader</code></a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="ldifReader"><a class="anchor" href="#ldifReader"></a><code>LdifReader</code></h5>
<div class="paragraph">
<p>The <code>LdifReader</code> reads LDIF (LDAP Data Interchange Format) records from a <code>Resource</code>,
parses them, and returns a <code>LdapAttribute</code> object for each <code>read</code> executed. Spring Batch
provides a <code>LdifReaderBuilder</code> to construct an instance of the <code>LdifReader</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="mappingLdifReader"><a class="anchor" href="#mappingLdifReader"></a><code>MappingLdifReader</code></h5>
<div class="paragraph">
<p>The <code>MappingLdifReader</code> reads LDIF (LDAP Data Interchange Format) records from a
<code>Resource</code>, parses them then maps each LDIF record to a POJO (Plain Old Java Object).
Each read returns a POJO. Spring Batch provides a <code>MappingLdifReaderBuilder</code> to construct
an instance of the <code>MappingLdifReader</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="specializedWriters"><a class="anchor" href="#specializedWriters"></a>6.15.6. Specialized Writers</h4>
<div class="paragraph">
<p>Spring Batch offers the following specialized writers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#simpleMailMessageItemWriter"><code>SimpleMailMessageItemWriter</code></a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="simpleMailMessageItemWriter"><a class="anchor" href="#simpleMailMessageItemWriter"></a><code>SimpleMailMessageItemWriter</code></h5>
<div class="paragraph">
<p>The <code>SimpleMailMessageItemWriter</code> is an <code>ItemWriter</code> that can send mail messages. It
delegates the actual sending of messages to an instance of <code>MailSender</code>. Spring Batch
provides a <code>SimpleMailMessageItemWriterBuilder</code> to construct an instance of the
<code>SimpleMailMessageItemWriter</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="specializedProcessors"><a class="anchor" href="#specializedProcessors"></a>6.15.7. Specialized Processors</h4>
<div class="paragraph">
<p>Spring Batch offers the following specialized processors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#scriptItemProcessor"><code>ScriptItemProcessor</code></a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="scriptItemProcessor"><a class="anchor" href="#scriptItemProcessor"></a><code>ScriptItemProcessor</code></h5>
<div class="paragraph">
<p>The <code>ScriptItemProcessor</code> is an <code>ItemProcessor</code> that passes the current item to process
to the provided script and the result of the script is returned by the processor. Spring
Batch provides a <code>ScriptItemProcessorBuilder</code> to construct an instance of the
<code>ScriptItemProcessor</code>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scalability"><a class="anchor" href="#scalability"></a>7. Scaling and Parallel Processing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Many batch processing problems can be solved with single threaded, single process jobs,
so it is always a good idea to properly check if that meets your needs before thinking
about more complex implementations. Measure the performance of a realistic job and see if
the simplest implementation meets your needs first. You can read and write a file of
several hundred megabytes in well under a minute, even with standard hardware.</p>
</div>
<div class="paragraph">
<p>When you are ready to start implementing a job with some parallel processing, Spring
Batch offers a range of options, which are described in this chapter, although some
features are covered elsewhere. At a high level, there are two modes of parallel
processing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Single process, multi-threaded</p>
</li>
<li>
<p>Multi-process</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These break down into categories as well, as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Multi-threaded Step (single process)</p>
</li>
<li>
<p>Parallel Steps (single process)</p>
</li>
<li>
<p>Remote Chunking of Step (multi process)</p>
</li>
<li>
<p>Partitioning a Step (single or multi process)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>First, we review the single-process options. Then we review the multi-process options.</p>
</div>
<div class="sect2">
<h3 id="multithreadedStep"><a class="anchor" href="#multithreadedStep"></a>7.1. Multi-threaded Step</h3>
<div class="paragraph">
<p>The simplest way to start parallel processing is to add a <code>TaskExecutor</code> to your Step
configuration.</p>
</div>
<div class="paragraph xmlContent">
<p>For example, you might add an attribute of the <code>tasklet</code>, as shown in the
following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loading</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet</span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>...<span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>When using java configuration, a <code>TaskExecutor</code> can be added to the step
as shown in the following example:</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> TaskExecutor taskExecutor(){
    <span class="keyword">return</span> <span class="keyword">new</span> SimpleAsyncTaskExecutor(<span class="string"><span class="delimiter">&quot;</span><span class="content">spring_batch</span><span class="delimiter">&quot;</span></span>);
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step sampleStep(TaskExecutor taskExecutor) {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleStep</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                                .reader(itemReader())
                                .writer(itemWriter())
                                .taskExecutor(taskExecutor)
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>taskExecutor</code> is a reference to another bean definition that
implements the <code>TaskExecutor</code> interface.
<a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/task/TaskExecutor.html"><code>TaskExecutor</code></a>
is a standard Spring interface, so consult the Spring User Guide for details of available
implementations. The simplest multi-threaded <code>TaskExecutor</code> is a
<code>SimpleAsyncTaskExecutor</code>.</p>
</div>
<div class="paragraph">
<p>The result of the above configuration is that the <code>Step</code> executes by reading, processing,
and writing each chunk of items (each commit interval) in a separate thread of execution.
Note that this means there is no fixed order for the items to be processed, and a chunk
might contain items that are non-consecutive compared to the single-threaded case. In
addition to any limits placed by the task executor (such as whether it is backed by a
thread pool), there is a throttle limit in the tasklet configuration which defaults to 4.
You may need to increase this to ensure that a thread pool is fully utilized.</p>
</div>
<div class="paragraph xmlContent">
<p>For example you might increase the throttle-limit, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loading</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="tag">&lt;tasklet</span>
    <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">throttle-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>...<span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>When using java configuration, the builders provide access to the throttle limit:</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step sampleStep(TaskExecutor taskExecutor) {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleStep</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                                .reader(itemReader())
                                .writer(itemWriter())
                                .taskExecutor(taskExecutor)
                                .throttleLimit(<span class="integer">20</span>)
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note also that there may be limits placed on concurrency by any pooled resources used in
your step, such as a <code>DataSource</code>.  Be sure to make the pool in those resources at least
as large as the desired number of concurrent threads in the step.</p>
</div>
<div class="paragraph">
<p>There are some practical limitations of using multi-threaded <code>Step</code> implementations for
some common batch use cases. Many participants in a <code>Step</code> (such as readers and writers)
are stateful. If the state is not segregated by thread, then those components are not
usable in a multi-threaded <code>Step</code>. In particular, most of the off-the-shelf readers and
writers from Spring Batch are not designed for multi-threaded use. It is, however,
possible to work with stateless or thread safe readers and writers, and there is a sample
(called <code>parallelJob</code>) in the
<a href="https://github.com/spring-projects/spring-batch/tree/master/spring-batch-samples">Spring
Batch Samples</a> that shows the use of a process indicator (see
<a href="#process-indicator">Preventing State Persistence</a>) to keep track
of items that have been processed in a database input table.</p>
</div>
<div class="paragraph">
<p>Spring Batch provides some implementations of <code>ItemWriter</code> and <code>ItemReader</code>.  Usually,
they say in the Javadoc if they are thread safe or not or what you have to do to avoid
problems in a concurrent environment.  If there is no information in the Javadoc, you can
check the implementation to see if there is any state.  If a reader is not thread safe,
you can decorate it with the provided <code>SynchronizedItemStreamReader</code> or use it in your own
synchronizing delegator. You can synchronize the call to <code>read()</code> and as long as the
processing and writing is the most expensive part of the chunk, your step may still
complete much faster than it would in a single threaded configuration.</p>
</div>
</div>
<div class="sect2">
<h3 id="scalabilityParallelSteps"><a class="anchor" href="#scalabilityParallelSteps"></a>7.2. Parallel Steps</h3>
<div class="paragraph">
<p>As long as the application logic that needs to be parallelized can be split into distinct
responsibilities and assigned to individual steps, then it can be parallelized in a
single process. Parallel Step execution is easy to configure and use.</p>
</div>
<div class="paragraph xmlContent">
<p>For example, executing steps <code>(step1,step2)</code> in parallel with <code>step3</code> is straightforward,
as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;split</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">split1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;flow&gt;</span>
            <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/flow&gt;</span>
        <span class="tag">&lt;flow&gt;</span>
            <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/flow&gt;</span>
    <span class="tag">&lt;/split&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/job&gt;</span>

<span class="tag">&lt;beans:bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...SimpleAsyncTaskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>When using java configuration, executing steps <code>(step1,step2)</code> in parallel with <code>step3</code>
is straightforward, as shown in the following example:</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job() {
    <span class="keyword">return</span> jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
        .start(splitFlow())
        .next(step4())
        .build()        <span class="comment">//builds FlowJobBuilder instance</span>
        .build();       <span class="comment">//builds Job instance</span>
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Flow splitFlow() {
    <span class="keyword">return</span> <span class="keyword">new</span> FlowBuilder&lt;SimpleFlow&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">splitFlow</span><span class="delimiter">&quot;</span></span>)
        .split(taskExecutor())
        .add(flow1(), flow2())
        .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Flow flow1() {
    <span class="keyword">return</span> <span class="keyword">new</span> FlowBuilder&lt;SimpleFlow&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">flow1</span><span class="delimiter">&quot;</span></span>)
        .start(step1())
        .next(step2())
        .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Flow flow2() {
    <span class="keyword">return</span> <span class="keyword">new</span> FlowBuilder&lt;SimpleFlow&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">flow2</span><span class="delimiter">&quot;</span></span>)
        .start(step3())
        .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> TaskExecutor taskExecutor(){
    <span class="keyword">return</span> <span class="keyword">new</span> SimpleAsyncTaskExecutor(<span class="string"><span class="delimiter">&quot;</span><span class="content">spring_batch</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configurable task executor is used to specify which <code>TaskExecutor</code>
implementation should be used to execute the individual flows. The default is
<code>SyncTaskExecutor</code>, but an asynchronous <code>TaskExecutor</code> is required to run the steps in
parallel. Note that the job ensures that every flow in the split completes before
aggregating the exit statuses and transitioning.</p>
</div>
<div class="paragraph">
<p>See the section on <a href="#split-flows">Split Flows</a> for more detail.</p>
</div>
</div>
<div class="sect2">
<h3 id="remoteChunking"><a class="anchor" href="#remoteChunking"></a>7.3. Remote Chunking</h3>
<div class="paragraph">
<p>In remote chunking, the <code>Step</code> processing is split across multiple processes,
communicating with each other through some middleware. The following image shows the
pattern:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/remote-chunking.png" alt="Remote Chunking">
</div>
<div class="title">Figure 22. Remote Chunking</div>
</div>
<div class="paragraph">
<p>The master component is a single process, and the slaves are multiple remote processes.
This pattern works best if the master is not a bottleneck, so the processing must be more
expensive than the reading of items (as is often the case in practice).</p>
</div>
<div class="paragraph">
<p>The master is an implementation of a Spring Batch <code>Step</code> with the <code>ItemWriter</code> replaced
by a generic version that knows how to send chunks of items to the middleware as
messages. The slaves are standard listeners for whatever middleware is being used (for
example, with JMS, they would be <code>MesssageListener</code> implementations), and their role is
to process the chunks of items using a standard <code>ItemWriter</code> or <code>ItemProcessor</code> plus
<code>ItemWriter</code>, through the <code>ChunkProcessor</code> interface. One of the advantages of using this
pattern is that the reader, processor, and writer components are off-the-shelf (the same
as would be used for a local execution of the step). The items are divided up dynamically
and work is shared through the middleware, so that, if the listeners are all eager
consumers, then load balancing is automatic.</p>
</div>
<div class="paragraph">
<p>The middleware has to be durable, with guaranteed delivery and a single consumer for each
message. JMS is the obvious candidate, but other options (such as JavaSpaces) exist in
the grid computing and shared memory product space.</p>
</div>
<div class="paragraph">
<p>See the section on
<a href="#remote-chunking">Spring Batch Integration - Remote Chunking</a>
for more detail.</p>
</div>
</div>
<div class="sect2">
<h3 id="partitioning"><a class="anchor" href="#partitioning"></a>7.4. Partitioning</h3>
<div class="paragraph">
<p>Spring Batch also provides an SPI for partitioning a <code>Step</code> execution and executing it
remotely. In this case, the remote participants are <code>Step</code> instances that could just as
easily have been configured and used for local processing. The following image shows the
pattern:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/partitioning-overview.png" alt="Partitioning Overview">
</div>
<div class="title">Figure 23. Partitioning</div>
</div>
<div class="paragraph">
<p>The <code>Job</code> runs on the left-hand side as a sequence of <code>Step</code> instances, and one of the
<code>Step</code> instances is labeled as a master. The slaves in this picture are all identical
instances of a <code>Step</code>, which could in fact take the place of the master, resulting in the
same outcome for the <code>Job</code>. The slaves are typically going to be remote services but
could also be local threads of execution. The messages sent by the master to the slaves
in this pattern do not need to be durable or have guaranteed delivery. Spring Batch
metadata in the <code>JobRepository</code> ensures that each slave is executed once and only once for
each <code>Job</code> execution.</p>
</div>
<div class="paragraph">
<p>The SPI in Spring Batch consists of a special implementation of <code>Step</code> (called the
<code>PartitionStep</code>) and two strategy interfaces that need to be implemented for the specific
environment. The strategy interfaces are <code>PartitionHandler</code> and <code>StepExecutionSplitter</code>,
and their role is shown in the following sequence diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/partitioning-spi.png" alt="Partitioning SPI">
</div>
<div class="title">Figure 24. Partitioning SPI</div>
</div>
<div class="paragraph">
<p>The <code>Step</code> on the right in this case is the "remote" slave, so, potentially, there are
many objects and or processes playing this role, and the <code>PartitionStep</code> is shown driving
the execution.</p>
</div>
<div class="paragraph xmlContent">
<p>The following example shows the <code>PartitionStep</code> configuration:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1.master</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;partition</span> <span class="attribute-name">step</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">partitioner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">partitioner</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;handler</span> <span class="attribute-name">grid-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/partition&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>The following example shows the <code>PartitionStep</code> configuration using java configuration:</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1Master() {
    <span class="keyword">return</span> stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1.master</span><span class="delimiter">&quot;</span></span>)
        .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;partitioner(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>, partitioner())
        .step(step1())
        .gridSize(<span class="integer">10</span>)
        .taskExecutor(taskExecutor())
        .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to the multi-threaded step&#8217;s <code>throttle-limit</code> attribute, the <code>grid-size</code>
attribute prevents the task executor from being saturated with requests from a single
step.</p>
</div>
<div class="paragraph">
<p>There is a simple example that can be copied and extended in the unit test suite for
<a href="https://github.com/spring-projects/spring-batch/tree/master/spring-batch-samples/src/main/resources/jobs">Spring
Batch Samples</a> (see <code>Partition*Job.xml</code> configuration).</p>
</div>
<div class="paragraph">
<p>Spring Batch creates step executions for the partitions called "step1:partition0", and so
on. Many people prefer to call the master step "step1:master" for consistency. You can
use an alias for the step (by specifying the <code>name</code> attribute instead of the <code>id</code>
attribute).</p>
</div>
<div class="sect3">
<h4 id="partitionHandler"><a class="anchor" href="#partitionHandler"></a>7.4.1. PartitionHandler</h4>
<div class="paragraph">
<p>The <code>PartitionHandler</code> is the component that knows about the fabric of the remoting or
grid environment. It is able to send <code>StepExecution</code> requests to the remote <code>Step</code>
instances, wrapped in some fabric-specific format, like a DTO. It does not have to know
how to split the input data or how to aggregate the result of multiple <code>Step</code> executions.
Generally speaking, it probably also does not need to know about resilience or failover,
since those are features of the fabric in many cases. In any case, Spring Batch always
provides restartability independent of the fabric. A failed <code>Job</code> can always be restarted
and only the failed <code>Steps</code> are re-executed.</p>
</div>
<div class="paragraph">
<p>The <code>PartitionHandler</code> interface can have specialized implementations for a variety of
fabric types, including simple RMI remoting, EJB remoting, custom web service, JMS, Java
Spaces, shared memory grids (like Terracotta or Coherence), and grid execution fabrics
(like GridGain). Spring Batch does not contain implementations for any proprietary grid
or remoting fabrics.</p>
</div>
<div class="paragraph">
<p>Spring Batch does, however, provide a useful implementation of <code>PartitionHandler</code> that
executes <code>Step</code> instances locally in separate threads of execution, using the
<code>TaskExecutor</code> strategy from Spring. The implementation is called
<code>TaskExecutorPartitionHandler</code>.</p>
</div>
<div class="paragraph xmlContent">
<p>The <code>TaskExecutorPartitionHandler</code> is the default for a step configured with the XML
namespace shown previously. It can also be configured explicitly, as shown in the
following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1.master</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;partition</span> <span class="attribute-name">step</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">handler</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">handler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/step&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...TaskExecutorPartitionHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gridSize</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>The <code>TaskExecutorPartitionHandler</code> can be configured explicitly within java configuration,
as shown in the following example:</p>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1Master() {
    <span class="keyword">return</span> stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1.master</span><span class="delimiter">&quot;</span></span>)
        .partitioner(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>, partitioner())
        .partitionHandler(partitionHandler())
        .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> PartitionHandler partitionHandler() {
    TaskExecutorPartitionHandler retVal = <span class="keyword">new</span> TaskExecutorPartitionHandler();
    retVal.setTaskExecutor(taskExecutor());
    retVal.setStep(step1());
    retVal.setGridSize(<span class="integer">10</span>);
    <span class="keyword">return</span> retVal;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>gridSize</code> attribute determines the number of separate step executions to create, so
it can be matched to the size of the thread pool in the <code>TaskExecutor</code>. Alternatively, it
can be set to be larger than the number of threads available, which makes the blocks of
work smaller.</p>
</div>
<div class="paragraph">
<p>The <code>TaskExecutorPartitionHandler</code> is useful for IO-intensive <code>Step</code> instances, such as
copying large numbers of files or replicating filesystems into content management
systems. It can also be used for remote execution by providing a <code>Step</code> implementation
that is a proxy for a remote invocation (such as using Spring Remoting).</p>
</div>
</div>
<div class="sect3">
<h4 id="stepExecutionSplitter"><a class="anchor" href="#stepExecutionSplitter"></a>7.4.2. Partitioner</h4>
<div class="paragraph">
<p>The <code>Partitioner</code> has a simpler responsibility: to generate execution contexts as input
parameters for new step executions only (no need to worry about restarts). It has a
single method, as shown in the following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Partitioner</span> {
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ExecutionContext&gt; partition(<span class="type">int</span> gridSize);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The return value from this method associates a unique name for each step execution (the
<code>String</code>) with input parameters in the form of an <code>ExecutionContext</code>. The names show up
later in the Batch metadata as the step name in the partitioned <code>StepExecutions</code>. The
<code>ExecutionContext</code> is just a bag of name-value pairs, so it might contain a range of
primary keys, line numbers, or the location of an input file. The remote <code>Step</code> then
normally binds to the context input using <code>#{&#8230;&#8203;}</code> placeholders (late binding in step
scope), as illustrated in the next section.</p>
</div>
<div class="paragraph">
<p>The names of the step executions (the keys in the <code>Map</code> returned by <code>Partitioner</code>) need
to be unique amongst the step executions of a <code>Job</code> but do not have any other specific
requirements. The easiest way to do this (and to make the names meaningful for users) is
to use a prefix+suffix naming convention, where the prefix is the name of the step that
is being executed (which itself is unique in the <code>Job</code>), and the suffix is just a
counter. There is a <code>SimplePartitioner</code> in the framework that uses this convention.</p>
</div>
<div class="paragraph">
<p>An optional interface called <code>PartitionNameProvider</code> can be used to provide the partition
names separately from the partitions themselves. If a <code>Partitioner</code> implements this
interface, then, on a restart, only the names are queried. If partitioning is expensive,
this can be a useful optimization. The names provided by the <code>PartitionNameProvider</code> must
match those provided by the <code>Partitioner</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="bindingInputDataToSteps"><a class="anchor" href="#bindingInputDataToSteps"></a>7.4.3. Binding Input Data to Steps</h4>
<div class="paragraph">
<p>It is very efficient for the steps that are executed by the <code>PartitionHandler</code> to have
identical configuration and for their input parameters to be bound at runtime from the
<code>ExecutionContext</code>. This is easy to do with the StepScope feature of Spring Batch
(covered in more detail in the section on <a href="#late-binding">Late Binding</a>). For
example, if the <code>Partitioner</code> creates <code>ExecutionContext</code> instances with an attribute key
called <code>fileName</code>, pointing to a different file (or directory) for each step invocation,
the <code>Partitioner</code> output might resemble the content of the following table:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 17. Example step execution name to execution context provided by <code>Partitioner</code> targeting directory processing</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Step Execution Name (key)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>ExecutionContext (value)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">filecopy:partition0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fileName=/home/data/one</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">filecopy:partition1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fileName=/home/data/two</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">filecopy:partition2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fileName=/home/data/three</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Then the file name can be bound to a step using late binding to the execution context, as
shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...MultiResourceItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resources</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{stepExecutionContext[fileName]}/*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> MultiResourceItemReader itemReader(
        <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{stepExecutionContext['fileName']}/*</span><span class="delimiter">&quot;</span></span>) Resource <span class="type">[]</span> resources) {
        <span class="keyword">return</span> <span class="keyword">new</span> MultiResourceItemReaderBuilder&lt;<span class="predefined-type">String</span>&gt;()
                        .delegate(fileReader())
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span>)
                        .resources(resources)
                        .build();
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repeat"><a class="anchor" href="#repeat"></a>8. Repeat</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="repeatTemplate"><a class="anchor" href="#repeatTemplate"></a>8.1. RepeatTemplate</h3>
<div class="paragraph">
<p>Batch processing is about repetitive actions, either as a simple optimization or as part
of a job. To strategize and generalize the repetition and to provide what amounts to an
iterator framework, Spring Batch has the <code>RepeatOperations</code> interface. The
<code>RepeatOperations</code> interface has the following definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">RepeatOperations</span> {

    RepeatStatus iterate(RepeatCallback callback) <span class="directive">throws</span> RepeatException;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The callback is an interface, shown in the following definition, that lets you insert
some business logic to be repeated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">RepeatCallback</span> {

    RepeatStatus doInIteration(RepeatContext context) <span class="directive">throws</span> <span class="exception">Exception</span>;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The callback is executed repeatedly until the implementation determines that the
iteration should end. The return value in these interfaces is an enumeration that can
either be <code>RepeatStatus.CONTINUABLE</code> or <code>RepeatStatus.FINISHED</code>. A <code>RepeatStatus</code>
enumeration conveys information to the caller of the repeat operations about whether
there is any more work to do. Generally speaking, implementations of <code>RepeatOperations</code>
should inspect the <code>RepeatStatus</code> and use it as part of the decision to end the
iteration. Any callback that wishes to signal to the caller that there is no more work to
do can return <code>RepeatStatus.FINISHED</code>.</p>
</div>
<div class="paragraph">
<p>The simplest general purpose implementation of <code>RepeatOperations</code> is <code>RepeatTemplate</code>, as
shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RepeatTemplate template = <span class="keyword">new</span> RepeatTemplate();

template.setCompletionPolicy(<span class="keyword">new</span> SimpleCompletionPolicy(<span class="integer">2</span>));

template.iterate(<span class="keyword">new</span> RepeatCallback() {

    <span class="directive">public</span> RepeatStatus doInIteration(RepeatContext context) {
        <span class="comment">// Do stuff in batch...</span>
        <span class="keyword">return</span> RepeatStatus.CONTINUABLE;
    }

});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, we return <code>RepeatStatus.CONTINUABLE</code>, to show that there is
more work to do. The callback can also return <code>RepeatStatus.FINISHED</code>, to signal to the
caller that there is no more work to do. Some iterations can be terminated by
considerations intrinsic to the work being done in the callback. Others are effectively
infinite loops as far as the callback is concerned and the completion decision is
delegated to an external policy, as in the case shown in the preceding example.</p>
</div>
<div class="sect3">
<h4 id="repeatContext"><a class="anchor" href="#repeatContext"></a>8.1.1. RepeatContext</h4>
<div class="paragraph">
<p>The method parameter for the <code>RepeatCallback</code> is a <code>RepeatContext</code>. Many callbacks ignore
the context. However, if necessary, it can be used as an attribute bag to store transient
data for the duration of the iteration. After the <code>iterate</code> method returns, the context
no longer exists.</p>
</div>
<div class="paragraph">
<p>If there is a nested iteration in progress, a <code>RepeatContext</code> has a parent context. The
parent context is occasionally useful for storing data that need to be shared between
calls to <code>iterate</code>. This is the case, for instance, if you want to count the number of
occurrences of an event in the iteration and remember it across subsequent calls.</p>
</div>
</div>
<div class="sect3">
<h4 id="repeatStatus"><a class="anchor" href="#repeatStatus"></a>8.1.2. RepeatStatus</h4>
<div class="paragraph">
<p><code>RepeatStatus</code> is an enumeration used by Spring Batch to indicate whether processing has
finished. It has two possible <code>RepeatStatus</code> values, described in the following table:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 18. RepeatStatus Properties</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONTINUABLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">There is more work to do.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FINISHED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No more repetitions should take place.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>RepeatStatus</code> values can also be combined with a logical AND operation by using the
<code>and()</code> method in <code>RepeatStatus</code>. The effect of this is to do a logical AND on the
continuable flag. In other words, if either status is <code>FINISHED</code>, then the result is
<code>FINISHED</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="completionPolicies"><a class="anchor" href="#completionPolicies"></a>8.2. Completion Policies</h3>
<div class="paragraph">
<p>Inside a <code>RepeatTemplate</code>, the termination of the loop in the <code>iterate</code> method is
determined by a <code>CompletionPolicy</code>, which is also a factory for the <code>RepeatContext</code>. The
<code>RepeatTemplate</code> has the responsibility to use the current policy to create a
<code>RepeatContext</code> and pass that in to the <code>RepeatCallback</code> at every stage in the iteration.
After a callback completes its <code>doInIteration</code>, the <code>RepeatTemplate</code> has to make a call
to the <code>CompletionPolicy</code> to ask it to update its state (which will be stored in the
<code>RepeatContext</code>). Then it asks the policy if the iteration is complete.</p>
</div>
<div class="paragraph">
<p>Spring Batch provides some simple general purpose implementations of <code>CompletionPolicy</code>.
<code>SimpleCompletionPolicy</code> allows execution up to a fixed number of times (with
<code>RepeatStatus.FINISHED</code> forcing early completion at any time).</p>
</div>
<div class="paragraph">
<p>Users might need to implement their own completion policies for more complicated
decisions. For example, a batch processing window that prevents batch jobs from executing
once the online systems are in use would require a custom policy.</p>
</div>
</div>
<div class="sect2">
<h3 id="repeatExceptionHandling"><a class="anchor" href="#repeatExceptionHandling"></a>8.3. Exception Handling</h3>
<div class="paragraph">
<p>If there is an exception thrown inside a <code>RepeatCallback</code>, the <code>RepeatTemplate</code> consults
an <code>ExceptionHandler</code>, which can decide whether or not to re-throw the exception.</p>
</div>
<div class="paragraph">
<p>The following listing shows the <code>ExceptionHandler</code> interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ExceptionHandler</span> {

    <span class="type">void</span> handleException(RepeatContext context, <span class="predefined-type">Throwable</span> throwable)
        <span class="directive">throws</span> <span class="predefined-type">Throwable</span>;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A common use case is to count the number of exceptions of a given type and fail when a
limit is reached. For this purpose, Spring Batch provides the
<code>SimpleLimitExceptionHandler</code> and a slightly more flexible
<code>RethrowOnThresholdExceptionHandler</code>. The <code>SimpleLimitExceptionHandler</code> has a limit
property and an exception type that should be compared with the current exception. All
subclasses of the provided type are also counted. Exceptions of the given type are
ignored until the limit is reached, and then they are rethrown. Exceptions of other types
are always rethrown.</p>
</div>
<div class="paragraph">
<p>An important optional property of the <code>SimpleLimitExceptionHandler</code> is the boolean flag
called <code>useParent</code>. It is <code>false</code> by default, so the limit is only accounted for in the
current <code>RepeatContext</code>. When set to <code>true</code>, the limit is kept across sibling contexts in
a nested iteration (such as a set of chunks inside a step).</p>
</div>
</div>
<div class="sect2">
<h3 id="repeatListeners"><a class="anchor" href="#repeatListeners"></a>8.4. Listeners</h3>
<div class="paragraph">
<p>Often, it is useful to be able to receive additional callbacks for cross-cutting concerns
across a number of different iterations. For this purpose, Spring Batch provides the
<code>RepeatListener</code> interface. The <code>RepeatTemplate</code> lets users register <code>RepeatListener</code>
implementations, and they are given callbacks with the <code>RepeatContext</code> and <code>RepeatStatus</code>
where available during the iteration.</p>
</div>
<div class="paragraph">
<p>The <code>RepeatListener</code> interface has the following definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">RepeatListener</span> {
    <span class="type">void</span> before(RepeatContext context);
    <span class="type">void</span> after(RepeatContext context, RepeatStatus result);
    <span class="type">void</span> open(RepeatContext context);
    <span class="type">void</span> onError(RepeatContext context, <span class="predefined-type">Throwable</span> e);
    <span class="type">void</span> close(RepeatContext context);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>open</code> and <code>close</code> callbacks come before and after the entire iteration. <code>before</code>,
<code>after</code>, and <code>onError</code> apply to the individual <code>RepeatCallback</code> calls.</p>
</div>
<div class="paragraph">
<p>Note that, when there is more than one listener, they are in a list, so there is an
order. In this case, <code>open</code> and <code>before</code> are called in the same order while <code>after</code>,
<code>onError</code>, and <code>close</code> are called in reverse order.</p>
</div>
</div>
<div class="sect2">
<h3 id="repeatParallelProcessing"><a class="anchor" href="#repeatParallelProcessing"></a>8.5. Parallel Processing</h3>
<div class="paragraph">
<p>Implementations of <code>RepeatOperations</code> are not restricted to executing the callback
sequentially. It is quite important that some implementations are able to execute their
callbacks in parallel. To this end, Spring Batch provides the
<code>TaskExecutorRepeatTemplate</code>, which uses the Spring <code>TaskExecutor</code> strategy to run the
<code>RepeatCallback</code>. The default is to use a <code>SynchronousTaskExecutor</code>, which has the effect
of executing the whole iteration in the same thread (the same as a normal
<code>RepeatTemplate</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="declarativeIteration"><a class="anchor" href="#declarativeIteration"></a>8.6. Declarative Iteration</h3>
<div class="paragraph">
<p>Sometimes there is some business processing that you know you want to repeat every time
it happens. The classic example of this is the optimization of a message pipeline. It is
more efficient to process a batch of messages, if they are arriving frequently, than to
bear the cost of a separate transaction for every message. Spring Batch provides an AOP
interceptor that wraps a method call in a <code>RepeatOperations</code> object for just this
purpose. The <code>RepeatOperationsInterceptor</code> executes the intercepted method and repeats
according to the <code>CompletionPolicy</code> in the provided <code>RepeatTemplate</code>.</p>
</div>
<div class="paragraph xmlContent">
<p>The following example shows declarative iteration using the Spring AOP namespace to
repeat a service call to a method called <code>processMessage</code> (for more detail on how to
configure AOP interceptors, see the Spring User Guide):</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;aop:config&gt;</span>
    <span class="tag">&lt;aop:pointcut</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactional</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">expression</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">execution(* com..*Service.processMessage(..))</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;aop:advisor</span> <span class="attribute-name">pointcut-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactional</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">advice-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retryAdvice</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">order</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/aop:config&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retryAdvice</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...RepeatOperationsInterceptor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>The following example demonstrates using java configuration to
repeat a service call to a method called <code>processMessage</code> (for more detail on how to
configure AOP interceptors, see the Spring User Guide):</p>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> MyService myService() {
        ProxyFactory factory = <span class="keyword">new</span> ProxyFactory(RepeatOperations.class.getClassLoader());
        factory.setInterfaces(MyService.class);
        factory.setTarget(<span class="keyword">new</span> MyService());

        MyService service = (MyService) factory.getProxy();
        JdkRegexpMethodPointcut pointcut = <span class="keyword">new</span> JdkRegexpMethodPointcut();
        pointcut.setPatterns(<span class="string"><span class="delimiter">&quot;</span><span class="content">.*processMessage.*</span><span class="delimiter">&quot;</span></span>);

        RepeatOperationsInterceptor interceptor = <span class="keyword">new</span> RepeatOperationsInterceptor();

        ((Advised) service).addAdvisor(<span class="keyword">new</span> DefaultPointcutAdvisor(pointcut, interceptor));

        <span class="keyword">return</span> service;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding example uses a default <code>RepeatTemplate</code> inside the interceptor. To change
the policies, listeners, and other details, you can inject an instance of
<code>RepeatTemplate</code> into the interceptor.</p>
</div>
<div class="paragraph">
<p>If the intercepted method returns <code>void</code>, then the interceptor always returns
<code>RepeatStatus.CONTINUABLE</code> (so there is a danger of an infinite loop if the
<code>CompletionPolicy</code> does not have a finite end point). Otherwise, it returns
<code>RepeatStatus.CONTINUABLE</code> until the return value from the intercepted method is <code>null</code>,
at which point it returns <code>RepeatStatus.FINISHED</code>. Consequently, the business logic
inside the target method can signal that there is no more work to do by returning <code>null</code>
or by throwing an exception that is re-thrown by the <code>ExceptionHandler</code> in the provided
<code>RepeatTemplate</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="retry"><a class="anchor" href="#retry"></a>9. Retry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To make processing more robust and less prone to failure, it sometimes
    helps to automatically retry a failed operation in case it might
    succeed on a subsequent attempt. Errors that are susceptible to intermittent failure
    are often transient in nature. Examples include remote calls to a web
    service that fails because of a network glitch or a
    <code>DeadlockLoserDataAccessException</code> in a database update.</p>
</div>
<div class="sect2">
<h3 id="retryTemplate"><a class="anchor" href="#retryTemplate"></a>9.1. <code>RetryTemplate</code></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The retry functionality was pulled out of Spring Batch as of 2.2.0.
It is now part of a new library, <a href="https://github.com/spring-projects/spring-retry">Spring Retry</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To automate retry
    operations Spring Batch has the <code>RetryOperations</code>
    strategy. The following interface definition for <code>RetryOperations</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">RetryOperations</span> {

    &lt;T, E <span class="directive">extends</span> <span class="predefined-type">Throwable</span>&gt; T execute(RetryCallback&lt;T, E&gt; retryCallback) <span class="directive">throws</span> E;

    &lt;T, E <span class="directive">extends</span> <span class="predefined-type">Throwable</span>&gt; T execute(RetryCallback&lt;T, E&gt; retryCallback, RecoveryCallback&lt;T&gt; recoveryCallback)
        <span class="directive">throws</span> E;

    &lt;T, E <span class="directive">extends</span> <span class="predefined-type">Throwable</span>&gt; T execute(RetryCallback&lt;T, E&gt; retryCallback, RetryState retryState)
        <span class="directive">throws</span> E, ExhaustedRetryException;

    &lt;T, E <span class="directive">extends</span> <span class="predefined-type">Throwable</span>&gt; T execute(RetryCallback&lt;T, E&gt; retryCallback, RecoveryCallback&lt;T&gt; recoveryCallback,
        RetryState retryState) <span class="directive">throws</span> E;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The basic callback is a simple interface that lets you
    insert some business logic to be retried, as shown in the following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">RetryCallback</span>&lt;T, E <span class="directive">extends</span> <span class="predefined-type">Throwable</span>&gt; {

    T doWithRetry(RetryContext context) <span class="directive">throws</span> E;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The callback runs and, if it fails (by throwing an
    <code>Exception</code>), it is retried until either it is
    successful or the implementation aborts. There are a number of
    overloaded <code>execute</code> methods in the
    <code>RetryOperations</code> interface. Those methods deal with various use
    cases for recovery when all retry attempts are exhausted and deal with
    retry state, which allows clients and implementations to store information
    between calls (we cover this in more detail later in the chapter).</p>
</div>
<div class="paragraph">
<p>The simplest general purpose implementation of
    <code>RetryOperations</code> is
    <code>RetryTemplate</code>. It can be used as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RetryTemplate template = <span class="keyword">new</span> RetryTemplate();

TimeoutRetryPolicy policy = <span class="keyword">new</span> TimeoutRetryPolicy();
policy.setTimeout(<span class="integer">30000L</span>);

template.setRetryPolicy(policy);

Foo result = template.execute(<span class="keyword">new</span> RetryCallback&lt;Foo&gt;() {

    <span class="directive">public</span> Foo doWithRetry(RetryContext context) {
        <span class="comment">// Do stuff that might fail, e.g. webservice operation</span>
        <span class="keyword">return</span> result;
    }

});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, we make a web service call and return the result
    to the user. If that call fails, then it is retried until a timeout is
    reached.</p>
</div>
<div class="sect3">
<h4 id="retryContext"><a class="anchor" href="#retryContext"></a>9.1.1. <code>RetryContext</code></h4>
<div class="paragraph">
<p>The method parameter for the <code>RetryCallback</code>
      is a <code>RetryContext</code>. Many callbacks
      ignore the context, but, if necessary, it can be used as an attribute bag
      to store data for the duration of the iteration.</p>
</div>
<div class="paragraph">
<p>A <code>RetryContext</code> has a parent context
      if there is a nested retry in progress in the same thread. The parent
      context is occasionally useful for storing data that need to be shared
      between calls to <code>execute</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="recoveryCallback"><a class="anchor" href="#recoveryCallback"></a>9.1.2. <code>RecoveryCallback</code></h4>
<div class="paragraph">
<p>When a retry is exhausted, the
      <code>RetryOperations</code> can pass control to a different
      callback, called the <code>RecoveryCallback</code>. To use this
      feature, clients pass in the callbacks together to the same method,
      as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Foo foo = template.execute(<span class="keyword">new</span> RetryCallback&lt;Foo&gt;() {
    <span class="directive">public</span> Foo doWithRetry(RetryContext context) {
        <span class="comment">// business logic here</span>
    },
  <span class="keyword">new</span> RecoveryCallback&lt;Foo&gt;() {
    Foo recover(RetryContext context) <span class="directive">throws</span> <span class="exception">Exception</span> {
          <span class="comment">// recover logic here</span>
    }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the business logic does not succeed before the template
      decides to abort, then the client is given the chance to do some
      alternate processing through the recovery callback.</p>
</div>
</div>
<div class="sect3">
<h4 id="statelessRetry"><a class="anchor" href="#statelessRetry"></a>9.1.3. Stateless Retry</h4>
<div class="paragraph">
<p>In the simplest case, a retry is just a while loop. The
      <code>RetryTemplate</code> can just keep trying until it
      either succeeds or fails. The <code>RetryContext</code>
      contains some state to determine whether to retry or abort, but this
      state is on the stack and there is no need to store it anywhere
      globally, so we call this stateless retry. The distinction between
      stateless and stateful retry is contained in the implementation of the
      <code>RetryPolicy</code> (the
      <code>RetryTemplate</code> can handle both). In a stateless
      retry, the retry callback is always executed in the same thread it was on
      when it failed.</p>
</div>
</div>
<div class="sect3">
<h4 id="statefulRetry"><a class="anchor" href="#statefulRetry"></a>9.1.4. Stateful Retry</h4>
<div class="paragraph">
<p>Where the failure has caused a transactional resource to become
      invalid, there are some special considerations. This does not apply to a
      simple remote call because there is no transactional resource (usually),
      but it does sometimes apply to a database update, especially when using
      Hibernate. In this case it only makes sense to re-throw the exception
      that called the failure immediately, so that the transaction can roll
      back and we can start a new, valid transaction.</p>
</div>
<div class="paragraph">
<p>In cases involving transactions, a stateless retry is not good enough, because the
      re-throw and roll back necessarily involve leaving the
      <code>RetryOperations.execute()</code> method and potentially losing the
      context that was on the stack. To avoid losing it we have to introduce a
      storage strategy to lift it off the stack and put it (at a minimum) in
      heap storage. For this purpose, Spring Batch provides a storage strategy called
      <code>RetryContextCache</code>, which can be injected into the
      <code>RetryTemplate</code>. The default implementation of the
      <code>RetryContextCache</code> is in memory, using a simple
      <code>Map</code>. Advanced usage with multiple processes in a
      clustered environment might also consider implementing the
      <code>RetryContextCache</code> with a cluster cache of some
      sort (however, even in a clustered environment, this might be
      overkill).</p>
</div>
<div class="paragraph">
<p>Part of the responsibility of the
      <code>RetryOperations</code> is to recognize the failed
      operations when they come back in a new execution (and usually wrapped
      in a new transaction). To facilitate this, Spring Batch provides the
      <code>RetryState</code> abstraction. This works in conjunction
      with a special <code>execute</code> methods in the
      <code>RetryOperations</code> interface.</p>
</div>
<div class="paragraph">
<p>The way the failed operations are recognized is by identifying the
      state across multiple invocations of the retry. To identify the state,
      the user can provide a <code>RetryState</code> object that is
      responsible for returning a unique key identifying the item. The
      identifier is used as a key in the
      <code>RetryContextCache</code> interface.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Be very careful with the implementation of
        <code>Object.equals()</code> and <code>Object.hashCode()</code> in the
        key returned by <code>RetryState</code>. The best advice is
        to use a business key to identify the items. In the case of a JMS
        message, the message ID can be used.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the retry is exhausted, there is also the option to handle the
      failed item in a different way, instead of calling the
      <code>RetryCallback</code> (which is now presumed to be likely
      to fail). Just like in the stateless case, this option is provided by
      the <code>RecoveryCallback</code>, which can be provided by
      passing it in to the <code>execute</code> method of
      <code>RetryOperations</code>.</p>
</div>
<div class="paragraph">
<p>The decision to retry or not is actually delegated to a regular
      <code>RetryPolicy</code>, so the usual concerns about limits
      and timeouts can be injected there (described later in this chapter).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="retryPolicies"><a class="anchor" href="#retryPolicies"></a>9.2. Retry Policies</h3>
<div class="paragraph">
<p>Inside a <code>RetryTemplate</code>, the decision to retry
    or fail in the <code>execute</code> method is determined by a
    <code>RetryPolicy</code>, which is also a factory for the
    <code>RetryContext</code>. The
    <code>RetryTemplate</code> has the responsibility to use the
    current policy to create a <code>RetryContext</code> and pass
    that in to the <code>RetryCallback</code> at every attempt.
    After a callback fails, the <code>RetryTemplate</code> has to
    make a call to the <code>RetryPolicy</code> to ask it to update
    its state (which is stored in the
    <code>RetryContext</code>) and then asks the policy if
    another attempt can be made. If another attempt cannot be made (such as when a
    limit is reached or a timeout is detected) then the policy is also
    responsible for handling the exhausted state. Simple implementations
    throw <code>RetryExhaustedException</code>, which causes
    any enclosing transaction to be rolled back. More sophisticated
    implementations might attempt to take some recovery action, in which case
    the transaction can remain intact.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Failures are inherently either retryable or not. If the same
      exception is always going to be thrown from the business logic, it
      does no good to retry it. So do not retry on all exception types. Rather, try to
      focus on only those exceptions that you expect to be retryable. It is not
      usually harmful to the business logic to retry more aggressively, but
      it is wasteful, because, if a failure is deterministic, you spend time
      retrying something that you know in advance is fatal.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Batch provides some simple general purpose implementations of
    stateless <code>RetryPolicy</code>, such as
    <code>SimpleRetryPolicy</code> and
    <code>TimeoutRetryPolicy</code> (used in the preceding example).</p>
</div>
<div class="paragraph">
<p>The <code>SimpleRetryPolicy</code> allows a retry on
    any of a named list of exception types, up to a fixed number of times. It
    also has a list of "fatal" exceptions that should never be retried, and
    this list overrides the retryable list so that it can be used to give
    finer control over the retry behavior, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SimpleRetryPolicy policy = <span class="keyword">new</span> SimpleRetryPolicy();
<span class="comment">// Set the max retry attempts</span>
policy.setMaxAttempts(<span class="integer">5</span>);
<span class="comment">// Retry on all exceptions (this is the default)</span>
policy.setRetryableExceptions(<span class="keyword">new</span> <span class="predefined-type">Class</span><span class="type">[]</span> {<span class="exception">Exception</span>.class});
<span class="comment">// ... but never retry IllegalStateException</span>
policy.setFatalExceptions(<span class="keyword">new</span> <span class="predefined-type">Class</span><span class="type">[]</span> {<span class="exception">IllegalStateException</span>.class});

<span class="comment">// Use the policy...</span>
RetryTemplate template = <span class="keyword">new</span> RetryTemplate();
template.setRetryPolicy(policy);
template.execute(<span class="keyword">new</span> RetryCallback&lt;Foo&gt;() {
    <span class="directive">public</span> Foo doWithRetry(RetryContext context) {
        <span class="comment">// business logic here</span>
    }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also a more flexible implementation called
    <code>ExceptionClassifierRetryPolicy</code>, which allows the
    user to configure different retry behavior for an arbitrary set of
    exception types though the <code>ExceptionClassifier</code>
    abstraction. The policy works by calling on the classifier to convert an
    exception into a delegate <code>RetryPolicy</code>. For
    example, one exception type can be retried more times before failure than
    another by mapping it to a different policy.</p>
</div>
<div class="paragraph">
<p>Users might need to implement their own retry policies for more
    customized decisions. For instance, a custom retry policy makes sense when there is a well-known,
    solution-specific classification of exceptions into retryable and not
    retryable.</p>
</div>
</div>
<div class="sect2">
<h3 id="backoffPolicies"><a class="anchor" href="#backoffPolicies"></a>9.3. Backoff Policies</h3>
<div class="paragraph">
<p>When retrying after a transient failure, it often helps to wait a bit
    before trying again, because usually the failure is caused by some problem
    that can only be resolved by waiting. If a
    <code>RetryCallback</code> fails, the
    <code>RetryTemplate</code> can pause execution according to the
    <code>BackoffPolicy</code>.</p>
</div>
<div class="paragraph">
<p>The following code shows the interface definition for the <code>BackOffPolicy</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">BackoffPolicy</span> {

    BackOffContext start(RetryContext context);

    <span class="type">void</span> backOff(BackOffContext backOffContext)
        <span class="directive">throws</span> BackOffInterruptedException;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>BackoffPolicy</code> is free to implement
    the backOff in any way it chooses. The policies provided by Spring Batch
    out of the box all use <code>Object.wait()</code>. A common use case is to
    backoff with an exponentially increasing wait period, to avoid two retries
    getting into lock step and both failing (this is a lesson learned from
    ethernet). For this purpose, Spring Batch provides the
    <code>ExponentialBackoffPolicy</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="retryListeners"><a class="anchor" href="#retryListeners"></a>9.4. Listeners</h3>
<div class="paragraph">
<p>Often, it is useful to be able to receive additional callbacks for
    cross cutting concerns across a number of different retries. For this
    purpose, Spring Batch provides the <code>RetryListener</code>
    interface. The <code>RetryTemplate</code> lets users
    register <code>RetryListeners</code>, and they are given
    callbacks with <code>RetryContext</code> and
    <code>Throwable</code> where available during the
    iteration.</p>
</div>
<div class="paragraph">
<p>The following code shows the interface definition for <code>RetryListener</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">RetryListener</span> {

    &lt;T, E <span class="directive">extends</span> <span class="predefined-type">Throwable</span>&gt; <span class="type">boolean</span> open(RetryContext context, RetryCallback&lt;T, E&gt; callback);

    &lt;T, E <span class="directive">extends</span> <span class="predefined-type">Throwable</span>&gt; <span class="type">void</span> onError(RetryContext context, RetryCallback&lt;T, E&gt; callback, <span class="predefined-type">Throwable</span> throwable);

    &lt;T, E <span class="directive">extends</span> <span class="predefined-type">Throwable</span>&gt; <span class="type">void</span> close(RetryContext context, RetryCallback&lt;T, E&gt; callback, <span class="predefined-type">Throwable</span> throwable);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>open</code> and
    <code>close</code> callbacks come before and after the entire
    retry in the simplest case, and <code>onError</code> applies to
    the individual <code>RetryCallback</code> calls. The
    <code>close</code> method might also receive a
    <code>Throwable</code>. If there has been an error, it is the
    last one thrown by the <code>RetryCallback</code>.</p>
</div>
<div class="paragraph">
<p>Note that, when there is more than one listener, they are in a list,
    so there is an order. In this case, <code>open</code> is
    called in the same order while <code>onError</code> and
    <code>close</code> are called in reverse order.</p>
</div>
</div>
<div class="sect2">
<h3 id="declarativeRetry"><a class="anchor" href="#declarativeRetry"></a>9.5. Declarative Retry</h3>
<div class="paragraph">
<p>Sometimes, there is some business processing that you know you want
    to retry every time it happens. The classic example of this is the remote
    service call. Spring Batch provides an AOP interceptor that wraps a method
    call in a <code>RetryOperations</code> implementation for just this purpose.
    The <code>RetryOperationsInterceptor</code> executes the
    intercepted method and retries on failure according to the
    <code>RetryPolicy</code> in the provided
    <code>RetryTemplate</code>.</p>
</div>
<div class="paragraph xmlContent">
<p>The following example shows a declarative retry that uses the Spring AOP
    namespace to retry a service call to a method called
    <code>remoteCall</code> (for more detail on how to configure
    AOP interceptors, see the Spring User Guide):</p>
</div>
<div class="listingblock xmlContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;aop:config&gt;</span>
    <span class="tag">&lt;aop:pointcut</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactional</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">expression</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">execution(* com..*Service.remoteCall(..))</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;aop:advisor</span> <span class="attribute-name">pointcut-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactional</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">advice-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retryAdvice</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">order</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/aop:config&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retryAdvice</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.retry.interceptor.RetryOperationsInterceptor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph javaContent">
<p>The following example shows a declarative retry that uses java configuration
    to retry a service call to a method called
    <code>remoteCall</code> (for more detail on how to configure
    AOP interceptors, see the Spring User Guide):</p>
</div>
<div class="listingblock javaContent">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> MyService myService() {
        ProxyFactory factory = <span class="keyword">new</span> ProxyFactory(RepeatOperations.class.getClassLoader());
        factory.setInterfaces(MyService.class);
        factory.setTarget(<span class="keyword">new</span> MyService());

        MyService service = (MyService) factory.getProxy();
        JdkRegexpMethodPointcut pointcut = <span class="keyword">new</span> JdkRegexpMethodPointcut();
        pointcut.setPatterns(<span class="string"><span class="delimiter">&quot;</span><span class="content">.*remoteCall.*</span><span class="delimiter">&quot;</span></span>);

        RetryOperationsInterceptor interceptor = <span class="keyword">new</span> RetryOperationsInterceptor();

        ((Advised) service).addAdvisor(<span class="keyword">new</span> DefaultPointcutAdvisor(pointcut, interceptor));

        <span class="keyword">return</span> service;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding example uses a default
    <code>RetryTemplate</code> inside the interceptor. To change the
    policies or listeners, you can inject an instance of
    <code>RetryTemplate</code> into the interceptor.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing"><a class="anchor" href="#testing"></a>10. Unit Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As with other application styles, it is extremely important to
  unit test any code written as part of a batch job. The Spring core
  documentation covers how to unit and integration test with Spring in great
  detail, so it is not be repeated here. It is important, however, to think
  about how to 'end to end' test a batch job, which is what this chapter
  covers. The spring-batch-test project includes classes that
  facilitate this end-to-end test approach.</p>
</div>
<div class="sect2">
<h3 id="creatingUnitTestClass"><a class="anchor" href="#creatingUnitTestClass"></a>10.1. Creating a Unit Test Class</h3>
<div class="paragraph">
<p>In order for the unit test to run a batch job, the framework must
    load the job&#8217;s <code>ApplicationContext</code>. Two annotations are used to trigger
    this behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@RunWith(SpringRunner.class)</code>:
Indicates that the class should use Spring&#8217;s JUnit facilities</p>
</li>
<li>
<p><code>@ContextConfiguration(&#8230;&#8203;)</code>:
Indicates which resources to configure the <code>ApplicationContext</code> with.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Starting from v4.1, it is also possible to inject Spring Batch test utilities
like the <code>JobLauncherTestUtils</code> and <code>JobRepositoryTestUtils</code> in the test context
using the <code>@SpringBatchTest</code> annotation.</p>
</div>
<div class="paragraph">
<p>The following example shows the annotations in use:</p>
</div>
<div class="listingblock javaContent">
<div class="title">Using Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SpringBatchTest</span>
<span class="annotation">@RunWith</span>(SpringRunner.class)
<span class="annotation">@ContextConfiguration</span>(classes=SkipSampleConfiguration.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SkipSampleFunctionalTests</span> { ... }</code></pre>
</div>
</div>
<div class="listingblock xmlContent">
<div class="title">Using XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SpringBatchTest</span>
<span class="annotation">@RunWith</span>(SpringRunner.class)
<span class="annotation">@ContextConfiguration</span>(locations = { <span class="string"><span class="delimiter">&quot;</span><span class="content">/simple-job-launcher-context.xml</span><span class="delimiter">&quot;</span></span>,
                                    <span class="string"><span class="delimiter">&quot;</span><span class="content">/jobs/skipSampleJob.xml</span><span class="delimiter">&quot;</span></span> })
<span class="directive">public</span> <span class="type">class</span> <span class="class">SkipSampleFunctionalTests</span> { ... }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="endToEndTesting"><a class="anchor" href="#endToEndTesting"></a>10.2. End-To-End Testing of Batch Jobs</h3>
<div class="paragraph">
<p>'End To End' testing can be defined as testing the complete run of a
    batch job from beginning to end. This allows for a test that sets up a
    test condition, executes the job, and verifies the end result.</p>
</div>
<div class="paragraph">
<p>In the following example, the batch job reads from the database and
    writes to a flat file. The test method begins by setting up the database
    with test data. It clears the CUSTOMER table and then inserts 10 new
    records. The test then launches the <code>Job</code> by using the
    <code>launchJob()</code> method. The
    <code>launchJob()</code> method is provided by the
    <code>JobLauncherTestUtils</code> class. The <code>JobLauncherTestUtils</code> class also provides the
    <code>launchJob(JobParameters)</code> method, which
    allows the test to give particular parameters. The
    <code>launchJob()</code> method returns the
    <code>JobExecution</code> object, which is useful for asserting
    particular information about the <code>Job</code> run. In the
    following case, the test verifies that the <code>Job</code> ended
    with status "COMPLETED":</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Based Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SpringBatchTest</span>
<span class="annotation">@RunWith</span>(SpringRunner.class)
<span class="annotation">@ContextConfiguration</span>(locations = { <span class="string"><span class="delimiter">&quot;</span><span class="content">/simple-job-launcher-context.xml</span><span class="delimiter">&quot;</span></span>,
                                    <span class="string"><span class="delimiter">&quot;</span><span class="content">/jobs/skipSampleJob.xml</span><span class="delimiter">&quot;</span></span> })
<span class="directive">public</span> <span class="type">class</span> <span class="class">SkipSampleFunctionalTests</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> JobLauncherTestUtils jobLauncherTestUtils;

    <span class="directive">private</span> SimpleJdbcTemplate simpleJdbcTemplate;

    <span class="annotation">@Autowired</span>
    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.simpleJdbcTemplate = <span class="keyword">new</span> SimpleJdbcTemplate(dataSource);
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testJob() <span class="directive">throws</span> <span class="exception">Exception</span> {
        simpleJdbcTemplate.update(<span class="string"><span class="delimiter">&quot;</span><span class="content">delete from CUSTOMER</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">1</span>; i &lt;= <span class="integer">10</span>; i++) {
            simpleJdbcTemplate.update(<span class="string"><span class="delimiter">&quot;</span><span class="content">insert into CUSTOMER values (?, 0, ?, 100000)</span><span class="delimiter">&quot;</span></span>,
                                      i, <span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span> + i);
        }

        JobExecution jobExecution = jobLauncherTestUtils.launchJob();


        Assert.assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span>, jobExecution.getExitStatus().getExitCode());
    }
}</code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Based Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SpringBatchTest</span>
<span class="annotation">@RunWith</span>(SpringRunner.class)
<span class="annotation">@ContextConfiguration</span>(classes=SkipSampleConfiguration.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SkipSampleFunctionalTests</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> JobLauncherTestUtils jobLauncherTestUtils;

    <span class="directive">private</span> SimpleJdbcTemplate simpleJdbcTemplate;

    <span class="annotation">@Autowired</span>
    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.simpleJdbcTemplate = <span class="keyword">new</span> SimpleJdbcTemplate(dataSource);
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testJob() <span class="directive">throws</span> <span class="exception">Exception</span> {
        simpleJdbcTemplate.update(<span class="string"><span class="delimiter">&quot;</span><span class="content">delete from CUSTOMER</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">1</span>; i &lt;= <span class="integer">10</span>; i++) {
            simpleJdbcTemplate.update(<span class="string"><span class="delimiter">&quot;</span><span class="content">insert into CUSTOMER values (?, 0, ?, 100000)</span><span class="delimiter">&quot;</span></span>,
                                      i, <span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span> + i);
        }

        JobExecution jobExecution = jobLauncherTestUtils.launchJob();


        Assert.assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span>, jobExecution.getExitStatus().getExitCode());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testingIndividualSteps"><a class="anchor" href="#testingIndividualSteps"></a>10.3. Testing Individual Steps</h3>
<div class="paragraph">
<p>For complex batch jobs, test cases in the end-to-end testing
    approach may become unmanageable. It these cases, it may be more useful to
    have test cases to test individual steps on their own. The
    <code>JobLauncherTestUtils</code> class contains a method called
    <code>launchStep</code>, which takes a step name and runs just
    that particular <code>Step</code>. This approach allows for more
    targeted tests letting the test set up data for only that step and
    to validate its results directly. The following example shows how to use the
    <code>launchStep</code> method to load a <code>Step</code> by name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">JobExecution jobExecution = jobLauncherTestUtils.launchStep(<span class="string"><span class="delimiter">&quot;</span><span class="content">loadFileStep</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testing-step-scoped-components"><a class="anchor" href="#testing-step-scoped-components"></a>10.4. Testing Step-Scoped Components</h3>
<div class="paragraph">
<p>Often, the components that are configured for your steps at runtime
    use step scope and late binding to inject context from the step or job
    execution. These are tricky to test as standalone components, unless you
    have a way to set the context as if they were in a step execution. That is
    the goal of two components in Spring Batch:
    <code>StepScopeTestExecutionListener</code> and
    <code>StepScopeTestUtils</code>.</p>
</div>
<div class="paragraph">
<p>The listener is declared at the class level, and its job is to
    create a step execution context for each test method, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ContextConfiguration</span>
<span class="annotation">@TestExecutionListeners</span>( { DependencyInjectionTestExecutionListener.class,
    StepScopeTestExecutionListener.class })
<span class="annotation">@RunWith</span>(SpringRunner.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">StepScopeTestExecutionListenerIntegrationTests</span> {

    <span class="comment">// This component is defined step-scoped, so it cannot be injected unless</span>
    <span class="comment">// a step is active...</span>
    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> ItemReader&lt;<span class="predefined-type">String</span>&gt; reader;

    <span class="directive">public</span> StepExecution getStepExecution() {
        StepExecution execution = MetaDataInstanceFactory.createStepExecution();
        execution.getExecutionContext().putString(<span class="string"><span class="delimiter">&quot;</span><span class="content">input.data</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">foo,bar,spam</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> execution;
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testReader() {
        <span class="comment">// The reader is initialized and bound to the input data</span>
        assertNotNull(reader.read());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two <code>TestExecutionListeners</code>. One
    is the regular Spring Test framework, which handles dependency injection
    from the configured application context to inject the reader. The
    other is the Spring Batch
    <code>StepScopeTestExecutionListener</code>. It works by looking
    for a factory method in the test case for a
    <code>StepExecution</code>, using that as the context for
    the test method, as if that execution were active in a <code>Step</code> at runtime. The
    factory method is detected by its signature (it must return a
    <code>StepExecution</code>). If a factory method is not provided,
    then a default <code>StepExecution</code> is created.</p>
</div>
<div class="paragraph">
<p>Starting from v4.1, the <code>StepScopeTestExecutionListener</code> and
 <code>JobScopeTestExecutionListener</code> are imported as test execution listeners
 if the test class is annotated with <code>@SpringBatchTest</code>. The preceding test
 example can be configured as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SpringBatchTest</span>
<span class="annotation">@RunWith</span>(SpringRunner.class)
<span class="annotation">@ContextConfiguration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">StepScopeTestExecutionListenerIntegrationTests</span> {

    <span class="comment">// This component is defined step-scoped, so it cannot be injected unless</span>
    <span class="comment">// a step is active...</span>
    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> ItemReader&lt;<span class="predefined-type">String</span>&gt; reader;

    <span class="directive">public</span> StepExecution getStepExecution() {
        StepExecution execution = MetaDataInstanceFactory.createStepExecution();
        execution.getExecutionContext().putString(<span class="string"><span class="delimiter">&quot;</span><span class="content">input.data</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">foo,bar,spam</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> execution;
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testReader() {
        <span class="comment">// The reader is initialized and bound to the input data</span>
        assertNotNull(reader.read());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The listener approach is convenient if you want the duration of the
    step scope to be the execution of the test method. For a more flexible
    but more invasive approach, you can use the
    <code>StepScopeTestUtils</code>. The following example counts the
    number of items available in the reader shown in the previous example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">int</span> count = StepScopeTestUtils.doInStepScope(stepExecution,
    <span class="keyword">new</span> <span class="predefined-type">Callable</span>&lt;<span class="predefined-type">Integer</span>&gt;() {
      <span class="directive">public</span> <span class="predefined-type">Integer</span> call() <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="type">int</span> count = <span class="integer">0</span>;

        <span class="keyword">while</span> (reader.read() != <span class="predefined-constant">null</span>) {
           count++;
        }
        <span class="keyword">return</span> count;
    }
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="validatingOutputFiles"><a class="anchor" href="#validatingOutputFiles"></a>10.5. Validating Output Files</h3>
<div class="paragraph">
<p>When a batch job writes to the database, it is easy to query the
    database to verify that the output is as expected. However, if the batch
    job writes to a file, it is equally important that the output be verified.
    Spring Batch provides a class called <code>AssertFile</code> to
    facilitate the verification of output files. The method called
    <code>assertFileEquals</code> takes two
    <code>File</code> objects (or two
    <code>Resource</code> objects) and asserts, line by line, that
    the two files have the same content. Therefore, it is possible to create a
    file with the expected output and to compare it to the actual
    result, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> EXPECTED_FILE = <span class="string"><span class="delimiter">&quot;</span><span class="content">src/main/resources/data/input.txt</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> OUTPUT_FILE = <span class="string"><span class="delimiter">&quot;</span><span class="content">target/test-outputs/output.txt</span><span class="delimiter">&quot;</span></span>;

AssertFile.assertFileEquals(<span class="keyword">new</span> FileSystemResource(EXPECTED_FILE),
                            <span class="keyword">new</span> FileSystemResource(OUTPUT_FILE));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mockingDomainObjects"><a class="anchor" href="#mockingDomainObjects"></a>10.6. Mocking Domain Objects</h3>
<div class="paragraph">
<p>Another common issue encountered while writing unit and integration
    tests for Spring Batch components is how to mock domain objects. A good
    example is a <code>StepExecutionListener</code>, as illustrated
    in the following code snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">NoWorkFoundStepExecutionListener</span> <span class="directive">extends</span> StepExecutionListenerSupport {

    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {
        <span class="keyword">if</span> (stepExecution.getReadCount() == <span class="integer">0</span>) {
            <span class="keyword">return</span> ExitStatus.FAILED;
        }
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding listener example is provided by the framework and checks a
    <code>StepExecution</code> for an empty read count, thus
    signifying that no work was done. While this example is fairly simple, it
    serves to illustrate the types of problems that may be encountered when
    attempting to unit test classes that implement interfaces requiring Spring
    Batch domain objects. Consider the following unit test for the listener&#8217;s in the preceding example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> NoWorkFoundStepExecutionListener tested = <span class="keyword">new</span> NoWorkFoundStepExecutionListener();

<span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> noWork() {
    StepExecution stepExecution = <span class="keyword">new</span> StepExecution(<span class="string"><span class="delimiter">&quot;</span><span class="content">NoProcessingStep</span><span class="delimiter">&quot;</span></span>,
                <span class="keyword">new</span> JobExecution(<span class="keyword">new</span> JobInstance(<span class="integer">1L</span>, <span class="keyword">new</span> JobParameters(),
                                 <span class="string"><span class="delimiter">&quot;</span><span class="content">NoProcessingJob</span><span class="delimiter">&quot;</span></span>)));

    stepExecution.setExitStatus(ExitStatus.COMPLETED);
    stepExecution.setReadCount(<span class="integer">0</span>);

    ExitStatus exitStatus = tested.afterStep(stepExecution);
    assertEquals(ExitStatus.FAILED.getExitCode(), exitStatus.getExitCode());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the Spring Batch domain model follows good object-oriented
    principles, the <code>StepExecution</code> requires a
    <code>JobExecution</code>, which requires a
    <code>JobInstance</code> and
    <code>JobParameters</code>, to create a valid
    <code>StepExecution</code>. While this is good in a solid domain
    model, it does make creating stub objects for unit testing verbose. To
    address this issue, the Spring Batch test module includes a factory for
    creating domain objects: <code>MetaDataInstanceFactory</code>.
    Given this factory, the unit test can be updated to be more
    concise, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> NoWorkFoundStepExecutionListener tested = <span class="keyword">new</span> NoWorkFoundStepExecutionListener();

<span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> testAfterStep() {
    StepExecution stepExecution = MetaDataInstanceFactory.createStepExecution();

    stepExecution.setExitStatus(ExitStatus.COMPLETED);
    stepExecution.setReadCount(<span class="integer">0</span>);

    ExitStatus exitStatus = tested.afterStep(stepExecution);
    assertEquals(ExitStatus.FAILED.getExitCode(), exitStatus.getExitCode());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding method for creating a simple
    <code>StepExecution</code> is just one convenience method
    available within the factory. A full method listing can be found in its
    <a href="https://docs.spring.io/spring-batch/apidocs/org/springframework/batch/test/MetaDataInstanceFactory.html">Javadoc</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="commonPatterns"><a class="anchor" href="#commonPatterns"></a>11. Common Batch Patterns</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some batch jobs can be assembled purely from off-the-shelf components in Spring Batch.
For instance, the <code>ItemReader</code> and <code>ItemWriter</code> implementations can be configured to
cover a wide range of scenarios. However, for the majority of cases, custom code must be
written. The main API entry points for application developers are the <code>Tasklet</code>, the
<code>ItemReader</code>, the <code>ItemWriter</code>, and the various listener interfaces. Most simple batch
jobs can use off-the-shelf input from a Spring Batch <code>ItemReader</code>, but it is often the
case that there are custom concerns in the processing and writing that require developers
to implement an <code>ItemWriter</code> or <code>ItemProcessor</code>.</p>
</div>
<div class="paragraph">
<p>In this chapter, we provide a few examples of common patterns in custom business logic.
These examples primarily feature the listener interfaces. It should be noted that an
<code>ItemReader</code> or <code>ItemWriter</code> can implement a listener interface as well, if appropriate.</p>
</div>
<div class="sect2">
<h3 id="loggingItemProcessingAndFailures"><a class="anchor" href="#loggingItemProcessingAndFailures"></a>11.1. Logging Item Processing and Failures</h3>
<div class="paragraph">
<p>A common use case is the need for special handling of errors in a step, item by item,
perhaps logging to a special channel or inserting a record into a database. A
chunk-oriented <code>Step</code> (created from the step factory beans) lets users implement this use
case with a simple <code>ItemReadListener</code> for errors on <code>read</code> and an <code>ItemWriteListener</code> for
errors on <code>write</code>. The following code snippet illustrates a listener that logs both read
and write failures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ItemFailureLoggerListener</span> <span class="directive">extends</span> ItemListenerSupport {

    <span class="directive">private</span> <span class="directive">static</span> Log logger = LogFactory.getLog(<span class="string"><span class="delimiter">&quot;</span><span class="content">item.error</span><span class="delimiter">&quot;</span></span>);

    <span class="directive">public</span> <span class="type">void</span> onReadError(<span class="exception">Exception</span> ex) {
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Encountered error on read</span><span class="delimiter">&quot;</span></span>, e);
    }

    <span class="directive">public</span> <span class="type">void</span> onWriteError(<span class="exception">Exception</span> ex, <span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Object</span>&gt; items) {
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Encountered error on write</span><span class="delimiter">&quot;</span></span>, ex);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Having implemented this listener, it must be registered with a step, as shown in the
following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
...
<span class="tag">&lt;listeners&gt;</span>
    <span class="tag">&lt;listener&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.example...ItemFailureLoggerListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/listener&gt;</span>
<span class="tag">&lt;/listeners&gt;</span>
<span class="tag">&lt;/step&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step simpleStep() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleStep</span><span class="delimiter">&quot;</span></span>)
                                ...
                                .listener(<span class="keyword">new</span> ItemFailureLoggerListener())
                                .build();
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
if your listener does anything in an <code>onError()</code> method, it must be inside
a transaction that is going to be rolled back. If you need to use a transactional
resource, such as a database, inside an <code>onError()</code> method, consider adding a declarative
transaction to that method (see Spring Core Reference Guide for details), and giving its
propagation attribute a value of <code>REQUIRES_NEW</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="stoppingAJobManuallyForBusinessReasons"><a class="anchor" href="#stoppingAJobManuallyForBusinessReasons"></a>11.2. Stopping a Job Manually for Business Reasons</h3>
<div class="paragraph">
<p>Spring Batch provides a <code>stop()</code> method through the <code>JobLauncher</code> interface, but this is
really for use by the operator rather than the application programmer. Sometimes, it is
more convenient or makes more sense to stop a job execution from within the business
logic.</p>
</div>
<div class="paragraph">
<p>The simplest thing to do is to throw a <code>RuntimeException</code> (one that is neither retried
indefinitely nor skipped). For example, a custom exception type could be used, as shown
in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PoisonPillItemProcessor</span>&lt;T&gt; <span class="directive">implements</span> ItemProcessor&lt;T, T&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> T process(T item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">if</span> (isPoisonPill(item)) {
            <span class="keyword">throw</span> <span class="keyword">new</span> PoisonPillException(<span class="string"><span class="delimiter">&quot;</span><span class="content">Poison pill detected: </span><span class="delimiter">&quot;</span></span> + item);
        }
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another simple way to stop a step from executing is to return <code>null</code> from the
<code>ItemReader</code>, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">EarlyCompletionItemReader</span> <span class="directive">implements</span> ItemReader&lt;T&gt; {

    <span class="directive">private</span> ItemReader&lt;T&gt; delegate;

    <span class="directive">public</span> <span class="type">void</span> setDelegate(ItemReader&lt;T&gt; delegate) { ... }

    <span class="directive">public</span> T read() <span class="directive">throws</span> <span class="exception">Exception</span> {
        T item = delegate.read();
        <span class="keyword">if</span> (isEndItem(item)) {
            <span class="keyword">return</span> <span class="predefined-constant">null</span>; <span class="comment">// end the step here</span>
        }
        <span class="keyword">return</span> item;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous example actually relies on the fact that there is a default implementation
of the <code>CompletionPolicy</code> strategy that signals a complete batch when the item to be
processed is <code>null</code>. A more sophisticated completion policy could be implemented and
injected into the <code>Step</code> through the <code>SimpleStepFactoryBean</code>, as shown in the following
example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet&gt;</span>
        <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">chunk-completion-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">completionPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
<span class="tag">&lt;/step&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">completionPolicy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.example...SpecialCompletionPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Step simpleStep() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleStep</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="keyword">new</span> SpecialCompletionPolicy())
                                .reader(reader())
                                .writer(writer())
                                .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An alternative is to set a flag in the <code>StepExecution</code>, which is checked by the <code>Step</code>
implementations in the framework in between item processing. To implement this
alternative, we need access to the current <code>StepExecution</code>, and this can be achieved by
implementing a <code>StepListener</code> and registering it with the <code>Step</code>. The following example
shows a listener that sets the flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomItemWriter</span> <span class="directive">extends</span> ItemListenerSupport <span class="directive">implements</span> StepListener {

    <span class="directive">private</span> StepExecution stepExecution;

    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="local-variable">this</span>.stepExecution = stepExecution;
    }

    <span class="directive">public</span> <span class="type">void</span> afterRead(<span class="predefined-type">Object</span> item) {
        <span class="keyword">if</span> (isPoisonPill(item)) {
            stepExecution.setTerminateOnly(<span class="predefined-constant">true</span>);
       }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the flag is set, the default behavior is for the step to throw a
<code>JobInterruptedException</code>. This behavior can be controlled through the
<code>StepInterruptionPolicy</code>. However, the only choice is to throw or not throw an exception,
so this is always an abnormal ending to a job.</p>
</div>
</div>
<div class="sect2">
<h3 id="addingAFooterRecord"><a class="anchor" href="#addingAFooterRecord"></a>11.3. Adding a Footer Record</h3>
<div class="paragraph">
<p>Often, when writing to flat files, a "footer" record must be appended to the end of the
file, after all processing has be completed. This can be achieved using the
<code>FlatFileFooterCallback</code> interface provided by Spring Batch. The <code>FlatFileFooterCallback</code>
(and its counterpart, the <code>FlatFileHeaderCallback</code>) are optional properties of the
<code>FlatFileItemWriter</code> and can be added to an item writer as shown in the following
example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...FlatFileItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputResource</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerCallback</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerCallback</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footerCallback</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footerCallback</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemWriter&lt;<span class="predefined-type">String</span>&gt; itemWriter(Resource outputResource) {
        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemWriterBuilder&lt;<span class="predefined-type">String</span>&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span>)
                        .resource(outputResource)
                        .lineAggregator(lineAggregator())
                        .headerCallback(headerCallback())
                        .footerCallback(footerCallback())
                        .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The footer callback interface has just one method that is called when the footer must be
written, as shown in the following interface definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">FlatFileFooterCallback</span> {

    <span class="type">void</span> writeFooter(<span class="predefined-type">Writer</span> writer) <span class="directive">throws</span> <span class="exception">IOException</span>;

}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="writingASummaryFooter"><a class="anchor" href="#writingASummaryFooter"></a>11.3.1. Writing a Summary Footer</h4>
<div class="paragraph">
<p>A common requirement involving footer records is to aggregate information during the
output process and to append this information to the end of the file. This footer often
serves as a summarization of the file or provides a checksum.</p>
</div>
<div class="paragraph">
<p>For example, if a batch job is writing <code>Trade</code> records to a flat file, and there is a
requirement that the total amount from all the <code>Trades</code> is placed in a footer, then the
following <code>ItemWriter</code> implementation can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">TradeItemWriter</span> <span class="directive">implements</span> ItemWriter&lt;Trade&gt;,
                                        FlatFileFooterCallback {

    <span class="directive">private</span> ItemWriter&lt;Trade&gt; delegate;

    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> totalAmount = <span class="predefined-type">BigDecimal</span>.ZERO;

    <span class="directive">public</span> <span class="type">void</span> write(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> Trade&gt; items) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">BigDecimal</span> chunkTotal = <span class="predefined-type">BigDecimal</span>.ZERO;
        <span class="keyword">for</span> (Trade trade : items) {
            chunkTotal = chunkTotal.add(trade.getAmount());
        }

        delegate.write(items);

        <span class="comment">// After successfully writing all items</span>
        totalAmount = totalAmount.add(chunkTotal);
    }

    <span class="directive">public</span> <span class="type">void</span> writeFooter(<span class="predefined-type">Writer</span> writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        writer.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">Total Amount Processed: </span><span class="delimiter">&quot;</span></span> + totalAmount);
    }

    <span class="directive">public</span> <span class="type">void</span> setDelegate(ItemWriter delegate) {...}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>TradeItemWriter</code> stores a <code>totalAmount</code> value that is increased with the <code>amount</code>
from each <code>Trade</code> item written. After the last <code>Trade</code> is processed, the framework calls
<code>writeFooter</code>, which puts the <code>totalAmount</code> into the file. Note that the <code>write</code> method
makes use of a temporary variable, <code>chunkTotal</code>, that stores the total of the
<code>Trade</code> amounts in the chunk. This is done to ensure that, if a skip occurs in the
<code>write</code> method, the <code>totalAmount</code> is left unchanged. It is only at the end of the <code>write</code>
method, once we are guaranteed that no exceptions are thrown, that we update the
<code>totalAmount</code>.</p>
</div>
<div class="paragraph">
<p>In order for the <code>writeFooter</code> method to be called, the <code>TradeItemWriter</code> (which
implements <code>FlatFileFooterCallback</code>) must be wired into the <code>FlatFileItemWriter</code> as the
<code>footerCallback</code>. The following example shows how to do so:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tradeItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">..TradeItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegate</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...FlatFileItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputResource</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footerCallback</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tradeItemWriter</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> TradeItemWriter tradeItemWriter() {
        TradeItemWriter itemWriter = <span class="keyword">new</span> TradeItemWriter();

        itemWriter.setDelegate(flatFileItemWriter(<span class="predefined-constant">null</span>));

        <span class="keyword">return</span> itemWriter;
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemWriter&lt;<span class="predefined-type">String</span>&gt; flatFileItemWriter(Resource outputResource) {
        <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemWriterBuilder&lt;<span class="predefined-type">String</span>&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span>)
                        .resource(outputResource)
                        .lineAggregator(lineAggregator())
                        .footerCallback(tradeItemWriter())
                        .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The way that the <code>TradeItemWriter</code> has been written so far functions correctly only if
the <code>Step</code> is not restartable. This is because the class is stateful (since it stores the
<code>totalAmount</code>), but the <code>totalAmount</code> is not persisted to the database. Therefore, it
cannot be retrieved in the event of a restart. In order to make this class restartable,
the <code>ItemStream</code> interface should be implemented along with the methods <code>open</code> and
<code>update</code>, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> open(ExecutionContext executionContext) {
    <span class="keyword">if</span> (executionContext.containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">total.amount</span><span class="delimiter">&quot;</span></span>) {
        totalAmount = (<span class="predefined-type">BigDecimal</span>) executionContext.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">total.amount</span><span class="delimiter">&quot;</span></span>);
    }
}

<span class="directive">public</span> <span class="type">void</span> update(ExecutionContext executionContext) {
    executionContext.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">total.amount</span><span class="delimiter">&quot;</span></span>, totalAmount);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The update method stores the most current version of <code>totalAmount</code> to the
<code>ExecutionContext</code> just before that object is persisted to the database. The open method
retrieves any existing <code>totalAmount</code> from the <code>ExecutionContext</code> and uses it as the
starting point for processing, allowing the <code>TradeItemWriter</code> to pick up on restart where
it left off the previous time the <code>Step</code> was run.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="drivingQueryBasedItemReaders"><a class="anchor" href="#drivingQueryBasedItemReaders"></a>11.4. Driving Query Based ItemReaders</h3>
<div class="paragraph">
<p>In the <a href="readersAndWriters.html">chapter on readers and writers</a>, database input using
paging was discussed. Many database vendors, such as DB2, have extremely pessimistic
locking strategies that can cause issues if the table being read also needs to be used by
other portions of the online application. Furthermore, opening cursors over extremely
large datasets can cause issues on databases from certain vendors. Therefore, many
projects prefer to use a 'Driving Query' approach to reading in data. This approach works
by iterating over keys, rather than the entire object that needs to be returned, as the
following image illustrates:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/drivingQueryExample.png" alt="Driving Query Job">
</div>
<div class="title">Figure 25. Driving Query Job</div>
</div>
<div class="paragraph">
<p>As you can see, the example shown in the preceding image uses the same 'FOO' table as was
used in the cursor-based example. However, rather than selecting the entire row, only the
IDs were selected in the SQL statement. So, rather than a <code>FOO</code> object being returned
from <code>read</code>, an <code>Integer</code> is returned. This number can then be used to query for the
'details', which is a complete <code>Foo</code> object, as shown in the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/drivingQueryJob.png" alt="Driving Query Example">
</div>
<div class="title">Figure 26. Driving Query Example</div>
</div>
<div class="paragraph">
<p>An <code>ItemProcessor</code> should be used to transform the key obtained from the driving query
into a full 'Foo' object. An existing DAO can be used to query for the full object based
on the key.</p>
</div>
</div>
<div class="sect2">
<h3 id="multiLineRecords"><a class="anchor" href="#multiLineRecords"></a>11.5. Multi-Line Records</h3>
<div class="paragraph">
<p>While it is usually the case with flat files that each record is confined to a single
line, it is common that a file might have records spanning multiple lines with multiple
formats. The following excerpt from a file shows an example of such an arrangement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>HEA;0013100345;2007-02-15
NCU;Smith;Peter;;T;20014539;F
BAD;;Oak Street 31/A;;Small Town;00235;IL;US
FOT;2;2;267.34</pre>
</div>
</div>
<div class="paragraph">
<p>Everything between the line starting with 'HEA' and the line starting with 'FOT' is
considered one record. There are a few considerations that must be made in order to
handle this situation correctly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Instead of reading one record at a time, the <code>ItemReader</code> must read every line of the
multi-line record as a group, so that it can be passed to the <code>ItemWriter</code> intact.</p>
</li>
<li>
<p>Each line type may need to be tokenized differently.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Because a single record spans multiple lines and because we may not know how many lines
there are, the <code>ItemReader</code> must be careful to always read an entire record. In order to
do this, a custom <code>ItemReader</code> should be implemented as a wrapper for the
<code>FlatFileItemReader</code>, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...MultiLineTradeItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegate</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">data/iosample/input/multiLine.txt</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">orderFileTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">orderFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/bean&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> MultiLineTradeItemReader itemReader() {
        MultiLineTradeItemReader itemReader = <span class="keyword">new</span> MultiLineTradeItemReader();

        itemReader.setDelegate(flatFileItemReader());

        <span class="keyword">return</span> itemReader;
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> FlatFileItemReader flatFileItemReader() {
        FlatFileItemReader&lt;Trade&gt; reader = <span class="keyword">new</span> FlatFileItemReaderBuilder&lt;Trade&gt;()
                        .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">flatFileItemReader</span><span class="delimiter">&quot;</span></span>)
                        .resource(<span class="keyword">new</span> ClassPathResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">data/iosample/input/multiLine.txt</span><span class="delimiter">&quot;</span></span>))
                        .lineTokenizer(orderFileTokenizer())
                        .fieldSetMapper(orderFieldSetMapper())
                        .build();
        <span class="keyword">return</span> reader;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To ensure that each line is tokenized properly, which is especially important for
fixed-length input, the <code>PatternMatchingCompositeLineTokenizer</code> can be used on the
delegate <code>FlatFileItemReader</code>. See
<a href="readersAndWriters.html#flatFileItemReader"><code>FlatFileItemReader</code> in the Readers and
Writers chapter</a> for more details. The delegate reader then uses a
<code>PassThroughFieldSetMapper</code> to deliver a <code>FieldSet</code> for each line back to the wrapping
<code>ItemReader</code>, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Content</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">orderFileTokenizer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr...PatternMatchingCompositeLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tokenizers</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">HEA*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerRecordTokenizer</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FOT*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footerRecordTokenizer</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NCU*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerLineTokenizer</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BAD*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">billingAddressLineTokenizer</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Content</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> PatternMatchingCompositeLineTokenizer orderFileTokenizer() {
        PatternMatchingCompositeLineTokenizer tokenizer =
                        <span class="keyword">new</span> PatternMatchingCompositeLineTokenizer();

        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, LineTokenizer&gt; tokenizers = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;(<span class="integer">4</span>);

        tokenizers.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">HEA*</span><span class="delimiter">&quot;</span></span>, headerRecordTokenizer());
        tokenizers.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">FOT*</span><span class="delimiter">&quot;</span></span>, footerRecordTokenizer());
        tokenizers.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">NCU*</span><span class="delimiter">&quot;</span></span>, customerLineTokenizer());
        tokenizers.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">BAD*</span><span class="delimiter">&quot;</span></span>, billingAddressLineTokenizer());

        tokenizer.setTokenizers(tokenizers);

        <span class="keyword">return</span> tokenizer;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This wrapper has to be able to recognize the end of a record so that it can continually
call <code>read()</code> on its delegate until the end is reached. For each line that is read, the
wrapper should build up the item to be returned. Once the footer is reached, the item can
be returned for delivery to the <code>ItemProcessor</code> and <code>ItemWriter</code>, as  shown in the
following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> FlatFileItemReader&lt;FieldSet&gt; delegate;

<span class="directive">public</span> Trade read() <span class="directive">throws</span> <span class="exception">Exception</span> {
    Trade t = <span class="predefined-constant">null</span>;

    <span class="keyword">for</span> (FieldSet line = <span class="predefined-constant">null</span>; (line = <span class="local-variable">this</span>.delegate.read()) != <span class="predefined-constant">null</span>;) {
        <span class="predefined-type">String</span> prefix = line.readString(<span class="integer">0</span>);
        <span class="keyword">if</span> (prefix.equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">HEA</span><span class="delimiter">&quot;</span></span>)) {
            t = <span class="keyword">new</span> Trade(); <span class="comment">// Record must start with header</span>
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (prefix.equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">NCU</span><span class="delimiter">&quot;</span></span>)) {
            Assert.notNull(t, <span class="string"><span class="delimiter">&quot;</span><span class="content">No header was found.</span><span class="delimiter">&quot;</span></span>);
            t.setLast(line.readString(<span class="integer">1</span>));
            t.setFirst(line.readString(<span class="integer">2</span>));
            ...
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (prefix.equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">BAD</span><span class="delimiter">&quot;</span></span>)) {
            Assert.notNull(t, <span class="string"><span class="delimiter">&quot;</span><span class="content">No header was found.</span><span class="delimiter">&quot;</span></span>);
            t.setCity(line.readString(<span class="integer">4</span>));
            t.setState(line.readString(<span class="integer">6</span>));
          ...
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (prefix.equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">FOT</span><span class="delimiter">&quot;</span></span>)) {
            <span class="keyword">return</span> t; <span class="comment">// Record must end with footer</span>
        }
    }
    Assert.isNull(t, <span class="string"><span class="delimiter">&quot;</span><span class="content">No 'END' was found.</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="executingSystemCommands"><a class="anchor" href="#executingSystemCommands"></a>11.6. Executing System Commands</h3>
<div class="paragraph">
<p>Many batch jobs require that an external command be called from within the batch job.
Such a process could be kicked off separately by the scheduler, but the advantage of
common metadata about the run would be lost. Furthermore, a multi-step job would also
need to be split up into multiple jobs as well.</p>
</div>
<div class="paragraph">
<p>Because the need is so common, Spring Batch provides a <code>Tasklet</code> implementation for
calling system commands, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.step.tasklet.SystemCommandTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">command</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">echo hello</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="comment">&lt;!-- 5 second timeout for the command to complete --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">timeout</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> SystemCommandTasklet tasklet() {
        SystemCommandTasklet tasklet = <span class="keyword">new</span> SystemCommandTasklet();

        tasklet.setCommand(<span class="string"><span class="delimiter">&quot;</span><span class="content">echo hello</span><span class="delimiter">&quot;</span></span>);
        tasklet.setTimeout(<span class="integer">5000</span>);

        <span class="keyword">return</span> tasklet;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="handlingStepCompletionWhenNoInputIsFound"><a class="anchor" href="#handlingStepCompletionWhenNoInputIsFound"></a>11.7. Handling Step Completion When No Input is Found</h3>
<div class="paragraph">
<p>In many batch scenarios, finding no rows in a database or file to process is not
exceptional. The <code>Step</code> is simply considered to have found no work and completes with 0
items read. All of the <code>ItemReader</code> implementations provided out of the box in Spring
Batch default to this approach. This can lead to some confusion if nothing is written out
even when input is present (which usually happens if a file was misnamed or some similar
issue arises). For this reason, the metadata itself should be inspected to determine how
much work the framework found to be processed. However, what if finding no input is
considered exceptional? In this case, programmatically checking the metadata for no items
processed and causing failure is the best solution. Because this is a common use case,
Spring Batch provides a listener with exactly this functionality, as shown in
the class definition for <code>NoWorkFoundStepExecutionListener</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">NoWorkFoundStepExecutionListener</span> <span class="directive">extends</span> StepExecutionListenerSupport {

    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {
        <span class="keyword">if</span> (stepExecution.getReadCount() == <span class="integer">0</span>) {
            <span class="keyword">return</span> ExitStatus.FAILED;
        }
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding <code>StepExecutionListener</code> inspects the <code>readCount</code> property of the
<code>StepExecution</code> during the 'afterStep' phase to determine if no items were read. If that
is the case, an exit code of FAILED is returned, indicating that the <code>Step</code> should fail.
Otherwise, <code>null</code> is returned, which does not affect the status of the <code>Step</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="passingDataToFutureSteps"><a class="anchor" href="#passingDataToFutureSteps"></a>11.8. Passing Data to Future Steps</h3>
<div class="paragraph">
<p>It is often useful to pass information from one step to another. This can be done through
the <code>ExecutionContext</code>. The catch is that there are two <code>ExecutionContexts</code>: one at the
<code>Step</code> level and one at the <code>Job</code> level. The <code>Step</code> <code>ExecutionContext</code> remains only as
long as the step, while the <code>Job</code> <code>ExecutionContext</code> remains through the whole <code>Job</code>. On
the other hand, the <code>Step</code> <code>ExecutionContext</code> is updated every time the <code>Step</code> commits a
chunk, while the <code>Job</code> <code>ExecutionContext</code> is updated only at the end of each <code>Step</code>.</p>
</div>
<div class="paragraph">
<p>The consequence of this separation is that all data must be placed in the <code>Step</code>
<code>ExecutionContext</code> while the <code>Step</code> is executing. Doing so ensures that the data is
stored properly while the <code>Step</code> runs. If data is stored to the <code>Job</code> <code>ExecutionContext</code>,
then it is not persisted during <code>Step</code> execution. If the <code>Step</code> fails, that data is lost.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SavingItemWriter</span> <span class="directive">implements</span> ItemWriter&lt;<span class="predefined-type">Object</span>&gt; {
    <span class="directive">private</span> StepExecution stepExecution;

    <span class="directive">public</span> <span class="type">void</span> write(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Object</span>&gt; items) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">// ...</span>

        ExecutionContext stepContext = <span class="local-variable">this</span>.stepExecution.getExecutionContext();
        stepContext.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">someKey</span><span class="delimiter">&quot;</span></span>, someObject);
    }

    <span class="annotation">@BeforeStep</span>
    <span class="directive">public</span> <span class="type">void</span> saveStepExecution(StepExecution stepExecution) {
        <span class="local-variable">this</span>.stepExecution = stepExecution;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make the data available to future <code>Steps</code>, it must be "promoted" to the <code>Job</code>
<code>ExecutionContext</code> after the step has finished. Spring Batch provides the
<code>ExecutionContextPromotionListener</code> for this purpose. The listener must be configured
with the keys related to the data in the <code>ExecutionContext</code> that must be promoted. It can
also, optionally, be configured with a list of exit code patterns for which the promotion
should occur (<code>COMPLETED</code> is the default). As with all listeners, it must be registered
on the <code>Step</code> as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">savingWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
        <span class="tag">&lt;listeners&gt;</span>
            <span class="tag">&lt;listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">promotionListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/listeners&gt;</span>
    <span class="tag">&lt;/step&gt;</span>

    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       ...
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span>

<span class="tag">&lt;beans:bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">promotionListener</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.spr....ExecutionContextPromotionListener</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;beans:property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keys</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;value&gt;</span>someKey<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/beans:property&gt;</span>
<span class="tag">&lt;/beans:bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Job job1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">job1</span><span class="delimiter">&quot;</span></span>)
                                .start(step1())
                                .next(step1())
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> Step step1() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                                .&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">10</span>)
                                .reader(reader())
                                .writer(savingWriter())
                                .listener(promotionListener())
                                .build();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> ExecutionContextPromotionListener promotionListener() {
        ExecutionContextPromotionListener listener = <span class="keyword">new</span> ExecutionContextPromotionListener();

        listener.setKeys(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">someKey</span><span class="delimiter">&quot;</span></span> });

        <span class="keyword">return</span> listener;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, the saved values must be retrieved from the <code>Job</code> <code>ExecutionContext</code>, as shown
in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">RetrievingItemWriter</span> <span class="directive">implements</span> ItemWriter&lt;<span class="predefined-type">Object</span>&gt; {
    <span class="directive">private</span> <span class="predefined-type">Object</span> someObject;

    <span class="directive">public</span> <span class="type">void</span> write(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Object</span>&gt; items) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">// ...</span>
    }

    <span class="annotation">@BeforeStep</span>
    <span class="directive">public</span> <span class="type">void</span> retrieveInterstepData(StepExecution stepExecution) {
        JobExecution jobExecution = stepExecution.getJobExecution();
        ExecutionContext jobContext = jobExecution.getExecutionContext();
        <span class="local-variable">this</span>.someObject = jobContext.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">someKey</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jsr-352"><a class="anchor" href="#jsr-352"></a>12. JSR-352 Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As of Spring Batch 3.0 support for JSR-352 has been fully implemented. This section is not a replacement for
        the spec itself and instead, intends to explain how the JSR-352 specific concepts apply to Spring Batch.
        Additional information on JSR-352 can be found via the
        JCP here: <a href="https://jcp.org/en/jsr/detail?id=352"><a href="https://jcp.org/en/jsr/detail?id=352" class="bare">https://jcp.org/en/jsr/detail?id=352</a></a></p>
</div>
<div class="sect2">
<h3 id="jsrGeneralNotes"><a class="anchor" href="#jsrGeneralNotes"></a>12.1. General Notes about Spring Batch and JSR-352</h3>
<div class="paragraph">
<p>Spring Batch and JSR-352 are structurally the same.  They both have jobs that are made up of steps.  They
            both have readers, processors, writers, and listeners.  However, their interactions are subtly different.
            For example, the <code>org.springframework.batch.core.SkipListener#onSkipInWrite(S item, Throwable t)</code>
            within Spring Batch receives two parameters: the item that was skipped and the Exception that caused the
            skip.  The JSR-352 version of the same method
            (<code>javax.batch.api.chunk.listener.SkipWriteListener#onSkipWriteItem(List&lt;Object&gt; items, Exception ex)</code>)
            also receives two parameters.  However the first one is a <code>List</code> of all the items
            within the current chunk with the second being the <code>Exception</code> that caused the skip.
            Because of these differences, it is important to note that there are two paths to execute a job within
            Spring Batch: either a traditional Spring Batch job or a JSR-352 based job.  While the use of Spring Batch
            artifacts (readers, writers, etc) will work within a job configured via JSR-352&#8217;s JSL and executed via the
            <code>JsrJobOperator</code>, they will behave according to the rules of JSR-352.  It is also
            important to note that batch artifacts that have been developed against the JSR-352 interfaces will not work
            within a traditional Spring Batch job.</p>
</div>
</div>
<div class="sect2">
<h3 id="jsrSetup"><a class="anchor" href="#jsrSetup"></a>12.2. Setup</h3>
<div class="sect3">
<h4 id="jsrSetupContexts"><a class="anchor" href="#jsrSetupContexts"></a>12.2.1. Application Contexts</h4>
<div class="paragraph">
<p>All JSR-352 based jobs within Spring Batch consist of two application contexts.  A parent context, that
			contains beans related to the infrastructure of Spring Batch such as the <code>JobRepository</code>,
			<code>PlatformTransactionManager</code>, etc and a child context that consists of the configuration
			of the job to be run.  The parent context is defined via the <code>jsrBaseContext.xml</code> provided
			by the framework.  This context may be overridden via the <code>JSR-352-BASE-CONTEXT</code> system
			property.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The base context is not processed by the JSR-352 processors for things like property injection so
				no components requiring that additional processing should be configured there.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="jsrSetupLaunching"><a class="anchor" href="#jsrSetupLaunching"></a>12.2.2. Launching a JSR-352 based job</h4>
<div class="paragraph">
<p>JSR-352 requires a very simple path to executing a batch job.  The following code is all that is needed to
				execute your first batch job:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">JobOperator operator = BatchRuntime.getJobOperator();
jobOperator.start(<span class="string"><span class="delimiter">&quot;</span><span class="content">myJob</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Properties</span>());</code></pre>
</div>
</div>
<div class="paragraph">
<p>While that is convenient for developers, the devil is in the details.  Spring Batch bootstraps a bit of
				infrastructure behind the scenes that a developer may want to override.  The following is bootstrapped the
				first time <code>BatchRuntime.getJobOperator()</code> is called:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Bean Name</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Default Configuration</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Notes</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dataSource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache DBCP BasicDataSource with configured values.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By default, HSQLDB is bootstrapped.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>transactionManager</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.jdbc.datasource.DataSourceTransactionManager</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">References the dataSource bean defined above.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Datasource initializer</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is configured to execute the scripts configured via the
									<code>batch.drop.script</code> and <code>batch.schema.script</code> properties.  By
									default, the schema scripts for HSQLDB are executed.  This behavior can be disabled via
									<code>batch.data.source.init</code> property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobRepository</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A JDBC based <code>SimpleJobRepository</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This <code>JobRepository</code> uses the previously mentioned data source and transaction
									manager.  The schema&#8217;s table prefix is configurable (defaults to BATCH_) via the
									<code>batch.table.prefix</code> property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobLauncher</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.core.launch.support.SimpleJobLauncher</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used to launch jobs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batchJobOperator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.core.launch.support.SimpleJobOperator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>JsrJobOperator</code> wraps this to provide most of it&#8217;s functionality.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobExplorer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.core.explore.support.JobExplorerFactoryBean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used to address lookup functionality provided by the <code>JsrJobOperator</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobParametersConverter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.core.jsr.JsrJobParametersConverter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSR-352 specific implementation of the <code>JobParametersConverter</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobRegistry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.core.configuration.support.MapJobRegistry</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used by the <code>SimpleJobOperator</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">placeholderProperties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.beans.factory.config.PropertyPlaceholderConfigure</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loads the properties file <code>batch-${ENVIRONMENT:hsql}.properties</code> to configure
									the properties mentioned above.  ENVIRONMENT is a System property (defaults to hsql)
									that can be used to specify any of the supported databases Spring Batch currently
									supports.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>None of the above beans are optional for executing JSR-352 based jobs.  All may be overriden to
				provide customized functionality as needed.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dependencyInjection"><a class="anchor" href="#dependencyInjection"></a>12.3. Dependency Injection</h3>
<div class="paragraph">
<p>JSR-352 is based heavily on the Spring Batch programming model.  As such, while not explicitly requiring a
            formal dependency injection implementation, DI of some kind implied.  Spring Batch supports all three
            methods for loading batch artifacts defined by JSR-352:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implementation Specific Loader - Spring Batch is built upon Spring and so supports Spring
dependency injection within JSR-352 batch jobs.</p>
</li>
<li>
<p>Archive Loader - JSR-352 defines the existing of a batch.xml file that provides mappings between a
logical name and a class name.  This file must be found within the /META-INF/ directory if it is
used.</p>
</li>
<li>
<p>Thread Context Class Loader - JSR-352 allows configurations to specify batch artifact
implementations in their JSL by providing the fully qualified class name inline.  Spring Batch
supports this as well in JSR-352 configured jobs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use Spring dependency injection within a JSR-352 based batch job consists of configuring batch
            artifacts using a Spring application context as beans.  Once the beans have been defined, a job can refer to
            them as it would any bean defined within the batch.xml.</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span>
                              <span class="content">https://www.springframework.org/schema/beans/spring-beans.xsd</span>
                              <span class="content">http://xmlns.jcp.org/xml/ns/javaee</span>
                              <span class="content">https://xmlns.jcp.org/xml/ns/javaee/jobXML_1_0.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- javax.batch.api.Batchlet implementation --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooBatchlet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">io.spring.FooBatchlet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">prop</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- Job is defined using the JSL schema provided in JSR-352 --&gt;</span>
    <span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batchlet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooBatchlet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/step&gt;</span>
    <span class="tag">&lt;/job&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BatchConfiguration</span> {

    <span class="annotation">@Bean</span>
    <span class="directive">public</span> Batchlet fooBatchlet() {
        FooBatchlet batchlet = <span class="keyword">new</span> FooBatchlet();
        batchlet.setProp(<span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> batchlet;
       }
}


&lt;?xml version=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span> encoding=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>?&gt;
&lt;job id=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooJob</span><span class="delimiter">&quot;</span></span> xmlns=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee</span><span class="delimiter">&quot;</span></span> version=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span>&gt;
    &lt;step id=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> &gt;
        &lt;batchlet ref=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooBatchlet</span><span class="delimiter">&quot;</span></span> /&gt;
    &lt;/step&gt;
&lt;/job&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The assembly of Spring contexts (imports, etc) works with JSR-352 jobs just as it would with any other
            Spring based application.  The only difference with a JSR-352 based job is that the entry point for the
            context definition will be the job definition found in /META-INF/batch-jobs/.</p>
</div>
<div class="paragraph">
<p>To use the thread context class loader approach, all you need to do is provide the fully qualified class
            name as the ref.  It is important to note that when using this approach or the batch.xml approach, the class
            referenced requires a no argument constructor which will be used to create the bean.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
        <span class="tag">&lt;batchlet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">io.spring.FooBatchlet</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jsrJobProperties"><a class="anchor" href="#jsrJobProperties"></a>12.4. Batch Properties</h3>
<div class="sect3">
<h4 id="jsrPropertySupport"><a class="anchor" href="#jsrPropertySupport"></a>12.4.1. Property Support</h4>
<div class="paragraph">
<p>JSR-352 allows for properties to be defined at the Job, Step and batch artifact level by way of
                configuration in the JSL. Batch properties are configured at each level in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;properties&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">propertyName1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">propertyValue1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">propertyName2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">propertyValue2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/properties&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Properties</code> may be configured on any batch artifact.</p>
</div>
</div>
<div class="sect3">
<h4 id="jsrBatchPropertyAnnotation"><a class="anchor" href="#jsrBatchPropertyAnnotation"></a>12.4.2. @BatchProperty annotation</h4>
<div class="paragraph">
<p><code>Properties</code> are referenced in batch artifacts by annotating class fields with the
               <code>@BatchProperty</code> and <code>@Inject</code> annotations (both annotations
                are required by the spec). As defined by JSR-352, fields for properties must be String typed. Any type
                conversion is up to the implementing developer to perform.</p>
</div>
<div class="paragraph">
<p>An <code>javax.batch.api.chunk.ItemReader</code> artifact could be configured with a
                properties block such as the one described above and accessed as such:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyItemReader</span> <span class="directive">extends</span> AbstractItemReader {
    <span class="annotation">@Inject</span>
    <span class="annotation">@BatchProperty</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> propertyName1;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The value of the field "propertyName1" will be "propertyValue1"</p>
</div>
</div>
<div class="sect3">
<h4 id="jsrPropertySubstitution"><a class="anchor" href="#jsrPropertySubstitution"></a>12.4.3. Property Substitution</h4>
<div class="paragraph">
<p>Property substitution is provided by way of operators and simple conditional expressions. The general
                usage is <code>#{operator['key']}</code>.</p>
</div>
<div class="paragraph">
<p>Supported operators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>jobParameters - access job parameter values that the job was started/restarted with.</p>
</li>
<li>
<p>jobProperties - access properties configured at the job level of the JSL.</p>
</li>
<li>
<p>systemProperties - access named system properties.</p>
</li>
<li>
<p>partitionPlan - access named property from the partition plan of a partitioned step.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>#{jobParameters['unresolving.prop']}?:#{systemProperties['file.separator']}</pre>
</div>
</div>
<div class="paragraph">
<p>The left hand side of the assignment is the expected value, the right hand side is the default value. In
this example, the result will resolve to a value of the system property <code>file.separator</code> as
<code>#{jobParameters['unresolving.prop']}</code> is assumed to not be resolvable. If neither expressions can be
resolved, an empty String will be returned. Multiple conditions can be used, which are separated by a
';'.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jsrProcessingModels"><a class="anchor" href="#jsrProcessingModels"></a>12.5. Processing Models</h3>
<div class="paragraph">
<p>JSR-352 provides the same two basic processing models that Spring Batch does:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Item based processing - Using an <code>javax.batch.api.chunk.ItemReader</code>, an
optional <code>javax.batch.api.chunk.ItemProcessor</code>, and an
<code>javax.batch.api.chunk.ItemWriter</code>.</p>
</li>
<li>
<p>Task based processing - Using a <code>javax.batch.api.Batchlet</code>
implementation.  This processing model is the same as the
<code>org.springframework.batch.core.step.tasklet.Tasklet</code> based processing
currently available.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="item-based-processing"><a class="anchor" href="#item-based-processing"></a>12.5.1. Item based processing</h4>
<div class="paragraph">
<p>Item based processing in this context is a chunk size being set by the number of items read by an
                <code>ItemReader</code>.  To configure a step this way, specify the
                <code>item-count</code> (which defaults to 10) and optionally configure the
                <code>checkpoint-policy</code> as item (this is the default).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">...
<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;chunk</span> <span class="attribute-name">checkpoint-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">item-count</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;reader</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooReader</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;processor</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;writer</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/chunk&gt;</span>
<span class="tag">&lt;/step&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If item based checkpointing is chosen, an additional attribute <code>time-limit</code> is
    supported.  This sets a time limit for how long the number of items specified has to be processed.  If
    the timeout is reached, the chunk will complete with however many items have been read by then
    regardless of what the <code>item-count</code> is configured to be.</p>
</div>
</div>
<div class="sect3">
<h4 id="custom-checkpointing"><a class="anchor" href="#custom-checkpointing"></a>12.5.2. Custom checkpointing</h4>
<div class="paragraph">
<p>JSR-352 calls the process around the commit interval within a step "checkpointing".  Item based
                checkpointing is one approach as mentioned above.  However, this will not be robust enough in many
                cases.  Because of this, the spec allows for the implementation of a custom checkpointing algorithm by
                implementing the <code>javax.batch.api.chunk.CheckpointAlgorithm</code> interface.  This
                functionality is functionally the same as Spring Batch&#8217;s custom completion policy.  To use an
                implementation of <code>CheckpointAlgorithm</code>, configure your step with the custom
                <code>checkpoint-policy</code> as shown below where <code>fooCheckpointer</code> refers to an
                implementation of <code>CheckpointAlgorithm</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">...
<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;chunk</span> <span class="attribute-name">checkpoint-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;checkpoint-algorithm</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooCheckpointer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;reader</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooReader</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;processor</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;writer</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/chunk&gt;</span>
<span class="tag">&lt;/step&gt;</span>
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jsrRunningAJob"><a class="anchor" href="#jsrRunningAJob"></a>12.6. Running a job</h3>
<div class="paragraph">
<p>The entrance to executing a JSR-352 based job is through the
            <code>javax.batch.operations.JobOperator</code>. Spring Batch provides its own implementation of
            this interface (<code>org.springframework.batch.core.jsr.launch.JsrJobOperator</code>).  This
            implementation is loaded via the <code>javax.batch.runtime.BatchRuntime</code>.  Launching a
            JSR-352 based batch job is implemented as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">JobOperator jobOperator = BatchRuntime.getJobOperator();
<span class="type">long</span> jobExecutionId = jobOperator.start(<span class="string"><span class="delimiter">&quot;</span><span class="content">fooJob</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Properties</span>());</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above code does the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bootstraps a base <code>ApplicationContext</code> - In order to provide batch functionality, the framework
needs some infrastructure bootstrapped.  This occurs once per JVM.  The components that are
bootstrapped are similar to those provided by <code>@EnableBatchProcessing</code>.
Specific details can be found in the javadoc for the <code>JsrJobOperator</code>.</p>
</li>
<li>
<p>Loads an <code>ApplicationContext</code> for the job requested - In the example
above, the framework will look in /META-INF/batch-jobs for a file named fooJob.xml and load a
context that is a child of the shared context mentioned previously.</p>
</li>
<li>
<p>Launch the job - The job defined within the context will be executed asynchronously.  The
<code>JobExecution&#8217;s</code> id will be returned.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All JSR-352 based batch jobs are executed asynchronously.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When <code>JobOperator#start</code> is called using <code>SimpleJobOperator</code>,
            Spring Batch determines if the call is an initial run or a retry of a previously executed run.  Using the
            JSR-352 based <code>JobOperator#start(String jobXMLName, Properties jobParameters)</code>, the
            framework will always create a new JobInstance (JSR-352 job parameters are
            non-identifying).  In order to restart a job, a call to
            <code>JobOperator#restart(long executionId, Properties restartParameters)</code> is required.</p>
</div>
</div>
<div class="sect2">
<h3 id="jsrContexts"><a class="anchor" href="#jsrContexts"></a>12.7. Contexts</h3>
<div class="paragraph">
<p>JSR-352 defines two context objects that are used to interact with the meta-data of a job or step from
            within a batch artifact: <code>javax.batch.runtime.context.JobContext</code> and
            <code>javax.batch.runtime.context.StepContext</code>.  Both of these are available in any step
            level artifact (<code>Batchlet</code>, <code>ItemReader</code>, etc) with the
            <code>JobContext</code> being available to job level artifacts as well
            (<code>JobListener</code> for example).</p>
</div>
<div class="paragraph">
<p>To obtain a reference to the <code>JobContext</code> or <code>StepContext</code>
            within the current scope, simply use the <code>@Inject</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span>
JobContext jobContext;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">@Autowire for JSR-352 contexts</div>
<div class="paragraph">
<p>Using Spring&#8217;s @Autowire is not supported for the injection of these contexts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In Spring Batch, the <code>JobContext</code> and <code>StepContext</code> wrap their
            corresponding execution objects (<code>JobExecution</code> and
            <code>StepExecution</code> respectively).  Data stored via
            <code>StepContext#setPersistentUserData(Serializable data)</code> is stored in the
            Spring Batch <code>StepExecution#executionContext</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="jsrStepFlow"><a class="anchor" href="#jsrStepFlow"></a>12.8. Step Flow</h3>
<div class="paragraph">
<p>Within a JSR-352 based job, the flow of steps works similarly as it does within Spring Batch.
            However, there are a few subtle differences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Decision&#8217;s are steps - In a regular Spring Batch job, a decision is a state that does not
have an independent <code>StepExecution</code> or any of the rights and
responsibilities that go along with being a full step..  However, with JSR-352, a decision
is a step just like any other and will behave just as any other steps (transactionality,
it gets a <code>StepExecution</code>, etc).  This means that they are treated the
same as any other step on restarts as well.</p>
</li>
<li>
<p><code>next</code> attribute and step transitions - In a regular job, these are
allowed to appear together in the same step.  JSR-352 allows them to both be used in the
same step with the next attribute taking precedence in evaluation.</p>
</li>
<li>
<p>Transition element ordering - In a standard Spring Batch job, transition elements are
sorted from most specific to least specific and evaluated in that order.  JSR-352 jobs
evaluate transition elements in the order they are specified in the XML.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="jsrScaling"><a class="anchor" href="#jsrScaling"></a>12.9. Scaling a JSR-352 batch job</h3>
<div class="paragraph">
<p>Traditional Spring Batch jobs have four ways of scaling (the last two capable of being executed across
            multiple JVMs):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Split - Running multiple steps in parallel.</p>
</li>
<li>
<p>Multiple threads - Executing a single step via multiple threads.</p>
</li>
<li>
<p>Partitioning - Dividing the data up for parallel processing (master/slave).</p>
</li>
<li>
<p>Remote Chunking - Executing the processor piece of logic remotely.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>JSR-352 provides two options for scaling batch jobs.  Both options support only a single JVM:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Split - Same as Spring Batch</p>
</li>
<li>
<p>Partitioning - Conceptually the same as Spring Batch however implemented slightly different.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="jsrPartitioning"><a class="anchor" href="#jsrPartitioning"></a>12.9.1. Partitioning</h4>
<div class="paragraph">
<p>Conceptually, partitioning in JSR-352 is the same as it is in Spring Batch.  Meta-data is provided
                to each slave to identify the input to be processed with the slaves reporting back to the master the
                results upon completion.  However, there are some important differences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Partitioned <code>Batchlet</code> - This will run multiple instances of the
configured <code>Batchlet</code> on multiple threads.  Each instance will have
it&#8217;s own set of properties as provided by the JSL or the
<code>PartitionPlan</code></p>
</li>
<li>
<p><code>PartitionPlan</code> - With Spring Batch&#8217;s partitioning, an
<code>ExecutionContext</code> is provided for each partition.  With JSR-352, a
single <code>javax.batch.api.partition.PartitionPlan</code> is provided with an
array of <code>Properties</code> providing the meta-data for each partition.</p>
</li>
<li>
<p><code>PartitionMapper</code> - JSR-352 provides two ways to generate partition
meta-data.  One is via the JSL (partition properties).  The second is via an implementation
of the <code>javax.batch.api.partition.PartitionMapper</code> interface.
Functionally, this interface is similar to the
<code>org.springframework.batch.core.partition.support.Partitioner</code>
interface provided by Spring Batch in that it provides a way to programmatically generate
meta-data for partitioning.</p>
</li>
<li>
<p><code>StepExecutions</code> - In Spring Batch, partitioned steps are run as
master/slave. Within JSR-352, the same configuration occurs.  However, the slave steps do
not get official <code>StepExecutions</code>.  Because of that, calls to
<code>JsrJobOperator#getStepExecutions(long jobExecutionId)</code> will only
return the <code>StepExecution</code> for the master.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The child <code>StepExecutions</code> still exist in the job repository and are available
via the <code>JobExplorer</code> and Spring Batch Admin.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Compensating logic - Since Spring Batch implements the master/slave logic of
partitioning using steps, <code>StepExecutionListeners</code> can be used to
handle compensating logic if something goes wrong.  However, since the slaves JSR-352
provides a collection of other components for the ability to provide compensating logic when
errors occur and to dynamically set the exit status.  These components include the following:</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Artifact Interface</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.batch.api.partition.PartitionCollector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides a way for slave steps to send information back to the
                                                master.  There is one instance per slave thread.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.batch.api.partition.PartitionAnalyzer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">End point that receives the information collected by the
                                                <code>PartitionCollector</code> as well as the resulting
                                                statuses from a completed partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.batch.api.partition.PartitionReducer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides the ability to provide compensating logic for a partitioned
                                                step.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="jsrTesting"><a class="anchor" href="#jsrTesting"></a>12.10. Testing</h3>
<div class="paragraph">
<p>Since all JSR-352 based jobs are executed asynchronously, it can be difficult to determine when a job has
            completed.  To help with testing, Spring Batch provides the
            <code>org.springframework.batch.test.JsrTestUtils</code>.  This utility class provides the
            ability to start a job and restart a job and wait for it to complete.  Once the job completes, the
            associated <code>JobExecution</code> is returned.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="springBatchIntegration"><a class="anchor" href="#springBatchIntegration"></a>13. Spring Batch Integration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="spring-batch-integration-introduction"><a class="anchor" href="#spring-batch-integration-introduction"></a>13.1. Spring Batch Integration Introduction</h3>
<div class="paragraph">
<p>Many users of Spring Batch may encounter requirements that are
outside the scope of Spring Batch but that may be efficiently and
concisely implemented by using Spring Integration. Conversely, Spring
Integration users may encounter Spring Batch requirements and need a way
to efficiently integrate both frameworks. In this context, several
patterns and use-cases emerge, and Spring Batch Integration
addresses those requirements.</p>
</div>
<div class="paragraph">
<p>The line between Spring Batch and Spring Integration is not always
clear, but two pieces of advice can
help: Think about granularity, and apply common patterns. Some
of those common patterns are described in this reference manual
section.</p>
</div>
<div class="paragraph">
<p>Adding messaging to a batch process enables automation of
operations and also separation and strategizing of key concerns.
For example, a message might trigger a job to execute, and then the
sending of the message can be exposed in a variety of ways. Alternatively, when
a job completes or fails, that event might trigger a message to be sent,
and the consumers of those messages might have operational concerns
that have nothing to do with the application itself. Messaging can
also be embedded in a job (for example reading or writing items for
processing via channels). Remote partitioning and remote chunking
provide methods to distribute workloads over a number of workers.</p>
</div>
<div class="paragraph">
<p>This section covers the following key concepts:</p>
</div>
<div class="ulist xmlContent">
<ul>
<li>
<p><a href="#namespace-support">Namespace Support</a></p>
</li>
</ul>
</div>
<div id="continue-section-list" class="ulist">
<ul>
<li>
<p><a href="#launching-batch-jobs-through-messages">Launching Batch Jobs through Messages</a></p>
</li>
<li>
<p><a href="#providing-feedback-with-informational-messages">Providing Feedback with Informational Messages</a></p>
</li>
<li>
<p><a href="#asynchronous-processors">Asynchronous Processors</a></p>
</li>
<li>
<p><a href="#externalizing-batch-process-execution">Externalizing
Batch Process Execution</a></p>
</li>
</ul>
</div>
<div class="sect3 xmlContent">
<h4 id="namespace-support"><a class="anchor" href="#namespace-support"></a>13.1.1. Namespace Support</h4>
<div class="paragraph">
<p>Since Spring Batch Integration 1.3, dedicated XML Namespace
support was added, with the aim to provide an easier configuration
experience. In order to activate the namespace, add the following
namespace declarations to your Spring XML Application Context
file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">xmlns:batch-int</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch-integration</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
    <span class="content">http://www.springframework.org/schema/batch-integration</span>
    <span class="content">https://www.springframework.org/schema/batch-integration/spring-batch-integration.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    ...

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A fully configured Spring XML Application Context file for Spring
Batch Integration may look like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">xmlns:int</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/integration</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">xmlns:batch-int</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch-integration</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
    <span class="content">http://www.springframework.org/schema/batch-integration</span>
    <span class="content">https://www.springframework.org/schema/batch-integration/spring-batch-integration.xsd</span>
    <span class="content">http://www.springframework.org/schema/batch</span>
    <span class="content">https://www.springframework.org/schema/batch/spring-batch.xsd</span>
    <span class="content">http://www.springframework.org/schema/beans</span>
    <span class="content">https://www.springframework.org/schema/beans/spring-beans.xsd</span>
    <span class="content">http://www.springframework.org/schema/integration</span>
    <span class="content">https://www.springframework.org/schema/integration/spring-integration.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    ...

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Appending version numbers to the referenced XSD file is also
allowed, but, as a version-less declaration always uses the
latest schema, we generally do not recommend appending the version
number to the XSD name. Adding a version number
could possibly create issues when updating the Spring Batch
Integration dependencies, as they may require more recent versions
of the XML schema.</p>
</div>
</div>
<div class="sect3">
<h4 id="launching-batch-jobs-through-messages"><a class="anchor" href="#launching-batch-jobs-through-messages"></a>13.1.2. Launching Batch Jobs through Messages</h4>
<div class="paragraph">
<p>When starting batch jobs by using the core Spring Batch API, you
basically have 2 options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>From the command line, with the <code>CommandLineJobRunner</code></p>
</li>
<li>
<p>Programmatically, with either <code>JobOperator.start()</code> or <code>JobLauncher.run()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, you may want to use the
<code>CommandLineJobRunner</code> when invoking Batch Jobs by
using a shell script. Alternatively, you may use the
<code>JobOperator</code> directly (for example, when using
Spring Batch as part of a web application). However, what about
more complex use cases? Maybe you need to poll a remote (S)FTP
server to retrieve the data for the Batch Job or your application
has to support multiple different data sources simultaneously. For
example, you may receive data files not only from the web, but also from
FTP and other sources. Maybe additional transformation of the input files is
needed before invoking Spring Batch.</p>
</div>
<div class="paragraph">
<p>Therefore, it would be much more powerful to execute the batch job
using Spring Integration and its numerous adapters. For example,
you can use a <em>File Inbound Channel Adapter</em> to
monitor a directory in the file-system and start the Batch Job as
soon as the input file arrives. Additionally, you can create Spring
Integration flows that use multiple different adapters to easily
ingest data for your batch jobs from multiple sources
simultaneously using only configuration. Implementing all these
scenarios with Spring Integration is easy, as it allows for
decoupled, event-driven execution of the
<code>JobLauncher</code>.</p>
</div>
<div class="paragraph">
<p>Spring Batch Integration provides the
<code>JobLaunchingMessageHandler</code> class that you can
use to launch batch jobs. The input for the
<code>JobLaunchingMessageHandler</code> is provided by a
Spring Integration message, which has a payload of type
<code>JobLaunchRequest</code>. This class is a wrapper around the <code>Job</code>
    that needs to be launched and around the <code>JobParameters</code>
necessary to launch the Batch job.</p>
</div>
<div class="paragraph">
<p>The following image illustrates the typical Spring Integration
message flow in order to start a Batch job. The
<a href="https://www.enterpriseintegrationpatterns.com/toc.html">EIP (Enterprise Integration Patterns) website</a>
provides a full overview of messaging icons and their descriptions.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/launch-batch-job.png" alt="Launch Batch Job">
</div>
<div class="title">Figure 27. Launch Batch Job</div>
</div>
<div class="sect4">
<h5 id="transforming-a-file-into-a-joblaunchrequest"><a class="anchor" href="#transforming-a-file-into-a-joblaunchrequest"></a>Transforming a file into a JobLaunchRequest</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.spring.sbi</span>;

<span class="keyword">import</span> <span class="include">org.springframework.batch.core.Job</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.core.JobParametersBuilder</span>;
<span class="keyword">import</span> <span class="include">org.springframework.batch.integration.launch.JobLaunchRequest</span>;
<span class="keyword">import</span> <span class="include">org.springframework.integration.annotation.Transformer</span>;
<span class="keyword">import</span> <span class="include">org.springframework.messaging.Message</span>;

<span class="keyword">import</span> <span class="include">java.io.File</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">FileMessageToJobRequest</span> {
    <span class="directive">private</span> Job job;
    <span class="directive">private</span> <span class="predefined-type">String</span> fileParameterName;

    <span class="directive">public</span> <span class="type">void</span> setFileParameterName(<span class="predefined-type">String</span> fileParameterName) {
        <span class="local-variable">this</span>.fileParameterName = fileParameterName;
    }

    <span class="directive">public</span> <span class="type">void</span> setJob(Job job) {
        <span class="local-variable">this</span>.job = job;
    }

    <span class="annotation">@Transformer</span>
    <span class="directive">public</span> JobLaunchRequest toRequest(Message&lt;<span class="predefined-type">File</span>&gt; message) {
        JobParametersBuilder jobParametersBuilder =
            <span class="keyword">new</span> JobParametersBuilder();

        jobParametersBuilder.addString(fileParameterName,
            message.getPayload().getAbsolutePath());

        <span class="keyword">return</span> <span class="keyword">new</span> JobLaunchRequest(job, jobParametersBuilder.toJobParameters());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="the-jobexecution-response"><a class="anchor" href="#the-jobexecution-response"></a>The <code>JobExecution</code> Response</h5>
<div class="paragraph">
<p>When a batch job is being executed, a
<code>JobExecution</code> instance is returned. This
instance can be used to determine the status of an execution. If
a <code>JobExecution</code> is able to be created
successfully, it is always returned, regardless of whether
or not the actual execution is successful.</p>
</div>
<div class="paragraph">
<p>The exact behavior on how the <code>JobExecution</code>
instance is returned depends on the provided
<code>TaskExecutor</code>. If a
<code>synchronous</code> (single-threaded)
<code>TaskExecutor</code> implementation is used, the
<code>JobExecution</code> response is returned only
<code>after</code> the job completes. When using an
<code>asynchronous</code>
<code>TaskExecutor</code>, the
<code>JobExecution</code> instance is returned
immediately. Users can then take the <code>id</code> of
<code>JobExecution</code> instance
(with <code>JobExecution.getJobId()</code>) and query the
<code>JobRepository</code> for the job&#8217;s updated status
using the <code>JobExplorer</code>. For more
information, please refer to the Spring
Batch reference documentation on
<a href="#queryingRepository">Querying the Repository</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="spring-batch-integration-configuration"><a class="anchor" href="#spring-batch-integration-configuration"></a>Spring Batch Integration Configuration</h5>
<div class="paragraph">
<p>The following configuration creates a file
<code>inbound-channel-adapter</code> to listen for CSV
files in the provided directory, hand them off to our
transformer (<code>FileMessageToJobRequest</code>),
launch the job via the <em>Job Launching Gateway</em>, and then log the output of the
<code>JobExecution</code> with the
<code>logging-channel-adapter</code>.</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;int:channel</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inboundFileChannel</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;int:channel</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outboundJobRequestChannel</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;int:channel</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLaunchReplyChannel</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;int-file:inbound-channel-adapter</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">filePoller</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inboundFileChannel</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">directory</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:/tmp/myfiles/</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">filename-pattern</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*.csv</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;int:poller</span> <span class="attribute-name">fixed-rate</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/int-file:inbound-channel-adapter&gt;</span>

<span class="tag">&lt;int:transformer</span> <span class="attribute-name">input-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inboundFileChannel</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">output-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outboundJobRequestChannel</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">io.spring.sbi.FileMessageToJobRequest</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">personJob</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileParameterName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">input.file.name</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/int:transformer&gt;</span>

<span class="tag">&lt;batch-int:job-launching-gateway</span> <span class="attribute-name">request-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outboundJobRequestChannel</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">reply-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLaunchReplyChannel</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;int:logging-channel-adapter</span> <span class="attribute-name">channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLaunchReplyChannel</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> FileMessageToJobRequest fileMessageToJobRequest() {
    FileMessageToJobRequest fileMessageToJobRequest = <span class="keyword">new</span> FileMessageToJobRequest();
    fileMessageToJobRequest.setFileParameterName(<span class="string"><span class="delimiter">&quot;</span><span class="content">input.file.name</span><span class="delimiter">&quot;</span></span>);
    fileMessageToJobRequest.setJob(personJob());
    <span class="keyword">return</span> fileMessageToJobRequest;
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> JobLaunchingGateway jobLaunchingGateway() {
    SimpleJobLauncher simpleJobLauncher = <span class="keyword">new</span> SimpleJobLauncher();
    simpleJobLauncher.setJobRepository(jobRepository);
    simpleJobLauncher.setTaskExecutor(<span class="keyword">new</span> SyncTaskExecutor());
    JobLaunchingGateway jobLaunchingGateway = <span class="keyword">new</span> JobLaunchingGateway(simpleJobLauncher);

    <span class="keyword">return</span> jobLaunchingGateway;
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> IntegrationFlow integrationFlow(JobLaunchingGateway jobLaunchingGateway) {
    <span class="keyword">return</span> IntegrationFlows.from(Files.inboundAdapter(<span class="keyword">new</span> <span class="predefined-type">File</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/myfiles</span><span class="delimiter">&quot;</span></span>)).
                    filter(<span class="keyword">new</span> SimplePatternFileListFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">*.csv</span><span class="delimiter">&quot;</span></span>)),
            c -&gt; c.poller(Pollers.fixedRate(<span class="integer">1000</span>).maxMessagesPerPoll(<span class="integer">1</span>))).
            handle(fileMessageToJobRequest()).
            handle(jobLaunchingGateway).
            log(LoggingHandler.Level.WARN, <span class="string"><span class="delimiter">&quot;</span><span class="content">headers.id + ': ' + payload</span><span class="delimiter">&quot;</span></span>).
            get();
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example-itemreader-configuration"><a class="anchor" href="#example-itemreader-configuration"></a>Example ItemReader Configuration</h5>
<div class="paragraph">
<p>Now that we are polling for files and launching jobs, we need to
configure our Spring Batch
<code>ItemReader</code> (for example) to use the files found at the location defined
by the job parameter called "input.file.name", as shown in the following bean configuration:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file://#{jobParameters['input.file.name']}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    ...
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="annotation">@StepScope</span>
<span class="directive">public</span> ItemReader sampleReader(<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters[input.file.name]}</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> resource) {
...
    FlatFileItemReader flatFileItemReader = <span class="keyword">new</span> FlatFileItemReader();
    flatFileItemReader.setResource(<span class="keyword">new</span> FileSystemResource(resource));
...
    return flatFileItemReader;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The main points of interest in the preceding example are injecting the value of
<code>#{jobParameters['input.file.name']}</code>
as the Resource property value and setting the <code>ItemReader</code> bean
to have <em>Step scope</em>. Setting the bean to have Step scope takes advantage of
the late binding support, which allows access to the
<code>jobParameters</code> variable.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="availableAttributesOfTheJobLaunchingGateway"><a class="anchor" href="#availableAttributesOfTheJobLaunchingGateway"></a>13.2. Available Attributes of the Job-Launching Gateway</h3>
<div class="paragraph">
<p>The job-launching gateway has the following attributes that you can set to control a job:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code>: Identifies the underlying Spring bean definition, which is an instance of either:</p>
<div class="ulist">
<ul>
<li>
<p><code>EventDrivenConsumer</code></p>
</li>
<li>
<p><code>PollingConsumer</code>
(The exact implementation depends on whether the component&#8217;s input channel is a
<code>SubscribableChannel</code> or <code>PollableChannel</code>.)</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>auto-startup</code>: Boolean flag to indicate that the endpoint should start automatically on
startup. The default is <em>true</em>.</p>
</li>
<li>
<p><code>request-channel</code>: The input <code>MessageChannel</code> of this endpoint.</p>
</li>
<li>
<p><code>reply-channel</code>: <code>MessageChannel</code> to which the resulting <code>JobExecution</code> payload is sent.</p>
</li>
<li>
<p><code>reply-timeout</code>: Lets you specify how long (in milliseconds) this gateway waits for the reply message
to be sent successfully to the reply channel before throwing
an exception. This attribute only applies when the channel
might block (for example, when using a bounded queue channel
that is currently full). Also, keep in mind that, when sending to a
<code>DirectChannel</code>, the invocation occurs
in the sender&#8217;s thread. Therefore, the failing of the send
operation may be caused by other components further downstream.
The <code>reply-timeout</code> attribute maps to the
<code>sendTimeout</code> property of the underlying
<code>MessagingTemplate</code> instance. If not specified, the attribute
defaults to&lt;emphasis&gt;-1&lt;/emphasis&gt;,
meaning that, by default, the <code>Gateway</code> waits indefinitely.</p>
</li>
<li>
<p><code>job-launcher</code>: Optional. Accepts a
custom
<code>JobLauncher</code>
bean reference.
If not specified the adapter
re-uses the instance that is registered under the <code>id</code> of
<code>jobLauncher</code>. If no default instance
exists, an exception is thrown.</p>
</li>
<li>
<p><code>order</code>: Specifies the order of invocation when this endpoint is connected as a subscriber
to a <code>SubscribableChannel</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sub-elements"><a class="anchor" href="#sub-elements"></a>13.3. Sub-Elements</h3>
<div class="paragraph">
<p>When this <code>Gateway</code> is receiving messages from a
<code>PollableChannel</code>, you must either provide
a global default <code>Poller</code> or provide a <code>Poller</code> sub-element to the
<code>Job Launching Gateway</code>, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch-int:job-launching-gateway</span> <span class="attribute-name">request-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">queueChannel</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">reply-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replyChannel</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-launcher</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLauncher</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;int:poller</span> <span class="attribute-name">fixed-rate</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;/batch-int:job-launching-gateway&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="annotation">@ServiceActivator</span>(inputChannel = <span class="string"><span class="delimiter">&quot;</span><span class="content">queueChannel</span><span class="delimiter">&quot;</span></span>, poller = <span class="annotation">@Poller</span>(fixedRate=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span>))
<span class="directive">public</span> JobLaunchingGateway sampleJobLaunchingGateway() {
    JobLaunchingGateway jobLaunchingGateway = <span class="keyword">new</span> JobLaunchingGateway(jobLauncher());
    jobLaunchingGateway.setOutputChannel(replyChannel());
    <span class="keyword">return</span> jobLaunchingGateway;
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="providing-feedback-with-informational-messages"><a class="anchor" href="#providing-feedback-with-informational-messages"></a>13.3.1. Providing Feedback with Informational Messages</h4>
<div class="paragraph">
<p>As Spring Batch jobs can run for long times, providing progress
information is often critical. For example, stake-holders may want
to be notified if some or all parts of a batch job have failed.
Spring Batch provides support for this information being gathered
through:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Active polling</p>
</li>
<li>
<p>Event-driven listeners</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When starting a Spring Batch job asynchronously (for example, by using the
<code>Job Launching Gateway</code>), a
<code>JobExecution</code> instance is returned. Thus,
<code>JobExecution.getJobId()</code> can be used to
continuously poll for status updates by retrieving updated
instances of the <code>JobExecution</code> from the
<code>JobRepository</code> by using the
<code>JobExplorer</code>. However, this is considered
sub-optimal, and an event-driven approach should be preferred.</p>
</div>
<div class="paragraph">
<p>Therefore, Spring Batch provides listeners, including the three most commonly used listeners:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>StepListener</p>
</li>
<li>
<p>ChunkListener</p>
</li>
<li>
<p>JobExecutionListener</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the example shown in the following image, a Spring Batch job has been configured with a
<code>StepExecutionListener</code>. Thus, Spring
Integration receives and processes any step before or after
events. For example, the received
<code>StepExecution</code> can be inspected by using a
<code>Router</code>. Based on the results of that
inspection, various things can occur (such as routing a message
to a Mail Outbound Channel Adapter), so that an Email notification
can be sent out based on some condition.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/handling-informational-messages.png" alt="Handling Informational Messages">
</div>
<div class="title">Figure 28. Handling Informational Messages</div>
</div>
<div class="paragraph">
<p>The following two-part example shows how a listener is configured to send a
message to a <code>Gateway</code> for a
<code>StepExecution</code> events and log its output to a
<code>logging-channel-adapter</code>.</p>
</div>
<div class="paragraph">
<p>First, create the notification integration beans:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;int:channel</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepExecutionsChannel</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;int:gateway</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">notificationExecutionsListener</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">service-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.StepExecutionListener</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">default-request-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepExecutionsChannel</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;int:logging-channel-adapter</span> <span class="attribute-name">channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepExecutionsChannel</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="annotation">@ServiceActivator</span>(inputChannel = <span class="string"><span class="delimiter">&quot;</span><span class="content">stepExecutionsChannel</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> LoggingHandler loggingHandler() {
    LoggingHandler adapter = <span class="keyword">new</span> LoggingHandler(LoggingHandler.Level.WARN);
    adapter.setLoggerName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TEST_LOGGER</span><span class="delimiter">&quot;</span></span>);
    adapter.setLogExpressionString(<span class="string"><span class="delimiter">&quot;</span><span class="content">headers.id + ': ' + payload</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> adapter;
}

<span class="annotation">@MessagingGateway</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">notificationExecutionsListener</span><span class="delimiter">&quot;</span></span>, defaultRequestChannel = <span class="string"><span class="delimiter">&quot;</span><span class="content">stepExecutionsChannel</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">NotificationExecutionListener</span> <span class="directive">extends</span> StepExecutionListener {}</code></pre>
</div>
</div>
<div class="admonitionblock note javaContent">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will need to add the <code>@IntegrationComponentScan</code> annotation to your configuration.
</td>
</tr>
</table>
</div>
<div id="message-gateway-entry-list" class="paragraph">
<p>Second, modify your job to add a step-level listener:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">importPayments</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet</span> <span class="attribute-name">..</span><span class="tag">/&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">..</span><span class="tag">/&gt;</span>
            <span class="tag">&lt;listeners&gt;</span>
                <span class="tag">&lt;listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">notificationExecutionsListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/listeners&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
        ...
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> Job importPaymentsJob() {
    <span class="keyword">return</span> jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">importPayments</span><span class="delimiter">&quot;</span></span>)
        .start(stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                .chunk(<span class="integer">200</span>)
                .listener(notificationExecutionsListener())
                ...
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="asynchronous-processors"><a class="anchor" href="#asynchronous-processors"></a>13.3.2. Asynchronous Processors</h4>
<div class="paragraph">
<p>Asynchronous Processors help you to scale the processing of
items. In the asynchronous processor use case, an
<code>AsyncItemProcessor</code> serves as a dispatcher,
executing the logic of the <code>ItemProcessor</code> for an
item on a new thread. Once the item completes, the <code>Future</code> is passed to
the <code>AsynchItemWriter</code> to be written.</p>
</div>
<div class="paragraph">
<p>Therefore, you can increase performance by using asynchronous item
processing, basically allowing you to implement
<em>fork-join</em> scenarios. The
<code>AsyncItemWriter</code> gathers the results and
writes back the chunk as soon as all the results become available.</p>
</div>
<div class="paragraph">
<p>The following example shows how to configuration the <code>AsyncItemProcessor</code>:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">processor</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.integration.async.AsyncItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegate</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">your.ItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.core.task.SimpleAsyncTaskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> AsyncItemProcessor processor(ItemProcessor itemProcessor, TaskExecutor taskExecutor) {
    AsyncItemProcessor asyncItemProcessor = <span class="keyword">new</span> AsyncItemProcessor();
    asyncItemProcessor.setTaskExecutor(taskExecutor);
    asyncItemProcessor.setDelegate(itemProcessor);
    <span class="keyword">return</span> asyncItemProcessor;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>delegate</code> property refers
to your <code>ItemProcessor</code> bean, and
the <code>taskExecutor</code> property
refers to the <code>TaskExecutor</code> of your choice.</p>
</div>
<div class="paragraph">
<p>The following example shows how to configure the <code>AsyncItemWriter</code>:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.integration.async.AsyncItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegate</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">your.ItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> AsyncItemWriter writer(ItemWriter itemWriter) {
    AsyncItemWriter asyncItemWriter = <span class="keyword">new</span> AsyncItemWriter();
    asyncItemWriter.setDelegate(itemWriter);
    <span class="keyword">return</span> asyncItemWriter;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, the <code>delegate</code> property is
actually a reference to your <code>ItemWriter</code> bean.</p>
</div>
</div>
<div class="sect3">
<h4 id="externalizing-batch-process-execution"><a class="anchor" href="#externalizing-batch-process-execution"></a>13.3.3. Externalizing Batch Process Execution</h4>
<div class="paragraph">
<p>The integration approaches discussed so far suggest use cases
where Spring Integration wraps Spring Batch like an outer-shell.
However, Spring Batch can also use Spring Integration internally.
Using this approach, Spring Batch users can delegate the
processing of items or even chunks to outside processes. This
allows you to offload complex processing. Spring Batch Integration
provides dedicated support for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Remote Chunking</p>
</li>
<li>
<p>Remote Partitioning</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="remote-chunking"><a class="anchor" href="#remote-chunking"></a>Remote Chunking</h5>
<div class="imageblock">
<div class="content">
<img src="./images/remote-chunking-sbi.png" alt="Remote Chunking">
</div>
<div class="title">Figure 29. Remote Chunking</div>
</div>
<div class="paragraph">
<p>Taking things one step further, one can also externalize the
chunk processing by using the
<code>ChunkMessageChannelItemWriter</code>
(provided by Spring Batch Integration), which sends items out
and collects the result. Once sent, Spring Batch continues the
process of reading and grouping items, without waiting for the results.
Rather, it is the responsibility of the <code>ChunkMessageChannelItemWriter</code>
to gather the results and integrate them back into the Spring Batch process.</p>
</div>
<div class="paragraph">
<p>With Spring Integration, you have full
control over the concurrency of your processes (for instance, by
using a <code>QueueChannel</code> instead of a
<code>DirectChannel</code>). Furthermore, by relying on
Spring Integration&#8217;s rich collection of Channel Adapters (such as
JMS and AMQP), you can distribute chunks of a Batch job to
external systems for processing.</p>
</div>
<div class="paragraph">
<p>A simple job with a step to be remotely chunked might have a
configuration similar to the following:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">personJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tasklet&gt;</span>
      <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tasklet&gt;</span>
    ...
  <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> Job chunkJob() {
     <span class="keyword">return</span> jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">personJob</span><span class="delimiter">&quot;</span></span>)
             .start(stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>)
                     .&lt;Person, Person&gt;chunk(<span class="integer">200</span>)
                     .reader(itemReader())
                     .writer(itemWriter())
                     .build())
             .build();
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ItemReader</code> reference points to the bean you want
to use for reading data on the master. The <code>ItemWriter</code> reference
points to a special <code>ItemWriter</code>
(called <code>ChunkMessageChannelItemWriter</code>),
as described above. The processor (if any) is left off the
master configuration, as it is configured on the worker. The
following configuration provides a basic master setup. You
should check any additional component properties, such as
throttle limits and so on, when implementing your use case.</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">connectionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.activemq.ActiveMQConnectionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">brokerURL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tcp://localhost:61616</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;int-jms:outbound-channel-adapter</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jmsRequests</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">destination-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">requests</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">messagingTemplate</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.integration.core.MessagingTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultChannel</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">requests</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">receiveTimeout</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.integration.chunk.ChunkMessageChannelItemWriter</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">messagingOperations</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">messagingTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replyChannel</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replies</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;int:channel</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replies</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;int:queue</span><span class="tag">/&gt;</span>
<span class="tag">&lt;/int:channel&gt;</span>

<span class="tag">&lt;int-jms:message-driven-channel-adapter</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jmsReplies</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">destination-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replies</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replies</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> org.apache.activemq.ActiveMQConnectionFactory connectionFactory() {
    ActiveMQConnectionFactory factory = <span class="keyword">new</span> ActiveMQConnectionFactory();
    factory.setBrokerURL(<span class="string"><span class="delimiter">&quot;</span><span class="content">tcp://localhost:61616</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> factory;
}

<span class="comment">/*
 * Configure outbound flow (requests going to workers)
 */</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> DirectChannel requests() {
    <span class="keyword">return</span> <span class="keyword">new</span> DirectChannel();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> IntegrationFlow outboundFlow(ActiveMQConnectionFactory connectionFactory) {
    <span class="keyword">return</span> IntegrationFlows
            .from(requests())
            .handle(Jms.outboundAdapter(connectionFactory).destination(<span class="string"><span class="delimiter">&quot;</span><span class="content">requests</span><span class="delimiter">&quot;</span></span>))
            .get();
}

<span class="comment">/*
 * Configure inbound flow (replies coming from workers)
 */</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> QueueChannel replies() {
    <span class="keyword">return</span> <span class="keyword">new</span> QueueChannel();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> IntegrationFlow inboundFlow(ActiveMQConnectionFactory connectionFactory) {
    <span class="keyword">return</span> IntegrationFlows
            .from(Jms.messageDrivenChannelAdapter(connectionFactory).destination(<span class="string"><span class="delimiter">&quot;</span><span class="content">replies</span><span class="delimiter">&quot;</span></span>))
            .channel(replies())
            .get();
}

<span class="comment">/*
 * Configure the ChunkMessageChannelItemWriter
 */</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> ItemWriter&lt;<span class="predefined-type">Integer</span>&gt; itemWriter() {
    MessagingTemplate messagingTemplate = <span class="keyword">new</span> MessagingTemplate();
    messagingTemplate.setDefaultChannel(requests());
    messagingTemplate.setReceiveTimeout(<span class="integer">2000</span>);
    ChunkMessageChannelItemWriter&lt;<span class="predefined-type">Integer</span>&gt; chunkMessageChannelItemWriter
            = <span class="keyword">new</span> ChunkMessageChannelItemWriter&lt;&gt;();
    chunkMessageChannelItemWriter.setMessagingOperations(messagingTemplate);
    chunkMessageChannelItemWriter.setReplyChannel(replies());
    <span class="keyword">return</span> chunkMessageChannelItemWriter;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding configuration provides us with a number of beans. We
configure our messaging middleware using ActiveMQ and the
inbound/outbound JMS adapters provided by Spring Integration. As
shown, our <code>itemWriter</code> bean, which is
referenced by our job step, uses the
<code>ChunkMessageChannelItemWriter</code> for writing chunks over the
configured middleware.</p>
</div>
<div class="paragraph">
<p>Now we can move on to the worker configuration, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">connectionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.activemq.ActiveMQConnectionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">brokerURL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tcp://localhost:61616</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;int:channel</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">requests</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;int:channel</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replies</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;int-jms:message-driven-channel-adapter</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">incomingRequests</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">destination-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">requests</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">requests</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;int-jms:outbound-channel-adapter</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outgoingReplies</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">destination-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replies</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replies</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;/int-jms:outbound-channel-adapter&gt;</span>

<span class="tag">&lt;int:service-activator</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">serviceActivator</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">input-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">requests</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">output-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replies</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkProcessorChunkHandler</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">handleChunk</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkProcessorChunkHandler</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.integration.chunk.ChunkProcessorChunkHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.step.item.SimpleChunkProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">io.spring.sbi.PersonItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">io.spring.sbi.PersonItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> org.apache.activemq.ActiveMQConnectionFactory connectionFactory() {
    ActiveMQConnectionFactory factory = <span class="keyword">new</span> ActiveMQConnectionFactory();
    factory.setBrokerURL(<span class="string"><span class="delimiter">&quot;</span><span class="content">tcp://localhost:61616</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> factory;
}

<span class="comment">/*
 * Configure inbound flow (requests coming from the master)
 */</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> DirectChannel requests() {
    <span class="keyword">return</span> <span class="keyword">new</span> DirectChannel();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> IntegrationFlow inboundFlow(ActiveMQConnectionFactory connectionFactory) {
    <span class="keyword">return</span> IntegrationFlows
            .from(Jms.messageDrivenChannelAdapter(connectionFactory).destination(<span class="string"><span class="delimiter">&quot;</span><span class="content">requests</span><span class="delimiter">&quot;</span></span>))
            .channel(requests())
            .get();
}

<span class="comment">/*
 * Configure outbound flow (replies going to the master)
 */</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> DirectChannel replies() {
    <span class="keyword">return</span> <span class="keyword">new</span> DirectChannel();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> IntegrationFlow outboundFlow(ActiveMQConnectionFactory connectionFactory) {
    <span class="keyword">return</span> IntegrationFlows
            .from(replies())
            .handle(Jms.outboundAdapter(connectionFactory).destination(<span class="string"><span class="delimiter">&quot;</span><span class="content">replies</span><span class="delimiter">&quot;</span></span>))
            .get();
}

<span class="comment">/*
 * Configure the ChunkProcessorChunkHandler
 */</span>
<span class="annotation">@Bean</span>
<span class="annotation">@ServiceActivator</span>(inputChannel = <span class="string"><span class="delimiter">&quot;</span><span class="content">requests</span><span class="delimiter">&quot;</span></span>, outputChannel = <span class="string"><span class="delimiter">&quot;</span><span class="content">replies</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> ChunkProcessorChunkHandler&lt;<span class="predefined-type">Integer</span>&gt; chunkProcessorChunkHandler() {
    ChunkProcessor&lt;<span class="predefined-type">Integer</span>&gt; chunkProcessor
            = <span class="keyword">new</span> SimpleChunkProcessor&lt;&gt;(itemProcessor(), itemWriter());
    ChunkProcessorChunkHandler&lt;<span class="predefined-type">Integer</span>&gt; chunkProcessorChunkHandler
            = <span class="keyword">new</span> ChunkProcessorChunkHandler&lt;&gt;();
    chunkProcessorChunkHandler.setChunkProcessor(chunkProcessor);
    <span class="keyword">return</span> chunkProcessorChunkHandler;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of these configuration items should look familiar from the
master configuration. Workers do not need access to
the Spring Batch <code>JobRepository</code> nor
to the actual job configuration file. The main bean of interest
is the <code>chunkProcessorChunkHandler</code>. The
<code>chunkProcessor</code> property of <code>ChunkProcessorChunkHandler</code> takes a
configured <code>SimpleChunkProcessor</code>, which is where you would provide a reference to your
<code>ItemWriter</code> (and, optionally, your
<code>ItemProcessor</code>) that will run on the worker
when it receives chunks from the master.</p>
</div>
<div class="paragraph">
<p>For more information, see the section of the "Scalability" chapter on
<a href="https://docs.spring.io/spring-batch/reference/html/scalability.html#remoteChunking">Remote Chunking</a>.</p>
</div>
<div class="paragraph">
<p>Starting from version 4.1, Spring Batch Integration introduces the <code>@EnableBatchIntegration</code>
annotation that can be used to simplify a remote chunking setup. This annotation provides
two beans that can be autowired in the application context:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>RemoteChunkingMasterStepBuilderFactory</code>: used to configure the master step</p>
</li>
<li>
<p><code>RemoteChunkingWorkerBuilder</code>: used to configure the remote worker integration flow</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These APIs take care of configuring a number of components as described in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/remote-chunking-config.png" alt="Remote Chunking Configuration">
</div>
<div class="title">Figure 30. Remote Chunking Configuration</div>
</div>
<div class="paragraph">
<p>On the master side, the <code>RemoteChunkingMasterStepBuilderFactory</code> allows you to
configure a master step by declaring:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the item reader to read items and send them to workers</p>
</li>
<li>
<p>the output channel ("Outgoing requests") to send requests to workers</p>
</li>
<li>
<p>the input channel ("Incoming replies") to receive replies from workers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A <code>ChunkMessageChannelItemWriter</code> and the <code>MessagingTemplate</code> are not needed to be explicitly configured
(Those can still be explicitly configured if required).</p>
</div>
<div class="paragraph">
<p>On the worker side, the <code>RemoteChunkingWorkerBuilder</code> allows you to configure a worker to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>listen to requests sent by the master on the input channel ("Incoming requests")</p>
</li>
<li>
<p>call the <code>handleChunk</code> method of <code>ChunkProcessorChunkHandler</code> for each request
with the configured <code>ItemProcessor</code> and <code>ItemWriter</code></p>
</li>
<li>
<p>send replies on the output channel ("Outgoing replies") to the master</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is no need to explicitly configure the <code>SimpleChunkProcessor</code>
and the <code>ChunkProcessorChunkHandler</code> (Those can be explicitly configured if required).</p>
</div>
<div class="paragraph">
<p>The following example shows how to use these APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@EnableBatchIntegration</span>
<span class="annotation">@EnableBatchProcessing</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RemoteChunkingJobConfiguration</span> {

    <span class="annotation">@Configuration</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">MasterConfiguration</span> {

        <span class="annotation">@Autowired</span>
        <span class="directive">private</span> RemoteChunkingMasterStepBuilderFactory masterStepBuilderFactory;

        <span class="annotation">@Bean</span>
        <span class="directive">public</span> TaskletStep masterStep() {
            <span class="keyword">return</span> <span class="local-variable">this</span>.masterStepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">masterStep</span><span class="delimiter">&quot;</span></span>)
                       .chunk(<span class="integer">100</span>)
                       .reader(itemReader())
                       .outputChannel(requests()) <span class="comment">// requests sent to workers</span>
                       .inputChannel(replies())   <span class="comment">// replies received from workers</span>
                       .build();
        }

        <span class="comment">// Middleware beans setup omitted</span>

    }

    <span class="annotation">@Configuration</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">WorkerConfiguration</span> {

        <span class="annotation">@Autowired</span>
        <span class="directive">private</span> RemoteChunkingWorkerBuilder workerBuilder;

        <span class="annotation">@Bean</span>
        <span class="directive">public</span> IntegrationFlow workerFlow() {
            <span class="keyword">return</span> <span class="local-variable">this</span>.workerBuilder
                       .itemProcessor(itemProcessor())
                       .itemWriter(itemWriter())
                       .inputChannel(requests()) <span class="comment">// requests received from the master</span>
                       .outputChannel(replies()) <span class="comment">// replies sent to the master</span>
                       .build();
        }

        <span class="comment">// Middleware beans setup omitted</span>

    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can find a complete example of a remote chunking job
<a href="https://github.com/spring-projects/spring-batch/tree/master/spring-batch-samples#remote-chunking-sample">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="remote-partitioning"><a class="anchor" href="#remote-partitioning"></a>Remote Partitioning</h5>
<div class="imageblock">
<div class="content">
<img src="./images/remote-partitioning.png" alt="Remote Partitioning">
</div>
<div class="title">Figure 31. Remote Partitioning</div>
</div>
<div class="paragraph">
<p>Remote Partitioning, on the other hand, is useful when it
is not the processing of items but rather the associated I/O that
causes the bottleneck. Using Remote Partitioning, work can
be farmed out to workers that execute complete Spring Batch
steps. Thus, each worker has its own <code>ItemReader</code>, <code>ItemProcessor</code>, and
<code>ItemWriter</code>. For this purpose, Spring Batch
Integration provides the <code>MessageChannelPartitionHandler</code>.</p>
</div>
<div class="paragraph">
<p>This implementation of the <code>PartitionHandler</code>
interface uses <code>MessageChannel</code> instances to
send instructions to remote workers and receive their responses.
This provides a nice abstraction from the transports (such as JMS
and AMQP) being used to communicate with the remote workers.</p>
</div>
<div class="paragraph">
<p>The section of the "Scalability" chapter that addresses
<a href="#partitioning">remote partitioning</a> provides an overview of the concepts and
components needed to configure remote partitioning and shows an
example of using the default
<code>TaskExecutorPartitionHandler</code> to partition
in separate local threads of execution. For remote partitioning
to multiple JVMs, two additional components are required:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A remoting fabric or grid environment</p>
</li>
<li>
<p>A <code>PartitionHandler</code> implementation that supports the desired
remoting fabric or grid environment</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Similar to remote chunking, JMS can be used as the "remoting
fabric". In that case, use a <code>MessageChannelPartitionHandler</code> instance as the <code>PartitionHandler</code> implementation,
as described above.
The following example
assumes an existing partitioned job and focuses on
the <code>MessageChannelPartitionHandler</code> and JMS
configuration:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">partitionHandler</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.integration.partition.MessageChannelPartitionHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gridSize</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replyChannel</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outbound-replies</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">messagingOperations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.integration.core.MessagingTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultChannel</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outbound-requests</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">receiveTimeout</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;int:channel</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outbound-requests</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;int-jms:outbound-channel-adapter</span> <span class="attribute-name">destination</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">requestsQueue</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outbound-requests</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;int:channel</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inbound-requests</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;int-jms:message-driven-channel-adapter</span> <span class="attribute-name">destination</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">requestsQueue</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inbound-requests</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepExecutionRequestHandler</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.integration.partition.StepExecutionRequestHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExplorer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExplorer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepLocator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepLocator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;int:service-activator</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepExecutionRequestHandler</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">input-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inbound-requests</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">output-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outbound-staging</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;int:channel</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outbound-staging</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;int-jms:outbound-channel-adapter</span> <span class="attribute-name">destination</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stagingQueue</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outbound-staging</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;int:channel</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inbound-staging</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;int-jms:message-driven-channel-adapter</span> <span class="attribute-name">destination</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stagingQueue</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inbound-staging</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;int:aggregator</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">partitionHandler</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">input-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inbound-staging</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">output-channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outbound-replies</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;int:channel</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outbound-replies</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;int:queue</span><span class="tag">/&gt;</span>
<span class="tag">&lt;/int:channel&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stepLocator</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.integration.partition.BeanFactoryStepLocator</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/*
 * Configuration of the master side
 */</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> PartitionHandler partitionHandler() {
    MessageChannelPartitionHandler partitionHandler = <span class="keyword">new</span> MessageChannelPartitionHandler();
    partitionHandler.setStepName(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span>);
    partitionHandler.setGridSize(<span class="integer">3</span>);
    partitionHandler.setReplyChannel(outboundReplies());
    MessagingTemplate template = <span class="keyword">new</span> MessagingTemplate();
    template.setDefaultChannel(outboundRequests());
    template.setReceiveTimeout(<span class="integer">100000</span>);
    partitionHandler.setMessagingOperations(template);
    <span class="keyword">return</span> partitionHandler;
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> QueueChannel outboundReplies() {
    <span class="keyword">return</span> <span class="keyword">new</span> QueueChannel();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> DirectChannel outboundRequests() {
    <span class="keyword">return</span> <span class="keyword">new</span> DirectChannel();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> IntegrationFlow outboundJmsRequests() {
    <span class="keyword">return</span> IntegrationFlows.from(<span class="string"><span class="delimiter">&quot;</span><span class="content">outboundRequests</span><span class="delimiter">&quot;</span></span>)
            .handle(Jms.outboundGateway(connectionFactory())
                    .requestDestination(<span class="string"><span class="delimiter">&quot;</span><span class="content">requestsQueue</span><span class="delimiter">&quot;</span></span>))
            .get();
}

<span class="annotation">@Bean</span>
<span class="annotation">@ServiceActivator</span>(inputChannel = <span class="string"><span class="delimiter">&quot;</span><span class="content">inboundStaging</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> AggregatorFactoryBean partitioningMessageHandler() <span class="directive">throws</span> <span class="exception">Exception</span> {
    AggregatorFactoryBean aggregatorFactoryBean = <span class="keyword">new</span> AggregatorFactoryBean();
    aggregatorFactoryBean.setProcessorBean(partitionHandler());
    aggregatorFactoryBean.setOutputChannel(outboundReplies());
    <span class="comment">// configure other propeties of the aggregatorFactoryBean</span>
    <span class="keyword">return</span> aggregatorFactoryBean;
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> DirectChannel inboundStaging() {
    <span class="keyword">return</span> <span class="keyword">new</span> DirectChannel();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> IntegrationFlow inboundJmsStaging() {
    <span class="keyword">return</span> IntegrationFlows
            .from(Jms.messageDrivenChannelAdapter(connectionFactory())
                    .configureListenerContainer(c -&gt; c.subscriptionDurable(<span class="predefined-constant">false</span>))
                    .destination(<span class="string"><span class="delimiter">&quot;</span><span class="content">stagingQueue</span><span class="delimiter">&quot;</span></span>))
            .channel(inboundStaging())
            .get();
}

<span class="comment">/*
 * Configuration of the worker side
 */</span>
<span class="annotation">@Bean</span>
<span class="directive">public</span> StepExecutionRequestHandler stepExecutionRequestHandler() {
    StepExecutionRequestHandler stepExecutionRequestHandler = <span class="keyword">new</span> StepExecutionRequestHandler();
    stepExecutionRequestHandler.setJobExplorer(jobExplorer);
    stepExecutionRequestHandler.setStepLocator(stepLocator());
    <span class="keyword">return</span> stepExecutionRequestHandler;
}

<span class="annotation">@Bean</span>
<span class="annotation">@ServiceActivator</span>(inputChannel = <span class="string"><span class="delimiter">&quot;</span><span class="content">inboundRequests</span><span class="delimiter">&quot;</span></span>, outputChannel = <span class="string"><span class="delimiter">&quot;</span><span class="content">outboundStaging</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> StepExecutionRequestHandler serviceActivator() <span class="directive">throws</span> <span class="exception">Exception</span> {
    <span class="keyword">return</span> stepExecutionRequestHandler();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> DirectChannel inboundRequests() {
    <span class="keyword">return</span> <span class="keyword">new</span> DirectChannel();
}

<span class="directive">public</span> IntegrationFlow inboundJmsRequests() {
    <span class="keyword">return</span> IntegrationFlows
            .from(Jms.messageDrivenChannelAdapter(connectionFactory())
                    .configureListenerContainer(c -&gt; c.subscriptionDurable(<span class="predefined-constant">false</span>))
                    .destination(<span class="string"><span class="delimiter">&quot;</span><span class="content">requestsQueue</span><span class="delimiter">&quot;</span></span>))
            .channel(inboundRequests())
            .get();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> DirectChannel outboundStaging() {
    <span class="keyword">return</span> <span class="keyword">new</span> DirectChannel();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> IntegrationFlow outboundJmsStaging() {
    <span class="keyword">return</span> IntegrationFlows.from(<span class="string"><span class="delimiter">&quot;</span><span class="content">outboundStaging</span><span class="delimiter">&quot;</span></span>)
            .handle(Jms.outboundGateway(connectionFactory())
                    .requestDestination(<span class="string"><span class="delimiter">&quot;</span><span class="content">stagingQueue</span><span class="delimiter">&quot;</span></span>))
            .get();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You must also ensure that the partition <code>handler</code> attribute maps to the <code>partitionHandler</code> bean, as shown in the following example:</p>
</div>
<div class="listingblock xmlContent">
<div class="title">XML Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">personJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1.master</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;partition</span> <span class="attribute-name">partitioner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">partitioner</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">handler</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">partitionHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    ...
  <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock javaContent">
<div class="title">Java Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        <span class="directive">public</span> Job personJob() {
                <span class="keyword">return</span> jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">personJob</span><span class="delimiter">&quot;</span></span>)
                                .start(stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1.master</span><span class="delimiter">&quot;</span></span>)
                                                .partitioner(<span class="string"><span class="delimiter">&quot;</span><span class="content">step1.worker</span><span class="delimiter">&quot;</span></span>, partitioner())
                                                .partitionHandler(partitionHandler())
                                                .build())
                                .build();
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can find a complete example of a remote partitioning job
<a href="https://github.com/spring-projects/spring-batch/tree/master/spring-batch-samples#remote-partitioning-sample">here</a>.</p>
</div>
<div class="paragraph">
<p>The <code>@EnableBatchIntegration</code> annotation that can be used to simplify a remote
 partitioning setup. This annotation provides two beans useful for remote partitioning:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>RemotePartitioningMasterStepBuilderFactory</code>: used to configure the master step</p>
</li>
<li>
<p><code>RemotePartitioningWorkerStepBuilderFactory</code>: used to configure the worker step</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These APIs take care of configuring a number of components as described in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/remote-partitioning-polling-config.png" alt="Remote Partitioning Configuration (with job repository polling)">
</div>
<div class="title">Figure 32. Remote Partitioning Configuration (with job repository polling)</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/remote-partitioning-aggregation-config.png" alt="Remote Partitioning Configuration (with replies aggregation)">
</div>
<div class="title">Figure 33. Remote Partitioning Configuration (with replies aggregation)</div>
</div>
<div class="paragraph">
<p>On the master side, the <code>RemotePartitioningMasterStepBuilderFactory</code> allows you to
configure a master step by declaring:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>Partitioner</code> used to partition data</p>
</li>
<li>
<p>the output channel ("Outgoing requests") to send requests to workers</p>
</li>
<li>
<p>the input channel ("Incoming replies") to receive replies from workers (when configuring replies aggregation)</p>
</li>
<li>
<p>the poll interval and timeout parameters (when configuring job repository polling)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>MessageChannelPartitionHandler</code> and the <code>MessagingTemplate</code> are not needed to be explicitly configured
(Those can still be explicitly configured if required).</p>
</div>
<div class="paragraph">
<p>On the worker side, the <code>RemotePartitioningWorkerStepBuilderFactory</code> allows you to configure a worker to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>listen to requests sent by the master on the input channel ("Incoming requests")</p>
</li>
<li>
<p>call the <code>handle</code> method of <code>StepExecutionRequestHandler</code> for each request</p>
</li>
<li>
<p>send replies on the output channel ("Outgoing replies") to the master</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is no need to explicitly configure the <code>StepExecutionRequestHandler</code> (which can be explicitly configured if required).</p>
</div>
<div class="paragraph">
<p>The following example shows how to use these APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Configuration</span>
<span class="annotation">@EnableBatchProcessing</span>
<span class="annotation">@EnableBatchIntegration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RemotePartitioningJobConfiguration</span> {

    <span class="annotation">@Configuration</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">MasterConfiguration</span> {

        <span class="annotation">@Autowired</span>
        <span class="directive">private</span> RemotePartitioningMasterStepBuilderFactory masterStepBuilderFactory;

        <span class="annotation">@Bean</span>
        <span class="directive">public</span> Step masterStep() {
                 <span class="keyword">return</span> <span class="local-variable">this</span>.masterStepBuilderFactory
                    .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">masterStep</span><span class="delimiter">&quot;</span></span>)
                    .partitioner(<span class="string"><span class="delimiter">&quot;</span><span class="content">workerStep</span><span class="delimiter">&quot;</span></span>, partitioner())
                    .gridSize(<span class="integer">10</span>)
                    .outputChannel(outgoingRequestsToWorkers())
                    .inputChannel(incomingRepliesFromWorkers())
                    .build();
        }

        <span class="comment">// Middleware beans setup omitted</span>

    }

    <span class="annotation">@Configuration</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">WorkerConfiguration</span> {

        <span class="annotation">@Autowired</span>
        <span class="directive">private</span> RemotePartitioningWorkerStepBuilderFactory workerStepBuilderFactory;

        <span class="annotation">@Bean</span>
        <span class="directive">public</span> Step workerStep() {
                 <span class="keyword">return</span> <span class="local-variable">this</span>.workerStepBuilderFactory
                    .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">workerStep</span><span class="delimiter">&quot;</span></span>)
                    .inputChannel(incomingRequestsFromMaster())
                    .outputChannel(outgoingRepliesToMaster())
                    .chunk(<span class="integer">100</span>)
                    .reader(itemReader())
                    .processor(itemProcessor())
                    .writer(itemWriter())
                    .build();
        }

        <span class="comment">// Middleware beans setup omitted</span>

    }

}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="listOfReadersAndWriters"><a class="anchor" href="#listOfReadersAndWriters"></a>Appendix A: List of ItemReaders and ItemWriters</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="itemReadersAppendix"><a class="anchor" href="#itemReadersAppendix"></a>A.1. Item Readers</h3>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 19. Available Item Readers</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item Reader</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AbstractItemCountingItemStreamItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abstract base class that provides basic
            restart capabilities by counting the number of items returned from
            an <code>ItemReader</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AggregateItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An <code>ItemReader</code> that delivers a list as its
            item, storing up objects from the injected <code>ItemReader</code> until they
            are ready to be packed out as a collection. This <code>ItemReader</code> should
            mark the beginning and end of records with the constant values in
            <code>FieldSetMapper AggregateItemReader#<em>BEGIN_RECORD</em></code> and
            <code>AggregateItemReader#<em>END_RECORD</em></code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AmqpItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given a Spring <code>AmqpTemplate</code>, it provides
            synchronous receive methods. The <code>receiveAndConvert()</code> method
            lets you receive POJO objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FlatFileItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reads from a flat file. Includes <code>ItemStream</code>
            and <code>Skippable</code> functionality. See <a href="readersAndWriters.html#flatFileItemReader"><code>FlatFileItemReader</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HibernateCursorItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reads from a cursor based on an HQL query. See
            <a href="readersAndWriters.html#cursorBasedItemReaders"><code>Cursor-based ItemReaders</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HibernatePagingItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reads from a paginated HQL query</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReaderAdapter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adapts any class to the
            <code>ItemReader</code> interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JdbcCursorItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reads from a database cursor via JDBC. See
            <a href="readersAndWriters.html#cursorBasedItemReaders"><code>Cursor-based ItemReaders</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JdbcPagingItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given an SQL statement, pages through the rows,
            such that large datasets can be read without running out of
            memory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JmsItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given a Spring <code>JmsOperations</code> object and a JMS
            Destination or destination name to which to send errors, provides items
            received through the injected <code>JmsOperations#receive()</code>
            method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JpaPagingItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given a JPQL statement, pages through the
            rows, such that large datasets can be read without running out of
            memory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ListItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides the items from a list, one at a
            time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MongoItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given a <code>MongoOperations</code> object and a JSON-based MongoDB
            query, provides items received from the <code>MongoOperations#find()</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Neo4jItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given a <code>Neo4jOperations</code> object and the components of a
            Cyhper query, items are returned as the result of the Neo4jOperations.query
            method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RepositoryItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given a Spring Data <code>PagingAndSortingRepository</code> object,
            a <code>Sort</code>, and the name of method to execute, returns items provided by the
            Spring Data repository implementation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">StoredProcedureItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reads from a database cursor resulting from the
            execution of a database stored procedure. See <a href="readersAndWriters.html#StoredProcedureItemReader"><code>StoredProcedureItemReader</code></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">StaxEventItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reads via StAX. see <a href="readersAndWriters.html#StaxEventItemReader"><code>StaxEventItemReader</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JsonItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reads items from a Json document. see <a href="readersAndWriters.html#JsonItemReader"><code>JsonItemReader</code></a>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="itemWritersAppendix"><a class="anchor" href="#itemWritersAppendix"></a>A.2. Item Writers</h3>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 20. Available Item Writers</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item Writer</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AbstractItemStreamItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abstract base class that combines the
            <code>ItemStream</code> and
            <code>ItemWriter</code> interfaces.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AmqpItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given a Spring <code>AmqpTemplate</code>, it provides
            for a synchronous <code>send</code> method. The <code>convertAndSend(Object)</code>
             method lets you send POJO objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CompositeItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passes an item to the <code>write</code> method of each
            in an injected <code>List</code> of <code>ItemWriter</code> objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FlatFileItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Writes to a flat file. Includes <code>ItemStream</code> and
            Skippable functionality. See <a href="readersAndWriters.html#flatFileItemWriter"><code>FlatFileItemWriter</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GemfireItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using a <code>GemfireOperations</code> object, items are either written
            or removed from the Gemfire instance based on the configuration of the delete
            flag.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HibernateItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This item writer is Hibernate-session aware
            and handles some transaction-related work that a non-"hibernate-aware"
            item writer would not need to know about and then delegates
            to another item writer to do the actual writing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriterAdapter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adapts any class to the
            <code>ItemWriter</code> interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JdbcBatchItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses batching features from a
            <code>PreparedStatement</code>, if available, and can
            take rudimentary steps to locate a failure during a
            <code>flush</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JmsItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using a <code>JmsOperations</code> object, items are written
            to the default queue through the <code>JmsOperations#convertAndSend()</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JpaItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This item writer is JPA EntityManager-aware
            and handles some transaction-related work that a non-"JPA-aware"
            <code>ItemWriter</code> would not need to know about and
            then delegates to another writer to do the actual writing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MimeMessageItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using Spring&#8217;s <code>JavaMailSender</code>, items of type <code>MimeMessage</code>
            are sent as mail messages.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MongoItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given a <code>MongoOperations</code> object, items are written
            through the <code>MongoOperations.save(Object)</code> method.  The actual write is delayed
            until the last possible moment before the transaction commits.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Neo4jItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given a <code>Neo4jOperations</code> object, items are persisted through the
            <code>save(Object)</code> method or deleted through the <code>delete(Object)</code> per the
            <code>ItemWriter&#8217;s</code> configuration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PropertyExtractingDelegatingItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <code>AbstractMethodInvokingDelegator</code>
            creating arguments on the fly. Arguments are created by retrieving
            the values from the fields in the item to be processed (through a
            <code>SpringBeanWrapper</code>), based on an injected array of field
            names.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RepositoryItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given a Spring Data <code>CrudRepository</code> implementation,
            items are saved through the method specified in the configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">StaxEventItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses a <code>Marshaller</code> implementation to
            convert each item to XML and then writes it to an XML file using
            StAX.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JsonFileItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses a <code>JsonObjectMarshaller</code> implementation to
            convert each item to Json and then writes it to an Json file.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="metaDataSchema"><a class="anchor" href="#metaDataSchema"></a>Appendix B: Meta-Data Schema</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="metaDataSchemaOverview"><a class="anchor" href="#metaDataSchemaOverview"></a>B.1. Overview</h3>
<div class="paragraph">
<p>The Spring Batch Metadata tables closely match the Domain objects that represent them in
Java. For example, <code>JobInstance</code>, <code>JobExecution</code>, <code>JobParameters</code>, and <code>StepExecution</code>
map to <code>BATCH_JOB_INSTANCE</code>, <code>BATCH_JOB_EXECUTION</code>, <code>BATCH_JOB_EXECUTION_PARAMS</code>, and
<code>BATCH_STEP_EXECUTION</code>, respectively. <code>ExecutionContext</code> maps to both
<code>BATCH_JOB_EXECUTION_CONTEXT</code> and <code>BATCH_STEP_EXECUTION_CONTEXT</code>. The <code>JobRepository</code> is
responsible for saving and storing each Java object into its correct table. This appendix
describes the metadata tables in detail, along with many of the design decisions that
were made when creating them. When viewing the various table creation statements below,
it is important to realize that the data types used are as generic as possible. Spring
Batch provides many schemas as examples, all of which have varying data types, due to
variations in how individual database vendors handle data types. The following image
shows an ERD model of all 6 tables and their relationships to one another:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/meta-data-erd.png" alt="Spring Batch Meta-Data ERD">
</div>
<div class="title">Figure 34. Spring Batch Meta-Data ERD</div>
</div>
<div class="sect3">
<h4 id="exampleDDLScripts"><a class="anchor" href="#exampleDDLScripts"></a>B.1.1. Example DDL Scripts</h4>
<div class="paragraph">
<p>The Spring Batch Core JAR file contains example scripts to create the relational tables
for a number of database platforms (which are, in turn, auto-detected by the job
repository factory bean or namespace equivalent). These scripts can be used as is or
modified with additional indexes and constraints as desired. The file names are in the
form <code>schema-*.sql</code>, where "*" is the short name of the target database platform.
The scripts are in the package <code>org.springframework.batch.core</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="migrationDDLScripts"><a class="anchor" href="#migrationDDLScripts"></a>B.1.2. Migration DDL Scripts</h4>
<div class="paragraph">
<p>Spring Batch provides migration DDL scripts that you need to execute when you upgrade versions.
These scripts can be found in the Core Jar file under <code>org/springframework/batch/core/migration</code>.
Migration scripts are organized into folders corresponding to version numbers in which they were introduced:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>2.2</code>: contains scripts needed if you are migrating from a version before <code>2.2</code> to version <code>2.2</code></p>
</li>
<li>
<p><code>4.1</code>: contains scripts needed if you are migrating from a version before <code>4.1</code> to version <code>4.1</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="metaDataVersion"><a class="anchor" href="#metaDataVersion"></a>B.1.3. Version</h4>
<div class="paragraph">
<p>Many of the database tables discussed in this appendix contain a version column. This
column is important because Spring Batch employs an optimistic locking strategy when
dealing with updates to the database. This means that each time a record is 'touched'
(updated) the value in the version column is incremented by one. When the repository goes
back to save the value, if the version number has changed it throws an
<code>OptimisticLockingFailureException</code>, indicating there has been an error with concurrent
access. This check is necessary, since, even though different batch jobs may be running
in different machines, they all use the same database tables.</p>
</div>
</div>
<div class="sect3">
<h4 id="metaDataIdentity"><a class="anchor" href="#metaDataIdentity"></a>B.1.4. Identity</h4>
<div class="paragraph">
<p><code>BATCH_JOB_INSTANCE</code>, <code>BATCH_JOB_EXECUTION</code>, and <code>BATCH_STEP_EXECUTION</code> each contain
columns ending in <code>_ID</code>. These fields act as primary keys for their respective tables.
However, they are not database generated keys. Rather, they are generated by separate
sequences. This is necessary because, after inserting one of the domain objects into the
database, the key it is given needs to be set on the actual object so that they can be
uniquely identified in Java. Newer database drivers (JDBC 3.0 and up) support this
feature with database-generated keys. However, rather than require that feature,
sequences are used. Each variation of the schema contains some form of the following
statements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> SEQUENCE BATCH_STEP_EXECUTION_SEQ;
<span class="class">CREATE</span> SEQUENCE BATCH_JOB_EXECUTION_SEQ;
<span class="class">CREATE</span> SEQUENCE BATCH_JOB_SEQ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Many database vendors do not support sequences. In these cases, work-arounds are used,
such as the following statements for MySQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> BATCH_STEP_EXECUTION_SEQ (ID <span class="predefined-type">BIGINT</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>) type=InnoDB;
<span class="class">INSERT</span> <span class="class">INTO</span> BATCH_STEP_EXECUTION_SEQ <span class="keyword">values</span>(<span class="integer">0</span>);
<span class="class">CREATE</span> <span class="type">TABLE</span> BATCH_JOB_EXECUTION_SEQ (ID <span class="predefined-type">BIGINT</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>) type=InnoDB;
<span class="class">INSERT</span> <span class="class">INTO</span> BATCH_JOB_EXECUTION_SEQ <span class="keyword">values</span>(<span class="integer">0</span>);
<span class="class">CREATE</span> <span class="type">TABLE</span> BATCH_JOB_SEQ (ID <span class="predefined-type">BIGINT</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>) type=InnoDB;
<span class="class">INSERT</span> <span class="class">INTO</span> BATCH_JOB_SEQ <span class="keyword">values</span>(<span class="integer">0</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding case, a table is used in place of each sequence. The Spring core class,
<code>MySQLMaxValueIncrementer</code>, then increments the one column in this sequence in order to
give similar functionality.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="metaDataBatchJobInstance"><a class="anchor" href="#metaDataBatchJobInstance"></a>B.2. <code>BATCH_JOB_INSTANCE</code></h3>
<div class="paragraph">
<p>The <code>BATCH_JOB_INSTANCE</code> table holds all information relevant to a <code>JobInstance</code>, and
serves as the top of the overall hierarchy. The following generic DDL statement is used
to create it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> BATCH_JOB_INSTANCE  (
  JOB_INSTANCE_ID <span class="predefined-type">BIGINT</span>  <span class="directive">PRIMARY</span> <span class="type">KEY</span> ,
  VERSION <span class="predefined-type">BIGINT</span>,
  JOB_NAME <span class="predefined-type">VARCHAR</span>(<span class="integer">100</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> ,
  JOB_KEY <span class="predefined-type">VARCHAR</span>(<span class="integer">2500</span>)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following list describes each column in the table:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JOB_INSTANCE_ID</code>: The unique ID that identifies the instance. It is also the primary
key. The value of this column should be obtainable by calling the <code>getId</code> method on
<code>JobInstance</code>.</p>
</li>
<li>
<p><code>VERSION</code>: See <a href="#metaDataVersion">Version</a>.</p>
</li>
<li>
<p><code>JOB_NAME</code>: Name of the job obtained from the <code>Job</code> object. Because it is required to
identify the instance, it must not be null.</p>
</li>
<li>
<p><code>JOB_KEY</code>: A serialization of the <code>JobParameters</code> that uniquely identifies separate
instances of the same job from one another. (<code>JobInstances</code> with the same job name must
have different <code>JobParameters</code> and, thus, different <code>JOB_KEY</code> values).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="metaDataBatchJobParams"><a class="anchor" href="#metaDataBatchJobParams"></a>B.3. <code>BATCH_JOB_EXECUTION_PARAMS</code></h3>
<div class="paragraph">
<p>The <code>BATCH_JOB_EXECUTION_PARAMS</code> table holds all information relevant to the
<code>JobParameters</code> object. It contains 0 or more key/value pairs passed to a <code>Job</code> and
serves as a record of the parameters with which a job was run. For each parameter that
contributes to the generation of a job&#8217;s identity, the <code>IDENTIFYING</code> flag is set to true.
Note that the table has been denormalized. Rather than creating a separate table for each
type, there is one table with a column indicating the type, as shown in the following
listing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> BATCH_JOB_EXECUTION_PARAMS  (
        JOB_EXECUTION_ID <span class="predefined-type">BIGINT</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> ,
        TYPE_CD <span class="predefined-type">VARCHAR</span>(<span class="integer">6</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> ,
        KEY_NAME <span class="predefined-type">VARCHAR</span>(<span class="integer">100</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> ,
        STRING_VAL <span class="predefined-type">VARCHAR</span>(<span class="integer">250</span>) ,
        DATE_VAL <span class="predefined-type">DATETIME</span> <span class="directive">DEFAULT</span> <span class="predefined-constant">NULL</span> ,
        LONG_VAL <span class="predefined-type">BIGINT</span> ,
        DOUBLE_VAL <span class="predefined-type">DOUBLE</span> PRECISION ,
        IDENTIFYING <span class="predefined-type">CHAR</span>(<span class="integer">1</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> ,
        <span class="type">constraint</span> JOB_EXEC_PARAMS_FK <span class="directive">foreign</span> <span class="type">key</span> (JOB_EXECUTION_ID)
        <span class="keyword">references</span> BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following list describes each column:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JOB_EXECUTION_ID</code>: Foreign key from the <code>BATCH_JOB_EXECUTION</code> table that indicates the
job execution to which the parameter entry belongs. Note that multiple rows (that is,
key/value pairs) may exist for each execution.</p>
</li>
<li>
<p>TYPE_CD: String representation of the type of value stored, which can be a string, a
date, a long, or a double. Because the type must be known, it cannot be null.</p>
</li>
<li>
<p>KEY_NAME: The parameter key.</p>
</li>
<li>
<p>STRING_VAL: Parameter value, if the type is string.</p>
</li>
<li>
<p>DATE_VAL: Parameter value, if the type is date.</p>
</li>
<li>
<p>LONG_VAL: Parameter value, if the type is long.</p>
</li>
<li>
<p>DOUBLE_VAL: Parameter value, if the type is double.</p>
</li>
<li>
<p>IDENTIFYING: Flag indicating whether the parameter contributed to the identity of the
related <code>JobInstance</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that there is no primary key for this table. This is because the framework has no
use for one and, thus, does not require it. If need be, you can add a primary key may be
added with a database generated key without causing any issues to the framework itself.</p>
</div>
</div>
<div class="sect2">
<h3 id="metaDataBatchJobExecution"><a class="anchor" href="#metaDataBatchJobExecution"></a>B.4. <code>BATCH_JOB_EXECUTION</code></h3>
<div class="paragraph">
<p>The <code>BATCH_JOB_EXECUTION</code> table holds all information relevant to the <code>JobExecution</code>
object. Every time a <code>Job</code> is run, there is always a new <code>JobExecution</code>, and a new row in
this table. The following listing shows the definition of the <code>BATCH_JOB_EXECUTION</code>
table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> BATCH_JOB_EXECUTION  (
  JOB_EXECUTION_ID <span class="predefined-type">BIGINT</span>  <span class="directive">PRIMARY</span> <span class="type">KEY</span> ,
  VERSION <span class="predefined-type">BIGINT</span>,
  JOB_INSTANCE_ID <span class="predefined-type">BIGINT</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  CREATE_TIME <span class="predefined-type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  START_TIME <span class="predefined-type">TIMESTAMP</span> <span class="directive">DEFAULT</span> <span class="predefined-constant">NULL</span>,
  END_TIME <span class="predefined-type">TIMESTAMP</span> <span class="directive">DEFAULT</span> <span class="predefined-constant">NULL</span>,
  STATUS <span class="predefined-type">VARCHAR</span>(<span class="integer">10</span>),
  EXIT_CODE <span class="predefined-type">VARCHAR</span>(<span class="integer">20</span>),
  EXIT_MESSAGE <span class="predefined-type">VARCHAR</span>(<span class="integer">2500</span>),
  LAST_UPDATED <span class="predefined-type">TIMESTAMP</span>,
  JOB_CONFIGURATION_LOCATION <span class="predefined-type">VARCHAR</span>(<span class="integer">2500</span>) <span class="predefined-constant">NULL</span>,
  <span class="type">constraint</span> JOB_INSTANCE_EXECUTION_FK <span class="directive">foreign</span> <span class="type">key</span> (JOB_INSTANCE_ID)
  <span class="keyword">references</span> BATCH_JOB_INSTANCE(JOB_INSTANCE_ID)
) ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following list describes each column:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JOB_EXECUTION_ID</code>: Primary key that uniquely identifies this execution. The value of
this column is obtainable by calling the <code>getId</code> method of the <code>JobExecution</code> object.</p>
</li>
<li>
<p><code>VERSION</code>: See <a href="#metaDataVersion">Version</a>.</p>
</li>
<li>
<p><code>JOB_INSTANCE_ID</code>: Foreign key from the <code>BATCH_JOB_INSTANCE</code> table. It indicates the
instance to which this execution belongs. There may be more than one execution per
instance.</p>
</li>
<li>
<p><code>CREATE_TIME</code>: Timestamp representing the time when the execution was created.</p>
</li>
<li>
<p><code>START_TIME</code>: Timestamp representing the time when the execution was started.</p>
</li>
<li>
<p><code>END_TIME</code>: Timestamp representing the time when the execution finished, regardless of
success or failure. An empty value in this column when the job is not currently running
indicates that there has been some type of error and the framework was unable to perform
a last save before failing.</p>
</li>
<li>
<p><code>STATUS</code>: Character string representing the status of the execution. This may be
<code>COMPLETED</code>, <code>STARTED</code>, and others. The object representation of this column is the
<code>BatchStatus</code> enumeration.</p>
</li>
<li>
<p><code>EXIT_CODE</code>: Character string representing the exit code of the execution. In the case
of a command-line job, this may be converted into a number.</p>
</li>
<li>
<p><code>EXIT_MESSAGE</code>: Character string representing a more detailed description of how the
job exited. In the case of failure, this might include as much of the stack trace as is
possible.</p>
</li>
<li>
<p><code>LAST_UPDATED</code>: Timestamp representing the last time this execution was persisted.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="metaDataBatchStepExecution"><a class="anchor" href="#metaDataBatchStepExecution"></a>B.5. <code>BATCH_STEP_EXECUTION</code></h3>
<div class="paragraph">
<p>The BATCH_STEP_EXECUTION table holds all information relevant to the <code>StepExecution</code>
object. This table is similar in many ways to the <code>BATCH_JOB_EXECUTION</code> table, and there
is always at least one entry per <code>Step</code> for each <code>JobExecution</code> created. The following
listing shows the definition of the <code>BATCH_STEP_EXECUTION</code> table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> BATCH_STEP_EXECUTION  (
  STEP_EXECUTION_ID <span class="predefined-type">BIGINT</span>  <span class="directive">PRIMARY</span> <span class="type">KEY</span> ,
  VERSION <span class="predefined-type">BIGINT</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  STEP_NAME <span class="predefined-type">VARCHAR</span>(<span class="integer">100</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  JOB_EXECUTION_ID <span class="predefined-type">BIGINT</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  START_TIME <span class="predefined-type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> ,
  END_TIME <span class="predefined-type">TIMESTAMP</span> <span class="directive">DEFAULT</span> <span class="predefined-constant">NULL</span>,
  STATUS <span class="predefined-type">VARCHAR</span>(<span class="integer">10</span>),
  COMMIT_COUNT <span class="predefined-type">BIGINT</span> ,
  READ_COUNT <span class="predefined-type">BIGINT</span> ,
  FILTER_COUNT <span class="predefined-type">BIGINT</span> ,
  WRITE_COUNT <span class="predefined-type">BIGINT</span> ,
  READ_SKIP_COUNT <span class="predefined-type">BIGINT</span> ,
  WRITE_SKIP_COUNT <span class="predefined-type">BIGINT</span> ,
  PROCESS_SKIP_COUNT <span class="predefined-type">BIGINT</span> ,
  ROLLBACK_COUNT <span class="predefined-type">BIGINT</span> ,
  EXIT_CODE <span class="predefined-type">VARCHAR</span>(<span class="integer">20</span>) ,
  EXIT_MESSAGE <span class="predefined-type">VARCHAR</span>(<span class="integer">2500</span>) ,
  LAST_UPDATED <span class="predefined-type">TIMESTAMP</span>,
  <span class="type">constraint</span> JOB_EXECUTION_STEP_FK <span class="directive">foreign</span> <span class="type">key</span> (JOB_EXECUTION_ID)
  <span class="keyword">references</span> BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
) ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following list describes for each column:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>STEP_EXECUTION_ID</code>: Primary key that uniquely identifies this execution. The value of
this column should be obtainable by calling the <code>getId</code> method of the <code>StepExecution</code>
object.</p>
</li>
<li>
<p><code>VERSION</code>: See <a href="#metaDataVersion">Version</a>.</p>
</li>
<li>
<p><code>STEP_NAME</code>: The name of the step to which this execution belongs.</p>
</li>
<li>
<p><code>JOB_EXECUTION_ID</code>: Foreign key from the <code>BATCH_JOB_EXECUTION</code> table. It indicates the
<code>JobExecution</code> to which this <code>StepExecution</code> belongs. There may be only one
<code>StepExecution</code> for a given <code>JobExecution</code> for a given <code>Step</code> name.</p>
</li>
<li>
<p><code>START_TIME</code>: Timestamp representing the time when the execution was started.</p>
</li>
<li>
<p><code>END_TIME</code>: Timestamp representing the time the when execution was finished, regardless
of success or failure. An empty value in this column, even though the job is not
currently running, indicates that there has been some type of error and the framework was
unable to perform a last save before failing.</p>
</li>
<li>
<p><code>STATUS</code>: Character string representing the status of the execution. This may be
<code>COMPLETED</code>, <code>STARTED</code>, and others. The object representation of this column is the
<code>BatchStatus</code> enumeration.</p>
</li>
<li>
<p><code>COMMIT_COUNT</code>: The number of times in which the step has committed a transaction
during this execution.</p>
</li>
<li>
<p><code>READ_COUNT</code>: The number of items read during this execution.</p>
</li>
<li>
<p><code>FILTER_COUNT</code>: The number of items filtered out of this execution.</p>
</li>
<li>
<p><code>WRITE_COUNT</code>: The number of items written and committed during this execution.</p>
</li>
<li>
<p><code>READ_SKIP_COUNT</code>: The number of items skipped on read during this execution.</p>
</li>
<li>
<p><code>WRITE_SKIP_COUNT</code>: The number of items skipped on write during this execution.</p>
</li>
<li>
<p><code>PROCESS_SKIP_COUNT</code>: The number of items skipped during processing during this
execution.</p>
</li>
<li>
<p><code>ROLLBACK_COUNT</code>: The number of rollbacks during this execution. Note that this count
includes each time rollback occurs, including rollbacks for retry and those in the skip
recovery procedure.</p>
</li>
<li>
<p><code>EXIT_CODE</code>: Character string representing the exit code of the execution. In the case
of a command-line job, this may be converted into a number.</p>
</li>
<li>
<p><code>EXIT_MESSAGE</code>: Character string representing a more detailed description of how the
job exited. In the case of failure, this might include as much of the stack trace as is
possible.</p>
</li>
<li>
<p><code>LAST_UPDATED</code>: Timestamp representing the last time this execution was persisted.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="metaDataBatchJobExecutionContext"><a class="anchor" href="#metaDataBatchJobExecutionContext"></a>B.6. <code>BATCH_JOB_EXECUTION_CONTEXT</code></h3>
<div class="paragraph">
<p>The <code>BATCH_JOB_EXECUTION_CONTEXT</code> table holds all information relevant to the
<code>ExecutionContext</code> of a <code>Job</code>. There is exactly one <code>Job</code> <code>ExecutionContext</code> per
<code>JobExecution</code>, and it contains all of the job-level data that is needed for a particular
job execution. This data typically represents the state that must be retrieved after a
failure, so that a <code>JobInstance</code> can "start from where it left off". The following
listing shows the definition of the <code>BATCH_JOB_EXECUTION_CONTEXT</code> table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> BATCH_JOB_EXECUTION_CONTEXT  (
  JOB_EXECUTION_ID <span class="predefined-type">BIGINT</span> <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
  SHORT_CONTEXT <span class="predefined-type">VARCHAR</span>(<span class="integer">2500</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  SERIALIZED_CONTEXT CLOB,
  <span class="type">constraint</span> JOB_EXEC_CTX_FK <span class="directive">foreign</span> <span class="type">key</span> (JOB_EXECUTION_ID)
  <span class="keyword">references</span> BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
) ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following list describes each column:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JOB_EXECUTION_ID</code>: Foreign key representing the <code>JobExecution</code> to which the context
belongs. There may be more than one row associated with a given execution.</p>
</li>
<li>
<p><code>SHORT_CONTEXT</code>: A string version of the <code>SERIALIZED_CONTEXT</code>.</p>
</li>
<li>
<p><code>SERIALIZED_CONTEXT</code>: The entire context, serialized.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="metaDataBatchStepExecutionContext"><a class="anchor" href="#metaDataBatchStepExecutionContext"></a>B.7. <code>BATCH_STEP_EXECUTION_CONTEXT</code></h3>
<div class="paragraph">
<p>The <code>BATCH_STEP_EXECUTION_CONTEXT</code> table holds all information relevant to the
<code>ExecutionContext</code> of a <code>Step</code>. There is exactly one <code>ExecutionContext</code> per
<code>StepExecution</code>, and it contains all of the data that
needs to be persisted for a particular step execution. This data typically represents the
state that must be retrieved after a failure, so that a <code>JobInstance</code> can 'start from
where it left off'. The following listing shows the definition of the
<code>BATCH_STEP_EXECUTION_CONTEXT</code> table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> BATCH_STEP_EXECUTION_CONTEXT  (
  STEP_EXECUTION_ID <span class="predefined-type">BIGINT</span> <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
  SHORT_CONTEXT <span class="predefined-type">VARCHAR</span>(<span class="integer">2500</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  SERIALIZED_CONTEXT CLOB,
  <span class="type">constraint</span> STEP_EXEC_CTX_FK <span class="directive">foreign</span> <span class="type">key</span> (STEP_EXECUTION_ID)
  <span class="keyword">references</span> BATCH_STEP_EXECUTION(STEP_EXECUTION_ID)
) ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following list describes each column:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>STEP_EXECUTION_ID</code>: Foreign key representing the <code>StepExecution</code> to which the context
belongs. There may be more than one row associated to a given execution.</p>
</li>
<li>
<p><code>SHORT_CONTEXT</code>: A string version of the <code>SERIALIZED_CONTEXT</code>.</p>
</li>
<li>
<p><code>SERIALIZED_CONTEXT</code>: The entire context, serialized.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="metaDataArchiving"><a class="anchor" href="#metaDataArchiving"></a>B.8. Archiving</h3>
<div class="paragraph">
<p>Because there are entries in multiple tables every time a batch job is run, it is common
to create an archive strategy for the metadata tables. The tables themselves are designed
to show a record of what happened in the past and generally do not affect the run of any
job, with a few notable exceptions pertaining to restart:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The framework uses the metadata tables to determine whether a particular <code>JobInstance</code>
has been run before. If it has been run and if the job is not restartable, then an
exception is thrown.</p>
</li>
<li>
<p>If an entry for a <code>JobInstance</code> is removed without having completed successfully, the
framework thinks that the job is new rather than a restart.</p>
</li>
<li>
<p>If a job is restarted, the framework uses any data that has been persisted to the
<code>ExecutionContext</code> to restore the <code>Job&#8217;s</code> state. Therefore, removing any entries from
this table for jobs that have not completed successfully prevents them from starting at
the correct point if run again.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="multiByteCharacters"><a class="anchor" href="#multiByteCharacters"></a>B.9. International and Multi-byte Characters</h3>
<div class="paragraph">
<p>If you are using multi-byte character sets (such as Chinese or Cyrillic) in your business
processing, then those characters might need to be persisted in the Spring Batch schema.
Many users find that simply changing the schema to double the length of the <code>VARCHAR</code>
columns is enough.  Others prefer to configure the
<a href="#configuringJobRepository">JobRepository</a> with <code>max-varchar-length</code> half the
value of the <code>VARCHAR</code> column length.  Some users have also reported that they use
<code>NVARCHAR</code> in place of <code>VARCHAR</code> in their schema definitions.  The best result depends on
the database platform and the way the database server has been configured locally.</p>
</div>
</div>
<div class="sect2">
<h3 id="recommendationsForIndexingMetaDataTables"><a class="anchor" href="#recommendationsForIndexingMetaDataTables"></a>B.10. Recommendations for Indexing Meta Data Tables</h3>
<div class="paragraph">
<p>Spring Batch provides DDL samples for the metadata tables in the core jar file for
several common database platforms. Index declarations are not included in that DDL,
because there are too many variations in how users may want to index, depending on their
precise platform, local conventions, and the business requirements of how the jobs are
operated. The following below provides some indication as to which columns are going to
be used in a <code>WHERE</code> clause by the DAO implementations provided by Spring Batch and how
frequently they might be used, so that individual projects can make up their own minds
about indexing:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 21. Where clauses in SQL statements (excluding primary keys) and their approximate frequency of use.</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default Table Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Where Clause</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Frequency</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_JOB_INSTANCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_NAME = ? and JOB_KEY = ?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Every time a job is launched</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_JOB_EXECUTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_INSTANCE_ID = ?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Every time a job is restarted</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_EXECUTION_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXECUTION_ID = ? and KEY_NAME = ?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">On commit interval, a.k.a. chunk</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_STEP_EXECUTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VERSION = ?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">On commit interval, a.k.a. chunk (and at start and end of
            step)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_STEP_EXECUTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STEP_NAME = ? and JOB_EXECUTION_ID = ?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Before each step execution</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="transactions"><a class="anchor" href="#transactions"></a>Appendix C: Batch Processing and Transactions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="transactionsNoRetry"><a class="anchor" href="#transactionsNoRetry"></a>C.1. Simple Batching with No Retry</h3>
<div class="paragraph">
<p>Consider the following simple example of a nested batch with no retries. It shows a
common scenario for batch processing: An input source is processed until exhausted, and
we commit periodically at the end of a "chunk" of processing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1   |  REPEAT(until=exhausted) {
|
2   |    TX {
3   |      REPEAT(size=5) {
3.1 |        input;
3.2 |        output;
|      }
|    }
|
|  }</pre>
</div>
</div>
<div class="paragraph">
<p>The input operation (3.1) could be a message-based receive (such as from JMS), or a
file-based read, but to recover and continue processing with a chance of completing the
whole job, it must be transactional. The same applies to the operation at 3.2. It must
be either transactional or idempotent.</p>
</div>
<div class="paragraph">
<p>If the chunk at <code>REPEAT</code> (3) fails because of a database exception at 3.2, then <code>TX</code> (2)
must roll back the whole chunk.</p>
</div>
</div>
<div class="sect2">
<h3 id="transactionStatelessRetry"><a class="anchor" href="#transactionStatelessRetry"></a>C.2. Simple Stateless Retry</h3>
<div class="paragraph">
<p>It is also useful to use a retry for an operation which is not transactional, such as a
call to a web-service or other remote resource, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>0   |  TX {
1   |    input;
1.1 |    output;
2   |    RETRY {
2.1 |      remote access;
|    }
|  }</pre>
</div>
</div>
<div class="paragraph">
<p>This is actually one of the most useful applications of a retry, since a remote call is
much more likely to fail and be retryable than a database update.  As long as the remote
access (2.1) eventually succeeds, the transaction, <code>TX</code> (0), commits.  If the remote
access (2.1) eventually fails, then the transaction, <code>TX</code> (0), is guaranteed to roll
back.</p>
</div>
</div>
<div class="sect2">
<h3 id="repeatRetry"><a class="anchor" href="#repeatRetry"></a>C.3. Typical Repeat-Retry Pattern</h3>
<div class="paragraph">
<p>The most typical batch processing pattern is to add a retry to the inner block of the
chunk, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1   |  REPEAT(until=exhausted, exception=not critical) {
|
2   |    TX {
3   |      REPEAT(size=5) {
|
4   |        RETRY(stateful, exception=deadlock loser) {
4.1 |          input;
5   |        } PROCESS {
5.1 |          output;
6   |        } SKIP and RECOVER {
|          notify;
|        }
|
|      }
|    }
|
|  }</pre>
</div>
</div>
<div class="paragraph">
<p>The inner <code>RETRY</code> (4) block is marked as "stateful". See <a href="#transactionsNoRetry">the
typical use case</a> for a description of a stateful retry.  This means that if the
retry <code>PROCESS</code> (5) block fails, the behavior of the <code>RETRY</code> (4) is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Throw an exception, rolling back the transaction, <code>TX</code> (2), at the chunk level, and
allowing the item to be re-presented to the input queue.</p>
</li>
<li>
<p>When the item re-appears, it might be retried depending on the retry policy in place,
executing <code>PROCESS</code> (5) again.  The second and subsequent attempts might fail again and
re-throw the exception.</p>
</li>
<li>
<p>Eventually, the item reappears for the final time. The retry policy disallows another
attempt, so <code>PROCESS</code> (5) is never executed. In this case, we follow the <code>RECOVER</code> (6)
path, effectively "skipping" the item that was received and is being processed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that the notation used for the <code>RETRY</code> (4) in the plan above explicitly shows that
the input step (4.1) is part of the retry. It also makes clear that there are two
alternate paths for processing: the normal case, as denoted by <code>PROCESS</code> (5), and the
recovery path, as denoted in a separate block by <code>RECOVER</code> (6).  The two alternate paths
are completely distinct. Only one is ever taken in normal circumstances.</p>
</div>
<div class="paragraph">
<p>In special cases (such as a special <code>TranscationValidException</code> type), the retry policy
might be able to determine that the <code>RECOVER</code> (6) path can be taken on the last attempt
after <code>PROCESS</code> (5) has just failed, instead of waiting for the item to be re-presented.
This is not the default behavior, because it requires detailed knowledge of what has
happened inside the <code>PROCESS</code> (5) block, which is not usually available. For example, if
the output included write access before the failure, then the exception should be
re-thrown to ensure transactional integrity.</p>
</div>
<div class="paragraph">
<p>The completion policy in the outer <code>REPEAT</code> (1) is crucial to the success of the above
plan.  If the output (5.1) fails, it may throw an exception (it usually does, as
described), in which case the transaction, <code>TX</code> (2), fails, and the exception could
propagate up through the outer batch <code>REPEAT</code> (1).  We do not want the whole batch to
stop, because the <code>RETRY</code> (4) might still be successful if we try again, so we add
<code>exception=not critical</code> to the outer <code>REPEAT</code> (1).</p>
</div>
<div class="paragraph">
<p>Note, however, that if the <code>TX</code> (2) fails and we <em>do</em> try again, by virtue of the outer
completion policy, the item that is next processed in the inner <code>REPEAT</code> (3) is not
guaranteed to be the one that just failed.  It might be, but it depends on the
implementation of the input (4.1).  Thus, the output (5.1) might fail again on either a
new item or the old one.  The client of the batch should not assume that each <code>RETRY</code> (4)
attempt is going to process the same items as the last one that failed.  For example, if
the termination policy for <code>REPEAT</code> (1) is to fail after 10 attempts, it fails after 10
consecutive attempts but not necessarily at the same item. This is consistent with the
overall retry strategy. The inner <code>RETRY</code> (4) is aware of the history of each item and
can decide whether or not to have another attempt at it.</p>
</div>
</div>
<div class="sect2">
<h3 id="asyncChunkProcessing"><a class="anchor" href="#asyncChunkProcessing"></a>C.4. Asynchronous Chunk Processing</h3>
<div class="paragraph">
<p>The inner batches or chunks in the <a href="#repeatRetry">typical example</a> can be executed
concurrently by configuring the outer batch to use an <code>AsyncTaskExecutor</code>.  The outer
batch waits for all the chunks to complete before completing. The following example shows
asynchronous chunk processing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1   |  REPEAT(until=exhausted, concurrent, exception=not critical) {
|
2   |    TX {
3   |      REPEAT(size=5) {
|
4   |        RETRY(stateful, exception=deadlock loser) {
4.1 |          input;
5   |        } PROCESS {
|          output;
6   |        } RECOVER {
|          recover;
|        }
|
|      }
|    }
|
|  }</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="asyncItemProcessing"><a class="anchor" href="#asyncItemProcessing"></a>C.5. Asynchronous Item Processing</h3>
<div class="paragraph">
<p>The individual items in chunks in the <a href="#repeatRetry">typical example</a> can also, in
principle, be processed concurrently.  In this case, the transaction boundary has to move
to the level of the individual item, so that each transaction is on a single thread, as
shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1   |  REPEAT(until=exhausted, exception=not critical) {
|
2   |    REPEAT(size=5, concurrent) {
|
3   |      TX {
4   |        RETRY(stateful, exception=deadlock loser) {
4.1 |          input;
5   |        } PROCESS {
|          output;
6   |        } RECOVER {
|          recover;
|        }
|      }
|
|    }
|
|  }</pre>
</div>
</div>
<div class="paragraph">
<p>This plan sacrifices the optimization benefit, which the simple plan had, of having all
the transactional resources chunked together.  It is only useful if the cost of the
processing (5) is much higher than the cost of transaction management (3).</p>
</div>
</div>
<div class="sect2">
<h3 id="transactionPropagation"><a class="anchor" href="#transactionPropagation"></a>C.6. Interactions Between Batching and Transaction Propagation</h3>
<div class="paragraph">
<p>There is a tighter coupling between batch-retry and transaction management than we would
ideally like.  In particular, a stateless retry cannot be used to retry database
operations with a transaction manager that does not support NESTED propagation.</p>
</div>
<div class="paragraph">
<p>The following example uses retry without repeat:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1   |  TX {
|
1.1 |    input;
2.2 |    database access;
2   |    RETRY {
3   |      TX {
3.1 |        database access;
|      }
|    }
|
|  }</pre>
</div>
</div>
<div class="paragraph">
<p>Again, and for the same reason, the inner transaction, <code>TX</code> (3), can cause the outer
transaction, <code>TX</code> (1), to fail, even if the <code>RETRY</code> (2) is eventually successful.</p>
</div>
<div class="paragraph">
<p>Unfortunately, the same effect percolates from the retry block up to the surrounding
repeat batch if there is one, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1   |  TX {
|
2   |    REPEAT(size=5) {
2.1 |      input;
2.2 |      database access;
3   |      RETRY {
4   |        TX {
4.1 |          database access;
|        }
|      }
|    }
|
|  }</pre>
</div>
</div>
<div class="paragraph">
<p>Now, if TX (3) rolls back, it can pollute the whole batch at TX (1) and force it to roll
back at the end.</p>
</div>
<div class="paragraph">
<p>What about non-default propagation?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the preceding example, <code>PROPAGATION_REQUIRES_NEW</code> at <code>TX</code> (3) prevents the outer
<code>TX</code> (1) from being polluted if both transactions are eventually successful.  But if <code>TX</code>
(3) commits and <code>TX</code> (1) rolls back, then <code>TX</code> (3) stays committed, so we violate the
transaction contract for <code>TX</code> (1).  If <code>TX</code> (3) rolls back, <code>TX</code> (1) does not necessarily
(but it probably does in practice, because the retry throws a roll back exception).</p>
</li>
<li>
<p><code>PROPAGATION_NESTED</code> at <code>TX</code> (3) works as we require in the retry case (and for a
batch with skips): <code>TX</code> (3) can commit but subsequently be rolled back by the outer
transaction, <code>TX</code> (1).  If <code>TX</code> (3) rolls back, <code>TX</code> (1) rolls back in practice.  This
option is only available on some platforms, not including Hibernate or
JTA, but it is the only one that consistently works.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consequently, the <code>NESTED</code> pattern is best if the retry block contains any database
access.</p>
</div>
</div>
<div class="sect2">
<h3 id="specialTransactionOrthonogonal"><a class="anchor" href="#specialTransactionOrthonogonal"></a>C.7. Special Case: Transactions with Orthogonal Resources</h3>
<div class="paragraph">
<p>Default propagation is always OK for simple cases where there are no nested database
transactions.  Consider the following example, where the <code>SESSION</code> and <code>TX</code> are not
global <code>XA</code> resources, so their resources are orthogonal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>0   |  SESSION {
1   |    input;
2   |    RETRY {
3   |      TX {
3.1 |        database access;
|      }
|    }
|  }</pre>
</div>
</div>
<div class="paragraph">
<p>Here there is a transactional message <code>SESSION</code> (0), but it does not participate in other
transactions with <code>PlatformTransactionManager</code>, so it does not propagate when <code>TX</code> (3)
starts.  There is no database access outside the <code>RETRY</code> (2) block. If <code>TX</code> (3) fails and
then eventually succeeds on a retry, <code>SESSION</code> (0) can commit (independently of a <code>TX</code>
block).  This is similar to the vanilla "best-efforts-one-phase-commit" scenario. The
worst that can happen is a duplicate message when the <code>RETRY</code> (2) succeeds and the
<code>SESSION</code> (0) cannot commit (for example, because the message system is unavailable).</p>
</div>
</div>
<div class="sect2">
<h3 id="statelessRetryCannotRecover"><a class="anchor" href="#statelessRetryCannotRecover"></a>C.8. Stateless Retry Cannot Recover</h3>
<div class="paragraph">
<p>The distinction between a stateless and a stateful retry in the typical example above is
important.  It is actually ultimately a transactional constraint that forces the
distinction, and this constraint also makes it obvious why the distinction exists.</p>
</div>
<div class="paragraph">
<p>We start with the observation that there is no way to skip an item that failed and
successfully commit the rest of the chunk unless we wrap the item processing in a
transaction.  Consequently, we simplify the typical batch execution plan to be as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>0   |  REPEAT(until=exhausted) {
|
1   |    TX {
2   |      REPEAT(size=5) {
|
3   |        RETRY(stateless) {
4   |          TX {
4.1 |            input;
4.2 |            database access;
|          }
5   |        } RECOVER {
5.1 |          skip;
|        }
|
|      }
|    }
|
|  }</pre>
</div>
</div>
<div class="paragraph">
<p>The preceding example shows a stateless <code>RETRY</code> (3) with a <code>RECOVER</code> (5) path that kicks
in after the final attempt fails.  The <code>stateless</code> label means that the block is repeated
without re-throwing any exception up to some limit.  This only works if the transaction,
<code>TX</code> (4), has propagation NESTED.</p>
</div>
<div class="paragraph">
<p>If the inner <code>TX</code> (4) has default propagation properties and rolls back, it pollutes the
outer <code>TX</code> (1). The inner transaction is assumed by the transaction manager to have
corrupted the transactional resource, so it cannot be used again.</p>
</div>
<div class="paragraph">
<p>Support for NESTED propagation is sufficiently rare that we choose not to support
recovery with stateless retries in the current versions of Spring Batch.  The same effect
can always be achieved (at the expense of repeating more processing) by using the
typical pattern above.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="glossary"><a class="anchor" href="#glossary"></a>Appendix D: Glossary</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="spring-batch-glossary"><a class="anchor" href="#spring-batch-glossary"></a>D.1. Spring Batch Glossary</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Batch</dt>
<dd>
<p>An accumulation of business transactions over time.</p>
</dd>
<dt class="hdlist1">Batch Application Style</dt>
<dd>
<p>Term used to designate batch as an application style in its own right, similar to
online, Web, or SOA. It has standard elements of input, validation, transformation of
information to business model, business processing, and output. In addition, it
requires monitoring at a macro level.</p>
</dd>
<dt class="hdlist1">Batch Processing</dt>
<dd>
<p>The handling of a batch of many business transactions that have accumulated over a
period of time (such as an hour, a day, a week, a month, or a year). It is the
application of a process or set of processes to many data entities or objects in a
repetitive and predictable fashion with either no manual element or a separate manual
element for error processing.</p>
</dd>
<dt class="hdlist1">Batch Window</dt>
<dd>
<p>The time frame within which a batch job must complete. This can be constrained by other
systems coming online, other dependent jobs needing to execute, or other factors
specific to the batch environment.</p>
</dd>
<dt class="hdlist1">Step</dt>
<dd>
<p>The main batch task or unit of work. It initializes the business logic and controls the
transaction environment, based on commit interval setting and other factors.</p>
</dd>
<dt class="hdlist1">Tasklet</dt>
<dd>
<p>A component created by an application developer to process the business logic for a
Step.</p>
</dd>
<dt class="hdlist1">Batch Job Type</dt>
<dd>
<p>Job types describe application of jobs for particular types of processing. Common areas
are interface processing (typically flat files), forms processing (either for online
PDF generation or print formats), and report processing.</p>
</dd>
<dt class="hdlist1">Driving Query</dt>
<dd>
<p>A driving query identifies the set of work for a job to do. The job then breaks that
work into individual units of work. For instance, a driving query might be to identify
all financial transactions that have a status of "pending transmission" and send them
to a partner system. The driving query returns a set of record IDs to process. Each
record ID then becomes a unit of work. A driving query may involve a join (if the
criteria for selection falls across two or more tables) or it may work with a single
table.</p>
</dd>
<dt class="hdlist1">Item</dt>
<dd>
<p>An item represents the smallest amount of complete data for processing. In the simplest
terms, this might be a line in a file, a row in a database table, or a particular
element in an XML file.</p>
</dd>
<dt class="hdlist1">Logicial Unit of Work (LUW)</dt>
<dd>
<p>A batch job iterates through a driving query (or other input source, such as a file) to
perform the set of work that the job must accomplish. Each iteration of work performed
is a unit of work.</p>
</dd>
<dt class="hdlist1">Commit Interval</dt>
<dd>
<p>A set of LUWs processed within a single transaction.</p>
</dd>
<dt class="hdlist1">Partitioning</dt>
<dd>
<p>Splitting a job into multiple threads where each thread is responsible for a subset of
the overall data to be processed. The threads of execution may be within the same JVM
or they may span JVMs in a clustered environment that supports workload balancing.</p>
</dd>
<dt class="hdlist1">Staging Table</dt>
<dd>
<p>A table that holds temporary data while it is being processed.</p>
</dd>
<dt class="hdlist1">Restartable</dt>
<dd>
<p>A job that can be executed again and assumes the same identity as when run initially.
In other words, it is has the same job instance ID.</p>
</dd>
<dt class="hdlist1">Rerunnable</dt>
<dd>
<p>A job that is restartable and manages its own state in terms of the previous run&#8217;s
record processing. An example of a rerunnable step is one based on a driving query. If
the driving query can be formed so that it limits the processed rows when the job is
restarted, then it is re-runnable. This is managed by the application logic. Often, a
condition is added to the <code>where</code> statement to limit the rows returned by the driving
query with logic resembling "and processedFlag!= true".</p>
</dd>
<dt class="hdlist1">Repeat</dt>
<dd>
<p>One of the most basic units of batch processing, it defines by repeatability calling a
portion of code until it is finished and while there is no error. Typically, a batch
process would be repeatable as long as there is input.</p>
</dd>
<dt class="hdlist1">Retry</dt>
<dd>
<p>Simplifies the execution of operations with retry semantics most frequently associated
with handling transactional output exceptions. Retry is slightly different from repeat,
rather than continually calling a block of code, retry is stateful and continually
calls the same block of code with the same input, until it either succeeds or some type
of retry limit has been exceeded. It is only generally useful when a subsequent
invocation of the operation might succeed because something in the environment has
improved.</p>
</dd>
<dt class="hdlist1">Recover</dt>
<dd>
<p>Recover operations handle an exception in such a way that a repeat process is able to
continue.</p>
</dd>
<dt class="hdlist1">Skip</dt>
<dd>
<p>Skip is a recovery strategy often used on file input sources as the strategy for
ignoring bad input records that failed validation.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 4.1.2.RELEASE<br>
Last updated 2019-04-03 09:14:50 UTC
</div>
</div>
<script type="text/javascript" src="tocbot-3.0.2/tocbot.js"></script>
<script type="text/javascript" >

    // Tocbot dynamic TOC, works with tocbot 3.0.2
    // Source: https://github.com/asciidoctor/asciidoctor/issues/699#issuecomment-321066006

    var oldtoc = document.getElementById('toctitle').nextElementSibling;
    var newtoc = document.createElement('div');
    newtoc.setAttribute('id', 'tocbot');
    newtoc.setAttribute('class', 'js-toc');
    oldtoc.parentNode.replaceChild(newtoc, oldtoc);
    tocbot.init({ contentSelector: '#content',
        headingSelector: 'h1, h2, h3, h4, h5',
        smoothScroll: false });
    var handleTocRefresh = function() {
        tocbot.refresh();
    }
    var handleTocOnResize = function() {
        var width = window.innerWidth
                    || document.documentElement.clientWidth
                    || document.body.clientWidth;
        if (width < 768) {
            tocbot.refresh({ contentSelector: '#content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 6,
                activeLinkClass: 'ignoreactive',
                throttleTimeout: 1000,
                smoothScroll: false });
        }
        else {
            tocbot.refresh({ contentSelector: '#content',
                headingSelector: 'h1, h2, h3, h4, h5',
                smoothScroll: false });
        }
    };
    window.addEventListener('resize', handleTocOnResize);
    window.addEventListener('tocRefresh', handleTocRefresh);
    handleTocOnResize();

    var link = document.createElement("a");
    link.setAttribute("href", "index.html");
    link.innerHTML = "<i class=\"fa fa-chevron-left\"></i>&nbsp;&nbsp;Back to index";
    var p = document.createElement("p");
    p.setAttribute("id", "backToIndex");
    p.appendChild(link);
    var toc = document.getElementById('toc');
    toc.insertBefore(p, toctitle);

</script>
</body>
</html>