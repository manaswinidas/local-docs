<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.3">
<title>Spring Cloud Open Service Broker</title>
<link rel="stylesheet" href="css//spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Spring Cloud Open Service Broker</h1>
<div class="details">
<span id="revnumber">version 3.0.1.RELEASE</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introduction</a></li>
<li><a href="#getting-started">2. Getting started</a>
<ul class="sectlevel2">
<li><a href="#maven-dependencies">2.1. Maven dependencies</a></li>
<li><a href="#gradle-dependencies">2.2. Gradle dependencies</a></li>
<li><a href="#configuring-the-service-broker">2.3. Configuring the service broker</a></li>
</ul>
</li>
<li><a href="#service-catalog">3. Advertising Services</a>
<ul class="sectlevel2">
<li><a href="#providing-a-catalog-bean">3.1. Providing a Catalog Bean</a></li>
<li><a href="#providing-a-catalog-using-properties">3.2. Providing a Catalog Using Properties</a></li>
<li><a href="#implementing-a-catalog-service">3.3. Implementing a Catalog Service</a></li>
</ul>
</li>
<li><a href="#service-instances">4. Service Instances</a>
<ul class="sectlevel2">
<li><a href="#service-instance-creation">4.1. Service Instance Creation</a>
<ul class="sectlevel3">
<li><a href="#event-registry">4.1.1. Event Registry</a></li>
</ul>
</li>
<li><a href="#service-instance-updating">4.2. Service Instance Updating</a>
<ul class="sectlevel3">
<li><a href="#event-registry-2">4.2.1. Event Registry</a></li>
</ul>
</li>
<li><a href="#service-instance-deletion">4.3. Service Instance Deletion</a>
<ul class="sectlevel3">
<li><a href="#event-registry-3">4.3.1. Event Registry</a></li>
</ul>
</li>
<li><a href="#service-instance-status">4.4. Service Instance Operation Status Retrieval</a>
<ul class="sectlevel3">
<li><a href="#event-registry-4">4.4.1. Event Registry</a></li>
</ul>
</li>
<li><a href="#service-instance-retrieval">4.5. Service Instance Retrieval</a></li>
<li><a href="#example-implementation">4.6. Example Implementation</a></li>
<li><a href="#example-event-flow-configuration">4.7. Example Event Flow Configuration</a></li>
</ul>
</li>
<li><a href="#service-bindings">5. Service Bindings</a>
<ul class="sectlevel2">
<li><a href="#service-binding-creation">5.1. Service Binding Creation</a>
<ul class="sectlevel3">
<li><a href="#event-registry-5">5.1.1. Event Registry</a></li>
</ul>
</li>
<li><a href="#service-binding-deletion">5.2. Service Binding Deletion</a>
<ul class="sectlevel3">
<li><a href="#event-registry-6">5.2.1. Event Registry</a></li>
</ul>
</li>
<li><a href="#service-binding-retrieval">5.3. Service Binding Retrieval</a></li>
<li><a href="#example-implementation-2">5.4. Example Implementation</a></li>
<li><a href="#example-event-flow-configuration-2">5.5. Example Event Flow Configuration</a></li>
</ul>
</li>
<li><a href="#api-version-verification">6. API version verification</a></li>
<li><a href="#service-broker-security">7. Service Broker Security</a>
<ul class="sectlevel2">
<li><a href="#example-configuration">7.1. Example Configuration</a></li>
</ul>
</li>
<li><a href="#example-service-broker">8. Example Service Broker Application</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div id="abstract" class="paragraph">
<p>Spring Cloud Open Service Broker is a framework for building <a href="https://projects.spring.io/spring-boot/">Spring Boot</a> applications that implement the <a href="https://www.openservicebrokerapi.org/">Open Service Broker API</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://www.openservicebrokerapi.org/">Open Service Broker API</a> defines an HTTP interface between the services marketplace of a platform and a service broker.</p>
</div>
<div class="paragraph">
<p>Service brokers are responsible for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Advertising a catalog of their service offerings and plans</p>
</li>
<li>
<p>Provisioning (creating or updating) service instances</p>
</li>
<li>
<p>Creating bindings between a service instance and a client application</p>
</li>
<li>
<p>Deleting bindings between a service instance and a client application</p>
</li>
<li>
<p>Deprovisioning (deleting) service instances</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <a href="https://cloud.spring.io/spring-cloud-open-service-broker/">Spring Cloud Open Service Broker</a> project provides the scaffolding for an <a href="https://www.openservicebrokerapi.org/">Open Service Broker API</a>-compliant service broker by implementing the required Spring web controllers, domain objects, and configuration.
Service broker authors can provide Spring beans that implement the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/package-summary.html">appropriate interfaces</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a>2. Getting started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most service broker applications implement API or web UI endpoints beyond the Open Service Broker API endpoints.
These additional endpoints might provide information about the application, provide a dashboard UI, or provide controls over application behavior.
Developers may implement these additional endpoints with <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html">Spring MVC</a>.
Spring WebFlux is currently not supported.</p>
</div>
<div class="sect2">
<h3 id="maven-dependencies"><a class="anchor" href="#maven-dependencies"></a>2.1. Maven dependencies</h3>
<div class="paragraph">
<p>To use Spring Cloud Open Service Broker in a Spring web application, add the starter:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-open-service-broker&lt;/artifactId&gt;
        &lt;version&gt;${version}&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="gradle-dependencies"><a class="anchor" href="#gradle-dependencies"></a>2.2. Gradle dependencies</h3>
<div class="paragraph">
<p>To use Spring Cloud Open Service Broker in a Spring web application, add the starter:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>dependencies {
    compile("org.springframework.cloud:spring-cloud-starter-open-service-broker:${version}")
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-the-service-broker"><a class="anchor" href="#configuring-the-service-broker"></a>2.3. Configuring the service broker</h3>
<div class="paragraph">
<p>See the <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#getting-started-first-application">Spring Boot documentation</a> for getting started building a Spring Boot application.</p>
</div>
<div class="paragraph">
<p>The framework provides default implementations of most of the components needed to implement a service broker.
In Spring Boot fashion, you can override the default behavior by providing your own implementation of Spring beans, and the framework will back away from its defaults.</p>
</div>
<div class="paragraph">
<p>To start, use the <code>@SpringBootApplication</code> annotation on the service broker&#8217;s main application class:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>This will trigger the inclusion of the default configuration.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="service-catalog"><a class="anchor" href="#service-catalog"></a>3. Advertising Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://github.com/openservicebrokerapi/servicebroker/blob/master/spec.md#catalog-management">service broker catalog</a> provides a set of metadata that describes the available services along with attributes such as cost and capabilities.
The catalog is made available to the platform&#8217;s services marketplace through the service broker <code>/v2/catalog</code> endpoint.</p>
</div>
<div class="paragraph">
<p>The service broker can either provide a Spring bean of type <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs//org/springframework/cloud/servicebroker/model/catalog/Catalog.html">Catalog</a> or implement the service <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/CatalogService.html">CatalogService</a>.</p>
</div>
<div class="sect2">
<h3 id="providing-a-catalog-bean"><a class="anchor" href="#providing-a-catalog-bean"></a>3.1. Providing a Catalog Bean</h3>
<div class="paragraph">
<p>The service broker catalog can be exposed by creating a Spring bean and contribute it to the Spring
application context. This can be done in a Spring <code>@Configuration</code> class as in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package com.example.servicebroker;

import org.springframework.cloud.servicebroker.model.catalog.Catalog;
import org.springframework.cloud.servicebroker.model.catalog.Plan;
import org.springframework.cloud.servicebroker.model.catalog.ServiceDefinition;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class ExampleCatalogConfiguration {

	@Bean
	public Catalog catalog() {
		Plan plan = Plan.builder()
				.id("simple-plan")
				.name("standard")
				.description("A simple plan")
				.free(true)
				.build();

		ServiceDefinition serviceDefinition = ServiceDefinition.builder()
				.id("example-service")
				.name("example")
				.description("A simple example")
				.bindable(true)
				.tags("example", "tags")
				.plans(plan)
				.build();

		return Catalog.builder()
		  .serviceDefinitions(serviceDefinition)
		  .build();
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="providing-a-catalog-using-properties"><a class="anchor" href="#providing-a-catalog-using-properties"></a>3.2. Providing a Catalog Using Properties</h3>
<div class="paragraph">
<p>A catalog may be configured with Spring Boot externalized configuration within a Java properties file or YAML file.
The catalog is parsed and made available as a <code>Catalog</code> bean during autoconfiguration.</p>
</div>
<div class="paragraph">
<p>The following example shows a YAML file that configures a catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml"># Example Spring Boot YAML configuration
spring:
  cloud:
    openservicebroker:
      catalog:
        services:
        - id: example-service
          name: example
          description: A simple example
          bindable: true
          tags:
          - example
          - tags
          plans:
          - id: simple-plan
            name: standard
            description: A simple plan</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows a properties file that configures a catalog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties" data-lang="properties"># Example Spring Boot properties configuration
spring.cloud.openservicebroker.catalog.services[0].id=example-service
spring.cloud.openservicebroker.catalog.services[0].name=example
spring.cloud.openservicebroker.catalog.services[0].description=A simple example
spring.cloud.openservicebroker.catalog.services[0].bindable=true
spring.cloud.openservicebroker.catalog.services[0].tags[0]=example
spring.cloud.openservicebroker.catalog.services[0].tags[1]=tags
spring.cloud.openservicebroker.catalog.services[0].plans[0].id=simple-plan
spring.cloud.openservicebroker.catalog.services[0].plans[0].name=standard
spring.cloud.openservicebroker.catalog.services[0].plans[0].description=A simple plan</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implementing-a-catalog-service"><a class="anchor" href="#implementing-a-catalog-service"></a>3.3. Implementing a Catalog Service</h3>
<div class="paragraph">
<p>A service broker can take more control over the catalog by implementing the <code>CatalogService</code> interface.
This might be required if some details of the catalog metadata need to be read from the environment or from an external data source.</p>
</div>
<div class="paragraph">
<p>The following example shows an implementation of the <code>CatalogService</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package com.example.servicebroker;

import reactor.core.publisher.Mono;

import org.springframework.cloud.servicebroker.model.catalog.Catalog;
import org.springframework.cloud.servicebroker.model.catalog.Plan;
import org.springframework.cloud.servicebroker.model.catalog.ServiceDefinition;
import org.springframework.cloud.servicebroker.service.CatalogService;
import org.springframework.stereotype.Service;

@Service
public class ExampleCatalogService implements CatalogService {

	@Override
	public Mono&lt;Catalog&gt; getCatalog() {
		return getServiceDefinition("example-service")
				.map(serviceDefinition -&gt; Catalog.builder()
						.serviceDefinitions(serviceDefinition)
						.build());
	}

	@Override
	public Mono&lt;ServiceDefinition&gt; getServiceDefinition(String serviceId) {
		return Mono.just(ServiceDefinition.builder()
			.id(serviceId)
			.name("example")
			.description("A simple example")
			.bindable(true)
			.tags("example", "tags")
			.plans(getPlan())
			.build());
	}

	private Plan getPlan() {
		return Plan.builder()
		   .id("simple-plan")
		   .name("standard")
		   .description("A simple plan")
		   .free(true)
		   .build();
	}
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="service-instances"><a class="anchor" href="#service-instances"></a>4. Service Instances</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Service brokers are responsible for provisioning the services advertised in their catalog and managing their lifecycle in the underlying cloud platform.
The services created by the broker are referred to as service instances.</p>
</div>
<div class="paragraph">
<p>Service brokers must implement the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/ServiceInstanceService.html"><code>ServiceInstanceService</code></a> interface and provide implementations of the required methods of that interface.
Each method receives a single Java object parameter containing all details of the request from the platform and returns a Java object value providing details of the operation to the platform.</p>
</div>
<div class="paragraph">
<p>The service instance create, update, and delete operations can be performed synchronously or asynchronously.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When a service broker creates, updates, or deletes a service instance synchronously, the appropriate interface method should block and only return a response to the platform when the operation completes successfully or when a failure occurs.</p>
</li>
<li>
<p>When performing an operation asynchronously, the service broker can return a response to the platform before the operation is complete and indicate in the response that the operation is in progress.
The platform <a href="#service-instance-status">polls the service broker</a> to get the status of the operation when an asynchronous operation is indicated.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="service-instance-creation"><a class="anchor" href="#service-instance-creation"></a>4.1. Service Instance Creation</h3>
<div class="paragraph">
<p>The service broker must provide an implementation of the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/ServiceInstanceService.html#createServiceInstance-org.springframework.cloud.servicebroker.model.instance.CreateServiceInstanceRequest-">createServiceInstance()</a>.</p>
</div>
<div class="paragraph">
<p>Service brokers typically provision a resource in the platform or in another system when creating a service instance.
Service brokers are responsible for keeping track of any resources associated with a service instance for future retrieval, updating, or deletion.</p>
</div>
<div class="sect3">
<h4 id="event-registry"><a class="anchor" href="#event-registry"></a>4.1.1. Event Registry</h4>
<div class="paragraph">
<p>Service instance creation can be further customized by utilizing events. Autowire the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistries.html">EventFlowRegistries</a> bean and retrieve the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/CreateServiceInstanceEventFlowRegistry.html">CreateServiceInstanceEventFlowRegistry</a> via the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistries.html#getCreateInstanceRegistry--">getCreateInstanceRegistry()</a> accessor. Use the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addInitializationFlow-I-">addInitializationFlow()</a>, <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addCompletionFlow-C-">addCompletionFlow()</a> or <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addErrorFlow-E-">addErrorFlow()</a> methods to register custom reactive flows for execution during the various stages of creating a service instance.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="service-instance-updating"><a class="anchor" href="#service-instance-updating"></a>4.2. Service Instance Updating</h3>
<div class="paragraph">
<p>If the <code>plan_updateable</code> field is set to <code>true</code> in the services catalog, the service broker must provide an implementation of the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/ServiceInstanceService.html#updateServiceInstance-org.springframework.cloud.servicebroker.model.instance.UpdateServiceInstanceRequest-">updateServiceInstance()</a>.
Otherwise, this method is never called by the platform, and the default implementation in the interface can be used.</p>
</div>
<div class="paragraph">
<p>Services brokers can modify the configuration of an existing resource when updating a service instance or deploying a new resource.</p>
</div>
<div class="sect3">
<h4 id="event-registry-2"><a class="anchor" href="#event-registry-2"></a>4.2.1. Event Registry</h4>
<div class="paragraph">
<p>Service instance updates can be further customized by utilizing events. Autowire the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistries.html">EventFlowRegistries</a> bean and retrieve the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/UpdateServiceInstanceEventFlowRegistry.html">UpdateServiceInstanceEventFlowRegistry</a> via the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistries.html#getUpdateInstanceRegistry--">getUpdateInstanceRegistry()</a> accessor. Use the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addInitializationFlow-I-">addInitializationFlow()</a>, <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addCompletionFlow-C-">addCompletionFlow()</a> or <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addErrorFlow-E-">addErrorFlow()</a> methods to register custom reactive flows for execution during the various stages of updating a service instance.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="service-instance-deletion"><a class="anchor" href="#service-instance-deletion"></a>4.3. Service Instance Deletion</h3>
<div class="paragraph">
<p>An implementation of the
<a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/ServiceInstanceService.html#deleteServiceInstance-org.springframework.cloud.servicebroker.model.instance.DeleteServiceInstanceRequest-">deleteServiceInstance()</a>
method must be provided by the service broker.</p>
</div>
<div class="paragraph">
<p>Any resources provisioned in the create operation should be deprovisioned by the delete operation.</p>
</div>
<div class="sect3">
<h4 id="event-registry-3"><a class="anchor" href="#event-registry-3"></a>4.3.1. Event Registry</h4>
<div class="paragraph">
<p>Service instance deletion can be further customized by utilizing events. Autowire the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistries.html">EventFlowRegistries</a> bean and retrieve the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/DeleteServiceInstanceEventFlowRegistry.html">DeleteServiceInstanceEventFlowRegistry</a> via the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistries.html#getDeleteInstanceRegistry--">getDeleteInstanceRegistry()</a> accessor. Use the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addInitializationFlow-I-">addInitializationFlow()</a>, <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addCompletionFlow-C-">addCompletionFlow()</a> or <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addErrorFlow-E-">addErrorFlow()</a> methods to register custom reactive flows for execution during the various stages of deleting a service instance.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="service-instance-status"><a class="anchor" href="#service-instance-status"></a>4.4. Service Instance Operation Status Retrieval</h3>
<div class="paragraph">
<p>If any create, update, or delete operation can return an asynchronous &#8220;operation in progress&#8221; response to the platform, the service broker must provide an implementation of the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/ServiceInstanceService.html#getLastOperation-org.springframework.cloud.servicebroker.model.instance.GetLastServiceOperationRequest-">getLastOperation()</a>. Otherwise, this method is never called by the platform, and the default implementation in the interface can be used.</p>
</div>
<div class="paragraph">
<p>The platform polls this method of the service broker for a service instance that has an asynchronous operation in progress until the service broker indicates that the operation has completed successfully or a failure has occurred.</p>
</div>
<div class="sect3">
<h4 id="event-registry-4"><a class="anchor" href="#event-registry-4"></a>4.4.1. Event Registry</h4>
<div class="paragraph">
<p>Service instance last operation requests can be further customized by utilizing events. Autowire the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistries.html">EventFlowRegistries</a> bean and retrieve the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/AsyncOperationServiceInstanceEventFlowRegistry.html">AsyncOperationServiceInstanceEventFlowRegistry</a> via the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistries.html#getLastOperationInstanceRegistry--">getLastOperationInstanceRegistry()</a> accessor. Use the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addInitializationFlow-I-">addInitializationFlow()</a>, <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addCompletionFlow-C-">addCompletionFlow()</a> or <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addErrorFlow-E-">addErrorFlow()</a> methods to register custom reactive flows for execution during the various stages of last operation retrieval.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="service-instance-retrieval"><a class="anchor" href="#service-instance-retrieval"></a>4.5. Service Instance Retrieval</h3>
<div class="paragraph">
<p>If the <code>instances_retrievable</code> field is set to <code>true</code> in the services catalog, the service broker must provide an implementation of the
<a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/ServiceInstanceService.html#getServiceInstance-org.springframework.cloud.servicebroker.model.instance.GetServiceInstanceRequest-">getServiceInstance()</a>. Otherwise, this method is never called by the platform, and the default implementation in the interface can be used.</p>
</div>
<div class="paragraph">
<p>Service brokers are responsible for maintaining any service instance state necessary to support the retrieval operation.</p>
</div>
</div>
<div class="sect2">
<h3 id="example-implementation"><a class="anchor" href="#example-implementation"></a>4.6. Example Implementation</h3>
<div class="paragraph">
<p>The following example shows a service instance implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package com.example.servicebroker;

import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import reactor.core.publisher.Mono;

import org.springframework.cloud.servicebroker.model.instance.CreateServiceInstanceRequest;
import org.springframework.cloud.servicebroker.model.instance.CreateServiceInstanceResponse;
import org.springframework.cloud.servicebroker.model.instance.DeleteServiceInstanceRequest;
import org.springframework.cloud.servicebroker.model.instance.DeleteServiceInstanceResponse;
import org.springframework.cloud.servicebroker.model.instance.GetLastServiceOperationRequest;
import org.springframework.cloud.servicebroker.model.instance.GetLastServiceOperationResponse;
import org.springframework.cloud.servicebroker.model.instance.GetServiceInstanceRequest;
import org.springframework.cloud.servicebroker.model.instance.GetServiceInstanceResponse;
import org.springframework.cloud.servicebroker.model.instance.OperationState;
import org.springframework.cloud.servicebroker.model.instance.UpdateServiceInstanceRequest;
import org.springframework.cloud.servicebroker.model.instance.UpdateServiceInstanceResponse;
import org.springframework.cloud.servicebroker.service.ServiceInstanceService;
import org.springframework.cloud.servicebroker.service.events.EventFlowRegistries;
import org.springframework.stereotype.Service;

@Service
public class ExampleServiceInstanceService implements ServiceInstanceService {

	@Override
	public Mono&lt;CreateServiceInstanceResponse&gt; createServiceInstance(CreateServiceInstanceRequest request) {
		String serviceInstanceId = request.getServiceInstanceId();
		String planId = request.getPlanId();
		Map&lt;String, Object&gt; parameters = request.getParameters();

		//
		// perform the steps necessary to initiate the asynchronous
		// provisioning of all necessary resources
		//

		String dashboardUrl = ""; /* construct a dashboard URL */

		return Mono.just(CreateServiceInstanceResponse.builder()
				.dashboardUrl(dashboardUrl)
				.async(true)
				.build());
	}

	@Override
	public Mono&lt;UpdateServiceInstanceResponse&gt; updateServiceInstance(UpdateServiceInstanceRequest request) {
		String serviceInstanceId = request.getServiceInstanceId();
		String planId = request.getPlanId();
		String previousPlan = request.getPreviousValues().getPlanId();
		Map&lt;String, Object&gt; parameters = request.getParameters();

		//
		// perform the steps necessary to initiate the asynchronous
		// updating of all necessary resources
		//

		return Mono.just(UpdateServiceInstanceResponse.builder()
				.async(true)
				.build());
	}

	@Override
	public Mono&lt;DeleteServiceInstanceResponse&gt; deleteServiceInstance(DeleteServiceInstanceRequest request) {
		String serviceInstanceId = request.getServiceInstanceId();
		String planId = request.getPlanId();

		//
		// perform the steps necessary to initiate the asynchronous
		// deletion of all provisioned resources
		//

		return Mono.just(DeleteServiceInstanceResponse.builder()
				.async(true)
				.build());
	}

	@Override
	public Mono&lt;GetServiceInstanceResponse&gt; getServiceInstance(GetServiceInstanceRequest request) {
		String serviceInstanceId = request.getServiceInstanceId();

		//
		// retrieve the details of the specified service instance
		//

		String dashboardUrl = ""; /* retrieve dashboard URL */

		return Mono.just(GetServiceInstanceResponse.builder()
				.dashboardUrl(dashboardUrl)
				.build());
	}

	@Override
	public Mono&lt;GetLastServiceOperationResponse&gt; getLastOperation(GetLastServiceOperationRequest request) {
		String serviceInstanceId = request.getServiceInstanceId();

		//
		// determine the status of the operation in progress
		//

		return Mono.just(GetLastServiceOperationResponse.builder()
				.operationState(OperationState.SUCCEEDED)
				.build());
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="example-event-flow-configuration"><a class="anchor" href="#example-event-flow-configuration"></a>4.7. Example Event Flow Configuration</h3>
<div class="paragraph">
<p>The following example shows a configuration for service instance event flows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package com.example.servicebroker;

import reactor.core.publisher.Mono;

import org.springframework.cloud.servicebroker.model.instance.CreateServiceInstanceRequest;
import org.springframework.cloud.servicebroker.model.instance.CreateServiceInstanceResponse;
import org.springframework.cloud.servicebroker.model.instance.DeleteServiceInstanceRequest;
import org.springframework.cloud.servicebroker.model.instance.DeleteServiceInstanceResponse;
import org.springframework.cloud.servicebroker.model.instance.GetLastServiceOperationRequest;
import org.springframework.cloud.servicebroker.model.instance.GetLastServiceOperationResponse;
import org.springframework.cloud.servicebroker.model.instance.UpdateServiceInstanceRequest;
import org.springframework.cloud.servicebroker.model.instance.UpdateServiceInstanceResponse;
import org.springframework.cloud.servicebroker.service.events.EventFlowRegistries;
import org.springframework.cloud.servicebroker.service.events.flows.AsyncOperationServiceInstanceCompletionFlow;
import org.springframework.cloud.servicebroker.service.events.flows.AsyncOperationServiceInstanceErrorFlow;
import org.springframework.cloud.servicebroker.service.events.flows.AsyncOperationServiceInstanceInitializationFlow;
import org.springframework.cloud.servicebroker.service.events.flows.CreateServiceInstanceCompletionFlow;
import org.springframework.cloud.servicebroker.service.events.flows.CreateServiceInstanceErrorFlow;
import org.springframework.cloud.servicebroker.service.events.flows.CreateServiceInstanceInitializationFlow;
import org.springframework.cloud.servicebroker.service.events.flows.DeleteServiceInstanceCompletionFlow;
import org.springframework.cloud.servicebroker.service.events.flows.DeleteServiceInstanceErrorFlow;
import org.springframework.cloud.servicebroker.service.events.flows.DeleteServiceInstanceInitializationFlow;
import org.springframework.cloud.servicebroker.service.events.flows.UpdateServiceInstanceCompletionFlow;
import org.springframework.cloud.servicebroker.service.events.flows.UpdateServiceInstanceErrorFlow;
import org.springframework.cloud.servicebroker.service.events.flows.UpdateServiceInstanceInitializationFlow;
import org.springframework.context.annotation.Configuration;

@Configuration
public class ExampleServiceInstanceEventFlowsConfiguration {

	// Autowire the EventFlowRegistries bean
	private EventFlowRegistries eventFlowRegistries;

	public ExampleServiceInstanceEventFlowsConfiguration(EventFlowRegistries eventFlowRegistries) {
		this.eventFlowRegistries = eventFlowRegistries;

		prepareCreateEventFlows()
				.then(prepareUpdateEventFlows())
				.then(prepareDeleteEventFlows())
				.then(prepareLastOperationEventFlows())
				.subscribe();
	}

	private Mono&lt;Void&gt; prepareCreateEventFlows() {
		return Mono.just(eventFlowRegistries.getCreateInstanceRegistry())
				.map(registry -&gt; registry.addInitializationFlow(new CreateServiceInstanceInitializationFlow() {
					@Override
					public Mono&lt;Void&gt; initialize(CreateServiceInstanceRequest request) {
						//
						// do something before the instance is created
						//
						return Mono.empty();
					}
				})
						.then(registry.addCompletionFlow(new CreateServiceInstanceCompletionFlow() {
							@Override
							public Mono&lt;Void&gt; complete(CreateServiceInstanceRequest request,
													   CreateServiceInstanceResponse response) {
								//
								// do something after the instance is created
								//
								return Mono.empty();
							}
						}))
						.then(registry.addErrorFlow(new CreateServiceInstanceErrorFlow() {
							@Override
							public Mono&lt;Void&gt; error(CreateServiceInstanceRequest request, Throwable t) {
								//
								// do something if an error occurs while creating an instance
								//
								return Mono.empty();
							}
						})))
				.then();
	}

	private Mono&lt;Void&gt; prepareUpdateEventFlows() {
		return Mono.just(eventFlowRegistries.getUpdateInstanceRegistry())
				.map(registry -&gt; registry.addInitializationFlow(new UpdateServiceInstanceInitializationFlow() {
					@Override
					public Mono&lt;Void&gt; initialize(UpdateServiceInstanceRequest request) {
						//
						// do something before the instance is updated
						//
						return Mono.empty();
					}
				})
						.then(registry.addCompletionFlow(new UpdateServiceInstanceCompletionFlow() {
							@Override
							public Mono&lt;Void&gt; complete(UpdateServiceInstanceRequest request,
													   UpdateServiceInstanceResponse response) {
								//
								// do something after the instance is updated
								//
								return Mono.empty();
							}
						}))
						.then(registry.addErrorFlow(new UpdateServiceInstanceErrorFlow() {
							@Override
							public Mono&lt;Void&gt; error(UpdateServiceInstanceRequest request, Throwable t) {
								//
								// do something if an error occurs while updating an instance
								//
								return Mono.empty();
							}
						})))
				.then();
	}

	private Mono&lt;Void&gt; prepareDeleteEventFlows() {
		return Mono.just(eventFlowRegistries.getDeleteInstanceRegistry())
				.map(registry -&gt; registry.addInitializationFlow(new DeleteServiceInstanceInitializationFlow() {
					@Override
					public Mono&lt;Void&gt; initialize(DeleteServiceInstanceRequest request) {
						//
						// do something before the instance is deleted
						//
						return Mono.empty();
					}
				})
						.then(registry.addCompletionFlow(new DeleteServiceInstanceCompletionFlow() {
							@Override
							public Mono&lt;Void&gt; complete(DeleteServiceInstanceRequest request,
													   DeleteServiceInstanceResponse response) {
								//
								// do something after the instance is deleted
								//
								return Mono.empty();
							}
						}))
						.then(registry.addErrorFlow(new DeleteServiceInstanceErrorFlow() {
							@Override
							public Mono&lt;Void&gt; error(DeleteServiceInstanceRequest request, Throwable t) {
								//
								// do something if an error occurs while deleting an instance
								//
								return Mono.empty();
							}
						})))
				.then();
	}

	private Mono&lt;Void&gt; prepareLastOperationEventFlows() {
		return Mono.just(eventFlowRegistries.getAsyncOperationRegistry())
				.map(registry -&gt; registry.addInitializationFlow(new AsyncOperationServiceInstanceInitializationFlow() {
					@Override
					public Mono&lt;Void&gt; initialize(GetLastServiceOperationRequest request) {
						//
						// do something before returning the last operation
						//
						return Mono.empty();
					}
				})
						.then(registry.addCompletionFlow(new AsyncOperationServiceInstanceCompletionFlow() {
							@Override
							public Mono&lt;Void&gt; complete(GetLastServiceOperationRequest request,
													   GetLastServiceOperationResponse response) {
								//
								// do something after returning the last operation
								//
								return Mono.empty();
							}
						}))
						.then(registry.addErrorFlow(new AsyncOperationServiceInstanceErrorFlow() {
							@Override
							public Mono&lt;Void&gt; error(GetLastServiceOperationRequest request, Throwable t) {
								//
								// do something if an error occurs while processing the last operation response
								//
								return Mono.empty();
							}
						})))
				.then();
	}

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="service-bindings"><a class="anchor" href="#service-bindings"></a>5. Service Bindings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Service brokers can provide information to a consumer of a service instance through a <a href="https://github.com/openservicebrokerapi/servicebroker/blob/master/spec.md#binding">service binding</a>.
Service bindings are often used to expose credentials for service instance resources to an application.</p>
</div>
<div class="paragraph">
<p>If the <code>bindable</code> field is set to <code>true</code> for any plan in the service catalog, the service broker must provide an implementation of the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/ServiceInstanceBindingService.html"><code>ServiceInstanceBindingService</code></a> interface.
Otherwise, the binding methods of the service broker are not called by the platform, and a default implementation of this interface can be used.
Each method receives a single Java object parameter that contains all details of the request from the platform and returns a Java object value that provides details of the operation to the platform.</p>
</div>
<div class="sect2">
<h3 id="service-binding-creation"><a class="anchor" href="#service-binding-creation"></a>5.1. Service Binding Creation</h3>
<div class="paragraph">
<p>The service broker must provide an implementation of the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/ServiceInstanceBindingService.html#createServiceInstanceBinding-org.springframework.cloud.servicebroker.model.binding.CreateServiceInstanceBindingRequest-">createServiceInstanceBinding()</a>.</p>
</div>
<div class="paragraph">
<p>Two types of bindings are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>App bindings can be used to provide credentials, log drains, and volume services to applications.</p>
</li>
<li>
<p>Route bindings can be used to provide routes for the platform to use when proxying requests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The response from this method lets one of two Java object types be returned, reflecting the two types of supported bindings.</p>
</div>
<div class="paragraph">
<p>Service brokers can generate one set of credentials for all binding requests or provide unique credentials for each binding request.</p>
</div>
<div class="sect3">
<h4 id="event-registry-5"><a class="anchor" href="#event-registry-5"></a>5.1.1. Event Registry</h4>
<div class="paragraph">
<p>Service binding creation can be further customized by utilizing events. Autowire the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistries.html">EventFlowRegistries</a> bean and retrieve the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/CreateServiceInstanceBindingEventFlowRegistry.html">CreateServiceInstanceBindingEventFlowRegistry</a> via the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistries.html#getCreateInstanceBindingRegistry--">getCreateInstanceBindingRegistry()</a> accessor. Use the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addInitializationFlow-I-">addInitializationFlow()</a>, <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addCompletionFlow-C-">addCompletionFlow()</a> or <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addErrorFlow-E-">addErrorFlow()</a> methods to register custom reactive flows for execution during the various stages of creating a service binding.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="service-binding-deletion"><a class="anchor" href="#service-binding-deletion"></a>5.2. Service Binding Deletion</h3>
<div class="paragraph">
<p>The service broker must provide an implementation of the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/ServiceInstanceBindingService.html#deleteServiceInstanceBinding-org.springframework.cloud.servicebroker.model.binding.DeleteServiceInstanceBindingRequest-">deleteServiceInstanceBinding()</a>.</p>
</div>
<div class="paragraph">
<p>Any credentials provisioned in the create operation should be deprovisioned by the delete operation.</p>
</div>
<div class="sect3">
<h4 id="event-registry-6"><a class="anchor" href="#event-registry-6"></a>5.2.1. Event Registry</h4>
<div class="paragraph">
<p>Service binding deletion can be further customized by utilizing events. Autowire the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistries.html">EventFlowRegistries</a> bean and retrieve the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/DeleteServiceInstanceBindingEventFlowRegistry.html">DeleteServiceInstanceBindingEventFlowRegistry</a> via the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistries.html#getDeleteInstanceBindingRegistry--">getDeleteInstanceBindingRegistry()</a> accessor. Use the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addInitializationFlow-I-">addInitializationFlow()</a>, <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addCompletionFlow-C-">addCompletionFlow()</a> or <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/events/EventFlowRegistry.html#addErrorFlow-E-">addErrorFlow()</a> methods to register custom reactive flows for execution during the various stages of deleting a service binding.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="service-binding-retrieval"><a class="anchor" href="#service-binding-retrieval"></a>5.3. Service Binding Retrieval</h3>
<div class="paragraph">
<p>If the <code>bindings_retrievable</code> field is set to <code>true</code> in the services catalog, the service catalog must provide an implementation of the <a href="https://docs.spring.io/spring-cloud-open-service-broker/docs/current/apidocs/org/springframework/cloud/servicebroker/service/ServiceInstanceBindingService.html#getServiceInstanceBinding-org.springframework.cloud.servicebroker.model.binding.GetServiceInstanceBindingRequest-">getServiceInstanceBinding()</a>.
Otherwise, this method is never called by the platform, and the default implementation in the interface can be used.</p>
</div>
<div class="paragraph">
<p>Service brokers are responsible for maintaining any service binding state necessary to support the retrieval operation.</p>
</div>
</div>
<div class="sect2">
<h3 id="example-implementation-2"><a class="anchor" href="#example-implementation-2"></a>5.4. Example Implementation</h3>
<div class="paragraph">
<p>The following example shows an implementation of a service binding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package com.example.servicebroker;

import reactor.core.publisher.Mono;

import org.springframework.cloud.servicebroker.model.binding.CreateServiceInstanceAppBindingResponse;
import org.springframework.cloud.servicebroker.model.binding.CreateServiceInstanceBindingRequest;
import org.springframework.cloud.servicebroker.model.binding.CreateServiceInstanceBindingResponse;
import org.springframework.cloud.servicebroker.model.binding.DeleteServiceInstanceBindingRequest;
import org.springframework.cloud.servicebroker.model.binding.DeleteServiceInstanceBindingResponse;
import org.springframework.cloud.servicebroker.model.binding.GetServiceInstanceAppBindingResponse;
import org.springframework.cloud.servicebroker.model.binding.GetServiceInstanceBindingRequest;
import org.springframework.cloud.servicebroker.model.binding.GetServiceInstanceBindingResponse;
import org.springframework.cloud.servicebroker.service.ServiceInstanceBindingService;
import org.springframework.stereotype.Service;

@Service
public class ExampleServiceBindingService implements ServiceInstanceBindingService {

	@Override
	public Mono&lt;CreateServiceInstanceBindingResponse&gt; createServiceInstanceBinding(CreateServiceInstanceBindingRequest request) {
		String serviceInstanceId = request.getServiceInstanceId();
		String bindingId = request.getBindingId();

		//
		// create credentials and store for later retrieval
		//

		String url = new String(/* build a URL to access the service instance */);
		String bindingUsername = new String(/* create a user */);
		String bindingPassword = new String(/* create a password */);

		CreateServiceInstanceBindingResponse response = CreateServiceInstanceAppBindingResponse.builder()
				.credentials("url", url)
				.credentials("username", bindingUsername)
				.credentials("password", bindingPassword)
				.bindingExisted(false)
				.async(true)
				.build();

		return Mono.just(response);
	}

	@Override
	public Mono&lt;DeleteServiceInstanceBindingResponse&gt; deleteServiceInstanceBinding(DeleteServiceInstanceBindingRequest request) {
		String serviceInstanceId = request.getServiceInstanceId();
		String bindingId = request.getBindingId();

		//
		// delete any binding-specific credentials
		//

		return Mono.just(DeleteServiceInstanceBindingResponse.builder()
				.async(true)
				.build());
	}

	@Override
	public Mono&lt;GetServiceInstanceBindingResponse&gt; getServiceInstanceBinding(GetServiceInstanceBindingRequest request) {
		String serviceInstanceId = request.getServiceInstanceId();
		String bindingId = request.getBindingId();

		//
		// retrieve the details of the specified service binding
		//

		String url = new String(/* retrieved URL */);
		String bindingUsername = new String(/* retrieved user */);
		String bindingPassword = new String(/* retrieved password */);

		GetServiceInstanceBindingResponse response = GetServiceInstanceAppBindingResponse.builder()
				.credentials("username", bindingUsername)
				.credentials("password", bindingPassword)
				.credentials("url", url)
				.build();

		return Mono.just(response);
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="example-event-flow-configuration-2"><a class="anchor" href="#example-event-flow-configuration-2"></a>5.5. Example Event Flow Configuration</h3>
<div class="paragraph">
<p>The following example shows a configuration of a service binding event flows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package com.example.servicebroker;

import reactor.core.publisher.Mono;

import org.springframework.cloud.servicebroker.model.binding.CreateServiceInstanceBindingRequest;
import org.springframework.cloud.servicebroker.model.binding.CreateServiceInstanceBindingResponse;
import org.springframework.cloud.servicebroker.model.binding.DeleteServiceInstanceBindingRequest;
import org.springframework.cloud.servicebroker.model.binding.DeleteServiceInstanceBindingResponse;
import org.springframework.cloud.servicebroker.model.instance.CreateServiceInstanceRequest;
import org.springframework.cloud.servicebroker.model.instance.CreateServiceInstanceResponse;
import org.springframework.cloud.servicebroker.model.instance.DeleteServiceInstanceRequest;
import org.springframework.cloud.servicebroker.model.instance.DeleteServiceInstanceResponse;
import org.springframework.cloud.servicebroker.model.instance.GetLastServiceOperationRequest;
import org.springframework.cloud.servicebroker.model.instance.GetLastServiceOperationResponse;
import org.springframework.cloud.servicebroker.model.instance.UpdateServiceInstanceRequest;
import org.springframework.cloud.servicebroker.model.instance.UpdateServiceInstanceResponse;
import org.springframework.cloud.servicebroker.service.events.EventFlowRegistries;
import org.springframework.cloud.servicebroker.service.events.flows.AsyncOperationServiceInstanceCompletionFlow;
import org.springframework.cloud.servicebroker.service.events.flows.AsyncOperationServiceInstanceErrorFlow;
import org.springframework.cloud.servicebroker.service.events.flows.AsyncOperationServiceInstanceInitializationFlow;
import org.springframework.cloud.servicebroker.service.events.flows.CreateServiceInstanceBindingCompletionFlow;
import org.springframework.cloud.servicebroker.service.events.flows.CreateServiceInstanceBindingErrorFlow;
import org.springframework.cloud.servicebroker.service.events.flows.CreateServiceInstanceBindingInitializationFlow;
import org.springframework.cloud.servicebroker.service.events.flows.CreateServiceInstanceCompletionFlow;
import org.springframework.cloud.servicebroker.service.events.flows.CreateServiceInstanceErrorFlow;
import org.springframework.cloud.servicebroker.service.events.flows.CreateServiceInstanceInitializationFlow;
import org.springframework.cloud.servicebroker.service.events.flows.DeleteServiceInstanceBindingCompletionFlow;
import org.springframework.cloud.servicebroker.service.events.flows.DeleteServiceInstanceBindingErrorFlow;
import org.springframework.cloud.servicebroker.service.events.flows.DeleteServiceInstanceBindingInitializationFlow;
import org.springframework.cloud.servicebroker.service.events.flows.DeleteServiceInstanceCompletionFlow;
import org.springframework.cloud.servicebroker.service.events.flows.DeleteServiceInstanceErrorFlow;
import org.springframework.cloud.servicebroker.service.events.flows.DeleteServiceInstanceInitializationFlow;
import org.springframework.cloud.servicebroker.service.events.flows.UpdateServiceInstanceCompletionFlow;
import org.springframework.cloud.servicebroker.service.events.flows.UpdateServiceInstanceErrorFlow;
import org.springframework.cloud.servicebroker.service.events.flows.UpdateServiceInstanceInitializationFlow;
import org.springframework.context.annotation.Configuration;

@Configuration
public class ExampleServiceBindingEventFlowsConfiguration {

	// Autowire the EventFlowRegistries bean
	private EventFlowRegistries eventFlowRegistries;

	public ExampleServiceBindingEventFlowsConfiguration(EventFlowRegistries eventFlowRegistries) {
		this.eventFlowRegistries = eventFlowRegistries;

		prepareCreateEventFlows()
				.then(prepareDeleteEventFlows())
				.subscribe();
	}

	private Mono&lt;Void&gt; prepareCreateEventFlows() {
		return Mono.just(eventFlowRegistries.getCreateInstanceBindingRegistry())
				.map(registry -&gt; registry.addInitializationFlow(new CreateServiceInstanceBindingInitializationFlow() {
					@Override
					public Mono&lt;Void&gt; initialize(CreateServiceInstanceBindingRequest request) {
						//
						// do something before the instance is created
						//
						return Mono.empty();
					}
				})
						.then(registry.addCompletionFlow(new CreateServiceInstanceBindingCompletionFlow() {
							@Override
							public Mono&lt;Void&gt; complete(CreateServiceInstanceBindingRequest request,
													   CreateServiceInstanceBindingResponse response) {
								//
								// do something after the instance is created
								//
								return Mono.empty();
							}
						}))
						.then(registry.addErrorFlow(new CreateServiceInstanceBindingErrorFlow() {
							@Override
							public Mono&lt;Void&gt; error(CreateServiceInstanceBindingRequest request, Throwable t) {
								//
								// do something if an error occurs while creating an instance
								//
								return Mono.empty();
							}
						})))
				.then();
	}

	private Mono&lt;Void&gt; prepareDeleteEventFlows() {
		return Mono.just(eventFlowRegistries.getDeleteInstanceBindingRegistry())
				.map(registry -&gt; registry.addInitializationFlow(new DeleteServiceInstanceBindingInitializationFlow() {
					@Override
					public Mono&lt;Void&gt; initialize(DeleteServiceInstanceBindingRequest request) {
						//
						// do something before the instance is deleted
						//
						return Mono.empty();
					}
				})
						.then(registry.addCompletionFlow(new DeleteServiceInstanceBindingCompletionFlow() {
							@Override
							public Mono&lt;Void&gt; complete(DeleteServiceInstanceBindingRequest request,
													   DeleteServiceInstanceBindingResponse response) {
								//
								// do something after the instance is deleted
								//
								return Mono.empty();
							}
						}))
						.then(registry.addErrorFlow(new DeleteServiceInstanceBindingErrorFlow() {
							@Override
							public Mono&lt;Void&gt; error(DeleteServiceInstanceBindingRequest request, Throwable t) {
								//
								// do something if an error occurs while deleting an instance
								//
								return Mono.empty();
							}
						})))
				.then();
	}

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="api-version-verification"><a class="anchor" href="#api-version-verification"></a>6. API version verification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Platforms are required to provide an <a href="https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#api-version-header">HTTP header</a> in each call to the Open Service Broker API, indicating the version of the API specification that the platform supports.
Spring Cloud Open Service Broker can be configured to verify the version provided by the platform on each call to the service broker.
This version verification is configured to allow any API version by default.</p>
</div>
<div class="paragraph">
<p>To customize the version verification, set the <code>apiVersion</code> property that specifies the API version required by the service broker, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">spring.cloud.openservicebroker.apiVersion=2.13</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, provide a <code>BrokerApiVersion</code> Spring bean, as in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package com.example.servicebroker;

import org.springframework.cloud.servicebroker.model.BrokerApiVersion;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class ExampleApiVersionConfiguration {
	@Bean
	public BrokerApiVersion brokerApiVersion() {
		return new BrokerApiVersion("2.13");
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the case of both a Spring Bean and a property being configured, then the Spring Bean will take precedence over the property.</p>
</div>
<div class="paragraph">
<p>If an API version is specified and the platform provides a different version in the <code>X-Broker-API-Version</code> header, the framework will return a <code>412 Precondition Failed</code> error to the platform.</p>
</div>
<div class="paragraph">
<p>As mentioned earlier, the default version verification is configured to allow any API version. However, to disable version verification entirely, set the <code>api-version-check-endabled</code> property to <code>false</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">spring.cloud.openservicebroker.api-version-check-enabled = false</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="service-broker-security"><a class="anchor" href="#service-broker-security"></a>7. Service Broker Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Authentication and authorization of service broker endpoints is not specified in the Open Service Broker API specification, but some platforms require or let <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">basic authentication</a> or <a href="https://oauth.net/2/">OAuth2</a> credentials be provided when a service broker is registered to the platform.</p>
</div>
<div class="paragraph">
<p>The Spring Cloud Open Service Broker project does not implement any security configuration.
Service broker application endpoints can be secured with <a href="https://projects.spring.io/spring-security/">Spring Security</a>
and <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-security.html">Spring Boot security configuration</a>
by applying security to application endpoints with the path-matching pattern: <code>/v2/**</code>.</p>
</div>
<div class="sect2">
<h3 id="example-configuration"><a class="anchor" href="#example-configuration"></a>7.1. Example Configuration</h3>
<div class="paragraph">
<p>The following examps shows a security configuration implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package com.example.servicebroker;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;

@Configuration
@EnableWebSecurity
public class ExampleSecurityConfig extends WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
				.authorizeRequests()
				.antMatchers("/v2/**").hasRole("ADMIN")
				.and()
				.httpBasic();
	}

	@Bean
	public InMemoryUserDetailsManager userDetailsService() {
		return new InMemoryUserDetailsManager(adminUser());
	}

	private UserDetails adminUser() {
		return User
				.withUsername("admin")
				.password("supersecret")
				.roles("ADMIN")
				.build();
	}
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example-service-broker"><a class="anchor" href="#example-service-broker"></a>8. Example Service Broker Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://github.com/spring-cloud-samples/bookstore-service-broker">Bookstore Service Broker</a> project implements a simple service broker that adheres to the Open Service Broker API by using the Spring Cloud Open Service Broker framework.
It can be deployed to either Cloud Foundry or Kubernetes and can be registered as a service broker to either platform.
View the project README for more information.</p>
</div>
</div>
</div>
</div>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
<link rel="stylesheet" href="js/highlight/styles/atom-one-dark-reasonable.min.css">
<script src="js/highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>