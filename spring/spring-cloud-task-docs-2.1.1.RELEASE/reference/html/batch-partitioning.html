<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>10.&nbsp;Remote Partitioning</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Cloud Task Reference Guide"><link rel="up" href="batch.html" title="Part&nbsp;IV.&nbsp;Batch"><link rel="prev" href="batch-association.html" title="9.&nbsp;Associating a Job Execution to the Task in which It Was Executed"><link rel="next" href="batch-informational-messages.html" title="11.&nbsp;Batch Informational Messages"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">10.&nbsp;Remote Partitioning</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="batch-association.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;IV.&nbsp;Batch</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="batch-informational-messages.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="batch-partitioning" href="#batch-partitioning"></a>10.&nbsp;Remote Partitioning</h2></div></div></div><p>Spring Cloud Deployer provides facilities for launching Spring Boot-based applications on
most cloud infrastructures. The <code class="literal">DeployerPartitionHandler</code> and
<code class="literal">DeployerStepExecutionHandler</code> delegate the launching of worker step executions to Spring
Cloud Deployer.</p><p>To configure the <code class="literal">DeployerStepExecutionHandler</code>, you must provide a <code class="literal">Resource</code>
representing the Spring Boot &uuml;ber-jar to be executed, a <code class="literal">TaskLauncher</code>, and a
<code class="literal">JobExplorer</code>. You can configure any environment properties as well as the max number of
workers to be executing at once, the interval to poll for the results (defaults to 10
seconds), and a timeout (defaults to -1 or no timeout). The following example shows how
configuring this <code class="literal">PartitionHandler</code> might look:</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> PartitionHandler partitionHandler(TaskLauncher taskLauncher,
		JobExplorer jobExplorer) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {

	MavenProperties mavenProperties = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> MavenProperties();
	mavenProperties.setRemoteRepositories(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> HashMap&lt;&gt;(Collections.singletonMap(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"springRepo"</span>,
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> MavenProperties.RemoteRepository(repository))));

 	Resource resource =
		MavenResource.parse(String.format(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"%s:%s:%s"</span>,
				<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"io.spring.cloud"</span>,
				<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"partitioned-batch-job"</span>,
				<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"1.1.0.RELEASE"</span>), mavenProperties);

	DeployerPartitionHandler partitionHandler =
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> DeployerPartitionHandler(taskLauncher, jobExplorer, resource, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"workerStep"</span>);

	List&lt;String&gt; commandLineArgs = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> ArrayList&lt;&gt;(<span class="hl-number">3</span>);
	commandLineArgs.add(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"--spring.profiles.active=worker"</span>);
	commandLineArgs.add(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"--spring.cloud.task.initialize.enable=false"</span>);
	commandLineArgs.add(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"--spring.batch.initializer.enabled=false"</span>);

	partitionHandler.setCommandLineArgsProvider(
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> PassThroughCommandLineArgsProvider(commandLineArgs));
	partitionHandler.setEnvironmentVariablesProvider(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> NoOpEnvironmentVariablesProvider());
	partitionHandler.setMaxWorkers(<span class="hl-number">2</span>);
	partitionHandler.setApplicationName(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"PartitionedBatchJobTask"</span>);

	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> partitionHandler;
}</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>When passing environment variables to partitions, each partition may
be on a different machine with different environment settings.
Consequently, you should pass only those environment variables that are required.</p></td></tr></table></div><p>The <code class="literal">Resource</code> to be executed is expected to be a Spring Boot &uuml;ber-jar with a
<code class="literal">DeployerStepExecutionHandler</code> configured as a <code class="literal">CommandLineRunner</code> in the current context.
The repository enumerated in the preceding example should be the remote repository in
which the &uuml;ber-jar is located. Both the master and slave are expected to have visibility
into the same data store being used as the job repository and task repository. Once the
underlying infrastructure has bootstrapped the Spring Boot jar and Spring Boot has
launched the <code class="literal">DeployerStepExecutionHandler</code>, the step handler executes the requested
<code class="literal">Step</code>. The following example shows how to configure the <code class="literal">DefaultStepExecutionHandler</code>:</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> DeployerStepExecutionHandler stepExecutionHandler(JobExplorer jobExplorer) {
	DeployerStepExecutionHandler handler =
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> DeployerStepExecutionHandler(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.context, jobExplorer, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.jobRepository);

	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> handler;
}</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>You can find a sample remote partition application in the samples module of the
Spring Cloud Task project,
<a class="link" href="https://github.com/spring-cloud/spring-cloud-task/tree/master/spring-cloud-task-samples/partitioned-batch-job" target="_top">here</a>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_notes_on_developing_a_batch_partitioned_application_for_the_kubernetes_platform" href="#_notes_on_developing_a_batch_partitioned_application_for_the_kubernetes_platform"></a>10.1&nbsp;Notes on Developing a Batch-partitioned application for the Kubernetes Platform</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">When deploying partitioned apps on the Kubernetes platform, you must use the following
dependency for the Spring Cloud Kubernetes Deployer:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-starter-deployer-kubernetes<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre></li><li class="listitem">The application name for the task application and its partitions need to follow
the following regex pattern: <code class="literal">[a-z0-9]([-a-z0-9]*[a-z0-9])</code>.
Otherwise, an exception is thrown.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_notes_on_developing_a_batch_partitioned_application_for_the_cloud_foundry_platform" href="#_notes_on_developing_a_batch_partitioned_application_for_the_cloud_foundry_platform"></a>10.2&nbsp;Notes on Developing a Batch-partitioned Application for the Cloud Foundry Platform</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">When deploying partitioned apps on the Cloud Foundry platform, you must use the
following dependencies for the Spring Cloud Foundry Deployer:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-deployer-cloudfoundry<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>io.projectreactor<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>reactor-core<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>3.1.5.RELEASE<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>io.projectreactor.ipc<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>reactor-netty<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>0.7.5.RELEASE<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre></li><li class="listitem"><p class="simpara">When configuring the partition handler, Cloud Foundry Deployment
environment variables need to be established so that the partition handler
can start the partitions. The following list shows the required environment
variables:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_url</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_org</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_space</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_domain</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_username</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_password</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_services</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_taskTimeout</code></li></ul></div></li></ul></div><p>An example set of deployment environment variables for a partitioned task that
uses a <code class="literal">mysql</code> database service might resemble the following:</p><pre class="programlisting">spring_cloud_deployer_cloudfoundry_url=https://api.local.pcfdev.io
spring_cloud_deployer_cloudfoundry_org=pcfdev-org
spring_cloud_deployer_cloudfoundry_space=pcfdev-space
spring_cloud_deployer_cloudfoundry_domain=local.pcfdev.io
spring_cloud_deployer_cloudfoundry_username=admin
spring_cloud_deployer_cloudfoundry_password=admin
spring_cloud_deployer_cloudfoundry_services=mysql
spring_cloud_deployer_cloudfoundry_taskTimeout=<span class="hl-number">300</span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>When using PCF-Dev, the following environment variable is also required:
<code class="literal">spring_cloud_deployer_cloudfoundry_skipSslValidation=true</code></p></td></tr></table></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="batch-association.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="batch.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="batch-informational-messages.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">9.&nbsp;Associating a Job Execution to the Task in which It Was Executed&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;11.&nbsp;Batch Informational Messages</td></tr></table></div></body></html>