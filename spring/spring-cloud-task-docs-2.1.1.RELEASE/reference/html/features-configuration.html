<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>8.&nbsp;Configuration</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Cloud Task Reference Guide"><link rel="up" href="features.html" title="Part&nbsp;III.&nbsp;Features"><link rel="prev" href="features-lifecycle.html" title="7.&nbsp;The lifecycle of a Spring Cloud Task"><link rel="next" href="batch.html" title="Part&nbsp;IV.&nbsp;Batch"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">8.&nbsp;Configuration</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="features-lifecycle.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;III.&nbsp;Features</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="batch.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="features-configuration" href="#features-configuration"></a>8.&nbsp;Configuration</h2></div></div></div><p>Spring Cloud Task provides a ready-to-use configuration, as defined in the
<code class="literal">DefaultTaskConfigurer</code> and <code class="literal">SimpleTaskConfiguration</code> classes. This section walks through
the defaults and how to customize Spring Cloud Task for your needs.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-data-source" href="#features-data-source"></a>8.1&nbsp;DataSource</h2></div></div></div><p>Spring Cloud Task uses a datasource for storing the results of task executions. By
default, we provide an in-memory instance of H2 to provide a simple method of
bootstrapping development. However, in a production environment, you probably want to
configure your own <code class="literal">DataSource</code>.</p><p>If your application uses only a single <code class="literal">DataSource</code> and that serves as both your business
schema and the task repository, all you need to do is provide any <code class="literal">DataSource</code> (the
easiest way to do so is through Spring Boot&#8217;s configuration conventions).  This
<code class="literal">DataSource</code> is automatically used by Spring Cloud Task for the repository.</p><p>If your application uses more than one <code class="literal">DataSource</code>, you need to configure the task
repository with the appropriate <code class="literal">DataSource</code>. This customization can be done through an
implementation of  <code class="literal">TaskConfigurer</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-table-prefix" href="#features-table-prefix"></a>8.2&nbsp;Table Prefix</h2></div></div></div><p>One modifiable property of <code class="literal">TaskRepository</code> is the table prefix for the task tables. By
default, they are all prefaced with <code class="literal">TASK_</code>. <code class="literal">TASK_EXECUTION</code> and <code class="literal">TASK_EXECUTION_PARAMS</code>
are two examples. However, there are potential reasons to modify this prefix. If the
schema name needs to be prepended to the table names or if more than one set of task
tables is needed within the same schema, you must change the table prefix. You can do so
by setting the <code class="literal">spring.cloud.task.tablePrefix</code> to the prefix you need, as follows:</p><p><code class="literal">spring.cloud.task.tablePrefix=yourPrefix</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-table-initialization" href="#features-table-initialization"></a>8.3&nbsp;Enable/Disable table initialization</h2></div></div></div><p>In cases where you are creating the task tables and do not wish for Spring Cloud Task to
create them at task startup, set the <code class="literal">spring.cloud.task.initialize.enable</code> property to
<code class="literal">false</code>, as follows:</p><p><code class="literal">spring.cloud.task.initialize.enable=false</code></p><p>It defaults to <code class="literal">true</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-generated_task_id" href="#features-generated_task_id"></a>8.4&nbsp;Externally Generated Task ID</h2></div></div></div><p>In some cases, you may want to allow for the time difference between when a task is
requested and when the infrastructure actually launches it. Spring Cloud Task lets you
create a <code class="literal">TaskExecution</code> when the task is requested. Then pass the execution ID of the
generated <code class="literal">TaskExecution</code> to the task so that it can update the <code class="literal">TaskExecution</code> through
the task&#8217;s lifecycle.</p><p>A <code class="literal">TaskExecution</code> can be created by calling the <code class="literal">createTaskExecution</code> method on an
implementation of the <code class="literal">TaskRepository</code> that references the datastore that holds
the <code class="literal">TaskExecution</code> objects.</p><p>In order to configure your Task to use a generated <code class="literal">TaskExecutionId</code>, add the
following property:</p><p><code class="literal">spring.cloud.task.executionid=yourtaskId</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-external_task_id" href="#features-external_task_id"></a>8.5&nbsp;External Task Id</h2></div></div></div><p>Spring Cloud Task lets you store an external task ID for each
<code class="literal">TaskExecution</code>. An example of this would be a task ID provided by
Cloud Foundry when a task is launched on the platform.
In order to configure your Task to use a generated <code class="literal">TaskExecutionId</code>, add the
following property:</p><p><code class="literal">spring.cloud.task.external-execution-id=&lt;externalTaskId&gt;</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-parent_task_id" href="#features-parent_task_id"></a>8.6&nbsp;Parent Task Id</h2></div></div></div><p>Spring Cloud Task lets you store a parent task ID for each <code class="literal">TaskExecution</code>. An example of
this would be a task that executes another task or tasks and you want to record which task
launched each of the child tasks. In order to configure your Task to set a parent
<code class="literal">TaskExecutionId</code> add the following property on the child task:</p><p><code class="literal">spring.cloud.task.parent-execution-id=&lt;parentExecutionTaskId&gt;</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-task-configurer" href="#features-task-configurer"></a>8.7&nbsp;TaskConfigurer</h2></div></div></div><p>The <code class="literal">TaskConfigurer</code> is a strategy interface that lets you customize the way components of
Spring Cloud Task are configured. By default, we provide the <code class="literal">DefaultTaskConfigurer</code> that
provides logical defaults: <code class="literal">Map</code>-based in-memory components (useful for development if no
<code class="literal">DataSource</code> is provided) and JDBC based components (useful if there is a <code class="literal">DataSource</code>
available).</p><p>The <code class="literal">TaskConfigurer</code> lets you configure three main components:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Component</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default (provided by <code class="literal">DefaultTaskConfigurer</code>)</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">TaskRepository</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The implementation of the <code class="literal">TaskRepository</code> to be used.</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SimpleTaskRepository</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">TaskExplorer</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The implementation of the <code class="literal">TaskExplorer</code> (a component for read-only access to the task
repository) to be used.</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SimpleTaskExplorer</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PlatformTransactionManager</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>A transaction manager to be used when running updates for tasks.</p></td><td style="" align="left" valign="top"><p><code class="literal">DataSourceTransactionManager</code> if a <code class="literal">DataSource</code> is used.
<code class="literal">ResourcelessTransactionManager</code> if it is not.</p></td></tr></tbody></table></div><p>You can customize any of the components described in the preceding table by creating a
custom implementation of the <code class="literal">TaskConfigurer</code> interface. Typically, extending the
<code class="literal">DefaultTaskConfigurer</code> (which is provided if a <code class="literal">TaskConfigurer</code> is not found) and
overriding the required getter is sufficient. However, implementing your own from scratch
may be required.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Users should not directly use getter methods from a <code class="literal">TaskConfigurer</code> directly
unless they are using it to supply implementations to be exposed as Spring Beans.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-task-name" href="#features-task-name"></a>8.8&nbsp;Task Name</h2></div></div></div><p>In most cases, the name of the task is the application name as configured in Spring
Boot. However, there are some cases where you may want to map the run of a task to a
different name. Spring Cloud Data Flow is an example of this (because you probably want
the task to be run with the name of the task definition). Because of this, we offer the
ability to customize how the task is named, through the <code class="literal">TaskNameResolver</code> interface.</p><p>By default, Spring Cloud Task provides the <code class="literal">SimpleTaskNameResolver</code>, which uses the
following options (in order of precedence):</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">A Spring Boot property (configured in any of the ways Spring Boot allows) called
<code class="literal">spring.cloud.task.name</code>.</li><li class="listitem">The application name as resolved using Spring Boot&#8217;s rules (obtained through
<code class="literal">ApplicationContext#getId</code>).</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-task-execution-listener" href="#features-task-execution-listener"></a>8.9&nbsp;Task Execution Listener</h2></div></div></div><p><code class="literal">TaskExecutionListener</code> lets you register listeners for specific events that occur during
the task lifecycle. To do so, create a class that implements the
<code class="literal">TaskExecutionListener</code> interface. The class that implements the <code class="literal">TaskExecutionListener</code>
interface is notified of the following events:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">onTaskStartup</code>: Prior to storing the <code class="literal">TaskExecution</code> into the <code class="literal">TaskRepository</code>.</li><li class="listitem"><code class="literal">onTaskEnd</code>: Prior to updating the <code class="literal">TaskExecution</code> entry in the <code class="literal">TaskRepository</code> and
marking the final state of the task.</li><li class="listitem"><code class="literal">onTaskFailed</code>: Prior to the <code class="literal">onTaskEnd</code> method being invoked when an unhandled
exception is thrown by the task.</li></ul></div><p>Spring Cloud Task also lets you add <code class="literal">TaskExecution</code> Listeners to methods within a bean
by using the following method annotations:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">@BeforeTask</code>: Prior to the storing the <code class="literal">TaskExecution</code> into the <code class="literal">TaskRepository</code></li><li class="listitem"><code class="literal">@AfterTask</code>: Prior to the updating of the <code class="literal">TaskExecution</code> entry in the <code class="literal">TaskRepository</code>
marking the final state of the task.</li><li class="listitem"><code class="literal">@FailedTask</code>: Prior to the <code class="literal">@AfterTask</code> method being invoked when an unhandled
exception is thrown by the task.</li></ul></div><p>The following example shows the three annotations in use:</p><pre class="programlisting"> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> MyBean {

	<em><span class="hl-annotation" style="color: gray">@BeforeTask</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> methodA(TaskExecution taskExecution) {
	}

	<em><span class="hl-annotation" style="color: gray">@AfterTask</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> methodB(TaskExecution taskExecution) {
	}

	<em><span class="hl-annotation" style="color: gray">@FailedTask</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> methodC(TaskExecution taskExecution, Throwable throwable) {
	}
}</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="features-task-execution-listener-Exceptions" href="#features-task-execution-listener-Exceptions"></a>8.9.1&nbsp;Exceptions Thrown by Task Execution Listener</h3></div></div></div><p>If an exception is thrown by a <code class="literal">TaskExecutionListener</code> event handler, all listener
processing for that event handler stops.  For example, if three <code class="literal">onTaskStartup</code> listeners
have started and the first <code class="literal">onTaskStartup</code> event handler throws an exception, the other
two <code class="literal">onTaskStartup</code> methods are not called. However, the other event handlers (<code class="literal">onTaskEnd</code>
and <code class="literal">onTaskFailed</code>) for the <code class="literal">TaskExecutionListeners</code> are called.</p><p>The exit code returned when a exception is thrown by a <code class="literal">TaskExecutionListener</code>
event handler is the exit code that was reported by the
<a class="link" href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/ExitCodeEvent.html" target="_top">ExitCodeEvent</a>.
If no <code class="literal">ExitCodeEvent</code> is emitted, the Exception thrown is evaluated to see
if it is of type
<a class="link" href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-application-exit" target="_top">ExitCodeGenerator</a>.
If so, it returns the exit code from  the <code class="literal">ExitCodeGenerator</code>. Otherwise, <code class="literal">1</code>
is returned.</p><p>In the case that an exception is thrown in an <code class="literal">onTaskStartup</code> method, the exit code for the application will be <code class="literal">1</code>.
If an exception is thrown in either a <code class="literal">onTaskEnd</code> or <code class="literal">onTaskFailed</code>
method, the exit code for the application will be the one established using the rules enumerated above.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>In the case of an exception being thrown in a <code class="literal">onTaskStartup</code>, <code class="literal">onTaskEnd</code>, or <code class="literal">onTaskFailed</code>
you can not override the exit code for the application using <code class="literal">ExitCodeExceptionMapper</code>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="features-task-execution-listener-exit-messages" href="#features-task-execution-listener-exit-messages"></a>8.9.2&nbsp;Exit Messages</h3></div></div></div><p>You can set the exit message for a task programmatically by using a
<code class="literal">TaskExecutionListener</code>. This is done by setting the <code class="literal">TaskExecution&#8217;s</code> <code class="literal">exitMessage</code>,
which then gets passed into the <code class="literal">TaskExecutionListener</code>. The following example shows
a method that is annotated with the <code class="literal">@AfterTask</code> <code class="literal">ExecutionListener</code> :</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@AfterTask</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> afterMe(TaskExecution taskExecution) {
    taskExecution.setExitMessage(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"AFTER EXIT MESSAGE"</span>);
}</pre><p>An <code class="literal">ExitMessage</code> can be set at any of the listener events (<code class="literal">onTaskStartup</code>,
<code class="literal">onTaskFailed</code>, and <code class="literal">onTaskEnd</code>). The order of precedence for the three listeners follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><code class="literal">onTaskEnd</code></li><li class="listitem"><code class="literal">onTaskFailed</code></li><li class="listitem"><code class="literal">onTaskStartup</code></li></ol></div><p>For example, if you set an <code class="literal">exitMessage</code> for the <code class="literal">onTaskStartup</code> and <code class="literal">onTaskFailed</code>
listeners and the task ends without failing, the <code class="literal">exitMessage</code> from the <code class="literal">onTaskStartup</code>
is stored in the repository. Otherwise, if a failure occurs, the <code class="literal">exitMessage</code> from
the <code class="literal">onTaskFailed</code> is stored. Also if you set the <code class="literal">exitMessage</code> with an
<code class="literal">onTaskEnd</code> listener, the <code class="literal">exitMessage</code> from the <code class="literal">onTaskEnd</code> supersedes
the exit messages from both the <code class="literal">onTaskStartup</code> and <code class="literal">onTaskFailed</code>.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_restricting_spring_cloud_task_instances" href="#_restricting_spring_cloud_task_instances"></a>8.10&nbsp;Restricting Spring Cloud Task Instances</h2></div></div></div><p>Spring Cloud Task lets you establish that only one task with a given task name can be run
at a time. To do so, you need to establish the <a class="link" href="features-configuration.html#features-task-name" title="8.8&nbsp;Task Name">task name</a> and set
<code class="literal">spring.cloud.task.single-instance-enabled=true</code> for each task execution. While the first
task execution is running, any other time you try to run a task with the same
<a class="link" href="features-configuration.html#features-task-name" title="8.8&nbsp;Task Name">task name</a> and`spring.cloud.task.single-instance-enabled=true`, the
task fails with the following error message: <code class="literal">Task with name "application" is already
running.</code> The default value for <code class="literal">spring.cloud.task.single-instance-enabled</code> is <code class="literal">false</code>. The
following example shows how to set <code class="literal">spring.cloud.task.single-instance-enabled</code> to <code class="literal">true</code>:</p><p><code class="literal">spring.cloud.task.single-instance-enabled=true or false</code></p><p>To use this feature, you must add the following Spring Integration dependencies to your
application:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-integration-core<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-integration-jdbc<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The exit code for the application will be 1 if the task fails because this feature
is enabled and another task is running with the same task name.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_disabling_spring_cloud_task_auto_configuration" href="#_disabling_spring_cloud_task_auto_configuration"></a>8.11&nbsp;Disabling Spring Cloud Task Auto Configuration</h2></div></div></div><p>In cases where Spring Cloud Task should not be auto configured for an implementation, you can disable Task&#8217;s auto configuration.
This can be done either by adding the following annotation to your Task application:</p><pre class="screen">@EnableAutoConfiguration(exclude={SimpleTaskAutoConfiguration.class})</pre><p>You may also disable Task auto configuration by setting the <code class="literal">spring.cloud.task.autoconfiguration.enabled</code> property to <code class="literal">false</code>.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="features-lifecycle.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="features.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="batch.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">7.&nbsp;The lifecycle of a Spring Cloud Task&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Part&nbsp;IV.&nbsp;Batch</td></tr></table></div></body></html>