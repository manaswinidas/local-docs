<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Spring Cloud Task Reference Guide</title><link rel="stylesheet" type="text/css" href="css/manual-singlepage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="d0e3"></a>Spring Cloud Task Reference Guide</h1></div><div><span xmlns:d="http://docbook.org/ns/docbook" class="author"><span class="firstname">Michael Minella, Glenn Renfro, Jay Bryant</span></span></div><div><p class="releaseinfo">2.1.1.RELEASE</p></div><div><p class="copyright">Copyright &copy; 2015-2017 Pivotal Software, Inc.</p></div><div><div class="legalnotice"><a name="d0e26" href="#d0e26"></a><p>
		Copies of this document may be made for your own use and for distribution to
		others, provided that you do not charge any fee for such copies and further
		provided that each copy contains this Copyright Notice, whether distributed in
		print or electronically.
	</p></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="part"><a href="#preface">I. Preface</a></span></dt><dd><dl><dt><span class="chapter"><a href="#_about_the_documentation">1. About the documentation</a></span></dt><dt><span class="chapter"><a href="#task-documentation-getting-help">2. Getting help</a></span></dt><dt><span class="chapter"><a href="#task-documentation-first-steps">3. First Steps</a></span></dt></dl></dd><dt><span class="part"><a href="#getting-started">II. Getting started</a></span></dt><dd><dl><dt><span class="chapter"><a href="#getting-started-introducing-spring-cloud-task">4. Introducing Spring Cloud Task</a></span></dt><dt><span class="chapter"><a href="#getting-started-system-requirements">5. System Requirements</a></span></dt><dd><dl><dt><span class="section"><a href="#_database_requirements">5.1. Database Requirements</a></span></dt></dl></dd><dt><span class="chapter"><a href="#getting-started-developing-first-task">6. Developing Your First Spring Cloud Task Application</a></span></dt><dd><dl><dt><span class="section"><a href="#getting-started-creating-project">6.1. Creating the Spring Task Project using Spring Initializr</a></span></dt><dt><span class="section"><a href="#getting-started-writing-the-code">6.2. Writing the Code</a></span></dt><dd><dl><dt><span class="section"><a href="#getting-started-at-task">6.2.1. Task Auto Configuration</a></span></dt><dt><span class="section"><a href="#getting-started-main-method">6.2.2. The main method</a></span></dt><dt><span class="section"><a href="#getting-started-clr">6.2.3. The CommandLineRunner</a></span></dt></dl></dd><dt><span class="section"><a href="#getting-started-running-the-example">6.3. Running the Example</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#features">III. Features</a></span></dt><dd><dl><dt><span class="chapter"><a href="#features-lifecycle">7. The lifecycle of a Spring Cloud Task</a></span></dt><dd><dl><dt><span class="section"><a href="#features-task-execution-details">7.1. The TaskExecution</a></span></dt><dt><span class="section"><a href="#features-lifecycle-exit-codes">7.2. Mapping Exit Codes</a></span></dt></dl></dd><dt><span class="chapter"><a href="#features-configuration">8. Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#features-data-source">8.1. DataSource</a></span></dt><dt><span class="section"><a href="#features-table-prefix">8.2. Table Prefix</a></span></dt><dt><span class="section"><a href="#features-table-initialization">8.3. Enable/Disable table initialization</a></span></dt><dt><span class="section"><a href="#features-generated_task_id">8.4. Externally Generated Task ID</a></span></dt><dt><span class="section"><a href="#features-external_task_id">8.5. External Task Id</a></span></dt><dt><span class="section"><a href="#features-parent_task_id">8.6. Parent Task Id</a></span></dt><dt><span class="section"><a href="#features-task-configurer">8.7. TaskConfigurer</a></span></dt><dt><span class="section"><a href="#features-task-name">8.8. Task Name</a></span></dt><dt><span class="section"><a href="#features-task-execution-listener">8.9. Task Execution Listener</a></span></dt><dd><dl><dt><span class="section"><a href="#features-task-execution-listener-Exceptions">8.9.1. Exceptions Thrown by Task Execution Listener</a></span></dt><dt><span class="section"><a href="#features-task-execution-listener-exit-messages">8.9.2. Exit Messages</a></span></dt></dl></dd><dt><span class="section"><a href="#_restricting_spring_cloud_task_instances">8.10. Restricting Spring Cloud Task Instances</a></span></dt><dt><span class="section"><a href="#_disabling_spring_cloud_task_auto_configuration">8.11. Disabling Spring Cloud Task Auto Configuration</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#batch">IV. Batch</a></span></dt><dd><dl><dt><span class="chapter"><a href="#batch-association">9. Associating a Job Execution to the Task in which It Was Executed</a></span></dt><dd><dl><dt><span class="section"><a href="#batch-association-override">9.1. Overriding the TaskBatchExecutionListener</a></span></dt></dl></dd><dt><span class="chapter"><a href="#batch-partitioning">10. Remote Partitioning</a></span></dt><dd><dl><dt><span class="section"><a href="#_notes_on_developing_a_batch_partitioned_application_for_the_kubernetes_platform">10.1. Notes on Developing a Batch-partitioned application for the Kubernetes Platform</a></span></dt><dt><span class="section"><a href="#_notes_on_developing_a_batch_partitioned_application_for_the_cloud_foundry_platform">10.2. Notes on Developing a Batch-partitioned Application for the Cloud Foundry Platform</a></span></dt></dl></dd><dt><span class="chapter"><a href="#batch-informational-messages">11. Batch Informational Messages</a></span></dt><dt><span class="chapter"><a href="#batch-failures-and-tasks">12. Batch Job Exit Codes</a></span></dt></dl></dd><dt><span class="part"><a href="#stream-integration">V. Spring Cloud Stream Integration</a></span></dt><dd><dl><dt><span class="chapter"><a href="#stream-integration-launching-sink">13. Launching a Task from a Spring Cloud Stream</a></span></dt><dd><dl><dt><span class="section"><a href="#stream-integration-launching-sink-dataflow">13.1. Spring Cloud Data Flow</a></span></dt></dl></dd><dt><span class="chapter"><a href="#stream-integration-events">14. Spring Cloud Task Events</a></span></dt><dd><dl><dt><span class="section"><a href="#stream-integration-disable-task-events">14.1. Disabling Specific Task Events</a></span></dt></dl></dd><dt><span class="chapter"><a href="#stream-integration-batch-events">15. Spring Batch Events</a></span></dt><dd><dl><dt><span class="section"><a href="#_sending_batch_events_to_different_channels">15.1. Sending Batch Events to Different Channels</a></span></dt><dt><span class="section"><a href="#_disabling_batch_events">15.2. Disabling Batch Events</a></span></dt><dt><span class="section"><a href="#_emit_order_for_batch_events">15.3. Emit Order for Batch Events</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#appendix">VI. Appendices</a></span></dt><dd><dl><dt><span class="chapter"><a href="#appendix-task-repository-schema">16. Task Repository Schema</a></span></dt><dt><span class="chapter"><a href="#appendix-building-the-documentation">17. Building This Documentation</a></span></dt><dt><span class="chapter"><a href="#appendix-cloud-foundry">18. Running a Task App on Cloud Foundry</a></span></dt></dl></dd></dl></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="preface" href="#preface"></a>Part&nbsp;I.&nbsp;Preface</h1></div></div></div><div class="partintro"><div></div><p>This section provides a brief overview of the Spring Cloud Task reference documentation.
Think of it as a map for the rest of the document. You can read this reference guide in a
linear fashion or you can skip sections if something does not interest you.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_about_the_documentation" href="#_about_the_documentation"></a>1.&nbsp;About the documentation</h2></div></div></div><p>The Spring Cloud Task reference guide is available in <a class="link" href="http://docs.spring.io/spring-cloud-task/docs/{version}/reference/html" target="_top">html</a>,
<a class="link" href="http://docs.spring.io/spring-cloud-task/docs/{version}/reference/pdf/spring-cloud-task-reference.pdf" target="_top">pdf</a>
and <a class="link" href="http://docs.spring.io/spring-cloud-task/docs/{version}/reference/epub/spring-cloud-task-reference.epub" target="_top">epub</a> formats. The
latest copy is available at <a class="link" href="http://docs.spring.io/spring-cloud-task/docs/current-SNAPSHOT/reference/html/" target="_top">docs.spring.io/spring-cloud-task/docs/current-SNAPSHOT/reference/html/</a>.</p><p>Copies of this document may be made for your own use and for distribution to others,
provided that you do not charge any fee for such copies and further provided that each
copy contains this Copyright Notice, whether distributed in print or electronically.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="task-documentation-getting-help" href="#task-documentation-getting-help"></a>2.&nbsp;Getting help</h2></div></div></div><p>Having trouble with Spring Cloud Task? We would like to help!</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Ask a question. We monitor <a class="link" href="http://stackoverflow.com" target="_top">stackoverflow.com</a> for questions
tagged with <a class="link" href="http://stackoverflow.com/tags/spring-cloud-task" target="_top"><code class="literal">spring-cloud-task</code></a>.</li><li class="listitem">Report bugs with Spring Cloud Task at
<a class="link" href="https://github.com/spring-cloud/spring-cloud-task/issues" target="_top">github.com/spring-cloud/spring-cloud-task/issues</a>.</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>All of Spring Cloud Task is open source, including the documentation. If you find
a problem with the docs or if you just want to improve them, please <a class="link" href="http://github.com/spring-cloud/spring-cloud-task/tree/v2.1.1.RELEASE" target="_top">get
involved</a>.</p></td></tr></table></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="task-documentation-first-steps" href="#task-documentation-first-steps"></a>3.&nbsp;First Steps</h2></div></div></div><p>If you are just getting started with Spring Cloud Task or with 'Spring' in general, we
suggesting reading the <a class="xref" href="#getting-started" title="Part&nbsp;II.&nbsp;Getting started">Part&nbsp;II, &#8220;Getting started&#8221;</a> chapter.</p><p>To get started from scratch, read the following sections:
* &#8220;<a class="xref" href="#getting-started-introducing-spring-cloud-task" title="4.&nbsp;Introducing Spring Cloud Task">Chapter&nbsp;4, <i>Introducing Spring Cloud Task</i></a>&#8221;
* &#8220;<a class="xref" href="#getting-started-system-requirements" title="5.&nbsp;System Requirements">Chapter&nbsp;5, <i>System Requirements</i></a>&#8221;
To follow the tutorial, read
&#8220;<a class="xref" href="#getting-started-developing-first-task" title="6.&nbsp;Developing Your First Spring Cloud Task Application">Chapter&nbsp;6, <i>Developing Your First Spring Cloud Task Application</i></a>&#8221;
To run your example, read
&#8220;<a class="xref" href="#getting-started-running-the-example" title="6.3&nbsp;Running the Example">Section&nbsp;6.3, &#8220;Running the Example&#8221;</a>&#8221;</p></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="getting-started" href="#getting-started"></a>Part&nbsp;II.&nbsp;Getting started</h1></div></div></div><div class="partintro"><div></div><p>If you are just getting started with Spring Cloud Task, you should read this section.
Here, we answer the basic &#8220;what?&#8221;, &#8220;how?&#8221;, and &#8220;why?&#8221; questions. We start with a
gentle introduction to Spring Cloud Task. We then build a Spring Cloud Task application,
discussing some core principles as we go.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="getting-started-introducing-spring-cloud-task" href="#getting-started-introducing-spring-cloud-task"></a>4.&nbsp;Introducing Spring Cloud Task</h2></div></div></div><p>Spring Cloud Task makes it easy to create short-lived microservices. It provides
capabilities that let short lived JVM processes be executed on demand in a production
environment.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="getting-started-system-requirements" href="#getting-started-system-requirements"></a>5.&nbsp;System Requirements</h2></div></div></div><p>You need to have Java installed (Java 8 or better). To build, you need to have Maven
installed as well.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_database_requirements" href="#_database_requirements"></a>5.1&nbsp;Database Requirements</h2></div></div></div><p>Spring Cloud Task uses a relational database to store the results of an executed task.
While you can begin developing a task without a database (the status of the task is logged
as part of the task repository&#8217;s updates), for production environments, you want to
use a supported database. Spring Cloud Task currently supports the following databases:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">DB2</li><li class="listitem">H2</li><li class="listitem">HSQLDB</li><li class="listitem">MySql</li><li class="listitem">Oracle</li><li class="listitem">Postgres</li><li class="listitem">SqlServer</li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="getting-started-developing-first-task" href="#getting-started-developing-first-task"></a>6.&nbsp;Developing Your First Spring Cloud Task Application</h2></div></div></div><p>A good place to start is with a simple &#8220;Hello, World!&#8221; application, so we create the
Spring Cloud Task equivalent to highlight the features of the framework. Most IDEs have
good support for Apache Maven, so we use it as the build tool for this project.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The spring.io web site contains many <a class="link" href="https://spring.io/guides" target="_top">&#8220;<code class="literal">Getting Started</code>&#8221;
guides</a> that use Spring Boot. If you need to solve a specific problem, check there first.
You can shortcut the following steps by going to the
<a class="link" href="http://start.spring.io/" target="_top">Spring Initializr</a> and creating a new project. Doing so
automatically generates a new project structure so that you can start coding right away.
We recommend experimenting with the Spring Initializr to become familiar with it.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="getting-started-creating-project" href="#getting-started-creating-project"></a>6.1&nbsp;Creating the Spring Task Project using Spring Initializr</h2></div></div></div><p>Now we can create and test an application that prints <code class="literal">Hello, World!</code> to the console.</p><p>To do so:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">Visit the <a class="link" href="https://start.spring.io/" target="_top">Spring Initialzr</a> site.</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">Create a new Maven project with a <span class="strong"><strong>Group</strong></span> name of <code class="literal">io.spring.demo</code> and an <span class="strong"><strong>Artifact</strong></span> name of <code class="literal">helloworld</code>.</li><li class="listitem">In the Dependencies text box, type <code class="literal">task</code> and then select the <code class="literal">Cloud Task</code> dependency.</li><li class="listitem">In the Dependencies text box, type <code class="literal">jdbc</code> and then select the <code class="literal">JDBC</code> dependency.</li><li class="listitem">In the Dependencies text box, type <code class="literal">h2</code> and then select the <code class="literal">H2</code>. (or your favorite database)</li><li class="listitem">Click the <span class="strong"><strong>Generate Project</strong></span> button</li></ol></div></li><li class="listitem">Unzip the timestamp.zip file and import the project into your favorite IDE.</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="getting-started-writing-the-code" href="#getting-started-writing-the-code"></a>6.2&nbsp;Writing the Code</h2></div></div></div><p>To finish our application, we need to update the generated <code class="literal">HelloworldApplication</code> with the following contents so that it launches a Task.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.spring.demo.helloworld;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.CommandLineRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.SpringApplication;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.context.annotation.Bean;

<em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> HelloworldApplication {
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> SampleTask {

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> CommandLineRunner commandLineRunner() {
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> HelloWorldCommandLineRunner();
	}

	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">static</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> main(String[] args) {
		SpringApplication.run(HelloworldApplication.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>, args);
	}

	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">static</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> HelloWorldCommandLineRunner <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">implements</span> CommandLineRunner {

		<em><span class="hl-annotation" style="color: gray">@Override</span></em>
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> run(String... strings) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {
			System.out.println(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Hello, World!"</span>);
		}
	}
}</pre><p>While it may seem small, quite a bit is going on. For more about Spring
Boot specifics, see the
<a class="link" href="http://docs.spring.io/spring-boot/docs/current/reference/html/" target="_top">Spring Boot reference documentation</a>.</p><p>Now we can open the <code class="literal">application.properties</code> file in <code class="literal">src/main/resources</code>.
We need to configure two properties in <code class="literal">application.properties</code>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">application.name</code>: To set the application name (which is translated to the task name)</li><li class="listitem"><code class="literal">logging.level</code>: To set the logging for Spring Cloud Task to <code class="literal">DEBUG</code> in order to
get a view of what is going on.</li></ul></div><p>The following example shows how to do both:</p><pre class="screen">logging.level.org.springframework.cloud.task=DEBUG
spring.application.name=helloWorld</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="getting-started-at-task" href="#getting-started-at-task"></a>6.2.1&nbsp;Task Auto Configuration</h3></div></div></div><p>When including Spring Cloud Task Starter dependency, Task auto configures all beans to bootstrap it&#8217;s functionality.
Part of this configuration registers the <code class="literal">TaskRepository</code> and the infrastructure for its use.</p><p>In our demo, the <code class="literal">TaskRepository</code> uses an embedded H2 database to record the results
of a task. This H2 embedded database is not a practical solution for a production environment, since
the H2 DB goes away once the task ends. However, for a quick getting-started
experience, we can use this in our example as well as echoing to the logs what is being updated
in that repository. In the <a class="xref" href="#features-configuration" title="8.&nbsp;Configuration">Chapter&nbsp;8, <i>Configuration</i></a> section (later in this
documentation), we cover how to customize the configuration of the pieces provided by
Spring Cloud Task.</p><p>When our sample application runs, Spring Boot launches our <code class="literal">HelloWorldCommandLineRunner</code>
and outputs our &#8220;Hello, World!&#8221; message to standard out. The <code class="literal">TaskLifecycleListener</code>
records the start of the task and the end of the task in the repository.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="getting-started-main-method" href="#getting-started-main-method"></a>6.2.2&nbsp;The main method</h3></div></div></div><p>The main method serves as the entry point to any java application.  Our main method
delegates to Spring Boot&#8217;s <a class="link" href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-spring-application.html" target="_top">SpringApplication</a> class.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="getting-started-clr" href="#getting-started-clr"></a>6.2.3&nbsp;The CommandLineRunner</h3></div></div></div><p>Spring includes many ways to bootstrap an application&#8217;s logic. Spring Boot provides
a convenient method of doing so in an organized manner through its <code class="literal">*Runner</code> interfaces
(<code class="literal">CommandLineRunner</code> or <code class="literal">ApplicationRunner</code>). A well behaved task can bootstrap any
logic by using one of these two runners.</p><p>The lifecycle of a task is considered from before the <code class="literal">*Runner#run</code> methods are executed
to once they are all complete. Spring Boot lets an application use multiple
<code class="literal">*Runner</code> implementations, as does Spring Cloud Task.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Any processing bootstrapped from mechanisms other than a <code class="literal">CommandLineRunner</code> or
<code class="literal">ApplicationRunner</code> (by using <code class="literal">InitializingBean#afterPropertiesSet</code> for example) is not
 recorded by Spring Cloud Task.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="getting-started-running-the-example" href="#getting-started-running-the-example"></a>6.3&nbsp;Running the Example</h2></div></div></div><p>At this point, our application should work.  Since this application is Spring Boot-based,
we can run it from the command line by using <code class="literal">$ mvn spring-boot:run</code> from the root
of our application, as shown (with its output) in the following example:</p><pre class="screen">$ mvn clean spring-boot:run
....... . . .
....... . . . (Maven log output here)
....... . . .

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::        (v2.0.3.RELEASE)

2018-07-23 17:44:34.426  INFO 1978 --- [           main] i.s.d.helloworld.HelloworldApplication   : Starting HelloworldApplication on Glenns-MBP-2.attlocal.net with PID 1978 (/Users/glennrenfro/project/helloworld/target/classes started by glennrenfro in /Users/glennrenfro/project/helloworld)
2018-07-23 17:44:34.430  INFO 1978 --- [           main] i.s.d.helloworld.HelloworldApplication   : No active profile set, falling back to default profiles: default
2018-07-23 17:44:34.472  INFO 1978 --- [           main] s.c.a.AnnotationConfigApplicationContext : Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@1d24f32d: startup date [Mon Jul 23 17:44:34 EDT 2018]; root of context hierarchy
2018-07-23 17:44:35.280  INFO 1978 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...
2018-07-23 17:44:35.410  INFO 1978 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2018-07-23 17:44:35.419 DEBUG 1978 --- [           main] o.s.c.t.c.SimpleTaskConfiguration        : Using org.springframework.cloud.task.configuration.DefaultTaskConfigurer TaskConfigurer
2018-07-23 17:44:35.420 DEBUG 1978 --- [           main] o.s.c.t.c.DefaultTaskConfigurer          : No EntityManager was found, using DataSourceTransactionManager
2018-07-23 17:44:35.522 DEBUG 1978 --- [           main] o.s.c.t.r.s.TaskRepositoryInitializer    : Initializing task schema for h2 database
2018-07-23 17:44:35.525  INFO 1978 --- [           main] o.s.jdbc.datasource.init.ScriptUtils     : Executing SQL script from class path resource [org/springframework/cloud/task/schema-h2.sql]
2018-07-23 17:44:35.558  INFO 1978 --- [           main] o.s.jdbc.datasource.init.ScriptUtils     : Executed SQL script from class path resource [org/springframework/cloud/task/schema-h2.sql] in 33 ms.
2018-07-23 17:44:35.728  INFO 1978 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup
2018-07-23 17:44:35.730  INFO 1978 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Bean with name 'dataSource' has been autodetected for JMX exposure
2018-07-23 17:44:35.733  INFO 1978 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Located MBean 'dataSource': registering with JMX server as MBean [com.zaxxer.hikari:name=dataSource,type=HikariDataSource]
2018-07-23 17:44:35.738  INFO 1978 --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Starting beans in phase 0
2018-07-23 17:44:35.762 DEBUG 1978 --- [           main] o.s.c.t.r.support.SimpleTaskRepository   : Creating: TaskExecution{executionId=0, parentExecutionId=null, exitCode=null, taskName='application', startTime=Mon Jul 23 17:44:35 EDT 2018, endTime=null, exitMessage='null', externalExecutionId='null', errorMessage='null', arguments=[]}
2018-07-23 17:44:35.772  INFO 1978 --- [           main] i.s.d.helloworld.HelloworldApplication   : Started HelloworldApplication in 1.625 seconds (JVM running for 4.764)
Hello, World!
2018-07-23 17:44:35.782 DEBUG 1978 --- [           main] o.s.c.t.r.support.SimpleTaskRepository   : Updating: TaskExecution with executionId=1 with the following {exitCode=0, endTime=Mon Jul 23 17:44:35 EDT 2018, exitMessage='null', errorMessage='null'}</pre><p>The preceding output has three lines that of interest to us here:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">SimpleTaskRepository</code> logged the creation of the entry in the <code class="literal">TaskRepository</code>.</li><li class="listitem">The execution of our <code class="literal">CommandLineRunner</code>, demonstrated by the &#8220;Hello, World!&#8221; output.</li><li class="listitem"><code class="literal">SimpleTaskRepository</code> logs the completion of the task in the <code class="literal">TaskRepository</code>.</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>A simple task application can be found in the samples module of the Spring Cloud
Task Project
<a class="link" href="https://github.com/spring-cloud/spring-cloud-task/tree/master/spring-cloud-task-samples/timestamp" target="_top">here</a>.</p></td></tr></table></div></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="features" href="#features"></a>Part&nbsp;III.&nbsp;Features</h1></div></div></div><div class="partintro"><div></div><p>This section goes into more detail about Spring Cloud Task, including how to use it, how
to configure it, and the appropriate extension points.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="features-lifecycle" href="#features-lifecycle"></a>7.&nbsp;The lifecycle of a Spring Cloud Task</h2></div></div></div><p>In most cases, the modern cloud environment is designed around the execution of processes
that are not expected to end. If they do end, they are typically restarted. While most
platforms do have some way to run a process that is not restarted when it ends, the
results of that run are typically not maintained in a consumable way. Spring Cloud
Task offers the ability to execute short-lived processes in an environment and record the
results. Doing so allows for a microservices architecture around short-lived processes as
well as longer running services through the integration of tasks by messages.</p><p>While this functionality is useful in a cloud environment, the same issues can arise in a
traditional deployment model as well. When running Spring Boot applications with a
scheduler such as cron, it can be useful to be able to monitor the results of the
application after its completion.</p><p>Spring Cloud Task takes the approach that a Spring Boot application can have a start and
an end and still be successful. Batch applications are one example of how processes that
are expected to end (and that are often short-lived) can be helpful.</p><p>Spring Cloud Task records the lifecycle events of a given task. Most long-running
processes, typified by most web applications, do not save their lifecycle events. The
tasks at the heart of Spring Cloud Task do.</p><p>The lifecycle consists of a single task execution. This is a physical execution of a
Spring Boot application configured to be a task (that is, it has the Sprint Cloud Task dependencies).</p><p>At the beginning of a task, before any <code class="literal">CommandLineRunner</code> or <code class="literal">ApplicationRunner</code>
implementations have been run, an entry in the <code class="literal">TaskRepository</code> that records the start
event is created. This event is triggered through <code class="literal">SmartLifecycle#start</code> being triggered
by the Spring Framework. This indicates to the system that all beans are ready for use and
comes before running any of the <code class="literal">CommandLineRunner</code> or <code class="literal">ApplicationRunner</code> implementations
provided by Spring Boot.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The recording of a task only occurs upon the successful bootstrapping of an
<code class="literal">ApplicationContext</code>. If the context fails to bootstrap at all, the task&#8217;s run is not
recorded.</p></td></tr></table></div><p>Upon completion of all of the <code class="literal">*Runner#run</code> calls from Spring Boot or the failure of an
<code class="literal">ApplicationContext</code> (indicated by an <code class="literal">ApplicationFailedEvent</code>), the task execution is
updated in the repository with the results.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If the application requires the <code class="literal">ApplicationContext</code> to be closed at the
completion of a task (all <code class="literal">*Runner#run</code> methods have been called and the task
repository has been updated), set the property <code class="literal">spring.cloud.task.closecontext_enabled</code>
to true.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-task-execution-details" href="#features-task-execution-details"></a>7.1&nbsp;The TaskExecution</h2></div></div></div><p>The information stored in the <code class="literal">TaskRepository</code> is modeled in the <code class="literal">TaskExecution</code> class and
consists of the following information:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Field</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">executionid</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The unique ID for the task&#8217;s run.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">exitCode</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The exit code generated from an <code class="literal">ExitCodeExceptionMapper</code> implementation. If there is no
exit code generated but an <code class="literal">ApplicationFailedEvent</code> is thrown, 1 is set.  Otherwise, it is
assumed to be 0.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">taskName</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name for the task, as determined by the configured <code class="literal">TaskNameResolver</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">startTime</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The time the task was started, as indicated by the <code class="literal">SmartLifecycle#start</code> call.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">endTime</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The time the task was completed, as indicated by the <code class="literal">ApplicationReadyEvent</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">exitMessage</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Any information available at the time of exit. This can programmatically be set by a
<code class="literal">TaskExecutionListener</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">errorMessage</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If an exception is the cause of the end of the task (as indicated by an
<code class="literal">ApplicationFailedEvent</code>), the stack trace for that exception is stored here.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">arguments</code></p></td><td style="" align="left" valign="top"><p>A <code class="literal">List</code> of the string command line arguments as they were passed into the executable
boot application.</p></td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-lifecycle-exit-codes" href="#features-lifecycle-exit-codes"></a>7.2&nbsp;Mapping Exit Codes</h2></div></div></div><p>When a task completes, it tries to return an exit code to the OS. If we take a look
at our <a class="link" href="#getting-started-developing-first-task" title="6.&nbsp;Developing Your First Spring Cloud Task Application">original example</a>, we can see that we are
not controlling that aspect of our application. So, if an exception is thrown, the JVM
returns a code that may or may not be of any use to you in debugging.</p><p>Consequently, Spring Boot provides an interface, <code class="literal">ExitCodeExceptionMapper</code>, that lets you
map uncaught exceptions to exit codes. Doing so lets you indicate, at the level of exit
codes, what went wrong. Also, by mapping exit codes in this manner, Spring Cloud Task
records the returned exit code.</p><p>If the task terminates with a SIG-INT or a SIG-TERM, the exit code is zero unless
otherwise specified within the code.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>While the task is running, the exit code is stored as a null in the repository.
Once the task completes, the appropriate exit code is stored based on the guidelines described
earlier in this section.</p></td></tr></table></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="features-configuration" href="#features-configuration"></a>8.&nbsp;Configuration</h2></div></div></div><p>Spring Cloud Task provides a ready-to-use configuration, as defined in the
<code class="literal">DefaultTaskConfigurer</code> and <code class="literal">SimpleTaskConfiguration</code> classes. This section walks through
the defaults and how to customize Spring Cloud Task for your needs.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-data-source" href="#features-data-source"></a>8.1&nbsp;DataSource</h2></div></div></div><p>Spring Cloud Task uses a datasource for storing the results of task executions. By
default, we provide an in-memory instance of H2 to provide a simple method of
bootstrapping development. However, in a production environment, you probably want to
configure your own <code class="literal">DataSource</code>.</p><p>If your application uses only a single <code class="literal">DataSource</code> and that serves as both your business
schema and the task repository, all you need to do is provide any <code class="literal">DataSource</code> (the
easiest way to do so is through Spring Boot&#8217;s configuration conventions).  This
<code class="literal">DataSource</code> is automatically used by Spring Cloud Task for the repository.</p><p>If your application uses more than one <code class="literal">DataSource</code>, you need to configure the task
repository with the appropriate <code class="literal">DataSource</code>. This customization can be done through an
implementation of  <code class="literal">TaskConfigurer</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-table-prefix" href="#features-table-prefix"></a>8.2&nbsp;Table Prefix</h2></div></div></div><p>One modifiable property of <code class="literal">TaskRepository</code> is the table prefix for the task tables. By
default, they are all prefaced with <code class="literal">TASK_</code>. <code class="literal">TASK_EXECUTION</code> and <code class="literal">TASK_EXECUTION_PARAMS</code>
are two examples. However, there are potential reasons to modify this prefix. If the
schema name needs to be prepended to the table names or if more than one set of task
tables is needed within the same schema, you must change the table prefix. You can do so
by setting the <code class="literal">spring.cloud.task.tablePrefix</code> to the prefix you need, as follows:</p><p><code class="literal">spring.cloud.task.tablePrefix=yourPrefix</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-table-initialization" href="#features-table-initialization"></a>8.3&nbsp;Enable/Disable table initialization</h2></div></div></div><p>In cases where you are creating the task tables and do not wish for Spring Cloud Task to
create them at task startup, set the <code class="literal">spring.cloud.task.initialize.enable</code> property to
<code class="literal">false</code>, as follows:</p><p><code class="literal">spring.cloud.task.initialize.enable=false</code></p><p>It defaults to <code class="literal">true</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-generated_task_id" href="#features-generated_task_id"></a>8.4&nbsp;Externally Generated Task ID</h2></div></div></div><p>In some cases, you may want to allow for the time difference between when a task is
requested and when the infrastructure actually launches it. Spring Cloud Task lets you
create a <code class="literal">TaskExecution</code> when the task is requested. Then pass the execution ID of the
generated <code class="literal">TaskExecution</code> to the task so that it can update the <code class="literal">TaskExecution</code> through
the task&#8217;s lifecycle.</p><p>A <code class="literal">TaskExecution</code> can be created by calling the <code class="literal">createTaskExecution</code> method on an
implementation of the <code class="literal">TaskRepository</code> that references the datastore that holds
the <code class="literal">TaskExecution</code> objects.</p><p>In order to configure your Task to use a generated <code class="literal">TaskExecutionId</code>, add the
following property:</p><p><code class="literal">spring.cloud.task.executionid=yourtaskId</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-external_task_id" href="#features-external_task_id"></a>8.5&nbsp;External Task Id</h2></div></div></div><p>Spring Cloud Task lets you store an external task ID for each
<code class="literal">TaskExecution</code>. An example of this would be a task ID provided by
Cloud Foundry when a task is launched on the platform.
In order to configure your Task to use a generated <code class="literal">TaskExecutionId</code>, add the
following property:</p><p><code class="literal">spring.cloud.task.external-execution-id=&lt;externalTaskId&gt;</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-parent_task_id" href="#features-parent_task_id"></a>8.6&nbsp;Parent Task Id</h2></div></div></div><p>Spring Cloud Task lets you store a parent task ID for each <code class="literal">TaskExecution</code>. An example of
this would be a task that executes another task or tasks and you want to record which task
launched each of the child tasks. In order to configure your Task to set a parent
<code class="literal">TaskExecutionId</code> add the following property on the child task:</p><p><code class="literal">spring.cloud.task.parent-execution-id=&lt;parentExecutionTaskId&gt;</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-task-configurer" href="#features-task-configurer"></a>8.7&nbsp;TaskConfigurer</h2></div></div></div><p>The <code class="literal">TaskConfigurer</code> is a strategy interface that lets you customize the way components of
Spring Cloud Task are configured. By default, we provide the <code class="literal">DefaultTaskConfigurer</code> that
provides logical defaults: <code class="literal">Map</code>-based in-memory components (useful for development if no
<code class="literal">DataSource</code> is provided) and JDBC based components (useful if there is a <code class="literal">DataSource</code>
available).</p><p>The <code class="literal">TaskConfigurer</code> lets you configure three main components:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Component</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default (provided by <code class="literal">DefaultTaskConfigurer</code>)</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">TaskRepository</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The implementation of the <code class="literal">TaskRepository</code> to be used.</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SimpleTaskRepository</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">TaskExplorer</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The implementation of the <code class="literal">TaskExplorer</code> (a component for read-only access to the task
repository) to be used.</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SimpleTaskExplorer</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PlatformTransactionManager</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>A transaction manager to be used when running updates for tasks.</p></td><td style="" align="left" valign="top"><p><code class="literal">DataSourceTransactionManager</code> if a <code class="literal">DataSource</code> is used.
<code class="literal">ResourcelessTransactionManager</code> if it is not.</p></td></tr></tbody></table></div><p>You can customize any of the components described in the preceding table by creating a
custom implementation of the <code class="literal">TaskConfigurer</code> interface. Typically, extending the
<code class="literal">DefaultTaskConfigurer</code> (which is provided if a <code class="literal">TaskConfigurer</code> is not found) and
overriding the required getter is sufficient. However, implementing your own from scratch
may be required.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Users should not directly use getter methods from a <code class="literal">TaskConfigurer</code> directly
unless they are using it to supply implementations to be exposed as Spring Beans.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-task-name" href="#features-task-name"></a>8.8&nbsp;Task Name</h2></div></div></div><p>In most cases, the name of the task is the application name as configured in Spring
Boot. However, there are some cases where you may want to map the run of a task to a
different name. Spring Cloud Data Flow is an example of this (because you probably want
the task to be run with the name of the task definition). Because of this, we offer the
ability to customize how the task is named, through the <code class="literal">TaskNameResolver</code> interface.</p><p>By default, Spring Cloud Task provides the <code class="literal">SimpleTaskNameResolver</code>, which uses the
following options (in order of precedence):</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">A Spring Boot property (configured in any of the ways Spring Boot allows) called
<code class="literal">spring.cloud.task.name</code>.</li><li class="listitem">The application name as resolved using Spring Boot&#8217;s rules (obtained through
<code class="literal">ApplicationContext#getId</code>).</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="features-task-execution-listener" href="#features-task-execution-listener"></a>8.9&nbsp;Task Execution Listener</h2></div></div></div><p><code class="literal">TaskExecutionListener</code> lets you register listeners for specific events that occur during
the task lifecycle. To do so, create a class that implements the
<code class="literal">TaskExecutionListener</code> interface. The class that implements the <code class="literal">TaskExecutionListener</code>
interface is notified of the following events:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">onTaskStartup</code>: Prior to storing the <code class="literal">TaskExecution</code> into the <code class="literal">TaskRepository</code>.</li><li class="listitem"><code class="literal">onTaskEnd</code>: Prior to updating the <code class="literal">TaskExecution</code> entry in the <code class="literal">TaskRepository</code> and
marking the final state of the task.</li><li class="listitem"><code class="literal">onTaskFailed</code>: Prior to the <code class="literal">onTaskEnd</code> method being invoked when an unhandled
exception is thrown by the task.</li></ul></div><p>Spring Cloud Task also lets you add <code class="literal">TaskExecution</code> Listeners to methods within a bean
by using the following method annotations:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">@BeforeTask</code>: Prior to the storing the <code class="literal">TaskExecution</code> into the <code class="literal">TaskRepository</code></li><li class="listitem"><code class="literal">@AfterTask</code>: Prior to the updating of the <code class="literal">TaskExecution</code> entry in the <code class="literal">TaskRepository</code>
marking the final state of the task.</li><li class="listitem"><code class="literal">@FailedTask</code>: Prior to the <code class="literal">@AfterTask</code> method being invoked when an unhandled
exception is thrown by the task.</li></ul></div><p>The following example shows the three annotations in use:</p><pre class="programlisting"> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> MyBean {

	<em><span class="hl-annotation" style="color: gray">@BeforeTask</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> methodA(TaskExecution taskExecution) {
	}

	<em><span class="hl-annotation" style="color: gray">@AfterTask</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> methodB(TaskExecution taskExecution) {
	}

	<em><span class="hl-annotation" style="color: gray">@FailedTask</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> methodC(TaskExecution taskExecution, Throwable throwable) {
	}
}</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="features-task-execution-listener-Exceptions" href="#features-task-execution-listener-Exceptions"></a>8.9.1&nbsp;Exceptions Thrown by Task Execution Listener</h3></div></div></div><p>If an exception is thrown by a <code class="literal">TaskExecutionListener</code> event handler, all listener
processing for that event handler stops.  For example, if three <code class="literal">onTaskStartup</code> listeners
have started and the first <code class="literal">onTaskStartup</code> event handler throws an exception, the other
two <code class="literal">onTaskStartup</code> methods are not called. However, the other event handlers (<code class="literal">onTaskEnd</code>
and <code class="literal">onTaskFailed</code>) for the <code class="literal">TaskExecutionListeners</code> are called.</p><p>The exit code returned when a exception is thrown by a <code class="literal">TaskExecutionListener</code>
event handler is the exit code that was reported by the
<a class="link" href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/ExitCodeEvent.html" target="_top">ExitCodeEvent</a>.
If no <code class="literal">ExitCodeEvent</code> is emitted, the Exception thrown is evaluated to see
if it is of type
<a class="link" href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-application-exit" target="_top">ExitCodeGenerator</a>.
If so, it returns the exit code from  the <code class="literal">ExitCodeGenerator</code>. Otherwise, <code class="literal">1</code>
is returned.</p><p>In the case that an exception is thrown in an <code class="literal">onTaskStartup</code> method, the exit code for the application will be <code class="literal">1</code>.
If an exception is thrown in either a <code class="literal">onTaskEnd</code> or <code class="literal">onTaskFailed</code>
method, the exit code for the application will be the one established using the rules enumerated above.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>In the case of an exception being thrown in a <code class="literal">onTaskStartup</code>, <code class="literal">onTaskEnd</code>, or <code class="literal">onTaskFailed</code>
you can not override the exit code for the application using <code class="literal">ExitCodeExceptionMapper</code>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="features-task-execution-listener-exit-messages" href="#features-task-execution-listener-exit-messages"></a>8.9.2&nbsp;Exit Messages</h3></div></div></div><p>You can set the exit message for a task programmatically by using a
<code class="literal">TaskExecutionListener</code>. This is done by setting the <code class="literal">TaskExecution&#8217;s</code> <code class="literal">exitMessage</code>,
which then gets passed into the <code class="literal">TaskExecutionListener</code>. The following example shows
a method that is annotated with the <code class="literal">@AfterTask</code> <code class="literal">ExecutionListener</code> :</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@AfterTask</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> afterMe(TaskExecution taskExecution) {
    taskExecution.setExitMessage(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"AFTER EXIT MESSAGE"</span>);
}</pre><p>An <code class="literal">ExitMessage</code> can be set at any of the listener events (<code class="literal">onTaskStartup</code>,
<code class="literal">onTaskFailed</code>, and <code class="literal">onTaskEnd</code>). The order of precedence for the three listeners follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><code class="literal">onTaskEnd</code></li><li class="listitem"><code class="literal">onTaskFailed</code></li><li class="listitem"><code class="literal">onTaskStartup</code></li></ol></div><p>For example, if you set an <code class="literal">exitMessage</code> for the <code class="literal">onTaskStartup</code> and <code class="literal">onTaskFailed</code>
listeners and the task ends without failing, the <code class="literal">exitMessage</code> from the <code class="literal">onTaskStartup</code>
is stored in the repository. Otherwise, if a failure occurs, the <code class="literal">exitMessage</code> from
the <code class="literal">onTaskFailed</code> is stored. Also if you set the <code class="literal">exitMessage</code> with an
<code class="literal">onTaskEnd</code> listener, the <code class="literal">exitMessage</code> from the <code class="literal">onTaskEnd</code> supersedes
the exit messages from both the <code class="literal">onTaskStartup</code> and <code class="literal">onTaskFailed</code>.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_restricting_spring_cloud_task_instances" href="#_restricting_spring_cloud_task_instances"></a>8.10&nbsp;Restricting Spring Cloud Task Instances</h2></div></div></div><p>Spring Cloud Task lets you establish that only one task with a given task name can be run
at a time. To do so, you need to establish the <a class="link" href="#features-task-name" title="8.8&nbsp;Task Name">task name</a> and set
<code class="literal">spring.cloud.task.single-instance-enabled=true</code> for each task execution. While the first
task execution is running, any other time you try to run a task with the same
<a class="link" href="#features-task-name" title="8.8&nbsp;Task Name">task name</a> and`spring.cloud.task.single-instance-enabled=true`, the
task fails with the following error message: <code class="literal">Task with name "application" is already
running.</code> The default value for <code class="literal">spring.cloud.task.single-instance-enabled</code> is <code class="literal">false</code>. The
following example shows how to set <code class="literal">spring.cloud.task.single-instance-enabled</code> to <code class="literal">true</code>:</p><p><code class="literal">spring.cloud.task.single-instance-enabled=true or false</code></p><p>To use this feature, you must add the following Spring Integration dependencies to your
application:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-integration-core<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-integration-jdbc<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The exit code for the application will be 1 if the task fails because this feature
is enabled and another task is running with the same task name.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_disabling_spring_cloud_task_auto_configuration" href="#_disabling_spring_cloud_task_auto_configuration"></a>8.11&nbsp;Disabling Spring Cloud Task Auto Configuration</h2></div></div></div><p>In cases where Spring Cloud Task should not be auto configured for an implementation, you can disable Task&#8217;s auto configuration.
This can be done either by adding the following annotation to your Task application:</p><pre class="screen">@EnableAutoConfiguration(exclude={SimpleTaskAutoConfiguration.class})</pre><p>You may also disable Task auto configuration by setting the <code class="literal">spring.cloud.task.autoconfiguration.enabled</code> property to <code class="literal">false</code>.</p></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="batch" href="#batch"></a>Part&nbsp;IV.&nbsp;Batch</h1></div></div></div><div class="partintro"><div></div><p>This section goes into more detail about Spring Cloud Task&#8217;s integration with Spring
Batch. Tracking the association between a job execution and the task in which it was
executed as well as remote partitioning through Spring Cloud Deployer are covered in
this section.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="batch-association" href="#batch-association"></a>9.&nbsp;Associating a Job Execution to the Task in which It Was Executed</h2></div></div></div><p>Spring Boot provides facilities for the execution of batch jobs within an &uuml;ber-jar.
Spring Boot&#8217;s support of this functionality lets a developer execute multiple batch jobs
within that execution. Spring Cloud Task provides the ability to associate the execution
of a job (a job execution) with a task&#8217;s execution so that one can be traced back to the
other.</p><p>Spring Cloud Task achieves this functionality by using the <code class="literal">TaskBatchExecutionListener</code>.
By default,
this listener is auto configured in any context that has both a Spring Batch Job
configured (by having a bean of type <code class="literal">Job</code> defined in the context) and the
<code class="literal">spring-cloud-task-batch</code> jar on the classpath. The listener is injected into all jobs
that meet those conditions.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="batch-association-override" href="#batch-association-override"></a>9.1&nbsp;Overriding the TaskBatchExecutionListener</h2></div></div></div><p>To prevent the listener from being injected into any batch jobs within the current
context, you can disable the autoconfiguration by using standard Spring Boot mechanisms.</p><p>To only have the listener injected into particular jobs within the context, override the
<code class="literal">batchTaskExecutionListenerBeanPostProcessor</code> and provide a list of job bean IDs, as shown
in the following example:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> TaskBatchExecutionListenerBeanPostProcessor batchTaskExecutionListenerBeanPostProcessor() {
	TaskBatchExecutionListenerBeanPostProcessor postProcessor =
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> TaskBatchExecutionListenerBeanPostProcessor();

	postProcessor.setJobNames(Arrays.asList(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> String[] {<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"job1"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"job2"</span>}));

	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> postProcessor;
}</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>You can find a sample batch application in the samples module of the Spring Cloud
Task Project,
<a class="link" href="https://github.com/spring-cloud/spring-cloud-task/tree/master/spring-cloud-task-samples/batch-job" target="_top">here</a>.</p></td></tr></table></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="batch-partitioning" href="#batch-partitioning"></a>10.&nbsp;Remote Partitioning</h2></div></div></div><p>Spring Cloud Deployer provides facilities for launching Spring Boot-based applications on
most cloud infrastructures. The <code class="literal">DeployerPartitionHandler</code> and
<code class="literal">DeployerStepExecutionHandler</code> delegate the launching of worker step executions to Spring
Cloud Deployer.</p><p>To configure the <code class="literal">DeployerStepExecutionHandler</code>, you must provide a <code class="literal">Resource</code>
representing the Spring Boot &uuml;ber-jar to be executed, a <code class="literal">TaskLauncher</code>, and a
<code class="literal">JobExplorer</code>. You can configure any environment properties as well as the max number of
workers to be executing at once, the interval to poll for the results (defaults to 10
seconds), and a timeout (defaults to -1 or no timeout). The following example shows how
configuring this <code class="literal">PartitionHandler</code> might look:</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> PartitionHandler partitionHandler(TaskLauncher taskLauncher,
		JobExplorer jobExplorer) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {

	MavenProperties mavenProperties = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> MavenProperties();
	mavenProperties.setRemoteRepositories(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> HashMap&lt;&gt;(Collections.singletonMap(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"springRepo"</span>,
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> MavenProperties.RemoteRepository(repository))));

 	Resource resource =
		MavenResource.parse(String.format(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"%s:%s:%s"</span>,
				<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"io.spring.cloud"</span>,
				<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"partitioned-batch-job"</span>,
				<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"1.1.0.RELEASE"</span>), mavenProperties);

	DeployerPartitionHandler partitionHandler =
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> DeployerPartitionHandler(taskLauncher, jobExplorer, resource, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"workerStep"</span>);

	List&lt;String&gt; commandLineArgs = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> ArrayList&lt;&gt;(<span class="hl-number">3</span>);
	commandLineArgs.add(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"--spring.profiles.active=worker"</span>);
	commandLineArgs.add(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"--spring.cloud.task.initialize.enable=false"</span>);
	commandLineArgs.add(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"--spring.batch.initializer.enabled=false"</span>);

	partitionHandler.setCommandLineArgsProvider(
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> PassThroughCommandLineArgsProvider(commandLineArgs));
	partitionHandler.setEnvironmentVariablesProvider(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> NoOpEnvironmentVariablesProvider());
	partitionHandler.setMaxWorkers(<span class="hl-number">2</span>);
	partitionHandler.setApplicationName(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"PartitionedBatchJobTask"</span>);

	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> partitionHandler;
}</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>When passing environment variables to partitions, each partition may
be on a different machine with different environment settings.
Consequently, you should pass only those environment variables that are required.</p></td></tr></table></div><p>The <code class="literal">Resource</code> to be executed is expected to be a Spring Boot &uuml;ber-jar with a
<code class="literal">DeployerStepExecutionHandler</code> configured as a <code class="literal">CommandLineRunner</code> in the current context.
The repository enumerated in the preceding example should be the remote repository in
which the &uuml;ber-jar is located. Both the master and slave are expected to have visibility
into the same data store being used as the job repository and task repository. Once the
underlying infrastructure has bootstrapped the Spring Boot jar and Spring Boot has
launched the <code class="literal">DeployerStepExecutionHandler</code>, the step handler executes the requested
<code class="literal">Step</code>. The following example shows how to configure the <code class="literal">DefaultStepExecutionHandler</code>:</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> DeployerStepExecutionHandler stepExecutionHandler(JobExplorer jobExplorer) {
	DeployerStepExecutionHandler handler =
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> DeployerStepExecutionHandler(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.context, jobExplorer, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.jobRepository);

	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> handler;
}</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>You can find a sample remote partition application in the samples module of the
Spring Cloud Task project,
<a class="link" href="https://github.com/spring-cloud/spring-cloud-task/tree/master/spring-cloud-task-samples/partitioned-batch-job" target="_top">here</a>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_notes_on_developing_a_batch_partitioned_application_for_the_kubernetes_platform" href="#_notes_on_developing_a_batch_partitioned_application_for_the_kubernetes_platform"></a>10.1&nbsp;Notes on Developing a Batch-partitioned application for the Kubernetes Platform</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">When deploying partitioned apps on the Kubernetes platform, you must use the following
dependency for the Spring Cloud Kubernetes Deployer:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-starter-deployer-kubernetes<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre></li><li class="listitem">The application name for the task application and its partitions need to follow
the following regex pattern: <code class="literal">[a-z0-9]([-a-z0-9]*[a-z0-9])</code>.
Otherwise, an exception is thrown.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_notes_on_developing_a_batch_partitioned_application_for_the_cloud_foundry_platform" href="#_notes_on_developing_a_batch_partitioned_application_for_the_cloud_foundry_platform"></a>10.2&nbsp;Notes on Developing a Batch-partitioned Application for the Cloud Foundry Platform</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">When deploying partitioned apps on the Cloud Foundry platform, you must use the
following dependencies for the Spring Cloud Foundry Deployer:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-deployer-cloudfoundry<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>io.projectreactor<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>reactor-core<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>3.1.5.RELEASE<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>io.projectreactor.ipc<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>reactor-netty<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>0.7.5.RELEASE<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre></li><li class="listitem"><p class="simpara">When configuring the partition handler, Cloud Foundry Deployment
environment variables need to be established so that the partition handler
can start the partitions. The following list shows the required environment
variables:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_url</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_org</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_space</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_domain</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_username</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_password</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_services</code></li><li class="listitem"><code class="literal">spring_cloud_deployer_cloudfoundry_taskTimeout</code></li></ul></div></li></ul></div><p>An example set of deployment environment variables for a partitioned task that
uses a <code class="literal">mysql</code> database service might resemble the following:</p><pre class="programlisting">spring_cloud_deployer_cloudfoundry_url=https://api.local.pcfdev.io
spring_cloud_deployer_cloudfoundry_org=pcfdev-org
spring_cloud_deployer_cloudfoundry_space=pcfdev-space
spring_cloud_deployer_cloudfoundry_domain=local.pcfdev.io
spring_cloud_deployer_cloudfoundry_username=admin
spring_cloud_deployer_cloudfoundry_password=admin
spring_cloud_deployer_cloudfoundry_services=mysql
spring_cloud_deployer_cloudfoundry_taskTimeout=<span class="hl-number">300</span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>When using PCF-Dev, the following environment variable is also required:
<code class="literal">spring_cloud_deployer_cloudfoundry_skipSslValidation=true</code></p></td></tr></table></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="batch-informational-messages" href="#batch-informational-messages"></a>11.&nbsp;Batch Informational Messages</h2></div></div></div><p>Spring Cloud Task provides the ability for batch jobs to emit informational messages. The
&#8220;<a class="xref" href="#stream-integration-batch-events" title="15.&nbsp;Spring Batch Events">Chapter&nbsp;15, <i>Spring Batch Events</i></a>&#8221; section covers this feature in detail.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="batch-failures-and-tasks" href="#batch-failures-and-tasks"></a>12.&nbsp;Batch Job Exit Codes</h2></div></div></div><p>As discussed <a class="link" href="#features-lifecycle-exit-codes" title="7.2&nbsp;Mapping Exit Codes">earlier</a>, Spring Cloud Task
applications support the ability to record the exit code of a task execution. However, in
cases where you run a Spring Batch Job within a task, regardless of how the Batch Job
Execution completes, the result of the task is always zero when using the default
Batch/Boot behavior. Keep in mind that a task is a boot application and that the exit code
returned from the task is the same as a boot application.
To override this behavior and allow the task to return an exit code other than zero when a
batch job returns an
<a class="link" href="https://docs.spring.io/spring-batch/4.0.x/reference/html/step.html#batchStatusVsExitStatus" target="_top">BatchStatus</a>
of <code class="literal">FAILED</code>, set <code class="literal">spring.cloud.task.batch.fail-on-job-failure</code> to <code class="literal">true</code>. Then the exit code
can be 1 (the default) or be based on the
<a class="link" href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-spring-application.html#boot-features-application-exit" target="_top">specified
<code class="literal">ExitCodeGenerator</code></a>)</p><p>This functionality uses a new <code class="literal">CommandLineRunner</code> that replaces the one provided by Spring
Boot. By default, it is configured with the same order. However, if you want to customize
the order in which the <code class="literal">CommandLineRunner</code> is run, you can set its order by setting the
<code class="literal">spring.cloud.task.batch.commandLineRunnerOrder</code> property. To have your task return the
exit code based on the result of the batch job execution, you need to write your own
<code class="literal">CommandLineRunner</code>.</p></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="stream-integration" href="#stream-integration"></a>Part&nbsp;V.&nbsp;Spring Cloud Stream Integration</h1></div></div></div><div class="partintro"><div></div><p>A task by itself can be useful, but integration of a task into a larger ecosystem lets it
be useful for more complex processing and orchestration. This section
covers the integration options for Spring Cloud Task with Spring Cloud Stream.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="stream-integration-launching-sink" href="#stream-integration-launching-sink"></a>13.&nbsp;Launching a Task from a Spring Cloud Stream</h2></div></div></div><p>You can launch tasks from a stream. To do so, create a sink that listens for a message
that contains a <code class="literal">TaskLaunchRequest</code> as its payload. The <code class="literal">TaskLaunchRequest</code> contains:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">uri</code>: To the task artifact that is to be executed.</li><li class="listitem"><code class="literal">applicationName</code>: The name that is associated with the task. If no
applicationName is set, the <code class="literal">TaskLaunchRequest</code> generates a task name
comprised of the following: <code class="literal">Task-&lt;UUID&gt;</code>.</li><li class="listitem"><code class="literal">commandLineArguments</code>: A list containing the command line arguments for the task.</li><li class="listitem"><code class="literal">environmentProperties</code>: A map containing the environment variables to be used by the
task.</li><li class="listitem"><code class="literal">deploymentProperties</code>: A map containing the properties that are used by the deployer to
deploy the task.</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If the payload is of a different type, the sink throws an exception.</p></td></tr></table></div><p>For example, a stream can be created that has a processor that takes in data from an
HTTP source and creates a <code class="literal">GenericMessage</code> that contains the <code class="literal">TaskLaunchRequest</code> and sends
the message to its output channel. The task sink would then receive the message from its
input channnel and then launch the task.</p><p>To create a taskSink, you need only create a Spring Boot application that includes the
<code class="literal">EnableTaskLauncher</code> annotation, as shown in the following example:</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableTaskLauncher</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> TaskSinkApplication {
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">static</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> main(String[] args) {
		SpringApplication.run(TaskSinkApplication.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>, args);
	}
}</pre><p>The <a class="link" href="https://github.com/spring-cloud/spring-cloud-task/tree/master/spring-cloud-task-samples" target="_top">samples
module</a> of the Spring Cloud Task project contains a sample Sink and Processor. To install
these samples into your local maven repository, run a maven build from the
<code class="literal">spring-cloud-task-samples</code> directory with the <code class="literal">skipInstall</code> property set to <code class="literal">false</code>, as
shown in the following example:</p><p><code class="literal">mvn clean install</code></p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The <code class="literal">maven.remoteRepositories.springRepo.url</code> property must be set to the location
of the remote repository in which the &uuml;ber-jar is located. If not set, there is no remote
repository, so it relies upon the local repository only.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stream-integration-launching-sink-dataflow" href="#stream-integration-launching-sink-dataflow"></a>13.1&nbsp;Spring Cloud Data Flow</h2></div></div></div><p>To create a stream in Spring Cloud Data Flow, you must first register the Task Sink
Application we created. In the following example, we are registering the Processor and
Sink sample applications by using the Spring Cloud Data Flow shell:</p><pre class="programlisting">app register --name taskSink --<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">type</span> sink --uri maven://io.spring.cloud:tasksink:&lt;version&gt;
app register --name taskProcessor --<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">type</span> processor --uri maven:io.spring.cloud:taskprocessor:&lt;version&gt;</pre><p>The following example shows how to create a stream from the Spring Cloud Data Flow shell:</p><pre class="programlisting">stream create foo --definition <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http --server.port=9000|taskProcessor|taskSink"</span> --deploy</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="stream-integration-events" href="#stream-integration-events"></a>14.&nbsp;Spring Cloud Task Events</h2></div></div></div><p>Spring Cloud Task provides the ability to emit events through a Spring Cloud Stream
channel when the task is run through a Spring Cloud Stream channel. A task listener is
used to publish the <code class="literal">TaskExecution</code> on a message channel named <code class="literal">task-events</code>. This feature
is autowired into any task that has <code class="literal">spring-cloud-stream</code>, <code class="literal">spring-cloud-stream-&lt;binder&gt;</code>,
and a defined task on its classpath.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>To disable the event emitting listener, set the <code class="literal">spring.cloud.task.events.enabled</code>
property to <code class="literal">false</code>.</p></td></tr></table></div><p>With the appropriate classpath defined, the following task emits the <code class="literal">TaskExecution</code> as an
event on the <code class="literal">task-events</code> channel (at both the start and the end of the task):</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> TaskEventsApplication {

	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">static</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> main(String[] args) {
		SpringApplication.run(TaskEventsApplication.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>, args);
	}

	<em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">static</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> TaskConfiguration {

		<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> CommandLineRunner commandLineRunner() {
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> CommandLineRunner() {
				<em><span class="hl-annotation" style="color: gray">@Override</span></em>
				<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> run(String... args) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {
					System.out.println(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"The CommandLineRunner was executed"</span>);
				}
			};
		}
	}
}</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>A binder implementation is also required to be on the classpath.</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>A sample task event application can be found in the samples module
of the Spring Cloud Task Project,
<a class="link" href="https://github.com/spring-cloud/spring-cloud-task/tree/master/spring-cloud-task-samples/task-events" target="_top">here</a>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stream-integration-disable-task-events" href="#stream-integration-disable-task-events"></a>14.1&nbsp;Disabling Specific Task Events</h2></div></div></div><p>To disable task events, you can set the <code class="literal">spring.cloud.task.events.enabled</code> property to
<code class="literal">false</code>.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="stream-integration-batch-events" href="#stream-integration-batch-events"></a>15.&nbsp;Spring Batch Events</h2></div></div></div><p>When executing a Spring Batch job through a task, Spring Cloud Task can be configured to
emit informational messages based on the Spring Batch listeners available in Spring Batch.
Specifically, the following Spring Batch listeners are autoconfigured into each batch job
and emit messages on the associated Spring Cloud Stream channels when run through Spring
Cloud Task:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">JobExecutionListener</code> listens for <code class="literal">job-execution-events</code></li><li class="listitem"><code class="literal">StepExecutionListener</code> listens for <code class="literal">step-execution-events</code></li><li class="listitem"><code class="literal">ChunkListener</code> listens for <code class="literal">chunk-events</code></li><li class="listitem"><code class="literal">ItemReadListener</code> listens for <code class="literal">item-read-events</code></li><li class="listitem"><code class="literal">ItemProcessListener</code> listens for <code class="literal">item-process-events</code></li><li class="listitem"><code class="literal">ItemWriteListener</code> listens for <code class="literal">item-write-events</code></li><li class="listitem"><code class="literal">SkipListener</code> listens for <code class="literal">skip-events</code></li></ul></div><p>These listeners are autoconfigured into any <code class="literal">AbstractJob</code> when the appropriate
beans (a <code class="literal">Job</code> and a <code class="literal">TaskLifecycleListener</code>) exist in the context. Configuration to
listen to these events is handled the same way binding to any other Spring
Cloud Stream channel is done.  Our task (the one running the batch job) serves as a
<code class="literal">Source</code>, with the listening applications serving as either a <code class="literal">Processor</code> or a <code class="literal">Sink</code>.</p><p>An example could be to have an application listening to the <code class="literal">job-execution-events</code> channel
for the start and stop of a job. To configure the listening application, you would
configure the input to be <code class="literal">job-execution-events</code> as follows:</p><p><code class="literal">spring.cloud.stream.bindings.input.destination=job-execution-events</code></p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>A binder implementation is also required to be on the classpath.</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>A sample batch event application can be found in the samples module
of the Spring Cloud Task Project,
<a class="link" href="https://github.com/spring-cloud/spring-cloud-task/tree/master/spring-cloud-task-samples/batch-events" target="_top">here</a>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_sending_batch_events_to_different_channels" href="#_sending_batch_events_to_different_channels"></a>15.1&nbsp;Sending Batch Events to Different Channels</h2></div></div></div><p>One of the options that Spring Cloud Task offers for batch events is the ability to alter
the channel to which a specific listener can emit its messages. To do so, use the
following configuration:
<code class="literal">spring.cloud.stream.bindings.&lt;the channel&gt;.destination=&lt;new destination&gt;</code>. For example,
if <code class="literal">StepExecutionListener</code> needs to emit its messages to another channel called
<code class="literal">my-step-execution-events</code> instead of the default <code class="literal">step-execution-events</code>, you can add the
following configuration:</p><p><code class="literal">spring.cloud.stream.bindings.step-execution-events.destination=my-step-execution-events</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_disabling_batch_events" href="#_disabling_batch_events"></a>15.2&nbsp;Disabling Batch Events</h2></div></div></div><p>To disable the listener functionality for all batch events, use the following
configuration:</p><p><code class="literal">spring.cloud.task.batch.events.enabled=false</code></p><p>To disable a specific batch event, use the following configuration:</p><p><code class="literal">spring.cloud.task.batch.events.&lt;batch event listener&gt;.enabled=false</code>:</p><p>The following listing shows individual listeners that you can disable:</p><pre class="programlisting">spring.cloud.task.batch.events.job-execution.enabled=false
spring.cloud.task.batch.events.step-execution.enabled=false
spring.cloud.task.batch.events.chunk.enabled=false
spring.cloud.task.batch.events.item-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">read</span>.enabled=false
spring.cloud.task.batch.events.item-process.enabled=false
spring.cloud.task.batch.events.item-write.enabled=false
spring.cloud.task.batch.events.skip.enabled=false</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_emit_order_for_batch_events" href="#_emit_order_for_batch_events"></a>15.3&nbsp;Emit Order for Batch Events</h2></div></div></div><p>By default, batch events have <code class="literal">Ordered.LOWEST_PRECEDENCE</code>. To change this value (for
example, to 5 ), use the following configuration:</p><pre class="programlisting">spring.cloud.task.batch.events.job-execution-order=<span class="hl-number">5</span>
spring.cloud.task.batch.events.step-execution-order=<span class="hl-number">5</span>
spring.cloud.task.batch.events.chunk-order=<span class="hl-number">5</span>
spring.cloud.task.batch.events.item-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">read</span>-order=<span class="hl-number">5</span>
spring.cloud.task.batch.events.item-process-order=<span class="hl-number">5</span>
spring.cloud.task.batch.events.item-write-order=<span class="hl-number">5</span>
spring.cloud.task.batch.events.skip-order=<span class="hl-number">5</span></pre></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="appendix" href="#appendix"></a>Part&nbsp;VI.&nbsp;Appendices</h1></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-task-repository-schema" href="#appendix-task-repository-schema"></a>16.&nbsp;Task Repository Schema</h2></div></div></div><p>This appendix provides an ERD for the database schema used in the task repository.</p><div class="informalfigure"><div class="mediaobject"><img src="images/task_schema.png" alt="task schema"></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-building-the-documentation" href="#appendix-building-the-documentation"></a>17.&nbsp;Building This Documentation</h2></div></div></div><p>This project uses Maven to generate this documentation. To generate it for yourself,
run the following command: <code class="literal">$ ./mvnw clean package -P full</code>.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-cloud-foundry" href="#appendix-cloud-foundry"></a>18.&nbsp;Running a Task App on Cloud Foundry</h2></div></div></div><p>The simplest way to launch a Spring Cloud Task application as a task on Cloud Foundry
is to use Spring Cloud Data Flow.  Via Spring Cloud Data Flow you can register your task application,
create a definition for it and then launch it.  You then can track the task execution(s)
via a RESTful API, the Spring Cloud Data Flow Shell, or the UI.  To learn out to get started installing Data Flow
follow the instructions in the
<a class="link" href="https://docs.spring.io/spring-cloud-dataflow/docs/current/reference/htmlsingle/#getting-started" target="_top">Getting Started</a>
section of the reference documentation.  For info on how to register and launch tasks, see the <a class="link" href="https://docs.spring.io/spring-cloud-dataflow/docs/current/reference/htmlsingle/#_the_lifecycle_of_a_task" target="_top">Lifecycle of a Task</a> documentation.</p></div></div></div></body></html>