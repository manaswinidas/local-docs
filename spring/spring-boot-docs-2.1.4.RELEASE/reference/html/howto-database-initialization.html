<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>85.&nbsp;Database Initialization</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Spring Boot Reference Guide"><link rel="up" href="howto.html" title="Part&nbsp;IX.&nbsp;&#8216;How-to&#8217; guides"><link rel="prev" href="howto-data-access.html" title="84.&nbsp;Data Access"><link rel="next" href="howto-messaging.html" title="86.&nbsp;Messaging"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">85.&nbsp;Database Initialization</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="howto-data-access.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;IX.&nbsp;&#8216;How-to&#8217; guides</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="howto-messaging.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="howto-database-initialization" href="#howto-database-initialization"></a>85.&nbsp;Database Initialization</h2></div></div></div><p>An SQL database can be initialized in different ways depending on what your stack is.
Of course, you can also do it manually, provided the database is a separate process.
It is recommended to use a single mechanism for schema generation.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="howto-initialize-a-database-using-jpa" href="#howto-initialize-a-database-using-jpa"></a>85.1&nbsp;Initialize a Database Using JPA</h2></div></div></div><p>JPA has features for DDL generation, and these can be set up to run on startup against the
database. This is controlled through two external properties:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">spring.jpa.generate-ddl</code> (boolean) switches the feature on and off and is vendor
independent.</li><li class="listitem"><code class="literal">spring.jpa.hibernate.ddl-auto</code> (enum) is a Hibernate feature that controls the
behavior in a more fine-grained way. This feature is described in more detail later in
this guide.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="howto-initialize-a-database-using-hibernate" href="#howto-initialize-a-database-using-hibernate"></a>85.2&nbsp;Initialize a Database Using Hibernate</h2></div></div></div><p>You can set <code class="literal">spring.jpa.hibernate.ddl-auto</code> explicitly and the standard Hibernate property
values are <code class="literal">none</code>, <code class="literal">validate</code>, <code class="literal">update</code>, <code class="literal">create</code>, and <code class="literal">create-drop</code>. Spring Boot chooses
a default value for you based on whether it thinks your database is embedded. It defaults
to <code class="literal">create-drop</code> if no schema manager has been detected or <code class="literal">none</code> in all other cases. An
embedded database is detected by looking at the <code class="literal">Connection</code> type. <code class="literal">hsqldb</code>, <code class="literal">h2</code>, and
<code class="literal">derby</code> are embedded, and others are not. Be careful when switching from in-memory to a
&#8216;real&#8217; database that you do not make assumptions about the existence of the tables and
data in the new platform. You either have to set <code class="literal">ddl-auto</code> explicitly or use one of the
other mechanisms to initialize the database.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>You can output the schema creation by enabling the <code class="literal">org.hibernate.SQL</code> logger. This
is done for you automatically if you enable the
<a class="link" href="boot-features-logging.html#boot-features-logging-console-output" title="26.2&nbsp;Console Output">debug mode</a>.</p></td></tr></table></div><p>In addition, a file named <code class="literal">import.sql</code> in the root of the classpath is executed on
startup if Hibernate creates the schema from scratch (that is, if the <code class="literal">ddl-auto</code> property
is set to <code class="literal">create</code> or <code class="literal">create-drop</code>). This can be useful for demos and for testing if you
are careful but is probably not something you want to be on the classpath in production.
It is a Hibernate feature (and has nothing to do with Spring).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="howto-initialize-a-database-using-spring-jdbc" href="#howto-initialize-a-database-using-spring-jdbc"></a>85.3&nbsp;Initialize a Database</h2></div></div></div><p>Spring Boot can automatically create the schema (DDL scripts) of your <code class="literal">DataSource</code> and
initialize it (DML scripts). It loads SQL from the standard root classpath locations:
<code class="literal">schema.sql</code> and <code class="literal">data.sql</code>, respectively. In addition, Spring Boot processes the
<code class="literal">schema-${platform}.sql</code> and <code class="literal">data-${platform}.sql</code> files (if present), where <code class="literal">platform</code>
is the value of <code class="literal">spring.datasource.platform</code>. This allows you to switch to
database-specific scripts if necessary. For example, you might choose to set it to the
vendor name of the database (<code class="literal">hsqldb</code>, <code class="literal">h2</code>, <code class="literal">oracle</code>, <code class="literal">mysql</code>, <code class="literal">postgresql</code>, and so on).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Spring Boot automatically creates the schema of an embedded <code class="literal">DataSource</code>. This behaviour
can be customized by using the <code class="literal">spring.datasource.initialization-mode</code> property. For
instance, if you want to always initialize the <code class="literal">DataSource</code> regardless of its type:</p><pre class="screen">spring.datasource.initialization-mode=always</pre></td></tr></table></div><p>By default, Spring Boot enables the fail-fast feature of the Spring JDBC initializer. This
means that, if the scripts cause exceptions, the application fails to start. You can tune
that behavior by setting <code class="literal">spring.datasource.continue-on-error</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>In a JPA-based app, you can choose to let Hibernate create the schema or use
<code class="literal">schema.sql</code>, but you cannot do both. Make sure to disable
<code class="literal">spring.jpa.hibernate.ddl-auto</code> if you use <code class="literal">schema.sql</code>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="howto-initialize-a-spring-batch-database" href="#howto-initialize-a-spring-batch-database"></a>85.4&nbsp;Initialize a Spring Batch Database</h2></div></div></div><p>If you use Spring Batch, it comes pre-packaged with SQL initialization scripts for most
popular database platforms. Spring Boot can detect your database type and execute those
scripts on startup. If you use an embedded database, this happens by default. You can also
enable it for any database type, as shown in the following example:</p><pre class="screen">spring.batch.initialize-schema=always</pre><p>You can also switch off the initialization explicitly by setting
<code class="literal">spring.batch.initialize-schema=never</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="howto-use-a-higher-level-database-migration-tool" href="#howto-use-a-higher-level-database-migration-tool"></a>85.5&nbsp;Use a Higher-level Database Migration Tool</h2></div></div></div><p>Spring Boot supports two higher-level migration tools: <a class="link" href="https://flywaydb.org/" target="_top">Flyway</a>
and <a class="link" href="https://www.liquibase.org/" target="_top">Liquibase</a>.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="howto-execute-flyway-database-migrations-on-startup" href="#howto-execute-flyway-database-migrations-on-startup"></a>85.5.1&nbsp;Execute Flyway Database Migrations on Startup</h3></div></div></div><p>To automatically run Flyway database migrations on startup, add the
<code class="literal">org.flywaydb:flyway-core</code> to your classpath.</p><p>The migrations are scripts in the form <code class="literal">V&lt;VERSION&gt;__&lt;NAME&gt;.sql</code> (with <code class="literal">&lt;VERSION&gt;</code> an
underscore-separated version, such as &#8216;1&#8217; or &#8216;2_1&#8217;). By default, they are in a folder
called <code class="literal">classpath:db/migration</code>, but you can modify that location by setting
<code class="literal">spring.flyway.locations</code>. This is a comma-separated list of one or more <code class="literal">classpath:</code>
or <code class="literal">filesystem:</code> locations. For example, the following configuration would search for
scripts in both the default classpath location and the <code class="literal">/opt/migration</code> directory:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">spring.flyway.locations</span>=classpath:db/migration,filesystem:/opt/migration</pre><p>You can also add a special <code class="literal">{vendor}</code> placeholder to use vendor-specific scripts. Assume
the following:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">spring.flyway.locations</span>=classpath:db/migration/{vendor}</pre><p>Rather than using <code class="literal">db/migration</code>, the preceding configuration sets the folder to use
according to the type of the database (such as <code class="literal">db/migration/mysql</code> for MySQL). The list
of supported databases is available in
<a class="link" href="https://github.com/spring-projects/spring-boot/tree/v2.1.4.RELEASE/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/jdbc/DatabaseDriver.java" target="_top"><code class="literal">DatabaseDriver</code></a>.</p><p><a class="link" href="https://github.com/spring-projects/spring-boot/tree/v2.1.4.RELEASE/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/flyway/FlywayProperties.java" target="_top"><code class="literal">FlywayProperties</code></a>
provides most of Flyway&#8217;s settings and a small set of additional properties that can be
used to disable the migrations or switch off the location checking. If you need more
control over the configuration, consider registering a <code class="literal">FlywayConfigurationCustomizer</code>
bean.</p><p>Spring Boot calls <code class="literal">Flyway.migrate()</code> to perform the database migration. If you would like
more control, provide a <code class="literal">@Bean</code> that implements
<a class="link" href="https://github.com/spring-projects/spring-boot/tree/v2.1.4.RELEASE/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/flyway/FlywayMigrationStrategy.java" target="_top"><code class="literal">FlywayMigrationStrategy</code></a>.</p><p>Flyway supports SQL and Java <a class="link" href="https://flywaydb.org/documentation/callbacks.html" target="_top">callbacks</a>.
To use SQL-based callbacks, place the callback scripts in the <code class="literal">classpath:db/migration</code>
folder. To use Java-based callbacks, create one or more beans that implement
<code class="literal">Callback</code>. Any such beans are automatically registered with <code class="literal">Flyway</code>. They can be
ordered by using <code class="literal">@Order</code> or by implementing <code class="literal">Ordered</code>. Beans that implement the
deprecated <code class="literal">FlywayCallback</code> interface can also be detected, however they cannot be used
alongside <code class="literal">Callback</code> beans.</p><p>By default, Flyway autowires the (<code class="literal">@Primary</code>) <code class="literal">DataSource</code> in your context and
uses that for migrations. If you like to use a different <code class="literal">DataSource</code>, you can create
one and mark its <code class="literal">@Bean</code> as <code class="literal">@FlywayDataSource</code>. If you do so and want two data sources,
remember to create another one and mark it as <code class="literal">@Primary</code>. Alternatively, you can use
Flyway&#8217;s native <code class="literal">DataSource</code> by setting <code class="literal">spring.flyway.[url,user,password]</code>
in external properties. Setting either <code class="literal">spring.flyway.url</code> or <code class="literal">spring.flyway.user</code>
is sufficient to cause Flyway to use its own <code class="literal">DataSource</code>. If any of the three
properties has not be set, the value of its equivalent <code class="literal">spring.datasource</code> property will
be used.</p><p>There is a <a class="link" href="https://github.com/spring-projects/spring-boot/tree/v2.1.4.RELEASE/spring-boot-samples/spring-boot-sample-flyway" target="_top">Flyway sample</a> so
that you can see how to set things up.</p><p>You can also use Flyway to provide data for specific scenarios. For example, you can
place test-specific migrations in <code class="literal">src/test/resources</code> and they are run only when your
application starts for testing. Also, you can use profile-specific configuration to
customize <code class="literal">spring.flyway.locations</code> so that certain migrations run only when a particular
profile is active. For example, in <code class="literal">application-dev.properties</code>, you might specify the
following setting:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">spring.flyway.locations</span>=classpath:/db/migration,classpath:/dev/db/migration</pre><p>With that setup, migrations in <code class="literal">dev/db/migration</code> run only when the <code class="literal">dev</code> profile is
active.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="howto-execute-liquibase-database-migrations-on-startup" href="#howto-execute-liquibase-database-migrations-on-startup"></a>85.5.2&nbsp;Execute Liquibase Database Migrations on Startup</h3></div></div></div><p>To automatically run Liquibase database migrations on startup, add the
<code class="literal">org.liquibase:liquibase-core</code> to your classpath.</p><p>By default, the master change log is read from <code class="literal">db/changelog/db.changelog-master.yaml</code>,
but you can change the location by setting <code class="literal">spring.liquibase.change-log</code>. In addition to
YAML, Liquibase also supports JSON, XML, and SQL change log formats.</p><p>By default, Liquibase autowires the (<code class="literal">@Primary</code>) <code class="literal">DataSource</code> in your context and uses
that for migrations. If you need to use a different <code class="literal">DataSource</code>, you can create one and
mark its <code class="literal">@Bean</code> as <code class="literal">@LiquibaseDataSource</code>. If you do so and you want two data sources,
remember to create another one and mark it as <code class="literal">@Primary</code>. Alternatively, you can use
Liquibase&#8217;s native <code class="literal">DataSource</code> by setting <code class="literal">spring.liquibase.[url,user,password]</code> in
external properties. Setting either <code class="literal">spring.liquibase.url</code> or <code class="literal">spring.liquibase.user</code>
is sufficient to cause Liquibase to use its own <code class="literal">DataSource</code>. If any of the three
properties has not be set, the value of its equivalent <code class="literal">spring.datasource</code> property will
be used.</p><p>See
<a class="link" href="https://github.com/spring-projects/spring-boot/tree/v2.1.4.RELEASE/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/liquibase/LiquibaseProperties.java" target="_top"><code class="literal">LiquibaseProperties</code></a>
for details about available settings such as contexts, the default schema, and others.</p><p>There is a <a class="link" href="https://github.com/spring-projects/spring-boot/tree/v2.1.4.RELEASE/spring-boot-samples/spring-boot-sample-liquibase" target="_top">Liquibase
sample</a> so that you can see how to set things up.</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="howto-data-access.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="howto.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="howto-messaging.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">84.&nbsp;Data Access&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;86.&nbsp;Messaging</td></tr></table></div></body></html>