<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;13.&nbsp;Adding Security</title><link rel="stylesheet" href="css/html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.73.2"><link rel="start" href="index.html" title="Good Relationships"><link rel="up" href="tutorial.html" title="Part&nbsp;I.&nbsp;Tutorial"><link rel="prev" href="tutorial_social.html" title="Chapter&nbsp;12.&nbsp;Adding social"><link rel="next" href="tutorial_user-experience.html" title="Chapter&nbsp;14.&nbsp;More UI"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div xmlns:fo="http://www.w3.org/1999/XSL/Format" style="background-color:white;border:none;height:73px;border:1px solid black;"><a style="border:none;" href="http://static.springframework.org/spring-ws/site/" title="The Spring Framework - Spring Web Services"><img style="border:none;" src="images/xdev-spring_logo.jpg"></a><a style="border:none;" href="http://www.springsource.com/" title="SpringSource"><img style="border:none;position:absolute;padding-top:5px;right:42px;" src="images/s2_box_logo.png"></a></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="tutorial_security"></a>Chapter&nbsp;13.&nbsp;Adding Security</h2></div><div><h3 class="subtitle"><i>Protecting assets</i></h3></div></div></div><p>
        To have a user in the webapp we had to put it in the session and add login and registration
        pages. Of course the pages that were only meant for logged-in users had to be secured as well.
    </p><p>
        Being Spring users, we naturally used Spring Security for this. We wrote  a simple UserDetailsService
        that used a repository for looking up the users and validating their credentials. The config is located
        in a separate applicationContext-security.xml. But first, as always, Maven and web.xml setup.
    </p><p>
        </p><div class="example"><a name="d0e696"></a><p class="title"><b>Example&nbsp;13.1.&nbsp;Spring Security pom.xml</b></p><div class="example-contents"><pre class="programlisting">&lt;<span class="hl-tag">dependency</span>&gt;
    &lt;<span class="hl-tag">groupId</span>&gt;org.springframework.security&lt;<span class="hl-tag">/groupId</span>&gt;
    &lt;<span class="hl-tag">artifactId</span>&gt;spring-security-web&lt;<span class="hl-tag">/artifactId</span>&gt;
    &lt;<span class="hl-tag">version</span>&gt;${spring.version}&lt;<span class="hl-tag">/version</span>&gt;
&lt;<span class="hl-tag">/dependency</span>&gt;
&lt;<span class="hl-tag">dependency</span>&gt;
    &lt;<span class="hl-tag">groupId</span>&gt;org.springframework.security&lt;<span class="hl-tag">/groupId</span>&gt;
    &lt;<span class="hl-tag">artifactId</span>&gt;spring-security-config&lt;<span class="hl-tag">/artifactId</span>&gt;
    &lt;<span class="hl-tag">version</span>&gt;${spring.version}&lt;<span class="hl-tag">/version</span>&gt;
&lt;<span class="hl-tag">/dependency</span>&gt;
</pre></div></div><p><br class="example-break">
    </p><p>
        </p><div class="example"><a name="d0e704"></a><p class="title"><b>Example&nbsp;13.2.&nbsp;Spring Security web.xml</b></p><div class="example-contents"><pre class="programlisting">&lt;<span class="hl-tag">context-param</span>&gt;
    &lt;<span class="hl-tag">param-name</span>&gt;contextConfigLocation&lt;<span class="hl-tag">/param-name</span>&gt;
    &lt;<span class="hl-tag">param-value</span>&gt;
        /WEB-INF/applicationContext-security.xml
        /WEB-INF/applicationContext.xml
    &lt;<span class="hl-tag">/param-value</span>&gt;
&lt;<span class="hl-tag">/context-param</span>&gt;

&lt;<span class="hl-tag">listener</span>&gt;
    &lt;<span class="hl-tag">listener-class</span>&gt;org.springframework.web.context.ContextLoaderListener&lt;<span class="hl-tag">/listener-class</span>&gt;
&lt;<span class="hl-tag">/listener</span>&gt;

&lt;<span class="hl-tag">filter</span>&gt;
    &lt;<span class="hl-tag">filter-name</span>&gt;springSecurityFilterChain&lt;<span class="hl-tag">/filter-name</span>&gt;
    &lt;<span class="hl-tag">filter-class</span>&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;<span class="hl-tag">/filter-class</span>&gt;
&lt;<span class="hl-tag">/filter</span>&gt;

&lt;<span class="hl-tag">filter-mapping</span>&gt;
    &lt;<span class="hl-tag">filter-name</span>&gt;springSecurityFilterChain&lt;<span class="hl-tag">/filter-name</span>&gt;
    &lt;<span class="hl-tag">url-pattern</span>&gt;/*&lt;<span class="hl-tag">/url-pattern</span>&gt;
&lt;<span class="hl-tag">/filter-mapping</span>&gt;
</pre></div></div><p><br class="example-break">
    </p><p>
        </p><div class="example"><a name="d0e712"></a><p class="title"><b>Example&nbsp;13.3.&nbsp;Spring Security applicationContext-security.xml</b></p><div class="example-contents"><pre class="programlisting">&lt;<span class="hl-tag">security:global-method-security</span> <span class="hl-attribute">secured-annotations</span>=<span class="hl-value">"enabled"</span>&gt;
&lt;<span class="hl-tag">/security:global-method-security</span>&gt;

&lt;<span class="hl-tag">security:http</span> <span class="hl-attribute">auto-config</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">access-denied-page</span>=<span class="hl-value">"/auth/denied"</span>&gt; &lt;<span class="hl-comment">!-- use-expressions="true" --</span>&gt;
    &lt;<span class="hl-tag">security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/admin/*"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_ADMIN"</span>/&gt;
    &lt;<span class="hl-tag">security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/import/*"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_ADMIN"</span>/&gt;
    &lt;<span class="hl-tag">security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/user/*"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_USER"</span>/&gt;
    &lt;<span class="hl-tag">security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/auth/login"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"IS_AUTHENTICATED_ANONYMOUSLY"</span>/&gt;
    &lt;<span class="hl-tag">security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/auth/register"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"IS_AUTHENTICATED_ANONYMOUSLY"</span>/&gt;
    &lt;<span class="hl-tag">security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"IS_AUTHENTICATED_ANONYMOUSLY"</span>/&gt;
    &lt;<span class="hl-tag">security:form-login</span> <span class="hl-attribute">login-page</span>=<span class="hl-value">"/auth/login"</span> <span class="hl-attribute">authentication-failure-url</span>=<span class="hl-value">"/auth/login?login_error=true"</span>
    <span class="hl-attribute">default-target-url</span>=<span class="hl-value">"/user"</span>/&gt;
    &lt;<span class="hl-tag">security:logout</span> <span class="hl-attribute">logout-url</span>=<span class="hl-value">"/auth/logout"</span> <span class="hl-attribute">logout-success-url</span>=<span class="hl-value">"/"</span> <span class="hl-attribute">invalidate-session</span>=<span class="hl-value">"true"</span>/&gt;
&lt;<span class="hl-tag">/security:http</span>&gt;

&lt;<span class="hl-tag">security:authentication-manager</span>&gt;
    &lt;<span class="hl-tag">security:authentication-provider</span> <span class="hl-attribute">user-service-ref</span>=<span class="hl-value">"userDetailsService"</span>&gt;
        &lt;<span class="hl-tag">security:password-encoder</span> <span class="hl-attribute">hash</span>=<span class="hl-value">"md5"</span>&gt;
            &lt;<span class="hl-tag">security:salt-source</span> <span class="hl-attribute">system-wide</span>=<span class="hl-value">"cewuiqwzie"</span>/&gt;
        &lt;<span class="hl-tag">/security:password-encoder</span>&gt;
    &lt;<span class="hl-tag">/security:authentication-provider</span>&gt;
&lt;<span class="hl-tag">/security:authentication-manager</span>&gt;

&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userDetailsService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.neo4j.movies.service.CineastsUserDetailsService"</span>/&gt;
</pre></div></div><p><br class="example-break">
        </p><div class="example"><a name="d0e718"></a><p class="title"><b>Example&nbsp;13.4.&nbsp;UserDetailsService and UserDetails implementation</b></p><div class="example-contents"><pre class="programlisting">@Service
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CineastsUserDetailsService <span class="hl-keyword">implements</span> UserDetailsService, InitializingBean {

    @Autowired <span class="hl-keyword">private</span> UserRepository userRepository;

    @Override
    <span class="hl-keyword">public</span> UserDetails loadUserByUsername(String login)
                                <span class="hl-keyword">throws</span> UsernameNotFoundException, DataAccessException {
        <span class="hl-keyword">final</span> User user = findUser(login);
        <span class="hl-keyword">if</span> (user==null) <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> UsernameNotFoundException(<span class="hl-string">"Username not found"</span>,login);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CineastsUserDetails(user);
    }

    <span class="hl-keyword">public</span> User findUser(String login) {
        <span class="hl-keyword">return</span> userRepository.findByPropertyValue(<span class="hl-string">"login"</span>,login);
    }
    <span class="hl-keyword">public</span> User getUserFromSession() {
        SecurityContext context = SecurityContextHolder.getContext();
        Authentication authentication = context.getAuthentication();
        Object principal = authentication.getPrincipal();
        <span class="hl-keyword">if</span> (principal <span class="hl-keyword">instanceof</span> CineastsUserDetails) {
            CineastsUserDetails userDetails = (CineastsUserDetails) principal;
            <span class="hl-keyword">return</span> userDetails.getUser();
        }
        <span class="hl-keyword">return</span> null;
    }
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CineastsUserDetails <span class="hl-keyword">implements</span> UserDetails {
    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> User user;

    <span class="hl-keyword">public</span> CineastsUserDetails(User user) {
        <span class="hl-keyword">this</span>.user = user;
    }

    @Override
    <span class="hl-keyword">public</span> Collection&lt;GrantedAuthority&gt; getAuthorities() {
        User.Roles[] roles = user.getRoles();
        <span class="hl-keyword">if</span> (roles ==null) <span class="hl-keyword">return</span> Collections.emptyList();
        <span class="hl-keyword">return</span> Arrays.&lt;GrantedAuthority&gt;asList(roles);
    }

    @Override
    <span class="hl-keyword">public</span> String getPassword() {
        <span class="hl-keyword">return</span> user.getPassword();
    }

    @Override
    <span class="hl-keyword">public</span> String getUsername() {
        <span class="hl-keyword">return</span> user.getLogin();
    }

    ...
    <span class="hl-keyword">public</span> User getUser() {
        <span class="hl-keyword">return</span> user;
    }
}
</pre></div></div><p><br class="example-break">
    </p><p>
        Any logged-in user was now available in the session, and could be used for all the social
        interactions. The remaining work for this was mainly adding controller methods and JSPs
        for the views. We used the helper method <code class="code">getUserFromSession()</code> in the controllers
        to access the logged-in user and put it in the model for rendering.
        Here's what the UI had evolved to:
    </p><div class="mediaobject"><img src="cineasts_user.png" width="531.496062992126"></div></div><div xmlns:fo="http://www.w3.org/1999/XSL/Format" class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tutorial_social.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="tutorial_user-experience.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;12.&nbsp;Adding social&nbsp;</td><td width="20%" align="center"><span style="color:white;font-size:90%;"><a href="http://www.springsource.com/" title="SpringSource">Sponsored by SpringSource
                                        </a></span></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;14.&nbsp;More UI</td></tr></table></div></body></html>