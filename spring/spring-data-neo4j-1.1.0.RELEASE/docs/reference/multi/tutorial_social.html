<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;12.&nbsp;Adding social</title><link rel="stylesheet" href="css/html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.73.2"><link rel="start" href="index.html" title="Good Relationships"><link rel="up" href="tutorial.html" title="Part&nbsp;I.&nbsp;Tutorial"><link rel="prev" href="tutorial_webapp.html" title="Chapter&nbsp;11.&nbsp;Web views"><link rel="next" href="tutorial_security.html" title="Chapter&nbsp;13.&nbsp;Adding Security"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div xmlns:fo="http://www.w3.org/1999/XSL/Format" style="background-color:white;border:none;height:73px;border:1px solid black;"><a style="border:none;" href="http://static.springframework.org/spring-ws/site/" title="The Spring Framework - Spring Web Services"><img style="border:none;" src="images/xdev-spring_logo.jpg"></a><a style="border:none;" href="http://www.springsource.com/" title="SpringSource"><img style="border:none;position:absolute;padding-top:5px;right:42px;" src="images/s2_box_logo.png"></a></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="tutorial_social"></a>Chapter&nbsp;12.&nbsp;Adding social</h2></div><div><h3 class="subtitle"><i>Movies 2.0</i></h3></div></div></div><p>
        So far, the website had only been a plain old movie database (POMD?). We now wanted to add
        a touch of social to it.
    </p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e647"></a>12.1.&nbsp;Users</h2></div></div></div><p>
            So we started out by taking the User class that we'd already coded and made it a
            full-fledged Spring Data Graph entity. We added the ability to make friends and to
            rate movies. With that we also added a simple UserRepository that was able to look
            up users by ID.
        </p><p>
            </p><div class="example"><a name="d0e654"></a><p class="title"><b>Example&nbsp;12.1.&nbsp;Social entities</b></p><div class="example-contents"><pre class="programlisting">@NodeEntity
<span class="hl-keyword">class</span> User {
    @Indexed String login;
    String name;
    String password;

    @RelatedToVia(elementClass = Rating.<span class="hl-keyword">class</span>, type = RATED)
    Iterable&lt;Rating&gt; ratings;

    @RelatedTo(elementClass = User.<span class="hl-keyword">class</span>, type = <span class="hl-string">"FRIEND"</span>, direction=Direction.BOTH)
    Set&lt;User&gt; friends;

    <span class="hl-keyword">public</span> Rating rate(Movie movie, <span class="hl-keyword">int</span> stars, String comment) {
        <span class="hl-keyword">return</span> relateTo(movie, Rating.<span class="hl-keyword">class</span>, <span class="hl-string">"RATED"</span>).rate(stars, comment);
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> befriend(User user) {
        <span class="hl-keyword">this</span>.friends.add(user);
    }
}

@RelationshipEntity
<span class="hl-keyword">class</span> Rating {
    @StartNode User user;
    @EndNode Movie movie;
    <span class="hl-keyword">int</span> stars;
    String comment;
    <span class="hl-keyword">public</span> Rating rate(<span class="hl-keyword">int</span> stars, String comment) {
       <span class="hl-keyword">this</span>.stars = stars; <span class="hl-keyword">this</span>.comment = comment;
       <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>;
    }
}
</pre></div></div><p><br class="example-break">
        </p><p>
            We extended the DatabasePopulator to add some users and ratings to the initial setup.
        </p><p>
            </p><div class="example"><a name="d0e664"></a><p class="title"><b>Example&nbsp;12.2.&nbsp;Populate users and ratings</b></p><div class="example-contents"><pre class="programlisting">@Transactional
<span class="hl-keyword">public</span> List&lt;Movie&gt; populateDatabase() {
    Actor tomHanks = <span class="hl-keyword">new</span> Actor(<span class="hl-string">"1"</span>, <span class="hl-string">"Tom Hanks"</span>).persist();
    Movie forestGump = <span class="hl-keyword">new</span> Movie(<span class="hl-string">"1"</span>, <span class="hl-string">"Forrest Gump"</span>).persist();
    tomHanks.playedIn(forestGump, <span class="hl-string">"Forrest"</span>);

    User me = <span class="hl-keyword">new</span> User(<span class="hl-string">"micha"</span>, <span class="hl-string">"Micha"</span>, <span class="hl-string">"password"</span>,
        User.Roles.ROLE_ADMIN, User.Roles.ROLE_USER).persist();
    Rating awesome = me.rate(forestGump, 5, <span class="hl-string">"Awesome"</span>);

    User ollie = <span class="hl-keyword">new</span> User(<span class="hl-string">"ollie"</span>, <span class="hl-string">"Olliver"</span>, <span class="hl-string">"password"</span>, User.Roles.ROLE_USER).persist();
    ollie.rate(forestGump, 2, <span class="hl-string">"ok"</span>);
    me.addFriend(ollie);
    <span class="hl-keyword">return</span> asList(forestGump);
}
</pre></div></div><p><br class="example-break">
        </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e670"></a>12.2.&nbsp;Ratings for movies</h2></div></div></div><p>
            We also put a ratings field into the Movie class to be able to get a movie's ratings,
            and also a method to average its star rating.
        </p><p>
            </p><div class="example"><a name="d0e677"></a><p class="title"><b>Example&nbsp;12.3.&nbsp;Getting the rating of a movie</b></p><div class="example-contents"><pre class="programlisting"><span class="hl-keyword">class</span> Movie {
    ...

    @RelatedToVia(elementClass=Rating.<span class="hl-keyword">class</span>, type=<span class="hl-string">"RATED"</span>, direction = Direction.INCOMING)
    Iterable&lt;Rating&gt; ratings;

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getStars() {
        <span class="hl-keyword">int</span> stars = 0, count = 0;
        <span class="hl-keyword">for</span> (Rating rating : ratings) {
            stars += rating.getStars(); count++;
        }
        <span class="hl-keyword">return</span> count == 0 ? 0 : stars / count;
    }
}
</pre></div></div><p><br class="example-break">
        </p><p>
            Fortunately our tests highlighted the division by zero error when calculating the stars for
            a movie without ratings. The next steps were to add this information to the movie presentation in
            the UI, and creating a user profile page. But for that to happen, users must first be able to log in.
        </p></div></div><div xmlns:fo="http://www.w3.org/1999/XSL/Format" class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tutorial_webapp.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="tutorial_security.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;11.&nbsp;Web views&nbsp;</td><td width="20%" align="center"><span style="color:white;font-size:90%;"><a href="http://www.springsource.com/" title="SpringSource">Sponsored by SpringSource
                                        </a></span></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;13.&nbsp;Adding Security</td></tr></table></div></body></html>